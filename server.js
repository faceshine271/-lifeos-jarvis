0; // LINE_GUARD â€” do not remove
// ATHENA v4.4 â€” Feb 24 2026 â€” Market Intelligence + CPC + Market Share + Attack List
require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const { google } = require('googleapis');
const twilio = require('twilio');
const path = require('path');
const fs = require('fs');
const https = require('https');
const http = require('http');

const app = express();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());

const PORT = process.env.PORT || 3000;

console.log("Starting LifeOS Jarvis...");

/* ===========================
   GOOGLE SHEETS AUTH
=========================== */

const SPREADSHEET_ID = process.env.SPREADSHEET_ID;
const BUSINESS_SPREADSHEET_ID = process.env.BUSINESS_SPREADSHEET_ID || SPREADSHEET_ID;
const PROFIT_SPREADSHEET_ID = process.env.PROFIT_SPREADSHEET_ID || '';
const FOLLOWUP_SPREADSHEET_ID = process.env.FOLLOWUP_SPREADSHEET_ID || '1A8oUmigHV6DsYcWF4hlDBC5KQDIHWMOh1Is6poCacx4';

if (!SPREADSHEET_ID) {
  console.error("Missing SPREADSHEET_ID");
  process.exit(1);
}

var keyfilePath = path.join(__dirname, 'google-credentials.json');

// Method 1: Base64 encoded credentials (decode to temp file)
if (process.env.GOOGLE_CREDENTIALS_BASE64) {
  console.log("Using GOOGLE_CREDENTIALS_BASE64 env var");
  var decoded = Buffer.from(process.env.GOOGLE_CREDENTIALS_BASE64, 'base64').toString('utf8');
  var tmpPath = '/tmp/google-credentials.json';
  fs.writeFileSync(tmpPath, decoded);
  keyfilePath = tmpPath;
}

// Method 2: Local JSON keyfile
if (!fs.existsSync(keyfilePath)) {
  console.error("No Google credentials found! Set GOOGLE_CREDENTIALS_BASE64 env var or add google-credentials.json file.");
  process.exit(1);
}

console.log("Using keyfile: " + keyfilePath);
var auth = new google.auth.GoogleAuth({
  keyFile: keyfilePath,
  scopes: ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive'],
});

var sheets = google.sheets({ version: 'v4', auth: auth });
var drive = google.drive({ version: 'v3', auth: auth });
console.log("Google Auth Ready");

// Log service account email for sharing
try {
  var creds = JSON.parse(fs.readFileSync(keyfilePath, 'utf8'));
  console.log("ðŸ”‘ Service Account Email: " + creds.client_email);
  console.log("   Share Google Drive folders with this email to enable uploads");
} catch (e) {}

// Follow-up portal config
const FOLLOWUP_PASSWORD_SHEET_ID = process.env.FOLLOWUP_PASSWORD_SHEET_ID || '1zXJPcJsKgoY8zY921mfzz0KSphQWFYF74hX9_M54v4A';
const FOLLOWUP_PASSWORD_TAB = 'Follow up password';
const FOLLOWUP_ADMIN_EMAIL = 'aly@wildwoodsmallenginerepair.com';
const FOLLOWUP_CC_EMAIL = 'trace@wildwoodsmallenginerepair.com';
const FOLLOWUP_OPENAI_KEY = process.env.FOLLOWUP_OPENAI_KEY || '';

// Discord bot config
const DISCORD_BOT_TOKEN = process.env.DISCORD_BOT_TOKEN || '';
const DISCORD_GUILD_ID = process.env.DISCORD_GUILD_ID || '';
var discordCache = { channels: null, messages: {}, time: 0 };

// Square API config
const SQUARE_ACCESS_TOKEN = process.env.SQUARE_ACCESS_TOKEN || '';
const SQUARE_BASE = process.env.SQUARE_ENV === 'sandbox' ? 'https://connect.squareupsandbox.com' : 'https://connect.squareup.com';
// Square API batch limits â€” future-proof for location growth
const SQ_BATCH = { ORDERS_LOCS: 10, INVOICES_LOCS: 1, MAX_PAGES: 200, CUSTOMERS_LIMIT: 50 };
// squareCache replaced by squareDataStore (see squareFullSnapshot)

async function squareFetch(endpoint, method, body) {
  if (!SQUARE_ACCESS_TOKEN) return null;
  try {
    var opts = {
      method: method || 'GET',
      headers: { 'Authorization': 'Bearer ' + SQUARE_ACCESS_TOKEN, 'Content-Type': 'application/json', 'Square-Version': '2024-12-18' }
    };
    if (body) opts.body = JSON.stringify(body);
    var r = await fetch(SQUARE_BASE + '/v2' + endpoint, opts);
    if (!r.ok) { var errBody = ''; try { errBody = await r.text(); } catch(e){} console.log('Square API error ' + endpoint + ':', r.status, errBody.substring(0,300)); return null; }
    return await r.json();
  } catch (err) { console.log('Square fetch error:', err.message); return null; }
}

// Paginated fetcher â€” handles any Square list endpoint
async function squareFetchAll(endpoint, method, body, listKey, maxPages) {
  var all = []; var cursor = '';
  for (var i = 0; i < (maxPages || 50); i++) {
    var url = endpoint;
    var reqBody = body ? JSON.parse(JSON.stringify(body)) : null;
    if (method === 'GET') {
      url += (url.includes('?') ? '&' : '?') + 'limit=100';
      if (cursor) url += '&cursor=' + cursor;
    } else if (reqBody) {
      reqBody.limit = 100;
      if (cursor) reqBody.cursor = cursor;
    }
    var d = await squareFetch(url, method, reqBody);
    if (!d) break;
    if (d[listKey]) all = all.concat(d[listKey]);
    if (!d.cursor) break;
    cursor = d.cursor;
  }
  return all;
}

// ---- LOCATIONS ----
async function squareGetLocations() {
  var d = await squareFetch('/locations');
  return d && d.locations ? d.locations : [];
}

// ---- PAYMENTS (last N days) ----
async function squareGetPayments(days) { // default: all since 2022
  var begin = new Date(Date.now() - (days || 1500) * 86400000).toISOString();
  return await squareFetchAll('/payments?begin_time=' + encodeURIComponent(begin) + '&end_time=' + encodeURIComponent(new Date().toISOString()) + '&sort_order=DESC', 'GET', null, 'payments', 100);
}

// ---- CUSTOMERS ----
async function squareGetCustomers() {
  return await squareFetchAll('/customers', 'GET', null, 'customers', 100);
}

// ---- INVOICES ----
async function squareGetInvoices(locationIds) {
  if (!locationIds) { var locs = await squareGetLocations(); if (!locs.length) return []; locationIds = locs.map(function(l){return l.id;}); }
  if (!Array.isArray(locationIds)) locationIds = [locationIds];
  // Square invoices API only allows 1 location_id at a time
  var all = [];
  for (var i = 0; i < locationIds.length; i++) {
    var batch = await squareFetchAll('/invoices/search', 'POST', { query: { filter: { location_ids: [locationIds[i]] }, sort: { field: 'INVOICE_SORT_DATE', order: 'DESC' } } }, 'invoices');
    all = all.concat(batch);
  }
  return all;
}

// ---- ORDERS (with full line items) ----
async function squareGetOrders(locationIds, days) {
  if (!locationIds) { var locs = await squareGetLocations(); if (!locs.length) return []; locationIds = locs.map(function(l){return l.id;}); }
  if (!Array.isArray(locationIds)) locationIds = [locationIds];
  var begin = new Date(Date.now() - (days || 1500) * 86400000).toISOString();
  // Square orders API only allows 10 location_ids at a time â€” batch dynamically
  var all = [];
  for (var i = 0; i < locationIds.length; i += SQ_BATCH.ORDERS_LOCS) {
    var chunk = locationIds.slice(i, i + SQ_BATCH.ORDERS_LOCS);
    var cursor = '';
    for (var page = 0; page < SQ_BATCH.MAX_PAGES; page++) {
      var body = {
        location_ids: chunk, query: { filter: { date_time_filter: { created_at: { start_at: begin } } }, sort: { sort_field: 'CREATED_AT', sort_order: 'DESC' } }, limit: 500
      };
      if (cursor) body.cursor = cursor;
      var d = await squareFetch('/orders/search', 'POST', body);
      if (!d) break;
      if (d.orders) all = all.concat(d.orders);
      if (!d.cursor) break;
      cursor = d.cursor;
    }
  }
  return all;
}

// ---- CATALOG (items, variations, categories, discounts, taxes, modifiers) ----
async function squareGetCatalog() {
  return await squareFetchAll('/catalog/list?types=ITEM,ITEM_VARIATION,CATEGORY,DISCOUNT,TAX,MODIFIER,MODIFIER_LIST,IMAGE', 'GET', null, 'objects');
}

// ---- INVENTORY COUNTS ----
async function squareGetInventory() {
  var d = await squareFetch('/inventory/counts/batch-retrieve', 'POST', { limit: 100 });
  return d && d.counts ? d.counts : [];
}

// ---- TEAM MEMBERS ----
async function squareGetTeamMembers() {
  var d = await squareFetch('/team-members/search', 'POST', { limit: 100 });
  return d && d.team_members ? d.team_members : [];
}

// ---- LABOR / SHIFTS ----
async function squareGetShifts(days) {
  var begin = new Date(Date.now() - (days || 14) * 86400000).toISOString();
  var d = await squareFetch('/labor/shifts/search', 'POST', {
    query: { filter: { start: { start_at: begin } }, sort: { field: 'START_AT', order: 'DESC' } }, limit: 200
  });
  return d && d.shifts ? d.shifts : [];
}

// ---- BREAK TYPES ----
async function squareGetBreakTypes() {
  var locs = await squareGetLocations();
  if (!locs.length) return [];
  var d = await squareFetch('/labor/break-types?location_id=' + locs[0].id);
  return d && d.break_types ? d.break_types : [];
}

// ---- REFUNDS ----
async function squareGetRefunds(days) {
  var begin = new Date(Date.now() - (days || 1500) * 86400000).toISOString();
  return await squareFetchAll('/refunds?begin_time=' + encodeURIComponent(begin), 'GET', null, 'refunds');
}

// ---- DISPUTES ----
async function squareGetDisputes() {
  var d = await squareFetch('/disputes?limit=50');
  return d && d.disputes ? d.disputes : [];
}

// ---- PAYOUTS (bank deposits) ----
async function squareGetPayouts(days) {
  var begin = new Date(Date.now() - (days || 1500) * 86400000).toISOString();
  var d = await squareFetch('/payouts?begin_time=' + encodeURIComponent(begin) + '&limit=50');
  return d && d.payouts ? d.payouts : [];
}

// ---- LOYALTY PROGRAM ----
async function squareGetLoyaltyProgram() {
  var d = await squareFetch('/loyalty/programs/main');
  return d && d.program ? d.program : null;
}

async function squareGetLoyaltyAccounts() {
  var d = await squareFetch('/loyalty/accounts/search', 'POST', { limit: 100 });
  return d && d.loyalty_accounts ? d.loyalty_accounts : [];
}

// ---- GIFT CARDS ----
async function squareGetGiftCards() {
  var d = await squareFetch('/gift-cards?limit=100');
  return d && d.gift_cards ? d.gift_cards : [];
}

// ---- BOOKINGS / APPOINTMENTS ----
async function squareGetBookings(days) {
  var begin = new Date(Date.now() - (days || 14) * 86400000).toISOString();
  var d = await squareFetch('/bookings?start_at_min=' + encodeURIComponent(begin) + '&limit=100');
  return d && d.bookings ? d.bookings : [];
}

// ---- SUBSCRIPTIONS ----
async function squareGetSubscriptions() {
  var d = await squareFetch('/subscriptions/search', 'POST', { limit: 100 });
  return d && d.subscriptions ? d.subscriptions : [];
}

// ---- CASH DRAWERS ----
async function squareGetCashDrawerShifts(locationId) {
  if (!locationId) { var locs = await squareGetLocations(); if (!locs.length) return []; locationId = locs[0].id; }
  var d = await squareFetch('/cash-drawers/shifts?location_id=' + locationId + '&limit=50');
  return d && d.items ? d.items : [];
}

// ---- DEVICES / TERMINALS ----
async function squareGetDevices() {
  var d = await squareFetch('/devices');
  return d && d.devices ? d.devices : [];
}

// ---- BANK ACCOUNTS ----
async function squareGetBankAccounts() {
  var d = await squareFetch('/bank-accounts');
  return d && d.bank_accounts ? d.bank_accounts : [];
}

// ---- CUSTOMER GROUPS / SEGMENTS ----
async function squareGetCustomerGroups() {
  var d = await squareFetch('/customers/groups?limit=' + SQ_BATCH.CUSTOMERS_LIMIT);
  return d && d.groups ? d.groups : [];
}

async function squareGetCustomerSegments() {
  var d = await squareFetch('/customers/segments?limit=' + SQ_BATCH.CUSTOMERS_LIMIT);
  return d && d.segments ? d.segments : [];
}

function squareMoney(amtObj) {
  if (!amtObj || amtObj.amount === undefined) return '$0.00';
  return '$' + (amtObj.amount / 100).toFixed(2);
}
function sqCents(amtObj) { return amtObj && amtObj.amount ? amtObj.amount / 100 : 0; }

// ---- FULL SNAPSHOT (smart cache â€” stores all data, only fetches new) ----
var squareDataStore = { payments: [], customers: [], invoices: [], orders: [], catalog: [], locations: [], team: [], refunds: [], disputes: [], payouts: [], shifts: [], giftCards: [], subscriptions: [], bookings: [], devices: [], loyalty: null, loyaltyAccounts: [], cashDrawers: [], bankAccounts: [], custGroups: [], custSegments: [], locIds: [], lastFullFetch: 0, lastIncrFetch: 0, initialized: false };

// ====== SEO AUDIT DATA â€” ALL 50 STATES, ~1000 CITIES, 5 SERVICE TYPES ======
// Format: state -> [[city, pop], ...], { service_key: [[city, vol, kd, cpc], ...] }
var SEO_AUDIT_DATA = {"Alabama":[[["Huntsville",231000],["Birmingham",194000],["Montgomery",192000],["Mobile",180000],["Tuscaloosa",116000],["Hoover",92000],["Auburn",85000],["Dothan",71000],["Madison",63000],["Decatur",58000],["Florence",51000],["Phenix City",37000],["Prattville",37000],["Vestavia Hills",36000],["Alabaster",33000],["Opelika",32000],["Bessemer",26000],["Homewood",26000],["Daphne",26000],["Pelham",25000],["Northport",25000],["Enterprise",24000],["Gadsden",23000],["Athens",23000],["Albertville",22000],["Mountain Brook",22000],["Trussville",22000],["Helena",21000],["Troy",20000],["Oxford",19000],["Cullman",19000],["Fairhope",19000],["Anniston",18000],["Millbrook",16000],["Hartselle",15000]],{"small_engine_repair":[["Huntsville",40,33.0,0],["Birmingham",30,31.0,0],["Mobile",20,28.0,1.54],["Montgomery",10,28.0,0],["Tuscaloosa",10,31.0,0],["Hoover",10,31.0,0],["Auburn",10,30.0,0],["Dothan",10,28.0,0],["Madison",10,48.0,0],["Decatur",10,30.0,0],["Prattville",10,28.0,0],["Vestavia Hills",10,31.0,0],["Alabaster",10,31.0,0],["Opelika",10,28.0,0],["Bessemer",10,40.0,0],["Homewood",10,31.0,0],["Daphne",10,31.0,0],["Pelham",10,31.0,0],["Northport",10,31.0,0],["Enterprise",10,31.0,0],["Gadsden",10,31.0,0],["Athens",10,31.0,0],["Albertville",10,31.0,0],["Mountain Brook",10,31.0,0],["Trussville",10,28.0,0],["Troy",10,37.0,0],["Oxford",10,34.0,0],["Cullman",10,28.0,0],["Fairhope",10,31.0,0],["Anniston",10,31.0,0],["Millbrook",10,31.0,0],["Hartselle",10,31.0,0],["Florence",0,41.0,0],["Phenix City",0,31.0,0],["Helena",0,30.0,0]],"lawn_mower_repair":[["Birmingham",170,24.0,3.52],["Mountain Brook",170,28.0,0],["Mobile",30,28.0,0],["Huntsville",20,28.0,0],["Montgomery",20,28.0,0],["Vestavia Hills",20,20.0,0],["Tuscaloosa",10,32.0,0],["Hoover",10,23.0,0],["Auburn",10,31.0,0],["Dothan",10,23.0,0],["Madison",10,24.0,0],["Decatur",10,19.0,0],["Florence",10,26.0,0],["Phenix City",10,24.0,0],["Alabaster",10,24.0,0],["Opelika",10,29.0,0],["Bessemer",10,23.0,0],["Homewood",10,20.0,0],["Daphne",10,24.0,0],["Pelham",10,24.0,0],["Northport",10,24.0,0],["Enterprise",10,30.0,0],["Gadsden",10,28.0,0],["Athens",10,24.0,0],["Trussville",10,24.0,0],["Helena",10,24.0,0],["Cullman",10,24.0,0],["Fairhope",10,31.0,0],["Anniston",10,24.0,0],["Millbrook",10,31.0,0],["Prattville",0,24.0,0],["Albertville",0,28.0,0],["Troy",0,31.0,0],["Oxford",0,24.0,0],["Hartselle",0,28.0,0]],"snow_blower_repair":[["Tuscaloosa",10,36.0,0],["Hoover",10,31.0,0],["Auburn",10,31.0,0],["Dothan",10,31.0,0],["Madison",10,37.0,0],["Decatur",10,31.0,0],["Florence",10,31.0,0],["Phenix City",10,29.0,0],["Vestavia Hills",10,34.0,0],["Alabaster",10,29.0,0],["Opelika",10,36.0,0],["Bessemer",10,31.0,0],["Homewood",10,37.0,0],["Daphne",10,37.0,0],["Pelham",10,34.0,0],["Northport",10,28.0,0],["Enterprise",10,31.0,0],["Gadsden",10,28.0,0],["Athens",10,28.0,0],["Albertville",10,31.0,0],["Mountain Brook",10,34.0,0],["Trussville",10,31.0,0],["Helena",10,34.0,0],["Troy",10,24.0,0],["Oxford",10,31.0,0],["Cullman",10,23.0,0],["Fairhope",10,35.0,0],["Millbrook",10,33.0,0],["Hartselle",10,34.0,0],["Huntsville",0,31.0,0],["Birmingham",0,31.0,0],["Montgomery",0,28.0,0],["Mobile",0,31.0,0],["Prattville",0,23.0,0],["Anniston",0,28.0,0]],"generator_repair":[["Birmingham",10,7.0,0],["Montgomery",10,29.0,0],["Mobile",10,6.0,0],["Tuscaloosa",10,5.0,0],["Hoover",10,29.0,0],["Dothan",10,11.0,0],["Decatur",10,30.0,0],["Florence",10,18.0,0],["Phenix City",10,22.0,0],["Vestavia Hills",10,7.0,0],["Bessemer",10,29.0,0],["Athens",10,29.0,0],["Millbrook",10,18.0,0],["Huntsville",0,13.0,0],["Auburn",0,4.0,0],["Madison",0,9.0,0],["Prattville",0,8.0,0],["Alabaster",0,9.0,0],["Opelika",0,5.0,0],["Homewood",0,29.0,0],["Daphne",0,4.0,0],["Pelham",0,11.0,0],["Northport",0,5.0,0],["Enterprise",0,22.0,0],["Gadsden",0,22.0,0],["Albertville",0,13.0,0],["Mountain Brook",0,29.0,0],["Trussville",0,29.0,0],["Helena",0,10.0,0],["Troy",0,19.0,0],["Oxford",0,16.0,0],["Cullman",0,7.0,0],["Fairhope",0,5.0,0],["Anniston",0,18.0,0],["Hartselle",0,5.0,0]],"motorcycle_repair":[["Birmingham",40,18.0,0],["Mobile",40,38.0,0],["Huntsville",10,25.0,0],["Montgomery",10,29.0,0],["Hoover",10,16.0,0],["Auburn",10,31.0,0],["Dothan",10,29.0,0],["Madison",10,32.0,0],["Prattville",10,32.0,0],["Opelika",10,28.0,0],["Homewood",10,18.0,0],["Tuscaloosa",0,32.0,0],["Decatur",0,9.0,0],["Florence",0,41.0,0],["Phenix City",0,37.0,0],["Vestavia Hills",0,47.0,0],["Alabaster",0,44.0,0],["Bessemer",0,15.0,0],["Daphne",0,38.0,0],["Pelham",0,30.0,0],["Northport",0,39.0,0],["Enterprise",0,36.0,0],["Gadsden",0,32.0,0],["Athens",0,30.0,0],["Albertville",0,30.0,0],["Mountain Brook",0,31.0,0],["Trussville",0,6.0,0],["Helena",0,52.0,0],["Troy",0,32.0,0],["Oxford",0,30.0,0],["Cullman",0,32.0,0],["Fairhope",0,36.0,0],["Anniston",0,30.0,0],["Millbrook",0,21.0,0],["Hartselle",0,26.0,0]]}],"Arizona":[[["Phoenix",1650000],["Tucson",550000],["Mesa",520000],["Chandler",280000],["Gilbert",270000],["Glendale",250000],["Scottsdale",250000],["Peoria",200000],["Tempe",190000],["Surprise",150000],["Goodyear",115000],["Buckeye",110000],["Avondale",95000],["Flagstaff",78000],["Queen Creek",75000],["Lake Havasu City",58000],["Maricopa",62000],["Casa Grande",60000],["Marana",55000],["Sierra Vista",45000],["Prescott Valley",50000],["Oro Valley",48000],["Prescott",47000],["Bullhead City",40000],["Apache Junction",40000],["San Tan Valley",100000],["Sahuarita",34000],["Fountain Hills",25000],["Eloy",20000],["Sun City",39000],["Payson",16000],["Nogales",20000],["Douglas",17000],["Show Low",11000],["Sedona",10000]],{"small_engine_repair":[["Phoenix",70,26.0,1.67],["Tempe",30,42.0,0],["Tucson",20,30.0,0],["Scottsdale",20,31.0,0],["Peoria",20,31.0,0],["Mesa",10,26.0,0],["Chandler",10,28.0,0],["Gilbert",10,28.0,0],["Glendale",10,26.0,0],["Surprise",10,34.0,0],["Goodyear",10,28.0,0],["Buckeye",10,31.0,0],["Avondale",10,31.0,0],["Flagstaff",10,31.0,0],["Queen Creek",10,31.0,0],["Lake Havasu City",10,31.0,0],["Casa Grande",10,31.0,0],["Marana",10,31.0,0],["Sierra Vista",10,31.0,0],["Prescott Valley",10,31.0,0],["Oro Valley",10,34.0,0],["Prescott",10,31.0,0],["Bullhead City",10,31.0,0],["Apache Junction",10,31.0,0],["San Tan Valley",10,31.0,0],["Sahuarita",10,31.0,0],["Sun City",10,44.0,0],["Show Low",10,30.0,0],["Sedona",10,31.0,0],["Maricopa",0,31.0,0],["Fountain Hills",0,31.0,0],["Eloy",0,52.0,0],["Payson",0,37.0,0],["Nogales",0,37.0,0],["Douglas",0,44.0,0]],"lawn_mower_repair":[["Phoenix",70,4.0,1.8],["Gilbert",20,24.0,0],["Glendale",20,22.0,3.18],["Tucson",10,22.0,0],["Mesa",10,18.0,0],["Chandler",10,2.0,0],["Scottsdale",10,24.0,0],["Peoria",10,24.0,0],["Tempe",10,18.0,0],["Surprise",10,24.0,0],["Goodyear",10,22.0,0],["Buckeye",10,22.0,0],["Avondale",10,22.0,0],["Flagstaff",10,24.0,0],["Queen Creek",10,22.0,0],["Maricopa",10,22.0,0],["Prescott Valley",10,31.0,0],["Oro Valley",10,24.0,0],["San Tan Valley",10,22.0,0],["Sahuarita",10,18.0,0],["Sun City",10,18.0,0],["Sedona",10,26.0,0],["Lake Havasu City",0,30.0,0],["Casa Grande",0,31.0,0],["Marana",0,22.0,0],["Sierra Vista",0,24.0,0],["Prescott",0,28.0,0],["Bullhead City",0,31.0,0],["Apache Junction",0,31.0,0],["Fountain Hills",0,18.0,0],["Eloy",0,22.0,0],["Payson",0,24.0,0],["Nogales",0,31.0,0],["Douglas",0,31.0,0],["Show Low",0,28.0,0]],"snow_blower_repair":[["Phoenix",10,31.0,0],["Surprise",10,39.0,0],["Goodyear",10,39.0,0],["Buckeye",10,34.0,0],["Avondale",10,34.0,0],["Queen Creek",10,31.0,0],["Lake Havasu City",10,31.0,0],["Maricopa",10,34.0,0],["Casa Grande",10,31.0,0],["Marana",10,31.0,0],["Sierra Vista",10,34.0,0],["Prescott Valley",10,31.0,0],["Oro Valley",10,30.0,0],["Bullhead City",10,34.0,0],["Apache Junction",10,34.0,0],["San Tan Valley",10,31.0,0],["Sahuarita",10,33.0,0],["Fountain Hills",10,31.0,0],["Sun City",10,33.0,0],["Payson",10,34.0,0],["Nogales",10,29.0,0],["Show Low",10,31.0,0],["Sedona",10,34.0,0],["Tucson",0,31.0,0],["Mesa",0,38.0,0],["Chandler",0,28.0,0],["Gilbert",0,31.0,0],["Glendale",0,34.0,0],["Scottsdale",0,34.0,0],["Peoria",0,28.0,0],["Tempe",0,30.0,0],["Flagstaff",0,28.0,0],["Prescott",0,31.0,0],["Eloy",0,31.0,0],["Douglas",0,33.0,0]],"generator_repair":[["Phoenix",30,14.0,7.23],["Tucson",10,3.0,0],["Mesa",10,17.0,0],["Chandler",10,20.0,0],["Gilbert",10,20.0,0],["Glendale",10,15.0,0],["Scottsdale",10,12.0,0],["Peoria",10,19.0,0],["Tempe",10,10.0,0],["Surprise",10,20.0,0],["Goodyear",10,20.0,0],["Buckeye",10,10.0,4.19],["Avondale",10,15.0,0],["Flagstaff",10,18.0,0],["Lake Havasu City",10,29.0,0],["Oro Valley",10,8.0,0],["Sahuarita",10,20.0,5.02],["Queen Creek",0,18.0,0],["Maricopa",0,12.0,0],["Casa Grande",0,21.0,0],["Marana",0,10.0,0],["Sierra Vista",0,18.0,0],["Prescott Valley",0,4.0,0],["Prescott",0,13.0,0],["Bullhead City",0,20.0,0],["Apache Junction",0,22.0,0],["San Tan Valley",0,20.0,0],["Fountain Hills",0,23.0,0],["Eloy",0,21.0,0],["Sun City",0,11.0,0],["Payson",0,23.0,0],["Nogales",0,25.0,0],["Douglas",0,14.0,0],["Show Low",0,3.0,0],["Sedona",0,27.0,0]],"motorcycle_repair":[["Phoenix",210,17.0,2.38],["Scottsdale",30,33.0,0],["Mesa",20,28.0,0],["Tucson",10,17.0,0],["Chandler",10,12.0,0],["Gilbert",10,28.0,0],["Glendale",10,14.0,2.87],["Peoria",10,12.0,0],["Tempe",10,25.0,0],["Surprise",10,16.0,0],["Goodyear",10,7.0,0],["Buckeye",10,10.0,0],["Avondale",10,14.0,0],["Flagstaff",10,26.0,0],["Queen Creek",10,29.0,0],["Lake Havasu City",10,8.0,0],["Maricopa",10,14.0,0],["Casa Grande",10,30.0,0],["Prescott Valley",10,37.0,0],["Prescott",10,36.0,0],["Sahuarita",10,31.0,0],["Nogales",10,49.0,0],["Douglas",10,33.0,0],["Marana",0,24.0,0],["Sierra Vista",0,28.0,0],["Oro Valley",0,36.0,0],["Bullhead City",0,38.0,0],["Apache Junction",0,28.0,0],["San Tan Valley",0,30.0,0],["Fountain Hills",0,11.0,0],["Eloy",0,27.0,0],["Sun City",0,21.0,0],["Payson",0,31.0,0],["Show Low",0,27.0,0],["Sedona",0,31.0,0]]}],"Wyoming":[[["Cheyenne",65000],["Casper",58000],["Laramie",32000],["Gillette",32000],["Rock Springs",23000],["Sheridan",19000],["Green River",12000],["Evanston",12000],["Riverton",11000],["Jackson",10000]],{"small_engine_repair":[["Cheyenne",10,30.0,0],["Casper",10,31.0,0],["Laramie",10,30.0,0],["Rock Springs",10,31.0,0],["Sheridan",10,46.0,0],["Green River",10,31.0,0],["Riverton",10,31.0,0],["Gillette",0,31.0,0],["Evanston",0,31.0,0],["Jackson",0,31.0,0]],"lawn_mower_repair":[["Cheyenne",10,24.0,0],["Gillette",10,24.0,0],["Casper",0,31.0,0],["Laramie",0,24.0,0],["Rock Springs",0,28.0,0],["Sheridan",0,21.0,0],["Green River",0,28.0,0],["Evanston",0,22.0,0],["Riverton",0,22.0,0],["Jackson",0,22.0,0]],"snow_blower_repair":[["Laramie",10,24.0,0],["Riverton",10,27.0,0],["Cheyenne",0,24.0,0],["Casper",0,26.0,0],["Gillette",0,31.0,0],["Rock Springs",0,26.0,0],["Sheridan",0,31.0,0],["Green River",0,28.0,0],["Evanston",0,34.0,0],["Jackson",0,23.0,0]],"generator_repair":[["Cheyenne",0,4.0,0],["Casper",0,26.0,0],["Laramie",0,31.0,0],["Gillette",0,16.0,0],["Rock Springs",0,25.0,0],["Sheridan",0,20.0,0],["Green River",0,29.0,0],["Evanston",0,32.0,0],["Riverton",0,31.0,0],["Jackson",0,19.0,0]],"motorcycle_repair":[["Cheyenne",0,39.0,0],["Casper",0,26.0,0],["Laramie",0,20.0,0],["Gillette",0,19.0,0],["Rock Springs",0,19.0,0],["Sheridan",0,32.0,0],["Green River",0,29.0,0],["Evanston",0,34.0,0],["Riverton",0,40.0,0],["Jackson",0,7.0,0]]}],"Alaska":[[["Anchorage",288000],["Fairbanks",32000],["Juneau",31000],["Knik-Fairview",19000],["College",14000],["Wasilla",13000],["Sitka",8500],["Kalifornsky",8500],["Ketchikan",8200],["Kenai",7800],["Meadow Lakes",7800],["Palmer",7400],["Kodiak",6300],["Bethel",6000]],{"small_engine_repair":[["Anchorage",20,28.0,0],["Fairbanks",10,31.0,0],["Wasilla",10,28.0,0],["Kalifornsky",10,31.0,0],["Ketchikan",10,46.0,0],["Kenai",10,34.0,0],["Palmer",10,28.0,0],["Bethel",10,40.0,0],["Juneau",0,40.0,0],["Knik-Fairview",0,40.0,0],["College",0,31.0,0],["Sitka",0,42.0,0],["Meadow Lakes",0,31.0,0],["Kodiak",0,55.0,0]],"lawn_mower_repair":[["Kodiak",31,0,0],["Bethel",31,0,0],["Anchorage",10,24.0,0],["Wasilla",10,23.0,0],["Fairbanks",0,22.0,0],["Juneau",0,31.0,0],["Knik-Fairview",0,24.0,0],["College",0,31.0,0],["Sitka",0,36.0,0],["Kalifornsky",0,31.0,0],["Ketchikan",0,31.0,0],["Kenai",0,22.0,0],["Meadow Lakes",0,22.0,0],["Palmer",0,24.0,0]],"snow_blower_repair":[["Anchorage",10,18.0,0],["Sitka",10,30.0,0],["Ketchikan",10,31.0,0],["Meadow Lakes",10,31.0,0],["Kodiak",10,30.0,0],["Bethel",10,30.0,0],["Fairbanks",0,31.0,0],["Juneau",0,34.0,0],["Knik-Fairview",0,12.0,0],["College",0,23.0,0],["Wasilla",0,20.0,0],["Kalifornsky",0,33.0,0],["Kenai",0,21.0,0],["Palmer",0,31.0,0]],"generator_repair":[["Anchorage",10,8.0,0],["Fairbanks",10,2.0,0],["College",10,3.0,0],["Kodiak",10,20.0,0],["Bethel",10,30.0,0],["Juneau",0,29.0,0],["Knik-Fairview",0,8.0,0],["Wasilla",0,8.0,0],["Sitka",0,18.0,0],["Kalifornsky",0,8.0,0],["Ketchikan",0,22.0,0],["Kenai",0,20.0,0],["Meadow Lakes",0,8.0,0],["Palmer",0,18.0,0]],"motorcycle_repair":[["Sitka",10,41.0,0],["Kalifornsky",10,36.0,0],["Ketchikan",10,40.0,0],["Kenai",10,36.0,0],["Meadow Lakes",10,29.0,0],["Kodiak",10,24.0,0],["Bethel",10,56.0,0],["Anchorage",0,31.0,0],["Fairbanks",0,19.0,0],["Juneau",0,16.0,0],["Knik-Fairview",0,27.0,0],["College",0,46.0,0],["Wasilla",0,29.0,0],["Palmer",0,29.0,0]]}],"Arkansas":[[["Little Rock",201000],["Fayetteville",101000],["Fort Smith",90000],["Springdale",87000],["Jonesboro",79000],["Rogers",72000],["Conway",66000],["Bentonville",58000],["Pine Bluff",41000],["Benton",37000],["Hot Springs",37000],["Sherwood",33000],["Texarkana",30000],["Russellville",30000],["Jacksonville",29000],["Paragould",29000],["Bella Vista",28000],["Cabot",27000],["West Memphis",24000],["Searcy",24000],["Van Buren",23000],["El Dorado",18000],["Maumelle",18000],["Marion",17000],["Bryant",17000],["Mountain Home",13000],["Blytheville",13000],["Forrest City",12000],["Arkadelphia",11000],["Magnolia",11000],["Hope",10000],["Camden",10000],["Harrison",13000],["Malvern",12000],["Crossett",10000]],{"small_engine_repair":[["Bentonville",20,42.0,0],["Benton",20,21.0,0],["Bryant",20,30.0,0],["Little Rock",10,32.0,0],["Fayetteville",10,32.0,0],["Springdale",10,31.0,0],["Jonesboro",10,7.0,0],["Conway",10,24.0,0],["Pine Bluff",10,31.0,0],["Hot Springs",10,31.0,0],["Sherwood",10,28.0,0],["Texarkana",10,43.0,0],["Russellville",10,31.0,0],["Jacksonville",10,31.0,0],["Paragould",10,31.0,0],["Bella Vista",10,36.0,0],["Cabot",10,28.0,0],["West Memphis",10,28.0,0],["Searcy",10,30.0,0],["Van Buren",10,31.0,0],["El Dorado",10,43.0,0],["Maumelle",10,28.0,0],["Marion",10,31.0,0],["Mountain Home",10,43.0,0],["Blytheville",10,31.0,0],["Harrison",10,37.0,0],["Malvern",10,31.0,0],["Fort Smith",0,19.0,0],["Rogers",0,31.0,0],["Forrest City",0,31.0,0],["Arkadelphia",0,31.0,0],["Magnolia",0,31.0,0],["Hope",0,31.0,0],["Camden",0,31.0,0],["Crossett",0,31.0,0]],"lawn_mower_repair":[["Little Rock",10,10.0,0],["Fayetteville",10,9.0,0],["Fort Smith",10,29.0,0],["Springdale",10,10.0,0],["Rogers",10,15.0,8.62],["Conway",10,23.0,0],["Bentonville",10,23.0,0],["Benton",10,28.0,0],["Hot Springs",10,23.0,0],["Jacksonville",10,24.0,0],["Bella Vista",10,22.0,0],["Cabot",10,24.0,0],["Searcy",10,24.0,0],["Van Buren",10,28.0,0],["Bryant",10,23.0,0],["Mountain Home",10,22.0,0],["Hope",10,22.0,0],["Malvern",10,22.0,0],["Jonesboro",0,29.0,0],["Pine Bluff",0,28.0,0],["Sherwood",0,22.0,0],["Texarkana",0,28.0,0],["Russellville",0,22.0,0],["Paragould",0,28.0,0],["West Memphis",0,24.0,0],["El Dorado",0,30.0,0],["Maumelle",0,22.0,0],["Marion",0,31.0,0],["Blytheville",0,24.0,0],["Forrest City",0,22.0,0],["Arkadelphia",0,24.0,0],["Magnolia",0,24.0,0],["Camden",0,24.0,0],["Harrison",0,24.0,0],["Crossett",0,32.0,0]],"snow_blower_repair":[["Fayetteville",10,21.0,0],["Fort Smith",10,31.0,0],["Springdale",10,31.0,0],["Jonesboro",10,27.0,0],["Rogers",10,37.0,0],["Conway",10,38.0,0],["Pine Bluff",10,34.0,0],["Benton",10,31.0,0],["Hot Springs",10,37.0,0],["Sherwood",10,33.0,0],["Texarkana",10,39.0,0],["Russellville",10,35.0,0],["Jacksonville",10,37.0,0],["Paragould",10,34.0,0],["Bella Vista",10,40.0,0],["Cabot",10,31.0,0],["West Memphis",10,37.0,0],["Searcy",10,37.0,0],["Van Buren",10,31.0,0],["El Dorado",10,37.0,0],["Maumelle",10,37.0,0],["Marion",10,31.0,0],["Bryant",10,37.0,0],["Mountain Home",10,37.0,0],["Blytheville",10,31.0,0],["Forrest City",10,30.0,0],["Arkadelphia",10,38.0,0],["Magnolia",10,37.0,0],["Hope",10,28.0,0],["Camden",10,31.0,0],["Harrison",10,33.0,0],["Malvern",10,31.0,0],["Crossett",10,34.0,0],["Little Rock",0,27.0,0],["Bentonville",0,40.0,0]],"generator_repair":[["Little Rock",10,10.0,0],["Fayetteville",10,9.0,0],["Fort Smith",10,29.0,0],["Springdale",10,10.0,0],["Rogers",10,15.0,8.62],["Bentonville",10,18.0,0],["Benton",10,7.0,0],["Bella Vista",10,10.0,0],["Van Buren",10,14.0,0],["Maumelle",10,10.0,0],["Jonesboro",0,29.0,0],["Conway",0,7.0,0],["Pine Bluff",0,24.0,0],["Hot Springs",0,19.0,0],["Sherwood",0,9.0,0],["Texarkana",0,13.0,0],["Russellville",0,13.0,0],["Jacksonville",0,10.0,0],["Paragould",0,11.0,0],["Cabot",0,11.0,0],["West Memphis",0,18.0,0],["Searcy",0,13.0,0],["El Dorado",0,7.0,0],["Marion",0,10.0,0],["Bryant",0,18.0,0],["Mountain Home",0,28.0,0],["Blytheville",0,32.0,0],["Forrest City",0,11.0,0],["Arkadelphia",0,11.0,0],["Magnolia",0,18.0,0],["Hope",0,17.0,0],["Camden",0,11.0,0],["Harrison",0,18.0,0],["Malvern",0,6.0,0],["Crossett",0,16.0,0]],"motorcycle_repair":[["Little Rock",10,32.0,0],["Fayetteville",10,32.0,0],["Springdale",10,31.0,0],["Jonesboro",10,7.0,0],["Conway",10,39.0,0],["Hot Springs",10,31.0,0],["Paragould",10,32.0,0],["West Memphis",10,39.0,0],["Searcy",10,7.0,0],["Marion",10,47.0,0],["Magnolia",10,48.0,0],["Hope",10,45.0,0],["Camden",10,27.0,0],["Fort Smith",0,19.0,0],["Rogers",0,31.0,0],["Bentonville",0,10.0,0],["Pine Bluff",0,27.0,0],["Benton",0,21.0,0],["Sherwood",0,26.0,0],["Texarkana",0,38.0,0],["Russellville",0,32.0,0],["Jacksonville",0,40.0,0],["Bella Vista",0,32.0,0],["Cabot",0,36.0,0],["Van Buren",0,31.0,0],["El Dorado",0,32.0,0],["Maumelle",0,33.0,0],["Bryant",0,48.0,0],["Mountain Home",0,12.0,0],["Blytheville",0,38.0,0],["Forrest City",0,32.0,0],["Arkadelphia",0,36.0,0],["Harrison",0,30.0,0],["Malvern",0,41.0,0],["Crossett",0,43.0,0]]}],"Delaware":[[["Wilmington",71000],["Dover",39000],["Newark",34000],["Middletown",25000],["Smyrna",13000],["Milford",12000]],{"small_engine_repair":[["Wilmington",10,34.0,0],["Dover",10,31.0,0],["Newark",10,31.0,0],["Middletown",10,31.0,0],["Smyrna",10,28.0,0],["Milford",10,31.0,0]],"lawn_mower_repair":[["Wilmington",20,23.0,0],["Dover",10,18.0,0],["Newark",10,18.0,0],["Middletown",10,21.0,0],["Milford",10,18.0,0],["Smyrna",0,20.0,0]],"snow_blower_repair":[["Wilmington",10,23.0,0],["Dover",0,31.0,0],["Newark",0,31.0,0],["Middletown",0,31.0,0],["Smyrna",0,28.0,0],["Milford",0,27.0,0]],"generator_repair":[["Wilmington",30,17.0,0],["Newark",30,14.0,0],["Dover",10,29.0,0],["Milford",10,8.0,0],["Middletown",0,9.0,0],["Smyrna",0,18.0,0]],"motorcycle_repair":[["Wilmington",0,26.0,0],["Dover",0,17.0,0],["Newark",0,34.0,0],["Middletown",0,31.0,0],["Smyrna",0,26.0,0],["Milford",0,14.0,0]]}],"California":[[["Los Angeles",3820000],["San Diego",1420000],["San Jose",1010000],["San Francisco",820000],["Fresno",550000],["Sacramento",530000],["Long Beach",460000],["Oakland",430000],["Bakersfield",410000],["Anaheim",350000],["Riverside",320000],["Stockton",320000],["Irvine",310000],["Chula Vista",285000],["Fremont",240000],["San Bernardino",220000],["Modesto",220000],["Fontana",215000],["Oxnard",210000],["Moreno Valley",210000],["Huntington Beach",200000],["Glendale",200000],["Santa Clarita",180000],["Garden Grove",175000],["Santa Rosa",175000],["Oceanside",175000],["Rancho Cucamonga",175000],["Ontario",170000],["Elk Grove",170000],["Corona",165000],["Lancaster",160000],["Palmdale",160000],["Salinas",160000],["Hayward",160000],["Pomona",150000]],{"small_engine_repair":[["Rancho Cucamonga",90,31.0,0],["Los Angeles",70,31.0,0],["San Diego",40,31.0,0],["Sacramento",30,26.0,0],["San Jose",20,35.0,0],["San Francisco",20,31.0,0],["Fresno",20,24.0,0],["Riverside",20,30.0,0],["Long Beach",10,31.0,0],["Oakland",10,31.0,0],["Bakersfield",10,31.0,0],["Anaheim",10,31.0,0],["Irvine",10,31.0,0],["Chula Vista",10,31.0,0],["Fremont",10,31.0,0],["San Bernardino",10,31.0,0],["Modesto",10,31.0,0],["Fontana",10,31.0,0],["Oxnard",10,31.0,0],["Moreno Valley",10,31.0,0],["Huntington Beach",10,31.0,0],["Glendale",10,37.0,0],["Santa Clarita",10,31.0,0],["Garden Grove",10,31.0,0],["Santa Rosa",10,31.0,0],["Oceanside",10,31.0,0],["Ontario",10,31.0,0],["Elk Grove",10,40.0,0],["Corona",10,31.0,0],["Lancaster",10,31.0,0],["Palmdale",10,31.0,0],["Salinas",10,31.0,0],["Hayward",10,31.0,0],["Pomona",10,31.0,0],["Stockton",0,0,0]],"lawn_mower_repair":[["Los Angeles",140,28.0,2.17],["Sacramento",70,28.0,1.57],["San Diego",40,22.0,0],["San Jose",40,15.0,0],["Fresno",40,24.0,0],["Bakersfield",40,24.0,0],["Riverside",30,23.0,0],["Oakland",20,22.0,0],["Anaheim",20,9.0,0],["San Bernardino",20,28.0,0],["Modesto",20,24.0,0],["Fontana",20,31.0,0],["Long Beach",10,22.0,0],["Irvine",10,20.0,0],["Chula Vista",10,22.0,0],["Fremont",10,17.0,0],["Oxnard",10,27.0,0],["Moreno Valley",10,28.0,0],["Huntington Beach",10,22.0,0],["Glendale",10,31.0,0],["Santa Clarita",10,28.0,0],["Garden Grove",10,7.0,0],["Santa Rosa",10,18.0,0],["Oceanside",10,22.0,0],["Rancho Cucamonga",10,28.0,0],["Ontario",10,28.0,0],["Elk Grove",10,24.0,0],["Corona",10,25.0,0],["Lancaster",10,22.0,0],["Palmdale",10,28.0,0],["Salinas",10,5.0,0],["Hayward",10,15.0,0],["Pomona",10,28.0,0],["San Francisco",0,0,0],["Stockton",0,0,0]],"snow_blower_repair":[["San Francisco",10,32.0,0],["Anaheim",10,34.0,0],["Riverside",10,31.0,0],["Los Angeles",0,31.0,0],["San Diego",0,37.0,0],["San Jose",0,27.0,0],["Fresno",0,31.0,0],["Sacramento",0,31.0,0],["Long Beach",0,27.0,0],["Oakland",0,31.0,0],["Bakersfield",0,31.0,0],["Stockton",0,0,0],["Irvine",0,37.0,0],["Chula Vista",0,36.0,0],["Fremont",0,31.0,0],["San Bernardino",0,31.0,0],["Modesto",0,35.0,0],["Fontana",0,30.0,0],["Oxnard",0,37.0,0],["Moreno Valley",0,31.0,0],["Huntington Beach",0,31.0,0],["Glendale",0,34.0,0],["Santa Clarita",0,31.0,0],["Garden Grove",0,31.0,0],["Santa Rosa",0,34.0,0],["Oceanside",0,35.0,0],["Rancho Cucamonga",0,31.0,0],["Ontario",0,31.0,0],["Elk Grove",0,34.0,0],["Corona",0,34.0,0],["Lancaster",0,31.0,0],["Palmdale",0,31.0,0],["Salinas",0,31.0,0],["Hayward",0,31.0,0],["Pomona",0,35.0,0]],"generator_repair":[["San Jose",170,15.0,0],["Fremont",70,6.0,0],["Los Angeles",50,4.0,5.29],["San Diego",20,4.0,10.38],["San Francisco",10,2.0,3.58],["Fresno",10,8.0,0],["Sacramento",10,12.0,0],["Long Beach",10,10.0,0],["Oakland",10,14.0,0],["Bakersfield",10,7.0,0],["Anaheim",10,13.0,0],["Riverside",10,10.0,0],["Irvine",10,11.0,0],["Chula Vista",10,6.0,0],["San Bernardino",10,9.0,0],["Modesto",10,15.0,0],["Fontana",10,9.0,0],["Oxnard",10,14.0,0],["Moreno Valley",10,9.0,0],["Huntington Beach",10,9.0,0],["Glendale",10,6.0,0],["Santa Clarita",10,13.0,0],["Garden Grove",10,13.0,0],["Santa Rosa",10,27.0,0],["Oceanside",10,29.0,0],["Rancho Cucamonga",10,16.0,0],["Ontario",10,11.0,0],["Elk Grove",10,15.0,0],["Corona",10,10.0,0],["Lancaster",10,10.0,0],["Palmdale",10,19.0,0],["Pomona",10,18.0,0],["Stockton",0,0,0],["Salinas",0,10.0,0],["Hayward",0,4.0,0]],"motorcycle_repair":[["Los Angeles",170,36.0,1.74],["San Diego",70,41.0,2.7],["San Jose",30,25.0,0],["San Francisco",30,24.0,0],["Fontana",30,28.0,0],["Sacramento",20,21.0,0],["Long Beach",20,21.0,0],["Fresno",10,17.0,0],["Oakland",10,31.0,0],["Bakersfield",10,21.0,0],["Anaheim",10,18.0,0],["Riverside",10,22.0,0],["Irvine",10,17.0,0],["Chula Vista",10,19.0,0],["Fremont",10,32.0,0],["San Bernardino",10,22.0,0],["Modesto",10,32.0,0],["Oxnard",10,27.0,0],["Moreno Valley",10,31.0,0],["Huntington Beach",10,18.0,0],["Glendale",10,27.0,0],["Santa Clarita",10,15.0,0],["Garden Grove",10,19.0,0],["Santa Rosa",10,27.0,0],["Oceanside",10,23.0,0],["Rancho Cucamonga",10,28.0,0],["Ontario",10,14.0,0],["Elk Grove",10,27.0,0],["Corona",10,11.0,0],["Lancaster",10,32.0,0],["Palmdale",10,17.0,0],["Hayward",10,43.0,0],["Pomona",10,22.0,0],["Stockton",0,0,0],["Salinas",0,10.0,0]]}],"Wisconsin":[[["Milwaukee",565000],["Madison",275000],["Green Bay",107000],["Kenosha",100000],["Racine",77000],["Appleton",75000],["Waukesha",71000],["Eau Claire",69000],["Oshkosh",66000],["Janesville",65000],["West Allis",60000],["La Crosse",52000],["Sheboygan",49000],["Wauwatosa",48000],["Fond du Lac",44000],["Brookfield",40000],["New Berlin",39000],["Wausau",39000],["Beloit",36000],["Franklin",36000],["Oak Creek",35000],["Manitowoc",34000],["West Bend",32000],["Sun Prairie",31000],["Superior",26000],["Stevens Point",26000],["Neenah",25000],["Fitchburg",21000],["Muskego",21000],["De Pere",20000],["South Milwaukee",20000],["Marshfield",18000],["Cudahy",18000],["Menomonee Falls",18000],["Wisconsin Rapids",18000]],{"small_engine_repair":[["Milwaukee",30,30.0,0],["Madison",20,23.0,0],["Green Bay",10,24.0,0],["Kenosha",10,45.0,0],["Racine",10,28.0,0],["Appleton",10,28.0,0],["Waukesha",10,24.0,0],["Eau Claire",10,12.0,0],["Oshkosh",10,2.0,0],["Janesville",10,24.0,0],["West Allis",10,12.0,0],["La Crosse",10,28.0,0],["Sheboygan",10,30.0,0],["Wauwatosa",10,31.0,0],["Fond du Lac",10,28.0,0],["Brookfield",10,15.0,0],["New Berlin",10,12.0,0],["Wausau",10,25.0,0],["Beloit",10,24.0,0],["Franklin",10,22.0,0],["Oak Creek",10,12.0,0],["Manitowoc",10,31.0,0],["West Bend",10,31.0,0],["Sun Prairie",10,31.0,0],["Superior",10,31.0,0],["Stevens Point",10,30.0,0],["Neenah",10,22.0,0],["Fitchburg",10,24.0,0],["Muskego",10,28.0,0],["De Pere",10,24.0,0],["South Milwaukee",10,31.0,0],["Marshfield",10,15.0,0],["Cudahy",10,25.0,0],["Menomonee Falls",10,11.0,0],["Wisconsin Rapids",10,31.0,0]],"lawn_mower_repair":[["Milwaukee",40,28.0,2.21],["Madison",10,8.0,1.95],["Green Bay",10,24.0,0],["Kenosha",10,32.0,0],["Racine",10,22.0,0],["Appleton",10,4.0,0],["Waukesha",10,11.0,0],["Eau Claire",10,8.0,0],["Oshkosh",10,30.0,0],["Janesville",10,23.0,0],["West Allis",10,22.0,0],["La Crosse",10,23.0,0],["Wauwatosa",10,22.0,0],["Fond du Lac",10,22.0,0],["Brookfield",10,3.0,0],["New Berlin",10,30.0,0],["Wausau",10,23.0,0],["Beloit",10,18.0,0],["Franklin",10,22.0,0],["Oak Creek",10,29.0,0],["Manitowoc",10,3.0,0],["West Bend",10,3.0,0],["Sun Prairie",10,29.0,0],["Stevens Point",10,22.0,0],["Fitchburg",10,22.0,0],["Muskego",10,22.0,0],["South Milwaukee",10,20.0,0],["Menomonee Falls",10,9.0,0],["Wisconsin Rapids",10,24.0,0],["Sheboygan",0,34.0,0],["Superior",0,18.0,0],["Neenah",0,11.0,0],["De Pere",0,22.0,0],["Marshfield",0,7.0,0],["Cudahy",0,30.0,0]],"snow_blower_repair":[["Milwaukee",20,27.0,0],["Madison",10,8.0,0],["Green Bay",10,22.0,0],["Kenosha",10,19.0,0],["Waukesha",10,10.0,0],["Eau Claire",10,31.0,0],["Wauwatosa",10,17.0,0],["New Berlin",10,30.0,0],["Wisconsin Rapids",10,31.0,0],["Racine",0,22.0,0],["Appleton",0,4.0,0],["Oshkosh",0,20.0,0],["Janesville",0,19.0,0],["West Allis",0,17.0,0],["La Crosse",0,23.0,0],["Sheboygan",0,30.0,0],["Fond du Lac",0,4.0,0],["Brookfield",0,14.0,0],["Wausau",0,7.0,0],["Beloit",0,23.0,0],["Franklin",0,21.0,0],["Oak Creek",0,16.0,0],["Manitowoc",0,16.0,0],["West Bend",0,29.0,0],["Sun Prairie",0,36.0,0],["Superior",0,20.0,0],["Stevens Point",0,28.0,0],["Neenah",0,11.0,0],["Fitchburg",0,5.0,0],["Muskego",0,3.0,0],["De Pere",0,22.0,0],["South Milwaukee",0,16.0,0],["Marshfield",0,31.0,0],["Cudahy",0,17.0,0],["Menomonee Falls",0,10.0,0]],"generator_repair":[["Milwaukee",10,6.0,3.38],["Madison",10,9.0,0],["Oshkosh",10,10.0,0],["Janesville",10,10.0,0],["Beloit",10,18.0,0],["Sun Prairie",10,19.0,0],["Green Bay",0,10.0,0],["Kenosha",0,7.0,0],["Racine",0,19.0,0],["Appleton",0,9.0,0],["Waukesha",0,6.0,0],["Eau Claire",0,14.0,0],["West Allis",0,8.0,0],["La Crosse",0,10.0,0],["Sheboygan",0,10.0,0],["Wauwatosa",0,9.0,0],["Fond du Lac",0,32.0,0],["Brookfield",0,10.0,0],["New Berlin",0,18.0,0],["Wausau",0,7.0,0],["Franklin",0,18.0,0],["Oak Creek",0,8.0,0],["Manitowoc",0,18.0,0],["West Bend",0,10.0,0],["Superior",0,20.0,0],["Stevens Point",0,14.0,0],["Neenah",0,10.0,0],["Fitchburg",0,9.0,0],["Muskego",0,18.0,0],["De Pere",0,8.0,0],["South Milwaukee",0,6.0,0],["Marshfield",0,18.0,0],["Cudahy",0,10.0,0],["Menomonee Falls",0,10.0,0],["Wisconsin Rapids",0,32.0,0]],"motorcycle_repair":[["Milwaukee",10,35.0,0],["Madison",10,18.0,0],["Fitchburg",10,12.0,0],["Green Bay",0,46.0,0],["Kenosha",0,46.0,0],["Racine",0,28.0,0],["Appleton",0,17.0,0],["Waukesha",0,22.0,0],["Eau Claire",0,12.0,0],["Oshkosh",0,9.0,0],["Janesville",0,24.0,0],["West Allis",0,14.0,0],["La Crosse",0,28.0,0],["Sheboygan",0,10.0,0],["Wauwatosa",0,17.0,0],["Fond du Lac",0,29.0,0],["Brookfield",0,17.0,0],["New Berlin",0,46.0,0],["Wausau",0,32.0,0],["Beloit",0,20.0,0],["Franklin",0,16.0,0],["Oak Creek",0,18.0,0],["Manitowoc",0,28.0,0],["West Bend",0,22.0,0],["Sun Prairie",0,17.0,0],["Superior",0,35.0,0],["Stevens Point",0,25.0,0],["Neenah",0,26.0,0],["Muskego",0,25.0,0],["De Pere",0,9.0,0],["South Milwaukee",0,17.0,0],["Marshfield",0,30.0,0],["Cudahy",0,30.0,0],["Menomonee Falls",0,20.0,0],["Wisconsin Rapids",0,40.0,0]]}],"Florida":[[["Jacksonville",975000],["Miami",450000],["Tampa",410000],["Orlando",320000],["St. Petersburg",260000],["Hialeah",220000],["Port St. Lucie",220000],["Cape Coral",210000],["Tallahassee",200000],["Fort Lauderdale",185000],["Pembroke Pines",175000],["Hollywood",153000],["Miramar",152000],["Gainesville",145000],["Coral Springs",134000],["Miami Gardens",113000],["Clearwater",116000],["Palm Bay",120000],["Pompano Beach",112000],["West Palm Beach",117000],["Lakeland",115000],["Davie",111000],["Boca Raton",99000],["Sunrise",97000],["Plantation",96000],["Deltona",95000],["Largo",95000],["Palm Coast",93000],["Deerfield Beach",87000],["Melbourne",87000],["Boynton Beach",82000],["Lauderhill",80000],["Fort Myers",79000],["Weston",75000],["Sanford",61000]],{"small_engine_repair":[["Jacksonville",70,16.0,5.42],["Tampa",50,37.0,0],["Orlando",50,31.0,0],["St. Petersburg",41,31.0,0],["Miami",20,31.0,0],["Cape Coral",20,28.0,0],["Tallahassee",20,28.0,0],["Fort Lauderdale",20,39.0,0],["Clearwater",20,31.0,0],["Palm Bay",20,37.0,0],["Pompano Beach",20,21.0,0],["Lakeland",20,28.0,0],["Largo",20,31.0,0],["Fort Myers",20,24.0,0],["Hialeah",10,31.0,0],["Port St. Lucie",10,31.0,0],["Pembroke Pines",10,42.0,0],["Hollywood",10,36.0,0],["Gainesville",10,38.0,0],["Coral Springs",10,16.0,0],["Miami Gardens",10,40.0,0],["West Palm Beach",10,30.0,1.57],["Davie",10,20.0,0],["Boca Raton",10,11.0,4.66],["Sunrise",10,18.0,0],["Plantation",10,31.0,0],["Deltona",10,31.0,0],["Palm Coast",10,31.0,0],["Deerfield Beach",10,31.0,0],["Melbourne",10,37.0,0],["Boynton Beach",10,24.0,0],["Lauderhill",10,24.0,0],["Sanford",10,31.0,0],["Miramar",0,31.0,0],["Weston",0,35.0,0]],"lawn_mower_repair":[["Jacksonville",90,10.0,1.46],["Miami",50,23.0,1.41],["Tampa",50,23.0,1.66],["Orlando",50,23.0,1.05],["St. Petersburg",20,28.0,0],["Port St. Lucie",20,22.0,0],["Cape Coral",20,28.0,0],["Tallahassee",20,8.0,0],["Fort Lauderdale",20,24.0,0],["Hollywood",20,23.0,0],["West Palm Beach",20,7.0,2.39],["Lakeland",20,24.0,0],["Hialeah",10,28.0,0],["Pembroke Pines",10,28.0,1.57],["Miramar",10,28.0,0],["Gainesville",10,23.0,1.64],["Coral Springs",10,23.0,0],["Miami Gardens",10,23.0,0.77],["Clearwater",10,28.0,0],["Palm Bay",10,28.0,0],["Pompano Beach",10,24.0,0],["Davie",10,23.0,0],["Boca Raton",10,5.0,0],["Sunrise",10,28.0,0],["Plantation",10,24.0,0],["Deltona",10,24.0,1.0],["Largo",10,28.0,0],["Palm Coast",10,24.0,0],["Deerfield Beach",10,24.0,0],["Boynton Beach",10,8.0,0],["Lauderhill",10,24.0,1.12],["Fort Myers",10,22.0,0],["Sanford",10,31.0,0],["Melbourne",0,24.0,0],["Weston",0,23.0,0]],"snow_blower_repair":[["Gainesville",10,31.0,0],["Coral Springs",10,23.0,0],["Miami Gardens",10,34.0,0],["Lakeland",10,31.0,0],["Davie",10,16.0,0],["Boca Raton",10,31.0,0],["Sunrise",10,37.0,0],["Plantation",10,34.0,0],["Deltona",10,31.0,0],["Largo",10,34.0,0],["Palm Coast",10,34.0,0],["Deerfield Beach",10,30.0,0],["Melbourne",10,37.0,0],["Lauderhill",10,34.0,0],["Weston",10,34.0,0],["Sanford",10,24.0,0],["Jacksonville",0,27.0,0],["Miami",0,34.0,0],["Tampa",0,16.0,0],["Orlando",0,31.0,0],["St. Petersburg",0,31.0,0],["Hialeah",0,34.0,0],["Port St. Lucie",0,35.0,0],["Cape Coral",0,31.0,0],["Tallahassee",0,31.0,0],["Fort Lauderdale",0,31.0,0],["Pembroke Pines",0,34.0,0],["Hollywood",0,31.0,0],["Miramar",0,31.0,0],["Clearwater",0,28.0,0],["Palm Bay",0,35.0,0],["Pompano Beach",0,31.0,0],["West Palm Beach",0,28.0,0],["Boynton Beach",0,31.0,0],["Fort Myers",0,31.0,0]],"generator_repair":[["Miami",20,9.0,4.49],["Orlando",20,29.0,7.14],["Jacksonville",10,4.0,6.22],["Tampa",10,6.0,9.99],["St. Petersburg",10,11.0,0],["Hialeah",10,7.0,0],["Port St. Lucie",10,8.0,0],["Cape Coral",10,7.0,18.13],["Tallahassee",10,4.0,0],["Fort Lauderdale",10,9.0,18.44],["Pembroke Pines",10,9.0,0],["Hollywood",10,9.0,0],["Miramar",10,17.0,0],["Gainesville",10,29.0,0],["Miami Gardens",10,6.0,0],["Clearwater",10,4.0,0],["Palm Bay",10,8.0,0],["Pompano Beach",10,9.0,0],["West Palm Beach",10,9.0,0],["Lakeland",10,3.0,0],["Davie",10,13.0,0],["Boca Raton",10,9.0,0],["Sunrise",10,10.0,0],["Plantation",10,7.0,0],["Deltona",10,6.0,0],["Largo",10,5.0,0],["Palm Coast",10,9.0,0],["Deerfield Beach",10,18.0,0],["Melbourne",10,29.0,6.42],["Boynton Beach",10,9.0,22.13],["Lauderhill",10,6.0,0],["Fort Myers",10,8.0,18.13],["Sanford",10,11.0,0],["Coral Springs",0,9.0,0],["Weston",0,9.0,0]],"motorcycle_repair":[["Miami",110,25.0,1.27],["Jacksonville",70,16.0,0],["Orlando",50,14.0,0],["Tampa",40,16.0,1.25],["St. Petersburg",20,8.0,0],["Cape Coral",20,9.0,0],["Tallahassee",20,30.0,0],["Hialeah",10,19.0,0],["Port St. Lucie",10,31.0,0],["Fort Lauderdale",10,36.0,1.78],["Pembroke Pines",10,21.0,0],["Hollywood",10,8.0,0],["Miramar",10,41.0,0],["Gainesville",10,41.0,0],["Coral Springs",10,18.0,0],["Miami Gardens",10,30.0,0],["Clearwater",10,17.0,0],["Palm Bay",10,10.0,0],["Pompano Beach",10,36.0,0],["West Palm Beach",10,27.0,0],["Lakeland",10,31.0,0],["Davie",10,30.0,0],["Boca Raton",10,50.0,0],["Sunrise",10,9.0,0],["Plantation",10,22.0,0],["Deltona",10,16.0,0],["Largo",10,9.0,0],["Palm Coast",10,28.0,0],["Deerfield Beach",10,30.0,0],["Melbourne",10,4.0,0],["Boynton Beach",10,38.0,0],["Lauderhill",10,39.0,0],["Fort Myers",10,15.0,0],["Weston",10,20.0,0],["Sanford",0,31.0,0]]}],"Georgia":[[["Atlanta",510000],["Columbus",207000],["Augusta",206000],["Macon",156000],["Savannah",150000],["Athens",130000],["Sandy Springs",110000],["Roswell",95000],["Johns Creek",83000],["Warner Robins",81000],["Albany",68000],["Alpharetta",67000],["Marietta",61000],["Smyrna",56000],["Valdosta",55000],["Brookhaven",55000],["Dunwoody",53000],["Gainesville",43000],["Peachtree Corners",43000],["Newnan",42000],["Milton",42000],["Hinesville",34000],["Dalton",34000],["Statesboro",33000],["Rome",32000],["East Point",31000],["Douglasville",31000],["Kennesaw",30000],["LaGrange",30000],["Lawrenceville",29000],["Stockbridge",29000],["McDonough",28000],["Carrollton",27000],["Canton",26000]],{"small_engine_repair":[["Atlanta",110,31.0,0],["Macon",20,28.0,0],["Savannah",20,24.0,0],["Columbus",10,30.0,0],["Augusta",10,31.0,0],["Athens",10,25.0,0],["Sandy Springs",10,31.0,0],["Roswell",10,25.0,0],["Johns Creek",10,51.0,0],["Warner Robins",10,31.0,0],["Albany",10,31.0,0],["Alpharetta",10,16.0,0],["Marietta",10,30.0,0],["Smyrna",10,28.0,0],["Valdosta",10,31.0,0],["Brookhaven",10,31.0,0],["Dunwoody",10,42.0,0],["Gainesville",10,28.0,0],["Peachtree Corners",10,37.0,0],["Newnan",10,31.0,0],["Milton",10,30.0,0],["Hinesville",10,31.0,0],["Dalton",10,31.0,0],["Statesboro",10,31.0,0],["Rome",10,31.0,0],["East Point",10,41.0,0],["Douglasville",10,31.0,0],["Kennesaw",10,28.0,0],["LaGrange",10,28.0,0],["Lawrenceville",10,31.0,0],["Stockbridge",10,31.0,0],["McDonough",10,31.0,0],["Carrollton",10,31.0,0],["Canton",10,31.0,0]],"lawn_mower_repair":[["Atlanta",140,14.0,1.28],["Columbus",20,24.0,0],["Augusta",20,24.0,0],["Savannah",20,18.0,0],["Athens",20,21.0,0],["Sandy Springs",20,19.0,0],["Alpharetta",20,8.0,2.35],["Marietta",20,27.0,2.16],["Lawrenceville",20,12.0,1.54],["Canton",20,23.0,0],["Macon",10,22.0,0],["Roswell",10,14.0,0],["Johns Creek",10,6.0,3.15],["Warner Robins",10,24.0,0],["Albany",10,24.0,0],["Smyrna",10,22.0,0],["Valdosta",10,28.0,0],["Brookhaven",10,23.0,0],["Dunwoody",10,18.0,0],["Gainesville",10,23.0,0],["Peachtree Corners",10,19.0,0],["Newnan",10,26.0,0],["Milton",10,14.0,0],["Hinesville",10,24.0,0],["Dalton",10,24.0,0],["Statesboro",10,22.0,0],["Rome",10,28.0,0],["Stockbridge",10,20.0,1.4],["McDonough",10,24.0,1.41],["Carrollton",10,8.0,0],["East Point",0,20.0,0],["Douglasville",0,24.0,0],["Kennesaw",0,29.0,0],["LaGrange",0,24.0,0]],"snow_blower_repair":[["Macon",10,27.0,0],["Sandy Springs",10,31.0,0],["Roswell",10,31.0,0],["Johns Creek",10,23.0,0],["Albany",10,29.0,0],["Alpharetta",10,31.0,0],["Marietta",10,31.0,0],["Smyrna",10,27.0,0],["Valdosta",10,34.0,0],["Brookhaven",10,31.0,0],["Dunwoody",10,31.0,0],["Peachtree Corners",10,31.0,0],["Newnan",10,34.0,0],["Milton",10,31.0,0],["Hinesville",10,31.0,0],["Dalton",10,35.0,0],["Statesboro",10,27.0,0],["Rome",10,27.0,0],["East Point",10,31.0,0],["Douglasville",10,28.0,0],["Kennesaw",10,22.0,0],["LaGrange",10,31.0,0],["Lawrenceville",10,28.0,0],["Stockbridge",10,31.0,0],["McDonough",10,31.0,0],["Carrollton",10,31.0,0],["Canton",10,37.0,0],["Atlanta",0,31.0,0],["Columbus",0,31.0,0],["Augusta",0,23.0,0],["Savannah",0,37.0,0],["Athens",0,31.0,0],["Warner Robins",0,35.0,0],["Gainesville",0,30.0,0]],"generator_repair":[["Atlanta",30,12.0,11.54],["Columbus",10,29.0,0],["Augusta",10,14.0,0],["Macon",10,31.0,0],["Savannah",10,7.0,0],["Athens",10,11.0,0],["Sandy Springs",10,12.0,0],["Johns Creek",10,7.0,0],["Alpharetta",10,8.0,0],["Marietta",10,29.0,0],["Valdosta",10,29.0,0],["Gainesville",10,11.0,0],["Hinesville",10,22.0,0],["Kennesaw",10,13.0,0],["Lawrenceville",10,13.0,0],["Stockbridge",10,10.0,0],["McDonough",10,12.0,0],["Roswell",0,12.0,0],["Warner Robins",0,25.0,0],["Albany",0,26.0,0],["Smyrna",0,11.0,0],["Brookhaven",0,12.0,0],["Dunwoody",0,12.0,0],["Peachtree Corners",0,12.0,0],["Newnan",0,13.0,0],["Milton",0,13.0,0],["Dalton",0,19.0,0],["Statesboro",0,21.0,0],["Rome",0,23.0,0],["East Point",0,13.0,0],["Douglasville",0,12.0,0],["LaGrange",0,13.0,0],["Carrollton",0,11.0,0],["Canton",0,11.0,0]],"motorcycle_repair":[["Atlanta",70,10.0,0],["Columbus",20,23.0,0],["Savannah",20,21.0,0],["Athens",10,23.0,0],["Sandy Springs",10,31.0,0],["Roswell",10,7.0,0],["Johns Creek",10,24.0,0],["Albany",10,36.0,0],["Alpharetta",10,6.0,0],["Marietta",10,9.0,0],["Smyrna",10,14.0,0],["Valdosta",10,28.0,0],["Douglasville",10,21.0,0],["Kennesaw",10,19.0,0],["Lawrenceville",10,31.0,0],["Augusta",0,0,0],["Macon",0,21.0,0],["Warner Robins",0,47.0,0],["Brookhaven",0,11.0,0],["Dunwoody",0,6.0,0],["Gainesville",0,22.0,0],["Peachtree Corners",0,15.0,0],["Newnan",0,19.0,0],["Milton",0,23.0,0],["Hinesville",0,25.0,0],["Dalton",0,24.0,0],["Statesboro",0,35.0,0],["Rome",0,17.0,0],["East Point",0,6.0,0],["LaGrange",0,25.0,0],["Stockbridge",0,20.0,0],["McDonough",0,36.0,0],["Carrollton",0,27.0,0],["Canton",0,9.0,0]]}],"Connecticut":[[["Bridgeport",150000],["Stamford",137000],["New Haven",134000],["Hartford",121000],["Waterbury",115000],["Norwalk",92000],["Danbury",87000],["New Britain",74000],["West Hartford",64000],["Greenwich",63000],["Fairfield",62000],["Hamden",61000],["Bristol",60000],["Meriden",60000],["Manchester",59000],["West Haven",56000],["Milford",54000],["Stratford",52000],["East Hartford",50000],["Middletown",48000],["Wallingford",45000],["Enfield",44000],["Southington",44000],["Shelton",43000],["Norwich",41000],["Trumbull",39000],["Torrington",36000],["Newington",30000],["Naugatuck",31000],["Vernon",29000]],{"small_engine_repair":[["Bridgeport",10,28.0,0],["Stamford",10,31.0,0],["New Haven",10,62.0,0],["Hartford",10,39.0,0],["Waterbury",10,20.0,0],["Norwalk",10,31.0,0],["Danbury",10,31.0,0],["New Britain",10,31.0,0],["West Hartford",10,28.0,0],["Greenwich",10,31.0,0],["Fairfield",10,31.0,0],["Hamden",10,31.0,0],["Bristol",10,31.0,0],["Meriden",10,31.0,0],["Manchester",10,27.0,0],["West Haven",10,31.0,0],["Milford",10,54.0,0],["Stratford",10,31.0,0],["East Hartford",10,39.0,0],["Middletown",10,31.0,0],["Wallingford",10,31.0,0],["Enfield",10,31.0,0],["Southington",10,36.0,0],["Shelton",10,31.0,0],["Norwich",10,18.0,0],["Trumbull",10,31.0,0],["Torrington",10,31.0,0],["Newington",10,31.0,0],["Vernon",10,7.0,0],["Naugatuck",0,31.0,0]],"lawn_mower_repair":[["Bridgeport",10,5.0,0],["Stamford",10,2.0,0],["New Haven",10,3.0,0],["Hartford",10,7.0,1.57],["Waterbury",10,18.0,0],["Norwalk",10,22.0,0],["Danbury",10,18.0,0],["New Britain",10,7.0,0],["West Hartford",10,18.0,0],["Greenwich",10,23.0,0],["Fairfield",10,23.0,0],["Hamden",10,22.0,0],["Bristol",10,24.0,0],["Meriden",10,22.0,0],["Manchester",10,22.0,0],["West Haven",10,18.0,0],["Milford",10,18.0,0],["Stratford",10,28.0,0],["East Hartford",10,5.0,0],["Middletown",10,12.0,0],["Wallingford",10,22.0,0],["Enfield",10,22.0,0],["Torrington",10,12.0,0],["Newington",10,7.0,0],["Southington",0,3.0,0],["Shelton",0,17.0,0],["Norwich",0,22.0,0],["Trumbull",0,44.0,0],["Naugatuck",0,18.0,0],["Vernon",0,4.0,0]],"snow_blower_repair":[["New Haven",10,3.0,0],["Hartford",10,9.0,0],["Danbury",10,5.0,0],["Hamden",10,3.0,0],["West Haven",10,3.0,0],["Stratford",10,23.0,0],["Vernon",10,21.0,0],["Bridgeport",0,27.0,0],["Stamford",0,23.0,0],["Waterbury",0,3.0,0],["Norwalk",0,23.0,0],["New Britain",0,15.0,0],["West Hartford",0,4.0,0],["Greenwich",0,31.0,0],["Fairfield",0,15.0,0],["Bristol",0,22.0,0],["Meriden",0,10.0,0],["Manchester",0,4.0,0],["Milford",0,3.0,0],["East Hartford",0,4.0,0],["Middletown",0,15.0,0],["Wallingford",0,15.0,0],["Enfield",0,7.0,0],["Southington",0,3.0,0],["Shelton",0,15.0,0],["Norwich",0,17.0,0],["Trumbull",0,24.0,0],["Torrington",0,16.0,0],["Newington",0,4.0,0],["Naugatuck",0,3.0,0]],"generator_repair":[["Bridgeport",10,4.0,0],["New Haven",10,4.0,0],["Hartford",10,3.0,0],["Norwalk",10,4.0,0],["Greenwich",10,5.0,0],["Hamden",10,4.0,7.7],["Middletown",10,12.0,0],["Enfield",10,4.0,0],["Stamford",0,4.0,0],["Waterbury",0,5.0,0],["Danbury",0,5.0,0],["New Britain",0,7.0,0],["West Hartford",0,4.0,0],["Fairfield",0,4.0,0],["Bristol",0,4.0,0],["Meriden",0,8.0,0],["Manchester",0,3.0,0],["West Haven",0,4.0,0],["Milford",0,8.0,0],["Stratford",0,8.0,0],["East Hartford",0,3.0,0],["Wallingford",0,24.0,0],["Southington",0,6.0,0],["Shelton",0,3.0,0],["Norwich",0,4.0,0],["Trumbull",0,4.0,0],["Torrington",0,9.0,0],["Newington",0,7.0,0],["Naugatuck",0,7.0,0],["Vernon",0,3.0,0]],"motorcycle_repair":[["Bridgeport",10,20.0,0],["Stamford",10,46.0,0],["New Haven",10,8.0,0],["Hartford",10,8.0,0],["Waterbury",0,46.0,0],["Norwalk",0,46.0,0],["Danbury",0,7.0,0],["New Britain",0,7.0,0],["West Hartford",0,10.0,0],["Greenwich",0,36.0,0],["Fairfield",0,30.0,0],["Hamden",0,46.0,0],["Bristol",0,20.0,0],["Meriden",0,30.0,0],["Manchester",0,7.0,0],["West Haven",0,7.0,0],["Milford",0,25.0,0],["Stratford",0,37.0,0],["East Hartford",0,14.0,0],["Middletown",0,7.0,0],["Wallingford",0,18.0,0],["Enfield",0,17.0,0],["Southington",0,12.0,0],["Shelton",0,16.0,0],["Norwich",0,23.0,0],["Trumbull",0,16.0,0],["Torrington",0,7.0,0],["Newington",0,19.0,0],["Naugatuck",0,13.0,0],["Vernon",0,33.0,0]]}],"Colorado":[[["Denver",710000],["Colorado Springs",490000],["Aurora",405000],["Fort Collins",175000],["Lakewood",160000],["Thornton",145000],["Arvada",125000],["Westminster",115000],["Pueblo",112000],["Greeley",111000],["Centennial",110000],["Boulder",108000],["Highlands Ranch",107000],["Longmont",100000],["Loveland",80000],["Broomfield",77000],["Castle Rock",75000],["Grand Junction",72000],["Commerce City",70000],["Parker",65000],["Littleton",45000],["Brighton",43000],["Northglenn",39000],["Englewood",35000],["Wheat Ridge",33000],["Fountain",30000],["Lafayette",29000],["Windsor",28000],["Erie",26000],["Golden",25000],["Louisville",23000],["Montrose",22000],["Evans",20000],["Durango",17000]],{"small_engine_repair":[["Denver",90,43.0,3.48],["Colorado Springs",40,23.0,2.22],["Aurora",20,28.0,1.82],["Fort Collins",20,28.0,0],["Lakewood",20,45.0,0],["Pueblo",20,28.0,0],["Thornton",10,36.0,0],["Arvada",10,50.0,0],["Westminster",10,63.0,0],["Greeley",10,28.0,0],["Centennial",10,44.0,0],["Boulder",10,23.0,0],["Highlands Ranch",10,57.0,0],["Longmont",10,30.0,0],["Loveland",10,34.0,0],["Broomfield",10,44.0,0],["Castle Rock",10,24.0,0],["Grand Junction",10,28.0,0],["Commerce City",10,24.0,0],["Parker",0,0,0],["Littleton",0,0,0],["Brighton",0,0,0],["Northglenn",0,0,0],["Englewood",0,0,0],["Wheat Ridge",0,0,0],["Fountain",0,0,0],["Lafayette",0,0,0],["Windsor",0,0,0],["Erie",0,0,0],["Golden",0,0,0],["Louisville",0,0,0],["Montrose",0,0,0],["Evans",0,0,0],["Durango",0,0,0],["Ca\u00f1on City",0,0,0]],"lawn_mower_repair":[["Denver",90,35.0,1.97],["Colorado Springs",30,5.0,1.44],["Aurora",20,23.0,0],["Thornton",20,22.0,0],["Westminster",20,22.0,0],["Fort Collins",10,24.0,0],["Lakewood",10,23.0,0],["Arvada",10,24.0,0],["Pueblo",10,24.0,0],["Greeley",10,24.0,0],["Centennial",10,35.0,0],["Boulder",10,14.0,0],["Highlands Ranch",10,20.0,0],["Longmont",10,23.0,0],["Loveland",10,23.0,0],["Broomfield",10,18.0,0],["Castle Rock",10,31.0,0],["Grand Junction",10,22.0,0],["Commerce City",10,26.0,0],["Parker",0,0,0],["Littleton",0,0,0],["Brighton",0,0,0],["Northglenn",0,0,0],["Englewood",0,0,0],["Wheat Ridge",0,0,0],["Fountain",0,0,0],["Lafayette",0,0,0],["Windsor",0,0,0],["Erie",0,0,0],["Golden",0,0,0],["Louisville",0,0,0],["Montrose",0,0,0],["Evans",0,0,0],["Durango",0,0,0],["Ca\u00f1on City",0,0,0]],"snow_blower_repair":[["Denver",10,27.0,0],["Colorado Springs",10,4.0,0],["Aurora",10,26.0,0],["Lakewood",10,13.0,0],["Centennial",10,27.0,0],["Highlands Ranch",10,23.0,0],["Castle Rock",10,2.0,0],["Grand Junction",10,28.0,0],["Fort Collins",0,3.0,0],["Thornton",0,19.0,0],["Arvada",0,19.0,0],["Westminster",0,11.0,0],["Pueblo",0,2.0,0],["Greeley",0,24.0,0],["Boulder",0,8.0,0],["Longmont",0,27.0,0],["Loveland",0,26.0,0],["Broomfield",0,8.0,0],["Commerce City",0,19.0,0],["Parker",0,0,0],["Littleton",0,0,0],["Brighton",0,0,0],["Northglenn",0,0,0],["Englewood",0,0,0],["Wheat Ridge",0,0,0],["Fountain",0,0,0],["Lafayette",0,0,0],["Windsor",0,0,0],["Erie",0,0,0],["Golden",0,0,0],["Louisville",0,0,0],["Montrose",0,0,0],["Evans",0,0,0],["Durango",0,0,0],["Ca\u00f1on City",0,0,0]],"generator_repair":[["Denver",20,12.0,23.39],["Colorado Springs",10,8.0,0],["Aurora",10,10.0,0],["Lakewood",10,9.0,0],["Thornton",10,11.0,0],["Westminster",10,11.0,16.53],["Pueblo",10,8.0,0],["Loveland",10,9.0,0],["Grand Junction",10,25.0,0],["Fort Collins",0,10.0,0],["Arvada",0,9.0,0],["Greeley",0,29.0,0],["Centennial",0,12.0,0],["Boulder",0,7.0,0],["Highlands Ranch",0,10.0,0],["Longmont",0,7.0,0],["Broomfield",0,29.0,0],["Castle Rock",0,9.0,0],["Commerce City",0,13.0,0],["Parker",0,0,0],["Littleton",0,0,0],["Brighton",0,0,0],["Northglenn",0,0,0],["Englewood",0,0,0],["Wheat Ridge",0,0,0],["Fountain",0,0,0],["Lafayette",0,0,0],["Windsor",0,0,0],["Erie",0,0,0],["Golden",0,0,0],["Louisville",0,0,0],["Montrose",0,0,0],["Evans",0,0,0],["Durango",0,0,0],["Ca\u00f1on City",0,0,0]],"motorcycle_repair":[["Denver",30,19.0,1.32],["Colorado Springs",20,25.0,0],["Aurora",10,12.0,0],["Fort Collins",10,15.0,0],["Lakewood",10,16.0,0],["Thornton",10,19.0,0],["Arvada",10,37.0,0],["Westminster",10,27.0,0],["Pueblo",10,32.0,0],["Greeley",10,10.0,0],["Centennial",10,27.0,0],["Boulder",10,24.0,0],["Longmont",10,32.0,0],["Broomfield",10,0.37,0],["Castle Rock",10,22.0,0],["Grand Junction",10,17.0,0],["Commerce City",10,0.29,0],["Highlands Ranch",0,16.0,0],["Loveland",0,0.18,0],["Parker",0,0,0],["Littleton",0,0,0],["Brighton",0,0,0],["Northglenn",0,0,0],["Englewood",0,0,0],["Wheat Ridge",0,0,0],["Fountain",0,0,0],["Lafayette",0,0,0],["Windsor",0,0,0],["Erie",0,0,0],["Golden",0,0,0],["Louisville",0,0,0],["Montrose",0,0,0],["Evans",0,0,0],["Durango",0,0,0],["Ca\u00f1on City",0,0,0]]}],"Hawaii":[[["Honolulu",350000],["Pearl City",45000],["Hilo",44000],["Waipahu",43000],["Kailua (O\u2018ahu)",40000],["Kaneohe",37000],["Ewa Gentry",25000],["Kahului",24000],["Kihei",23000],["Kapolei",21000],["Wahiawa",18000],["Schofield Barracks",18000],["Wailuku",17000]],{"small_engine_repair":[["Pearl City",10,31.0,0],["Hilo",10,31.0,0],["Waipahu",10,28.0,0],["Kailua (O\u2018ahu)",10,28.0,0],["Kaneohe",10,29.0,0],["Ewa Gentry",10,31.0,0],["Kapolei",10,31.0,0],["Wailuku",10,44.0,0],["Honolulu",0,28.0,0],["Kahului",0,50.0,0],["Kihei",0,37.0,0],["Wahiawa",0,31.0,0],["Schofield Barracks",0,41.0,0]],"lawn_mower_repair":[["Honolulu",10,18.0,0],["Pearl City",10,20.0,0],["Hilo",10,24.0,0],["Waipahu",10,18.0,0],["Kailua (O\u2018ahu)",10,18.0,0],["Kaneohe",10,22.0,0],["Wahiawa",10,18.0,0],["Ewa Gentry",0,18.0,0],["Kahului",0,18.0,0],["Kihei",0,37.0,0],["Kapolei",0,28.0,0],["Schofield Barracks",0,28.0,0],["Wailuku",0,21.0,0]],"snow_blower_repair":[["Pearl City",10,31.0,0],["Hilo",10,39.0,0],["Waipahu",10,31.0,0],["Kailua (O\u2018ahu)",10,31.0,0],["Kaneohe",10,31.0,0],["Ewa Gentry",10,39.0,0],["Kahului",10,31.0,0],["Kihei",10,31.0,0],["Kapolei",10,37.0,0],["Wahiawa",10,31.0,0],["Schofield Barracks",10,31.0,0],["Wailuku",10,31.0,0],["Honolulu",0,31.0,0]],"generator_repair":[["Honolulu",10,10.0,0],["Hilo",10,29.0,0],["Ewa Gentry",10,18.0,0],["Pearl City",0,10.0,0],["Waipahu",0,10.0,0],["Kailua (O\u2018ahu)",0,5.0,0],["Kaneohe",0,10.0,0],["Kahului",0,17.0,0],["Kihei",0,17.0,0],["Kapolei",0,29.0,0],["Wahiawa",0,4.0,0],["Schofield Barracks",0,11.0,0],["Wailuku",0,28.0,0]],"motorcycle_repair":[["Honolulu",10,22.0,0],["Pearl City",0,18.0,0],["Hilo",0,31.0,0],["Waipahu",0,18.0,0],["Kailua (O\u2018ahu)",0,24.0,0],["Kaneohe",0,26.0,0],["Ewa Gentry",0,39.0,0],["Kahului",0,47.0,0],["Kihei",0,24.0,0],["Kapolei",0,25.0,0],["Wahiawa",0,19.0,0],["Schofield Barracks",0,24.0,0],["Wailuku",0,47.0,0]]}],"Idaho":[[["Boise",240000],["Meridian",140000],["Nampa",110000],["Idaho Falls",68000],["Caldwell",63000],["Pocatello",57000],["Twin Falls",43000],["Rexburg",40000],["Lewiston",34000],["Eagle",33000],["Moscow",26000],["Kuna",25000],["Ammon",17000],["Chubbuck",15000],["Hayden",15000],["Jerome",12000],["Blackfoot",12000],["Garden City",12000],["Mountain Home",12000],["Star",11000],["Rathdrum",10000],["Payette",10000],["Sandpoint",10000],["Middleton",10000],["Burley",10000],["Emmett",10000],["Weiser",10000],["Rupert",10000],["Gooding",10000],["Hailey",10000],["Preston",10000],["Shelley",10000],["Homedale",10000]],{"small_engine_repair":[["Boise",30,31.0,0],["Meridian",10,31.0,0],["Nampa",10,24.0,0],["Idaho Falls",10,18.0,0],["Caldwell",10,26.0,0],["Eagle",10,31.0,0],["Moscow",10,31.0,0],["Kuna",10,31.0,0],["Ammon",10,28.0,0],["Chubbuck",10,31.0,0],["Blackfoot",10,30.0,0],["Garden City",10,23.0,0],["Mountain Home",10,31.0,0],["Star",10,22.0,0],["Rathdrum",10,31.0,0],["Sandpoint",10,33.0,0],["Middleton",10,28.0,0],["Burley",10,31.0,0],["Emmett",10,33.0,0],["Shelley",10,31.0,0],["Pocatello",0,24.0,0],["Twin Falls",0,46.0,0],["Rexburg",0,23.0,0],["Lewiston",0,32.0,0],["Hayden",0,34.0,0],["Jerome",0,30.0,0],["Payette",0,31.0,0],["Weiser",0,31.0,0],["Rupert",0,40.0,0],["Gooding",0,42.0,0],["Hailey",0,36.0,0],["Preston",0,31.0,0],["Homedale",0,23.0,0]],"lawn_mower_repair":[["Boise",30,28.0,0],["Nampa",20,28.0,0],["Meridian",10,23.0,0],["Idaho Falls",10,28.0,0],["Caldwell",10,23.0,0],["Pocatello",10,30.0,0],["Twin Falls",10,28.0,0],["Lewiston",10,24.0,0],["Eagle",10,24.0,0],["Kuna",10,22.0,0],["Ammon",10,28.0,0],["Garden City",10,28.0,0],["Middleton",10,24.0,0],["Rexburg",0,28.0,0],["Moscow",0,31.0,0],["Chubbuck",0,31.0,0],["Hayden",0,31.0,0],["Jerome",0,31.0,0],["Blackfoot",0,22.0,0],["Mountain Home",0,26.0,0],["Star",0,23.0,0],["Rathdrum",0,31.0,0],["Payette",0,22.0,0],["Sandpoint",0,24.0,0],["Burley",0,28.0,0],["Emmett",0,31.0,0],["Weiser",0,31.0,0],["Rupert",0,28.0,0],["Gooding",0,31.0,0],["Hailey",0,35.0,0],["Preston",0,31.0,0],["Shelley",0,28.0,0],["Homedale",0,24.0,0]],"snow_blower_repair":[["Caldwell",10,31.0,0],["Rexburg",10,31.0,0],["Lewiston",10,31.0,0],["Moscow",10,31.0,0],["Hayden",10,24.0,0],["Jerome",10,30.0,0],["Blackfoot",10,31.0,0],["Garden City",10,31.0,0],["Mountain Home",10,31.0,0],["Star",10,31.0,0],["Rathdrum",10,31.0,0],["Payette",10,31.0,0],["Burley",10,34.0,0],["Emmett",10,31.0,0],["Weiser",10,30.0,0],["Rupert",10,30.0,0],["Gooding",10,31.0,0],["Preston",10,31.0,0],["Shelley",10,35.0,0],["Homedale",10,27.0,0],["Boise",0,31.0,0],["Meridian",0,31.0,0],["Nampa",0,31.0,0],["Idaho Falls",0,31.0,0],["Pocatello",0,31.0,0],["Twin Falls",0,31.0,0],["Eagle",0,31.0,0],["Kuna",0,31.0,0],["Ammon",0,31.0,0],["Chubbuck",0,31.0,0],["Sandpoint",0,31.0,0],["Middleton",0,27.0,0],["Hailey",0,16.0,0]],"generator_repair":[["Boise",10,8.0,0],["Nampa",10,8.0,0],["Weiser",10,16.0,0],["Rupert",10,32.0,0],["Gooding",10,11.0,0],["Preston",10,18.0,0],["Shelley",10,32.0,0],["Meridian",0,8.0,0],["Idaho Falls",0,6.0,0],["Caldwell",0,8.0,0],["Pocatello",0,29.0,0],["Twin Falls",0,32.0,0],["Rexburg",0,9.0,0],["Lewiston",0,32.0,0],["Eagle",0,8.0,0],["Moscow",0,21.0,0],["Kuna",0,8.0,0],["Ammon",0,22.0,0],["Chubbuck",0,20.0,0],["Hayden",0,11.0,0],["Jerome",0,22.0,0],["Blackfoot",0,11.0,0],["Garden City",0,8.0,0],["Mountain Home",0,32.0,0],["Star",0,8.0,0],["Rathdrum",0,11.0,0],["Payette",0,32.0,0],["Sandpoint",0,5.0,0],["Middleton",0,32.0,0],["Burley",0,33.0,0],["Emmett",0,8.0,0],["Hailey",0,32.0,0],["Homedale",0,10.0,0]],"motorcycle_repair":[["Boise",10,17.0,0],["Nampa",10,31.0,0],["Idaho Falls",10,18.0,0],["Caldwell",10,26.0,0],["Weiser",10,31.0,0],["Rupert",10,41.0,0],["Gooding",10,25.0,0],["Shelley",10,25.0,0],["Meridian",0,16.0,0],["Pocatello",0,24.0,0],["Twin Falls",0,46.0,0],["Rexburg",0,23.0,0],["Lewiston",0,32.0,0],["Eagle",0,29.0,0],["Moscow",0,52.0,0],["Kuna",0,32.0,0],["Ammon",0,22.0,0],["Chubbuck",0,49.0,0],["Hayden",0,48.0,0],["Jerome",0,47.0,0],["Blackfoot",0,29.0,0],["Garden City",0,24.0,0],["Mountain Home",0,16.0,0],["Star",0,24.0,0],["Rathdrum",0,32.0,0],["Payette",0,19.0,0],["Sandpoint",0,30.0,0],["Middleton",0,52.0,0],["Burley",0,41.0,0],["Emmett",0,30.0,0],["Hailey",0,20.0,0],["Preston",0,56.0,0],["Homedale",0,19.0,0]]}],"Indiana":[[["Indianapolis",880000],["Fort Wayne",265000],["Evansville",117000],["South Bend",104000],["Carmel",103000],["Fishers",102000],["Bloomington",80000],["Hammond",77000],["Gary",67000],["Lafayette",65000],["Muncie",65000],["Noblesville",70000],["Terre Haute",58000],["Kokomo",59000],["Greenwood",63000],["Anderson",54000],["Elkhart",54000],["Mishawaka",52000],["Lawrence",49000],["Jeffersonville",49000],["Columbus",49000],["Westfield",48000],["Portage",38000],["New Albany",37000],["Goshen",35000],["Michigan City",32000],["Plainfield",32000],["Richmond",31000],["Merrillville",29000],["Valparaiso",34000],["Granger",30000],["Crown Point",34000],["Hobart",29000],["Zionsville",30000],["Frankfort",16000]],{"small_engine_repair":[["Indianapolis",50,28.0,9.04],["Carmel",20,17.0,0],["Westfield",20,31.0,0],["Fort Wayne",10,16.0,0],["Evansville",10,28.0,0],["South Bend",10,24.0,0],["Bloomington",10,31.0,0],["Hammond",10,31.0,0],["Gary",10,31.0,0],["Lafayette",10,39.0,0],["Muncie",10,22.0,0],["Noblesville",10,31.0,0],["Terre Haute",10,24.0,0],["Kokomo",10,31.0,0],["Greenwood",10,28.0,0],["Anderson",10,31.0,0],["Elkhart",10,24.0,0],["Mishawaka",10,31.0,0],["Lawrence",10,28.0,0],["Jeffersonville",10,31.0,0],["Columbus",10,31.0,0],["Portage",10,24.0,0],["New Albany",10,31.0,0],["Goshen",10,23.0,0],["Michigan City",10,28.0,0],["Valparaiso",10,24.0,0],["Fishers",0,0,0],["Plainfield",0,31.0,0],["Richmond",0,40.0,0],["Merrillville",0,31.0,0],["Granger",0,0,0],["Crown Point",0,0,0],["Hobart",0,0,0],["Zionsville",0,0,0],["Frankfort",0,0,0]],"lawn_mower_repair":[["Indianapolis",140,18.0,5.49],["Fort Wayne",30,24.0,2.59],["Evansville",20,23.0,0],["Carmel",20,3.0,0],["Lafayette",20,22.0,0],["South Bend",10,22.0,0],["Fishers",10,9.0,0],["Bloomington",10,24.0,0],["Hammond",10,24.0,0],["Gary",10,24.0,0],["Muncie",10,18.0,0],["Noblesville",10,3.0,0],["Terre Haute",10,14.0,0],["Kokomo",10,13.0,0],["Greenwood",10,23.0,0],["Anderson",10,28.0,0],["Elkhart",10,22.0,0],["Mishawaka",10,13.0,0],["Lawrence",10,3.0,0],["Jeffersonville",10,24.0,0],["Columbus",10,22.0,0],["Westfield",10,24.0,0],["Portage",10,22.0,0],["New Albany",10,28.0,0],["Goshen",10,22.0,0],["Richmond",10,22.0,0],["Valparaiso",10,18.0,0],["Michigan City",0,22.0,0],["Plainfield",0,18.0,0],["Merrillville",0,28.0,0],["Granger",0,0,0],["Crown Point",0,0,0],["Hobart",0,0,0],["Zionsville",0,0,0],["Frankfort",0,0,0]],"snow_blower_repair":[["Indianapolis",20,3.0,0],["Fort Wayne",10,3.0,0],["Evansville",10,29.0,0],["Carmel",10,3.0,0],["Terre Haute",10,16.0,0],["Westfield",10,3.0,0],["New Albany",10,30.0,0],["Goshen",10,3.0,0],["Plainfield",10,7.0,0],["South Bend",0,15.0,0],["Fishers",0,15.0,0],["Bloomington",0,16.0,0],["Hammond",0,15.0,0],["Gary",0,15.0,0],["Lafayette",0,16.0,0],["Muncie",0,8.0,0],["Noblesville",0,15.0,0],["Kokomo",0,22.0,0],["Greenwood",0,3.0,0],["Anderson",0,16.0,0],["Elkhart",0,23.0,0],["Mishawaka",0,22.0,0],["Lawrence",0,3.0,0],["Jeffersonville",0,27.0,0],["Columbus",0,22.0,0],["Portage",0,15.0,0],["Michigan City",0,16.0,0],["Richmond",0,16.0,0],["Merrillville",0,15.0,0],["Valparaiso",0,16.0,0],["Granger",0,0,0],["Crown Point",0,0,0],["Hobart",0,0,0],["Zionsville",0,0,0],["Frankfort",0,0,0]],"generator_repair":[["Indianapolis",10,8.0,8.03],["Fort Wayne",10,14.0,0],["South Bend",10,4.0,0],["Bloomington",10,12.0,0],["Hammond",10,8.0,0],["Gary",10,9.0,0],["Lafayette",10,17.0,0],["Kokomo",10,8.0,0],["Mishawaka",10,8.0,0],["Plainfield",10,16.0,0],["Valparaiso",10,4.0,0],["Evansville",0,8.0,0],["Carmel",0,15.0,0],["Fishers",0,14.0,0],["Muncie",0,8.0,0],["Noblesville",0,8.0,0],["Terre Haute",0,24.0,0],["Greenwood",0,8.0,0],["Anderson",0,10.0,0],["Elkhart",0,4.0,0],["Lawrence",0,9.0,0],["Jeffersonville",0,11.0,0],["Columbus",0,8.0,0],["Westfield",0,9.0,0],["Portage",0,12.0,0],["New Albany",0,9.0,0],["Goshen",0,9.0,0],["Michigan City",0,9.0,0],["Richmond",0,22.0,0],["Merrillville",0,9.0,0],["Granger",0,0,0],["Crown Point",0,0,0],["Hobart",0,0,0],["Zionsville",0,0,0],["Frankfort",0,0,0]],"motorcycle_repair":[["Indianapolis",30,17.0,0],["Bloomington",10,18.0,0],["Lafayette",10,8.0,0],["Columbus",10,29.0,0],["Plainfield",10,26.0,0],["Fort Wayne",0,26.0,0],["Evansville",0,6.0,0],["South Bend",0,41.0,0],["Carmel",0,32.0,0],["Fishers",0,40.0,0],["Hammond",0,6.0,0],["Gary",0,27.0,0],["Muncie",0,31.0,0],["Noblesville",0,46.0,0],["Terre Haute",0,7.0,0],["Kokomo",0,30.0,0],["Greenwood",0,30.0,0],["Anderson",0,56.0,0],["Elkhart",0,16.0,0],["Mishawaka",0,30.0,0],["Lawrence",0,34.0,0],["Jeffersonville",0,28.0,0],["Westfield",0,13.0,0],["Portage",0,23.0,0],["New Albany",0,28.0,0],["Goshen",0,36.0,0],["Michigan City",0,31.0,0],["Richmond",0,17.0,0],["Merrillville",0,25.0,0],["Valparaiso",0,8.0,0],["Granger",0,0,0],["Crown Point",0,0,0],["Hobart",0,0,0],["Zionsville",0,0,0],["Frankfort",0,0,0]]}],"Illinois":[[["Chicago",2700000],["Aurora",180000],["Naperville",150000],["Joliet",150000],["Rockford",145000],["Springfield",115000],["Elgin",115000],["Peoria",110000],["Champaign",90000],["Waukegan",88000],["Cicero",81000],["Bloomington",79000],["Arlington Heights",77000],["Evanston",75000],["Bolingbrook",74000],["Schaumburg",73000],["Decatur",70000],["Palatine",68000],["Skokie",67000],["Orland Park",66000],["Des Plaines",60000],["Tinley Park",56000],["Oak Lawn",55000],["Berwyn",54000],["Mount Prospect",54000],["Normal",52000],["Wheaton",51000],["Hoffman Estates",50000],["Oak Park",49000],["Downers Grove",48000],["Glenview",47000],["Elmhurst",46000],["Lombard",44000],["DeKalb",40000],["Quincy",39000]],{"small_engine_repair":[["Chicago",90,20.0,0],["Aurora",20,22.0,0],["Rockford",20,24.0,0],["Bloomington",20,28.0,0],["Naperville",10,23.0,0],["Joliet",10,31.0,0],["Springfield",10,20.0,0],["Elgin",10,36.0,0],["Peoria",10,31.0,0],["Champaign",10,24.0,0],["Waukegan",10,28.0,0],["Cicero",10,37.0,0],["Arlington Heights",10,12.0,0],["Evanston",10,35.0,0],["Bolingbrook",10,27.0,0],["Schaumburg",10,31.0,0],["Decatur",10,35.0,0],["Palatine",10,18.0,0],["Skokie",10,28.0,0],["Orland Park",10,33.0,0],["Des Plaines",10,23.0,0],["Tinley Park",10,64.0,0],["Oak Lawn",10,50.0,0],["Berwyn",10,12.0,0],["Mount Prospect",10,12.0,0],["Normal",10,31.0,0],["Wheaton",10,15.0,0],["Hoffman Estates",10,23.0,0],["Oak Park",10,24.0,0],["Downers Grove",10,23.0,0],["Glenview",10,25.0,0],["Elmhurst",10,23.0,0],["Lombard",10,28.0,0],["DeKalb",10,31.0,0],["Quincy",10,31.0,0]],"lawn_mower_repair":[["Chicago",140,20.0,1.14],["Naperville",23,10.0,1.94],["Aurora",20,24.0,0],["Rockford",20,22.0,0],["Springfield",20,20.0,0],["Peoria",20,24.0,0],["Joliet",10,28.0,0],["Elgin",10,23.0,0],["Champaign",10,23.0,0],["Waukegan",10,28.0,0],["Cicero",10,22.0,0],["Bloomington",10,23.0,0],["Arlington Heights",10,18.0,0],["Bolingbrook",10,27.0,0],["Schaumburg",10,18.0,0],["Palatine",10,24.0,0],["Skokie",10,18.0,0],["Orland Park",10,22.0,0],["Des Plaines",10,18.0,0],["Tinley Park",10,22.0,0],["Oak Lawn",10,18.0,0],["Mount Prospect",10,28.0,0],["Normal",10,22.0,0],["Hoffman Estates",10,22.0,0],["Downers Grove",10,22.0,0],["Elmhurst",10,23.0,0],["Lombard",10,22.0,0],["Quincy",10,24.0,0],["Evanston",0,22.0,0],["Decatur",0,22.0,0],["Berwyn",0,24.0,0],["Wheaton",0,22.0,0],["Oak Park",0,20.0,0],["Glenview",0,22.0,0],["DeKalb",0,18.0,0]],"snow_blower_repair":[["Chicago",30,10.0,0],["Aurora",10,24.0,0],["Naperville",10,19.0,0],["Joliet",10,2.0,0],["Rockford",10,13.0,0],["Springfield",10,33.0,0],["Elgin",10,24.0,0],["Bloomington",10,23.0,0],["Arlington Heights",10,3.0,0],["Bolingbrook",10,13.0,0],["Schaumburg",10,3.0,0],["Skokie",10,3.0,0],["Orland Park",10,13.0,0],["Des Plaines",10,3.0,0],["Tinley Park",10,34.0,0],["Hoffman Estates",10,13.0,0],["Quincy",10,39.0,0],["Peoria",0,31.0,0],["Champaign",0,31.0,0],["Waukegan",0,30.0,0],["Cicero",0,9.0,0],["Evanston",0,3.0,0],["Decatur",0,3.0,0],["Palatine",0,3.0,0],["Oak Lawn",0,35.0,0],["Berwyn",0,13.0,0],["Mount Prospect",0,13.0,0],["Normal",0,24.0,0],["Wheaton",0,2.0,0],["Oak Park",0,14.0,0],["Downers Grove",0,3.0,0],["Glenview",0,14.0,0],["Elmhurst",0,13.0,0],["Lombard",0,13.0,0],["DeKalb",0,14.0,0]],"generator_repair":[["Chicago",30,29.0,5.4],["Naperville",10,4.0,0],["Rockford",10,5.0,0],["Peoria",10,9.0,0],["Cicero",10,11.0,0],["Oak Lawn",10,11.0,0],["Hoffman Estates",10,11.0,0],["Glenview",10,9.0,0],["Aurora",0,5.0,0],["Joliet",0,29.0,0],["Springfield",0,8.0,0],["Elgin",0,11.0,0],["Champaign",0,7.0,0],["Waukegan",0,11.0,0],["Bloomington",0,7.0,0],["Arlington Heights",0,11.0,0],["Evanston",0,6.0,0],["Bolingbrook",0,5.0,0],["Schaumburg",0,7.0,0],["Decatur",0,6.0,0],["Palatine",0,6.0,0],["Skokie",0,7.0,0],["Orland Park",0,4.0,0],["Des Plaines",0,9.0,0],["Tinley Park",0,9.0,0],["Berwyn",0,9.0,0],["Mount Prospect",0,9.0,0],["Normal",0,13.0,0],["Wheaton",0,9.0,0],["Oak Park",0,7.0,0],["Downers Grove",0,11.0,0],["Elmhurst",0,4.0,0],["Lombard",0,9.0,0],["DeKalb",0,8.0,0],["Quincy",0,11.0,0]],"motorcycle_repair":[["Chicago",90,16.0,43.7],["Joliet",10,18.0,0],["Springfield",10,7.0,0],["DeKalb",10,18.0,0],["Aurora",0,42.0,0],["Naperville",0,19.0,0],["Rockford",0,32.0,0],["Elgin",0,30.0,0],["Peoria",0,32.0,0],["Champaign",0,28.0,0],["Waukegan",0,31.0,0],["Cicero",0,10.0,0],["Bloomington",0,31.0,0],["Arlington Heights",0,50.0,0],["Evanston",0,37.0,0],["Bolingbrook",0,28.0,0],["Schaumburg",0,13.0,0],["Decatur",0,37.0,0],["Palatine",0,23.0,0],["Skokie",0,13.0,0],["Orland Park",0,26.0,0],["Des Plaines",0,25.0,0],["Tinley Park",0,31.0,0],["Oak Lawn",0,14.0,0],["Berwyn",0,34.0,0],["Mount Prospect",0,37.0,0],["Normal",0,32.0,0],["Wheaton",0,25.0,0],["Hoffman Estates",0,41.0,0],["Oak Park",0,35.0,0],["Downers Grove",0,21.0,0],["Glenview",0,25.0,0],["Elmhurst",0,12.0,0],["Lombard",0,13.0,0],["Quincy",0,30.0,0]]}],"Montana":[[["Billings",125000],["Missoula",75000],["Great Falls",60000],["Bozeman",57000],["Butte",35000],["Helena",34000],["Kalispell",28000],["Belgrade",13000],["Havre",12000],["Anaconda",10000],["Miles City",10000]],{"small_engine_repair":[["Billings",10,24.0,0],["Missoula",10,31.0,0],["Great Falls",10,28.0,0],["Bozeman",10,39.0,0],["Helena",10,34.0,0],["Kalispell",10,31.0,0],["Butte",0,24.0,0],["Belgrade",0,31.0,0],["Havre",0,52.0,0],["Anaconda",0,31.0,0],["Miles City",0,52.0,0]],"lawn_mower_repair":[["Billings",10,11.0,0],["Missoula",10,14.0,0],["Great Falls",10,24.0,0],["Bozeman",10,22.0,0],["Kalispell",10,28.0,0],["Belgrade",10,31.0,0],["Butte",0,28.0,0],["Helena",0,22.0,0],["Havre",0,31.0,0],["Anaconda",0,22.0,0],["Miles City",0,31.0,0]],"snow_blower_repair":[["Bozeman",10,24.0,0],["Butte",10,31.0,0],["Havre",10,23.0,0],["Miles City",10,31.0,0],["Billings",0,3.0,0],["Missoula",0,28.0,0],["Great Falls",0,31.0,0],["Helena",0,30.0,0],["Kalispell",0,31.0,0],["Belgrade",0,31.0,0],["Anaconda",0,34.0,0]],"generator_repair":[["Billings",0,10.0,0],["Missoula",0,29.0,0],["Great Falls",0,29.0,0],["Bozeman",0,4.0,0],["Butte",0,22.0,0],["Helena",0,32.0,0],["Kalispell",0,3.0,0],["Belgrade",0,32.0,0],["Havre",0,22.0,0],["Anaconda",0,40.0,0],["Miles City",0,32.0,0]],"motorcycle_repair":[["Billings",10,32.0,0],["Bozeman",10,14.0,0],["Missoula",0,20.0,0],["Great Falls",0,48.0,0],["Butte",0,15.0,0],["Helena",0,8.0,0],["Kalispell",0,35.0,0],["Belgrade",0,18.0,0],["Havre",0,50.0,0],["Anaconda",0,49.0,0],["Miles City",0,36.0,0]]}],"New Hampshire":[[["Manchester",116000],["Nashua",91000],["Concord",44000],["Derry",34000],["Dover",33000],["Rochester",32000],["Salem",31000],["Merrimack",30000],["Londonderry",27000],["Hudson",25000],["Keene",23000],["Bedford",23000],["Portsmouth",22000],["Goffstown",18000],["Laconia",16000],["Hampton",15000]],{"small_engine_repair":[["Manchester",10,39.0,0],["Nashua",10,31.0,0],["Concord",10,41.0,0],["Derry",10,28.0,0],["Dover",10,3.0,0],["Rochester",10,31.0,0],["Salem",10,22.0,0],["Merrimack",10,40.0,0],["Londonderry",10,28.0,0],["Keene",10,24.0,0],["Bedford",10,27.0,0],["Portsmouth",10,31.0,0],["Goffstown",10,42.0,0],["Laconia",10,31.0,0],["Hudson",0,37.0,0],["Hampton",0,3.0,0]],"lawn_mower_repair":[["Manchester",10,10.0,0],["Nashua",10,28.0,0],["Concord",10,13.0,0],["Rochester",10,18.0,0],["Derry",0,7.0,0],["Dover",0,3.0,0],["Salem",0,18.0,0],["Merrimack",0,2.0,0],["Londonderry",0,3.0,0],["Hudson",0,28.0,0],["Keene",0,22.0,0],["Bedford",0,16.0,0],["Portsmouth",0,22.0,0],["Goffstown",0,10.0,0],["Laconia",0,22.0,0],["Hampton",0,5.0,0]],"snow_blower_repair":[["Manchester",10,4.0,0],["Hudson",10,13.0,0],["Keene",10,30.0,0],["Nashua",0,2.0,0],["Concord",0,10.0,0],["Derry",0,2.0,0],["Dover",0,6.0,0],["Rochester",0,3.0,0],["Salem",0,11.0,0],["Merrimack",0,11.0,0],["Londonderry",0,10.0,0],["Bedford",0,11.0,0],["Portsmouth",0,31.0,0],["Goffstown",0,10.0,0],["Laconia",0,16.0,0],["Hampton",0,10.0,0]],"generator_repair":[["Manchester",10,9.0,0],["Concord",10,9.0,0],["Goffstown",10,10.0,0],["Nashua",0,9.0,0],["Derry",0,9.0,0],["Dover",0,6.0,0],["Rochester",0,18.0,0],["Salem",0,15.0,0],["Merrimack",0,6.0,0],["Londonderry",0,15.0,0],["Hudson",0,6.0,0],["Keene",0,9.0,0],["Bedford",0,10.0,0],["Portsmouth",0,8.0,0],["Laconia",0,6.0,0],["Hampton",0,4.0,0]],"motorcycle_repair":[["Manchester",20,23.0,0],["Nashua",10,19.0,0],["Concord",10,18.0,0],["Derry",0,27.0,0],["Dover",0,4.0,0],["Rochester",0,4.0,0],["Salem",0,27.0,0],["Merrimack",0,18.0,0],["Londonderry",0,23.0,0],["Hudson",0,10.0,0],["Keene",0,23.0,0],["Bedford",0,20.0,0],["Portsmouth",0,11.0,0],["Goffstown",0,16.0,0],["Laconia",0,9.0,0],["Hampton",0,4.0,0]]}],"Oregon":[[["Portland",635000],["Salem",180000],["Eugene",175000],["Gresham",115000],["Hillsboro",110000],["Beaverton",97000],["Bend",95000],["Medford",87000],["Springfield",63000],["Corvallis",60000],["Albany",56000],["Tigard",55000],["Grants Pass",39000],["Oregon City",38000],["McMinnville",37000]],{"small_engine_repair":[["Gresham",70,26.0,0],["Portland",40,7.0,2.12],["Medford",20,31.0,0],["Salem",10,37.0,0],["Eugene",10,14.0,0],["Hillsboro",10,19.0,0],["Beaverton",10,5.0,0],["Bend",10,28.0,4.94],["Springfield",10,30.0,0],["Corvallis",10,37.0,0],["Albany",10,26.0,0],["Tigard",10,7.0,0],["Grants Pass",10,31.0,0],["Oregon City",10,6.0,0],["McMinnville",10,24.0,0]],"lawn_mower_repair":[["Portland",70,9.0,1.78],["Salem",20,24.0,0],["Eugene",20,7.0,0],["Medford",20,23.0,0],["Springfield",10,23.0,0],["Corvallis",10,22.0,0],["Albany",10,24.0,0],["Tigard",10,11.0,0],["Grants Pass",10,9.0,0],["Oregon City",10,6.0,0],["McMinnville",10,18.0,0],["Gresham",0,22.0,0],["Hillsboro",0,2.0,0],["Beaverton",0,10.0,0],["Bend",0,28.0,0]],"snow_blower_repair":[["Gresham",10,31.0,0],["Hillsboro",10,31.0,0],["Beaverton",10,26.0,0],["Medford",10,31.0,0],["Springfield",10,31.0,0],["Corvallis",10,29.0,0],["Albany",10,29.0,0],["Tigard",10,37.0,0],["Grants Pass",10,31.0,0],["Oregon City",10,31.0,0],["McMinnville",10,31.0,0],["Portland",0,0,0],["Salem",0,0,0],["Eugene",0,0,0],["Bend",0,0,0]],"generator_repair":[["Portland",10,29.0,0],["Salem",10,5.0,0],["Eugene",10,5.0,0],["Gresham",10,12.0,0],["Hillsboro",10,9.0,0],["Beaverton",10,5.0,0],["Bend",10,16.0,0],["Medford",10,3.0,0],["Springfield",10,23.0,0],["Grants Pass",10,5.0,0],["Corvallis",0,0,0],["Albany",0,0,0],["Tigard",0,0,0],["Oregon City",0,0,0],["McMinnville",0,0,0]],"motorcycle_repair":[["Portland",30,15.0,1.12],["Salem",10,20.0,0],["Eugene",10,10.0,0],["Gresham",10,20.0,0],["Hillsboro",10,36.0,0],["Beaverton",10,19.0,0],["Bend",10,6.0,0],["Medford",10,31.0,0],["Oregon City",10,9.0,0],["McMinnville",10,14.0,0],["Springfield",0,0,0],["Corvallis",0,0,0],["Albany",0,0,0],["Tigard",0,0,0],["Grants Pass",0,0,0]]}],"Louisiana":[[["New Orleans",370000],["Baton Rouge",220000],["Shreveport",185000],["Metairie",143000],["Lafayette",120000],["Lake Charles",87000],["Bossier City",62000],["Kenner",66000],["Monroe",47000],["Alexandria",44000],["Houma",33000],["Slidell",29000],["Central",29000],["Ruston",22000]],{"small_engine_repair":[["New Orleans",30,30.0,0],["Baton Rouge",20,26.0,0],["Shreveport",10,28.0,0],["Metairie",10,31.0,0],["Lafayette",10,26.0,0],["Lake Charles",10,31.0,0],["Bossier City",10,22.0,0],["Kenner",10,31.0,0],["Monroe",10,31.0,0],["Alexandria",10,35.0,0],["Houma",10,28.0,0],["Slidell",10,28.0,0],["Central",10,30.0,0],["Ruston",0,0,0]],"lawn_mower_repair":[["New Orleans",40,24.0,0],["Baton Rouge",30,24.0,0],["Shreveport",20,20.0,0],["Metairie",10,33.0,0],["Lafayette",10,22.0,0],["Lake Charles",10,24.0,0],["Bossier City",10,16.0,0],["Kenner",10,20.0,0],["Monroe",10,24.0,0],["Alexandria",10,24.0,0],["Houma",10,24.0,0],["Slidell",10,24.0,0],["Central",10,24.0,0],["Ruston",0,0,0]],"snow_blower_repair":[["Metairie",10,34.0,0],["Lake Charles",10,30.0,0],["Bossier City",10,31.0,0],["Kenner",10,35.0,0],["Monroe",10,37.0,0],["Alexandria",10,36.0,0],["Houma",10,31.0,0],["Slidell",10,34.0,0],["Central",10,37.0,0],["Ruston",10,24.0,0],["New Orleans",0,0,0],["Baton Rouge",0,0,0],["Shreveport",0,0,0],["Lafayette",0,0,0]],"generator_repair":[["New Orleans",30,5.0,23.28],["Baton Rouge",10,7.0,11.88],["Shreveport",10,29.0,0],["Metairie",10,4.0,0],["Lafayette",10,3.0,0],["Lake Charles",10,9.0,0],["Bossier City",10,24.0,0],["Kenner",10,29.0,0],["Alexandria",10,7.0,0],["Houma",10,4.0,0],["Slidell",10,4.0,0],["Central",10,29.0,0],["Ruston",10,24.0,0],["Monroe",0,0,0]],"motorcycle_repair":[["New Orleans",10,16.0,0],["Baton Rouge",10,10.0,0],["Shreveport",10,26.0,0],["Lafayette",10,26.0,0],["Metairie",0,0,0],["Lake Charles",0,0,0],["Bossier City",0,0,0],["Kenner",0,0,0],["Monroe",0,0,0],["Alexandria",0,0,0],["Houma",0,0,0],["Slidell",0,0,0],["Central",0,0,0],["Ruston",0,0,0]]}],"Maryland":[[["Baltimore",576000],["Columbia",105000],["Germantown",90000],["Silver Spring",81000],["Waldorf",79000],["Glen Burnie",73000],["Frederick",72000],["Gaithersburg",69000],["Rockville",68000],["Bethesda",65000],["Bowie",59000],["Towson",58000],["Hagerstown",43000],["Salisbury",52000]],{"small_engine_repair":[["Baltimore",30,26.0,2.7],["Columbia",10,18.0,0],["Germantown",10,21.0,0],["Silver Spring",10,20.0,0],["Waldorf",10,45.0,0.37],["Glen Burnie",10,32.0,0],["Frederick",10,28.0,0],["Gaithersburg",10,15.0,0],["Rockville",10,11.0,0],["Bethesda",10,21.0,0],["Bowie",10,11.0,0],["Towson",10,12.0,0],["Hagerstown",10,28.0,0],["Salisbury",10,24.0,0]],"lawn_mower_repair":[["Baltimore",90,18.0,1.11],["Columbia",10,12.0,0],["Germantown",10,31.0,0],["Silver Spring",10,33.0,0],["Waldorf",10,24.0,0],["Glen Burnie",10,13.0,0],["Frederick",10,33.0,0],["Gaithersburg",10,33.0,0],["Rockville",10,16.0,0],["Bethesda",10,21.0,0],["Bowie",10,33.0,1.25],["Towson",10,6.0,0],["Hagerstown",10,10.0,0],["Salisbury",10,23.0,0]],"snow_blower_repair":[["Baltimore",10,4.0,0],["Bethesda",10,3.0,0],["Salisbury",10,31.0,0],["Columbia",0,0,0],["Germantown",0,0,0],["Silver Spring",0,0,0],["Waldorf",0,0,0],["Glen Burnie",0,0,0],["Frederick",0,0,0],["Gaithersburg",0,0,0],["Rockville",0,0,0],["Bowie",0,0,0],["Towson",0,0,0],["Hagerstown",0,0,0]],"generator_repair":[["Baltimore",10,12.0,0],["Frederick",10,7.0,0],["Gaithersburg",10,9.0,0],["Bowie",10,7.0,0],["Columbia",0,0,0],["Germantown",0,0,0],["Silver Spring",0,0,0],["Waldorf",0,0,0],["Glen Burnie",0,0,0],["Rockville",0,0,0],["Bethesda",0,0,0],["Towson",0,0,0],["Hagerstown",0,0,0],["Salisbury",0,0,0]],"motorcycle_repair":[["Baltimore",40,21.0,0],["Columbia",10,10.0,0],["Germantown",10,7.0,0],["Silver Spring",10,17.0,0],["Frederick",10,46.0,0],["Gaithersburg",10,11.0,0],["Rockville",10,10.0,0],["Waldorf",0,0,0],["Glen Burnie",0,0,0],["Bethesda",0,0,0],["Bowie",0,0,0],["Towson",0,0,0],["Hagerstown",0,0,0],["Salisbury",0,0,0]]}],"Nebraska":[[["Omaha",485000],["Lincoln",292000],["Bellevue",64000],["Grand Island",52000],["Kearney",34000],["Fremont",27000],["Hastings",25000],["Norfolk",24000],["Columbus",24000],["Papillion",23000],["La Vista",17000],["Scottsbluff",15000],["South Sioux City",14000],["Beatrice",12000]],{"small_engine_repair":[["Omaha",90,18.0,1.38],["Lincoln",40,26.0,0.91],["Bellevue",10,11.0,0],["Grand Island",10,31.0,0],["Kearney",10,31.0,0],["Hastings",10,31.0,0],["Columbus",10,29.0,0],["Papillion",10,17.0,0],["La Vista",10,17.0,0],["Scottsbluff",10,31.0,0],["Beatrice",10,31.0,0],["Fremont",0,24.0,0],["Norfolk",0,28.0,0],["South Sioux City",0,31.0,0]],"lawn_mower_repair":[["Omaha",50,3.0,0.65],["Lincoln",30,24.0,2.4],["Bellevue",10,3.0,0],["Papillion",10,10.0,0],["La Vista",10,4.0,0],["Grand Island",0,22.0,0],["Kearney",0,22.0,0],["Fremont",0,24.0,0],["Hastings",0,24.0,0],["Norfolk",0,4.0,0],["Columbus",0,24.0,0],["Scottsbluff",0,24.0,0],["South Sioux City",0,22.0,0],["Beatrice",0,2.0,0]],"snow_blower_repair":[["Omaha",20,26.0,0],["Lincoln",10,23.0,0],["Bellevue",10,11.0,0],["Fremont",10,8.0,0],["Hastings",10,31.0,0],["Norfolk",10,15.0,0],["Papillion",10,11.0,0],["La Vista",10,17.0,0],["South Sioux City",10,33.0,0],["Grand Island",0,31.0,0],["Kearney",0,31.0,0],["Columbus",0,33.0,0],["Scottsbluff",0,31.0,0],["Beatrice",0,10.0,0]],"generator_repair":[["Omaha",10,8.0,0],["Lincoln",0,10.0,0],["Bellevue",0,8.0,0],["Grand Island",0,31.0,0],["Kearney",0,32.0,0],["Fremont",0,17.0,0],["Hastings",0,17.0,0],["Norfolk",0,32.0,0],["Columbus",0,19.0,0],["Papillion",0,7.0,0],["La Vista",0,7.0,0],["Scottsbluff",0,32.0,0],["South Sioux City",0,25.0,0],["Beatrice",0,13.0,0]],"motorcycle_repair":[["Omaha",10,16.0,0],["Lincoln",10,36.0,0],["Scottsbluff",10,31.0,0],["South Sioux City",10,38.0,0],["Bellevue",0,18.0,0],["Grand Island",0,32.0,0],["Kearney",0,35.0,0],["Fremont",0,26.0,0],["Hastings",0,32.0,0],["Norfolk",0,18.0,0],["Columbus",0,25.0,0],["Papillion",0,26.0,0],["La Vista",0,26.0,0],["Beatrice",0,23.0,0]]}],"Nevada":[[["Las Vegas",660000],["Henderson",330000],["Reno",270000],["North Las Vegas",280000],["Paradise",190000],["Sunrise Manor",210000],["Spring Valley",220000],["Enterprise",180000],["Sparks",110000],["Carson City",58000],["Whitney",44000],["Winchester",38000],["Pahrump",36000],["Sun Valley",22000]],{"small_engine_repair":[["Las Vegas",20,31.0,4.19],["Henderson",10,37.0,0],["Reno",10,34.0,0],["North Las Vegas",10,31.0,0],["Paradise",10,31.0,0],["Enterprise",10,31.0,0],["Sparks",10,26.0,0],["Carson City",10,7.0,0],["Whitney",10,31.0,0],["Winchester",10,31.0,0],["Pahrump",10,31.0,0],["Sun Valley",10,40.0,0],["Sunrise Manor",0,31.0,0],["Spring Valley",0,31.0,0]],"lawn_mower_repair":[["Las Vegas",20,24.0,0],["Henderson",10,18.0,0],["Reno",10,25.0,0],["Sparks",10,17.0,0],["Whitney",10,24.0,0],["Winchester",10,18.0,0],["Pahrump",10,22.0,0],["North Las Vegas",0,22.0,0],["Paradise",0,24.0,0],["Sunrise Manor",0,24.0,0],["Spring Valley",0,18.0,0],["Enterprise",0,18.0,0],["Carson City",0,7.0,0],["Sun Valley",0,25.0,0]],"snow_blower_repair":[["Reno",10,17.0,0],["Paradise",10,31.0,0],["Sunrise Manor",10,23.0,0],["Spring Valley",10,29.0,0],["Enterprise",10,31.0,0],["Whitney",10,31.0,0],["Winchester",10,33.0,0],["Pahrump",10,31.0,0],["Las Vegas",0,31.0,0],["Henderson",0,29.0,0],["North Las Vegas",0,30.0,0],["Sparks",0,22.0,0],["Carson City",0,11.0,0],["Sun Valley",0,22.0,0]],"generator_repair":[["Las Vegas",10,8.0,3.81],["Henderson",10,10.0,0],["Reno",10,12.0,0],["North Las Vegas",10,9.0,0],["Whitney",10,8.0,0],["Winchester",10,10.0,0],["Paradise",0,8.0,0],["Sunrise Manor",0,10.0,0],["Spring Valley",0,8.0,0],["Enterprise",0,10.0,0],["Sparks",0,12.0,0],["Carson City",0,6.0,0],["Pahrump",0,20.0,0],["Sun Valley",0,16.0,0]],"motorcycle_repair":[["Las Vegas",50,15.0,0],["Henderson",10,16.0,0],["Reno",10,20.0,0],["North Las Vegas",10,15.0,0],["Paradise",10,13.0,0],["Sunrise Manor",10,13.0,0],["Spring Valley",10,13.0,0],["Enterprise",10,13.0,0],["Carson City",10,26.0,0],["Whitney",10,14.0,0],["Winchester",10,15.0,0],["Sparks",0,17.0,0],["Pahrump",0,32.0,0],["Sun Valley",0,20.0,0]]}],"Mississippi":[[["Jackson",150000],["Gulfport",73000],["Southaven",60000],["Hattiesburg",48000],["Biloxi",46000],["Olive Branch",40000],["Tupelo",38000],["Meridian",36000],["Greenville",29000],["Pearl",26000],["Madison",25000],["Starkville",25000],["Clinton",25000],["Ridgeland",24000]],{"small_engine_repair":[["Jackson",40,30.0,0],["Gulfport",10,31.0,0],["Southaven",10,31.0,0],["Hattiesburg",10,28.0,0],["Biloxi",10,31.0,0],["Olive Branch",10,31.0,0],["Tupelo",10,45.0,0],["Meridian",10,45.0,0],["Greenville",10,38.0,0],["Pearl",10,30.0,0],["Madison",10,31.0,0],["Starkville",10,30.0,0],["Clinton",0,0,0],["Ridgeland",0,0,0]],"lawn_mower_repair":[["Jackson",30,24.0,0],["Gulfport",10,28.0,0],["Southaven",10,18.0,0],["Hattiesburg",10,33.0,0],["Biloxi",10,28.0,0],["Olive Branch",10,24.0,0],["Tupelo",10,28.0,0],["Meridian",10,28.0,0],["Pearl",10,31.0,0],["Madison",10,24.0,0],["Clinton",10,27.0,0],["Greenville",0,0,0],["Starkville",0,0,0],["Ridgeland",0,0,0]],"snow_blower_repair":[["Gulfport",10,31.0,0],["Southaven",10,31.0,0],["Hattiesburg",10,30.0,0],["Biloxi",10,31.0,0],["Olive Branch",10,34.0,0],["Tupelo",10,37.0,0],["Meridian",10,31.0,0],["Greenville",10,35.0,0],["Pearl",10,37.0,0],["Madison",10,35.0,0],["Starkville",10,27.0,0],["Clinton",10,27.0,0],["Jackson",0,0,0],["Ridgeland",0,0,0]],"generator_repair":[["Jackson",10,6.0,0],["Southaven",10,29.0,0],["Madison",10,8.0,0],["Clinton",10,11.0,0],["Gulfport",0,0,0],["Hattiesburg",0,0,0],["Biloxi",0,0,0],["Olive Branch",0,0,0],["Tupelo",0,0,0],["Meridian",0,0,0],["Greenville",0,0,0],["Pearl",0,0,0],["Starkville",0,0,0],["Ridgeland",0,0,0]],"motorcycle_repair":[["Jackson",20,10.0,0],["Southaven",10,46.0,0],["Olive Branch",10,26.0,0],["Greenville",10,52.0,0],["Madison",10,30.0,0],["Gulfport",0,0,0],["Hattiesburg",0,0,0],["Biloxi",0,0,0],["Tupelo",0,0,0],["Meridian",0,0,0],["Pearl",0,0,0],["Starkville",0,0,0],["Clinton",0,0,0],["Ridgeland",0,0,0]]}],"Utah":[[["Salt Lake City",203000],["West Valley City",140000],["Provo",116000],["West Jordan",117000],["Orem",100000],["Sandy",96000],["Ogden",87000],["St. George",100000],["Layton",85000],["South Jordan",84000],["Lehi",83000],["Taylorsville",60000],["Logan",54000],["Murray",50000]],{"small_engine_repair":[["Salt Lake City",40,20.0,0],["Ogden",20,35.0,0],["West Valley City",10,20.0,0],["Provo",10,28.0,0],["West Jordan",10,40.0,0],["Orem",10,31.0,0],["Sandy",10,22.0,0],["St. George",10,31.0,0],["Layton",10,24.0,0],["South Jordan",10,45.0,0],["Lehi",10,31.0,0],["Taylorsville",10,20.0,0],["Logan",10,28.0,0],["Murray",10,31.0,0]],"lawn_mower_repair":[["Salt Lake City",50,19.0,0],["West Valley City",10,7.0,0],["Provo",10,3.0,0],["West Jordan",10,38.0,0],["Orem",10,21.0,0],["Sandy",10,20.0,0],["Ogden",10,33.0,0],["St. George",10,23.0,0],["Layton",10,21.0,0],["South Jordan",10,24.0,0],["Lehi",10,35.0,0],["Taylorsville",10,7.0,0],["Logan",10,11.0,0],["Murray",10,13.0,0]],"snow_blower_repair":[["Salt Lake City",10,9.0,0],["West Valley City",10,30.0,0],["West Jordan",10,27.0,0],["Ogden",10,16.0,0],["St. George",10,27.0,0],["South Jordan",10,17.0,0],["Taylorsville",10,27.0,0],["Logan",10,13.0,0],["Murray",10,20.0,0],["Provo",0,0,0],["Orem",0,0,0],["Sandy",0,0,0],["Layton",0,0,0],["Lehi",0,0,0]],"generator_repair":[["Salt Lake City",10,29.0,18.02],["Ogden",10,18.0,0],["Murray",10,10.0,0],["West Valley City",0,0,0],["Provo",0,0,0],["West Jordan",0,0,0],["Orem",0,0,0],["Sandy",0,0,0],["St. George",0,0,0],["Layton",0,0,0],["South Jordan",0,0,0],["Lehi",0,0,0],["Taylorsville",0,0,0],["Logan",0,0,0]],"motorcycle_repair":[["Salt Lake City",20,10.0,4.26],["West Valley City",10,4.0,0],["Orem",10,8.0,1.8],["Ogden",10,12.0,0],["St. George",10,18.0,0],["Lehi",10,14.0,0],["Provo",0,0,0],["West Jordan",0,0,0],["Sandy",0,0,0],["Layton",0,0,0],["South Jordan",0,0,0],["Taylorsville",0,0,0],["Logan",0,0,0],["Murray",0,0,0]]}],"West Virginia":[[["Charleston",48000],["Huntington",45000],["Morgantown",30000],["Parkersburg",29000],["Wheeling",26000],["Weirton",19000],["Martinsburg",18000],["Fairmont",18000],["Beckley",17000],["Clarksburg",16000]],{"small_engine_repair":[["Charleston",10,2.0,0],["Huntington",10,31.0,0],["Morgantown",10,31.0,0],["Parkersburg",10,28.0,0],["Wheeling",10,31.0,0],["Weirton",10,31.0,0],["Martinsburg",10,23.0,0],["Fairmont",10,31.0,0],["Beckley",10,28.0,0],["Clarksburg",10,28.0,0]],"lawn_mower_repair":[["Charleston",10,30.0,0],["Huntington",10,28.0,0],["Morgantown",10,22.0,0],["Parkersburg",10,28.0,0],["Weirton",10,28.0,0],["Martinsburg",10,18.0,0],["Wheeling",0,28.0,0],["Fairmont",0,24.0,0],["Beckley",0,24.0,0],["Clarksburg",0,20.0,0]],"snow_blower_repair":[["Parkersburg",10,16.0,0],["Wheeling",10,37.0,0],["Beckley",10,19.0,0],["Charleston",0,20.0,0],["Huntington",0,35.0,0],["Morgantown",0,31.0,0],["Weirton",0,31.0,0],["Martinsburg",0,31.0,0],["Fairmont",0,34.0,0],["Clarksburg",0,30.0,0]],"generator_repair":[["Charleston",10,29.0,0],["Huntington",10,14.0,0],["Martinsburg",10,8.0,0],["Fairmont",10,6.0,0],["Morgantown",0,6.0,0],["Parkersburg",0,5.0,0],["Wheeling",0,9.0,0],["Weirton",0,18.0,0],["Beckley",0,18.0,0],["Clarksburg",0,20.0,0]],"motorcycle_repair":[["Charleston",0,37.0,0],["Huntington",0,20.0,0],["Morgantown",0,20.0,0],["Parkersburg",0,26.0,0],["Wheeling",0,25.0,0],["Weirton",0,26.0,0],["Martinsburg",0,32.0,0],["Fairmont",0,46.0,0],["Beckley",0,39.0,0],["Clarksburg",0,31.0,0]]}],"Vermont":[[["Burlington",44000],["South Burlington",20000],["Colchester",17000],["Rutland",15000]],{"small_engine_repair":[["Burlington",10,16.0,0],["South Burlington",10,16.0,0],["Colchester",10,39.0,0],["Rutland",10,31.0,0]],"lawn_mower_repair":[["Burlington",10,11.0,0],["South Burlington",0,16.0,0],["Colchester",0,21.0,0],["Rutland",0,21.0,0]],"snow_blower_repair":[["Burlington",0,23.0,0],["South Burlington",0,23.0,0],["Colchester",0,11.0,0],["Rutland",0,15.0,0]],"generator_repair":[["Colchester",10,6.0,0],["Rutland",10,14.0,0],["Burlington",0,7.0,0],["South Burlington",0,20.0,0]],"motorcycle_repair":[["Burlington",0,20.0,0],["South Burlington",0,20.0,0],["Colchester",0,20.0,0],["Rutland",0,27.0,0]]}],"New Jersey":[[["Newark",305000],["Jersey City",286000],["Paterson",160000],["Elizabeth",139000],["Lakewood",135000],["Edison",109000],["Woodbridge Township",104000],["Toms River",95000],["Hamilton Township",88000],["Trenton",90000],["Clifton",89000],["Camden",73000],["Brick Township",73000],["Cherry Hill",75000],["Passaic",71000],["Union City",66000],["Old Bridge",67000],["Gloucester Township",65000],["Bayonne",71000],["Franklin Township",68000],["North Bergen",64000],["Vineland",60000],["East Orange",64000],["Union Township",58000],["Piscataway",56000],["New Brunswick",56000],["Jackson Township",57000],["Perth Amboy",55000],["Hoboken",58000],["Parsippany-Troy Hills",56000]],{"small_engine_repair":[["Newark",10,0.31,0],["Jersey City",10,0.25,0],["Paterson",10,0.44,0],["Elizabeth",10,0.31,0],["Edison",10,0.35,0],["Woodbridge Township",10,0.17,0],["Toms River",10,0.41,0],["Hamilton Township",10,0.24,0],["Trenton",10,0.39,0],["Clifton",10,0.25,0],["Brick Township",10,0.23,0],["Cherry Hill",10,0.2,0],["Gloucester Township",10,0.31,0],["Bayonne",10,0.31,0],["Franklin Township",10,0.31,0],["North Bergen",10,0.31,0],["Vineland",10,0.16,0],["East Orange",10,0.36,0],["Piscataway",10,0.31,0],["New Brunswick",10,0.31,0],["Jackson Township",10,0.36,0],["Perth Amboy",10,0.31,0],["Hoboken",10,0.31,0],["Parsippany-Troy Hills",10,0.31,0],["Lakewood",0,0.31,0],["Camden",0,0,0],["Passaic",0,0,0],["Union City",0,0,0],["Old Bridge",0,0,0],["Union Township",0,0,0]],"lawn_mower_repair":[["Newark",10,0.18,0],["Jersey City",10,0.18,0],["Paterson",10,0.22,0],["Elizabeth",10,0.18,0],["Edison",10,0.05,0],["Woodbridge Township",10,0.31,0],["Toms River",10,0.23,0],["Hamilton Township",10,0.22,0],["Trenton",10,0.28,1.29],["Clifton",10,0.2,0],["Brick Township",10,0.23,0],["Cherry Hill",10,0.18,0],["Passaic",10,0.2,0],["Old Bridge",10,0.22,0],["Vineland",10,0.28,0],["Piscataway",10,0.18,0],["New Brunswick",10,0.24,0],["Jackson Township",10,0.19,0],["Perth Amboy",10,0.31,0],["Parsippany-Troy Hills",10,0.18,0],["Lakewood",0,0.23,0],["Camden",0,0,0],["Union City",0,0,0],["Gloucester Township",0,0.23,1.06],["Bayonne",0,0,0],["Franklin Township",0,0,0],["North Bergen",0,0,0],["East Orange",0,0,0],["Union Township",0,0,0],["Hoboken",0,0,0]],"snow_blower_repair":[["Paterson",10,0.02,0],["Camden",10,0.05,0],["Passaic",10,0.02,0],["Union City",10,0.15,0],["Union Township",10,0.02,0],["Newark",0,0,0],["Jersey City",0,0,0],["Elizabeth",0,0,0],["Lakewood",0,0,0],["Edison",0,0,0],["Woodbridge Township",0,0,0],["Toms River",0,0,0],["Hamilton Township",0,0,0],["Trenton",0,0,0],["Clifton",0,0,0],["Brick Township",0,0,0],["Cherry Hill",0,0,0],["Old Bridge",0,0,0],["Gloucester Township",0,0,0],["Bayonne",0,0,0],["Franklin Township",0,0,0],["North Bergen",0,0,0],["Vineland",0,0,0],["East Orange",0,0,0],["Piscataway",0,0,0],["New Brunswick",0,0,0],["Jackson Township",0,0,0],["Perth Amboy",0,0,0],["Hoboken",0,0,0],["Parsippany-Troy Hills",0,0,0]],"generator_repair":[["Newark",10,0.07,0],["Jersey City",10,0.07,0],["Paterson",10,0.07,0],["Edison",10,0.22,0],["Woodbridge Township",10,0.17,0],["Toms River",10,0.29,0],["Clifton",10,0.07,0],["Brick Township",10,0.06,0],["Old Bridge",10,0.1,0],["Franklin Township",10,0.09,0],["Union Township",10,0.06,0],["Piscataway",10,0.07,0],["Elizabeth",0,0.08,0],["Lakewood",0,0.07,0],["Hamilton Township",0,0.08,0],["Trenton",0,0.08,0],["Camden",0,0,0],["Cherry Hill",0,0,0],["Passaic",0,0,0],["Union City",0,0,0],["Gloucester Township",0,0,0],["Bayonne",0,0,0],["North Bergen",0,0,0],["Vineland",0,0,0],["East Orange",0,0,0],["New Brunswick",0,0,0],["Jackson Township",0,0,0],["Perth Amboy",0,0,0],["Hoboken",0,0,0],["Parsippany-Troy Hills",0,0,0]],"motorcycle_repair":[["Newark",30,0.17,0],["Jersey City",20,0.13,0],["Paterson",10,0.3,0],["Brick Township",10,0.33,0],["Franklin Township",10,0.09,0],["Union Township",10,0.13,0],["Elizabeth",0,0,0],["Lakewood",0,0,0],["Edison",0,0,0],["Woodbridge Township",0,0,0],["Toms River",0,0,0],["Hamilton Township",0,0,0],["Trenton",0,0,0],["Clifton",0,0,0],["Camden",0,0,0],["Cherry Hill",0,0,0],["Passaic",0,0,0],["Union City",0,0,0],["Old Bridge",0,0,0],["Gloucester Township",0,0,0],["Bayonne",0,0,0],["North Bergen",0,0,0],["Vineland",0,0,0],["East Orange",0,0,0],["Piscataway",0,0,0],["New Brunswick",0,0,0],["Jackson Township",0,0,0],["Perth Amboy",0,0,0],["Hoboken",0,0,0],["Parsippany-Troy Hills",0,0,0]]}],"New York":[[["Buffalo",276000],["Rochester",210000],["Yonkers",210000],["Syracuse",145000],["Albany",100000],["New Rochelle",81000],["Mount Vernon",68000],["Schenectady",67000],["Utica",64000],["White Plains",59000],["Hempstead",58000],["Troy",51000],["Niagara Falls",48000],["Binghamton",47000],["Freeport",44000],["Long Beach",35000],["Poughkeepsie",31000],["Ithaca",30000],["Middletown",28000],["Kingston",24000],["Peekskill",24000],["Glen Cove",22000],["Newburgh",22000],["Cortland",18000],["Watertown",24000],["Plattsburgh",20000]],{"small_engine_repair":[["Buffalo",40,31.0,0],["Syracuse",20,31.0,0],["Albany",20,34.0,0],["Rochester",10,30.0,0],["Yonkers",10,30.0,0],["Mount Vernon",10,40.0,0],["Schenectady",10,24.0,0],["Utica",10,28.0,0],["White Plains",10,50.0,0],["Troy",10,31.0,0],["Niagara Falls",10,26.0,0],["Binghamton",10,28.0,0],["Poughkeepsie",10,28.0,0],["Ithaca",10,28.0,0],["Middletown",10,30.0,0],["Kingston",10,7.0,0],["Newburgh",10,28.0,0],["Cortland",10,35.0,0],["Watertown",10,31.0,0],["Plattsburgh",10,31.0,0],["New Rochelle",0,0,0],["Hempstead",0,0,0],["Freeport",0,0,0],["Long Beach",0,0,0],["Peekskill",0,0,0],["Glen Cove",0,0,0]],"lawn_mower_repair":[["Buffalo",0,30.0,23.0],["Rochester",0,30.0,8.0],["Yonkers",0,10.0,24.0],["Syracuse",0,20.0,23.0],["Albany",0,10.0,23.0],["New Rochelle",0,0,0],["Mount Vernon",0,0,0],["Schenectady",0,10.0,18.0],["Utica",0,10.0,18.0],["White Plains",0,10.0,24.0],["Hempstead",0,0,0],["Troy",0,10.0,33.0],["Niagara Falls",0,10.0,22.0],["Binghamton",0,10.0,24.0],["Freeport",0,0,0],["Long Beach",0,0,0],["Poughkeepsie",0,10.0,22.0],["Ithaca",0,10.0,28.0],["Middletown",0,10.0,26.0],["Kingston",0,10.0,7.0],["Peekskill",0,0,0],["Glen Cove",0,10.0,22.0],["Newburgh",0,10.0,23.0],["Cortland",0,0,0],["Watertown",0,0,0],["Plattsburgh",0,0,0]],"snow_blower_repair":[["Buffalo",0,0,20.0],["Rochester",0,0,10.0],["Yonkers",0,0,10.0],["Syracuse",0,0,10.0],["Albany",0,0,10.0],["New Rochelle",0,0,10.0],["Mount Vernon",0,0,0],["Schenectady",0,0,10.0],["Utica",0,0,10.0],["White Plains",0,0,0],["Hempstead",0,0,0],["Troy",0,0,0],["Niagara Falls",0,0,0],["Binghamton",0,0,0],["Freeport",0,0,0],["Long Beach",0,0,10.0],["Poughkeepsie",0,0,0],["Ithaca",0,0,0],["Middletown",0,0,0],["Kingston",0,0,10.0],["Peekskill",0,0,0],["Glen Cove",0,0,0],["Newburgh",0,0,0],["Cortland",0,0,0],["Watertown",0,0,10.0],["Plattsburgh",0,0,0]],"generator_repair":[["Buffalo",0,0,0],["Rochester",0,0,0],["Yonkers",0,0,0],["Syracuse",0,0,0],["Albany",0,0,0],["New Rochelle",0,0,0],["Mount Vernon",0,0,0],["Schenectady",0,0,0],["Utica",0,0,0],["White Plains",0,0,0],["Hempstead",0,0,0],["Troy",0,0,0],["Niagara Falls",0,0,0],["Binghamton",0,0,0],["Freeport",0,0,0],["Long Beach",0,0,0],["Poughkeepsie",0,0,0],["Ithaca",0,0,0],["Middletown",0,0,0],["Kingston",0,0,0],["Peekskill",0,0,0],["Glen Cove",0,0,0],["Newburgh",0,0,0],["Cortland",0,0,0],["Watertown",0,0,0],["Plattsburgh",0,0,0]],"motorcycle_repair":[["Albany",22,0,0],["Poughkeepsie",20,0,0],["Middletown",20,0,0],["Rochester",9,0,0],["Buffalo",8,0,0],["Yonkers",7,0,0],["New Rochelle",7,0,0],["Ithaca",5,0,0],["Syracuse",0,0,0],["Mount Vernon",0,0,0],["Schenectady",0,0,0],["Utica",0,0,0],["White Plains",0,0,0],["Hempstead",0,0,0],["Troy",0,0,0],["Niagara Falls",0,0,0],["Binghamton",0,0,0],["Freeport",0,0,0],["Long Beach",0,0,0],["Kingston",0,0,0],["Peekskill",0,0,0],["Glen Cove",0,0,0],["Newburgh",0,0,0],["Cortland",0,0,0],["Watertown",0,0,0],["Plattsburgh",0,0,0]]}],"Kansas":[[["Wichita",400000],["Overland Park",200000],["Kansas City",155000],["Olathe",143000],["Topeka",126000],["Lawrence",95000],["Shawnee",67000],["Manhattan",55000],["Lenexa",55000],["Salina",46000],["Hutchinson",40000],["Leavenworth",38000],["Leawood",37000],["Garden City",34000],["Emporia",24000]],{"small_engine_repair":[["Overland Park",30,0.11,0],["Kansas City",20,0.24,0],["Olathe",20,0.2,0],["Lenexa",20,0.07,0],["Wichita",10,0.44,0],["Topeka",10,0.32,0],["Lawrence",10,0.3,0],["Shawnee",10,0.13,0],["Manhattan",10,0.31,0],["Salina",10,0.31,0],["Hutchinson",10,0.22,0],["Leavenworth",10,0.3,0],["Leawood",10,0.06,0],["Garden City",10,0.31,0],["Emporia",0,0,0]],"lawn_mower_repair":[["Overland Park",40,0.18,0],["Kansas City",30,0.22,0],["Olathe",20,0.2,0],["Topeka",20,0.22,0],["Lenexa",20,0.22,0],["Wichita",10,0.31,0],["Lawrence",10,0.28,0],["Shawnee",10,0.18,0],["Manhattan",10,0.34,0],["Salina",10,0.28,0],["Hutchinson",10,0.22,0],["Leavenworth",0,0,0],["Leawood",0,0,0],["Garden City",0,0,0],["Emporia",0,0,0]],"snow_blower_repair":[["Wichita",10,0.36,0],["Overland Park",10,0.03,0],["Topeka",10,0.04,0],["Lenexa",10,0.03,0],["Garden City",10,0.31,0],["Emporia",10,0.31,0],["Kansas City",0,0,0],["Olathe",0,0,0],["Lawrence",0,0,0],["Shawnee",0,0,0],["Manhattan",0,0,0],["Salina",0,0,0],["Hutchinson",0,0,0],["Leavenworth",0,0,0],["Leawood",0,0,0]],"generator_repair":[["Wichita",10,0.24,0],["Overland Park",10,0.09,0],["Kansas City",10,0.1,0],["Topeka",10,0.04,0],["Olathe",0,0,0],["Lawrence",0,0,0],["Shawnee",0,0,0],["Manhattan",0,0,0],["Lenexa",0,0,0],["Salina",0,0,0],["Hutchinson",0,0,0],["Leavenworth",0,0,0],["Leawood",0,0,0],["Garden City",0,0,0],["Emporia",0,0,0]],"motorcycle_repair":[["Wichita",10,0.47,0],["Overland Park",10,0.16,0],["Kansas City",10,0.11,0],["Olathe",10,0.23,0],["Topeka",10,0.3,0],["Shawnee",10,0.17,0],["Lenexa",10,0.2,0],["Lawrence",0,0,0],["Manhattan",0,0,0],["Salina",0,0,0],["Hutchinson",0,0,0],["Leavenworth",0,0,0],["Leawood",0,0,0],["Garden City",0,0,0],["Emporia",0,0,0]]}],"Iowa":[[["Des Moines",215000],["Cedar Rapids",135000],["Davenport",101000],["Ankeny",67000],["Council Bluffs",63000],["Marion",41000]],{"small_engine_repair":[["Des Moines",20,28.0,0],["Cedar Rapids",10,31.0,0],["Davenport",10,28.0,0],["Ankeny",10,28.0,0],["Council Bluffs",10,30.0,0],["Marion",10,31.0,0]],"snow_blower_repair":[],"generator_repair":[],"motorcycle_repair":[]}],"Virginia":[[["Virginia Beach",460000],["Chesapeake",250000],["Norfolk",238000],["Richmond",232000],["Newport News",185000],["Alexandria",160000],["Hampton",137000],["Roanoke",100000],["Portsmouth",97000],["Suffolk",95000],["Lynchburg",80000],["Centreville",74000],["Dale City",73000],["Reston",63000],["Harrisonburg",52000]],{"small_engine_repair":[["Richmond",40,23.0,0],["Virginia Beach",20,23.0,0],["Chesapeake",20,30.0,0],["Norfolk",20,45.0,0],["Newport News",10,29.0,0],["Alexandria",10,9.0,0],["Hampton",10,24.0,0],["Lynchburg",10,26.0,0],["Centreville",10,14.0,0],["Dale City",10,23.0,1.79],["Reston",10,10.0,0],["Harrisonburg",10,35.0,0],["Roanoke",0,0,0],["Portsmouth",0,0,0],["Suffolk",0,0,0]],"lawn_mower_repair":[["Virginia Beach",50,23.0,0],["Richmond",40,6.0,1.49],["Chesapeake",30,23.0,0],["Norfolk",20,24.0,0],["Newport News",20,23.0,0],["Hampton",20,24.0,0],["Roanoke",20,18.0,0],["Alexandria",10,18.0,0],["Portsmouth",10,33.0,0],["Suffolk",10,23.0,0],["Lynchburg",10,23.0,0],["Centreville",10,11.0,0],["Dale City",10,14.0,0],["Reston",10,24.0,0],["Harrisonburg",10,23.0,0]],"snow_blower_repair":[["Alexandria",10,2.0,0],["Suffolk",10,31.0,0],["Harrisonburg",10,31.0,0],["Virginia Beach",0,0,0],["Chesapeake",0,0,0],["Norfolk",0,0,0],["Richmond",0,0,0],["Newport News",0,0,0],["Hampton",0,0,0],["Roanoke",0,0,0],["Portsmouth",0,0,0],["Lynchburg",0,0,0],["Centreville",0,0,0],["Dale City",0,0,0],["Reston",0,0,0]],"generator_repair":[["Virginia Beach",10,29.0,20.27],["Chesapeake",10,7.0,0],["Norfolk",10,29.0,0],["Richmond",10,7.0,0],["Newport News",10,8.0,0],["Alexandria",10,6.0,0],["Hampton",10,29.0,0],["Roanoke",10,29.0,0],["Harrisonburg",10,29.0,0],["Portsmouth",0,0,0],["Suffolk",0,5.0,0],["Lynchburg",0,0,0],["Centreville",0,0,0],["Dale City",0,0,0],["Reston",0,0,0]],"motorcycle_repair":[["Virginia Beach",10,11.0,0],["Chesapeake",10,33.0,0],["Norfolk",10,15.0,0],["Richmond",10,13.0,0],["Newport News",10,41.0,0],["Alexandria",10,14.0,0],["Hampton",10,8.0,0],["Roanoke",10,26.0,0],["Centreville",10,29.0,0],["Reston",10,14.0,0],["Harrisonburg",10,30.0,0],["Portsmouth",0,0,0],["Suffolk",0,0,0],["Lynchburg",0,0,0],["Dale City",0,0,0]]}],"New Mexico":[[["Albuquerque",560000],["Las Cruces",115000],["Rio Rancho",105000],["Santa Fe",89000],["Roswell",48000],["Farmington",46000],["Hobbs",43000],["Clovis",38000],["Alamogordo",31000],["Carlsbad",32000]],{"small_engine_repair":[["Albuquerque",40,31.0,0],["Las Cruces",20,30.0,0],["Rio Rancho",10,31.0,0],["Santa Fe",10,28.0,0],["Roswell",10,31.0,0],["Farmington",10,30.0,0],["Hobbs",10,34.0,0],["Clovis",10,31.0,0],["Alamogordo",10,38.0,0],["Carlsbad",10,34.0,0]],"lawn_mower_repair":[["Albuquerque",30,28.0,0],["Las Cruces",10,14.0,0],["Roswell",10,26.0,0],["Hobbs",10,22.0,0],["Clovis",10,22.0,0],["Carlsbad",10,22.0,0],["Rio Rancho",0,0,0],["Santa Fe",0,0,0],["Farmington",0,0,0],["Alamogordo",0,0,0]],"snow_blower_repair":[["Rio Rancho",10,31.0,0],["Santa Fe",10,31.0,0],["Roswell",10,26.0,0],["Farmington",10,34.0,0],["Hobbs",10,28.0,0],["Clovis",10,29.0,0],["Carlsbad",10,31.0,0],["Albuquerque",0,0,0],["Las Cruces",0,0,0],["Alamogordo",0,0,0]],"generator_repair":[["Albuquerque",10,10.0,0],["Las Cruces",0,0,0],["Rio Rancho",0,0,0],["Santa Fe",0,0,0],["Roswell",0,0,0],["Farmington",0,0,0],["Hobbs",0,0,0],["Clovis",0,0,0],["Alamogordo",0,0,0],["Carlsbad",0,0,0]],"motorcycle_repair":[["Albuquerque",10,15.0,0],["Rio Rancho",10,28.0,0],["Las Cruces",0,0,0],["Santa Fe",0,0,0],["Roswell",0,0,0],["Farmington",0,0,0],["Hobbs",0,0,0],["Clovis",0,0,0],["Alamogordo",0,0,0],["Carlsbad",0,0,0]]}],"Pennsylvania":[[["Philadelphia",1585000],["Pittsburgh",302000],["Allentown",125000],["Erie",94000],["Reading",95000],["Scranton",76000],["Bethlehem",76000],["Lancaster",58000],["Harrisburg",51000],["Altoona",43000],["York",45000],["State College",39000],["Wilkes-Barre",40000],["Chester",33000],["Williamsport",28000]],{"small_engine_repair":[["Philadelphia",40,31.0,0],["Pittsburgh",30,30.0,0],["Allentown",10,40.0,0],["Erie",10,31.0,0],["Reading",10,23.0,0],["Scranton",10,35.0,0],["Bethlehem",10,40.0,0],["Lancaster",10,12.0,0],["Harrisburg",10,28.0,0],["Altoona",10,28.0,0],["York",10,3.0,0],["State College",10,34.0,0],["Wilkes-Barre",10,40.0,0],["Chester",10,31.0,0],["Williamsport",10,28.0,0]],"lawn_mower_repair":[["Philadelphia",70,21.0,0.91],["Pittsburgh",40,24.0,0],["Erie",20,24.0,0],["Wilkes-Barre",20,24.0,0],["Allentown",10,28.0,0],["Reading",10,23.0,1.53],["Scranton",10,21.0,0],["Bethlehem",10,23.0,0],["Lancaster",10,8.0,0],["Harrisburg",10,19.0,0],["Altoona",10,28.0,0],["York",10,4.0,0],["State College",10,14.0,0],["Chester",10,4.0,0],["Williamsport",0,0,0]],"snow_blower_repair":[["Philadelphia",10,7.0,0],["Pittsburgh",10,4.0,0],["Erie",10,23.0,0],["Bethlehem",10,38.0,0],["Williamsport",10,31.0,0],["Allentown",0,0,0],["Reading",0,0,0],["Scranton",0,0,0],["Lancaster",0,0,0],["Harrisburg",0,0,0],["Altoona",0,0,0],["York",0,0,0],["State College",0,0,0],["Wilkes-Barre",0,0,0],["Chester",0,0,0]],"generator_repair":[["Lancaster",30,5.0,0],["Harrisburg",30,8.0,0],["York",30,4.0,0],["Philadelphia",10,11.0,9.68],["Pittsburgh",10,4.0,0],["Erie",10,17.0,0],["Reading",10,6.0,0],["Bethlehem",10,6.0,0],["Wilkes-Barre",10,7.0,0],["Allentown",0,0,0],["Scranton",0,0,0],["Altoona",0,0,0],["State College",0,0,0],["Chester",0,0,0],["Williamsport",0,0,0]],"motorcycle_repair":[["Philadelphia",50,7.0,0],["Pittsburgh",40,19.0,0],["Allentown",10,26.0,0],["Erie",10,37.0,0],["Reading",10,35.0,0],["Bethlehem",10,34.0,0],["Lancaster",10,36.0,0],["York",10,19.0,0],["State College",10,26.0,0],["Scranton",0,0,0],["Harrisburg",0,0,0],["Altoona",0,0,0],["Wilkes-Barre",0,0,0],["Chester",0,0,0],["Williamsport",0,0,0]]}],"Rhode Island":[[["Providence",190000],["Cranston",82000],["Warwick",81000],["Pawtucket",76000],["East Providence",50000],["Woonsocket",43000],["Cumberland",36000],["Coventry",35000],["North Providence",34000],["South Kingstown",31000]],{"small_engine_repair":[["Providence",10,35.0,0],["Cranston",10,31.0,0],["Warwick",10,33.0,0],["Pawtucket",10,38.0,0],["East Providence",10,31.0,0],["Woonsocket",10,31.0,0],["Cumberland",10,31.0,0],["Coventry",10,36.0,0],["North Providence",10,37.0,0],["South Kingstown",10,31.0,0]],"lawn_mower_repair":[["Providence",10,29.0,0],["Cranston",10,25.0,0],["Warwick",10,24.0,0],["East Providence",10,22.0,0],["North Providence",10,22.0,0],["South Kingstown",10,10.0,0],["Pawtucket",0,0,0],["Woonsocket",0,0,0],["Cumberland",0,0,0],["Coventry",0,0,0]],"snow_blower_repair":[["Providence",10,31.0,0],["Cranston",10,25.0,0],["Warwick",0,0,0],["Pawtucket",0,0,0],["East Providence",0,0,0],["Woonsocket",0,0,0],["Cumberland",0,0,0],["Coventry",0,0,0],["North Providence",0,0,0],["South Kingstown",0,0,0]],"generator_repair":[["Providence",10,29.0,0],["Cranston",0,0,0],["Warwick",0,0,0],["Pawtucket",0,0,0],["East Providence",0,0,0],["Woonsocket",0,0,0],["Cumberland",0,0,0],["Coventry",0,0,0],["North Providence",0,0,0],["South Kingstown",0,0,0]],"motorcycle_repair":[["Providence",10,28.0,0],["Cranston",10,47.0,0],["Warwick",10,29.0,0],["Pawtucket",0,0,0],["East Providence",0,0,0],["Woonsocket",0,0,0],["Cumberland",0,0,0],["Coventry",0,0,0],["North Providence",0,0,0],["South Kingstown",0,0,0]]}],"Massachusetts":[[["Boston",650000],["Worcester",205000],["Springfield",155000],["Cambridge",119000],["Lowell",115000],["Brockton",105000],["Quincy",101000],["Lynn",101000],["New Bedford",100000],["Fall River",95000],["Newton",91000],["Somerville",81000],["Lawrence",81000],["Framingham",80000],["Haverhill",67000],["Malden",65000],["Brookline",63000],["Plymouth",61000],["Medford",60000],["Taunton",59000],["Chicopee",55000],["Everett",53000],["Revere",53000],["Peabody",53000],["Methuen",52000],["Attleboro",46000],["Salem",44000],["Braintree",38000],["Marlborough",36000]],{"small_engine_repair":[["Boston",40,0.19,0],["Haverhill",20,0.3,0],["Worcester",10,0.31,0],["Springfield",10,0.31,0],["Cambridge",10,0.14,0],["Lowell",10,0.38,0],["Brockton",10,0.4,0],["Quincy",10,0.14,0],["Lynn",10,0.4,0],["New Bedford",10,0.28,0],["Fall River",10,0.31,0],["Newton",10,0.25,0],["Somerville",10,0.22,0],["Lawrence",10,0.31,0],["Framingham",10,0.24,0],["Malden",10,0.37,0],["Brookline",10,0.17,0],["Plymouth",10,0.4,0],["Medford",10,0.32,0],["Taunton",10,0.3,0],["Chicopee",10,0.24,0],["Everett",10,0.37,0],["Revere",10,0.28,0],["Peabody",10,0.33,0],["Methuen",10,0.31,0],["Attleboro",10,0.28,0],["Salem",10,0.33,0],["Braintree",10,0.37,0],["Marlborough",10,0.24,0]],"lawn_mower_repair":[["Boston",40,0.16,0],["Worcester",10,0.05,0],["Springfield",10,0.28,0],["Cambridge",10,0.14,0],["Brockton",10,0.2,0],["Quincy",10,0.13,0],["New Bedford",10,0.24,0],["Fall River",10,0.24,0],["Newton",10,0.09,0],["Framingham",10,0.03,0],["Haverhill",10,0.22,0],["Taunton",10,0.22,0],["Chicopee",10,0.23,0],["Peabody",10,0.03,0],["Methuen",10,0.28,0],["Attleboro",10,0.22,0],["Salem",10,0.02,0],["Marlborough",10,0.08,0],["Lowell",0,0,0],["Lynn",0,0,0],["Somerville",0,0,0],["Lawrence",0,0,0],["Malden",0,0,0],["Brookline",0,0,0],["Plymouth",0,0,0],["Medford",0,0,0],["Everett",0,0,0],["Revere",0,0,0],["Braintree",0,0,0]],"snow_blower_repair":[["Boston",20,0.1,0],["Springfield",10,0.24,0],["New Bedford",10,0.06,0],["Newton",10,0.03,0],["Haverhill",10,0.08,0],["Plymouth",10,0.13,0],["Medford",10,0.16,0],["Taunton",10,0.22,0],["Peabody",10,0.08,0],["Salem",10,0.07,0],["Worcester",0,0,0],["Cambridge",0,0,0],["Lowell",0,0,0],["Brockton",0,0,0],["Quincy",0,0,0],["Lynn",0,0,0],["Fall River",0,0,0],["Somerville",0,0,0],["Lawrence",0,0,0],["Framingham",0,0,0],["Malden",0,0,0],["Brookline",0,0,0],["Chicopee",0,0,0],["Everett",0,0,0],["Revere",0,0,0],["Methuen",0,0,0],["Attleboro",0,0,0],["Braintree",0,0,0],["Marlborough",0,0,0]],"generator_repair":[["Plymouth",70,0.08,0],["Boston",50,0.05,0],["Brockton",20,0.26,0],["Quincy",20,0.07,0],["Braintree",20,0.11,0],["Worcester",10,0.07,0],["Springfield",10,0.08,0],["Cambridge",10,0.07,0],["New Bedford",10,0.06,0],["Newton",10,0.07,0],["Framingham",10,0.05,0],["Haverhill",10,0.07,0],["Taunton",10,0.16,0],["Peabody",10,0.07,0],["Methuen",10,0.07,0],["Salem",10,0.07,0],["Lowell",0,0,0],["Lynn",0,0,0],["Fall River",0,0,0],["Somerville",0,0,0],["Lawrence",0,0,0],["Malden",0,0,0],["Brookline",0,0,0],["Medford",0,0,0],["Chicopee",0,0,0],["Everett",0,0,0],["Revere",0,0,0],["Attleboro",0,0,0],["Marlborough",0,0,0]],"motorcycle_repair":[["Boston",50,0.32,0],["Springfield",10,0.08,0],["Cambridge",10,0.18,0],["Lynn",10,0.14,0],["New Bedford",10,0.3,0],["Worcester",0,0,0],["Lowell",0,0,0],["Brockton",0,0,0],["Quincy",0,0,0],["Fall River",0,0,0],["Newton",0,0,0],["Somerville",0,0,0],["Lawrence",0,0,0],["Framingham",0,0,0],["Haverhill",0,0,0],["Malden",0,0,0],["Brookline",0,0,0],["Plymouth",0,0,0],["Medford",0,0,0],["Taunton",0,0,0],["Chicopee",0,0,0],["Everett",0,0,0],["Revere",0,0,0],["Peabody",0,0,0],["Methuen",0,0,0],["Attleboro",0,0,0],["Salem",0,0,0],["Braintree",0,0,0],["Marlborough",0,0,0]]}],"Washington":[[["Seattle",755000],["Spokane",230000],["Tacoma",220000],["Vancouver",195000],["Bellevue",154000],["Kent",137000],["Everett",118000],["Renton",107000],["Spokane Valley",105000],["Federal Way",101000],["Yakima",97000],["Kirkland",94000],["Bellingham",93000],["Kennewick",92000],["Auburn",87000],["Pasco",78000],["Marysville",71000],["Redmond",67000],["Sammamish",66000],["Lakewood",64000],["Richland",63000],["Shoreline",61000],["Burien",51000],["Olympia",53000],["Lacey",53000],["Edmonds",52000],["Puyallup",42000],["Lynnwood",40000],["Mount Vernon",38000],["Walla Walla",34000],["Pullman",33000],["Des Moines",32000],["Issaquah",31000],["Bremerton",30000],["Longview",30000]],{"small_engine_repair":[["Seattle",90,28.0,0],["Vancouver",90,28.0,0],["Spokane",30,31.0,0],["Tacoma",20,26.0,0],["Spokane Valley",20,31.0,0],["Yakima",20,28.0,0],["Olympia",20,31.0,0],["Bellevue",10,32.0,0],["Kent",10,24.0,0],["Everett",10,28.0,0],["Renton",10,38.0,0],["Federal Way",10,28.0,0],["Kirkland",10,31.0,0],["Bellingham",10,31.0,0],["Kennewick",10,31.0,0],["Auburn",10,26.0,0],["Pasco",10,23.0,0],["Marysville",10,37.0,0],["Redmond",10,31.0,0],["Sammamish",10,39.0,0],["Lakewood",10,31.0,0],["Richland",10,31.0,0],["Shoreline",10,31.0,0],["Burien",10,28.0,0],["Lacey",10,28.0,0],["Edmonds",10,30.0,0],["Puyallup",10,32.0,0],["Lynnwood",10,37.0,0],["Mount Vernon",10,24.0,0],["Walla Walla",10,28.0,0],["Pullman",10,31.0,0],["Issaquah",10,28.0,0],["Bremerton",10,23.0,0],["Des Moines",0,38.0,0],["Longview",0,28.0,0]],"lawn_mower_repair":[["Seattle",110,34.0,0],["Spokane",30,27.0,0],["Tacoma",30,24.0,0],["Vancouver",30,7.0,0],["Spokane Valley",20,28.0,0],["Federal Way",20,18.0,0],["Olympia",20,24.0,0],["Bellevue",10,23.0,0],["Kent",10,18.0,0],["Everett",10,24.0,0],["Renton",10,20.0,0],["Yakima",10,24.0,0],["Kirkland",10,32.0,0],["Bellingham",10,22.0,0],["Kennewick",10,24.0,0],["Auburn",10,24.0,0],["Pasco",10,32.0,0],["Marysville",10,22.0,0],["Redmond",10,20.0,0],["Sammamish",10,24.0,0],["Lakewood",10,23.0,0],["Richland",10,24.0,2.85],["Shoreline",10,32.0,0],["Burien",10,30.0,0],["Lacey",10,24.0,0],["Edmonds",10,22.0,0],["Puyallup",10,22.0,0],["Lynnwood",10,22.0,0],["Mount Vernon",10,24.0,0],["Walla Walla",10,24.0,0],["Des Moines",10,23.0,0],["Issaquah",10,29.0,0],["Bremerton",10,23.0,0],["Pullman",0,24.0,0],["Longview",0,22.0,0]],"snow_blower_repair":[["Seattle",10,32.0,0],["Spokane",10,31.0,0],["Renton",10,37.0,0],["Federal Way",10,31.0,0],["Yakima",10,28.0,0],["Kirkland",10,34.0,0],["Bellingham",10,31.0,0],["Auburn",10,23.0,0],["Marysville",10,26.0,0],["Redmond",10,30.0,0],["Sammamish",10,30.0,0],["Lakewood",10,31.0,0],["Shoreline",10,35.0,0],["Burien",10,28.0,0],["Olympia",10,31.0,0],["Lacey",10,33.0,0],["Edmonds",10,25.0,0],["Puyallup",10,37.0,0],["Lynnwood",10,31.0,0],["Mount Vernon",10,31.0,0],["Walla Walla",10,23.0,0],["Des Moines",10,31.0,0],["Issaquah",10,29.0,0],["Bremerton",10,21.0,0],["Longview",10,36.0,0],["Tacoma",0,31.0,0],["Vancouver",0,23.0,0],["Bellevue",0,36.0,0],["Kent",0,23.0,0],["Everett",0,27.0,0],["Spokane Valley",0,26.0,0],["Kennewick",0,27.0,0],["Pasco",0,29.0,0],["Richland",0,31.0,0],["Pullman",0,27.0,0]],"generator_repair":[["Seattle",30,29.0,15.08],["Spokane",10,5.0,0],["Tacoma",10,6.0,0],["Bellevue",10,29.0,0],["Kent",10,6.0,0],["Renton",10,29.0,0],["Federal Way",10,7.0,0],["Yakima",10,5.0,0],["Kirkland",10,6.0,0],["Kennewick",10,26.0,0],["Auburn",10,6.0,0],["Marysville",10,29.0,0],["Redmond",10,29.0,0],["Shoreline",10,28.0,0],["Burien",10,9.0,0],["Olympia",10,9.0,0],["Issaquah",10,29.0,0],["Bremerton",10,29.0,0],["Longview",10,32.0,0],["Vancouver",0,6.0,0],["Everett",0,29.0,0],["Spokane Valley",0,23.0,0],["Bellingham",0,7.0,0],["Pasco",0,32.0,0],["Sammamish",0,29.0,0],["Lakewood",0,6.0,0],["Richland",0,29.0,0],["Lacey",0,11.0,0],["Edmonds",0,5.0,0],["Puyallup",0,6.0,0],["Lynnwood",0,6.0,0],["Mount Vernon",0,8.0,0],["Walla Walla",0,13.0,0],["Pullman",0,38.0,0],["Des Moines",0,6.0,0]],"motorcycle_repair":[["Seattle",90,28.0,0],["Spokane",10,38.0,0],["Tacoma",10,32.0,0],["Vancouver",10,8.0,0],["Bellevue",10,23.0,0],["Kent",10,45.0,0],["Everett",10,9.0,0],["Renton",10,17.0,0],["Kirkland",10,36.0,0],["Bellingham",10,21.0,0],["Kennewick",10,31.0,0],["Auburn",10,26.0,0],["Redmond",10,21.0,0],["Lakewood",10,14.0,0],["Burien",10,32.0,0],["Olympia",10,9.0,0],["Longview",10,33.0,0],["Spokane Valley",0,20.0,0],["Federal Way",0,40.0,0],["Yakima",0,26.0,0],["Pasco",0,32.0,0],["Marysville",0,26.0,0],["Sammamish",0,26.0,0],["Richland",0,32.0,0],["Shoreline",0,21.0,0],["Lacey",0,40.0,0],["Edmonds",0,20.0,0],["Puyallup",0,10.0,0],["Lynnwood",0,17.0,0],["Mount Vernon",0,13.0,0],["Walla Walla",0,30.0,0],["Pullman",0,52.0,0],["Des Moines",0,21.0,0],["Issaquah",0,17.0,0],["Bremerton",0,17.0,0]]}],"Ohio":[[["Columbus",920000],["Cleveland",370000],["Cincinnati",308000],["Toledo",268000],["Akron",190000],["Dayton",135000],["Parma",79000],["Canton",70000],["Youngstown",60000],["Lorain",65000],["Hamilton",62000],["Springfield",58000],["Kettering",57000],["Elyria",53000],["Lakewood",50000],["Cuyahoga Falls",51000],["Middletown",50000],["Newark",49000],["Mansfield",47000],["Mentor",47000],["Beavercreek",47000],["Strongsville",46000],["Dublin",46000],["Westerville",44000],["Stow",44000],["Brunswick",43000],["Fairfield",42000],["Findlay",41000],["Lancaster",41000],["Warren",40000]],{"small_engine_repair":[["Cleveland",50,24.0,0],["Columbus",40,28.0,0],["Cincinnati",20,31.0,0],["Toledo",10,22.0,0],["Akron",10,30.0,0],["Dayton",10,24.0,0],["Parma",10,17.0,0],["Canton",10,28.0,0],["Youngstown",10,28.0,0],["Lorain",10,31.0,0],["Springfield",10,34.0,0],["Kettering",10,28.0,0],["Elyria",10,28.0,0],["Lakewood",10,24.0,0],["Middletown",10,31.0,0],["Newark",10,31.0,0],["Mansfield",10,24.0,0],["Mentor",10,24.0,0],["Beavercreek",10,38.0,0],["Strongsville",10,38.0,0],["Dublin",10,24.0,0],["Westerville",10,24.0,0],["Stow",10,31.0,0],["Brunswick",10,26.0,0],["Fairfield",10,31.0,0],["Findlay",10,28.0,0],["Lancaster",10,31.0,0],["Hamilton",0,0,0],["Cuyahoga Falls",0,0,0],["Warren",0,0,0]],"lawn_mower_repair":[["Columbus",110,30.0,1.29],["Cleveland",110,22.0,1.02],["Cincinnati",90,24.0,2.6],["Toledo",30,21.0,0],["Dayton",30,24.0,0],["Akron",20,24.0,0],["Canton",20,24.0,0],["Hamilton",20,18.0,0],["Beavercreek",20,28.0,0],["Fairfield",20,5.0,0],["Parma",10,24.0,0],["Youngstown",10,24.0,0],["Lorain",10,28.0,0],["Springfield",10,24.0,0],["Kettering",10,23.0,0],["Elyria",10,24.0,0],["Lakewood",10,22.0,0],["Cuyahoga Falls",10,18.0,0],["Middletown",10,8.0,0],["Newark",10,33.0,0],["Mansfield",10,24.0,0],["Mentor",10,24.0,0],["Strongsville",10,26.0,0],["Dublin",10,22.0,0],["Westerville",10,23.0,0],["Stow",10,18.0,0],["Brunswick",10,24.0,0],["Findlay",10,28.0,0],["Warren",10,23.0,0],["Lancaster",0,0,0]],"snow_blower_repair":[["Cleveland",40,26.0,0],["Columbus",10,22.0,0],["Cincinnati",10,17.0,0],["Akron",10,26.0,0],["Dayton",10,25.0,0],["Parma",10,22.0,0],["Hamilton",10,18.0,0],["Springfield",10,31.0,0],["Cuyahoga Falls",10,22.0,0],["Mentor",10,23.0,0],["Beavercreek",10,31.0,0],["Fairfield",10,27.0,0],["Toledo",0,0,0],["Canton",0,0,0],["Youngstown",0,0,0],["Lorain",0,0,0],["Kettering",0,0,0],["Elyria",0,0,0],["Lakewood",0,0,0],["Middletown",0,0,0],["Newark",0,0,0],["Mansfield",0,0,0],["Strongsville",0,0,0],["Dublin",0,0,0],["Westerville",0,0,0],["Stow",0,0,0],["Brunswick",0,0,0],["Findlay",0,0,0],["Lancaster",0,0,0],["Warren",0,0,0]],"generator_repair":[["Columbus",20,6.0,5.63],["Cleveland",10,7.0,6.55],["Cincinnati",10,11.0,0],["Toledo",10,4.0,0],["Akron",10,11.0,0],["Dayton",10,8.0,0],["Parma",10,9.0,0],["Canton",10,11.0,0],["Youngstown",10,14.0,0],["Springfield",10,14.0,0],["Kettering",10,17.0,0],["Elyria",10,10.0,0],["Middletown",10,8.0,0],["Beavercreek",10,10.0,0],["Lorain",0,0,0],["Hamilton",0,0,0],["Lakewood",0,0,0],["Cuyahoga Falls",0,0,0],["Newark",0,0,0],["Mansfield",0,0,0],["Mentor",0,0,0],["Strongsville",0,0,0],["Dublin",0,0,0],["Westerville",0,0,0],["Stow",0,0,0],["Brunswick",0,0,0],["Fairfield",0,0,0],["Findlay",0,0,0],["Lancaster",0,0,0],["Warren",0,0,0]],"motorcycle_repair":[["Columbus",20,16.0,0],["Cleveland",20,13.0,0],["Cincinnati",10,10.0,0],["Toledo",10,26.0,0],["Akron",10,38.0,0],["Dayton",10,26.0,0],["Parma",10,40.0,0],["Canton",10,8.0,0],["Youngstown",10,26.0,0],["Hamilton",10,10.0,0],["Springfield",10,32.0,0],["Fairfield",10,10.0,0],["Lorain",0,0,0],["Kettering",0,0,0],["Elyria",0,0,0],["Lakewood",0,0,0],["Cuyahoga Falls",0,0,0],["Middletown",0,0,0],["Newark",0,0,0],["Mansfield",0,0,0],["Mentor",0,0,0],["Beavercreek",0,0,0],["Strongsville",0,0,0],["Dublin",0,0,0],["Westerville",0,0,0],["Stow",0,0,0],["Brunswick",0,0,0],["Findlay",0,0,0],["Lancaster",0,0,0],["Warren",0,0,0]]}],"North Dakota":[[["Fargo",133000],["Bismarck",74000],["Grand Forks",59000],["Minot",48000],["West Fargo",39000],["Williston",29000],["Dickinson",25000],["Mandan",24000]],{"small_engine_repair":[["Fargo",20,30.0,0],["Bismarck",10,30.0,0],["Grand Forks",10,28.0,0],["Minot",10,35.0,0],["West Fargo",10,45.0,0],["Williston",10,28.0,0],["Dickinson",10,31.0,0],["Mandan",10,28.0,0]],"lawn_mower_repair":[["Fargo",10,21.0,0],["Bismarck",10,28.0,0],["Grand Forks",10,23.0,0],["Minot",0,0,0],["West Fargo",0,0,0],["Williston",0,0,0],["Dickinson",0,0,0],["Mandan",0,0,0]],"snow_blower_repair":[["Fargo",10,21.0,0],["Grand Forks",10,22.0,0],["Williston",10,34.0,0],["Mandan",10,38.0,0],["Bismarck",0,0,0],["Minot",0,0,0],["West Fargo",0,0,0],["Dickinson",0,0,0]],"generator_repair":[["Fargo",0,0,0],["Bismarck",0,0,0],["Grand Forks",0,0,0],["Minot",0,0,0],["West Fargo",0,0,0],["Williston",0,0,0],["Dickinson",0,0,0],["Mandan",0,0,0]],"motorcycle_repair":[["Williston",10,20.0,0],["Fargo",0,0,0],["Bismarck",0,0,0],["Grand Forks",0,0,0],["Minot",0,0,0],["West Fargo",0,0,0],["Dickinson",0,0,0],["Mandan",0,0,0]]}],"South Dakota":[[["Sioux Falls",213000],["Rapid City",80000],["Aberdeen",28000],["Brookings",24000],["Watertown",22000],["Mitchell",15000],["Yankton",15000],["Huron",14000]],{"small_engine_repair":[["Sioux Falls",10,3.0,0],["Rapid City",10,28.0,0],["Aberdeen",10,34.0,0],["Brookings",10,28.0,0],["Watertown",10,28.0,0],["Mitchell",10,31.0,0],["Yankton",0,0,0],["Huron",0,31.0,0]],"lawn_mower_repair":[["Sioux Falls",10,12.0,0],["Rapid City",10,13.0,0],["Aberdeen",10,21.0,0],["Brookings",10,21.0,0],["Watertown",0,14.0,0],["Mitchell",0,31.0,0],["Yankton",0,0,0],["Huron",0,24.0,0]],"snow_blower_repair":[["Sioux Falls",10,3.0,0],["Watertown",10,28.0,0],["Huron",10,29.0,0],["Rapid City",0,0,0],["Aberdeen",0,0,0],["Brookings",0,0,0],["Mitchell",0,0,0],["Yankton",0,0,0]],"generator_repair":[["Watertown",10,22.0,0],["Huron",10,16.0,0],["Sioux Falls",0,0,0],["Rapid City",0,0,0],["Aberdeen",0,0,0],["Brookings",0,0,0],["Mitchell",0,0,0],["Yankton",0,0,0]],"motorcycle_repair":[["Sioux Falls",10,26.0,0],["Aberdeen",10,32.0,0],["Mitchell",10,8.0,0],["Rapid City",0,0,0],["Brookings",0,0,0],["Watertown",0,0,0],["Yankton",0,0,0],["Huron",0,0,0]]}],"Maine":[[["Portland",68000],["Lewiston",36000],["Bangor",32000],["South Portland",26000],["Auburn",24000],["Biddeford",24000],["Sanford",22000],["Augusta",19000],["Brunswick",21000],["Scarborough",21000],["Saco",20000],["Windham",19000],["Waterville",15000]],{"small_engine_repair":[["Portland",10,31.0,0],["Lewiston",10,28.0,0],["Bangor",10,28.0,0],["South Portland",10,31.0,0],["Auburn",10,23.0,0],["Biddeford",10,28.0,0],["Augusta",10,31.0,0],["Saco",10,40.0,0],["Windham",10,13.0,0],["Waterville",10,45.0,0],["Sanford",0,0,0],["Brunswick",0,0,0],["Scarborough",0,0,0]],"lawn_mower_repair":[["Portland",10,22.0,0],["Scarborough",10,18.0,0],["Lewiston",0,0,0],["Bangor",0,0,0],["South Portland",0,0,0],["Auburn",0,0,0],["Biddeford",0,0,0],["Sanford",0,0,0],["Augusta",0,0,0],["Brunswick",0,0,0],["Saco",0,0,0],["Windham",0,0,0],["Waterville",0,0,0]],"snow_blower_repair":[["Portland",10,22.0,0],["Sanford",10,27.0,0],["Lewiston",0,0,0],["Bangor",0,0,0],["South Portland",0,0,0],["Auburn",0,0,0],["Biddeford",0,0,0],["Augusta",0,0,0],["Brunswick",0,0,0],["Scarborough",0,0,0],["Saco",0,0,0],["Windham",0,0,0],["Waterville",0,0,0]],"generator_repair":[["Portland",20,29.0,0],["South Portland",10,6.0,0],["Biddeford",10,32.0,0],["Sanford",10,22.0,0],["Saco",10,6.0,0],["Windham",10,11.0,0],["Lewiston",0,0,0],["Bangor",0,0,0],["Auburn",0,0,0],["Augusta",0,0,0],["Brunswick",0,0,0],["Scarborough",0,0,0],["Waterville",0,0,0]],"motorcycle_repair":[["Portland",10,25.0,0],["Auburn",10,50.0,0],["Scarborough",10,20.0,0],["Saco",10,32.0,0],["Lewiston",0,0,0],["Bangor",0,0,0],["South Portland",0,0,0],["Biddeford",0,0,0],["Sanford",0,0,0],["Augusta",0,0,0],["Brunswick",0,0,0],["Windham",0,0,0],["Waterville",0,0,0]]}],"Texas":[[["Houston",2350000],["San Antonio",1480000],["Dallas",1300000],["Austin",980000],["Fort Worth",960000],["El Paso",680000],["Arlington",400000],["Corpus Christi",320000],["Plano",290000],["Lubbock",260000],["Laredo",260000],["Irving",260000],["Garland",240000],["Frisco",225000],["McKinney",210000]],{"small_engine_repair":[["Houston",170,31.0,2.84],["San Antonio",140,8.0,0],["Dallas",90,26.0,0],["Austin",70,28.0,0],["Fort Worth",50,45.0,0],["Corpus Christi",50,31.0,0],["El Paso",40,31.0,0],["McKinney",30,31.0,0],["Arlington",10,31.0,0],["Plano",10,24.0,0],["Lubbock",10,55.0,0],["Laredo",10,31.0,0],["Garland",10,33.0,0],["Frisco",10,38.0,0],["Irving",0,0,0]],"lawn_mower_repair":[["Houston",210,28.0,1.31],["San Antonio",140,33.0,1.23],["Dallas",140,21.0,1.72],["Austin",90,23.0,2.6],["Fort Worth",90,18.0,1.07],["Arlington",30,33.0,0],["Lubbock",30,3.0,0],["El Paso",20,28.0,0],["Corpus Christi",20,28.0,0],["Plano",20,26.0,0],["Garland",20,26.0,0],["McKinney",20,33.0,0],["Laredo",10,28.0,0],["Frisco",10,22.0,0],["Irving",0,0,0]],"snow_blower_repair":[["Houston",10,27.0,0],["San Antonio",0,0,0],["Dallas",0,0,0],["Austin",0,0,0],["Fort Worth",0,0,0],["El Paso",0,0,0],["Arlington",0,0,0],["Corpus Christi",0,0,0],["Plano",0,0,0],["Lubbock",0,0,0],["Laredo",0,0,0],["Irving",0,0,0],["Garland",0,0,0],["Frisco",0,0,0],["McKinney",0,0,0]],"generator_repair":[["Houston",90,11.0,9.0],["San Antonio",40,29.0,14.29],["Dallas",20,9.0,8.54],["Austin",20,29.0,0],["Fort Worth",10,10.0,8.17],["El Paso",10,4.0,0],["Arlington",10,8.0,12.0],["Corpus Christi",10,10.0,0],["Plano",10,9.0,0],["Lubbock",10,3.0,0],["Laredo",10,29.0,0],["Garland",10,9.0,0],["Frisco",10,18.0,0],["McKinney",10,8.0,0],["Irving",0,0,0]],"motorcycle_repair":[["Houston",90,14.0,0],["Dallas",50,8.0,0],["San Antonio",40,15.0,0],["Austin",40,17.0,0],["Fort Worth",20,18.0,0],["El Paso",10,4.0,0],["Arlington",10,17.0,0],["Corpus Christi",10,36.0,0],["Plano",10,8.0,0],["Lubbock",10,46.0,0],["Laredo",10,30.0,0],["Garland",10,33.0,0],["Frisco",10,30.0,0],["McKinney",10,8.0,0],["Irving",0,0,0]]}],"Kentucky":[[["Louisville",620000],["Lexington",320000],["Bowling Green",75000],["Owensboro",60000],["Covington",41000],["Richmond",37000],["Georgetown",38000],["Florence",34000],["Nicholasville",32000],["Elizabethtown",31000],["Hopkinsville",30000],["Frankfort",28000],["Paducah",27000],["Independence",27000],["Henderson",27000]],{"small_engine_repair":[["Louisville",40,0.31,3.31],["Lexington",20,0.28,0],["Bowling Green",10,0.3,0],["Owensboro",10,0.31,0],["Covington",10,0.31,0],["Richmond",10,0.26,0],["Georgetown",10,0.31,0],["Florence",10,0.31,0],["Nicholasville",10,0.31,0],["Elizabethtown",10,0.24,0],["Hopkinsville",10,0.31,0],["Frankfort",10,0.31,0],["Paducah",10,0.31,0],["Independence",10,0.31,0],["Henderson",10,0.31,0]],"lawn_mower_repair":[["Louisville",70,0.28,1.62],["Lexington",30,0.08,0],["Bowling Green",30,0.22,0],["Owensboro",10,0.31,0],["Covington",10,0.31,0],["Richmond",10,0.24,0],["Georgetown",10,0.24,0],["Florence",10,0.23,0],["Nicholasville",10,0.24,0],["Elizabethtown",10,0.18,0],["Hopkinsville",10,0.31,0],["Frankfort",10,0.24,0],["Paducah",10,0.28,0],["Independence",10,0.23,0],["Henderson",10,0.24,0]],"snow_blower_repair":[["Bowling Green",10,0.28,0],["Owensboro",10,0.31,0],["Nicholasville",10,0.31,0],["Hopkinsville",10,0.35,0],["Frankfort",10,0.37,0],["Paducah",10,0.31,0],["Independence",10,0.31,0],["Henderson",10,0.3,0],["Louisville",0,0,0],["Lexington",0,0,0],["Covington",0,0,0],["Richmond",0,0,0],["Georgetown",0,0,0],["Florence",0,0,0],["Elizabethtown",0,0,0]],"generator_repair":[["Louisville",10,0.08,4.83],["Lexington",10,0.08,0],["Owensboro",10,0.32,0],["Covington",10,0.11,0],["Bowling Green",0,0,0],["Richmond",0,0,0],["Georgetown",0,0,0],["Florence",0,0,0],["Nicholasville",0,0,0],["Elizabethtown",0,0,0],["Hopkinsville",0,0,0],["Frankfort",0,0,0],["Paducah",0,0,0],["Independence",0,0,0],["Henderson",0,0,0]],"motorcycle_repair":[["Louisville",40,0.17,0],["Lexington",30,0.32,0],["Owensboro",10,0.46,0],["Covington",10,0.19,0],["Richmond",10,0.32,0],["Bowling Green",0,0,0],["Georgetown",0,0,0],["Florence",0,0,0],["Nicholasville",0,0,0],["Elizabethtown",0,0,0],["Hopkinsville",0,0,0],["Frankfort",0,0,0],["Paducah",0,0,0],["Independence",0,0,0],["Henderson",0,0,0]]}],"Oklahoma":[[["Oklahoma City",710000],["Tulsa",410000],["Norman",130000],["Broken Arrow",115000],["Edmond",97000],["Lawton",91000],["Moore",63000],["Midwest City",58000],["Stillwater",49000],["Enid",49000],["Muskogee",37000],["Bartlesville",37000],["Owasso",37000],["Shawnee",31000],["Yukon",30000],["Bixby",29000],["Ardmore",25000],["Ponca City",24000],["Jenks",23000],["Duncan",22000],["Mustang",21000],["Del City",21000],["Sapulpa",21000],["Altus",18000],["McAlester",18000],["Chickasha",17000],["Claremore",16000],["El Reno",16000],["Durant",16000],["Sand Springs",16000],["Bethany",15000],["Tahlequah",15000],["Ada",15000],["Pryor Creek",11000],["Miami",11000]],{"small_engine_repair":[["Oklahoma City",40,28.0,0],["Tulsa",20,2.0,0],["Norman",10,28.0,0],["Broken Arrow",10,30.0,0],["Edmond",10,28.0,0],["Lawton",10,31.0,0],["Moore",10,30.0,0],["Midwest City",10,35.0,0],["Stillwater",10,31.0,0],["Enid",10,30.0,0],["Muskogee",10,28.0,0],["Bartlesville",10,38.0,0],["Owasso",10,2.0,0],["Ardmore",10,31.0,0],["Ponca City",10,38.0,0],["Jenks",10,13.0,0],["Duncan",10,31.0,0],["Del City",10,28.0,0],["Sapulpa",10,26.0,0],["McAlester",10,31.0,0],["Chickasha",10,31.0,0],["Claremore",10,24.0,0],["El Reno",10,32.0,0],["Durant",10,31.0,0],["Sand Springs",10,24.0,0],["Bethany",10,28.0,0],["Ada",10,31.0,0],["Shawnee",0,0,0],["Yukon",0,0,0],["Bixby",0,0,0],["Mustang",0,0,0],["Altus",0,0,0],["Tahlequah",0,0,0],["Pryor Creek",0,0,0],["Miami",0,0,0]],"lawn_mower_repair":[["Oklahoma City",90,23.0,3.83],["Tulsa",90,7.0,1.36],["Broken Arrow",20,24.0,0],["Edmond",20,28.0,0],["Moore",20,24.0,0],["Norman",10,24.0,0],["Lawton",10,24.0,0],["Midwest City",10,7.0,0],["Stillwater",10,24.0,0],["Enid",10,23.0,0],["Bartlesville",10,23.0,0],["Owasso",10,18.0,0],["Bixby",10,22.0,0],["Ardmore",10,31.0,0],["Jenks",10,33.0,0],["Duncan",10,28.0,0],["Mustang",10,22.0,0],["Del City",10,22.0,0],["Sapulpa",10,10.0,0],["McAlester",10,28.0,0],["Claremore",10,24.0,0],["Durant",10,28.0,0],["Sand Springs",10,7.0,0],["Ada",10,28.0,0],["Miami",10,28.0,0],["Muskogee",0,0,0],["Shawnee",0,0,0],["Yukon",0,0,0],["Ponca City",0,0,0],["Altus",0,0,0],["Chickasha",0,0,0],["El Reno",0,0,0],["Bethany",0,0,0],["Tahlequah",0,0,0],["Pryor Creek",0,0,0]],"snow_blower_repair":[["Norman",10,34.0,0],["Broken Arrow",10,34.0,0],["Lawton",10,31.0,0],["Moore",10,31.0,0],["Midwest City",10,31.0,0],["Stillwater",10,0,0],["Enid",10,31.0,0],["Muskogee",10,31.0,0],["Bartlesville",10,31.0,0],["Bixby",10,34.0,0],["Ponca City",10,34.0,0],["Jenks",10,37.0,0],["Mustang",10,31.0,0],["Del City",10,31.0,0],["Sapulpa",10,31.0,0],["Altus",10,31.0,0],["McAlester",10,31.0,0],["Chickasha",10,31.0,0],["Claremore",10,37.0,0],["El Reno",10,27.0,0],["Durant",10,36.0,0],["Sand Springs",10,37.0,0],["Bethany",10,27.0,0],["Tahlequah",10,31.0,0],["Ada",10,31.0,0],["Miami",10,27.0,0],["Oklahoma City",0,0,0],["Tulsa",0,0,0],["Edmond",0,0,0],["Owasso",0,0,0],["Shawnee",0,0,0],["Yukon",0,0,0],["Ardmore",0,0,0],["Duncan",0,0,0],["Pryor Creek",0,0,0]],"generator_repair":[["Oklahoma City",10,10.0,25.82],["Tulsa",10,10.0,0],["Edmond",10,10.0,0],["Norman",0,0,0],["Broken Arrow",0,0,0],["Lawton",0,0,0],["Moore",0,0,0],["Midwest City",0,0,0],["Stillwater",0,0,0],["Enid",0,0,0],["Muskogee",0,0,0],["Bartlesville",0,0,0],["Owasso",0,0,0],["Shawnee",0,0,0],["Yukon",0,0,0],["Bixby",0,0,0],["Ardmore",0,0,0],["Ponca City",0,0,0],["Jenks",0,0,0],["Duncan",0,0,0],["Mustang",0,0,0],["Del City",0,0,0],["Sapulpa",0,0,0],["Altus",0,0,0],["McAlester",0,0,0],["Chickasha",0,0,0],["Claremore",0,0,0],["El Reno",0,0,0],["Durant",0,0,0],["Sand Springs",0,0,0],["Bethany",0,0,0],["Tahlequah",0,0,0],["Ada",0,0,0],["Pryor Creek",0,0,0],["Miami",0,0,0]],"motorcycle_repair":[["Oklahoma City",10,12.0,0],["Tulsa",10,46.0,0],["Broken Arrow",10,10.0,0],["Miami",10,30.0,0],["Norman",0,0,0],["Edmond",0,0,0],["Lawton",0,0,0],["Moore",0,0,0],["Midwest City",0,0,0],["Stillwater",0,0,0],["Enid",0,0,0],["Muskogee",0,0,0],["Bartlesville",0,0,0],["Owasso",0,0,0],["Shawnee",0,0,0],["Yukon",0,0,0],["Bixby",0,0,0],["Ardmore",0,0,0],["Ponca City",0,0,0],["Jenks",0,0,0],["Duncan",0,0,0],["Mustang",0,0,0],["Del City",0,0,0],["Sapulpa",0,0,0],["Altus",0,0,0],["McAlester",0,0,0],["Chickasha",0,0,0],["Claremore",0,0,0],["El Reno",0,0,0],["Durant",0,0,0],["Sand Springs",0,0,0],["Bethany",0,0,0],["Tahlequah",0,0,0],["Ada",0,0,0],["Pryor Creek",0,0,0]]}],"South Carolina":[[["Charleston",156000],["Columbia",137000],["North Charleston",118000],["Mount Pleasant",92000],["Rock Hill",77000],["Greenville",75000],["Summerville",52000],["Goose Creek",47000],["Sumter",43000],["Florence",39000],["Spartanburg",38000],["Myrtle Beach",37000],["Anderson",29000],["Aiken",22000]],{"small_engine_repair":[["Greenville",70,0.22,0],["Charleston",20,0.3,0.93],["Columbia",20,0.26,0],["North Charleston",20,0.28,1.36],["Spartanburg",20,0.45,0],["Myrtle Beach",20,0.28,0],["Anderson",20,0.32,0],["Aiken",20,0.3,0],["Mount Pleasant",10,0.3,0],["Rock Hill",10,0.28,0],["Summerville",10,0.31,0],["Goose Creek",10,0.28,0],["Sumter",10,0.17,0],["Florence",10,0.31,0]],"lawn_mower_repair":[["Greenville",40,0.28,2.02],["Columbia",30,0.33,2.05],["Charleston",20,0.33,0],["Summerville",20,0.22,0],["Anderson",20,0.33,1.01],["North Charleston",10,0.18,0],["Mount Pleasant",10,0.18,0],["Rock Hill",10,0.24,0],["Goose Creek",10,0.24,0],["Sumter",10,0.24,0],["Florence",10,0.28,0],["Spartanburg",10,0.15,0],["Myrtle Beach",10,0.24,0],["Aiken",10,0.24,0]],"snow_blower_repair":[["North Charleston",10,0.37,0],["Mount Pleasant",10,0.31,0],["Rock Hill",10,0.33,0],["Summerville",10,0.29,0],["Goose Creek",10,0.34,0],["Sumter",10,0.24,0],["Florence",10,0.31,0],["Spartanburg",10,0.39,0],["Aiken",10,0.31,0],["Charleston",0,0,0],["Columbia",0,0,0],["Greenville",0,0,0],["Myrtle Beach",0,0,0],["Anderson",0,0,0]],"generator_repair":[["Charleston",30,0.09,0],["Columbia",30,0.25,0],["North Charleston",10,0.07,0],["Mount Pleasant",0,0,0],["Rock Hill",0,0,0],["Greenville",0,0,0],["Summerville",0,0,0],["Goose Creek",0,0,0],["Sumter",0,0,0],["Florence",0,0,0],["Spartanburg",0,0,0],["Myrtle Beach",0,0,0],["Anderson",0,0,0],["Aiken",0,0,0]],"motorcycle_repair":[["Charleston",0,0,0],["Columbia",0,0,0],["North Charleston",0,0,0],["Mount Pleasant",0,0,0],["Rock Hill",0,0,0],["Greenville",0,0,0],["Summerville",0,0,0],["Goose Creek",0,0,0],["Sumter",0,0,0],["Florence",0,0,0],["Spartanburg",0,0,0],["Myrtle Beach",0,0,0],["Anderson",0,0,0],["Aiken",0,0,0]]}],"Michigan":[[["Detroit",630000],["Grand Rapids",200000],["Warren",138000],["Sterling Heights",135000],["Ann Arbor",122000],["Lansing",112000],["Dearborn",110000],["Livonia",95000],["Troy",87000],["Westland",85000],["Farmington Hills",84000],["Kalamazoo",74000],["Flint",72000],["Rochester Hills",76000],["Southfield",72000]],{"small_engine_repair":[["Detroit",50,17.0,0],["Grand Rapids",30,31.0,0],["Warren",10,33.0,0],["Sterling Heights",10,37.0,0],["Ann Arbor",10,30.0,0],["Lansing",10,31.0,0],["Dearborn",10,24.0,0],["Livonia",10,31.0,0],["Troy",10,28.0,0],["Westland",10,40.0,0],["Farmington Hills",10,31.0,0],["Kalamazoo",10,24.0,0],["Flint",10,31.0,0],["Rochester Hills",10,24.0,0],["Southfield",10,28.0,0]],"lawn_mower_repair":[["Detroit",110,24.0,2.74],["Grand Rapids",20,24.0,0],["Warren",20,24.0,1.89],["Sterling Heights",10,22.0,0.86],["Ann Arbor",10,12.0,0],["Lansing",10,28.0,0],["Dearborn",10,22.0,0],["Livonia",10,22.0,1.7],["Troy",10,22.0,0],["Westland",10,14.0,0],["Farmington Hills",10,18.0,0],["Kalamazoo",10,12.0,0],["Flint",10,9.0,0],["Rochester Hills",10,3.0,0],["Southfield",10,23.0,0.96]],"snow_blower_repair":[["Detroit",20,8.0,0],["Grand Rapids",10,17.0,0],["Warren",10,9.0,0],["Lansing",10,30.0,0],["Troy",10,9.0,0],["Flint",10,31.0,0],["Rochester Hills",10,3.0,0],["Southfield",10,3.0,0],["Sterling Heights",0,0,0],["Ann Arbor",0,0,0],["Dearborn",0,0,0],["Livonia",0,0,0],["Westland",0,0,0],["Farmington Hills",0,0,0],["Kalamazoo",0,0,0]],"generator_repair":[["Detroit",20,5.0,5.83],["Grand Rapids",10,7.0,0],["Warren",10,7.0,0],["Sterling Heights",10,10.0,0],["Ann Arbor",10,4.0,0],["Lansing",10,5.0,0],["Troy",10,11.0,0],["Kalamazoo",10,4.0,0],["Flint",10,4.0,0],["Rochester Hills",10,7.0,0],["Dearborn",0,0,0],["Livonia",0,0,0],["Westland",0,0,0],["Farmington Hills",0,0,0],["Southfield",0,0,0]],"motorcycle_repair":[["Detroit",40,30.0,0],["Grand Rapids",10,46.0,0],["Ann Arbor",10,18.0,0],["Livonia",10,18.0,0],["Kalamazoo",10,0,0],["Flint",10,22.0,0],["Warren",0,0,0],["Sterling Heights",0,0,0],["Lansing",0,0,0],["Dearborn",0,0,0],["Troy",0,0,0],["Westland",0,0,0],["Farmington Hills",0,0,0],["Rochester Hills",0,0,0],["Southfield",0,0,0]]}],"Missouri":[[["Kansas City",510000],["St. Louis",293000],["Springfield",170000],["Columbia",127000],["Independence",123000],["O\u2019Fallon",95000],["St. Joseph",72000],["St. Charles",71000],["Blue Springs",60000],["St. Louis",293000],["St. Peters",58000],["Florissant",52000],["Joplin",51000],["Chesterfield",49000],["Jefferson City",43000],["Kansas City",510000]],{"small_engine_repair":[["Kansas City",70,28.0,0],["St. Louis",40,31.0,0],["Springfield",20,30.0,0],["Independence",20,28.0,0],["St. Charles",20,31.0,0],["Columbia",10,28.0,0],["O\u2019Fallon",10,12.0,0],["Blue Springs",10,11.0,0],["St. Peters",10,26.0,0],["Florissant",10,28.0,0],["Joplin",10,31.0,0],["Chesterfield",10,26.0,0],["Jefferson City",10,30.0,0],["Kansas City",10,24.0,0],["St. Joseph",0,0,0],["St. Louis",0,0,0]],"lawn_mower_repair":[["Kansas City",90,28.0,1.1],["St. Louis",90,24.0,2.55],["St. Charles",40,9.0,0],["Springfield",30,24.0,1.9],["O\u2019Fallon",20,23.0,0],["St. Peters",20,23.0,0],["Joplin",20,28.0,0],["Columbia",10,24.0,0],["Independence",10,24.0,0],["Blue Springs",10,8.0,0],["Florissant",10,18.0,0],["Chesterfield",10,22.0,0],["Jefferson City",10,24.0,0],["Kansas City",10,28.0,0],["St. Joseph",0,0,0],["St. Louis",0,0,0]],"snow_blower_repair":[["Kansas City",10,10.0,0],["St. Louis",10,9.0,0],["Independence",10,23.0,0],["St. Charles",10,23.0,0],["Joplin",10,36.0,0],["Jefferson City",10,31.0,0],["Kansas City",10,17.0,0],["Springfield",0,0,0],["Columbia",0,0,0],["O\u2019Fallon",0,0,0],["St. Joseph",0,0,0],["Blue Springs",0,0,0],["St. Louis",0,0,0],["St. Peters",0,0,0],["Florissant",0,0,0],["Chesterfield",0,0,0]],"generator_repair":[["St. Louis",20,5.0,0],["Kansas City",10,9.0,0],["Springfield",10,8.0,0],["Independence",10,14.0,0],["St. Charles",10,14.0,0],["Columbia",0,0,0],["O\u2019Fallon",0,0,0],["St. Joseph",0,0,0],["Blue Springs",0,0,0],["St. Louis",0,0,0],["St. Peters",0,0,0],["Florissant",0,0,0],["Joplin",0,0,0],["Chesterfield",0,0,0],["Jefferson City",0,0,0],["Kansas City",0,0,0]],"motorcycle_repair":[["Columbia",10,30.0,0],["O\u2019Fallon",10,9.0,0],["St. Charles",10,10.0,0],["St. Peters",10,8.0,0],["Kansas City",0,0,0],["St. Louis",0,0,0],["Springfield",0,0,0],["Independence",0,14.0,0],["St. Joseph",0,0,0],["Blue Springs",0,0,0],["St. Louis",0,0,0],["Florissant",0,0,0],["Joplin",0,0,0],["Chesterfield",0,0,0],["Jefferson City",0,0,0],["Kansas City",0,0,0]]}],"Minnesota":[[["Minneapolis",430000],["St. Paul",310000],["Rochester",125000],["Bloomington",89000],["Duluth",86000],["Brooklyn Park",87000],["Plymouth",83000],["Woodbury",81000],["Maple Grove",80000],["St. Cloud",69000],["Eagan",68000],["Eden Prairie",67000],["Burnsville",63000],["Coon Rapids",63000],["Blaine",70000]],{"small_engine_repair":[["Minneapolis",110,9.0,1.15],["Rochester",10,3.0,0],["Bloomington",10,38.0,0],["Duluth",10,31.0,0],["Brooklyn Park",10,25.0,0],["Plymouth",10,29.0,0],["Woodbury",10,14.0,0],["Maple Grove",10,28.0,0],["St. Cloud",10,31.0,0],["Eagan",10,4.0,0],["Eden Prairie",10,18.0,0],["Burnsville",10,38.0,0],["Coon Rapids",10,38.0,0],["Blaine",10,14.0,0],["St. Paul",0,0,0]],"lawn_mower_repair":[["Minneapolis",50,13.0,1.16],["Rochester",10,3.0,0],["Bloomington",10,16.0,0],["Duluth",10,23.0,0],["Brooklyn Park",10,16.0,0],["Plymouth",10,22.0,1.33],["Woodbury",10,15.0,0],["Maple Grove",10,23.0,0],["Burnsville",10,4.0,0],["Coon Rapids",10,18.0,0],["Blaine",10,16.0,0],["St. Paul",0,0,0],["St. Cloud",0,0,0],["Eagan",0,0,0],["Eden Prairie",0,0,0]],"snow_blower_repair":[["Minneapolis",30,3.0,0],["Rochester",10,27.0,0],["Bloomington",10,12.0,0],["Duluth",10,13.0,0],["Brooklyn Park",10,3.0,0],["Plymouth",10,10.0,0],["Woodbury",10,14.0,0],["Maple Grove",10,9.0,0],["Eagan",10,4.0,0],["Eden Prairie",10,0,0],["Burnsville",10,3.0,0],["Coon Rapids",10,0,0],["Blaine",10,13.0,0],["St. Paul",0,0,0],["St. Cloud",0,0,0]],"generator_repair":[["Minneapolis",10,8.0,9.09],["St. Paul",0,0,0],["Rochester",0,0,0],["Bloomington",0,0,0],["Duluth",0,0,0],["Brooklyn Park",0,0,0],["Plymouth",0,0,0],["Woodbury",0,0,0],["Maple Grove",0,0,0],["St. Cloud",0,0,0],["Eagan",0,0,0],["Eden Prairie",0,0,0],["Burnsville",0,0,0],["Coon Rapids",0,0,0],["Blaine",0,0,0]],"motorcycle_repair":[["Minneapolis",20,11.0,0],["Eden Prairie",10,32.0,0],["St. Paul",0,0,0],["Rochester",0,0,0],["Bloomington",0,0,0],["Duluth",0,0,0],["Brooklyn Park",0,0,0],["Plymouth",0,0,0],["Woodbury",0,0,0],["Maple Grove",0,0,0],["St. Cloud",0,0,0],["Eagan",0,0,0],["Burnsville",0,0,0],["Coon Rapids",0,0,0],["Blaine",0,0,0]]}],"Tennessee":[[["Nashville",689000],["Memphis",628000],["Chattanooga",184000],["Clarksville",166000],["Murfreesboro",157000],["Franklin",88000],["Jackson",68000],["Johnson City",71000],["Bartlett",57000],["Hendersonville",61000],["Kingsport",56000],["Smyrna",56000],["Collierville",52000],["Cleveland",47000]],{"small_engine_repair":[["Memphis",70,28.0,2.71],["Nashville",50,28.0,3.19],["Chattanooga",20,28.0,0],["Clarksville",20,30.0,0],["Murfreesboro",20,28.0,0],["Franklin",10,31.0,0],["Jackson",10,28.0,0],["Johnson City",10,27.0,0],["Bartlett",10,15.0,0],["Hendersonville",10,18.0,0],["Smyrna",10,24.0,0],["Collierville",10,28.0,0],["Cleveland",10,31.0,0],["Kingsport",0,0,0]],"lawn_mower_repair":[["Nashville",50,18.0,2.04],["Memphis",40,18.0,1.89],["Chattanooga",30,24.0,0],["Clarksville",20,22.0,0],["Murfreesboro",10,28.0,0],["Franklin",10,22.0,0],["Jackson",10,28.0,0],["Johnson City",10,23.0,0],["Bartlett",10,31.0,0],["Hendersonville",10,18.0,0],["Smyrna",10,24.0,0],["Collierville",10,22.0,0],["Cleveland",10,28.0,0],["Kingsport",0,0,0]],"snow_blower_repair":[["Chattanooga",10,13.0,0],["Clarksville",10,12.0,0],["Murfreesboro",10,15.0,0],["Hendersonville",10,8.0,0],["Nashville",0,0,0],["Memphis",0,0,0],["Franklin",0,0,0],["Jackson",0,0,0],["Johnson City",0,0,0],["Bartlett",0,0,0],["Kingsport",0,0,0],["Smyrna",0,0,0],["Collierville",0,0,0],["Cleveland",0,0,0]],"generator_repair":[["Nashville",20,8.0,0],["Memphis",10,13.0,0],["Chattanooga",0,0,0],["Clarksville",0,0,0],["Murfreesboro",0,0,0],["Franklin",0,0,0],["Jackson",0,0,0],["Johnson City",0,0,0],["Bartlett",0,0,0],["Hendersonville",0,0,0],["Kingsport",0,0,0],["Smyrna",0,0,0],["Collierville",0,0,0],["Cleveland",0,0,0]],"motorcycle_repair":[["Nashville",70,46.0,0],["Memphis",50,46.0,0],["Chattanooga",10,34.0,0],["Clarksville",10,28.0,0],["Murfreesboro",10,46.0,0],["Franklin",10,14.0,0],["Jackson",10,30.0,0],["Bartlett",10,43.0,0],["Smyrna",10,46.0,0],["Collierville",10,26.0,0],["Johnson City",0,0,0],["Hendersonville",0,0,0],["Kingsport",0,0,0],["Cleveland",0,0,0]]}],"North Carolina":[[["Charlotte",880000],["Raleigh",470000],["Greensboro",300000],["Durham",285000],["Winston-Salem",250000],["Fayetteville",210000],["Cary",180000],["Wilmington",120000],["High Point",115000],["Concord",105000],["Asheville",95000],["Greenville",90000],["Gastonia",80000],["Jacksonville",72000],["Huntersville",65000],["Chapel Hill",62000],["Apex",70000],["Burlington",57000],["Rocky Mount",54000],["Kannapolis",53000],["Wilson",50000],["Hickory",43000],["Mooresville",40000],["Monroe",39000],["Salisbury",35000],["Goldsboro",34000]],{"small_engine_repair":[["Charlotte",90,38.0,1.83],["Raleigh",50,38.0,1.54],["Greensboro",20,28.0,0],["Winston-Salem",20,23.0,0],["Fayetteville",20,31.0,1.98],["Asheville",20,31.0,0],["Durham",10,24.0,0],["Cary",10,24.0,0],["Wilmington",10,34.0,0],["High Point",10,24.0,0],["Concord",10,38.0,0],["Greenville",10,26.0,0],["Gastonia",10,31.0,0],["Jacksonville",10,38.0,0],["Huntersville",10,24.0,0],["Chapel Hill",10,22.0,0],["Apex",10,23.0,0],["Burlington",10,28.0,0],["Rocky Mount",10,28.0,0],["Kannapolis",10,23.0,0],["Wilson",10,21.0,0],["Hickory",10,28.0,0],["Mooresville",10,28.0,0],["Monroe",10,34.0,0],["Salisbury",10,25.0,0],["Goldsboro",10,31.0,0]],"lawn_mower_repair":[["Charlotte",110,20.0,1.17],["Raleigh",50,18.0,1.62],["Greensboro",30,33.0,1.49],["Durham",20,23.0,1.22],["Winston-Salem",20,23.0,0],["Fayetteville",20,24.0,0],["High Point",20,18.0,0],["Cary",10,18.0,1.26],["Wilmington",10,22.0,1.58],["Concord",10,24.0,0],["Asheville",10,23.0,0],["Greenville",10,22.0,0],["Gastonia",10,23.0,0],["Jacksonville",10,28.0,0],["Huntersville",10,14.0,0],["Chapel Hill",10,22.0,0],["Apex",10,22.0,1.53],["Burlington",10,28.0,0],["Rocky Mount",10,18.0,0],["Kannapolis",10,20.0,0],["Wilson",10,22.0,0],["Hickory",10,18.0,0],["Mooresville",10,27.0,0],["Monroe",10,22.0,0],["Salisbury",10,24.0,0],["Goldsboro",10,24.0,0]],"snow_blower_repair":[["High Point",10,31.0,0],["Concord",10,31.0,0],["Greenville",10,31.0,0],["Gastonia",10,31.0,0],["Jacksonville",10,31.0,0],["Huntersville",10,33.0,0],["Chapel Hill",10,33.0,0],["Apex",10,31.0,0],["Burlington",10,23.0,0],["Rocky Mount",10,35.0,0],["Kannapolis",10,31.0,0],["Wilson",10,34.0,0],["Mooresville",10,37.0,0],["Monroe",10,31.0,0],["Salisbury",10,31.0,0],["Charlotte",0,0,0],["Raleigh",0,0,0],["Greensboro",0,0,0],["Durham",0,0,0],["Winston-Salem",0,0,0],["Fayetteville",0,0,0],["Cary",0,0,0],["Wilmington",0,0,0],["Asheville",0,0,0],["Hickory",0,0,0],["Goldsboro",0,0,0]],"generator_repair":[["Wilmington",30,6.0,0],["Charlotte",20,8.0,0],["Raleigh",10,7.0,6.59],["Greensboro",10,11.0,0],["Durham",10,25.0,0],["Winston-Salem",10,8.0,0],["Fayetteville",10,13.0,0],["High Point",10,10.0,0],["Concord",10,9.0,0],["Asheville",10,8.0,0],["Greenville",10,8.0,0],["Gastonia",10,10.0,0],["Jacksonville",10,5.0,0],["Huntersville",10,0,0],["Chapel Hill",10,0,0],["Hickory",10,13.0,0],["Mooresville",10,8.0,0],["Salisbury",10,11.0,0],["Cary",0,0,0],["Apex",0,0,0],["Burlington",0,0,0],["Rocky Mount",0,0,0],["Kannapolis",0,0,0],["Wilson",0,0,0],["Monroe",0,0,0],["Goldsboro",0,0,0]],"motorcycle_repair":[["Charlotte",20,28.0,0],["Raleigh",20,24.0,0],["Greensboro",10,26.0,0],["Durham",10,5.0,0],["Winston-Salem",10,35.0,0],["Fayetteville",10,30.0,0],["Cary",10,26.0,0],["Wilmington",10,34.0,0],["High Point",10,26.0,0],["Concord",10,28.0,0],["Asheville",10,46.0,0],["Apex",10,13.0,0],["Mooresville",10,16.0,0],["Greenville",0,0,0],["Gastonia",0,8.0,0],["Jacksonville",0,0,0],["Huntersville",0,0,0],["Chapel Hill",0,0,0],["Burlington",0,0,0],["Rocky Mount",0,0,0],["Kannapolis",0,0,0],["Wilson",0,0,0],["Hickory",0,0,0],["Monroe",0,0,0],["Salisbury",0,0,0],["Goldsboro",0,0,0]]}]};

// SEO helper functions
var SEO_CONTENT_DATA = {"gbpPosts":{"Sioux Falls, SD":{"coords":"43.51336720, -96.75184570","gbpLink":"https://www.google.com/search?q=Mobile+Wildwood+Mower+Repair+/+Snow+Blower&stick=H4sIAAAAAAAA_-NgU1I1qLAwt0hNtrQwN7JITLRMSjG0MqgwTktOSUw1sTQxNzRONk01W8Sq5ZuflJmTqhCemZNSnp-fouCbX55apBCUWpCYWaSgrxCcl1-","posts":[{"week":"1st Week","title":"Keep Your Small Engine Running Strong in Sioux Falls!","body":"Engines perform better when tuned before the cold sets in. Our team checks spark plugs, filters, and fuel lines to keep your mower, generator, or blower in top shape. We\u2019re mobile and serve all of Sio","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Winter Tune-Up Discount \u2013Book Before the First Snow!","body":"Winter is on the way, and now is the perfect time to prepare your equipment. Schedule your small engine tune-up in Sioux Falls this week and enjoy 10% off before the first snow hits. Our mobile small ","cta":"Book Now","status":"Published"},{"week":"3rd Week","title":"3 Signs Your Engine Needs a Tune-Up","body":"If you own a mower, snow blower, or other small engine equipment, recognizing early signs of engine trouble can save you time and money. Here are three key indicators that it\u2019s time to call for a tune","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Winter Tune Up Before the Next Snow Book Now","body":"Snow is already falling in Sioux Falls and your snowblower must be ready. A winter tune up helps your machine start easier and run smoothly during cold days. Keep your equipment ready for the next sno","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Snowblower Not Starting Call Now","body":"Cold weather can make your snowblower hard to start. It may be due to stale fuel or a clogged carburetor. Our team can quickly check the issue and get your machine running strong again for winter use.","cta":"Call Now","status":"Published"},{"week":"4th Week","title":"Save Money With Our Tune Up Plans View Plans","body":"Our tune up plans help you save money all year. We offer plans for all equipment from 0 to 26 plus horsepower. You get inspection oil change filter service and priority scheduling with every plan.","cta":"View Plans","status":"Published"},{"week":"1st Week","title":"Start January With a Fresh Tune Up Book Now","body":"January brings heavy snow to Sioux Falls. A fresh tune up keeps your snowblower strong and reduces starting issues. Stay ready for winter weather with a simple and affordable service.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Keep Your Generator Ready Call for Service","body":"Winter storms can cause power outages. Make sure your generator is working safely and giving full power when you need it. Our technicians check and service generators for smooth performance.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune Up Plans Starting at 10.83 Explore Plans","body":"Our monthly tune up plans make it easy to care for your equipment. Plans include inspection oil and filter changes and priority scheduling. Choose the plan that matches your machine and enjoy member p","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Prepare Your Lawn Mower Early Book Early","body":"January is a good time to prepare your lawn mower for spring. Early maintenance helps avoid long waiting times when the snow melts. Get your blades sharpened and engine checked before the rush.","cta":"Book Early","status":"Published"}]},"Lees Summit, MO":{"coords":"","gbpLink":"https://www.google.com/search?q=Quick+and+Mobile+Wildwood+Small+Engine+Repair&stick=H4sIAAAAAAAA_-NgU1I1qLAwTzY0MjSzMDE0M0xOTDW2MqgwMTdOS7Q0MzVOMzFKTrW0WMSqG1iamZytkJiXouCbn5SZk6oQnpmTUp6fn6IQnJuYk6Pg","posts":[{"week":"1st Week","title":"Tired of Hard-Starting Engines? Here\u2019s Your Local Fix in Lee\u2019s Summit!","body":"Struggling with engines that won\u2019t start? Our mobile team offers small engine repair for mowers, blowers, and generators fast, reliable, and right here in Lee\u2019s Summit.Tip: Regular tune-ups before win","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Fall Tune-Up Deal: Save Before Winter Hits Lee\u2019s Summit!","body":"Avoid cold-season breakdowns! Prepare your equipment for the season with our small engine repair Lee\u2019s Summit service. Our mobile techs come straight to you.","cta":"Book Now","status":"Published"},{"week":"3rd Week","title":"3 Easy Fixes for Engines That Won\u2019t Start (Tip #2 Saves Time!)","body":"If your lawn mower or small engine refuses to start, a few simple checks can often solve the problem. At Quick and Mobile Wildwood Small Engine Repair, we see these issues daily, and most are caused b","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Snowblower Hard to Start Call Now","body":"Freezing temperatures can make snowblowers hard to start and unreliable. If yours is struggling, bring it in for a quick check before more snow arrives.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Tune-Up Plans for Snow and Cold View Plans","body":"Cold weather puts extra strain on equipment. Our tune-up plans help keep snowblowers, generators, and machines running well all winter long.","cta":"View Plans","status":"Published"},{"week":"4th Week","title":"Last Minute Tune-Up Savings Book Now","body":"Snow and cold may still be ahead. Book your winter tune\u2011up now and enjoy priority service, reduced repair costs, and peace of mind.","cta":"Book Now","status":"Published"},{"week":"1st Week","title":"Start the Year With a Snowblower Tune-Up Book Now","body":"January is still cold with possible snowstorms. Get your snowblower tuned now to avoid breakdowns during winter events.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Keep Your Generator Ready for Cold Call for Service","body":"Cold weather and winter storms can cause outages. Make sure your generator runs smoothly when you need it most.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune-Up Plans Starting at 10.83 Explore Plans","body":"Keep your equipment protected year\u2011round with a monthly tune\u2011up plan. Includes inspections, oil changes, and priority scheduling.","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Prepare Lawn Mower Early for Spring Book Early","body":"Winter isn\u2019t over, but spring is coming. Schedule early lawn mower maintenance now so you\u2019re ready as soon as snow melts.","cta":"Book Early","status":"Published"}]},"Reno, Nevada":{"coords":"39.4861766, -119.79543750","gbpLink":"https://www.google.com/search?q=Mobile+Wildwood+Mower+Repair+/+Snow+Blower&stick=H4sIAAAAAAAA_-NgU1I1qLAwsLQ0MTQxSrU0sjBMNjW3MqgwMjC3NExLNjUzNzVINUwyWMSq5ZuflJmTqhCemZNSnp-fouCbX55apBCUWpCYWaSgrxCcl1-","posts":[{"week":"1st Week","title":"Engine Repair Service You Can Rely On In Reno Nevada","body":"Having trouble starting your mower or snow blower? Our team provides reliable small engine repair in Reno, Nevada, right at your home or business. We come to you with professional tools, quick service","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Get Your Equipment Ready Before The Cold Arrives","body":"Prepare for the winter season with a professional small engine tune-up and repair. Our mobile small engine repair service in Reno NV keeps your lawn mower, snow blower, and outdoor equipment running s","cta":"Book Now","status":"Published"},{"week":"3rd Week","title":"Common Signs Your Engine Needs Professional Attention","body":"If your lawn mower, snow blower, or other small engine is acting up, it\u2019s usually a sign that it needs some professional attention. Engines can be tricky, and small problems often get worse if ignored","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Snowblower Not Starting? Call Now","body":"Winter can be tough on your snowblower. If it's hard to start, bring it in for a quick check\u2011up before the next cold snap.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Keep Your Generator Ready for Winter Call for Service","body":"Winter storms in Reno can cause power outages. Get your generator serviced now to ensure it\u2019s ready for emergencies.","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for All Your Equipment View Plans","body":"We offer affordable tune\u2011up plans for your snowblower, generator, and lawn mower. Keep your equipment running smoothly year\u2011round with priority scheduling and discounts.","cta":"View Plans","status":"Published"},{"week":"1st Week","title":"Start the Year with a Snowblower Tune-Up Book Now","body":"Even though snowstorms are rare, Reno\u2019s winter can still bring snow. Make sure your snowblower is ready for any snow that might come.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Keep Your Generator Running for Winter Call for Service","body":"Power outages can happen in Reno during winter storms. Ensure your generator is ready by having it serviced now.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune-Up Plans Starting at 10.83 Explore Plans","body":"Make sure your equipment is ready for any season with our affordable monthly tune\u2011up plans. Includes inspections, oil changes, and priority scheduling.","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Early Lawn Mower Prep \u2014 Get Ready for Spring Book Early","body":"Spring is coming early in Reno! Start prepping your lawn mower now with a quick tune\u2011up to ensure it\u2019s ready when the grass grows.","cta":"Book Early","status":"Published"}]},"Sarasota, FL":{"coords":"27.54461500, -82.45130850","gbpLink":"https://www.google.com/search?q=Mobile+Wildwood+Mower+Repair+/+Generator+SRQ&stick=H4sIAAAAAAAA_-NgU1I1qLCwNDQ0NjVOM7ZITDVPTjW2MqgwNUg1MTY0MEwzMDAxTklMWcSq45uflJmTqhCemZNSnp-fouCbX55apBCUWpCYWaSgr-Cem","posts":[{"week":"1st Week","title":"Engine Repair You Can Trust In Sarasota Florida","body":"When your lawn mower, snow blower, or generator won\u2019t start, count on our reliable small engine repair in Sarasota, FL for fast, affordable, and mobile service. We come to your home or business to ins","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Tune Up Your Equipment Before Winter Arrives","body":"Don\u2019t wait until the cold season causes downtime. Prepare early with our mobile lawn mower repair and small engine tune-up service in Sarasota. Our experienced technicians come directly to your locati","cta":"Book Now","status":"Published"},{"week":"3rd Week","title":"Signs Your Small Engine Needs Attention Sooner Than Later","body":"If your mower, generator, or snow blower isn\u2019t running like it used to, it might need attention sooner than later. Hard starting, stalling, unusual noises, smoke, or overheating are all signs that som","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Lawn Mower Running Rough? Call Now","body":"In Sarasota, lawn mowers work year-round and regular use can cause wear over time. If your mower is running rough or losing power, now is a good time to get it checked before peak mowing season.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Keep Your Generator Ready for Winter Call for Service","body":"Winter storms can cause power outages, so it\u2019s essential to have your generator ready. Don\u2019t wait until the power goes out\u2014call today for a quick check-up!","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for Your Equipment View Plans","body":"Start the new year with a tune-up plan for your equipment! From lawn mowers to generators, our plans include regular maintenance and priority service to keep your equipment in top condition all year.","cta":"View Plans","status":"Published"},{"week":"1st Week","title":"Start the New Year with a Lawn Mower Tune-Up Book Now","body":"Now\u2019s the time to get your lawn mower ready for the spring season. Book your tune-up today and enjoy a hassle-free spring with a mower that\u2019s in top condition.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Get Your Generator Serviced for Winter Call for Service","body":"Don\u2019t wait for a power outage to test your generator. Ensure it\u2019s in working condition with a quick service check-up. We\u2019ll make sure you\u2019re ready for any winter storm.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune-Up Plans Starting at 10.83 Explore Plans","body":"Our affordable monthly tune-up plans keep your equipment in top shape year-round. Whether it\u2019s your lawn mower, generator, or other outdoor equipment, we\u2019ve got you covered!","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Early Lawn Mower Prep for Spring Book Early","body":"Spring is just around the corner. Start preparing your lawn mower now to avoid long wait times later. Schedule your tune-up today and be ready for the season ahead!","cta":"Book Early","status":"Published"}]},"Crawfordsville, IN":{"coords":"","gbpLink":"https://www.google.com/search?q=Mobile+Wildwood+Mower+Repair+/+Generator+CRF&stick=H4sIAAAAAAAA_-NgU1I1qDAyMzA2MjM1M7Q0MzQwN7a0MqiwNLCwMDIzTzGwsDRMNTNPW8Sq45uflJmTqhCemZNSnp-fouCbX55apBCUWpCYWaSgr-Cem","posts":[{"week":"1st Week","title":"Reliable Small Engine Repair in Crawfordsville IN","body":"When your lawn mower, snow blower, or generator refuses to start, trust our expert small engine repair in Crawfordsville, IN for fast, affordable, and on-site service. We inspect, clean, tune, and rep","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Get Your Mower Ready Before Winter","body":"Don\u2019t wait until cold weather hits  prepare your equipment early with a professional lawn mower repair and tune-up in Crawfordsville. Our expert technicians inspect spark plugs, blades, filters, fuel ","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Snowblower Not Starting Call Now","body":"Cold temperatures may cause your snowblower to malfunction. Get it serviced before the next snowfall to avoid a breakdown.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Generator Maintenance for Winter Call for Service","body":"Power outages can happen during winter storms. Make sure your generator is ready by having it checked today.","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for Your Equipment View Plans","body":"Keep your snowblower, generator, and lawn equipment running smoothly with a yearly tune-up plan. Enjoy priority scheduling and discounted repairs.","cta":"View Plans","status":"Published"},{"week":"1st Week","title":"Get Your Snowblower Ready Book Now","body":"Winter storms can still hit Crawfordsville, and your snowblower needs to be ready. Book a tune-up before the snow arrives!","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Snowblower Not Starting Call Now","body":"Cold temperatures may cause your snowblower to malfunction. Get it serviced before the next snowfall to avoid a breakdown.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Generator Maintenance for Winter Call for Service","body":"Power outages can happen during winter storms. Make sure your generator is ready by having it checked today.","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for Your Equipment View Plans","body":"Keep your snowblower, generator, and lawn equipment running smoothly with a yearly tune-up plan. Enjoy priority scheduling and discounted repairs.","cta":"View Plans","status":"Published"}]},"Lapeer, MI":{"coords":"","gbpLink":"https://www.google.com/search?q=Mobile+Wildwood+Repair+Services:+Mowers,+Generators,+%26+Snow+Blowers&stick=H4sIAAAAAAAA_-NgU1IxqDAzN7MwsTBOSjY1tTBNM7YyqLAwSk5KTbIwsEi2MLe0MDFYxOrsm5-UmZOqEJ6Zk1Ken5-i","posts":[{"week":"1st Week","title":"Trusted Small Engine Repair in Lapeer MI","body":"Don\u2019t let a faulty mower, snow blower, or generator slow you down! Our expert team at Mobile Wildwood provides professional small engine repair in Lapeer MI, right at your location. From seasonal tune","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Get Ready for the Cold With Expert Mower Repair","body":"Before storage season starts, schedule your mower repair in Lapeer MI to clean blades, replace filters, and tune up engines. Regular maintenance ensures your mower runs strong next spring.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Snow Blower Not Starting Call Now","body":"Heavy snow in Lapeer puts extra stress on snow blowers. If your machine is not starting or not clearing snow properly, now is the time to get it serviced.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune-Up Plans Starting at 10.83 Explore Plans","body":"Keep your equipment running smoothly with our monthly tune-up plans. From snow blowers to lawn mowers, enjoy priority service and discounts all year long.","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Early Lawn Mower Prep \u2014 Book Now","body":"It may be winter, but now is the best time to get your lawn mower ready for spring. Book your early tune-up now and avoid the spring rush!","cta":"Book Now","status":"Published"},{"week":"1st Week","title":"Start the Year with a Snowblower Tune-Up Book Now","body":"January brings even more snow. Get your snowblower ready with a quick tune-up so it\u2019s ready to handle the winter storms.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Generator Maintenance for Winter Call for Service","body":"Winter storms can cause power outages. Make sure your generator is working when you need it most. Call for a service check-up today.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune-Up Plans Starting at 10.83 Explore Plans","body":"Keep your equipment running smoothly with our monthly tune-up plans. From snow blowers to lawn mowers, enjoy priority service and discounts all year long.","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Early Lawn Mower Prep \u2014 Book Now","body":"It may be winter, but now is the best time to get your lawn mower ready for spring. Book your early tune-up now and avoid the spring rush!","cta":"Book Now","status":"Published"}]},"Sioux Falls, SD 2":{"coords":"43.5623, -96.7355","gbpLink":"https://www.google.com/search?q=Quick+and+Mobile+Wildwood+Small+Engine+Repair&stick=H4sIAAAAAAAA_-NgU1I1qDAxSTVLsjA1TEsxNEpLTja2MqhITDE0SDFKSkwxS04zM7VMWcSqG1iamZytkJiXouCbn5SZk6oQnpmTUp6fn6IQnJuYk6Pg","posts":[{"week":"1st Week","title":"Mobile Lawn Mower Repair in Sioux Falls \u2014 Get Ready Before Storage Season!","body":"As the mowing season winds down in Sioux Falls, now\u2019s the time to get your lawn mower serviced before storing it for the winter. Our mobile mower repair team comes to you  handling tune-ups, blade sha","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Snowblower Not Starting Call Now","body":"Cold weather can cause snowblowers to struggle. If your snowblower isn\u2019t starting, bring it in for a quick check-up before the snow hits.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Keep Your Generator Ready for Winter Call for Service","body":"Winter storms can cause power outages in Sioux Falls. Make sure your generator is ready for emergencies by having it serviced now.","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for Snowblower & Generator View Plans","body":"Our tune-up plans help keep your snowblower, generator, and other equipment in top condition all year long. Book today for priority service and discounts on repairs.","cta":"View Plans","status":"Published"},{"week":"1st Week","title":"Get Your Snowblower Ready for Winter Book Now","body":"Snowstorms can arrive anytime in Sioux Falls. Get your snowblower ready with a tune-up before the snow falls. Book your appointment today!","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Snowblower Not Starting Call Now","body":"Cold weather can cause snowblowers to struggle. If your snowblower isn\u2019t starting, bring it in for a quick check-up before the snow hits.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Keep Your Generator Ready for Winter Call for Service","body":"Winter storms can cause power outages in Sioux Falls. Make sure your generator is ready for emergencies by having it serviced now.","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for Snowblower & Generator View Plans","body":"Our tune-up plans help keep your snowblower, generator, and other equipment in top condition all year long. Book today for priority service and discounts on repairs.","cta":"View Plans","status":"Published"}]},"Cape Coral, Fl":{"coords":"","gbpLink":"https://www.google.com/search?q=Wildwood+Mobile+Small+Engine+Repair+Fl&stick=H4sIAAAAAAAA_-NgU1I1qEi0MLEwtUyxTDYwTDNOS7W0MqgwN7UwTzW1NEozMUszTTMwWMSqFp6Zk1Ken5-i4JuflJmTqhCcm5iTo-Cal56Zl6oQlFqQmFmk4JY","posts":[{"week":"1st Week","title":"Engine Trouble? Cape Coral\u2019s Trusted Mobile Repair Is Just a Call Away!","body":"Having issues starting your mower or generator? Our expert team provides fast, reliable small engine repair in Cape Coral, FL \u2014 right at your doorstep. We bring tools, parts, and years of experience s","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Keep Your Tools Ready: Book a Tune-Up & Save Time This Month!","body":"Don\u2019t wait until your mower or power tools stop working. Schedule a professional small engine repair and tune-up in Cape Coral today. Our mobile repair technicians come directly to your home or job si","cta":"Book Now","status":"Published"},{"week":"3rd Week","title":"Top 3 Signs Your Small Engine Needs a Tune-Up (Before It\u2019s Too Late!)","body":"If you own a lawn mower, trimmer, generator, or snow blower, ignoring tune-up warning signs can lead to costly repairs. At Wildwood Mobile Small Engine Repair, we arrive at your location and perform f","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Lawn Mower Not Starting? Call Now","body":"Cold weather can make your lawn mower hard to start. If it\u2019s giving you trouble, bring it in for a quick check-up before spring.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Keep Your Generator Ready for Winter Call for Service","body":"Winter storms can still affect Cape Coral. Make sure your generator is ready for any power outages with a quick service check-up.","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for Your Equipment View Plans","body":"Get your lawn mower, generator, and other equipment ready with our yearly tune-up plans. Regular maintenance keeps your equipment running smoothly all year.","cta":"View Plans","status":"Published"},{"week":"1st Week","title":"Start the Year with a Lawn Mower Tune-Up Book Now","body":"Start the year right by making sure your lawn mower is ready for spring. Book a tune-up to ensure your mower is in top condition when the season starts.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Get Your Generator Ready for Winter Call for Service","body":"Although we don\u2019t get much snow, winter power outages can happen in Florida. Ensure your generator is ready by having it serviced now.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune-Up Plans Starting at 10.83 Explore Plans","body":"Keep your equipment in top shape year-round with our affordable monthly tune-up plans. From lawn mowers to generators, we\u2019ve got you covered.","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Early Lawn Mower Prep \u2014 Get Ready for Spring Book Early","body":"Spring is right around the corner! Get your lawn mower ready now and avoid the spring rush. Schedule your tune-up today!","cta":"Book Early","status":"Published"}]},"Tallahassee, FL":{"coords":"","gbpLink":"https://www.google.com/search?q=ONLY+Mobile+Wildwood+Mower+Repair+/+Generator&stick=H4sIAAAAAAAA_-NgU1I1qLCwSE1OMzRLTrM0sDRNMU-yMqgwNElMSjIwMrMwMDU0NzA3WsSq6-_nE6ngm5-UmZOqEJ6Zk1Ken58C5JenFikEpRYkZhYp","posts":[{"week":"1st Week","title":"Mobile Lawn Mower Repair\u202fTallahassee \u2013 Get Your Mower Ready to Go","body":"Getting your lawn ready for action? Our mobile mower repair team in Tallahassee has got you covered! From tune-ups and blade sharpening to engine diagnostics and full repairs we bring the service righ","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Lawn Mower Not Starting? Call Now","body":"If your lawn mower isn\u2019t starting or is giving you trouble, now is the time for a check-up before the busy spring season.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Keep Your Generator Ready for Winter Call for Service","body":"Winter power outages can still happen in Tallahassee. Keep your generator in top shape with a service check-up today.","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for Your Equipment View Plans","body":"Keep your lawn mower, generator, and other equipment running smoothly with our yearly tune-up plans. Get priority service and discounts on repairs.","cta":"View Plans","status":"Published"},{"week":"1st Week","title":"Start the Year with a Lawn Mower Tune-Up Book Now","body":"Get your lawn mower ready for the spring season with a tune-up! Ensure it runs smoothly and efficiently by booking your appointment today.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Get Your Generator Ready for Winter Call for Service","body":"Power outages can happen even in mild winters. Make sure your generator is ready for any situation with a service check-up now.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune-Up Plans Starting at 10.83 Explore Plans","body":"Keep your equipment in excellent shape all year long with our monthly tune-up plans. Priority scheduling, discounts on repairs, and more!","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Early Lawn Mower Prep \u2014 Book Now","body":"Spring is just around the corner. Get ahead of the rush and schedule your lawn mower tune-up now for a smoother start to the season.","cta":"Book Now","status":"Published"}]},"Brownsville, TX":{"coords":"","gbpLink":"https://www.google.com/search?q=Wildwood+Small+Engine+Repair&stick=H4sIAAAAAAAA_-NgU1IxqDC1MEk1TrI0MEs0MDIyNLYyqEi0sEhMNTA1MTe3MDBKskxbxCoTnpmTUp6fn6IQnJuYk6PgmpeemZeqEJRakJhZBADPE0VyRwAAAA&hl=en&mat=","posts":[{"week":"1st Week","title":"Mobile Lawn Mower Repair in Brownsville \u2013 Expert On-Site Service","body":"Tired of hauling your mower to the shop? In Brownsville, we bring expert small-engine repair directly to you. Our mobile team handles everything from tune-ups and blade sharpening to diagnostics and f","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Lawn Mower Not Starting? Call Now","body":"If your lawn mower isn\u2019t starting properly, now is the time to get it checked out. We\u2019ll ensure it\u2019s ready for spring.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Keep Your Generator Ready for Winter Call for Service","body":"Even in mild winters, power outages can occur. Make sure your generator is ready for use with a quick check-up.","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for Your Equipment View Plans","body":"Our tune-up plans are perfect for keeping your lawn mower, generator, and other equipment running smoothly all year long. Get priority service and discounted repairs.","cta":"View Plans","status":"Published"},{"week":"1st Week","title":"Start the Year with a Lawn Mower Tune-Up Book Now","body":"Get your lawn mower ready for the spring season with a quick tune-up. Book today to ensure it\u2019s running smoothly for the year ahead.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Get Your Generator Ready for Winter Call for Service","body":"Power outages can happen at any time. Make sure your generator is in top shape by scheduling a service check today.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune-Up Plans Starting at 10.83 Explore Plans","body":"Make sure your equipment stays in great condition all year long with our monthly tune-up plans. Priority service and discounts on repairs included!","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Early Lawn Mower Prep \u2014 Get Ready for Spring Book Early","body":"Spring is coming soon! Avoid the spring rush and schedule your lawn mower tune-up today to get ahead of the season.","cta":"Book Early","status":"Published"}]},"Houston, TX":{"coords":"","gbpLink":"https://www.google.com/search?q=Mobile+Wildwood+Mower+Repair+/+Generator+HOU&stick=H4sIAAAAAAAA_-NgU1I1qDAxNzFLMUtMMTZMSTI2NzW0MqgwN040TUs2tbRITjUzSjWzWMSq45uflJmTqhCemZNSnp-fouCbX55apBCUWpCYWaSgr-Cem","posts":[{"week":"1st Week","title":"Keep Engines Reliable with Small Engine Repair Houston TX","body":"Is your lawn mower, generator, or power tool losing strength or refusing to start? Our professional small engine repair Houston TX team delivers fast, mobile, and affordable solutions right at your do","cta":"Call Now","status":"Published"},{"week":"2nd Week","title":"Mower Repair Houston TX \u2013 Stay Ready Before Spring Season","body":"Spring is just around the corner is your mower ready? At Mobile Wildwood Mower Repair in Houston, we specialize in fast, reliable mower and small-engine repair so that your lawn is ready when spring a","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Lawn Mower Not Starting? Call Now","body":"If your lawn mower is having trouble starting, now is the time to get it checked out. Make sure it\u2019s ready for the busy spring season ahead.","cta":"Call Now","status":"Published"},{"week":"3rd Week","title":"Keep Your Generator Ready for Winter Call for Service","body":"Even though winter in Houston is mild, it\u2019s still important to have your generator ready for any potential power outages. Get it serviced today!","cta":"Call for Service","status":"Published"},{"week":"4th Week","title":"Tune-Up Plans for Your Equipment View Plans","body":"Our yearly tune-up plans are designed to keep your lawn mower, generator, and other equipment running smoothly all year. Get priority service and discounts on repairs.","cta":"View Plans","status":"Published"},{"week":"1st Week","title":"Start the Year with a Lawn Mower Tune-Up Book Now","body":"Start the year off right by making sure your lawn mower is ready for spring. Book your tune-up today to ensure it\u2019s running smoothly when you need it.","cta":"Book Now","status":"Published"},{"week":"2nd Week","title":"Get Your Generator Ready for Winter Call for Service","body":"Power outages can still happen in mild winters. Make sure your generator is ready for use by scheduling a service check today.","cta":"Call for Service","status":"Published"},{"week":"3rd Week","title":"Monthly Tune-Up Plans Starting at 10.83 Explore Plans","body":"Keep your equipment running smoothly all year long with our affordable monthly tune-up plans. Includes inspections, oil changes, and priority service.","cta":"Explore Plans","status":"Published"},{"week":"4th Week","title":"Early Lawn Mower Prep \u2014 Get Ready for Spring Book Early","body":"Spring is just around the corner. Avoid the spring rush and schedule your lawn mower tune-up now to get ahead of the season.","cta":"Book Early","status":"Published"}]}},"offPage":{"Brownsville, TX":{"name":"Wildwood Small Engine Repair","phone":"(361) 203-4876","citations":[{"domain":"https://www.mylifegb.com/","link":"https://www.mylifegb.com/elsa/automotive/wildwood-small-engine-repair","status":"Pending"},{"domain":"https://www.godown.town/","link":"https://www.godown.town/elsa/place/wildwood-small-engine-repair","status":"Pending"},{"domain":"http://www.fsbas.com/","link":"https://www.localhomeservicepros.com/elsa/appliance-repair/wildwood-small-engine-repair","status":"Pending"},{"domain":"https://www.freelistingusa.com/","link":"https://www.freelistingusa.com/listings/wildwood-small-engine-repair-1","status":"Pending"},{"domain":"https://www.911getit.com/","link":"http://www.fsbas.com/elsa/home-services/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://www.cargodirectory.co/","link":"https://www.cargodirectory.co/elsa/office-equipment/wildwood-small-engine-repair","status":"Pending"},{"domain":"http://www.golocalezservices.com/","link":"https://www.golocalezservices.com/elsa/automotive/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://www.techdirectory.io/","link":"https://www.techdirectory.io/elsa/home-services/wild-wood-small-engine-repair","status":""},{"domain":"https://helpsellmyfsbo.com/","link":"https://helpsellmyfsbo.com/elsa/wild-wood-small-engine-repair","status":""},{"domain":"https://www.localhomeservicepros.com/","link":"https://www.localhomeservicepros.com/elsa/appliance-repair/wildwood-small-engine-repair-262489","status":""},{"domain":"https://www.bizmakersamerica.org/","link":"https://www.bizmakersamerica.org/elsa/other/wildwood-small-engine-repair","status":""},{"domain":"https://www.freelistinguk.com/","link":"https://www.freelistinguk.com/listings/wildwood-small-engine-repair","status":""},{"domain":"https://www.getlisteduae.com/","link":"https://www.getlisteduae.com/listings/wildwood-small-engine-repair","status":""},{"domain":"https://www.youbiz.com/","link":"https://www.youbiz.com/sponsors/listing/listing.php?id=198574","status":"Pending"},{"domain":"https://www.nextbizmaker.com/","link":"","status":""},{"domain":"https://www.businesssoftwarehelp.com/","link":"","status":""},{"domain":"https://www.successcenter.com/","link":"","status":""},{"domain":"https://www.revealnepal.com/","link":"https://www.revealnepal.com/?post_type=listing&p=50363","status":"Pending"},{"domain":"https://www.bizdiversity.directory/","link":"","status":""},{"domain":"https://habeshalink.com/","link":"","status":""},{"domain":"https://listings.beginswithfamily.net/","link":"","status":""},{"domain":"https://www.anibookmark.com/","link":"","status":""},{"domain":"https://nearfinderau.com/en/","link":"","status":""},{"domain":"https://www.trysmallbiz.com/","link":"","status":""},{"domain":"https://www.callupcontact.com/","link":"","status":""},{"domain":"https://vymaps.com/AU/","link":"","status":""},{"domain":"https://www.bizdiversity.","link":"","status":""},{"domain":"https://www.surfyourtown.com/","link":"","status":""},{"domain":"https://www.counselingnearme.com/","link":"","status":""},{"domain":"https://www.dealerbaba.com/","link":"","status":""},{"domain":"https://startups.snapmunk.com/","link":"","status":""},{"domain":"https://www.trueen.com/","link":"","status":""},{"domain":"https://www.cybo.com/","link":"","status":""},{"domain":"https://www.us-info.com/","link":"","status":""},{"domain":"https://www.startupranking.com/","link":"","status":""},{"domain":"https://www.b2bco.com/","link":"","status":""},{"domain":"https://www.d2o-global.com/","link":"","status":""},{"domain":"https://www.locbusiness.com/","link":"","status":""},{"domain":"https://1businessworld.com/","link":"","status":""},{"domain":"https://www.cataloxy.us/","link":"","status":""},{"domain":"https://www.insertbiz.com/","link":"","status":""},{"domain":"https://www.ourbizdirectory.com/","link":"","status":""},{"domain":"https://www.bunity.com/","link":"","status":""},{"domain":"http://www.localstar.org/","link":"","status":""},{"domain":"https://www.242hub.com/","link":"","status":""},{"domain":"https://www.freelistingindia.in/","link":"","status":""},{"domain":"https://www.onmap.ae/","link":"","status":""},{"domain":"https://groovyfreeads.com/","link":"","status":""},{"domain":"https://linkz.us/","link":"","status":""},{"domain":"https://alwaysdial.com/","link":"","status":""},{"domain":"https://www.addonbiz.com/","link":"","status":""},{"domain":"https://www.savenebraskalocal.com/","link":"","status":""},{"domain":"https://www.detroitbusinesscenter.com/","link":"","status":""},{"domain":"https://www.boisemeridian.com/","link":"","status":""},{"domain":"https://www.africanfind.com/","link":"","status":""},{"domain":"http://ballarat.thelocalskinny.com/","link":"","status":""},{"domain":"https://aussiestoresonline.com/","link":"","status":""},{"domain":"https://catalog-australia.com/","link":"","status":""},{"domain":"https://www.trustfeed.com/","link":"","status":""},{"domain":"http://www.localstorefronts.com/","link":"","status":""},{"domain":"https://www.officiallyiconic.com/","link":"","status":""},{"domain":"https://www.radar.directory/","link":"","status":""},{"domain":"https://www.demobootstrap.com/","link":"","status":""},{"domain":"https://www.revealbusinesses.com/","link":"","status":""},{"domain":"https://milestones.business/","link":"","status":""},{"domain":"https://highdadirectory.com/","link":"","status":""},{"domain":"http://listizze.com/","link":"","status":""},{"domain":"https://www.distrilist.eu/","link":"","status":""},{"domain":"https://getmedirectory.com/","link":"","status":""},{"domain":"https://heliskidirectory.com/","link":"","status":""},{"domain":"https://topdirectory1.com/","link":"","status":""},{"domain":"https://www.middleeastsouk.com","link":"","status":""},{"domain":"https://www.impressionsdirectory.com/","link":"","status":""},{"domain":"https://www.blacklinkus.com","link":"","status":""},{"domain":"https://www.squeakafrica.com/","link":"","status":""},{"domain":"https://www.myadbay.com/","link":"","status":""},{"domain":"http://www.surpassconnect.com/","link":"","status":""},{"domain":"https://www.adlocalpages.com/","link":"","status":""},{"domain":"http://www.askjaynee.com/","link":"","status":""},{"domain":"https://www.cybo.com/","link":"","status":""}],"profiles":[{"domain":"https://solo.to/","link":"https://solo.to/wildwoodsmallengine1","status":""},{"domain":"https://www.behance.net/","link":"https://www.behance.net/noahjohson","status":""},{"domain":"https://stackoverflow.com","link":"https://stackoverflow.com/users/31571891/wild-wood-small-engine-repair","status":""},{"domain":"https://www.sutori.com/","link":"https://www.sutori.com/en/user/noah-johson?tab=profile","status":""},{"domain":"https://slideslive.com/","link":"https://slideslive.com/wildwoodsmallenginerepairbrownsville-texas/","status":""},{"domain":"https://dev.to/","link":"https://dev.to/wildwoodsmallenginerepair8","status":""},{"domain":"https://www.pinterest.com/","link":"https://www.pinterest.com/wildwoodsmallenginerepair9/","status":""},{"domain":"https://www.quora.com/","link":"https://www.quora.com/profile/Noah-Johson-1","status":""},{"domain":"https://os.mbed.com/","link":"https://os.mbed.com/users/wildwoodsmallenginer/","status":""},{"domain":"https://trello.com/","link":"https://trello.com/u/wildwoodsmallenginerepair10","status":""},{"domain":"https://github.com/","link":"https://github.com/wildwoodsmallenginerepair12","status":""},{"domain":"https://webflow.com/","link":"https://webflow.com/@brownsville-texas","status":""},{"domain":"https://gifyu.com/","link":"https://gifyu.com/image/bw7XS","status":""},{"domain":"https://linktr.ee/","link":"https://linktr.ee/wildwoodsmallenginer","status":""},{"domain":"https://www.pexels.com/","link":"https://www.pexels.com/edit-profile/","status":""},{"domain":"https://archello.com/","link":"https://archello.com/user/small-engine-repair-wild-wood","status":""},{"domain":"https://devpost.com/","link":"https://devpost.com/wildwoodsmallenginerepair","status":""},{"domain":"https://ko-fi.com/","link":"https://ko-fi.com/wildwoodsmallenginerepair#payment-widget","status":""},{"domain":"https://issuu.com","link":"https://issuu.com/wildwoodsmallenginer","status":""},{"domain":"https://info.credly.com/","link":"https://www.credly.com/users/wild-wood-small-engine-repair.356e2b8c/edit#credly","status":""},{"domain":"https://www.evernote.com","link":"","status":""},{"domain":"https://unsplash.com/","link":"","status":""},{"domain":"https://www.storeboard.com/","link":"","status":""},{"domain":"https://www.alignable.com/","link":"","status":""},{"domain":"https://www.zillow.com/","link":"","status":""},{"domain":"https://www.locanto.com.au/","link":"","status":""},{"domain":"https://www.oodle.com/","link":"","status":""},{"domain":"https://www.meetup.com/","link":"https://www.meetup.com/members/476295129/","status":""},{"domain":"https://www.plurk.com/","link":"https://www.plurk.com/WildWood23/public","status":""},{"domain":"https://www.mediafire.com","link":"","status":""},{"domain":"https://www.dead.net/","link":"","status":""},{"domain":"https://www.wattpad.com/","link":"","status":""},{"domain":"https://www.redbubble.com/","link":"","status":""},{"domain":"https://pixabay.com/","link":"","status":""},{"domain":"https://500px.com/","link":"https://500px.com/p/wildwoodsmallengine?view=photos","status":""},{"domain":"https://public.tableau.com/","link":"","status":""},{"domain":"https://app.slack.com/","link":"","status":""}],"guestPosts":[{"domain":"https://medium.com/","link":"","status":""},{"domain":"https://www.livejournal.com/","link":"","status":""},{"domain":"https://www.hashtap.com/","link":"","status":""},{"domain":"https://www.blogger.com/","link":"","status":""},{"domain":"https://articlebiz.com","link":"","status":""},{"domain":"https://buymeacoffee.com/","link":"","status":""},{"domain":"https://www.quora.com/","link":"","status":""},{"domain":"https://trumpbookusa.com/","link":"","status":""},{"domain":"https://printable-calendar.mn.co/","link":"","status":""},{"domain":"https://substack.com/","link":"","status":""},{"domain":"https://www.hellobox.co/","link":"","status":""},{"domain":"https://pinaunaeditora.com.br/","link":"","status":""},{"domain":"https://1st-street.com/","link":"","status":""},{"domain":"https://urrankings.com/","link":"","status":""},{"domain":"https://collectionofblogs.com/","link":"","status":""},{"domain":"https://doomelang.com/","link":"","status":""},{"domain":"https://bdnews55.com/","link":"","status":""},{"domain":"https://www.diigo.com/item/","link":"","status":""},{"domain":"https://usman09.ampedpages.com/","link":"","status":""},{"domain":"https://timessquarereporter.com/","link":"","status":""},{"domain":"https://www.bairwaji.com/","link":"","status":""},{"domain":"https://www.diigo.com/user/urban12","link":"","status":""},{"domain":"https://webyourself.eu","link":"","status":""}]},"Cape Coral, FL":{"name":"Wildwood Mobile Small Engine Repair Fl","phone":"(239) 766-5543","citations":[{"domain":"https://www.mylifegb.com/","link":"https://www.mylifegb.com/cape-coral/home-services/wild-wood-small-engine-repair-services","status":"Pending"},{"domain":"https://www.godown.town/","link":"https://www.godown.town/cape-coral/place/wild-wood-small-engine-repair-services","status":""},{"domain":"http://www.fsbas.com/","link":"http://www.fsbas.com/cape-coral/home-services/wild-wood-small-engine-repair-services","status":""},{"domain":"https://www.freelistingusa.com/","link":"https://www.freelistingusa.com/listings/wildwood-mobile-small-engine-repair-fl-1","status":""},{"domain":"https://www.911getit.com/","link":"https://www.911getit.com/cape-coral/auto-repair-service/wild-wood-small-engine-repair-services","status":""},{"domain":"https://www.cargodirectory.co/","link":"https://www.cargodirectory.co/cape-coral/aircraft-equipment/wild-wood-small-engine-repair-services","status":""},{"domain":"http://www.golocalezservices.com/","link":"https://www.golocalezservices.com/cape-coral/automotive/wild-wood-small-engine-repair-services","status":""},{"domain":"https://architizer.com/","link":"https://architizer.com/firms/wild-wood-small-engine-repair/","status":"Pending"},{"domain":"https://www.techdirectory.io/","link":"https://www.techdirectory.io/cape-coral/automotive/wild-wood-small-engine-repair-services","status":""},{"domain":"https://www.localhomeservicepros.com/","link":"https://www.localhomeservicepros.com/cape-coral/appliance-repair/wild-wood-small-engine-repair-services","status":""},{"domain":"https://helpsellmyfsbo.com/","link":"https://helpsellmyfsbo.com/cape-coral/wild-wood-small-engine-repair","status":""},{"domain":"https://www.revealnepal.com/","link":"https://www.revealnepal.com/?post_type=listing&p=50378","status":"Pending"},{"domain":"https://www.freelistinguk.com/","link":"https://www.freelistinguk.com/listings/wildwood-mobile-small-engine-repair","status":""},{"domain":"https://www.getlisteduae.com/","link":"https://www.getlisteduae.com/listings/wildwood-small-engine-repair-1","status":""},{"domain":"https://www.youbiz.com/","link":"https://youbiz.com/sponsors/listing/listing.php?id=198659","status":""},{"domain":"https://www.successcenter.com/","link":"","status":"Email dont receive"},{"domain":"https://www.businesssoftwarehelp.com/","link":"","status":"Blocked"},{"domain":"https://www.cybo.com/","link":"https://www.cybo.com/US-biz/wildwood-small-engine-repair_10","status":""},{"domain":"http://www.brownbook.net/","link":"https://www.brownbook.net/business/54420258/wild-wood-small-engine-repair-services/edit","status":""},{"domain":"https://www.hotfrog.com/","link":"https://www.hotfrog.com/company/9e59eac869266c164cc8d82b1c6b9581","status":""},{"domain":"http://www.surpassconnect.com/","link":"","status":""},{"domain":"https://www.adlocalpages.com/","link":"","status":""},{"domain":"http://www.askjaynee.com/","link":"","status":""},{"domain":"https://www.nextbizmaker.com/","link":"","status":""},{"domain":"https://au.enrollbusiness.com/","link":"","status":""},{"domain":"https://www.bizdiversity.directory/","link":"","status":""},{"domain":"https://habeshalink.com/","link":"","status":""},{"domain":"https://listings.beginswithfamily.net/","link":"","status":""},{"domain":"https://www.anibookmark.com/","link":"","status":""},{"domain":"https://nearfinderau.com/en/","link":"","status":""},{"domain":"https://www.trysmallbiz.com/","link":"","status":""},{"domain":"https://www.callupcontact.com/","link":"","status":""},{"domain":"https://vymaps.com/AU/","link":"","status":""},{"domain":"https://www.bizdiversity.","link":"","status":""},{"domain":"https://www.surfyourtown.com/","link":"","status":""},{"domain":"https://www.counselingnearme.com/","link":"","status":""},{"domain":"https://www.dealerbaba.com/","link":"","status":""},{"domain":"https://startups.snapmunk.com/","link":"","status":""},{"domain":"https://www.bizmakersamerica.org/","link":"","status":""},{"domain":"https://www.trueen.com/","link":"","status":""},{"domain":"https://www.cybo.com/","link":"","status":""},{"domain":"https://www.us-info.com/","link":"","status":""},{"domain":"https://www.find-us-here.com","link":"","status":""},{"domain":"https://about.me/","link":"","status":""},{"domain":"https://www.startupranking.com/","link":"","status":""},{"domain":"https://www.b2bco.com/","link":"","status":""},{"domain":"https://www.d2o-global.com/","link":"","status":""},{"domain":"https://www.locbusiness.com/","link":"","status":""},{"domain":"https://1businessworld.com/","link":"","status":""},{"domain":"https://www.cataloxy.us/","link":"","status":""},{"domain":"https://www.insertbiz.com/","link":"","status":""},{"domain":"https://www.ourbizdirectory.com/","link":"","status":""},{"domain":"https://www.bunity.com/","link":"","status":""},{"domain":"https://www.fixerhub.com/","link":"","status":""},{"domain":"http://www.localstar.org/","link":"","status":""},{"domain":"https://www.242hub.com/","link":"","status":""},{"domain":"https://www.freelistingindia.in/","link":"","status":""},{"domain":"https://www.onmap.ae/","link":"","status":""},{"domain":"https://groovyfreeads.com/","link":"","status":""},{"domain":"https://linkz.us/","link":"","status":""},{"domain":"https://alwaysdial.com/","link":"","status":""},{"domain":"https://www.addonbiz.com/","link":"","status":""},{"domain":"https://www.savenebraskalocal.com/","link":"","status":""},{"domain":"https://www.detroitbusinesscenter.com/","link":"","status":""},{"domain":"https://www.boisemeridian.com/","link":"","status":""},{"domain":"https://www.africanfind.com/","link":"","status":""},{"domain":"http://ballarat.thelocalskinny.com/","link":"","status":""},{"domain":"https://aussiestoresonline.com/","link":"","status":""},{"domain":"https://catalog-australia.com/","link":"","status":""},{"domain":"https://www.trustfeed.com/","link":"","status":""},{"domain":"http://www.localstorefronts.com/","link":"","status":""},{"domain":"https://www.officiallyiconic.com/","link":"","status":""},{"domain":"https://www.radar.directory/","link":"","status":""},{"domain":"https://www.demobootstrap.com/","link":"","status":""},{"domain":"https://www.revealbusinesses.com/","link":"","status":""},{"domain":"https://milestones.business/","link":"","status":""},{"domain":"https://highdadirectory.com/","link":"","status":""},{"domain":"http://listizze.com/","link":"","status":""},{"domain":"https://www.distrilist.eu/","link":"","status":""},{"domain":"https://getmedirectory.com/","link":"","status":""},{"domain":"https://heliskidirectory.com/","link":"","status":""},{"domain":"https://topdirectory1.com/","link":"","status":""},{"domain":"https://www.middleeastsouk.com","link":"","status":""},{"domain":"https://www.impressionsdirectory.com/","link":"","status":""},{"domain":"https://www.blacklinkus.com","link":"","status":""},{"domain":"https://www.squeakafrica.com/","link":"","status":""},{"domain":"https://www.myadbay.com/","link":"","status":""}],"profiles":[{"domain":"https://solo.to/","link":"https://solo.to/wildwoodsmallengine6","status":""},{"domain":"https://www.behance.net/","link":"https://www.behance.net/benjaminscott15","status":""},{"domain":"https://stackoverflow.com","link":"https://stackoverflow.com/users/31577268/wildwood-small-engine-repair","status":""},{"domain":"https://www.sutori.com/","link":"https://www.sutori.com/en/user/benjamin-scott-c6af?tab=profile","status":""},{"domain":"https://slideslive.com/","link":"https://slideslive.com/wildwoodsmallenginerepaircapecoral/-/edit","status":""},{"domain":"https://www.mediafire.com","link":"","status":""},{"domain":"https://dev.to/","link":"","status":""},{"domain":"https://www.pinterest.com/","link":"","status":""},{"domain":"https://www.quora.com/","link":"","status":""},{"domain":"https://os.mbed.com/","link":"","status":""},{"domain":"https://trello.com/","link":"","status":""},{"domain":"https://www.dead.net/","link":"","status":""},{"domain":"https://github.com/","link":"","status":""},{"domain":"https://webflow.com/","link":"","status":""},{"domain":"https://www.coursera.org/","link":"","status":""},{"domain":"https://www.discogs.com/","link":"","status":""},{"domain":"https://www.wattpad.com/","link":"","status":""},{"domain":"https://superuser.com/","link":"","status":""},{"domain":"https://www.redbubble.com/","link":"","status":""},{"domain":"https://gifyu.com/","link":"","status":""},{"domain":"https://linktr.ee/","link":"","status":""},{"domain":"https://www.pexels.com/","link":"","status":""},{"domain":"https://archello.com/","link":"","status":""},{"domain":"https://app.slack.com/","link":"","status":""},{"domain":"https://pixabay.com/","link":"","status":""},{"domain":"https://devpost.com/","link":"","status":""},{"domain":"https://public.tableau.com/","link":"","status":""},{"domain":"https://ko-fi.com/","link":"","status":""},{"domain":"https://500px.com/","link":"","status":""},{"domain":"https://issuu.com","link":"","status":""},{"domain":"https://info.credly.com/","link":"","status":""},{"domain":"https://www.evernote.com","link":"","status":""},{"domain":"https://unsplash.com/","link":"","status":""},{"domain":"https://www.storeboard.com/","link":"","status":""},{"domain":"https://www.alignable.com/","link":"","status":""},{"domain":"https://www.zillow.com/","link":"","status":""},{"domain":"https://www.locanto.com.au/","link":"","status":""},{"domain":"https://www.oodle.com/","link":"","status":""},{"domain":"https://www.meetup.com/","link":"","status":""},{"domain":"https://www.plurk.com/","link":"","status":""},{"domain":"https://nextdoor.com/","link":"","status":""}],"guestPosts":[{"domain":"https://medium.com/","link":"","status":""},{"domain":"https://www.livejournal.com/","link":"","status":""},{"domain":"https://www.hashtap.com/","link":"","status":""},{"domain":"https://www.blogger.com/","link":"","status":""},{"domain":"https://articlebiz.com","link":"","status":""},{"domain":"https://buymeacoffee.com/","link":"","status":""},{"domain":"https://www.quora.com/","link":"","status":""},{"domain":"https://trumpbookusa.com/","link":"","status":""},{"domain":"https://printable-calendar.mn.co/","link":"","status":""},{"domain":"https://substack.com/","link":"","status":""},{"domain":"https://www.hellobox.co/","link":"","status":""},{"domain":"https://pinaunaeditora.com.br/","link":"","status":""},{"domain":"https://1st-street.com/","link":"","status":""},{"domain":"https://urrankings.com/","link":"","status":""},{"domain":"https://collectionofblogs.com/","link":"","status":""},{"domain":"https://doomelang.com/","link":"","status":""},{"domain":"https://bdnews55.com/","link":"","status":""},{"domain":"https://www.diigo.com/item/","link":"","status":""},{"domain":"https://usman09.ampedpages.com/","link":"","status":""},{"domain":"https://timessquarereporter.com/","link":"","status":""},{"domain":"https://www.bairwaji.com/","link":"","status":""},{"domain":"https://www.diigo.com/user/urban12","link":"","status":""},{"domain":"https://webyourself.eu","link":"","status":""}]},"Crawfordsville, IN":{"business":"Mobile Wildwood Mower Repair / Generator CRF","phone":"(765) 436-1206","citations":[{"domain":"https://www.mylifegb.com/","liveLink":"https://www.mylifegb.com/united-states/carmel/professional-services/wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.godown.town/","liveLink":"https://www.godown.town/indiana/carmel/place/wildwoodsmallenginerepair","status":"Pending"},{"domain":"https://www.freelistingusa.com/","liveLink":"https://www.freelistingusa.com/listings/wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.localhomeservicepros.com/","liveLink":"https://www.localhomeservicepros.com/carmel/appliance-repair/wildwood-small-engine-repair","status":"Live"},{"domain":"http://www.fsbas.com/","liveLink":"http://www.fsbas.com/carmel/home-services/wild-wood-small-engine-repair","status":"Live"},{"domain":"https://www.cargodirectory.co/","liveLink":"https://www.cargodirectory.co/carmel/office-equipment/wild-wood-small-engine-repair-services","status":"Pending"},{"domain":"http://www.golocalezservices.com/","liveLink":"https://www.golocalezservices.com/carmel/automotive/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://architizer.com/","liveLink":"https://architizer.com/firms/wildwood-small-engine-repair/","status":"Pending"},{"domain":"https://www.techdirectory.io/","liveLink":"https://www.techdirectory.io/carmel/automotive/wildwood-small-engine-repair","status":"Pending"},{"domain":"https://www.revealnepal.com/","liveLink":"https://www.revealnepal.com/?post_type=listing&p=50375","status":"Pending"},{"domain":"https://www.freelistinguk.com/","liveLink":"https://www.freelistinguk.com/listings/wildwood-small-engine-repair-1","status":"Pending"},{"domain":"https://www.getlisteduae.com/","liveLink":"https://www.getlisteduae.com/listings/mobile-wildwood-mower-repair-generator-srq-1","status":"Pending"},{"domain":"https://www.youbiz.com/","liveLink":"https://www.youbiz.com/sponsors/listing/listing.php?id=198647","status":"Pending"},{"domain":"https://www.businesssoftwarehelp.com/","liveLink":"","status":"Pending"},{"domain":"https://helpsellmyfsbo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.successcenter.com/","liveLink":"","status":"Pending"},{"domain":"http://www.surpassconnect.com/","liveLink":"","status":"Pending"},{"domain":"https://www.adlocalpages.com/","liveLink":"","status":"Pending"},{"domain":"http://www.askjaynee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.nextbizmaker.com/","liveLink":"","status":"Pending"},{"domain":"https://au.enrollbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.directory/","liveLink":"","status":"Pending"},{"domain":"https://habeshalink.com/","liveLink":"","status":"Pending"},{"domain":"https://listings.beginswithfamily.net/","liveLink":"","status":"Pending"},{"domain":"https://www.anibookmark.com/","liveLink":"","status":"Pending"},{"domain":"https://nearfinderau.com/en/","liveLink":"","status":"Pending"},{"domain":"https://www.trysmallbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.callupcontact.com/","liveLink":"","status":"Pending"},{"domain":"https://vymaps.com/AU/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.","liveLink":"","status":"Pending"},{"domain":"https://www.surfyourtown.com/","liveLink":"","status":"Pending"},{"domain":"https://www.counselingnearme.com/","liveLink":"","status":"Pending"},{"domain":"https://www.dealerbaba.com/","liveLink":"","status":"Pending"},{"domain":"https://startups.snapmunk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"","status":"Pending"},{"domain":"https://www.trueen.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://www.find-us-here.com","liveLink":"","status":"Pending"},{"domain":"https://about.me/","liveLink":"","status":"Pending"},{"domain":"https://www.startupranking.com/","liveLink":"","status":"Pending"},{"domain":"https://www.b2bco.com/","liveLink":"","status":"Pending"},{"domain":"https://www.d2o-global.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://1businessworld.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cataloxy.us/","liveLink":"","status":"Pending"},{"domain":"https://www.insertbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.ourbizdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bunity.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstar.org/","liveLink":"","status":"Pending"},{"domain":"https://www.242hub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistingindia.in/","liveLink":"","status":"Pending"},{"domain":"https://www.onmap.ae/","liveLink":"","status":"Pending"},{"domain":"https://groovyfreeads.com/","liveLink":"","status":"Pending"},{"domain":"https://linkz.us/","liveLink":"","status":"Pending"},{"domain":"https://alwaysdial.com/","liveLink":"","status":"Pending"},{"domain":"https://www.addonbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.savenebraskalocal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.detroitbusinesscenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.boisemeridian.com/","liveLink":"","status":"Pending"},{"domain":"https://www.africanfind.com/","liveLink":"","status":"Pending"},{"domain":"http://ballarat.thelocalskinny.com/","liveLink":"","status":"Pending"},{"domain":"https://aussiestoresonline.com/","liveLink":"","status":"Pending"},{"domain":"https://catalog-australia.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trustfeed.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstorefronts.com/","liveLink":"","status":"Pending"},{"domain":"https://www.officiallyiconic.com/","liveLink":"","status":"Pending"},{"domain":"https://www.radar.directory/","liveLink":"","status":"Pending"},{"domain":"https://www.demobootstrap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.revealbusinesses.com/","liveLink":"","status":"Pending"},{"domain":"https://milestones.business/","liveLink":"","status":"Pending"},{"domain":"https://highdadirectory.com/","liveLink":"","status":"Pending"},{"domain":"http://listizze.com/","liveLink":"","status":"Pending"},{"domain":"https://www.distrilist.eu/","liveLink":"","status":"Pending"},{"domain":"https://getmedirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://heliskidirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://topdirectory1.com/","liveLink":"","status":"Pending"},{"domain":"https://www.middleeastsouk.com","liveLink":"","status":"Pending"},{"domain":"https://www.impressionsdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blacklinkus.com","liveLink":"","status":"Pending"},{"domain":"https://www.squeakafrica.com/","liveLink":"","status":"Pending"},{"domain":"https://www.myadbay.com/","liveLink":"","status":"Pending"},{"domain":"https://www.911getit.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"}],"profiles":[{"domain":"https://solo.to/","liveLink":"https://solo.to/wildwoodsmallengine3","status":"Pending"},{"domain":"https://www.behance.net/","liveLink":"https://www.behance.net/ethanparker29","status":"Pending"},{"domain":"https://stackoverflow.com","liveLink":"https://stackoverflow.com/users/31557991/wildwood-small-engine-repair","status":"Pending"},{"domain":"https://www.sutori.com/","liveLink":"https://www.sutori.com/en/user/ethan-parker-7c4d?tab=profile","status":"Pending"},{"domain":"https://slideslive.com/","liveLink":"https://slideslive.com/wildwoodsmallenginerepaircarmel/-/edit","status":"Pending"},{"domain":"https://www.mediafire.com","liveLink":"","status":"Pending"},{"domain":"https://www.dead.net/","liveLink":"","status":"Pending"},{"domain":"https://www.wattpad.com/","liveLink":"","status":"Pending"},{"domain":"https://www.redbubble.com/","liveLink":"","status":"Pending"},{"domain":"https://dev.to/","liveLink":"","status":"Pending"},{"domain":"https://www.pinterest.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://os.mbed.com/","liveLink":"","status":"Pending"},{"domain":"https://trello.com/","liveLink":"","status":"Pending"},{"domain":"https://github.com/","liveLink":"","status":"Pending"},{"domain":"https://webflow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.coursera.org/","liveLink":"","status":"Pending"},{"domain":"https://www.discogs.com/","liveLink":"","status":"Pending"},{"domain":"https://gifyu.com/","liveLink":"","status":"Pending"},{"domain":"https://linktr.ee/","liveLink":"","status":"Pending"},{"domain":"https://www.pexels.com/","liveLink":"","status":"Pending"},{"domain":"https://archello.com/","liveLink":"","status":"Pending"},{"domain":"https://app.slack.com/","liveLink":"","status":"Pending"},{"domain":"https://pixabay.com/","liveLink":"","status":"Pending"},{"domain":"https://devpost.com/","liveLink":"","status":"Pending"},{"domain":"https://public.tableau.com/","liveLink":"","status":"Pending"},{"domain":"https://ko-fi.com/","liveLink":"","status":"Pending"},{"domain":"https://500px.com/","liveLink":"","status":"Pending"},{"domain":"https://issuu.com","liveLink":"https://issuu.com/wildwoodsmallenginerepaircarmel","status":"Pending"},{"domain":"https://info.credly.com/","liveLink":"","status":"Pending"},{"domain":"https://www.evernote.com","liveLink":"","status":"Pending"},{"domain":"https://unsplash.com/","liveLink":"","status":"Pending"},{"domain":"https://www.storeboard.com/","liveLink":"","status":"Pending"},{"domain":"https://www.alignable.com/","liveLink":"","status":"Pending"},{"domain":"https://www.zillow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locanto.com.au/","liveLink":"","status":"Pending"},{"domain":"https://www.oodle.com/","liveLink":"","status":"Pending"},{"domain":"https://www.meetup.com/","liveLink":"","status":"Pending"},{"domain":"https://www.plurk.com/","liveLink":"","status":"Pending"},{"domain":"https://nextdoor.com/","liveLink":"","status":"Pending"}],"guestPosts":[{"domain":"https://medium.com/","liveLink":"","status":"Pending"},{"domain":"https://www.livejournal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hashtap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blogger.com/","liveLink":"","status":"Pending"},{"domain":"https://articlebiz.com","liveLink":"","status":"Pending"},{"domain":"https://buymeacoffee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://trumpbookusa.com/","liveLink":"","status":"Pending"},{"domain":"https://printable-calendar.mn.co/","liveLink":"","status":"Pending"},{"domain":"https://substack.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hellobox.co/","liveLink":"","status":"Pending"},{"domain":"https://pinaunaeditora.com.br/","liveLink":"","status":"Pending"},{"domain":"https://1st-street.com/","liveLink":"","status":"Pending"},{"domain":"https://urrankings.com/","liveLink":"","status":"Pending"},{"domain":"https://collectionofblogs.com/","liveLink":"","status":"Pending"},{"domain":"https://doomelang.com/","liveLink":"","status":"Pending"},{"domain":"https://bdnews55.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/item/","liveLink":"","status":"Pending"},{"domain":"https://usman09.ampedpages.com/","liveLink":"","status":"Pending"},{"domain":"https://timessquarereporter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bairwaji.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/user/urban12","liveLink":"","status":"Pending"},{"domain":"https://webyourself.eu","liveLink":"","status":"Pending"}]},"Houston, TX":{"business":"Mobile Wildwood Mower Repair / Generator HOU","phone":"(713) 561-5922","citations":[{"domain":"https://www.mylifegb.com/","liveLink":"https://www.mylifegb.com/united-states/katy/public-services/mobile-wildwood-mower-repair-generator-hou","status":"Live"},{"domain":"https://www.godown.town/","liveLink":"https://www.godown.town/texas/katy/place/mobile-wildwood-mower-repair-generator-hou","status":"Live"},{"domain":"http://www.fsbas.com/","liveLink":"http://www.fsbas.com/united-states/katy/automotive/mobile-wildwood-mower-repair-generator-hou","status":"Live"},{"domain":"https://www.freelistingusa.com/","liveLink":"https://www.freelistingusa.com/listings/mobile-wildwood-mower-repair-generator-hou","status":"Live"},{"domain":"https://www.911getit.com/","liveLink":"https://www.911getit.com/united-states/katy/a-business-service-undefined-category-listing/mobile-wildwood-mower-repair-g","status":"Live"},{"domain":"https://www.cargodirectory.co/","liveLink":"https://www.cargodirectory.co/katy/undecided-category/lawn-mower-repair-service","status":"Live"},{"domain":"http://www.golocalezservices.com/","liveLink":"http://www.golocalezservices.com/katy/automotive/lawn-mower-repair-service","status":"Live"},{"domain":"https://www.successcenter.com/","liveLink":"Paid","status":"Pending"},{"domain":"https://www.localhomeservicepros.com/","liveLink":"","status":"Pending"},{"domain":"https://www.businesssoftwarehelp.com/","liveLink":"","status":"Pending"},{"domain":"https://www.adlocalpages.com/","liveLink":"","status":"Pending"},{"domain":"http://www.askjaynee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.nextbizmaker.com/","liveLink":"","status":"Pending"},{"domain":"https://au.enrollbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.directory/","liveLink":"","status":"Pending"},{"domain":"https://habeshalink.com/","liveLink":"","status":"Pending"},{"domain":"https://listings.beginswithfamily.net/","liveLink":"","status":"Pending"},{"domain":"https://www.anibookmark.com/","liveLink":"https://www.anibookmark.com/user/wildwoodengine123%20.html","status":"Pending"},{"domain":"https://nearfinderau.com/en/","liveLink":"","status":"Pending"},{"domain":"https://www.trysmallbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.callupcontact.com/","liveLink":"","status":"Pending"},{"domain":"https://vymaps.com/AU/","liveLink":"","status":"Pending"},{"domain":"https://www.revealnepal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.","liveLink":"","status":"Pending"},{"domain":"https://www.surfyourtown.com/","liveLink":"","status":"Pending"},{"domain":"https://www.counselingnearme.com/","liveLink":"","status":"Pending"},{"domain":"https://www.dealerbaba.com/","liveLink":"https://www.dealerbaba.com/suppliers/automobiles-spare-parts-and-accessories/service-and-rapier-center/mobile-wildwood-m","status":"Pending"},{"domain":"https://startups.snapmunk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"","status":"Pending"},{"domain":"https://www.trueen.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistinguk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.getlisteduae.com/","liveLink":"https://www.getlisteduae.com/listings/best-cheap-small-engine-and-lawn-mower-repair-services-1","status":"Pending"},{"domain":"https://www.find-us-here.com","liveLink":"","status":"Pending"},{"domain":"https://about.me/","liveLink":"https://about.me/wsmallenginerepair/edit/emailsignature","status":"Pending"},{"domain":"https://www.startupranking.com/","liveLink":"https://www.startupranking.com/startup/wild-wood-small-engine-repair","status":"Live"},{"domain":"https://www.b2bco.com/","liveLink":"","status":"Pending"},{"domain":"https://www.youbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.d2o-global.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://1businessworld.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cataloxy.us/","liveLink":"","status":"Pending"},{"domain":"https://www.insertbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.ourbizdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bunity.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstar.org/","liveLink":"","status":"Pending"},{"domain":"https://www.242hub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistingindia.in/","liveLink":"https://www.freelistingindia.in/listings/best-cheap-small-engine-and-lawn-mower-repair-services-4","status":"Live"},{"domain":"https://www.onmap.ae/","liveLink":"https://www.onmap.ae/houston/motors-pros/lawn-mower-repair-service","status":"Pending"},{"domain":"https://groovyfreeads.com/","liveLink":"","status":"Pending"},{"domain":"https://linkz.us/","liveLink":"","status":"Pending"},{"domain":"https://alwaysdial.com/","liveLink":"","status":"Pending"},{"domain":"https://www.addonbiz.com/","liveLink":"https://www.addonbiz.com/add-your-listing/","status":"Pending"},{"domain":"http://www.surpassconnect.com/","liveLink":"","status":"Pending"},{"domain":"https://www.savenebraskalocal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.detroitbusinesscenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.boisemeridian.com/","liveLink":"","status":"Pending"},{"domain":"https://www.africanfind.com/","liveLink":"","status":"Pending"},{"domain":"http://ballarat.thelocalskinny.com/","liveLink":"","status":"Pending"},{"domain":"https://aussiestoresonline.com/","liveLink":"","status":"Pending"},{"domain":"https://catalog-australia.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trustfeed.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstorefronts.com/","liveLink":"","status":"Pending"},{"domain":"https://www.officiallyiconic.com/","liveLink":"","status":"Pending"},{"domain":"https://www.radar.directory/","liveLink":"","status":"Pending"},{"domain":"https://www.demobootstrap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.revealbusinesses.com/","liveLink":"","status":"Pending"},{"domain":"https://milestones.business/","liveLink":"","status":"Pending"},{"domain":"https://highdadirectory.com/","liveLink":"","status":"Pending"},{"domain":"http://listizze.com/","liveLink":"","status":"Pending"},{"domain":"https://www.distrilist.eu/","liveLink":"","status":"Pending"},{"domain":"https://getmedirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://heliskidirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://topdirectory1.com/","liveLink":"","status":"Pending"},{"domain":"https://www.middleeastsouk.com","liveLink":"","status":"Pending"},{"domain":"https://www.impressionsdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blacklinkus.com","liveLink":"","status":"Pending"},{"domain":"https://www.squeakafrica.com/","liveLink":"","status":"Pending"},{"domain":"https://www.myadbay.com/","liveLink":"","status":"Pending"}],"profiles":[{"domain":"https://solo.to/","liveLink":"https://solo.to/loganmitchell1290","status":"Live"},{"domain":"https://issuu.com","liveLink":"https://issuu.com/wildwoodsmallenginerepaircarmel","status":"Live"},{"domain":"https://stackoverflow.com","liveLink":"https://stackoverflow.com/users/31586319/wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.sutori.com/","liveLink":"https://www.sutori.com/en/user/logan-mitchell-b2de","status":"Live"},{"domain":"https://slideslive.com/","liveLink":"https://slideslive.com/wildwoodengine23/-/edit","status":"Live"},{"domain":"https://www.mediafire.com","liveLink":"","status":"Pending"},{"domain":"https://dev.to/","liveLink":"https://dev.to/wildwoodengine12","status":"Live"},{"domain":"https://www.pinterest.com/","liveLink":"https://www.pinterest.com/wildwoodengine123/","status":"Live"},{"domain":"https://www.quora.com/","liveLink":"https://www.quora.com/profile/Wildwood-Small-Engine-Repair-3","status":"Live"},{"domain":"https://trello.com/","liveLink":"https://trello.com/u/wildwoodsmall123","status":"Live"},{"domain":"https://www.dead.net/","liveLink":"","status":"Pending"},{"domain":"https://github.com/","liveLink":"","status":"Pending"},{"domain":"https://webflow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.coursera.org/","liveLink":"","status":"Pending"},{"domain":"https://www.discogs.com/","liveLink":"","status":"Pending"},{"domain":"https://www.wattpad.com/","liveLink":"","status":"Pending"},{"domain":"https://superuser.com/","liveLink":"","status":"Pending"},{"domain":"https://www.redbubble.com/","liveLink":"","status":"Pending"},{"domain":"https://gifyu.com/","liveLink":"","status":"Pending"},{"domain":"https://linktr.ee/","liveLink":"https://linktr.ee/wildwoodengine230","status":"Live"},{"domain":"https://www.pexels.com/","liveLink":"https://www.pexels.com/@wildwood-small-engine-repair-2156817402/","status":"Live"},{"domain":"https://archello.com/","liveLink":"https://archello.com/user/small-engine-repair-wild-wood","status":"Live"},{"domain":"https://app.slack.com/","liveLink":"https://app.slack.com/client/T09MZC421B4/C09MW15LSBF?entry_point=default_oauth","status":"Live"},{"domain":"https://pixabay.com/","liveLink":"","status":"Pending"},{"domain":"https://devpost.com/","liveLink":"","status":"Pending"},{"domain":"https://public.tableau.com/","liveLink":"","status":"Pending"},{"domain":"https://ko-fi.com/","liveLink":"","status":"Pending"},{"domain":"https://500px.com/","liveLink":"https://500px.com/p/wildwoodengine23?view=photos","status":"Live"},{"domain":"https://info.credly.com/","liveLink":"https://www.credly.com/users/wildwood-small-engine-repair.a0ed29f2/edit#credly","status":"Live"},{"domain":"https://www.evernote.com","liveLink":"","status":"Pending"},{"domain":"https://unsplash.com/","liveLink":"","status":"Pending"},{"domain":"https://www.storeboard.com/","liveLink":"","status":"Pending"},{"domain":"https://www.alignable.com/","liveLink":"","status":"Pending"},{"domain":"https://www.zillow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locanto.com.au/","liveLink":"","status":"Pending"},{"domain":"https://www.oodle.com/","liveLink":"","status":"Pending"},{"domain":"https://www.meetup.com/","liveLink":"","status":"Pending"},{"domain":"https://www.plurk.com/","liveLink":"","status":"Pending"},{"domain":"https://nextdoor.com/","liveLink":"","status":"Pending"},{"domain":"https://www.behance.net/","liveLink":"","status":"Pending"}],"guestPosts":[{"domain":"https://medium.com/","liveLink":"","status":"Pending"},{"domain":"https://www.livejournal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hashtap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blogger.com/","liveLink":"","status":"Pending"},{"domain":"https://articlebiz.com","liveLink":"","status":"Pending"},{"domain":"https://buymeacoffee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://trumpbookusa.com/","liveLink":"","status":"Pending"},{"domain":"https://printable-calendar.mn.co/","liveLink":"","status":"Pending"},{"domain":"https://substack.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hellobox.co/","liveLink":"","status":"Pending"},{"domain":"https://pinaunaeditora.com.br/","liveLink":"","status":"Pending"},{"domain":"https://1st-street.com/","liveLink":"","status":"Pending"},{"domain":"https://urrankings.com/","liveLink":"","status":"Pending"},{"domain":"https://collectionofblogs.com/","liveLink":"","status":"Pending"},{"domain":"https://doomelang.com/","liveLink":"","status":"Pending"},{"domain":"https://bdnews55.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/item/","liveLink":"","status":"Pending"},{"domain":"https://usman09.ampedpages.com/","liveLink":"","status":"Pending"},{"domain":"https://timessquarereporter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bairwaji.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/user/urban12","liveLink":"","status":"Pending"},{"domain":"https://webyourself.eu","liveLink":"","status":"Pending"}]},"Lapeer, MI":{"business":"(888) 594-5516","phone":"Lapeer, MI","citations":[{"domain":"https://www.mylifegb.com/","liveLink":"https://www.mylifegb.com/midway/automotive/only-mobile-wildwood-mower-repair-generator","status":"Live"},{"domain":"https://www.godown.town/","liveLink":"https://www.godown.town/florida/midway/place/only-mobile-wildwood-mower-repair-generator","status":"Live"},{"domain":"http://www.fsbas.com/","liveLink":"http://www.fsbas.com/wayne-county/public-services/mobile-wildwood-repair-services-mowers-generators-snow-blowers","status":"Live"},{"domain":"https://www.freelistingusa.com/","liveLink":"https://www.freelistingusa.com/listings/mobile-wildwood-repair-services-mowers-generators-snow-blowers","status":"Live"},{"domain":"https://www.911getit.com/","liveLink":"https://www.911getit.com/wayne-county/a-business-service-undefined-category-listing/mobile-wildwood-repair-services-mowe","status":"Live"},{"domain":"https://www.cargodirectory.co/","liveLink":"https://www.cargodirectory.co/wayne-county/office-equipment/wild-wood-small-engine-repair","status":"Pending"},{"domain":"http://www.golocalezservices.com/","liveLink":"","status":"Pending"},{"domain":"https://www.businesssoftwarehelp.com/","liveLink":"https://www.businesssoftwarehelp.com/wayne-county/solutioneer/wild-wood-small-engine-repair","status":"Live"},{"domain":"https://www.anibookmark.com/","liveLink":"https://www.anibookmark.com/business/quick-and-mobile-wildwood-small-engine-repair-bs409309.html","status":"Live"},{"domain":"https://www.addonbiz.com/","liveLink":"https://www.addonbiz.com/add-your-listing/#google_vignette","status":"Rejected"},{"domain":"https://www.freelistingindia.in/","liveLink":"https://www.freelistingindia.in/listings/best-cheap-small-engine-and-lawn-mower-repair-services","status":"Live"},{"domain":"https://www.onmap.ae/","liveLink":"https://www.onmap.ae/lapeer/motors-pros/mobile-wildwood-repair-services-mowers-generators-snow-blowers","status":"Live"},{"domain":"https://www.getlisteduae.com/","liveLink":"https://www.getlisteduae.com/listings/best-cheap-small-engine-and-lawn-mower-repair-services-4","status":"Live"},{"domain":"https://about.me/","liveLink":"https://about.me/wildwoods/edit/emailsignature","status":"Live"},{"domain":"https://www.startupranking.com/","liveLink":"https://www.startupranking.com/startup/wild-wood-small-engine-repair","status":"Live"},{"domain":"https://www.b2bco.com/","liveLink":"https://www.b2bco.com/wildwoodsmallenginerepair","status":"Live"},{"domain":"https://about.me/","liveLink":"https://about.me/wildwoods/edit/emailsignature","status":"Live"},{"domain":"https://nearfinderau.com/en/","liveLink":"","status":"Pending"},{"domain":"https://www.trysmallbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.callupcontact.com/","liveLink":"","status":"Pending"},{"domain":"https://vymaps.com/AU/","liveLink":"","status":"Pending"},{"domain":"https://www.revealnepal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.","liveLink":"","status":"Pending"},{"domain":"https://www.surfyourtown.com/","liveLink":"","status":"Pending"},{"domain":"https://www.counselingnearme.com/","liveLink":"","status":"Pending"},{"domain":"https://startups.snapmunk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"","status":"Pending"},{"domain":"https://www.trueen.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistinguk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.find-us-here.com","liveLink":"","status":"Pending"},{"domain":"https://www.youbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.d2o-global.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://1businessworld.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cataloxy.us/","liveLink":"","status":"Pending"},{"domain":"https://www.insertbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.ourbizdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bunity.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstar.org/","liveLink":"","status":"Pending"},{"domain":"https://www.242hub.com/","liveLink":"","status":"Pending"},{"domain":"https://au.enrollbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.directory/","liveLink":"","status":"Pending"},{"domain":"https://habeshalink.com/","liveLink":"","status":"Pending"},{"domain":"https://groovyfreeads.com/","liveLink":"","status":"Pending"},{"domain":"https://linkz.us/","liveLink":"","status":"Pending"},{"domain":"https://alwaysdial.com/","liveLink":"","status":"Pending"},{"domain":"https://www.techdirectory.io/","liveLink":"","status":"Pending"},{"domain":"https://helpsellmyfsbo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.successcenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.localhomeservicepros.com/","liveLink":"","status":"Pending"},{"domain":"http://www.surpassconnect.com/","liveLink":"","status":"Pending"},{"domain":"https://www.adlocalpages.com/","liveLink":"","status":"Pending"},{"domain":"http://ballarat.thelocalskinny.com/","liveLink":"","status":"Pending"},{"domain":"https://aussiestoresonline.com/","liveLink":"","status":"Pending"},{"domain":"https://catalog-australia.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trustfeed.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstorefronts.com/","liveLink":"","status":"Pending"},{"domain":"https://www.officiallyiconic.com/","liveLink":"","status":"Pending"},{"domain":"https://www.radar.directory/","liveLink":"","status":"Pending"},{"domain":"https://www.demobootstrap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.revealbusinesses.com/","liveLink":"","status":"Pending"},{"domain":"https://milestones.business/","liveLink":"","status":"Pending"},{"domain":"https://highdadirectory.com/","liveLink":"","status":"Pending"},{"domain":"http://listizze.com/","liveLink":"","status":"Pending"},{"domain":"https://www.distrilist.eu/","liveLink":"","status":"Pending"},{"domain":"https://getmedirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://heliskidirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://topdirectory1.com/","liveLink":"","status":"Pending"},{"domain":"https://www.middleeastsouk.com","liveLink":"","status":"Pending"},{"domain":"https://www.impressionsdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blacklinkus.com","liveLink":"","status":"Pending"},{"domain":"https://www.squeakafrica.com/","liveLink":"","status":"Pending"},{"domain":"https://www.myadbay.com/","liveLink":"","status":"Pending"}],"profiles":[{"domain":"https://www.behance.net/","liveLink":"https://www.behance.net/Wildwoodengine23","status":"Live"},{"domain":"https://stackoverflow.com","liveLink":"https://stackoverflow.com/users/31568201/wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.sutori.com/","liveLink":"https://www.sutori.com/en/user/wild-wood-small-engine-repair-c8f8","status":"Live"},{"domain":"https://dev.to/","liveLink":"https://dev.to/parker_james_17eb5f00db86","status":"Live"},{"domain":"https://www.pinterest.com/","liveLink":"https://www.pinterest.com/parkerjames20045/","status":"Live"},{"domain":"https://www.quora.com/","liveLink":"https://www.quora.com/profile/Wildwood-Small-Engine-Repair-1","status":"Live"},{"domain":"vvhttps://architizer.com/\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvvvv","liveLink":"https://architizer.com/users/parker-james/","status":"Live"},{"domain":"https://trello.com/","liveLink":"https://trello.com/u/wildwoodengine23","status":"Live"},{"domain":"https://www.coursera.org/","liveLink":"https://www.coursera.org/learner/wildwoodengine23","status":"Live"},{"domain":"https://www.discogs.com/","liveLink":"https://www.discogs.com/user/wildwoodsmall23","status":"Live"},{"domain":"https://gifyu.com/","liveLink":"https://gifyu.com/wildwoodsmall23","status":"Live"},{"domain":"https://superuser.com/","liveLink":"https://superuser.com/users/3097117/wildwood-small-engine-repair?tab=topactivity","status":"Live"},{"domain":"https://www.pexels.com/","liveLink":"https://www.pexels.com/@wild-wood-small-engine-repair-2156531654/","status":"Live"},{"domain":"https://archello.com/","liveLink":"https://archello.com/user/small-engine-repair-wild-wood-2","status":"Live"},{"domain":"https://app.slack.com/","liveLink":"https://app.slack.com/client/T09LH2V9KS8","status":"Live"},{"domain":"https://pixabay.com/","liveLink":"https://pixabay.com/users/wildwoodengine123-52709680/","status":"Live"},{"domain":"https://devpost.com/","liveLink":"https://devpost.com/wildwoodengine23?ref_content=user-portfolio&ref_feature=portfolio&ref_medium=global-nav","status":"Live"},{"domain":"https://public.tableau.com/","liveLink":"","status":"Pending"},{"domain":"https://ko-fi.com/","liveLink":"https://ko-fi.com/wildwoodengine234","status":"Live"},{"domain":"https://500px.com/","liveLink":"https://500px.com/p/wildwoodengine123?view=photos","status":"Live"},{"domain":"https://issuu.com","liveLink":"https://issuu.com/wildwoodsmallenginerepaircarmel","status":"Live"},{"domain":"https://info.credly.com/","liveLink":"https://www.credly.com/users/wild-wood-small-engine-repair.5f860a7b/edit#credly","status":"Pending"},{"domain":"https://www.evernote.com","liveLink":"","status":"Pending"},{"domain":"https://unsplash.com/","liveLink":"","status":"Pending"},{"domain":"https://www.storeboard.com/","liveLink":"","status":"Pending"},{"domain":"https://www.alignable.com/","liveLink":"","status":"Pending"},{"domain":"https://www.zillow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locanto.com.au/","liveLink":"","status":"Pending"},{"domain":"https://www.oodle.com/","liveLink":"","status":"Pending"},{"domain":"https://www.meetup.com/","liveLink":"https://www.meetup.com/home/?memberId=477083777&track=fromWelcome","status":"Pending"},{"domain":"https://www.plurk.com/","liveLink":"","status":"Pending"},{"domain":"https://nextdoor.com/","liveLink":"","status":"Pending"},{"domain":"https://solo.to/","liveLink":"https://solo.to/wildwoodenginerepair","status":"Pending"},{"domain":"https://www.mediafire.com","liveLink":"","status":"Pending"},{"domain":"https://slideslive.com/","liveLink":"","status":"Pending"},{"domain":"https://www.dead.net/","liveLink":"","status":"Pending"},{"domain":"https://webflow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.wattpad.com/","liveLink":"","status":"Pending"},{"domain":"https://www.redbubble.com/","liveLink":"","status":"Pending"},{"domain":"https://linktr.ee/","liveLink":"https://linktr.ee/wildwoodengine234","status":"Live"}],"guestPosts":[{"domain":"https://medium.com/","liveLink":"","status":"Pending"},{"domain":"https://www.livejournal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hashtap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blogger.com/","liveLink":"","status":"Pending"},{"domain":"https://articlebiz.com","liveLink":"","status":"Pending"},{"domain":"https://buymeacoffee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://trumpbookusa.com/","liveLink":"","status":"Pending"},{"domain":"https://printable-calendar.mn.co/","liveLink":"","status":"Pending"},{"domain":"https://substack.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hellobox.co/","liveLink":"","status":"Pending"},{"domain":"https://pinaunaeditora.com.br/","liveLink":"","status":"Pending"},{"domain":"https://1st-street.com/","liveLink":"","status":"Pending"},{"domain":"https://urrankings.com/","liveLink":"","status":"Pending"},{"domain":"https://collectionofblogs.com/","liveLink":"","status":"Pending"},{"domain":"https://doomelang.com/","liveLink":"","status":"Pending"},{"domain":"https://bdnews55.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/item/","liveLink":"","status":"Pending"},{"domain":"https://usman09.ampedpages.com/","liveLink":"","status":"Pending"},{"domain":"https://timessquarereporter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bairwaji.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/user/urban12","liveLink":"","status":"Pending"},{"domain":"https://webyourself.eu","liveLink":"","status":"Pending"}]},"Lee's Summit, MO":{"business":"Quick and Mobile Wildwood Small Engine Repair","phone":"(816) 837-4480","citations":[{"domain":"https://www.mylifegb.com/","liveLink":"https://www.mylifegb.com/lee-s-summit/automotive/quick-and-mobile-wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.godown.town/","liveLink":"https://www.godown.town/lee-s-summit/place/quick-and-mobile-wildwood-small-engine-repair","status":"Live"},{"domain":"http://www.fsbas.com/","liveLink":"http://www.fsbas.com/united-states/lee-s-summit/financial-services/quick-and-mobile-wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.freelistingusa.com/","liveLink":"https://www.freelistingusa.com/listings/quick-and-mobile-wildwood-small-engine-repair-2","status":"Live"},{"domain":"https://www.911getit.com/","liveLink":"https://www.911getit.com/united-states/lee-s-summit/a-business-service-undefined-category-listing/quick-and-mobile-wildw","status":"Live"},{"domain":"https://www.cargodirectory.co/","liveLink":"https://www.cargodirectory.co/lee-s-summit/suppliers-of-cargo-products-services/quick-and-mobile-wildwood-small-engine-r","status":"Live"},{"domain":"http://www.golocalezservices.com/","liveLink":"https://www.golocalezservices.com/lee-s-summit/automotive/quick-and-mobile-wildwood-small-engine-repair","status":"Live"},{"domain":"https://architizer.com/","liveLink":"https://architizer.com/users/james-walker-5/","status":"Live"},{"domain":"https://vymaps.com/AU/","liveLink":"https://vymaps.com/US/Quick-And-Mobile-Wildwood-Small-Engine-Repair-VN130221/?id_new=01e0ed0f4e52991a60df351690b56339","status":"Live"},{"domain":"https://www.successcenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistingindia.in/","liveLink":"https://www.freelistingindia.in/listings/best-cheap-small-engine-and-lawn-mower-repair-services-3","status":"Live"},{"domain":"https://www.onmap.ae/","liveLink":"https://www.onmap.ae/lee-s-summit/motors-pros/quick-and-mobile-wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.getlisteduae.com/","liveLink":"https://www.getlisteduae.com/listings/best-cheap-small-engine-and-lawn-mower-repair-services-2","status":"Live"},{"domain":"https://www.addonbiz.com/","liveLink":"https://www.addonbiz.com/add-your-listing/","status":"Live"},{"domain":"https://about.me/","liveLink":"https://about.me/wildwoods1/edit/emailsignature","status":"Live"},{"domain":"https://www.startupranking.com/","liveLink":"https://www.startupranking.com/startup/wild-wood-small-engine-repair","status":"Live"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"https://www.bizmakersamerica.org/lee-s-summit/professional-services/quick-and-mobile-wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.anibookmark.com/","liveLink":"https://www.anibookmark.com/business/quick-and-mobile-wildwood-small-engine-repair-bs409309.html","status":"Live"},{"domain":"https://nearfinderau.com/en/","liveLink":"https://nearfinderau.com/en/empresa/cad2","status":"Live"},{"domain":"https://www.counselingnearme.com/","liveLink":"https://www.callupcontact.com/main/internaledit.php?cid=3342867","status":"Live"},{"domain":"https://helpsellmyfsbo.com/","liveLink":"https://helpsellmyfsbo.com/lee-s-summit/wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.dealerbaba.com/","liveLink":"https://www.dealerbaba.com/suppliers/security-systems-services/quick-and-mobile-wildwood-small-engine-repair-1.html","status":"Live"},{"domain":"https://www.b2bco.com/","liveLink":"https://www.b2bco.com/wildwoodsmallenginerepair","status":"Live"},{"domain":"https://www.businesssoftwarehelp.com/","liveLink":"https://www.businesssoftwarehelp.com/lee-s-summit/solutioneer/wild-wood-small-engine-repair","status":"Live"},{"domain":"https://www.cybo.com/","liveLink":"https://www.cybo.com/US-biz/quick-and-mobile-wildwood-small-engine_20","status":"Live"},{"domain":"https://www.hotfrog.com/","liveLink":"https://www.hotfrog.com/company/49caec73c9b2781f7d1839e488e70276/quick-and-mobile-wildwood-small-engine-repair/lee-s-sum","status":"Live"},{"domain":"http://ballarat.thelocalskinny.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trysmallbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.savenebraskalocal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.localhomeservicepros.com/","liveLink":"","status":"Pending"},{"domain":"https://www.detroitbusinesscenter.com/","liveLink":"","status":"Pending"},{"domain":"http://www.surpassconnect.com/","liveLink":"","status":"Pending"},{"domain":"https://www.boisemeridian.com/","liveLink":"","status":"Pending"},{"domain":"https://www.nextbizmaker.com/","liveLink":"","status":"Pending"},{"domain":"https://au.enrollbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://www.adlocalpages.com/","liveLink":"","status":"Pending"},{"domain":"http://www.askjaynee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.directory/","liveLink":"","status":"Pending"},{"domain":"https://www.africanfind.com/","liveLink":"","status":"Pending"},{"domain":"https://habeshalink.com/","liveLink":"","status":"Pending"},{"domain":"https://listings.beginswithfamily.net/","liveLink":"","status":"Pending"},{"domain":"https://www.callupcontact.com/","liveLink":"","status":"Pending"},{"domain":"https://aussiestoresonline.com/","liveLink":"","status":"Pending"},{"domain":"https://catalog-australia.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trustfeed.com/","liveLink":"","status":"Pending"},{"domain":"https://www.techdirectory.io/","liveLink":"","status":"Pending"},{"domain":"https://www.revealnepal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.impressionsdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.","liveLink":"","status":"Pending"},{"domain":"https://www.surfyourtown.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstorefronts.com/","liveLink":"","status":"Pending"},{"domain":"https://startups.snapmunk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blacklinkus.com","liveLink":"","status":"Pending"},{"domain":"https://www.trueen.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/bunbury-wa/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistinguk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.find-us-here.com","liveLink":"","status":"Pending"},{"domain":"https://www.squeakafrica.com/","liveLink":"","status":"Pending"},{"domain":"https://www.myadbay.com/bunbury-wa/professional-services/urban-self-storage","liveLink":"","status":"Pending"},{"domain":"https://www.youbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.d2o-global.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://www.officiallyiconic.com/","liveLink":"","status":"Pending"},{"domain":"https://www.radar.directory/","liveLink":"","status":"Pending"},{"domain":"https://1businessworld.com/","liveLink":"","status":"Pending"},{"domain":"https://www.demobootstrap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cataloxy.us/","liveLink":"","status":"Pending"},{"domain":"https://www.insertbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.revealbusinesses.com/","liveLink":"","status":"Pending"},{"domain":"https://www.ourbizdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://milestones.business/","liveLink":"","status":"Pending"},{"domain":"https://www.bunity.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstar.org/","liveLink":"","status":"Pending"},{"domain":"https://www.242hub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.distrilist.eu/","liveLink":"","status":"Pending"},{"domain":"https://highdadirectory.com/","liveLink":"","status":"Pending"},{"domain":"http://listizze.com/","liveLink":"","status":"Pending"},{"domain":"https://getmedirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://groovyfreeads.com/","liveLink":"","status":"Pending"},{"domain":"https://heliskidirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://topdirectory1.com/","liveLink":"","status":"Pending"},{"domain":"https://linkz.us/","liveLink":"","status":"Pending"},{"domain":"https://www.middleeastsouk.com","liveLink":"","status":"Pending"},{"domain":"https://alwaysdial.com/","liveLink":"","status":"Pending"}],"profiles":[{"domain":"https://solo.to/","liveLink":"https://solo.to/jameswalker128918","status":"Live"},{"domain":"https://stackoverflow.com","liveLink":"https://stackoverflow.com/users/31583173/wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.sutori.com/","liveLink":"https://www.sutori.com/en/user/james-walker-12db?tab=profile","status":"Live"},{"domain":"https://slideslive.com/","liveLink":"https://slideslive.com/wildwoodsmallengine23/","status":"Live"},{"domain":"https://dev.to/","liveLink":"https://dev.to/wildwoodsmallengine23","status":"Live"},{"domain":"https://www.pinterest.com/","liveLink":"https://www.pinterest.com/jameswalker128918/","status":"Live"},{"domain":"https://webflow.com/","liveLink":"https://wildwood-small-engine-repair.design.webflow.com/","status":"Live"},{"domain":"https://issuu.com","liveLink":"https://issuu.com/wildwoodsmallenginerepaircarmel","status":"Live"},{"domain":"https://www.bizcommunity.com/","liveLink":"https://www.bizcommunity.com/MyProfile.aspx","status":"Pending"},{"domain":"https://home.atlassian.com/","liveLink":"https://id.atlassian.com/manage-profile/profile-and-visibility","status":"Live"},{"domain":"https://linktr.ee/","liveLink":"https://linktr.ee/wildwoodengine23","status":"Live"},{"domain":"https://www.discogs.com/","liveLink":"https://www.discogs.com/user/wildwoodengine23","status":"Live"},{"domain":"https://superuser.com/","liveLink":"https://superuser.com/users/3096980/wildwood-small-engine-repair","status":"Live"},{"domain":"https://gifyu.com/","liveLink":"https://gifyu.com/wildwoodengine23","status":"Live"},{"domain":"https://www.pexels.com/","liveLink":"https://www.pexels.com/@wildwood-small-engine-repair-2156527174/","status":"Live"},{"domain":"https://archello.com/","liveLink":"https://archello.com/user/small-engine-repair-wild-wood","status":"Live"},{"domain":"https://pixabay.com/","liveLink":"https://pixabay.com/users/wildwoodengine23-52707035/","status":"Live"},{"domain":"https://devpost.com/","liveLink":"https://devpost.com/wildwood230?ref_content=user-portfolio&ref_feature=portfolio&ref_medium=global-nav","status":"Live"},{"domain":"https://ko-fi.com/","liveLink":"https://ko-fi.com/wildwoodengine23","status":"Live"},{"domain":"https://500px.com/","liveLink":"https://500px.com/p/wildwoodsmall230?view=photos","status":"Live"},{"domain":"https://info.credly.com/","liveLink":"https://www.credly.com/users/wildwood-small-engine-repair/edit#credly","status":"Live"},{"domain":"https://app.slack.com/","liveLink":"https://app.slack.com/client/T09N2UNLZKN/C09MJ0VK9SB?entry_point=default_oauth&_gl=1%2Aayjjrd%2A_gcl_au%2AMTI2MTY1MTg3NS","status":"Live"},{"domain":"https://www.evernote.com","liveLink":"","status":"Pending"},{"domain":"https://unsplash.com/","liveLink":"","status":"Pending"},{"domain":"https://www.storeboard.com/","liveLink":"","status":"Pending"},{"domain":"https://www.alignable.com/","liveLink":"","status":"Pending"},{"domain":"https://www.zillow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locanto.com.au/","liveLink":"","status":"Pending"},{"domain":"https://www.oodle.com/","liveLink":"","status":"Pending"},{"domain":"https://www.meetup.com/","liveLink":"","status":"Pending"},{"domain":"https://www.plurk.com/","liveLink":"","status":"Pending"},{"domain":"https://nextdoor.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"","status":"Pending"},{"domain":"https://www.behance.net/","liveLink":"","status":"Pending"},{"domain":"https://www.mediafire.com","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://os.mbed.com/","liveLink":"","status":"Pending"},{"domain":"https://trello.com/","liveLink":"","status":"Pending"},{"domain":"https://www.dead.net/","liveLink":"","status":"Pending"},{"domain":"https://github.com/","liveLink":"","status":"Pending"},{"domain":"https://www.mapquest.com/","liveLink":"","status":"Pending"}],"guestPosts":[{"domain":"https://medium.com/","liveLink":"","status":"Pending"},{"domain":"https://www.livejournal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hashtap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blogger.com/","liveLink":"","status":"Pending"},{"domain":"https://articlebiz.com","liveLink":"","status":"Pending"},{"domain":"https://buymeacoffee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://trumpbookusa.com/","liveLink":"","status":"Pending"},{"domain":"https://printable-calendar.mn.co/","liveLink":"","status":"Pending"},{"domain":"https://substack.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hellobox.co/","liveLink":"","status":"Pending"},{"domain":"https://pinaunaeditora.com.br/","liveLink":"","status":"Pending"},{"domain":"https://1st-street.com/","liveLink":"","status":"Pending"},{"domain":"https://urrankings.com/","liveLink":"","status":"Pending"},{"domain":"https://collectionofblogs.com/","liveLink":"","status":"Pending"},{"domain":"https://doomelang.com/","liveLink":"","status":"Pending"},{"domain":"https://bdnews55.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/item/","liveLink":"","status":"Pending"},{"domain":"https://usman09.ampedpages.com/","liveLink":"","status":"Pending"},{"domain":"https://timessquarereporter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bairwaji.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/user/urban12","liveLink":"","status":"Pending"},{"domain":"https://webyourself.eu","liveLink":"","status":"Pending"}]},"Reno, NV":{"business":"Mobile Wildwood Mower Repair / Snow Blower","phone":"(775) 526-2933","citations":[{"domain":"https://www.mylifegb.com/","liveLink":"https://www.mylifegb.com/united-states/reno/automotive/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.godown.town/","liveLink":"https://www.godown.town/nevada/reno/place/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"http://www.fsbas.com/","liveLink":"https://www.smartbusinesspage.com/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.freelistingusa.com/","liveLink":"https://www.freelistingusa.com/listings/mobile-wildwood-mower-repair-snow-blower-1","status":"Live"},{"domain":"https://www.911getit.com/","liveLink":"https://www.911getit.com/united-states/reno/a-business-service-undefined-category-listing/mobile-wildwood-mower-repair-s","status":"Live"},{"domain":"http://www.golocalezservices.com/","liveLink":"https://www.golocalezservices.com/automotive/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.techdirectory.io/","liveLink":"https://www.techdirectory.io/professional-services/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.cargodirectory.co/","liveLink":"","status":"Pending"},{"domain":"https://helpsellmyfsbo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.localhomeservicepros.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistinguk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.getlisteduae.com/","liveLink":"","status":"Pending"},{"domain":"https://www.youbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.nextbizmaker.com/","liveLink":"","status":"Pending"},{"domain":"https://www.businesssoftwarehelp.com/","liveLink":"","status":"Pending"},{"domain":"https://www.successcenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.revealnepal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.directory/","liveLink":"","status":"Pending"},{"domain":"https://habeshalink.com/","liveLink":"","status":"Pending"},{"domain":"https://listings.beginswithfamily.net/","liveLink":"","status":"Pending"},{"domain":"https://www.anibookmark.com/","liveLink":"","status":"Pending"},{"domain":"https://nearfinderau.com/en/","liveLink":"","status":"Pending"},{"domain":"https://www.trysmallbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.callupcontact.com/","liveLink":"","status":"Pending"},{"domain":"https://vymaps.com/AU/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.","liveLink":"","status":"Pending"},{"domain":"https://www.surfyourtown.com/","liveLink":"","status":"Pending"},{"domain":"https://www.counselingnearme.com/","liveLink":"","status":"Pending"},{"domain":"https://www.dealerbaba.com/","liveLink":"","status":"Pending"},{"domain":"https://startups.snapmunk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trueen.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://www.startupranking.com/","liveLink":"","status":"Pending"},{"domain":"https://www.b2bco.com/","liveLink":"","status":"Pending"},{"domain":"https://www.d2o-global.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://1businessworld.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cataloxy.us/","liveLink":"","status":"Pending"},{"domain":"https://www.insertbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.ourbizdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bunity.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstar.org/","liveLink":"","status":"Pending"},{"domain":"https://www.242hub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistingindia.in/","liveLink":"","status":"Pending"},{"domain":"https://www.onmap.ae/","liveLink":"","status":"Pending"},{"domain":"https://groovyfreeads.com/","liveLink":"","status":"Pending"},{"domain":"https://linkz.us/","liveLink":"","status":"Pending"},{"domain":"https://alwaysdial.com/","liveLink":"","status":"Pending"},{"domain":"https://www.addonbiz.com/","liveLink":"","status":"Pending"},{"domain":"http://www.surpassconnect.com/","liveLink":"","status":"Pending"},{"domain":"https://www.adlocalpages.com/","liveLink":"","status":"Pending"},{"domain":"http://www.askjaynee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"}],"profiles":[],"guestPosts":[{"domain":"https://medium.com/","liveLink":"","status":"Pending"},{"domain":"https://www.livejournal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hashtap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blogger.com/","liveLink":"","status":"Pending"},{"domain":"https://articlebiz.com","liveLink":"","status":"Pending"},{"domain":"https://buymeacoffee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://trumpbookusa.com/","liveLink":"","status":"Pending"},{"domain":"https://printable-calendar.mn.co/","liveLink":"","status":"Pending"},{"domain":"https://substack.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hellobox.co/","liveLink":"","status":"Pending"},{"domain":"https://pinaunaeditora.com.br/","liveLink":"","status":"Pending"},{"domain":"https://1st-street.com/","liveLink":"","status":"Pending"},{"domain":"https://urrankings.com/","liveLink":"","status":"Pending"},{"domain":"https://collectionofblogs.com/","liveLink":"","status":"Pending"},{"domain":"https://doomelang.com/","liveLink":"","status":"Pending"},{"domain":"https://bdnews55.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/item/","liveLink":"","status":"Pending"},{"domain":"https://usman09.ampedpages.com/","liveLink":"","status":"Pending"},{"domain":"https://timessquarereporter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bairwaji.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/user/urban12","liveLink":"","status":"Pending"},{"domain":"https://webyourself.eu","liveLink":"","status":"Pending"}]},"Sarasota, FL":{"business":"Mobile Wildwood Mower Repair / Generator SRQ","phone":"(941) 273-8085","citations":[{"domain":"https://www.mylifegb.com/","liveLink":"https://www.mylifegb.com/tampa/automotive/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://www.godown.town/","liveLink":"https://www.godown.town/tampa/place/wild-wood-small-engine-repair","status":"Pending"},{"domain":"http://www.fsbas.com/","liveLink":"http://www.fsbas.com/tampa/home-services/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://www.freelistingusa.com/","liveLink":"https://www.freelistingusa.com/listings/mobile-wildwood-mower-repair-generator-srq","status":"Pending"},{"domain":"https://www.911getit.com/","liveLink":"https://www.911getit.com/tampa/auto-repair-service/wild-wood-small-engine-repair-services","status":"Pending"},{"domain":"https://www.cargodirectory.co/","liveLink":"https://www.cargodirectory.co/tampa/aircraft-equipment/wild-wood-small-engine-repair","status":"Pending"},{"domain":"http://www.golocalezservices.com/","liveLink":"https://www.golocalezservices.com/tampa/automotive/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://www.techdirectory.io/","liveLink":"https://www.techdirectory.io/tampa/automotive/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://helpsellmyfsbo.com/","liveLink":"https://helpsellmyfsbo.com/tampa/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://www.localhomeservicepros.com/","liveLink":"https://www.localhomeservicepros.com/tampa/appliance-repair/wildwood-small-engine-repair","status":"Pending"},{"domain":"https://www.anibookmark.com/","liveLink":"https://www.anibookmark.com/user/wildwoodsmallengine1.html","status":"Pending"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"https://www.bizmakersamerica.org/tampa/other/wildwood-small-engine-repair","status":"Pending"},{"domain":"https://www.revealnepal.com/","liveLink":"https://www.revealnepal.com/?post_type=listing&p=50372","status":"Pending"},{"domain":"https://www.freelistinguk.com/","liveLink":"https://www.freelistinguk.com/listings/mobile-wildwood-mower-repair-generator-srq-1","status":"Pending"},{"domain":"https://www.getlisteduae.com/","liveLink":"https://www.getlisteduae.com/listings/mobile-wildwood-mower-repair-generator-srq","status":"Pending"},{"domain":"https://www.youbiz.com/","liveLink":"https://www.youbiz.com/sponsors/listing/listing.php?id=198640","status":"Pending"},{"domain":"https://www.dealerbaba.com/","liveLink":"","status":"Pending"},{"domain":"http://www.askjaynee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.nextbizmaker.com/","liveLink":"","status":"Pending"},{"domain":"https://www.businesssoftwarehelp.com/","liveLink":"","status":"Pending"},{"domain":"https://habeshalink.com/","liveLink":"","status":"Pending"},{"domain":"https://nearfinderau.com/en/","liveLink":"","status":"Pending"},{"domain":"https://www.trysmallbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.callupcontact.com/","liveLink":"","status":"Pending"},{"domain":"https://vymaps.com/AU/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.","liveLink":"","status":"Pending"},{"domain":"https://www.surfyourtown.com/","liveLink":"","status":"Pending"},{"domain":"https://www.counselingnearme.com/","liveLink":"","status":"Pending"},{"domain":"https://startups.snapmunk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trueen.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://about.me/","liveLink":"","status":"Pending"},{"domain":"https://www.startupranking.com/","liveLink":"","status":"Pending"},{"domain":"https://www.b2bco.com/","liveLink":"","status":"Pending"},{"domain":"https://www.d2o-global.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://1businessworld.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cataloxy.us/","liveLink":"","status":"Pending"},{"domain":"https://www.insertbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.ourbizdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bunity.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstar.org/","liveLink":"","status":"Pending"},{"domain":"https://www.242hub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistingindia.in/","liveLink":"","status":"Pending"},{"domain":"https://www.onmap.ae/","liveLink":"","status":"Pending"},{"domain":"https://groovyfreeads.com/","liveLink":"","status":"Pending"},{"domain":"https://linkz.us/","liveLink":"","status":"Pending"},{"domain":"https://alwaysdial.com/","liveLink":"","status":"Pending"},{"domain":"https://www.addonbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.successcenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.savenebraskalocal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.detroitbusinesscenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.boisemeridian.com/","liveLink":"","status":"Pending"},{"domain":"https://www.africanfind.com/","liveLink":"","status":"Pending"},{"domain":"http://ballarat.thelocalskinny.com/","liveLink":"","status":"Pending"},{"domain":"https://aussiestoresonline.com/","liveLink":"","status":"Pending"},{"domain":"https://catalog-australia.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trustfeed.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstorefronts.com/","liveLink":"","status":"Pending"},{"domain":"https://www.officiallyiconic.com/","liveLink":"","status":"Pending"},{"domain":"https://www.radar.directory/","liveLink":"","status":"Pending"},{"domain":"https://www.demobootstrap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.revealbusinesses.com/","liveLink":"","status":"Pending"},{"domain":"https://milestones.business/","liveLink":"","status":"Pending"},{"domain":"https://highdadirectory.com/","liveLink":"","status":"Pending"},{"domain":"http://listizze.com/","liveLink":"","status":"Pending"},{"domain":"https://www.distrilist.eu/","liveLink":"","status":"Pending"},{"domain":"https://getmedirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://heliskidirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://topdirectory1.com/","liveLink":"","status":"Pending"},{"domain":"https://www.middleeastsouk.com","liveLink":"","status":"Pending"},{"domain":"https://www.impressionsdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blacklinkus.com","liveLink":"","status":"Pending"},{"domain":"https://www.squeakafrica.com/","liveLink":"","status":"Pending"},{"domain":"https://www.myadbay.com/","liveLink":"","status":"Pending"},{"domain":"https://www.adlocalpages.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"}],"profiles":[{"domain":"https://solo.to/","liveLink":"https://solo.to/wildwoodsmallengine2","status":"Pending"},{"domain":"https://www.behance.net/","liveLink":"https://www.behance.net/oliviamartinez25","status":"Pending"},{"domain":"https://stackoverflow.com","liveLink":"https://stackoverflow.com/users/31572181/wildwood-small-engine","status":"Pending"},{"domain":"https://www.sutori.com/","liveLink":"https://www.sutori.com/en/user/olivia-martinez-14d8?tab=profile","status":"Pending"},{"domain":"https://slideslive.com/","liveLink":"https://slideslive.com/wildwoodsmallenginerepair","status":"Pending"},{"domain":"https://dev.to/","liveLink":"https://dev.to/wildwoodsmallenginerepair14","status":"Pending"},{"domain":"https://www.pinterest.com/","liveLink":"https://www.pinterest.com/wildwoodsmallenginerepair15/","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"https://www.quora.com/profile/Olivia-Martinez-734/log","status":"Pending"},{"domain":"https://os.mbed.com/","liveLink":"https://os.mbed.com/users/wildwoodsmallengine1/","status":"Pending"},{"domain":"https://trello.com/","liveLink":"https://trello.com/u/wildwoodsmallenginerepair16/profile","status":"Pending"},{"domain":"https://github.com/","liveLink":"https://github.com/wildwoodsmallengine19","status":"Pending"},{"domain":"https://webflow.com/","liveLink":"https://webflow.com/@wildwoodsmallenginerepair","status":"Pending"},{"domain":"https://www.mediafire.com","liveLink":"","status":"Pending"},{"domain":"https://www.dead.net/","liveLink":"","status":"Pending"},{"domain":"https://www.wattpad.com/","liveLink":"","status":"Pending"},{"domain":"https://superuser.com/","liveLink":"https://superuser.com/users/3108341/wildwood-small-engine","status":"Pending"},{"domain":"https://www.redbubble.com/","liveLink":"","status":"Pending"},{"domain":"https://gifyu.com/","liveLink":"https://gifyu.com/image/b3wba","status":"Pending"},{"domain":"https://linktr.ee/","liveLink":"","status":"Pending"},{"domain":"https://www.pexels.com/","liveLink":"","status":"Pending"},{"domain":"https://archello.com/","liveLink":"","status":"Pending"},{"domain":"https://app.slack.com/","liveLink":"","status":"Pending"},{"domain":"https://pixabay.com/","liveLink":"","status":"Pending"},{"domain":"https://public.tableau.com/","liveLink":"","status":"Pending"},{"domain":"https://ko-fi.com/","liveLink":"","status":"Pending"},{"domain":"https://500px.com/","liveLink":"","status":"Pending"},{"domain":"https://issuu.com","liveLink":"","status":"Pending"},{"domain":"https://info.credly.com/","liveLink":"","status":"Pending"},{"domain":"https://www.evernote.com","liveLink":"","status":"Pending"},{"domain":"https://unsplash.com/","liveLink":"","status":"Pending"},{"domain":"https://www.storeboard.com/","liveLink":"","status":"Pending"},{"domain":"https://www.alignable.com/","liveLink":"","status":"Pending"},{"domain":"https://www.zillow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locanto.com.au/","liveLink":"","status":"Pending"},{"domain":"https://www.oodle.com/","liveLink":"","status":"Pending"},{"domain":"https://www.meetup.com/","liveLink":"","status":"Pending"},{"domain":"https://www.plurk.com/","liveLink":"","status":"Pending"},{"domain":"https://nextdoor.com/","liveLink":"","status":"Pending"},{"domain":"https://www.coursera.org/","liveLink":"","status":"Pending"},{"domain":"https://www.discogs.com/","liveLink":"","status":"Pending"}],"guestPosts":[{"domain":"https://medium.com/","liveLink":"","status":"Pending"},{"domain":"https://www.livejournal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hashtap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blogger.com/","liveLink":"","status":"Pending"},{"domain":"https://articlebiz.com","liveLink":"","status":"Pending"},{"domain":"https://buymeacoffee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://trumpbookusa.com/","liveLink":"","status":"Pending"},{"domain":"https://printable-calendar.mn.co/","liveLink":"","status":"Pending"},{"domain":"https://substack.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hellobox.co/","liveLink":"","status":"Pending"},{"domain":"https://pinaunaeditora.com.br/","liveLink":"","status":"Pending"},{"domain":"https://1st-street.com/","liveLink":"","status":"Pending"},{"domain":"https://urrankings.com/","liveLink":"","status":"Pending"},{"domain":"https://collectionofblogs.com/","liveLink":"","status":"Pending"},{"domain":"https://doomelang.com/","liveLink":"","status":"Pending"},{"domain":"https://bdnews55.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/item/","liveLink":"","status":"Pending"},{"domain":"https://usman09.ampedpages.com/","liveLink":"","status":"Pending"},{"domain":"https://timessquarereporter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bairwaji.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/user/urban12","liveLink":"","status":"Pending"},{"domain":"https://webyourself.eu","liveLink":"","status":"Pending"}]},"Sioux Falls, SD (1)":{"business":"Mobile Wildwood Mower Repair / Snow Blower","phone":"(605) 657-6487","citations":[{"domain":"https://www.mylifegb.com/","liveLink":"https://www.mylifegb.com/united-states/sioux-falls/public-services/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.godown.town/","liveLink":"https://www.godown.town/sioux-falls/place/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"http://www.fsbas.com/","liveLink":"http://www.fsbas.com/united-states/sioux-falls/professional-services/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.freelistingusa.com/","liveLink":"https://www.freelistingusa.com/listings/mobile-wildwood-mower-repair-snow-blower#google_vignette","status":"Live"},{"domain":"https://www.911getit.com/","liveLink":"https://www.911getit.com/united-states/sioux-falls/a-business-service-undefined-category-listing/mobile-wildwood-mower-r","status":"Live"},{"domain":"https://www.cargodirectory.co/","liveLink":"https://www.cargodirectory.co/sioux-falls/office-equipment/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"http://www.golocalezservices.com/","liveLink":"https://www.golocalezservices.com/sioux-falls/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.freelistingindia.in/","liveLink":"https://www.freelistingindia.in/listings/best-cheap-small-engine-and-lawn-mower-repair-services-2","status":"Live"},{"domain":"https://www.onmap.ae/","liveLink":"https://www.onmap.ae/sioux-falls/motors-pros/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.businesssoftwarehelp.com/","liveLink":"https://www.businesssoftwarehelp.com/sioux-falls/solutioneer/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.anibookmark.com/","liveLink":"https://www.anibookmark.com/business/quick-and-mobile-wildwood-small-engine-repair-bs409309.html","status":"Live"},{"domain":"https://www.dealerbaba.com/","liveLink":"https://www.dealerbaba.com/suppliers/others/mobile-wildwood-mower-repair-snow-blower.html","status":"Live"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"https://www.bizmakersamerica.org/sioux-falls/professional-services/mobile-wildwood-mower-repair-snow-blower","status":"Live"},{"domain":"https://www.cybo.com/","liveLink":"https://www.cybo.com/US-biz/mobile-wildwood-mower-repair-snow","status":"Live"},{"domain":"https://www.freelistinguk.com/","liveLink":"https://www.freelistinguk.com/listings/best-cheap-small-engine-and-lawn-mower-repair-services-1","status":"Live"},{"domain":"https://www.getlisteduae.com/","liveLink":"https://www.getlisteduae.com/listings/best-cheap-small-engine-and-lawn-mower-repair-services-3","status":"Live"},{"domain":"https://about.me/","liveLink":"https://about.me/wildwood.smallenginerepair/edit/emailsignature","status":"Live"},{"domain":"https://www.startupranking.com/","liveLink":"https://www.startupranking.com/startup/edit-options/wild-wood-small-engine-repair","status":"Live"},{"domain":"https://www.b2bco.com/","liveLink":"https://www.b2bco.com/wildwoodsmallenginerepair","status":"Live"},{"domain":"https://www.hotfrog.com/","liveLink":"https://www.hotfrog.com/company/9cf54c7b68519406c5a27e376a8f703f/mobile-wildwood-mower-repair-snow-blower/sioux-falls/au","status":"Live"},{"domain":"https://groovyfreeads.com/","liveLink":"","status":"Pending"},{"domain":"https://linkz.us/","liveLink":"","status":"Pending"},{"domain":"https://alwaysdial.com/","liveLink":"","status":"Pending"},{"domain":"https://www.addonbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.mapquest.com/","liveLink":"","status":"Pending"},{"domain":"https://www.successcenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.localhomeservicepros.com/","liveLink":"","status":"Pending"},{"domain":"http://www.surpassconnect.com/","liveLink":"","status":"Pending"},{"domain":"https://www.adlocalpages.com/","liveLink":"","status":"Pending"},{"domain":"http://www.askjaynee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.nextbizmaker.com/","liveLink":"","status":"Pending"},{"domain":"https://au.enrollbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.directory/","liveLink":"","status":"Pending"},{"domain":"https://habeshalink.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trueen.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"https://nearfinderau.com/en/","liveLink":"","status":"Pending"},{"domain":"https://www.trysmallbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://www.callupcontact.com/","liveLink":"","status":"Pending"},{"domain":"https://vymaps.com/AU/","liveLink":"","status":"Pending"},{"domain":"https://www.revealnepal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.","liveLink":"","status":"Pending"},{"domain":"https://www.surfyourtown.com/","liveLink":"","status":"Pending"},{"domain":"https://www.counselingnearme.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://startups.snapmunk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.find-us-here.com","liveLink":"","status":"Pending"},{"domain":"https://www.youbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.d2o-global.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://1businessworld.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cataloxy.us/","liveLink":"","status":"Pending"},{"domain":"https://www.insertbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.ourbizdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bunity.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstar.org/","liveLink":"","status":"Pending"},{"domain":"https://www.242hub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.savenebraskalocal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.detroitbusinesscenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.boisemeridian.com/","liveLink":"","status":"Pending"},{"domain":"https://www.africanfind.com/","liveLink":"","status":"Pending"},{"domain":"http://ballarat.thelocalskinny.com/","liveLink":"","status":"Pending"},{"domain":"https://aussiestoresonline.com/","liveLink":"","status":"Pending"},{"domain":"https://catalog-australia.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trustfeed.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstorefronts.com/","liveLink":"","status":"Pending"},{"domain":"https://www.officiallyiconic.com/","liveLink":"","status":"Pending"},{"domain":"https://www.radar.directory/","liveLink":"","status":"Pending"},{"domain":"https://www.demobootstrap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.revealbusinesses.com/","liveLink":"","status":"Pending"},{"domain":"https://milestones.business/","liveLink":"","status":"Pending"},{"domain":"https://highdadirectory.com/","liveLink":"","status":"Pending"},{"domain":"http://listizze.com/","liveLink":"","status":"Pending"},{"domain":"https://www.distrilist.eu/","liveLink":"","status":"Pending"},{"domain":"https://getmedirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://heliskidirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://topdirectory1.com/","liveLink":"","status":"Pending"},{"domain":"https://www.middleeastsouk.com","liveLink":"","status":"Pending"},{"domain":"https://www.impressionsdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blacklinkus.com","liveLink":"","status":"Pending"},{"domain":"https://www.squeakafrica.com/","liveLink":"","status":"Pending"},{"domain":"https://www.myadbay.com/","liveLink":"","status":"Pending"},{"domain":"https://listings.beginswithfamily.net/","liveLink":"","status":"Pending"}],"profiles":[{"domain":"https://solo.to/","liveLink":"https://solo.to/wildwoodsmallenginer","status":"Live"},{"domain":"https://www.behance.net/","liveLink":"https://www.behance.net/wildwoodengine123","status":"Live"},{"domain":"https://stackoverflow.com","liveLink":"https://stackoverflow.com/users/31588405/wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.sutori.com/","liveLink":"https://www.sutori.com/en/user/wildwood-small-engine-repair-1c7d","status":"Live"},{"domain":"https://slideslive.com/","liveLink":"https://slideslive.com/wildwoodenginrepair123/","status":"Live"},{"domain":"https://dev.to/","liveLink":"https://dev.to/wildwoodengine234","status":"Live"},{"domain":"https://www.pinterest.com/","liveLink":"https://www.pinterest.com/wildwoodengine23/","status":"Live"},{"domain":"https://www.quora.com/","liveLink":"https://www.quora.com/profile/Wildwood-Small-Engine-Repair-2/activity","status":"Live"},{"domain":"https://trello.com/","liveLink":"https://trello.com/u/wildwoodengine123","status":"Live"},{"domain":"https://www.dead.net/","liveLink":"https://www.dead.net/member/wildwoodengine230","status":"Live"},{"domain":"https://github.com/","liveLink":"https://github.com/wildwoodengine23","status":"Live"},{"domain":"https://webflow.com/","liveLink":"https://webflow.com/@wildwood-engine-23","status":"Live"},{"domain":"https://www.coursera.org/","liveLink":"https://www.coursera.org/learner/wildwood-small-engine-repair-5354","status":"Live"},{"domain":"https://www.discogs.com/","liveLink":"https://www.discogs.com/user/wildwoodengine123","status":"Live"},{"domain":"https://www.wattpad.com/","liveLink":"","status":"Live"},{"domain":"https://superuser.com/","liveLink":"https://superuser.com/users/3098090/wildwood-small-engine-repair?tab=profile","status":"Live"},{"domain":"https://www.redbubble.com/","liveLink":"","status":"Live"},{"domain":"https://gifyu.com/","liveLink":"https://gifyu.com/wildwoodengine12","status":"Live"},{"domain":"https://linktr.ee/","liveLink":"https://linktr.ee/wildwoodengine123","status":"Live"},{"domain":"https://www.pexels.com/","liveLink":"https://www.pexels.com/@wildwood-small-engine-repair-2156557492/","status":"Live"},{"domain":"https://archello.com/","liveLink":"https://archello.com/user/small-engine-repair-wild-wood-3","status":"Live"},{"domain":"https://app.slack.com/","liveLink":"https://app.slack.com/client/T09MHQZVAMD/C09MZA3RS74?entry_point=default_oauth","status":"Live"},{"domain":"https://pixabay.com/","liveLink":"","status":"Live"},{"domain":"https://devpost.com/","liveLink":"","status":"Live"},{"domain":"https://public.tableau.com/","liveLink":"","status":"Live"},{"domain":"https://ko-fi.com/","liveLink":"https://ko-fi.com/wildwoodsmallengine12","status":"Live"},{"domain":"https://500px.com/","liveLink":"https://500px.com/p/wildwoodengine234?view=photos","status":"Live"},{"domain":"https://issuu.com","liveLink":"https://issuu.com/wildwoodsmallengine12","status":"Live"},{"domain":"https://info.credly.com/","liveLink":"https://www.credly.com/users/wildwood-small-engine-repair.e4ded076/edit#credly","status":"Live"},{"domain":"https://www.evernote.com","liveLink":"","status":"Live"},{"domain":"https://unsplash.com/","liveLink":"","status":"Live"},{"domain":"https://www.storeboard.com/","liveLink":"","status":"Live"},{"domain":"https://www.alignable.com/","liveLink":"","status":"Live"},{"domain":"https://www.zillow.com/","liveLink":"","status":"Live"},{"domain":"https://www.locanto.com.au/","liveLink":"","status":"Live"},{"domain":"https://www.oodle.com/","liveLink":"","status":"Live"},{"domain":"https://www.meetup.com/","liveLink":"","status":"Live"},{"domain":"https://www.plurk.com/","liveLink":"","status":"Live"},{"domain":"https://nextdoor.com/","liveLink":"","status":"Live"},{"domain":"https://os.mbed.com/","liveLink":"","status":"Live"}],"guestPosts":[]},"Sioux Falls, SD (2)":{"business":"Quick and Mobile Wildwood Small Engine Repair","phone":"(605) 853-8240","citations":[{"domain":"https://www.mylifegb.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.godown.town/","liveLink":"Live","status":"Pending"},{"domain":"http://www.fsbas.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.freelistingusa.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.911getit.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.cargodirectory.co/","liveLink":"Live","status":"Pending"},{"domain":"http://www.golocalezservices.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.techdirectory.io/","liveLink":"Live","status":"Pending"},{"domain":"https://www.businesssoftwarehelp.com/","liveLink":"Live","status":"Pending"},{"domain":"https://helpsellmyfsbo.com/","liveLink":"Live","status":"Pending"},{"domain":"https://vymaps.com/AU/","liveLink":"Live","status":"Pending"},{"domain":"https://www.revealnepal.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"Live","status":"Pending"},{"domain":"http://www.brownbook.net/","liveLink":"Live","status":"Pending"},{"domain":"https://www.hotfrog.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"Live","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.freelistinguk.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.getlisteduae.com/","liveLink":"Live","status":"Pending"},{"domain":"https://about.me/","liveLink":"Live","status":"Pending"},{"domain":"https://www.startupranking.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.b2bco.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.youbiz.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.freelistingindia.in/","liveLink":"Live","status":"Pending"},{"domain":"https://www.onmap.ae/","liveLink":"Live","status":"Pending"},{"domain":"https://1businessworld.com/","liveLink":"Live","status":"Pending"},{"domain":"https://www.cataloxy.us/","liveLink":"","status":"Pending"},{"domain":"https://www.insertbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.ourbizdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bunity.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstar.org/","liveLink":"","status":"Pending"},{"domain":"https://www.242hub.com/","liveLink":"","status":"Pending"},{"domain":"https://groovyfreeads.com/","liveLink":"","status":"Pending"},{"domain":"https://linkz.us/","liveLink":"","status":"Pending"},{"domain":"https://alwaysdial.com/","liveLink":"","status":"Pending"},{"domain":"https://www.addonbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://www.d2o-global.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://www.coolmarketingsoftware.com/download-your-pro-software-free/","liveLink":"","status":"Pending"},{"domain":"https://www.mapquest.com/","liveLink":"","status":"Pending"},{"domain":"https://www.yext.com/","liveLink":"","status":"Pending"}],"profiles":[{"domain":"https://architizer.com/","liveLink":"https://architizer.com/users/wild-wood-small-engine-repair/","status":"Live"},{"domain":"https://www.behance.net/","liveLink":"https://www.behance.net/emilycarter64","status":"Live"},{"domain":"https://stackoverflow.com","liveLink":"https://stackoverflow.com/users/31571676/wildwood-small-engine-repair","status":"Live"},{"domain":"https://www.sutori.com/","liveLink":"https://www.sutori.com/en/user/wild-wood-small-engine-repair-19e8?tab=profile","status":"Live"},{"domain":"https://dev.to/","liveLink":"https://dev.to/wildwood_smll_engine_repair_23","status":"Live"},{"domain":"https://www.pinterest.com/","liveLink":"https://www.pinterest.com/emilycarter7812/","status":"Live"},{"domain":"https://os.mbed.com/","liveLink":"https://os.mbed.com/account/email_reminder/","status":"Pending"},{"domain":"https://trello.com/","liveLink":"https://trello.com/u/wildwoodsmallenginerepair23","status":"Live"},{"domain":"https://www.dead.net/","liveLink":"https://www.dead.net/member/emilycarter7812","status":"Live"},{"domain":"https://webflow.com/","liveLink":"https://webflow.com/@wildwoodsmallenginerepair23","status":"Live"},{"domain":"https://superuser.com/","liveLink":"https://superuser.com/users/3079839/wildwood-small-engine-repair?tab=profile","status":"Live"},{"domain":"https://gifyu.com/","liveLink":"https://gifyu.com/emilycarter123","status":"Live"},{"domain":"https://linktr.ee/","liveLink":"https://linktr.ee/wildwoodsmallengine23","status":"Live"},{"domain":"https://www.pexels.com/","liveLink":"https://www.pexels.com/@wild-wood-small-engine-repair-2156154186/","status":"Live"},{"domain":"https://archello.com/","liveLink":"https://archello.com/user/small-engine-repair-wild-wood","status":"Live"},{"domain":"https://pixabay.com/","liveLink":"https://pixabay.com/users/wildwoodsmallenginerepair-52493545/","status":"Live"},{"domain":"https://ko-fi.com/","liveLink":"https://ko-fi.com/emilycarter7812","status":"Live"},{"domain":"https://500px.com/","liveLink":"https://500px.com/p/wildwoodsmallengine23?view=photos","status":"Live"},{"domain":"https://issuu.com","liveLink":"https://issuu.com/wildwood_smll_engine23","status":"Live"},{"domain":"https://info.credly.com/","liveLink":"https://www.credly.com/users/wild-wood-small-engine-repair/edit#credly","status":"Live"},{"domain":"https://unsplash.com/","liveLink":"https://unsplash.com/@wildwoodsmallengine23/stats","status":"Live"},{"domain":"https://www.plurk.com/","liveLink":"https://www.plurk.com/emilycarter7812","status":"Live"},{"domain":"https://solo.to","liveLink":"https://solo.to/wildwoodsmallenginer","status":"Live"},{"domain":"https://www.revealnepal.com/","liveLink":"https://www.revealnepal.com/listing/small-engine-repair-service/","status":"Live"},{"domain":"https://home.atlassian.com/","liveLink":"https://id.atlassian.com/manage-profile/email","status":"Live"},{"domain":"https://www.bizcommunity.com/","liveLink":"https://www.bizcommunity.com/MyProfile.aspx","status":"Pending"},{"domain":"https://slideslive.com/","liveLink":"https://slideslive.com/wildwoodengin23/-/edit","status":"Live"},{"domain":"https://devpost.com/","liveLink":"https://devpost.com/wildwoodengine123?ref_content=user-portfolio&ref_feature=portfolio&ref_medium=global-nav","status":"Live"},{"domain":"https://app.slack.com/","liveLink":"https://app.slack.com/client/T09HVJN64E5/C09H0N6LYS3","status":"Live"}],"guestPosts":[{"domain":"https://medium.com/","liveLink":"","status":"Pending"},{"domain":"https://www.livejournal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hashtap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blogger.com/","liveLink":"","status":"Pending"},{"domain":"https://articlebiz.com","liveLink":"","status":"Pending"},{"domain":"https://buymeacoffee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://trumpbookusa.com/","liveLink":"","status":"Pending"},{"domain":"https://printable-calendar.mn.co/","liveLink":"","status":"Pending"},{"domain":"https://substack.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hellobox.co/","liveLink":"","status":"Pending"},{"domain":"https://pinaunaeditora.com.br/","liveLink":"","status":"Pending"},{"domain":"https://1st-street.com/","liveLink":"","status":"Pending"},{"domain":"https://urrankings.com/","liveLink":"","status":"Pending"},{"domain":"https://collectionofblogs.com/","liveLink":"","status":"Pending"},{"domain":"https://doomelang.com/","liveLink":"","status":"Pending"},{"domain":"https://bdnews55.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/item/","liveLink":"","status":"Pending"},{"domain":"https://usman09.ampedpages.com/","liveLink":"","status":"Pending"},{"domain":"https://timessquarereporter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bairwaji.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/user/urban12","liveLink":"","status":"Pending"},{"domain":"https://webyourself.eu","liveLink":"","status":"Pending"}]},"Tallahassee, FL":{"business":"Wild Wood","phone":"(239) 688-3815","citations":[{"domain":"https://www.mylifegb.com/","liveLink":"https://www.mylifegb.com/midway/automotive/only-mobile-wildwood-mower-repair-generator","status":"Live"},{"domain":"https://www.godown.town/","liveLink":"https://www.godown.town/florida/midway/place/only-mobile-wildwood-mower-repair-generator","status":"Live"},{"domain":"http://www.fsbas.com/","liveLink":"http://www.fsbas.com/united-states/midway/automotive/only-mobile-wildwood-mower-repair-generator","status":"Live"},{"domain":"https://www.freelistingusa.com/","liveLink":"","status":"Pending"},{"domain":"https://www.911getit.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cargodirectory.co/","liveLink":"https://www.911getit.com/united-states/midway/a-business-service-undefined-category-listing/only-mobile-wildwood-mower-r","status":"Live"},{"domain":"http://www.golocalezservices.com/","liveLink":"","status":"Pending"},{"domain":"https://architizer.com/","liveLink":"https://www.golocalezservices.com/midway/automotive/only-mobile-wildwood-mower-repair-generator","status":"Live"},{"domain":"https://www.techdirectory.io/","liveLink":"https://www.techdirectory.io/midway/automotive/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://www.businesssoftwarehelp.com/","liveLink":"","status":"Pending"},{"domain":"https://helpsellmyfsbo.com/","liveLink":"https://helpsellmyfsbo.com/midway/wild-wood-small-engine-repair","status":"Pending"},{"domain":"https://www.successcenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.localhomeservicepros.com/","liveLink":"","status":"Pending"},{"domain":"http://www.surpassconnect.com/","liveLink":"","status":"Pending"},{"domain":"https://www.adlocalpages.com/","liveLink":"","status":"Pending"},{"domain":"http://www.askjaynee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.nextbizmaker.com/","liveLink":"","status":"Pending"},{"domain":"https://au.enrollbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizdiversity.directory/","liveLink":"","status":"Pending"},{"domain":"https://habeshalink.com/","liveLink":"","status":"Pending"},{"domain":"https://listings.beginswithfamily.net/","liveLink":"","status":"Pending"},{"domain":"https://www.anibookmark.com/","liveLink":"","status":"Pending"},{"domain":"https://nearfinderau.com/en/","liveLink":"","status":"Pending"},{"domain":"https://www.trysmallbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.callupcontact.com/","liveLink":"","status":"Pending"},{"domain":"https://vymaps.com/AU/","liveLink":"","status":"Pending"},{"domain":"https://www.revealnepal.com/","liveLink":"https://www.revealnepal.com/?post_type=listing&p=50381","status":"Pending"},{"domain":"https://www.bizdiversity.","liveLink":"","status":"Pending"},{"domain":"https://www.surfyourtown.com/","liveLink":"","status":"Pending"},{"domain":"https://www.counselingnearme.com/","liveLink":"","status":"Pending"},{"domain":"https://www.dealerbaba.com/","liveLink":"","status":"Pending"},{"domain":"https://startups.snapmunk.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bizmakersamerica.org/","liveLink":"","status":"Pending"},{"domain":"https://www.trueen.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"},{"domain":"https://www.us-info.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistinguk.com/","liveLink":"https://www.freelistinguk.com/listings/only-mobile-wildwood-mower-repair-generator","status":"Pending"},{"domain":"https://www.getlisteduae.com/","liveLink":"https://www.getlisteduae.com/listings/only-mobile-wildwood-mower-repair-generator","status":"Pending"},{"domain":"https://www.find-us-here.com","liveLink":"","status":"Pending"},{"domain":"https://about.me/","liveLink":"","status":"Pending"},{"domain":"https://www.startupranking.com/","liveLink":"","status":"Pending"},{"domain":"https://www.b2bco.com/","liveLink":"","status":"Pending"},{"domain":"https://www.youbiz.com/","liveLink":"https://www.youbiz.com/sponsors/listing/listing.php?id=198669","status":"Pending"},{"domain":"https://www.d2o-global.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locbusiness.com/","liveLink":"","status":"Pending"},{"domain":"https://1businessworld.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cataloxy.us/","liveLink":"","status":"Pending"},{"domain":"https://www.insertbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.ourbizdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bunity.com/","liveLink":"","status":"Pending"},{"domain":"https://www.fixerhub.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstar.org/","liveLink":"","status":"Pending"},{"domain":"https://www.242hub.com/","liveLink":"","status":"Pending"},{"domain":"https://www.freelistingindia.in/","liveLink":"","status":"Pending"},{"domain":"https://www.onmap.ae/","liveLink":"","status":"Pending"},{"domain":"https://groovyfreeads.com/","liveLink":"","status":"Pending"},{"domain":"https://linkz.us/","liveLink":"","status":"Pending"},{"domain":"https://alwaysdial.com/","liveLink":"","status":"Pending"},{"domain":"https://www.addonbiz.com/","liveLink":"","status":"Pending"},{"domain":"https://www.savenebraskalocal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.detroitbusinesscenter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.boisemeridian.com/","liveLink":"","status":"Pending"},{"domain":"https://www.africanfind.com/","liveLink":"","status":"Pending"},{"domain":"http://ballarat.thelocalskinny.com/","liveLink":"","status":"Pending"},{"domain":"https://aussiestoresonline.com/","liveLink":"","status":"Pending"},{"domain":"https://catalog-australia.com/","liveLink":"","status":"Pending"},{"domain":"https://www.trustfeed.com/","liveLink":"","status":"Pending"},{"domain":"http://www.localstorefronts.com/","liveLink":"","status":"Pending"},{"domain":"https://www.officiallyiconic.com/","liveLink":"","status":"Pending"},{"domain":"https://www.radar.directory/","liveLink":"","status":"Pending"},{"domain":"https://www.demobootstrap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.revealbusinesses.com/","liveLink":"","status":"Pending"},{"domain":"https://milestones.business/","liveLink":"","status":"Pending"},{"domain":"https://highdadirectory.com/","liveLink":"","status":"Pending"},{"domain":"http://listizze.com/","liveLink":"","status":"Pending"},{"domain":"https://www.distrilist.eu/","liveLink":"","status":"Pending"},{"domain":"https://getmedirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://heliskidirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://topdirectory1.com/","liveLink":"","status":"Pending"},{"domain":"https://www.middleeastsouk.com","liveLink":"","status":"Pending"},{"domain":"https://www.impressionsdirectory.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blacklinkus.com","liveLink":"","status":"Pending"},{"domain":"https://www.squeakafrica.com/","liveLink":"","status":"Pending"},{"domain":"https://www.myadbay.com/","liveLink":"","status":"Pending"},{"domain":"https://www.cybo.com/","liveLink":"","status":"Pending"}],"profiles":[{"domain":"https://solo.to/","liveLink":"https://solo.to/wildwoodsmallengine5","status":"Pending"},{"domain":"https://www.behance.net/","liveLink":"https://www.behance.net/avathompson19","status":"Live"},{"domain":"https://stackoverflow.com","liveLink":"https://stackoverflow.com/users/31563826/only-mobile-wildwood-mower-rep?tab=profile","status":"Live"},{"domain":"https://www.sutori.com/","liveLink":"https://www.sutori.com/en/user/ava-thompson-7be2?tab=emails","status":"Live"},{"domain":"https://slideslive.com/","liveLink":"https://slideslive.com/wildwoodsmallenginerepair3/-/edit","status":"Pending"},{"domain":"https://www.mediafire.com","liveLink":"https://dev.to/ava_thompson_37390cbb0b0f","status":"Live"},{"domain":"https://dev.to/","liveLink":"https://dev.to/onlymobilewildwoodmowerrep","status":"Pending"},{"domain":"https://www.pinterest.com/","liveLink":"https://www.pinterest.com/onlymobilewildwoodmowerrepair/","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://os.mbed.com/","liveLink":"","status":"Pending"},{"domain":"https://trello.com/","liveLink":"","status":"Pending"},{"domain":"https://www.dead.net/","liveLink":"","status":"Pending"},{"domain":"https://github.com/","liveLink":"","status":"Pending"},{"domain":"https://webflow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.coursera.org/","liveLink":"","status":"Pending"},{"domain":"https://www.discogs.com/","liveLink":"","status":"Pending"},{"domain":"https://www.wattpad.com/","liveLink":"","status":"Pending"},{"domain":"https://superuser.com/","liveLink":"","status":"Pending"},{"domain":"https://www.redbubble.com/","liveLink":"","status":"Pending"},{"domain":"https://gifyu.com/","liveLink":"","status":"Pending"},{"domain":"https://linktr.ee/","liveLink":"","status":"Pending"},{"domain":"https://www.pexels.com/","liveLink":"","status":"Pending"},{"domain":"https://archello.com/","liveLink":"","status":"Pending"},{"domain":"https://app.slack.com/","liveLink":"","status":"Pending"},{"domain":"https://pixabay.com/","liveLink":"","status":"Pending"},{"domain":"https://devpost.com/","liveLink":"","status":"Pending"},{"domain":"https://public.tableau.com/","liveLink":"","status":"Pending"},{"domain":"https://ko-fi.com/","liveLink":"","status":"Pending"},{"domain":"https://500px.com/","liveLink":"","status":"Pending"},{"domain":"https://issuu.com","liveLink":"https://issuu.com/wildwoodsmallenginerepaircarmel","status":"Pending"},{"domain":"https://info.credly.com/","liveLink":"","status":"Pending"},{"domain":"https://www.evernote.com","liveLink":"","status":"Pending"},{"domain":"https://unsplash.com/","liveLink":"","status":"Pending"},{"domain":"https://www.storeboard.com/","liveLink":"","status":"Pending"},{"domain":"https://www.alignable.com/","liveLink":"","status":"Pending"},{"domain":"https://www.zillow.com/","liveLink":"","status":"Pending"},{"domain":"https://www.locanto.com.au/","liveLink":"","status":"Pending"},{"domain":"https://www.oodle.com/","liveLink":"","status":"Pending"},{"domain":"https://www.meetup.com/","liveLink":"","status":"Pending"},{"domain":"https://www.plurk.com/","liveLink":"","status":"Pending"},{"domain":"https://nextdoor.com/","liveLink":"","status":"Pending"}],"guestPosts":[{"domain":"https://medium.com/","liveLink":"","status":"Pending"},{"domain":"https://www.livejournal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hashtap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blogger.com/","liveLink":"","status":"Pending"},{"domain":"https://articlebiz.com","liveLink":"","status":"Pending"},{"domain":"https://buymeacoffee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://trumpbookusa.com/","liveLink":"","status":"Pending"},{"domain":"https://printable-calendar.mn.co/","liveLink":"","status":"Pending"},{"domain":"https://substack.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hellobox.co/","liveLink":"","status":"Pending"},{"domain":"https://pinaunaeditora.com.br/","liveLink":"","status":"Pending"},{"domain":"https://1st-street.com/","liveLink":"","status":"Pending"},{"domain":"https://urrankings.com/","liveLink":"","status":"Pending"},{"domain":"https://collectionofblogs.com/","liveLink":"","status":"Pending"},{"domain":"https://doomelang.com/","liveLink":"","status":"Pending"},{"domain":"https://bdnews55.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/item/","liveLink":"","status":"Pending"},{"domain":"https://usman09.ampedpages.com/","liveLink":"","status":"Pending"},{"domain":"https://timessquarereporter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bairwaji.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/user/urban12","liveLink":"","status":"Pending"},{"domain":"https://webyourself.eu","liveLink":"","status":"Pending"}]}},"adsPower":{"cities":[{"city":"Miami","proxy":"Miami Proxy #1","reason":"Exact match (Miami-Dade County)"},{"city":"Tallahassee","proxy":"Christmas Proxy #1","reason":"North FL capital, fallback under Central FL logic"},{"city":"Tampa","proxy":"Mango Proxy #1","reason":"Mango is within Tampa metro (Hillsborough County)"},{"city":"West Palm Beach","proxy":"Brandon Proxy #1","reason":"Palm Beach County \u2013 helps balance Miami proxy load"},{"city":"Fort Myers","proxy":"Brandon Proxy #2","reason":"SW Florida city, reasonable under Brandon proxy"},{"city":"Boca Raton","proxy":"Miami Proxy #1","reason":"South FL, Palm Beach County \u2013 near Miami"},{"city":"Fort Lauderdale","proxy":"Miami Proxy #3","reason":"South FL metro city (Broward County) \u2013 neighboring Miami"},{"city":"Cape Coral","proxy":"Christmas Proxy #1","reason":"Covered under Central/Southwest Florida region"},{"city":"Naples","proxy":"Christmas Proxy #2","reason":"Southwest FL, safe under Central FL proxy"},{"city":"Sarasota","proxy":"Mango Proxy #2","reason":"Tampa Bay area neighbor (Sarasota County)"},{"city":"St. Petersburg","proxy":"Mango Proxy #3","reason":"Tampa Bay metro neighbor (Pinellas County)"},{"city":"Key West","proxy":"Brandon Proxy #3","reason":"Remote South Florida island, safe under Brandon group"},{"city":"Orlando","proxy":"Orlando Proxy #1","reason":"Exact match (Central Florida hub)"},{"city":"Jacksonville","proxy":"Orlando Proxy #2","reason":"Northeast Florida city \u2013 fallback under Central proxy"},{"city":"Pensacola","proxy":"Orlando Proxy #3","reason":"Far Panhandle city \u2013 safest fallback under Orlando"}],"numbers":[{"name":"229-597-8266","number":"229-597-8266","forward":"ai flow"},{"name":"239-766-5543","number":"239-766-5543","forward":"Call Flow 2025-08-10 17:53"},{"name":"253-300-2867","number":"253-300-2867","forward":"Call Flow 2025-07-14 13:50"},{"name":"313-351-8981","number":"313-351-8981","forward":"Call Flow 2025-07-14 13:50"},{"name":"361-203-4876","number":"361-203-4876","forward":"Call Flow 2025-07-14 13:50"},{"name":"816-597-4281","number":"816-597-4281","forward":"Call Flow 2025-07-14 13:50"},{"name":"888-594-5516","number":"888-594-5516","forward":"239-766-5543"},{"name":"970-427-0782","number":"970-427-0782","forward":"Call Flow 2025-07-14 13:50"},{"name":"Customer line","number":"888-301-5405","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google Ads Call Ext","number":"239-688-3815","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"239-734-4232","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"313-458-4304","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"816-837-4480","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"713-561-5922","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"765-436-1206","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"941-273-8085","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"605-853-8240","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"361-326-3158","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"775-977-4235","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"775-526-2933","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"605-657-6487","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"719-427-5451","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"860-847-8435","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"203-894-6838","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"208-537-1670","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"574-601-3798","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"260-217-0285","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"410-650-8043","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"419-595-5733","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"813-452-4083","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"210-864-1043","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"813-796-6637","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"813-669-7696","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"956-477-1528","forward":"Call Flow 2025-07-14 13:50"},{"name":"Google My Business","number":"303-529-8905","forward":"Call Flow 2025-07-14 13:50"},{"name":"magnets","number":"888-851-4987","forward":"Call Flow 2025-07-14 13:50"},{"name":"shirts","number":"888-489-6585","forward":"Call Flow 2025-07-14 13:50"},{"name":"Team","number":"888-296-1869","forward":"Call Flow 2025-07-14 13:50"},{"name":"Ymc Agency","number":"866-702-4274","forward":"Call Flow 2025-08-13 15:36"}],"localGuides":[{"city":"West Palm LG","email":"ethancollins1273@gmail.com","progress":"2,799 points on level 6","level5":"Yes"},{"city":"Fort Myers LG","email":"jessicaramirez9530@gmail.com","progress":"2,833 points on level 6","level5":"Yes"},{"city":"Miami LG","email":"marcusjohnson3851@gmail.com","progress":"2,796points on Level 6","level5":"Yes"},{"city":"Tampa LG","email":"rachelgreen3749@gmail.com","progress":"2,716 points on level 6","level5":"Yes"},{"city":"Tallahassee LG","email":"danielbrooks1731@gmail.com","progress":"2,530 points on level 6","level5":"Yes"}],"gbpGmails":[{"city":"West Palm LG","email":"Brandon Proxy #1"},{"city":"Fort Myers LG","email":"Brandon Proxy #2"},{"city":"Miami LG","email":"Miami Proxy #2"},{"city":"Tampa LG","email":"Mango Proxy #1"},{"city":"Tallahassee LG","email":"Christmas Proxy #3"}]},"addresses":[{"city":"West Palm","address":"515 N Flagler Dr, West Palm Beach, FL 33401","areas":["\ud83d\udee3 ~1 mile","\ud83d\udcb5 Avg. Household Income: $160k+","South End (SoSo \u2013 South of Southern Blvd)","\ud83d\udee3 ~4 miles","\ud83d\udcb5 Avg. Household Income: $120k\u2013130k+","Flamingo Park / El Cid","\ud83d\udee3 ~2 miles","\ud83d\udcb5 Avg. Household Income: $110k\u2013115k+","Ibis Golf & Country Club (west, off Northlake Blvd)","\ud83d\udee3 ~11 miles","\ud83d\udcb5 Avg. Household Income: $140k+","Breakers West (west of WPB, near Okeechobee Blvd)","\ud83d\udee3 ~10 miles","\ud83d\udcb5 Avg. Household Income: $130k+"]},{"city":"Fort Myers","address":"5237 Summerlin Commons Blvd, Fort Myers, FL 33907","areas":["\ud83d\udee3 ~3 miles","\ud83d\udcb5 Avg. Household Income: $95k\u2013100k+","Whiskey Creek","\ud83d\udee3 ~2.5 miles","\ud83d\udcb5 Avg. Household Income: $90k\u201395k","Gulf Harbour Yacht & Country Club","\ud83d\udee3 ~7 miles","\ud83d\udcb5 Avg. Household Income: $110k+","Caloosa Yacht & Racquet Club","\ud83d\udee3 ~6 miles","\ud83d\udcb5 Avg. Household Income: $105k+","Fiddlesticks Country Club","\ud83d\udee3 ~9 miles","\ud83d\udcb5 Avg. Household Income: $120k+"]},{"city":"Miami","address":"2525 Ponce de Leon, Coral Gables, FL 33134","areas":["\ud83d\udee3 ~0 miles (you\u2019re inside it)","\ud83d\udcb5 Avg. Household Income: $130k+","Coconut Grove","\ud83d\udee3 ~2.5 miles","\ud83d\udcb5 Avg. Household Income: $140k+","Pinecrest","\ud83d\udee3 ~7 miles","\ud83d\udcb5 Avg. Household Income: $150k+","Key Biscayne","\ud83d\udee3 ~9 miles","\ud83d\udcb5 Avg. Household Income: $145k+","Miami Shores","\ud83d\udee3 ~10 miles","\ud83d\udcb5 Avg. Household Income: $110k\u2013120k"]},{"city":"Tampa","address":"2202 N Westshore Blvd, Tampa, FL 33607","areas":["\ud83d\udee3 ~1.5 miles","\ud83d\udcb5 Avg. Household Income: $135k+","Palma Ceia","\ud83d\udee3 ~3.0 miles","\ud83d\udcb5 Avg. Household Income: $140k+","Hyde Park","\ud83d\udee3 ~4.0 miles","\ud83d\udcb5 Avg. Household Income: $150k+","Sunset Park / Culbreath Isles","\ud83d\udee3 ~4.0\u20134.5 miles","\ud83d\udcb5 Avg. Household Income: $120k\u2013130k+"]},{"city":"Tallahassee","address":"1415 Timberlane Rd, Tallahassee, FL 32312","areas":["\ud83d\udee3 ~4.5 miles","\ud83d\udcb5 Avg. Household Income: $120k+","Ox Bottom Manor","\ud83d\udee3 ~3.0 miles","\ud83d\udcb5 Avg. Household Income: $110k+","Killearn Estates","\ud83d\udee3 ~3.5 miles","\ud83d\udcb5 Avg. Household Income: $85k+","Waverly Hills","\ud83d\udee3 ~5.0 miles","\ud83d\udcb5 Avg. Household Income: $90k+","Betton Hills","\ud83d\udee3 ~6.0 miles","\ud83d\udcb5 Avg. Household Income: $95k+"]}],"tasks":{"Hassan":[{"phase":"Week 1\u20132","activity":"Local SEO Prepping","task":"Prepare 15 business names and matching addresses","done":false},{"phase":"Week 1\u20132","activity":"SEO Prepping","task":"Prepare NAP, phone numbers, and logo variations","done":false},{"phase":"Week 1\u20132","activity":"SEO Prepping","task":"Label AdsPower profiles: Dallas-GMB1, Austin-GMB2...","done":false},{"phase":"Week 3\u20134","activity":"Build Local Authority","task":"Submit each GMB to at least 10 citations (Moz, Yelp...)","done":false},{"phase":"Week 3\u20134","activity":"Build Local Authority","task":"Add NAP data to footers of city pages","done":false},{"phase":"Week 3\u20134","activity":"Build Local Authority","task":"Create 5 backlinks for domain using niche edits/PBNs","done":false}],"MuQaDas":[{"phase":"Week 1\u20132","activity":"Gmail Farming & Activity","task":"Create 10 Gmails (5 city, 5 local guide, )","done":false},{"phase":"Week 1\u20132","activity":"Gmail Farming & Activity","task":"Assign Gmails to AdsPower profiles with proxies","done":false},{"phase":"Week 1\u20132","activity":"Gmail Farming & Activity","task":"Warm up Gmail accounts with YouTube, Reddit, email","done":false},{"phase":"Week 3\u20134","activity":"Push GMB Soft Listings","task":"Submit 5\u201310 soft GMB listings","done":false},{"phase":"Week 3\u20134","activity":"Push GMB Soft Listings","task":"Monitor which listings go live vs. pending/suspended","done":false},{"phase":"Week 3\u20134","activity":"Push GMB Soft Listings","task":"Continue warming email accounts & simulate activity","done":false}],"Nida":[{"phase":"Week 1\u20132","activity":"Local SEO Prepping","task":"Prepare 15 business names and matching addresses","done":false},{"phase":"Week 1\u20132","activity":"SEO Prepping","task":"Prepare NAP, phone numbers, and logo variations","done":false},{"phase":"Week 1\u20132","activity":"SEO Prepping","task":"Label AdsPower profiles: Dallas-GMB1, Austin-GMB2...","done":false},{"phase":"Week 3\u20134","activity":"Build Local Authority","task":"Submit each GMB to at least 10 citations (Moz, Yelp...)","done":false},{"phase":"Week 3\u20134","activity":"Build Local Authority","task":"Add NAP data to footers of city pages","done":false},{"phase":"Week 3\u20134","activity":"Build Local Authority","task":"Create 5 backlinks for domain using niche edits/PBNs","done":false}]},"landingPages":[{"city":"Albany, NY","file":"Albany__NY_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Albany NY","metaTitle":"Snow Blower Repair Albany NY | Same-Day Mobile Service","metaDesc":"Reliable mobile snow blower repair in Albany NY. Same-day, at-home service for Ariens, Toro, Craftsman & more. Emergency repairs available.","wordCount":1335,"serviceType":"Snow Blower"},{"city":"Anchorage, AK","file":"Anchorage__AK_Snow_Blower_Page.docx","mainKeyword":"","metaTitle":"Snow Blower Repair Anchorage AK | Mobile Coastal-Snow Specialists","metaDesc":"Need snow blower repair in Anchorage AK? We offer mobile, same-day service for wet coastal snow, hillsides & freeze-thaw damage. Free estimates.","wordCount":1070,"serviceType":"Snow Blower"},{"city":"Boise, ID","file":"Boise__ID_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Boise ID","metaTitle":"Snow Blower Repair Boise ID | Same-Day Mobile Service","metaDesc":"Fast mobile snow blower repair in Boise ID. Same-day, at-home service for Toro, Ariens, Honda & more. Inversion and freeze-thaw ready repairs.","wordCount":893,"serviceType":"Snow Blower"},{"city":"Bozeman, MT","file":"Bozeman__MT_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Bozeman MT","metaTitle":"Snow Blower Repair Bozeman MT | Same-Day Mobile Service","metaDesc":"Reliable mobile snow blower repair in Bozeman MT. Same-day, at-home service with altitude tuning for Ariens, Honda, Toro & more. Emergency repairs available.","wordCount":1169,"serviceType":"Snow Blower"},{"city":"Buffalo, NY","file":"Buffalo__NY_Snow_Blower_Page.docx","mainKeyword":"snow blower repair buffalo ny","metaTitle":"Snow Blower Repair Buffalo, NY | Same-Day & Mobile Service","metaDesc":"Need snow blower repair in Buffalo, NY? We offer same-day and mobile service for gas & electric snow blowers. Free estimates. Call today.","wordCount":1026,"serviceType":"Snow Blower"},{"city":"Burlington, VT","file":"Burlington__VT_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Burlington VT","metaTitle":"Snow Blower Repair Burlington VT | Same-Day Mobile Service","metaDesc":"Fast mobile snow blower repair in Burlington VT. Same-day, at-home service for Ariens, Toro, Honda & more. Emergency winter repairs available.","wordCount":1292,"serviceType":"Snow Blower"},{"city":"Chicago, IL","file":"Chicago__IL_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Chicago IL","metaTitle":"Snow Blower Repair Chicago IL | Same-Day Mobile Service","metaDesc":"Fast mobile snow blower repair in Chicago IL. Same-day, at-home service for Toro, Ariens, Craftsman & more. Emergency winter repairs available.","wordCount":1138,"serviceType":"Snow Blower"},{"city":"Cleveland, OH","file":"Cleveland__OH_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Cleveland OH","metaTitle":"Snow Blower Repair Cleveland OH | Same-Day Mobile Service","metaDesc":"Expert mobile snow blower repair in Cleveland OH. Same-day, at-home service for Ariens, Toro, Craftsman & more. Lake-effect emergency repairs available.","wordCount":945,"serviceType":"Snow Blower"},{"city":"Colorado Springs, CO","file":"Colorado_Springs__CO_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Colorado Springs CO","metaTitle":"Snow Blower Repair Colorado Springs CO | Mobile Service","metaDesc":"Expert mobile snow blower repair in Colorado Springs CO. Same-day, at-home service with high-altitude tuning for Toro, Ariens, Honda & more.","wordCount":780,"serviceType":"Snow Blower"},{"city":"Denver, CO","file":"Copy_of_Denver__CO_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Denver CO","metaTitle":"Snow Blower Repair Denver CO | Same-Day Mobile Service","metaDesc":"Trusted mobile snow blower repair in Denver CO. Same-day, at-home service with altitude tuning for Toro, Ariens, Honda & more. Emergency repairs available.","wordCount":1212,"serviceType":"Snow Blower"},{"city":"Detroit, MI","file":"Copy_of_Detroit__MI_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Detroit MI","metaTitle":"Snow Blower Repair Detroit MI | Same-Day Mobile Service","metaDesc":"Fast mobile snow blower repair in Detroit MI. Same-day, at-home service for Toro, Ariens, Craftsman & more. Emergency winter repairs available.","wordCount":806,"serviceType":"Snow Blower"},{"city":"Erie, PA","file":"Copy_of_Erie__PA_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Erie PA","metaTitle":"Snow Blower Repair Erie PA | Same-Day Mobile Service","metaDesc":"Expert mobile snow blower repair in Erie PA. Same-day, at-home service for Ariens, Toro, Honda & more. Lake-effect emergency repairs available.","wordCount":926,"serviceType":"Snow Blower"},{"city":"Fairbanks, AK","file":"Copy_of_Fairbanks__AK_Snow_Blower_Page.docx","mainKeyword":"","metaTitle":"","metaDesc":"","wordCount":686,"serviceType":"Snow Blower"},{"city":"Green Bay, WI","file":"Copy_of_Green_Bay__WI_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Green Bay WI","metaTitle":"Snow Blower Repair Green Bay WI | Same-Day Mobile Service","metaDesc":"Reliable mobile snow blower repair in Green Bay WI. Same-day, at-home service for Ariens, Toro, Honda & more. Emergency winter repairs available.","wordCount":1311,"serviceType":"Snow Blower"},{"city":"Kansas City, MO","file":"Copy_of_Kansas_City__MO_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Kansas City MO","metaTitle":"Snow Blower Repair Kansas City MO | Same-Day Mobile Service","metaDesc":"Ice-storm\u2013ready mobile snow blower repair in Kansas City MO. Same-day, at-home service for Toro, Ariens, Honda & more. Emergency repairs available.","wordCount":677,"serviceType":"Snow Blower"},{"city":"Minneapolis, MN","file":"Copy_of_Minneapolis__MN_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Minneapolis MN","metaTitle":"Snow Blower Repair Minneapolis MN | Same-Day Mobile Service","metaDesc":"Expert mobile snow blower repair in Minneapolis MN. Same-day, at-home service for Ariens, Toro, Honda & more. Extreme-cold emergency repairs available.","wordCount":1420,"serviceType":"Snow Blower"},{"city":"Rochester, NY","file":"Copy_of_Rochester__NY_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Rochester NY","metaTitle":"Snow Blower Repair Rochester NY | Same-Day Mobile Service","metaDesc":"Fast mobile snow blower repair in Rochester NY. Same-day, at-home service for Ariens, Toro, Craftsman & more. Emergency repairs available.","wordCount":1272,"serviceType":"Snow Blower"},{"city":"Salt Lake City, UT","file":"Copy_of_Salt_Lake_City__UT_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Salt Lake City UT","metaTitle":"Snow Blower Repair Salt Lake City UT | Same-Day Mobile Service","metaDesc":"Expert mobile snow blower repair in Salt Lake City UT. Same-day, at-home service with altitude tuning for Toro, Ariens & more. Emergency repairs available.","wordCount":1294,"serviceType":"Snow Blower"},{"city":"Sioux Falls, SD","file":"Copy_of_Sioux_Falls__SD_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Sioux Falls SD","metaTitle":"Snow Blower Repair Sioux Falls SD | Same-Day Mobile Service","metaDesc":"Fast mobile snow blower repair in Sioux Falls SD. Same-day, at-home service for Toro, Ariens, Honda & more. Emergency winter repairs available.","wordCount":1515,"serviceType":"Snow Blower"},{"city":"Syracuse, NY","file":"Copy_of_Syracuse__NY_Snow_Blower_Page.docx","mainKeyword":"snow blower repair Syracuse NY","metaTitle":"Snow Blower Repair Syracuse NY | Same-Day Mobile Service","metaDesc":"Same-day mobile snow blower repair in Syracuse NY. We fix Ariens, Toro, Honda & more with 2\u20134 hour storm response. Call for fast at-home service.","wordCount":1318,"serviceType":"Snow Blower"}],"honeyBookEmails":[{"name":"HoneyBooks Client & Project (0\u20137 HP Protection)","subject":"Hey, {First client first name} we want you to have this.","body":"{First client first name}\nAt $243.60, enjoy peace of mind with 1 year of protection. Unlimited repairs on all major parts and labor with no deductible. Your plan stays active only when repairs are performed by Wildwood \u2014 any o\nWe also offer a monthly plan at $24.83 (save appropriately $50 with the annual plan).\nServices do not start until paid in full.\nOur plan does not include:\nRoutine tune-ups (oil changes, blade sharpening, seasonal prep) \u2022 Consumables (filters, spark plugs, fuel, lubricants) \u2022 Neglect or abuse (running without oil, bad fuel, skipped maintenance) \u2022\nAccidental damage, theft, or cosmetic issues\nMember Perks:\n\u2705 All major parts & labor for 1 year\n\u2705 Wear-and-tear failures (blades, belts, carburetors, cords, wiring, drivetrain, engine)\n\u2705 Unlimited repairs \u2014 no claim limits\n\u2705 $0 deductible\n\u2705 Transferable if you sell your equipment\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"},{"name":"HoneyBooks Client & Project (8\u201313 HP Protection)","subject":"Hey, {First client first name} we want you to have this.","body":"{First client first name}\nAt $352.35, enjoy peace of mind with 1 year of protection. Unlimited repairs on all major parts and labor with no deductible. Your plan stays active only when repairs are performed by Wildwood \u2014 any o\nWe also offer a monthly plan at $33.89 (save appropriately $50 with the annual plan).\nServices do not start until paid in full.\nOur plan does not include:\nRoutine tune-ups (oil changes, blade sharpening, seasonal prep) \u2022 Consumables (filters, spark plugs, fuel, lubricants) \u2022 Neglect or abuse (running without oil, bad fuel, skipped maintenance) \u2022\nAccidental damage, theft, or cosmetic issues\nMember Perks:\n\u2705 All major parts & labor for 1 year\n\u2705 Wear-and-tear failures (blades, belts, carburetors, cords, wiring, drivetrain, engine)\n\u2705 Unlimited repairs \u2014 no claim limits\n\u2705 $0 deductible\n\u2705 Transferable if you sell your equipment\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"},{"name":"HoneyBooks Client & Project (14\u201319 HP Protection)","subject":"Hey, {First client first name} we want you to have this.","body":"{First client first name}\nAt $515.48, enjoy peace of mind with 1 year of protection. Unlimited repairs on all major parts and labor with no deductible. Your plan stays active only when repairs are performed by Wildwood \u2014 any o\nWe also offer a monthly plan at $47.49 (save appropriately $50 with the annual plan).\nServices do not start until paid in full.\nOur plan does not include:\nRoutine tune-ups (oil changes, blade sharpening, seasonal prep) \u2022 Consumables (filters, spark plugs, fuel, lubricants) \u2022 Neglect or abuse (running without oil, bad fuel, skipped maintenance) \u2022\nAccidental damage, theft, or cosmetic issues\nMember Perks:\n\u2705 All major parts & labor for 1 year\n\u2705 Wear-and-tear failures (blades, belts, carburetors, cords, wiring, drivetrain, engine)\n\u2705 Unlimited repairs \u2014 no claim limits\n\u2705 $0 deductible\n\u2705 Transferable if you sell your equipment\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"},{"name":"HoneyBooks Client & Project (20\u201325 HP Protection)","subject":"Hey, {First client first name} we want you to have this.","body":"{First client first name}\nAt $678.60, enjoy peace of mind with 1 year of protection. Unlimited repairs on all major parts and labor with no deductible. Your plan stays active only when repairs are performed by Wildwood \u2014 any o\nWe also offer a monthly plan at $61.08 (save appropriately $50 with the annual plan).\nServices do not start until paid in full.\nOur plan does not include:\nRoutine tune-ups (oil changes, blade sharpening, seasonal prep) \u2022 Consumables (filters, spark plugs, fuel, lubricants) \u2022 Neglect or abuse (running without oil, bad fuel, skipped maintenance) \u2022\nAccidental damage, theft, or cosmetic issues\nMember Perks:\n\u2705 All major parts & labor for 1 year\n\u2705 Wear-and-tear failures (blades, belts, carburetors, cords, wiring, drivetrain, engine)\n\u2705 Unlimited repairs \u2014 no claim limits\n\u2705 $0 deductible\n\u2705 Transferable if you sell your equipment\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"},{"name":"HoneyBooks Client & Project (26+ HP Protection)","subject":"Hey, {First client first name} we want you to have this.","body":"{First client first name}\nAt $950.48, enjoy peace of mind with 1 year of protection. Unlimited repairs on all major parts and labor with no deductible. Your plan stays active only when repairs are performed by Wildwood \u2014 any o\nWe also offer a monthly plan at $83.74 (save appropriately $50 with the annual plan).\nServices do not start until paid in full.\nOur plan does not include:\nRoutine tune-ups (oil changes, blade sharpening, seasonal prep) \u2022 Consumables (filters, spark plugs, fuel, lubricants) \u2022 Neglect or abuse (running without oil, bad fuel, skipped maintenance) \u2022\nAccidental damage, theft, or cosmetic issues\nMember Perks:\n\u2705 All major parts & labor for 1 year\n\u2705 Wear-and-tear failures (blades, belts, carburetors, cords, wiring, drivetrain, engine)\n\u2705 Unlimited repairs \u2014 no claim limits\n\u2705 $0 deductible\n\u2705 Transferable if you sell your equipment\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"},{"name":"0\u20137 HP Tuneup","subject":"","body":"Our plan includes:\n\ud83e\uddf0 Full inspection \u2022 \ud83d\udee2\ufe0f Oil & filter change \u2022 \u26a1 Spark & air filter check \u2014 and more to keep your equipment running like new.\nMember Perks:\n\u2705 We book the appointment for you\n\u2705 Discounted tune-ups\n\u2705 10% off all Repairs\n\u2705 No diagnostic fee\n\u2705 Priority scheduling year-round\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"},{"name":"HoneyBooks Client & Project (8\u201313 HP Tuneup)","subject":"Hey, {First client first name} we want you to have this.","body":"{First client first name}\nWhen your equipment breaks mid-season or every shop is booked out, it\u2019s frustrating. That\u2019s why we created our Annual Tune-Up Plan to keep your machines running smooth all year. Yearly payment at just\nWe also offer a monthly plan at $27.19 (save appropriately $50 with the annual plan).\nServices do not start until paid in full.\nOur plan includes:\n\ud83e\uddf0 Full inspection \u2022 \ud83d\udee2\ufe0f Oil & filter change \u2022 \u26a1 Spark & air filter check \u2014 and more to keep your equipment running like new.\nMember Perks:\n\u2705 We book the appointment for you\n\u2705 Discounted tune-ups\n\u2705 10% off all Repairs\n\u2705 No diagnostic fee\n\u2705 Priority scheduling year-round\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"},{"name":"HoneyBooks Client & Project (14\u201319 HP Tuneup)","subject":"Hey, {First client first name} we want you to have this.","body":"{First client first name}\nWhen your equipment breaks mid-season or every shop is booked out, it\u2019s frustrating. That\u2019s why we created our Annual Tune-Up Plan to keep your machines running smooth all year. Yearly payment at just\nWe also offer a monthly plan at $36.25 (save appropriately $50 with the annual plan).\nServices do not start until paid in full.\nOur plan includes:\n\ud83e\uddf0 Full inspection \u2022 \ud83d\udee2\ufe0f Oil & filter change \u2022 \u26a1 Spark & air filter check \u2014 and more to keep your equipment running like new.\nMember Perks:\n\u2705 We book the appointment for you\n\u2705 Discounted tune-ups\n\u2705 10% off all Repairs\n\u2705 No diagnostic fee\n\u2705 Priority scheduling year-round\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"},{"name":"HoneyBooks Client & Project (20\u201325 HP Tuneup)","subject":"Hey, {First client first name} we want you to have this.","body":"{First client first name}\nWhen your equipment breaks mid-season or every shop is booked out, it\u2019s frustrating. That\u2019s why we created our Annual Tune-Up Plan to keep your machines running smooth all year. Yearly payment at just\nWe also offer a monthly plan at $42.59 (save appropriately $50 with the annual plan).\nServices do not start paid in full.\nOur plan includes:\n\ud83e\uddf0 Full inspection \u2022 \ud83d\udee2\ufe0f Oil & filter change \u2022 \u26a1 Spark & air filter check \u2014 and more to keep your equipment running like new.\nMember Perks:\n\u2705 We book the appointment for you\n\u2705 Discounted tune-ups\n\u2705 10% off all Repairs\n\u2705 No diagnostic fee\n\u2705 Priority scheduling year-round\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"},{"name":"HoneyBooks Client & Project (26+ HP Tuneup)","subject":"Hey, {First client first name} we want you to have this.","body":"{First client first name}\nWhen your equipment breaks mid-season or every shop is booked out, it\u2019s frustrating. That\u2019s why we created our Annual Tune-Up Plan to keep your machines running smooth all year. Yearly payment at just\nWe also offer a monthly plan at $51.66 (save appropriately $50 with the annual plan).\nServices do not start until paid in full.\nOur plan includes:\n\ud83e\uddf0 Full inspection \u2022 \ud83d\udee2\ufe0f Oil & filter change \u2022 \u26a1 Spark & air filter check \u2014 and more to keep your equipment running like new.\nMember Perks:\n\u2705 We book the appointment for you\n\u2705 Discounted tune-ups\n\u2705 10% off all Repairs\n\u2705 No diagnostic fee\n\u2705 Priority scheduling year-round\nJoin hundreds of homeowners who trust Wildwood to keep their machines reliable year after year.\nTo enroll, just fill out the attached contract.\nNeed help? Give us a call anytime at 888-658-9157.\nBest,\nWildwood Small Engine Repair\n"}],"competitors":{"sites":[{"url":"https://www.mrhandyman.com/kansas-city-liberty-gladstone/","da":57.0,"ahrefsTraffic":518.0,"semrushTraffic":"238.0","locationType":"Single location page","serviceType":"Multiple"},{"url":"https://handymanbillcan.com/","da":21.0,"ahrefsTraffic":200.0,"semrushTraffic":"191.0","locationType":"Multiple location pages","serviceType":"Multiple"},{"url":"https://qualityhandymankc.com/","da":8.0,"ahrefsTraffic":41.0,"semrushTraffic":"191.0","locationType":"Multiple location pages","serviceType":"Multiple"},{"url":"https://www.handymandankc.com/","da":4.0,"ahrefsTraffic":47.0,"semrushTraffic":"29.0","locationType":"Multiple location pages","serviceType":"Multiple"},{"url":"https://www.handyman2therescuellckc.com/","da":12.0,"ahrefsTraffic":68.0,"semrushTraffic":"881.0","locationType":"Multiple location pages","serviceType":"Multiple"},{"url":"https://www.acehandymanservices.com/offices/kansas-city","da":58.0,"ahrefsTraffic":null,"semrushTraffic":"11.8k","locationType":"Multiple location pages","serviceType":"Multiple"}],"keywords":{"https://www.mrhandyman.com/kansas-city-liberty-gladstone/":[{"keyword":"door replacement","volume":27100.0},{"keyword":"floor refinishers near me","volume":8100.0},{"keyword":"cabinet installers near me","volume":5400.0},{"keyword":"shower glass doors repair","volume":1300.0},{"keyword":"interior door installation near me","volume":1300.0},{"keyword":"kc handyman","volume":1000.0},{"keyword":"handyman in kansas city","volume":1000.0},{"keyword":"kansas city handyman","volume":null},{"keyword":"handyman kansas city","volume":1000.0},{"keyword":"door installation companies","volume":880.0},{"keyword":"general handyman services","volume":880.0},{"keyword":"handyman for small jobs","volume":880.0},{"keyword":"handyman manchester","volume":880.0},{"keyword":"exterior door repair","volume":880.0},{"keyword":"handyman to install bathroom vanity","volume":480.0},{"keyword":"staircase specialists near me","volume":320.0},{"keyword":"attic stair installation near me","volume":320.0},{"keyword":"staircase carpenter near me","volume":320.0},{"keyword":"kansas city handyman services","volume":260.0},{"keyword":"handyman service kansas city","volume":260.0},{"keyword":"handyman services kansas city","volume":260.0},{"keyword":"window installation kansas city","volume":170.0},{"keyword":"double hung window repair near me","volume":170.0},{"keyword":"kc handyman services","volume":140.0},{"keyword":"fence repair kansas city","volume":140.0},{"keyword":"drywall repair kansas city","volume":140.0},{"keyword":"gutter installation kansas city","volume":140.0},{"keyword":"deck repair kansas city","volume":140.0}],"https://handymanbillcan.com/":[{"keyword":"repair window screens near me","volume":22200.0},{"keyword":"window screen repair near me","volume":22200.0},{"keyword":"tv installation near me","volume":22200.0},{"keyword":"house repair services","volume":12100.0},{"keyword":"local handyman","volume":8100.0},{"keyword":"replacement window screens near me","volume":6600.0},{"keyword":"screen door repair near me","volume":6600.0},{"keyword":"wood rot repair","volume":6600.0},{"keyword":"cracked window repair","volume":6600.0},{"keyword":"tv installation service","volume":6600.0},{"keyword":"window repair home","volume":6600.0},{"keyword":"companies that fix windows","volume":4400.0},{"keyword":"good handyman near me","volume":3600.0},{"keyword":"handyman plumber near me","volume":3600.0},{"keyword":"plumber handyman near me","volume":3600.0},{"keyword":"handyman electrician","volume":3600.0},{"keyword":"electrician handyman","volume":3600.0},{"keyword":"best dandelion killer that won't kill grass","volume":2400.0},{"keyword":"best dandelion killer that won t kill grass","volume":2400.0},{"keyword":"electrician handyman near me","volume":2400.0},{"keyword":"door repair service","volume":1900.0},{"keyword":"local handyman services near me","volume":1900.0},{"keyword":"find handyman near me","volume":1600.0},{"keyword":"professional picture hanger","volume":1600.0},{"keyword":"how to fix rotted wood","volume":1600.0},{"keyword":"commercial handyman services","volume":1300.0},{"keyword":"picture hanging services","volume":1000.0},{"keyword":"picture hanging service near me","volume":1000.0}],"https://www.handyman2therescuellckc.com/":[{"keyword":"kc handyman","volume":1000.0},{"keyword":"handyman in kansas city","volume":1000.0},{"keyword":"kansas city handyman","volume":1000.0},{"keyword":"handyman kansas city","volume":1000.0},{"keyword":"handyman manchester","volume":880.0},{"keyword":"kansas city handyman services","volume":260.0},{"keyword":"handyman service kansas city","volume":260.0},{"keyword":"handyman services kansas city","volume":260.0},{"keyword":"handyman olathe","volume":210.0},{"keyword":"black owned handyman services near me","volume":110.0},{"keyword":"handyman kansas city mo","volume":70.0},{"keyword":"handyman kansas city ks","volume":70.0}],"https://www.acehandymanservices.com/offices/kansas-city":[{"keyword":"drywall repair near me","volume":27100.0},{"keyword":"drywall repair contractors","volume":6600.0},{"keyword":"drywall repair services","volume":1900.0},{"keyword":"ace hardware handyman service","volume":1600.0},{"keyword":"interior door installation near me","volume":1300.0},{"keyword":"handyman in kansas city","volume":1000.0},{"keyword":"kansas city handyman","volume":1000.0},{"keyword":"handyman kansas city","volume":1000.0},{"keyword":"handyman manchester","volume":880.0},{"keyword":"handyman painter near me","volume":590.0},{"keyword":"handyman to install bathroom vanity","volume":480.0},{"keyword":"residential door repair","volume":480.0},{"keyword":"handyman overland park","volume":260.0},{"keyword":"handyman service kansas city","volume":260.0},{"keyword":"kansas city handyman services","volume":260.0},{"keyword":"handyman services kansas city","volume":260.0},{"keyword":"house painters kansas city","volume":210.0},{"keyword":"handyman olathe ks","volume":210.0},{"keyword":"olathe handyman","volume":210.0},{"keyword":"handyman olathe","volume":210.0},{"keyword":"handyman lees summit","volume":170.0},{"keyword":"ace handyman services beaumont","volume":90.0},{"keyword":"ace handyman services wichita","volume":70.0},{"keyword":"ace hardware handyman near me","volume":70.0},{"keyword":"handyman kansas city mo","volume":70.0},{"keyword":"find local handyman services","volume":70.0},{"keyword":"handyman blue springs mo","volume":70.0},{"keyword":"handyman kansas city ks","volume":70.0}]},"missingKeywords":[{"keyword":"floor refinishers near me","volume":8100.0},{"keyword":"cabinet installers near me","volume":5400.0},{"keyword":"ace hardware handyman service","volume":1600.0},{"keyword":"shower glass doors repair","volume":1300.0},{"keyword":"interior door installation near me","volume":1300.0},{"keyword":"kc handyman","volume":1000.0},{"keyword":"handyman dan","volume":1000.0},{"keyword":"handyman in kansas city","volume":1000.0},{"keyword":"kansas city handyman","volume":1000.0},{"keyword":"handyman kansas city","volume":1000.0},{"keyword":"handyman manchester","volume":880.0},{"keyword":"exterior door repair","volume":880.0},{"keyword":"broken window glass repair","volume":880.0},{"keyword":"handyman to install bathroom vanity","volume":480.0},{"keyword":"staircase specialists near me","volume":320.0},{"keyword":"attic stair installation near me","volume":320.0},{"keyword":"staircase carpenter near me","volume":320.0},{"keyword":"handyman service kansas city","volume":260.0},{"keyword":"kansas city handyman services","volume":260.0},{"keyword":"handyman services kansas city","volume":260.0},{"keyword":"handyman overland park","volume":260.0},{"keyword":"handyman olathe ks","volume":210.0},{"keyword":"olathe handyman","volume":210.0},{"keyword":"handyman olathe","volume":210.0},{"keyword":"handyman lees summit","volume":170.0},{"keyword":"double hung window repair near me","volume":170.0},{"keyword":"kc handyman services","volume":140.0},{"keyword":"deck repair kansas city","volume":140.0},{"keyword":"fence repair kansas city","volume":140.0}]},"auditChecklist":[{"section":"","item":"Install SEO Wallet Chrome Plugin","status":"Not Completed","comment":"","score":"","link":"Install Link","tutorial":""},{"section":"","item":"Custom GPT | Solon SEO Sage","status":"Not Completed","comment":"","score":"","link":"Solon GPT","tutorial":""},{"section":"Website Speed","item":"Google PageSpeed Insight","status":"Not Completed","comment":"","score":"","link":"https://pagespeed.web.dev/","tutorial":"Masterclass on Website Loading Time"},{"section":"Website Speed","item":"GTMetrix","status":"Not Completed","comment":"","score":"","link":"https://gtmetrix.com/","tutorial":""},{"section":"Meta Data","item":"Title Tags","status":"Not Completed","comment":"","score":"","link":"https://cdn.zappy.app/4c8c55cbd07b85fb90e437c6453cdcbd.png","tutorial":"Masterclass Tutorial On Title Tags"},{"section":"Meta Data","item":"Meta Descriptions","status":"Not Completed","comment":"","score":"","link":"https://cdn.zappy.app/ba7de6da28e315d7e9001a1ad8fe6ebe.png","tutorial":"Masterclass Tutorial On Meta Descriptions"},{"section":"Images","item":"Image Type","status":"Completed","comment":"","score":"","link":"https://tinypng.com/","tutorial":"Masterclass Tutorial on Image Optimisation"},{"section":"Images","item":"Image Alt Tags","status":"Not Completed","comment":"","score":"","link":"https://cdn.zappy.app/0e3b56917f23a52513210a16f0a78ef7.png","tutorial":"Masterclass Tutorial On Img Alt Tags"},{"section":"Images","item":"Image Titles","status":"Not Completed","comment":"","score":"","link":"https://cdn.zappy.app/82aa21d98047b6f0abe67135d497411b.png","tutorial":""},{"section":"Security","item":"SSL Certificate","status":"Not Completed","comment":"","score":"","link":"https://www.godaddy.com/es/ssl-checker","tutorial":""},{"section":"Design Checklist","item":"Clear Call To Action on the First Fold?","status":"Not Completed","comment":"","score":"","link":"","tutorial":""},{"section":"Design Checklist","item":"Key Message Easy To Read?","status":"Not Completed","comment":"","score":"","link":"","tutorial":""},{"section":"Design Checklist","item":"Mobile Version Easy To Navigate?","status":"Not Completed","comment":"","score":"","link":"https://chromewebstore.google.com/detail/mobile-simulator-responsi/ckejmhbmlajgoklhgbapkiccekfoccmk","tutorial":""},{"section":"Design Checklist","item":"Easy to read typography?","status":"Not Completed","comment":"","score":"","link":"","tutorial":""}],"currentGmbs":{"known":[{"city":"Sioux Falls, SD","note":""},{"city":"Lee's Summit, MO","note":""},{"city":"Tea, SD","note":""},{"city":"Cape Coral, Fl","note":""},{"city":"Reno, Nevada","note":""}],"hidden":[{"city":"Katy, TX,","note":"Houston, TX find through description"},{"city":"Carmel, IN","note":"Crawfordsville, IN  find through description"},{"city":"Tampa, Fl","note":"Sarasota, FL find through description"},{"city":"Midway, Fl","note":""},{"city":"Elsa, TX","note":""},{"city":"Wayne County, MI","note":""}]},"domainSelection":[{"city":"Tallahassee","domain":"smallenginerepairtallahassee.com"},{"city":"Tallahassee","domain":"http://lawnmowerrepairtallahassee.com"},{"city":"Cape Coral","domain":"smallenginerepaircapecoral.com"},{"city":"Cape Coral","domain":"lawnmowerrepaircapecoral.com"},{"city":"Sarasota","domain":"smallenginerepairsarasota.com"},{"city":"Sarasota","domain":"lawnmowerrepairsarasota.com"},{"city":"Miami","domain":"lawnmowerrepairmiamifl.com"},{"city":"Miami","domain":"smallenginerepairmiami.com"},{"city":"Orlando","domain":"lawnmowerrepairorlandofl.com"},{"city":"Orlando","domain":"smallenginerepairorlando.com"},{"city":"West Palm Beach","domain":"lawnmowerrepairwestpalmbeach.com"},{"city":"West Palm Beach","domain":"smallenginerepairwestpalmbeach.com"},{"city":"Jacksonville","domain":"lawnmowerrepairjacksonville.com"},{"city":"Jacksonville","domain":"smallenginerepairjacksonville.com"},{"city":"Fort Lauderdale","domain":"smallenginerepairfortlauderdale.com"},{"city":"Fort Lauderdale","domain":"lawnmowerrepairfortlauderdale.com"},{"city":"St. Petersburg","domain":"smallenginerepairstpetersburg.com"},{"city":"St. Petersburg","domain":"lawnmowerrepairstpetersburg.com"},{"city":"Pensacola","domain":"smallenginerepairpensacola.com"},{"city":"Pensacola","domain":"lawnmowerrepairpensacola.com"},{"city":"Fort Myers","domain":"smallenginerepairfortmyers.com"},{"city":"Fort Myers","domain":"lawnmowerrepairfortmyersfl.com"},{"city":"Key West","domain":"smallenginerepairkeywest.com"},{"city":"Key West","domain":"lawnmowerrepairkeywest.com"},{"city":"Boca Raton","domain":"smallenginerepairbocaraton.com"},{"city":"Boca Raton","domain":"lawnmowerrepairbocaraton.com"}],"gmbStrategy":[{"phase":"Local Guide Phase","steps":[{"step":"Purpose","details":"Create soft-approved GMB listings without triggering postcard verification"},{"step":"Account & IP Setup","details":"\u2022 5 Local Guide Gmail accounts per specific city\n\u2022 5 AdsPower profiles \u2192 1 Gmail = 1 profile\n\u2022 Each profile uses unique City U.S. IP\n\u2022 Gmail must be 2+ weeks old before GMB Listing\n\u2022 Use real-looking U.S. names, matching city info\n\u2022 Use recovery email only or local U.S. number if needed\n\u2022 No cross-logging outside AdsPower\n Example Address: 9110 Strada Place, Naples, FL 34108  , 69 Yarra St, Geelong VIC 3220, Australia"},{"step":"Local Guide Leveling","details":"\u2022 Target Level 5\u20136 for better trust\n \u2022 1\u20133 local reviews/day (random businesses in City)\n \u2022 1\u20132 photo uploads/day (Street View, Facebook reuse, AI edits)\n \u2022 1\u20132 Q&A answers/day\n \u2022 Photo strategy: 80% Facebook page photos, 20% AI-generated interiors/offices"},{"step":"GMB Listing Creation","details":"\u2022 Use Local Guide \u2192 Add Missing Place\n \u2022 Include business name, category, address (commercial plaza, 2nd floor+), phone, email, website\n \u2022 Business hours, opening date\n \u2022 Upload 5\u201310 photos during creation\n \u2022 Leave listing live for 2 weeks before ownership claim"}]},{"phase":"Ownership Phase","steps":[{"step":"Purpose","details":"Take full control of GMB listings for long-term management and prevent suspension"},{"step":"City-Based Ownership Setup","details":"\u2022 5 cities \u2192 5 AdsPower profiles \u2192 5 unique city IPs\n \u2022 1 Gmail per city for ownership and ongoing management\n \u2022 City IP is preferred but nearby city IP can also work"},{"step":"Claiming Timeline","details":"Week 1\u20133: LG creates listings (soft approval)\nWeek 2\u20134: Claim ownership using city Gmail/IP\nPhone or email verification (postcard rare)"}]},{"phase":"Website & Citations","steps":[{"step":"Purpose","details":"Strengthen GMB trust, prevent suspension, and rank in local search results"},{"step":"State Website Setup","details":"\u2022 5 EMD Donaim name with 5 city landing pages and other pages.\n\u2022 Each city page: Exact NAP matching GMB, business email, hours, creation date, embedded map pin"},{"step":"Citations & Social Proof","details":"\u2022 50+ citations per city page with consistent NAP Before Creating GBP\n \u2022 Match GMB category with citation category\n \u2022 Create social profiles: Facebook, Instagram, LinkedIn"},{"step":"Ongoing SEO & Local Trust","details":"\u2022 Link EMD To GMB profiles\n \u2022 Weekly posts & updates\n \u2022 Add local blogs/updates\n \u2022 Keep building citations over time"}]}],"gbpTracker":[{"item":"GMB Approval Strategy","hasFile":true},{"item":"New Website's Keywords","hasFile":true},{"item":"Ads Power","hasFile":true},{"item":"Citations","hasFile":true},{"item":"New Websites Meta Data","hasFile":true},{"item":"GMB Cities","hasFile":true},{"item":"Adress Sheet","hasFile":true},{"item":"Gmb Verified","hasFile":false},{"item":"Off Page","hasFile":true},{"item":"Domain Selection","hasFile":true},{"item":"Content","hasFile":false},{"item":"Home Page","hasFile":true},{"item":"About","hasFile":false},{"item":"Pricing","hasFile":false},{"item":"Snow Blower Repair","hasFile":false},{"item":"Generator repair","hasFile":false},{"item":"ATV,UTV, Motorcycle Repair","hasFile":false},{"item":"Boat Engine Repair","hasFile":false},{"item":"Login Details","hasFile":true}],"flCities":{"cities":[{"city":"Tallahassee","county":"Leon County"},{"city":"Cape Coral","county":"Lee County"},{"city":"Naples","county":"Collier County"},{"city":"Tampa","county":"Hillsborough County"},{"city":"Sarasota","county":"Sarasota County"},{"city":"Boca Raton","county":"Palm Beach County"},{"city":"Miami (instead of Miami-Dade)","county":"Miami-Dade County"},{"city":"Orlando","county":"Orange County"},{"city":"Fort Lauderdale","county":"Broward County"},{"city":"West Palm Beach","county":"Palm Beach County"},{"city":"Jacksonville","county":"Duval County"},{"city":"St. Petersburg","county":"Pinellas County"},{"city":"Fort Myers","county":"Lee County"},{"city":"Pensacola","county":"Escambia County"},{"city":"Key West","county":"Monroe County"}],"services":[{"service":"Small Engine Repair","sub":""},{"service":"Lawn Mower Repair","sub":"Push Mowers"},{"service":"","sub":"Riding Mowers"},{"service":"","sub":"Zero-Turn Mowers"},{"service":"Generator Repair","sub":""},{"service":"Snow Blower Repair","sub":""},{"service":"Motorcycle, ATV & UTV Repair","sub":""},{"service":"Boat & Small Marine Engine Repair","sub":""}],"profiles":[{"city":"West Palm Beach","name":"West Palm Engine & Mower Repair","phone":"(561) 4206777","address":"515 N Flagler Dr, West Palm Beach, FL 33401","website":"https://lawnmowerrepairwestpalmbeach.com/","category":"Lawn Mower Repair","email":"info@lawnmowerrepairwestpalmbeach.com","domains":["lawnmowerrepairwestpalmbeach.com","smallenginerepairwestpalmbeach.com"],"gbpKeywords":["lawn mower repair west palm beach fl","small engine repair west palm beach","generator repair service","lawn riding lawn mowers","best push mowers","lawn mower carburetor cleaner","zero turn mowers","snow blower repair"],"competitors":[{"name":"Small Engine Guys Lawn Equipment Repair","source":"GMB Profile"},{"name":"Flynn Small Engine & Tool Rental","source":"GMB Profile"},{"name":"My Lawn Mower Repair","source":"Website"},{"name":"MOBILE Small engine repair","source":"GMB Profile"}],"pageKeywords":[{"keyword":"lawn mower repair west palm beach","volume":70.0,"kd":18.0},{"keyword":"small engine repair west palm beach","volume":40.0,"kd":9.0},{"keyword":"lawn mower repair west palm beach fl","volume":40.0,"kd":17.0},{"keyword":"lawn mower repair west palm beach","volume":70.0,"kd":18.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Fort Myers","name":"Fort Myers Outdoor Engine Repair","phone":"(239) 2165172","address":"5237 Summerlin Commons Blvd, Fort Myers, FL 33907","website":"https://lawnmowerrepairfortmyersfl.com/","category":"Lawn Mower Repair","email":"info@lawnmowerrepairfortmyersfl.com","domains":["smallenginerepairfortmyers.com","lawnmowerrepairfortmyersfl.com"],"gbpKeywords":["small engine repair fort myers florida","lawn mower repair fort myers fl","fort myers generators repair","lawn riding lawn mowers","cheap push mowers","best carburetor cleaner","zero turn mowers","snow blower repair"],"competitors":[{"name":"Cape Coral Mobile Small Engine Repair","source":"GMB Profile"},{"name":"Wildwood Mobile Small Engine","source":"Both( Website and GMB Profile  )"},{"name":"The king small engine service and repairs","source":"GMB Profile"},{"name":"Terry's Small Engine Repair & Auto Shop","source":"GMB Profile"}],"pageKeywords":[{"keyword":"small engine repair fort myers","volume":90.0,"kd":8.0},{"keyword":"small engine repair fort myers florida","volume":70.0,"kd":7.0},{"keyword":"small engine repair fort myers fl","volume":90.0,"kd":7.0},{"keyword":"lawn mower repair fort myers fl","volume":70.0,"kd":14.0},{"keyword":"lawn mower repair fort myers","volume":70.0,"kd":10.0},{"keyword":"small engine repair fort myers","volume":90.0,"kd":8.0},{"keyword":"small engine repair fort myers florida","volume":70.0,"kd":7.0},{"keyword":"fort myers generators","volume":30.0,"kd":15.0},{"keyword":"small engine repair","volume":20.0,"kd":31.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Miami","name":"Magic City Small Engine Services","phone":"3052805170.0","address":"2525 Ponce de Leon, Coral Gables, FL 33134","website":"https://lawnmowerrepairmiamifl.com","category":"Lawn Mower Repair","email":"info@lawnmowerrepairmiamifl.com","domains":["lawnmowerrepairmiamifl.com","smallenginerepairmiami.com"],"gbpKeywords":["lawn mower repair miami fl","small engine repair miami","best push mowers","riding lawn mowers","snow blower repair at home service","best carburetor cleaner","zero turn mowers","generator repair service"],"competitors":[{"name":"Handy Fixer mobile small engine repair","source":"GMB Profile"},{"name":"MOBILE Small engine repair","source":"GMB Profile"},{"name":"Delvis Lawn Mower","source":"GMB Profile"},{"name":"Home Guide","source":"Website"}],"pageKeywords":[{"keyword":"lawn mower repair miami","volume":140.0,"kd":11.0},{"keyword":"lawn mower repair miami fl","volume":90.0,"kd":16.0},{"keyword":"small engine repair miami","volume":20.0,"kd":0},{"keyword":"riding lawn mower repair","volume":10.0,"kd":26.0},{"keyword":"Generator Repair","volume":20.0,"kd":9.0},{"keyword":"Zero-Turn Mowers","volume":320.0,"kd":64.0},{"keyword":"Push Mowers","volume":10.0,"kd":48.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Tampa","name":"Tampa Small Engine Pros","phone":"(813) 537-0651","address":"2202 N Westshore Blvd, Tampa, FL 33607","website":"https://tampamowerrepair.com","category":"Lawn Mower Repair","email":"","domains":["https://tampamowerrepair.com/"],"gbpKeywords":["small engine repair tampa florida","lawn mower repair & service","best push mowers","riding lawn mowers","snow blower repair at home service","small engine carburetor cleaner","zero turn mowers","generator repair service"],"competitors":[{"name":"Supreme small engine repair","source":"GMB Profile"},{"name":"Bills On The Spot Lawn Mower Repair","source":"GMB Profile"},{"name":"Tampa Small Engine Repair","source":"Website"},{"name":"Mm mowers","source":"Website"}],"pageKeywords":[{"keyword":"lawn mower repair tampa","volume":210.0,"kd":26.0},{"keyword":"small engine repair tampa","volume":140.0,"kd":16.0},{"keyword":"small engine repair tampa florida","volume":90.0,"kd":25.0},{"keyword":"tampa small engine repair","volume":40.0,"kd":23.0},{"keyword":"mobile lawn mower repair","volume":10.0,"kd":20.0},{"keyword":"lawn mower repair tampa fl","volume":140.0,"kd":23.0},{"keyword":"mobile lawn mower repair tampa","volume":50.0,"kd":15.0},{"keyword":"Zero-Turn Mowers","volume":390.0,"kd":57.0},{"keyword":"zero turn mowers tampa","volume":10.0,"kd":0},{"keyword":"Riding Mowers","volume":20.0,"kd":62.0},{"keyword":"Push Mowers","volume":10.0,"kd":52.0},{"keyword":"Generator Repair","volume":30.0,"kd":8.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Tallahassee","name":"Tallahassee Engine & Mower Services","phone":"(850) 279-9003","address":"1415 Timberlane Rd, Tallahassee, FL 32312","website":"http://lawnmowerrepairtallahassee.com","category":"Lawn Mower Repair","email":"","domains":["lawnmowerrepairtallahassee.com"],"gbpKeywords":["small engine repair tallahassee florida","lawn mower repair tallahassee fl","cheap zero turn mowers","riding lawn mower repair","generator repair service","mobile small engine repair service","cheap push mowers","snow blower repair at home service","small engine repair tallahassee"],"competitors":[{"name":"Midtown Mowers","source":"GMB Profile"},{"name":"Southside Mower","source":"GMB Profile"},{"name":"Southern Mower Repair","source":"GMB Profile"},{"name":"Big Bend Lawn Enforcement Small Engine Repair","source":"Both( Website and GMB Profile  )"},{"name":"Esposito garden center","source":"Website"}],"pageKeywords":[{"keyword":"small engine repair tallahassee","volume":140.0,"kd":18.0},{"keyword":"small engine repair tallahassee florida","volume":110.0,"kd":18.0},{"keyword":"small engine repair tallahassee fl","volume":110.0,"kd":18.0},{"keyword":"tallahassee small engine repair","volume":40.0,"kd":18.0},{"keyword":"lawn mower repair tallahassee fl","volume":110.0,"kd":10.0},{"keyword":"small engine repair","volume":20.0,"kd":26.0},{"keyword":"lawn mower repair","volume":30.0,"kd":12.0},{"keyword":"riding lawn mower repair","volume":10.0,"kd":13.0},{"keyword":"lawn mower repair tallahassee florida","volume":90.0,"kd":4.0},{"keyword":"generator tallahassee","volume":50.0,"kd":5.0},{"keyword":"Generator Repair","volume":10.0,"kd":4.0},{"keyword":"Push Mowers","volume":10.0,"kd":48.0},{"keyword":"small zero turn mowers","volume":10.0,"kd":36.0},{"keyword":"cheap zero turn mowers","volume":0,"kd":0},{"keyword":"best price on zero turn lawn mowers","volume":0,"kd":0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Orlando","name":"","phone":"","address":"","website":"http://lawnmowerrepairorlandofl.com","category":"small engine repair","email":"","domains":["lawnmowerrepairorlandofl.com","smallenginerepairorlando.com"],"gbpKeywords":["small engine repair orlando fl","lawn mower repair orlando","generator repair service","riding lawn mower repair","zero turn mowers","best push mowers","snow blower repair","lawn mower repair orlando","small engine repair orlando"],"competitors":[{"name":"Mow Lawn and Landscape equipment repair","source":"GMB Profile"},{"name":"Kj's small engine repairs","source":"GMB Profile"},{"name":"Trail Saw & Mower Service Inc.","source":"GMB Profile"},{"name":"Home Guide","source":"Website"}],"pageKeywords":[{"keyword":"lawn mower repair orlando","volume":110.0,"kd":9.0},{"keyword":"small engine repair orlando","volume":90.0,"kd":19.0},{"keyword":"lawn mower repair orlando fl","volume":90.0,"kd":16.0},{"keyword":"small engine repair orlando fl","volume":70.0,"kd":18.0},{"keyword":"orlando lawn mower repair","volume":50.0,"kd":8.0},{"keyword":"lawn mower service orlando","volume":40.0,"kd":3.0},{"keyword":"small engine repair","volume":50.0,"kd":31.0},{"keyword":"riding lawn mower repair","volume":10.0,"kd":19.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Naples","name":"","phone":"","address":"","website":"https://naplesmowerrepair.com","category":"small engine repair","email":"","domains":[],"gbpKeywords":["small engine repair naples","lawn mower repair naples fl","cheap push mowers","riding lawn mowers","snow blower repair at home service","best carburetor cleaner","zero turn mowers","generator repair service","small engine repair naples"],"competitors":[{"name":"Adam's Mobile Small Engine Repair","source":"Both( Website and GMB Profile  )"},{"name":"Sarlo Mowers LLC","source":"GMB Profile"},{"name":"Next Door","source":"Websiite"},{"name":"NAPLES SMALL ENGINE REPAIR LLC","source":"GMB Profile"}],"pageKeywords":[{"keyword":"small engine repair naples","volume":70.0,"kd":24.0},{"keyword":"small engine repair naples fl","volume":70.0,"kd":25.0},{"keyword":"naples small engine repair","volume":30.0,"kd":0},{"keyword":"mobile small engine repair naples fl","volume":0,"kd":20.0},{"keyword":"small engine repair naples","volume":10.0,"kd":29.0},{"keyword":"lawn mower repair naples fl","volume":30.0,"kd":0},{"keyword":"mobile lawn mower repair naples fl","volume":10.0,"kd":0},{"keyword":"generator repair naples","volume":30.0,"kd":8.0},{"keyword":"generator repair naples fl","volume":30.0,"kd":10.0},{"keyword":"naples generator repair","volume":20.0,"kd":0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Cape Coral","name":"","phone":"","address":"","website":"https://capecoralmowerrepair.com/","category":"small engine repair","email":"","domains":["smallenginerepaircapecoral.com","lawnmowerrepaircapecoral.com"],"gbpKeywords":["lawn mower repair cape coral fl","small engine repair cape coral fl","cheap push mowers","riding lawn mowers","snow blower repair at home service","cleaning carburetor on push mower","zero turn mowers","generator repair service","lawn mower repair cape coral fl"],"competitors":[{"name":"Wildwood Mobile Small Engine","source":"Both( Website and GMB Profile  )"},{"name":"Sarlo Mowers","source":"GMB Profile"},{"name":"Cape Coral Mobile Small Engine Repair","source":"GMB Profile"},{"name":"Tri County Small Engine Repair","source":"GMB Profile"}],"pageKeywords":[{"keyword":"lawn mower repair cape coral fl","volume":110.0,"kd":13.0},{"keyword":"lawn mower repair cape coral florida","volume":90.0,"kd":16.0},{"keyword":"lawn mower repair in cape coral","volume":30.0,"kd":11.0},{"keyword":"small engine repair cape coral fl","volume":70.0,"kd":18.0},{"keyword":"lawn mower repair cape coral","volume":70.0,"kd":16.0},{"keyword":"small engine repair","volume":20.0,"kd":30.0},{"keyword":"lawn mower repair","volume":20.0,"kd":23.0},{"keyword":"Generator Repair","volume":10.0,"kd":7.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Sarasota","name":"","phone":"","address":"","website":"","category":"small engine repair","email":"","domains":["lawnmowerrepairsarasota.com","smallenginerepairsarasota.com"],"gbpKeywords":["small engine repair sarasota","lawn mower repair sarasota florida","push lawn mowers","riding lawn mowers","snow blower repair at home service","best carburetor cleaner","zero turn mowers","generator repair service","small engine repair sarasota florida"],"competitors":[{"name":"Mowers, Inc.","source":"GMB Profile"},{"name":"Gaskell Small Engine Repair","source":"GMB Profile"},{"name":"Wildwood Mobile Small Engine","source":"Website"},{"name":"Bbb","source":"Website"},{"name":"RoyaltyRepair","source":"GMB Profile"}],"pageKeywords":[{"keyword":"small engine repair sarasota florida","volume":70.0,"kd":11.0},{"keyword":"small engine repair sarasota","volume":70.0,"kd":4.0},{"keyword":"small engine repair","volume":10.0,"kd":31.0},{"keyword":"lawn mower repair","volume":10.0,"kd":30.0},{"keyword":"lawn mower repair sarasota fl","volume":50.0,"kd":10.0},{"keyword":"sarasota small engine repair","volume":40.0,"kd":4.0},{"keyword":"lawn mower repair sarasota florida","volume":50.0,"kd":15.0},{"keyword":"lawn mower repair sarasota","volume":70.0,"kd":15.0},{"keyword":"sarasota lawn mower repair","volume":30.0,"kd":10.0},{"keyword":"zero turn mower tune up","volume":10.0,"kd":32.0},{"keyword":"Generator Repair","volume":10.0,"kd":8.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Jacksonville","name":"","phone":"","address":"","website":"","category":"small engine repair","email":"","domains":["lawnmowerrepairjacksonville.com","smallenginerepairjacksonville.com"],"gbpKeywords":["lawn mower repair jacksonville fl","mobile lawn mower repair jacksonville fl","small engine repair jacksonville fl","lawn riding lawn mowers","cheap push mowers","best carburetor cleaner","zero turn mowers","snow blower repair","generator repair service"],"competitors":[{"name":"Oberto's Small Engine Repair","source":"GMB Profile"},{"name":"Superior Saw & Small Engine","source":"GMB Profile"},{"name":"Shane's Small Engine Shop","source":"GMB Profile"},{"name":"Jay's small engine repair by appointment only","source":"GMB Profile"}],"pageKeywords":[{"keyword":"lawn mower repair jacksonville fl","volume":320.0,"kd":7.0},{"keyword":"lawn equipment repair jacksonville fl","volume":140.0,"kd":12.0},{"keyword":"small engine repair jacksonville","volume":170.0,"kd":12.0},{"keyword":"lawn mower repair jacksonville","volume":90.0,"kd":7.0},{"keyword":"jacksonville lawn mower repair","volume":70.0,"kd":7.0},{"keyword":"lawn mower parts jacksonville fl","volume":30.0,"kd":10.0},{"keyword":"lawn mower parts jacksonville","volume":30.0,"kd":10.0},{"keyword":"small engine repair jacksonville nc","volume":70.0,"kd":17.0},{"keyword":"small engine repair jacksonville fl","volume":210.0,"kd":22.0},{"keyword":"lawn mower sales jacksonville fl","volume":40.0,"kd":0},{"keyword":"small engine repair jacksonville","volume":170.0,"kd":12.0},{"keyword":"mobile lawn mower repair jacksonville fl","volume":90.0,"kd":18.0},{"keyword":"Zero-Turn Mowers","volume":390.0,"kd":61.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Fort Lauderdale","name":"","phone":"","address":"","website":"","category":"small engine repair","email":"","domains":["lawnmowerrepairfortlauderdale.com","lawnmowerepairfortlauderdale.com"],"gbpKeywords":["small engine repair fort lauderdale fl","generator maintenance fort lauderdale","lawn riding lawn mowers","cheap push mowers","lawn mower repair","generator repair service","best carburetor cleaner","zero turn mowers","snow blower repair"],"competitors":[{"name":"Lauderdale Lakes Small Engine","source":"GMB Profile"},{"name":"Glades Small Engine Lawn Mower Repair Generator Repair","source":"GMB Profile"},{"name":"Next Door","source":"Website"},{"name":"Home Guide","source":"Website"}],"pageKeywords":[{"keyword":"small engine repair fort lauderdale","volume":40.0,"kd":17.0},{"keyword":"small engine repair fort lauderdale fl","volume":30.0,"kd":18.0},{"keyword":"generator maintenance fort lauderdale","volume":40.0,"kd":5.0},{"keyword":"lawn mower repair fort lauderdale","volume":40.0,"kd":18.0},{"keyword":"small engine repair fort lauderdale","volume":40.0,"kd":17.0},{"keyword":"lawn mower repair","volume":20.0,"kd":21.0},{"keyword":"small engine repair","volume":20.0,"kd":34.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"St. Petersburg","name":"","phone":"","address":"","website":"","category":"small engine repair","email":"","domains":["lawnmowerrepairstpetersburg.com","smallenginerepairstpetersburg.com"],"gbpKeywords":["lawn mower repair st petersburg fl","small engine repair st petersburg fl","generator repair service","lawn riding lawn mowers","best push mowers","cleaning carburetor on push mower","zero turn mowers","snow blower repair","lawn mower repair st petersburg fl"],"competitors":[{"name":"Kenny's Small Engine Repair LLC","source":"GMB Profile"},{"name":"Jason's Small Engine Repair","source":"GMB Profile"},{"name":"Next Door","source":"Website"},{"name":"Rob's Small Engine Repair","source":"GMB Profile"}],"pageKeywords":[{"keyword":"lawn mower repair st petersburg fl","volume":90.0,"kd":23.0},{"keyword":"lawn mower repair st petersburg","volume":70.0,"kd":24.0},{"keyword":"small engine repair st petersburg fl","volume":30.0,"kd":25.0},{"keyword":"small engine repair","volume":40.0,"kd":31.0},{"keyword":"Generator Repair","volume":10.0,"kd":8.0},{"keyword":"lawn mower repair","volume":30.0,"kd":26.0},{"keyword":"Zero-Turn Mowers","volume":140.0,"kd":61.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Pensacola","name":"","phone":"","address":"","website":"","category":"small engine repair","email":"","domains":["smallenginerepairpensacola.com","lawnmowerrepairpensacola.com"],"gbpKeywords":["small engine repair pensacola","lawn mower repair pensacola fl","mobile small engine repair service","riding lawnmower repairs","zero turn mowers","generator repair service","small engine carburetor cleaner","cleaning carburetor on push mower","small engine repair pensacola"],"competitors":[{"name":"Dennis's Small Engine Repair","source":"GMB Profile"},{"name":"Lonnie Alderman Lawnmower and Small Engine Part no repair","source":"GMB Profile"},{"name":"Bellview Small Engine Repair, Inc.","source":"GMB Profile"},{"name":"Doc Small Engine Repair","source":"Website"}],"pageKeywords":[{"keyword":"small engine repair pensacola","volume":210.0,"kd":24.0},{"keyword":"lawn mower repair pensacola fl","volume":140.0,"kd":18.0},{"keyword":"small engine repair pensacola florida","volume":140.0,"kd":24.0},{"keyword":"lawn mower repair pensacola","volume":140.0,"kd":20.0},{"keyword":"pensacola small engine repair","volume":140.0,"kd":25.0},{"keyword":"small engine repair pensacola florida","volume":140.0,"kd":24.0},{"keyword":"lawn mower repair pensacola fl","volume":140.0,"kd":18.0},{"keyword":"lawn mower repair pensacola","volume":140.0,"kd":20.0},{"keyword":"pensacola small engine repair","volume":140.0,"kd":25.0},{"keyword":"small engine repair pensacola fl","volume":110.0,"kd":24.0},{"keyword":"lawn mower repair pensacola florida","volume":90.0,"kd":19.0},{"keyword":"small engine and generator repair","volume":90.0,"kd":26.0},{"keyword":"mobile small engine repair service","volume":70.0,"kd":33.0},{"keyword":"small engine repair at your home","volume":70.0,"kd":21.0},{"keyword":"pensacola lawn mower repair","volume":40.0,"kd":18.0},{"keyword":"generator repair florida","volume":40.0,"kd":0},{"keyword":"generator small engine repair","volume":40.0,"kd":26.0},{"keyword":"professional small engine repair","volume":40.0,"kd":6.0},{"keyword":"riding lawnmower repairs","volume":30.0,"kd":26.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Key West","name":"","phone":"","address":"","website":"","category":"small engine repair","email":"","domains":["smallenginerepairkeywest.com","lawnmowerrepairkeywest.com"],"gbpKeywords":["small engine repair key west fl","zero turn lawn mowers","mobile small engine repair service","generator repair service","lawn mower carburetor cleaner","sharpening lawn mower blades","Generator Repair","small engine repair key west","small engine repair key west fl"],"competitors":[{"name":"Bill's Small Vehicle Repair","source":"GMB Profile"},{"name":"Handy Fixer mobile small engine repair","source":"GMB Profile"}],"pageKeywords":[{"keyword":"small engine repair key west","volume":0,"kd":0},{"keyword":"small engine repair key west fl","volume":0,"kd":0},{"keyword":"small engine repair","volume":10.0,"kd":36.0},{"keyword":"Generator Repair","volume":10.0,"kd":14.0},{"keyword":"push mower tune up","volume":10.0,"kd":41.0},{"keyword":"zero turn mower tune up","volume":10.0,"kd":26.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]},{"city":"Boca Raton","name":"","phone":"","address":"","website":"","category":"small engine repair","email":"","domains":["smallenginerepairbocaraton.com","lawnmowerrepairbocaraton.com"],"gbpKeywords":["lawn mower repair boca raton fl","small engine repair boca raton","best push mowers","riding lawn mowers","snow blower repair at home service","best carburetor cleaner","zero turn mowers","generator repair service","small engine repair boca raton"],"competitors":[{"name":"JLM Small Engine Repair, Inc.","source":"GMB Profile"},{"name":"All Equipment Repairs and Services","source":"GMB Profile"},{"name":"MOBILE Small engine repair","source":"GMB Profile"},{"name":"Wildwood Mobile Small Engine","source":"Website"},{"name":"Pronto Mowers","source":"Website"}],"pageKeywords":[{"keyword":"small engine repair boca raton","volume":40.0,"kd":2.0},{"keyword":"lawn mower repair","volume":10.0,"kd":13.0},{"keyword":"lawn mower repair boca raton fl","volume":20.0,"kd":0},{"keyword":"lawn mower repair in boca raton florida","volume":0,"kd":0},{"keyword":"small engine repair","volume":10.0,"kd":29.0},{"keyword":"how to repair a lawn mower","volume":0,"kd":0},{"keyword":"how to repair small engines","volume":0,"kd":0},{"keyword":"how to repair self propelled lawn mower","volume":0,"kd":0},{"keyword":"how to repair a lawn mower pull cord","volume":0,"kd":0},{"keyword":"how to repair a lawn mower carburetor","volume":0,"kd":0},{"keyword":"how much does it cost to repair a lawn mower","volume":0,"kd":0},{"keyword":"how much does lawn mower repair cost","volume":0,"kd":0},{"keyword":"how to repair a riding lawn mower","volume":0,"kd":0},{"keyword":"is it cheaper to repair or replace a lawn mower","volume":0,"kd":0},{"keyword":"how to repair lawn mower throttle cable","volume":0,"kd":0},{"keyword":"where to repair lawn mower","volume":0,"kd":0}]}]},"gbpProfiles":[{"city":"Crawfordsville, IN","name":"Mobile Wildwood Mower Repair / Generator CRF","phone":"(765) 436-1206","address":"Crawfordsville, IN","website":"https://wildwoodsmallenginerepair.com/","category":"Lawn mower repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"lawn mower repair near me","searches":"47.0"},{"keyword":"mobile lawn mower repair","searches":"17.0"},{"keyword":"lawn mower repair crawfordsville indiana","searches":"16.0"},{"keyword":"small engine repair crawfordsville indiana","searches":"16.0"},{"keyword":"generator repair","searches":"< 15"},{"keyword":"in home lawn mower repair","searches":"< 15"},{"keyword":"lawn mower blade sharpening near me","searches":"< 15"},{"keyword":"lawn mower repair","searches":"< 15"},{"keyword":"lawn mower repair crawfordsville in","searches":"< 15"},{"keyword":"lawnmower repair near me","searches":"< 15"},{"keyword":"mobile lawn mower repair companies greenfield indiana","searches":"< 15"},{"keyword":"mobile lawn mower repair near me","searches":"< 15"},{"keyword":"mobile mower repair","searches":"< 15"},{"keyword":"mobile small engine repair near me","searches":"< 15"},{"keyword":"mower repair","searches":"< 15"},{"keyword":"mower repair near me","searches":"< 15"},{"keyword":"small engine repair near me","searches":"< 15"},{"keyword":"traveling lawn mower repair near me","searches":"< 15"},{"keyword":"wildwood small engine repair","searches":"< 15"}]},{"city":"Lees Summit, MO","name":"Quick and Mobile Wildwood Small Engine Repair","phone":"(816) 837-4480","address":"3636 Sw crane rd, Lee's Summit, MO 64082","website":"https://wildwoodsmallenginerepair.com/?utm_campaign=gmb","category":"Lawn mower repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"mobile lawn mower repair near me","searches":"135.0"},{"keyword":"lawn mower repair near me","searches":"112.0"},{"keyword":"lawn mower repair","searches":"21.0"},{"keyword":"mobile lawn mower repair","searches":"17.0"},{"keyword":"generator repair near me","searches":"< 15"},{"keyword":"in hou,tx bob elders mobile generator repair","searches":"< 15"},{"keyword":"lawn mower blade sharpening near me","searches":"< 15"},{"keyword":"lawn mower repair houston","searches":"< 15"},{"keyword":"lawn mower repair mobile","searches":"< 15"},{"keyword":"lawn mower repair on hempstead road houston tx","searches":"< 15"},{"keyword":"lawn mower repair service stafford","searches":"< 15"},{"keyword":"lawn mower service","searches":"< 15"},{"keyword":"lawn mower service and equipment","searches":"< 15"},{"keyword":"lawnmower repair near me","searches":"< 15"},{"keyword":"lawnmower repair that comes to your house","searches":"< 15"},{"keyword":"mobile generator repair","searches":"< 15"},{"keyword":"mobile lawn mower repair houston","searches":"< 15"},{"keyword":"mobile lawnmower repair houston","searches":"< 15"},{"keyword":"mobile mower repair","searches":"< 15"},{"keyword":"mobile mower repair near me","searches":"< 15"}]},{"city":"Sioux Falls, SD ","name":"Mobile Wildwood Mower Repair / Snow Blower","phone":"(605) 657-6487","address":"2101 W 41st St, Sioux Falls, SD 57105","website":"https://wildwoodsmallenginerepair.com/souix-falls-south-dakota/","category":"Lawn mower repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"small engine repair sioux falls","searches":"486.0"},{"keyword":"lawn mower repair sioux falls","searches":"306.0"},{"keyword":"small engine repair near me","searches":"188.0"},{"keyword":"lawn mower repair near me","searches":"156.0"},{"keyword":"lawn mower repair","searches":"60.0"},{"keyword":"small engine repair","searches":"58.0"},{"keyword":"lawn mower blade sharpening near me","searches":"34.0"},{"keyword":"lawnmower repair near me","searches":"28.0"},{"keyword":"mower repair near me","searches":"22.0"},{"keyword":"sioux falls lawn mower repair","searches":"19.0"},{"keyword":"lawn mower","searches":"18.0"},{"keyword":"2101 w 41st streetsioux fallssd57105","searches":"< 15"},{"keyword":"ariens dealer near me","searches":"< 15"},{"keyword":"ariens lawn mower parts near me","searches":"< 15"},{"keyword":"bills small repairs","searches":"< 15"},{"keyword":"bob-cat mowers","searches":"< 15"},{"keyword":"chainsaw repair","searches":"< 15"},{"keyword":"chainsaw repair near me","searches":"< 15"},{"keyword":"contract mowers in sioux falls south dakota","searches":"< 15"},{"keyword":"espeland small engine repair","searches":"< 15"}]},{"city":"Sarasota, FL","name":"Mobile Wildwood Mower Repair / Generator SRQ","phone":"(941) 273-8085","address":"Sarasota, FL","website":"https://wildwoodsmallenginerepair.com/","category":"Small engine repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"small engine repair sarasota","searches":"84.0"},{"keyword":"wildwood small engine repair","searches":"22.0"},{"keyword":"small engine repair near me","searches":"19.0"},{"keyword":"generator repair near me","searches":"< 15"},{"keyword":"generator.maintenenace.lakewood.ranch fl","searches":"< 15"},{"keyword":"mobile lawn mower repair in ruskin fl","searches":"< 15"},{"keyword":"mobile lawn mower repair sarasota","searches":"< 15"},{"keyword":"mobile mower repair near me","searches":"< 15"},{"keyword":"mobile small engine repair near me","searches":"< 15"},{"keyword":"mobile small engine repair near me open now","searches":"< 15"},{"keyword":"mower repair near me","searches":"< 15"},{"keyword":"small engine repair bradenton","searches":"< 15"},{"keyword":"small engine repair mobile","searches":"< 15"},{"keyword":"small generator repair near me","searches":"< 15"}]},{"city":"Cape Coral, Fl","name":"Wildwood Mobile Small Engine Repair Fl","phone":"(239) 766-5543","address":"3514 se 4th place, cape coral, FL 33904","website":"https://wildwoodsmallenginerepair.com/cape-coral/","category":"Lawn mower repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"lawn mower repair cape coral","searches":"218.0"},{"keyword":"small engine repair cape coral","searches":"164.0"},{"keyword":"small engine repair near me","searches":"131.0"},{"keyword":"lawn mower repair near me","searches":"116.0"},{"keyword":"generator repair near me","searches":"58.0"},{"keyword":"mobile lawn mower repair near me","searches":"44.0"},{"keyword":"small engine repair","searches":"42.0"},{"keyword":"portable generator repair near me","searches":"40.0"},{"keyword":"lawnmower repair near me","searches":"36.0"},{"keyword":"lawn mower repair service","searches":"34.0"},{"keyword":"small engine repair service","searches":"33.0"},{"keyword":"mower repair near me","searches":"24.0"},{"keyword":"wildwood","searches":"19.0"},{"keyword":"wildwood small engine repair","searches":"19.0"},{"keyword":"mobile lawn mower repair","searches":"18.0"},{"keyword":"engine","searches":"16.0"},{"keyword":"barry's power equipment, inc.","searches":"< 15"},{"keyword":"cape coral mobile generator repair","searches":"< 15"},{"keyword":"cape coral mobile small engine repair","searches":"< 15"},{"keyword":"cape coral small engine repair","searches":"< 15"}]},{"city":"Brownsville, TX","name":"Wildwood Small Engine Repair","phone":"(361) 203-4876","address":"Brownsville, TX","website":"https://wildwoodsmallenginerepair.com/brownsville-texas/","category":"Lawn mower repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"wildwood small engine repair","searches":"135.0"},{"keyword":"lawn mower repair brownsville tx","searches":"118.0"},{"keyword":"lawn mower repair near me","searches":"105.0"},{"keyword":"small engine repair near me","searches":"74.0"},{"keyword":"lawnmower repair near me","searches":"23.0"},{"keyword":"small engine repair","searches":"18.0"},{"keyword":"generator repair near me","searches":"< 15"},{"keyword":"i'm looking for somebody who fix lawnmowers in harlingen","searches":"< 15"},{"keyword":"lawn mower","searches":"< 15"},{"keyword":"lawn mower repair","searches":"< 15"},{"keyword":"lawn mower repair in brownsville texas","searches":"< 15"},{"keyword":"lawn mower repair los fresnos","searches":"< 15"},{"keyword":"lawn mower repair los fresnos tx","searches":"< 15"},{"keyword":"lawn mower service","searches":"< 15"},{"keyword":"lawn tracror repair shop","searches":"< 15"},{"keyword":"lawnmower repair services","searches":"< 15"},{"keyword":"lawnmower service repair","searches":"< 15"},{"keyword":"riding lawn mower repair near me","searches":"< 15"},{"keyword":"riding lawn mower repair price list near me","searches":"< 15"},{"keyword":"small engine repair brownsville tx","searches":"< 15"}]},{"city":"Sioux Falls, SD 2","name":"Quick and Mobile Wildwood Small Engine Repair","phone":"(605) 853-8240","address":"Sioux Falls, SD","website":"https://wildwoodsmallenginerepair.com/","category":"Small engine repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"small engine repair sioux falls","searches":"309.0"},{"keyword":"small engine repair near me","searches":"260.0"},{"keyword":"small engine repair","searches":"174.0"},{"keyword":"wildwood small engine repair","searches":"73.0"},{"keyword":"lawn mower repair sioux falls","searches":"71.0"},{"keyword":"lawn mower repair near me","searches":"57.0"},{"keyword":"quick and mobile wildwood small engine repair","searches":"36.0"},{"keyword":"dell rapids small engine repair","searches":"< 15"},{"keyword":"fix lawnmower","searches":"< 15"},{"keyword":"lawn mower repair","searches":"< 15"},{"keyword":"lawnmower repair near me","searches":"< 15"},{"keyword":"mobile phone repair service at home","searches":"< 15"},{"keyword":"mobile small engine repair near me","searches":"< 15"},{"keyword":"mower blade sharpening near me","searches":"< 15"},{"keyword":"mower repair near me","searches":"< 15"},{"keyword":"mower repair sioux falls","searches":"< 15"},{"keyword":"quick and mobile wildwood small enigne repair","searches":"< 15"},{"keyword":"sioux falls small engine repair","searches":"< 15"},{"keyword":"small engine repair in sioux falls","searches":"< 15"},{"keyword":"small engine repair near 3805 s villanova ave","searches":"< 15"}]},{"city":"Tallahassee, FL","name":"ONLY Mobile Wildwood Mower Repair / Generator","phone":"(239) 688-3815","address":"Tallahassee, FL","website":"https://wildwoodsmallenginerepair.com/","category":"Lawn mower repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"lawn mower repair tallahassee","searches":"173.0"},{"keyword":"small engine repair tallahassee","searches":"158.0"},{"keyword":"small engine repair near me","searches":"125.0"},{"keyword":"lawn mower repair near me","searches":"117.0"},{"keyword":"mobile lawn mower repair near me","searches":"41.0"},{"keyword":"mobile lawn mower repair","searches":"34.0"},{"keyword":"small engine repair","searches":"17.0"},{"keyword":"mobile lawn mower repair tallahassee","searches":"16.0"},{"keyword":"engine repair near tallahassee fl","searches":"< 15"},{"keyword":"generator repair near me","searches":"< 15"},{"keyword":"lawn mower repair","searches":"< 15"},{"keyword":"lawn mower repair tallahassee fl","searches":"< 15"},{"keyword":"lawn mower repairs","searches":"< 15"},{"keyword":"lawnmower repair near me","searches":"< 15"},{"keyword":"lawnmower repair tallahassee","searches":"< 15"},{"keyword":"mobile lawn care equipment","searches":"< 15"},{"keyword":"mobile lawn mower repair boykin","searches":"< 15"},{"keyword":"mobile lawnmower repair near me","searches":"< 15"},{"keyword":"mobile mower repair near me","searches":"< 15"},{"keyword":"mobile small engine repair near me","searches":"< 15"}]},{"city":"Lapeer, MI","name":"Mobile Wildwood Repair Services: Mowers, Generators, & Snow Blowers","phone":"(888) 594-5516","address":"Lapeer, MI","website":"https://wildwoodsmallenginerepair.com/","category":"Lawn mower repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"lawn mower repair near me","searches":"164.0"},{"keyword":"small engine repair near me","searches":"107.0"},{"keyword":"mobile lawn mower repair near me","searches":"55.0"},{"keyword":"wildwood small engine repair","searches":"36.0"},{"keyword":"lawn mower repair","searches":"20.0"},{"keyword":"mobile lawn mower repair","searches":"19.0"},{"keyword":"generator repair","searches":"< 15"},{"keyword":"generator repair near me","searches":"< 15"},{"keyword":"generator repair, marlette michigan","searches":"< 15"},{"keyword":"lawn mower blade sharpening near me","searches":"< 15"},{"keyword":"lawn mower mobile repair near me","searches":"< 15"},{"keyword":"lawn mower repair lapeer","searches":"< 15"},{"keyword":"lawn mower repair services","searches":"< 15"},{"keyword":"lawn mower repairs near me","searches":"< 15"},{"keyword":"lawn mower tune up near me","searches":"< 15"},{"keyword":"lawn tractor repair near me","searches":"< 15"},{"keyword":"lawnmower repair near me","searches":"< 15"},{"keyword":"mobile lawn equipment service near lapeer","searches":"< 15"},{"keyword":"mobile lawn mower repair michigan","searches":"< 15"}]},{"city":"Houston, TX","name":"Mobile Wildwood Mower Repair / Generator HOU","phone":"(713) 561-5922","address":"Houston, TX","website":"https://wildwoodsmallenginerepair.com/","category":"Lawn mower repair service","facebook":"https://www.facebook.com/Wildwoodsmallenginerepair","instagram":"https://www.instagram.com/wildwoodsmallenginerepair/","searchTerms":[{"keyword":"generator repair","searches":"< 15"},{"keyword":"lawn mower repair","searches":"< 15"},{"keyword":"lawn mower repair crawfordsville indiana","searches":"< 15"},{"keyword":"lawn mower repair near me","searches":"< 15"},{"keyword":"lawnmower repair near me","searches":"< 15"},{"keyword":"mobile lawn mower repair","searches":"< 15"},{"keyword":"mobile lawn mower repair near me","searches":"< 15"},{"keyword":"mobile small engine repair near me","searches":"< 15"},{"keyword":"mobile snowblower repair","searches":"< 15"},{"keyword":"mobile snowblower repair near me","searches":"< 15"},{"keyword":"mobile wildwood mower repair / generator crf","searches":"< 15"},{"keyword":"mower repair in hendricks county indiana","searches":"< 15"},{"keyword":"mower repair near me","searches":"< 15"},{"keyword":"portable generator repair near me","searches":"< 15"},{"keyword":"small engine repair crawfordsville indiana","searches":"< 15"},{"keyword":"small engine repair near me","searches":"< 15"},{"keyword":"traveling lawn mower repair near me","searches":"< 15"},{"keyword":"who can service a snow snowblower near me","searches":"< 15"}]}],"keywordResearch":{"Sioux Falls, SD":[{"keyword":"sioux falls small engine repair","volume":210.0,"kd":0},{"keyword":"generator repair sioux falls","volume":10.0,"kd":0},{"keyword":"small engine repair","volume":50.0,"kd":0},{"keyword":"small engine repair sioux falls","volume":50.0,"kd":0},{"keyword":"dave's small engine repair sioux falls","volume":10.0,"kd":0},{"keyword":"generac generator repair service","volume":10.0,"kd":0},{"keyword":"dave's small engine repair sioux falls sd","volume":10.0,"kd":0},{"keyword":"generator repair","volume":10.0,"kd":0},{"keyword":"small engine parts sioux falls","volume":10.0,"kd":0},{"keyword":"generator repair services","volume":10.0,"kd":0},{"keyword":"small engine repair sioux falls sd","volume":210.0,"kd":0},{"keyword":"small engine repair sioux falls south dakota","volume":210.0,"kd":0},{"keyword":"onan generator repair","volume":10.0,"kd":0},{"keyword":"engine repair sioux falls","volume":10.0,"kd":0},{"keyword":"portable generator repair","volume":10.0,"kd":0},{"keyword":"sioux falls engine repair","volume":10.0,"kd":0},{"keyword":"small generator repair near me","volume":10.0,"kd":0},{"keyword":"yamaha generator repair near me","volume":10.0,"kd":0},{"keyword":"kohler generator repair","volume":10.0,"kd":0},{"keyword":"snow blower repair sioux falls","volume":10.0,"kd":0}],"Reno, Nevada":[{"keyword":"generator repair reno nv","volume":10.0,"kd":0},{"keyword":"generator repair reno","volume":10.0,"kd":0},{"keyword":"generator repair","volume":10.0,"kd":0},{"keyword":"portable generator repair","volume":10.0,"kd":0},{"keyword":"generator service and repair","volume":10.0,"kd":0},{"keyword":"generator repair service near me","volume":10.0,"kd":0},{"keyword":"generator repair services","volume":10.0,"kd":0},{"keyword":"home generator repair","volume":10.0,"kd":0},{"keyword":"onan generator repair","volume":10.0,"kd":0},{"keyword":"fix generator near me","volume":10.0,"kd":0},{"keyword":"generator fix near me","volume":10.0,"kd":0},{"keyword":"honda generator repair","volume":10.0,"kd":0},{"keyword":"small generator repair","volume":10.0,"kd":0},{"keyword":"diesel generator repair","volume":10.0,"kd":0},{"keyword":"kohler generator repair","volume":10.0,"kd":0},{"keyword":"fix my generator","volume":10.0,"kd":0},{"keyword":"small engine repair reno nv","volume":140.0,"kd":0},{"keyword":"electric generator repair","volume":10.0,"kd":0},{"keyword":"standby generator repair","volume":10.0,"kd":0},{"keyword":"small engine repair reno","volume":140.0,"kd":0}],"Sarasota, FL":[{"keyword":"generator repair sarasota","volume":20.0,"kd":0},{"keyword":"generator repair sarasota fl","volume":10.0,"kd":0},{"keyword":"portable generator repair","volume":10.0,"kd":0},{"keyword":"generator repair","volume":10.0,"kd":0},{"keyword":"generator service and repair","volume":10.0,"kd":0},{"keyword":"generator repair services","volume":10.0,"kd":0},{"keyword":"home generator repair","volume":10.0,"kd":0},{"keyword":"onan generator repair","volume":10.0,"kd":0},{"keyword":"mobile generator repair","volume":10.0,"kd":0},{"keyword":"honda generator repair","volume":10.0,"kd":0},{"keyword":"local generator repair","volume":10.0,"kd":0},{"keyword":"small generator repair","volume":10.0,"kd":0},{"keyword":"diesel generator repair","volume":10.0,"kd":0},{"keyword":"generac repair service","volume":10.0,"kd":0},{"keyword":"kohler generator repair","volume":10.0,"kd":0},{"keyword":"fix my generator near me","volume":10.0,"kd":0},{"keyword":"snow blower repair near me","volume":10.0,"kd":0},{"keyword":"blower repair near me","volume":10.0,"kd":0},{"keyword":"toro snowblower repair","volume":10.0,"kd":0},{"keyword":"lawn mower repair sarasota fl","volume":50.0,"kd":0}],"Lees Summit, MO":[{"keyword":"generator repair","volume":10.0,"kd":0},{"keyword":"portable generator repair","volume":10.0,"kd":0},{"keyword":"onan generator repair","volume":10.0,"kd":0},{"keyword":"mobile generator repair","volume":10.0,"kd":0},{"keyword":"home generator maintenance","volume":10.0,"kd":0},{"keyword":"honda generator repair","volume":10.0,"kd":0},{"keyword":"diesel generator repair","volume":10.0,"kd":0},{"keyword":"kohler generator repair","volume":10.0,"kd":0},{"keyword":"gas generator repair","volume":10.0,"kd":0},{"keyword":"small engine repair lees summit","volume":30.0,"kd":0},{"keyword":"cummins generator repair","volume":10.0,"kd":0},{"keyword":"motorhome generator repair","volume":10.0,"kd":0},{"keyword":"lees summit lawn mower repair","volume":10.0,"kd":0},{"keyword":"industrial generator repair","volume":10.0,"kd":0},{"keyword":"lees summit small engine repair","volume":10.0,"kd":0},{"keyword":"yamaha generator repair","volume":10.0,"kd":0},{"keyword":"small engine repair lee's summit mo","volume":10.0,"kd":0},{"keyword":"westerbeke generator repair","volume":10.0,"kd":0},{"keyword":"small engine repair lees summit mo","volume":10.0,"kd":0},{"keyword":"generator alternator repair","volume":10.0,"kd":0}],"Buffalo":[{"keyword":"Snow Blower Repair Buffalo","volume":10.0,"kd":0},{"keyword":"snow blower repair near buffalo","volume":10.0,"kd":0},{"keyword":"snow blower repair buffalo ny","volume":10.0,"kd":0}],"Lapeer, MI":[{"keyword":"generator repair","volume":10.0,"kd":0},{"keyword":"portable generator repair","volume":10.0,"kd":0},{"keyword":"generator service and repair","volume":10.0,"kd":0},{"keyword":"generator repair services","volume":10.0,"kd":0},{"keyword":"fix generator near me","volume":10.0,"kd":0},{"keyword":"electric generator repair near me","volume":10.0,"kd":0},{"keyword":"kohler generator maintenance","volume":10.0,"kd":0},{"keyword":"generac repair service","volume":10.0,"kd":0},{"keyword":"kohler generator repair","volume":10.0,"kd":0},{"keyword":"small engine repair lapeer mi","volume":10.0,"kd":0},{"keyword":"generator servicing and maintenance","volume":10.0,"kd":0},{"keyword":"small engine repair lapeer","volume":10.0,"kd":0},{"keyword":"small engine repair","volume":10.0,"kd":0},{"keyword":"small repair engine","volume":10.0,"kd":0},{"keyword":"lawn mower repair lapeer","volume":10.0,"kd":0},{"keyword":"snow blower repair","volume":10.0,"kd":0},{"keyword":"lawn mower repair lapeer mi","volume":10.0,"kd":0},{"keyword":"lawn mower repair","volume":10.0,"kd":0},{"keyword":"toro snowblower repair","volume":10.0,"kd":0},{"keyword":"mower repair near me","volume":10.0,"kd":0}],"Crawfordsville, IN":[{"keyword":"small engine repair","volume":10.0,"kd":0},{"keyword":"engine repair","volume":10.0,"kd":0},{"keyword":"oil leak repair","volume":10.0,"kd":0},{"keyword":"cylinder head repair","volume":10.0,"kd":0},{"keyword":"diesel engine repair","volume":10.0,"kd":0},{"keyword":"bmw engine repair","volume":10.0,"kd":0},{"keyword":"weedeater repair near me","volume":10.0,"kd":0},{"keyword":"engine mount replacement cost","volume":10.0,"kd":0},{"keyword":"generator repair","volume":10.0,"kd":0},{"keyword":"generator service and repair","volume":10.0,"kd":0},{"keyword":"generator repair services","volume":10.0,"kd":0},{"keyword":"fix generator near me","volume":10.0,"kd":0},{"keyword":"onan generator repair","volume":10.0,"kd":0},{"keyword":"home generator maintenance","volume":10.0,"kd":0},{"keyword":"honda generator repair","volume":10.0,"kd":0},{"keyword":"repair generator near me","volume":10.0,"kd":0},{"keyword":"kohler generator repair","volume":10.0,"kd":0},{"keyword":"lawn mower repair crawfordsville in","volume":10.0,"kd":0},{"keyword":"snow blower repair","volume":10.0,"kd":0},{"keyword":"lawn mower repair","volume":10.0,"kd":0}],"Cape Coral, Fl":[{"keyword":"generator repair cape coral","volume":20.0,"kd":0},{"keyword":"portable generator repair cape coral","volume":20.0,"kd":0},{"keyword":"generator repair cape coral fl","volume":10.0,"kd":0},{"keyword":"generator repair","volume":10.0,"kd":0},{"keyword":"portable generator repair","volume":10.0,"kd":0},{"keyword":"home generator repair","volume":10.0,"kd":0},{"keyword":"onan generator repair","volume":10.0,"kd":0},{"keyword":"mobile generator repair","volume":10.0,"kd":0},{"keyword":"honda generator repair","volume":10.0,"kd":0},{"keyword":"local generator repair","volume":10.0,"kd":0},{"keyword":"small engine repair cape coral","volume":90.0,"kd":0},{"keyword":"portable gas generator repair","volume":10.0,"kd":0},{"keyword":"small generator repair","volume":10.0,"kd":0},{"keyword":"small engine repair cape coral fl","volume":90.0,"kd":0},{"keyword":"diesel generator repair","volume":10.0,"kd":0},{"keyword":"small engine repair","volume":10.0,"kd":0},{"keyword":"kohler generator repair","volume":10.0,"kd":0},{"keyword":"small repair engine","volume":10.0,"kd":0},{"keyword":"gas generator repair","volume":10.0,"kd":0},{"keyword":"small machine repair","volume":10.0,"kd":0}],"Tallahassee, FL":[{"keyword":"generator repair tallahassee","volume":20.0,"kd":0},{"keyword":"generator repair tallahassee fl","volume":10.0,"kd":0},{"keyword":"generator repair","volume":10.0,"kd":0},{"keyword":"portable generator repair","volume":10.0,"kd":0},{"keyword":"generator service and repair","volume":10.0,"kd":0},{"keyword":"generator repair services","volume":10.0,"kd":0},{"keyword":"generator servicing","volume":10.0,"kd":0},{"keyword":"home generator repair","volume":10.0,"kd":0},{"keyword":"onan generator repair","volume":10.0,"kd":0},{"keyword":"fix generator near me","volume":10.0,"kd":0},{"keyword":"small engine repair tallahassee","volume":110.0,"kd":0},{"keyword":"mobile generator repair","volume":10.0,"kd":0},{"keyword":"home generator maintenance","volume":10.0,"kd":0},{"keyword":"small engine repair tallahassee fl","volume":110.0,"kd":0},{"keyword":"kohler generator maintenance","volume":10.0,"kd":0},{"keyword":"small engine repair tallahassee florida","volume":110.0,"kd":0},{"keyword":"small generator repair","volume":10.0,"kd":0},{"keyword":"small engine repair in tallahassee","volume":10.0,"kd":0},{"keyword":"small engine repair","volume":10.0,"kd":0},{"keyword":"small machine repair","volume":10.0,"kd":0}],"Houston, TX":[{"keyword":"small engine repair houston","volume":210.0,"kd":0},{"keyword":"snow blower repair","volume":10.0,"kd":0},{"keyword":"blower repair near me","volume":10.0,"kd":0},{"keyword":"small engine repair houston tx","volume":210.0,"kd":0},{"keyword":"engine repair houston","volume":70.0,"kd":0},{"keyword":"mobile snow blower repair","volume":10.0,"kd":0},{"keyword":"engine repair houston tx","volume":70.0,"kd":0},{"keyword":"toro snowblower repair","volume":10.0,"kd":0},{"keyword":"small engine repair","volume":260.0,"kd":0},{"keyword":"small machine repair","volume":10.0,"kd":0},{"keyword":"craftsman snow blower repair near me","volume":10.0,"kd":0},{"keyword":"small repair engine","volume":260.0,"kd":0},{"keyword":"snow machine repair","volume":10.0,"kd":0},{"keyword":"lawn mower repair houston","volume":320.0,"kd":0},{"keyword":"generator repair houston","volume":70.0,"kd":0},{"keyword":"lawn mower repair houston tx","volume":320.0,"kd":0},{"keyword":"lawnmower repair houston","volume":20.0,"kd":0},{"keyword":"generator repair houston tx","volume":50.0,"kd":0},{"keyword":"mower repair houston","volume":10.0,"kd":0},{"keyword":"honda generator repair houston","volume":70.0,"kd":0}],"Brownsville, TX":[{"keyword":"generator repair","volume":10.0,"kd":0},{"keyword":"generator service and repair","volume":10.0,"kd":0},{"keyword":"generator repair services","volume":10.0,"kd":0},{"keyword":"home generator repair","volume":10.0,"kd":0},{"keyword":"onan generator repair","volume":10.0,"kd":0},{"keyword":"fix generator near me","volume":10.0,"kd":0},{"keyword":"generator fix near me","volume":10.0,"kd":0},{"keyword":"generator maintenance service near me","volume":10.0,"kd":0},{"keyword":"home generator maintenance","volume":10.0,"kd":0},{"keyword":"honda generator repair","volume":10.0,"kd":0},{"keyword":"generator rewinding near me","volume":10.0,"kd":0},{"keyword":"small engine repair","volume":10.0,"kd":0},{"keyword":"generator fix","volume":10.0,"kd":0},{"keyword":"small repair engine","volume":10.0,"kd":0},{"keyword":"kohler generator repair","volume":10.0,"kd":0},{"keyword":"generac repair service","volume":10.0,"kd":0},{"keyword":"diesel generator repair","volume":10.0,"kd":0},{"keyword":"snow blower repair","volume":10.0,"kd":0},{"keyword":"lawn mower repair","volume":20.0,"kd":0},{"keyword":"snow blower repair near me mobile","volume":10.0,"kd":0}]},"usAudit":[{"state":"Alabama","cities":[{"city":"Huntsville","population":231000,"volumes":{}},{"city":"Birmingham","population":194000,"volumes":{}},{"city":"Montgomery","population":192000,"volumes":{}},{"city":"Mobile","population":180000,"volumes":{}},{"city":"Tuscaloosa","population":116000,"volumes":{}},{"city":"Hoover","population":92000,"volumes":{}},{"city":"Auburn","population":85000,"volumes":{}},{"city":"Dothan","population":71000,"volumes":{}},{"city":"Madison","population":63000,"volumes":{}},{"city":"Decatur","population":58000,"volumes":{}},{"city":"Florence","population":51000,"volumes":{}},{"city":"Phenix City","population":37000,"volumes":{}},{"city":"Prattville","population":37000,"volumes":{}},{"city":"Vestavia Hills","population":36000,"volumes":{}},{"city":"Alabaster","population":33000,"volumes":{}},{"city":"Opelika","population":32000,"volumes":{}},{"city":"Bessemer","population":26000,"volumes":{}},{"city":"Homewood","population":26000,"volumes":{}},{"city":"Daphne","population":26000,"volumes":{}},{"city":"Pelham","population":25000,"volumes":{}},{"city":"Northport","population":25000,"volumes":{}},{"city":"Enterprise","population":24000,"volumes":{}},{"city":"Gadsden","population":23000,"volumes":{}},{"city":"Athens","population":23000,"volumes":{}},{"city":"Albertville","population":22000,"volumes":{}},{"city":"Mountain Brook","population":22000,"volumes":{}},{"city":"Trussville","population":22000,"volumes":{}},{"city":"Helena","population":21000,"volumes":{}},{"city":"Troy","population":20000,"volumes":{}},{"city":"Oxford","population":19000,"volumes":{}},{"city":"Cullman","population":19000,"volumes":{}},{"city":"Fairhope","population":19000,"volumes":{}},{"city":"Anniston","population":18000,"volumes":{}},{"city":"Millbrook","population":16000,"volumes":{}},{"city":"Hartselle","population":15000,"volumes":{}}]},{"state":"Alaska","cities":[{"city":"Anchorage","population":288000,"volumes":{}},{"city":"Fairbanks","population":32000,"volumes":{}},{"city":"Juneau","population":31000,"volumes":{}},{"city":"Badger","population":20000,"volumes":{}},{"city":"Knik-Fairview","population":19000,"volumes":{}},{"city":"College","population":14000,"volumes":{}},{"city":"Wasilla","population":13000,"volumes":{}},{"city":"Tanaina","population":12000,"volumes":{}},{"city":"Lakes","population":12000,"volumes":{}},{"city":"Sitka","population":8500,"volumes":{}},{"city":"Kalifornsky","population":8500,"volumes":{}},{"city":"Ketchikan","population":8200,"volumes":{}},{"city":"Kenai","population":7800,"volumes":{}},{"city":"Meadow Lakes","population":7800,"volumes":{}},{"city":"Steele Creek","population":7600,"volumes":{}},{"city":"Palmer","population":7400,"volumes":{}},{"city":"Sterling","population":6500,"volumes":{}},{"city":"Kodiak","population":6300,"volumes":{}},{"city":"Gateway","population":6200,"volumes":{}},{"city":"Bethel","population":6000,"volumes":{}}]},{"state":"Arizona","cities":[{"city":"Phoenix","population":1650000,"volumes":{}},{"city":"Tucson","population":550000,"volumes":{}},{"city":"Mesa","population":520000,"volumes":{}},{"city":"Chandler","population":280000,"volumes":{}},{"city":"Gilbert","population":270000,"volumes":{}},{"city":"Glendale","population":250000,"volumes":{}},{"city":"Scottsdale","population":250000,"volumes":{}},{"city":"Peoria","population":200000,"volumes":{}},{"city":"Tempe","population":190000,"volumes":{}},{"city":"Surprise","population":150000,"volumes":{}},{"city":"Goodyear","population":115000,"volumes":{}},{"city":"Buckeye","population":110000,"volumes":{}},{"city":"Avondale","population":95000,"volumes":{}},{"city":"Flagstaff","population":78000,"volumes":{}},{"city":"Queen Creek","population":75000,"volumes":{}},{"city":"Lake Havasu City","population":58000,"volumes":{}},{"city":"Maricopa","population":62000,"volumes":{}},{"city":"Casa Grande","population":60000,"volumes":{}},{"city":"Marana","population":55000,"volumes":{}},{"city":"Sierra Vista","population":45000,"volumes":{}},{"city":"Prescott Valley","population":50000,"volumes":{}},{"city":"Oro Valley","population":48000,"volumes":{}},{"city":"Prescott","population":47000,"volumes":{}},{"city":"Bullhead City","population":40000,"volumes":{}},{"city":"Apache Junction","population":40000,"volumes":{}},{"city":"San Tan Valley","population":100000,"volumes":{}},{"city":"Sahuarita","population":34000,"volumes":{}},{"city":"Fountain Hills","population":25000,"volumes":{}},{"city":"Eloy","population":20000,"volumes":{}},{"city":"Sun City","population":39000,"volumes":{}},{"city":"Payson","population":16000,"volumes":{}},{"city":"Nogales","population":20000,"volumes":{}},{"city":"Douglas","population":17000,"volumes":{}},{"city":"Show Low","population":11000,"volumes":{}},{"city":"Sedona","population":10000,"volumes":{}}]},{"state":"Delaware","cities":[{"city":"Wilmington","population":71000,"volumes":{}},{"city":"Dover","population":39000,"volumes":{}},{"city":"Newark","population":34000,"volumes":{}},{"city":"Middletown","population":25000,"volumes":{}},{"city":"Smyrna","population":13000,"volumes":{}},{"city":"Milford","population":12000,"volumes":{}}]},{"state":"Arkansas","cities":[{"city":"Little Rock","population":201000,"volumes":{}},{"city":"Fayetteville","population":101000,"volumes":{}},{"city":"Fort Smith","population":90000,"volumes":{}},{"city":"Springdale","population":87000,"volumes":{}},{"city":"Jonesboro","population":79000,"volumes":{}},{"city":"Rogers","population":72000,"volumes":{}},{"city":"Conway","population":66000,"volumes":{}},{"city":"Bentonville","population":58000,"volumes":{}},{"city":"Pine Bluff","population":41000,"volumes":{}},{"city":"Benton","population":37000,"volumes":{}},{"city":"Hot Springs","population":37000,"volumes":{}},{"city":"Sherwood","population":33000,"volumes":{}},{"city":"Texarkana","population":30000,"volumes":{}},{"city":"Russellville","population":30000,"volumes":{}},{"city":"Jacksonville","population":29000,"volumes":{}},{"city":"Paragould","population":29000,"volumes":{}},{"city":"Bella Vista","population":28000,"volumes":{}},{"city":"Cabot","population":27000,"volumes":{}},{"city":"West Memphis","population":24000,"volumes":{}},{"city":"Searcy","population":24000,"volumes":{}},{"city":"Van Buren","population":23000,"volumes":{}},{"city":"El Dorado","population":18000,"volumes":{}},{"city":"Maumelle","population":18000,"volumes":{}},{"city":"Marion","population":17000,"volumes":{}},{"city":"Bryant","population":17000,"volumes":{}},{"city":"Mountain Home","population":13000,"volumes":{}},{"city":"Blytheville","population":13000,"volumes":{}},{"city":"Forrest City","population":12000,"volumes":{}},{"city":"Arkadelphia","population":11000,"volumes":{}},{"city":"Magnolia","population":11000,"volumes":{}},{"city":"Hope","population":10000,"volumes":{}},{"city":"Camden","population":10000,"volumes":{}},{"city":"Harrison","population":13000,"volumes":{}},{"city":"Malvern","population":12000,"volumes":{}},{"city":"Crossett","population":10000,"volumes":{}}]},{"state":"California","cities":[{"city":"Los Angeles","population":3820000,"volumes":{}},{"city":"San Diego","population":1420000,"volumes":{}},{"city":"San Jose","population":1010000,"volumes":{}},{"city":"San Francisco","population":820000,"volumes":{}},{"city":"Fresno","population":550000,"volumes":{}},{"city":"Sacramento","population":530000,"volumes":{}},{"city":"Long Beach","population":460000,"volumes":{}},{"city":"Oakland","population":430000,"volumes":{}},{"city":"Bakersfield","population":410000,"volumes":{}},{"city":"Anaheim","population":350000,"volumes":{}},{"city":"Riverside","population":320000,"volumes":{}},{"city":"Stockton","population":320000,"volumes":{}},{"city":"Irvine","population":310000,"volumes":{}},{"city":"Chula Vista","population":285000,"volumes":{}},{"city":"Fremont","population":240000,"volumes":{}},{"city":"San Bernardino","population":220000,"volumes":{}},{"city":"Modesto","population":220000,"volumes":{}},{"city":"Fontana","population":215000,"volumes":{}},{"city":"Oxnard","population":210000,"volumes":{}},{"city":"Moreno Valley","population":210000,"volumes":{}},{"city":"Huntington Beach","population":200000,"volumes":{}},{"city":"Glendale","population":200000,"volumes":{}},{"city":"Santa Clarita","population":180000,"volumes":{}},{"city":"Garden Grove","population":175000,"volumes":{}},{"city":"Santa Rosa","population":175000,"volumes":{}},{"city":"Oceanside","population":175000,"volumes":{}},{"city":"Rancho Cucamonga","population":175000,"volumes":{}},{"city":"Ontario","population":170000,"volumes":{}},{"city":"Elk Grove","population":170000,"volumes":{}},{"city":"Corona","population":165000,"volumes":{}},{"city":"Lancaster","population":160000,"volumes":{}},{"city":"Palmdale","population":160000,"volumes":{}},{"city":"Salinas","population":160000,"volumes":{}},{"city":"Hayward","population":160000,"volumes":{}},{"city":"Pomona","population":150000,"volumes":{}}]},{"state":"Florida","cities":[{"city":"Jacksonville","population":975000,"volumes":{}},{"city":"Miami","population":450000,"volumes":{}},{"city":"Tampa","population":410000,"volumes":{}},{"city":"Orlando","population":320000,"volumes":{}},{"city":"St. Petersburg","population":260000,"volumes":{}},{"city":"Hialeah","population":220000,"volumes":{}},{"city":"Port St. Lucie","population":220000,"volumes":{}},{"city":"Cape Coral","population":210000,"volumes":{}},{"city":"Tallahassee","population":200000,"volumes":{}},{"city":"Fort Lauderdale","population":185000,"volumes":{}},{"city":"Pembroke Pines","population":175000,"volumes":{}},{"city":"Hollywood","population":153000,"volumes":{}},{"city":"Miramar","population":152000,"volumes":{}},{"city":"Gainesville","population":145000,"volumes":{}},{"city":"Coral Springs","population":134000,"volumes":{}},{"city":"Miami Gardens","population":113000,"volumes":{}},{"city":"Clearwater","population":116000,"volumes":{}},{"city":"Palm Bay","population":120000,"volumes":{}},{"city":"Pompano Beach","population":112000,"volumes":{}},{"city":"West Palm Beach","population":117000,"volumes":{}},{"city":"Lakeland","population":115000,"volumes":{}},{"city":"Davie","population":111000,"volumes":{}},{"city":"Boca Raton","population":99000,"volumes":{}},{"city":"Sunrise","population":97000,"volumes":{}},{"city":"Plantation","population":96000,"volumes":{}},{"city":"Deltona","population":95000,"volumes":{}},{"city":"Largo","population":95000,"volumes":{}},{"city":"Palm Coast","population":93000,"volumes":{}},{"city":"Deerfield Beach","population":87000,"volumes":{}},{"city":"Melbourne","population":87000,"volumes":{}},{"city":"Boynton Beach","population":82000,"volumes":{}},{"city":"Lauderhill","population":80000,"volumes":{}},{"city":"Fort Myers","population":79000,"volumes":{}},{"city":"Weston","population":75000,"volumes":{}},{"city":"Sanford","population":61000,"volumes":{}}]},{"state":"Connecticut","cities":[{"city":"Bridgeport","population":150000,"volumes":{}},{"city":"Stamford","population":137000,"volumes":{}},{"city":"New Haven","population":134000,"volumes":{}},{"city":"Hartford","population":121000,"volumes":{}},{"city":"Waterbury","population":115000,"volumes":{}},{"city":"Norwalk","population":92000,"volumes":{}},{"city":"Danbury","population":87000,"volumes":{}},{"city":"New Britain","population":74000,"volumes":{}},{"city":"West Hartford","population":64000,"volumes":{}},{"city":"Greenwich","population":63000,"volumes":{}},{"city":"Fairfield","population":62000,"volumes":{}},{"city":"Hamden","population":61000,"volumes":{}},{"city":"Bristol","population":60000,"volumes":{}},{"city":"Meriden","population":60000,"volumes":{}},{"city":"Manchester","population":59000,"volumes":{}},{"city":"West Haven","population":56000,"volumes":{}},{"city":"Milford","population":54000,"volumes":{}},{"city":"Stratford","population":52000,"volumes":{}},{"city":"East Hartford","population":50000,"volumes":{}},{"city":"Middletown","population":48000,"volumes":{}},{"city":"Wallingford","population":45000,"volumes":{}},{"city":"Enfield","population":44000,"volumes":{}},{"city":"Southington","population":44000,"volumes":{}},{"city":"Shelton","population":43000,"volumes":{}},{"city":"Norwich","population":41000,"volumes":{}},{"city":"Trumbull","population":39000,"volumes":{}},{"city":"Torrington","population":36000,"volumes":{}},{"city":"Newington","population":30000,"volumes":{}},{"city":"Naugatuck","population":31000,"volumes":{}},{"city":"Vernon","population":29000,"volumes":{}}]},{"state":"Georgia","cities":[{"city":"Atlanta","population":510000,"volumes":{}},{"city":"Columbus","population":207000,"volumes":{}},{"city":"Augusta","population":206000,"volumes":{}},{"city":"Macon","population":156000,"volumes":{}},{"city":"Savannah","population":150000,"volumes":{}},{"city":"Athens","population":130000,"volumes":{}},{"city":"Sandy Springs","population":110000,"volumes":{}},{"city":"South Fulton","population":108000,"volumes":{}},{"city":"Roswell","population":95000,"volumes":{}},{"city":"Johns Creek","population":83000,"volumes":{}},{"city":"Warner Robins","population":81000,"volumes":{}},{"city":"Albany","population":68000,"volumes":{}},{"city":"Alpharetta","population":67000,"volumes":{}},{"city":"Marietta","population":61000,"volumes":{}},{"city":"Smyrna","population":56000,"volumes":{}},{"city":"Valdosta","population":55000,"volumes":{}},{"city":"Brookhaven","population":55000,"volumes":{}},{"city":"Dunwoody","population":53000,"volumes":{}},{"city":"Gainesville","population":43000,"volumes":{}},{"city":"Peachtree Corners","population":43000,"volumes":{}},{"city":"Newnan","population":42000,"volumes":{}},{"city":"Milton","population":42000,"volumes":{}},{"city":"Hinesville","population":34000,"volumes":{}},{"city":"Dalton","population":34000,"volumes":{}},{"city":"Statesboro","population":33000,"volumes":{}},{"city":"Rome","population":32000,"volumes":{}},{"city":"East Point","population":31000,"volumes":{}},{"city":"Douglasville","population":31000,"volumes":{}},{"city":"Kennesaw","population":30000,"volumes":{}},{"city":"LaGrange","population":30000,"volumes":{}},{"city":"Lawrenceville","population":29000,"volumes":{}},{"city":"Stockbridge","population":29000,"volumes":{}},{"city":"McDonough","population":28000,"volumes":{}},{"city":"Carrollton","population":27000,"volumes":{}},{"city":"Canton","population":26000,"volumes":{}}]},{"state":"Colorado","cities":[{"city":"Denver","population":710000,"volumes":{}},{"city":"Colorado Springs","population":490000,"volumes":{}},{"city":"Aurora","population":405000,"volumes":{}},{"city":"Fort Collins","population":175000,"volumes":{}},{"city":"Lakewood","population":160000,"volumes":{}},{"city":"Thornton","population":145000,"volumes":{}},{"city":"Arvada","population":125000,"volumes":{}},{"city":"Westminster","population":115000,"volumes":{}},{"city":"Pueblo","population":112000,"volumes":{}},{"city":"Greeley","population":111000,"volumes":{}},{"city":"Centennial","population":110000,"volumes":{}},{"city":"Boulder","population":108000,"volumes":{}},{"city":"Highlands Ranch","population":107000,"volumes":{}},{"city":"Longmont","population":100000,"volumes":{}},{"city":"Loveland","population":80000,"volumes":{}},{"city":"Broomfield","population":77000,"volumes":{}},{"city":"Castle Rock","population":75000,"volumes":{}},{"city":"Grand Junction","population":72000,"volumes":{}},{"city":"Commerce City","population":70000,"volumes":{}},{"city":"Parker","population":65000,"volumes":{}},{"city":"Littleton","population":45000,"volumes":{}},{"city":"Brighton","population":43000,"volumes":{}},{"city":"Northglenn","population":39000,"volumes":{}},{"city":"Englewood","population":35000,"volumes":{}},{"city":"Wheat Ridge","population":33000,"volumes":{}},{"city":"Fountain","population":30000,"volumes":{}},{"city":"Lafayette","population":29000,"volumes":{}},{"city":"Windsor","population":28000,"volumes":{}},{"city":"Erie","population":26000,"volumes":{}},{"city":"Golden","population":25000,"volumes":{}},{"city":"Louisville","population":23000,"volumes":{}},{"city":"Montrose","population":22000,"volumes":{}},{"city":"Evans","population":20000,"volumes":{}},{"city":"Durango","population":17000,"volumes":{}},{"city":"Ca\u00f1on City","population":0,"volumes":{}}]},{"state":"Hawaii","cities":[{"city":"Honolulu","population":350000,"volumes":{}},{"city":"East Honolulu","population":50000,"volumes":{}},{"city":"Pearl City","population":45000,"volumes":{}},{"city":"Hilo","population":44000,"volumes":{}},{"city":"Waipahu","population":43000,"volumes":{}},{"city":"Kailua (O\u2018ahu)","population":40000,"volumes":{}},{"city":"Kaneohe","population":37000,"volumes":{}},{"city":"Mililani Town","population":28000,"volumes":{}},{"city":"Ewa Gentry","population":25000,"volumes":{}},{"city":"Kahului","population":24000,"volumes":{}},{"city":"Kihei","population":23000,"volumes":{}},{"city":"Kapolei","population":21000,"volumes":{}},{"city":"Wahiawa","population":18000,"volumes":{}},{"city":"Schofield Barracks","population":18000,"volumes":{}},{"city":"Wailuku","population":17000,"volumes":{}}]},{"state":"Idaho","cities":[{"city":"Boise","population":240000,"volumes":{}},{"city":"Meridian","population":140000,"volumes":{}},{"city":"Nampa","population":110000,"volumes":{}},{"city":"Idaho Falls","population":68000,"volumes":{}},{"city":"Caldwell","population":63000,"volumes":{}},{"city":"Pocatello","population":57000,"volumes":{}},{"city":"Coeur d\u2019Alene","population":56000,"volumes":{}},{"city":"Twin Falls","population":54000,"volumes":{}},{"city":"Twin Falls","population":43000,"volumes":{}},{"city":"Rexburg","population":40000,"volumes":{}},{"city":"Lewiston","population":34000,"volumes":{}},{"city":"Eagle","population":33000,"volumes":{}},{"city":"Moscow","population":26000,"volumes":{}},{"city":"Kuna","population":25000,"volumes":{}},{"city":"Ammon","population":17000,"volumes":{}},{"city":"Chubbuck","population":15000,"volumes":{}},{"city":"Hayden","population":15000,"volumes":{}},{"city":"Jerome","population":12000,"volumes":{}},{"city":"Blackfoot","population":12000,"volumes":{}},{"city":"Garden City","population":12000,"volumes":{}},{"city":"Mountain Home","population":12000,"volumes":{}},{"city":"Star","population":11000,"volumes":{}},{"city":"Rathdrum","population":10000,"volumes":{}},{"city":"Payette","population":10000,"volumes":{}},{"city":"Sandpoint","population":10000,"volumes":{}},{"city":"Middleton","population":10000,"volumes":{}},{"city":"Burley","population":10000,"volumes":{}},{"city":"Emmett","population":10000,"volumes":{}},{"city":"Weiser","population":10000,"volumes":{}},{"city":"Rupert","population":10000,"volumes":{}},{"city":"Gooding","population":10000,"volumes":{}},{"city":"Hailey","population":10000,"volumes":{}},{"city":"Preston","population":10000,"volumes":{}},{"city":"Shelley","population":10000,"volumes":{}},{"city":"Homedale","population":10000,"volumes":{}}]},{"state":"Illinois","cities":[{"city":"Chicago","population":2700000,"volumes":{}},{"city":"Aurora","population":180000,"volumes":{}},{"city":"Naperville","population":150000,"volumes":{}},{"city":"Joliet","population":150000,"volumes":{}},{"city":"Rockford","population":145000,"volumes":{}},{"city":"Springfield","population":115000,"volumes":{}},{"city":"Elgin","population":115000,"volumes":{}},{"city":"Peoria","population":110000,"volumes":{}},{"city":"Champaign","population":90000,"volumes":{}},{"city":"Waukegan","population":88000,"volumes":{}},{"city":"Cicero","population":81000,"volumes":{}},{"city":"Bloomington","population":79000,"volumes":{}},{"city":"Arlington Heights","population":77000,"volumes":{}},{"city":"Evanston","population":75000,"volumes":{}},{"city":"Bolingbrook","population":74000,"volumes":{}},{"city":"Schaumburg","population":73000,"volumes":{}},{"city":"Decatur","population":70000,"volumes":{}},{"city":"Palatine","population":68000,"volumes":{}},{"city":"Skokie","population":67000,"volumes":{}},{"city":"Orland Park","population":66000,"volumes":{}},{"city":"Des Plaines","population":60000,"volumes":{}},{"city":"Tinley Park","population":56000,"volumes":{}},{"city":"Oak Lawn","population":55000,"volumes":{}},{"city":"Berwyn","population":54000,"volumes":{}},{"city":"Mount Prospect","population":54000,"volumes":{}},{"city":"Normal","population":52000,"volumes":{}},{"city":"Wheaton","population":51000,"volumes":{}},{"city":"Hoffman Estates","population":50000,"volumes":{}},{"city":"Oak Park","population":49000,"volumes":{}},{"city":"Downers Grove","population":48000,"volumes":{}},{"city":"Glenview","population":47000,"volumes":{}},{"city":"Elmhurst","population":46000,"volumes":{}},{"city":"Lombard","population":44000,"volumes":{}},{"city":"DeKalb","population":40000,"volumes":{}},{"city":"Quincy","population":39000,"volumes":{}}]},{"state":"Indiana","cities":[{"city":"Indianapolis","population":880000,"volumes":{}},{"city":"Fort Wayne","population":265000,"volumes":{}},{"city":"Evansville","population":117000,"volumes":{}},{"city":"South Bend","population":104000,"volumes":{}},{"city":"Carmel","population":103000,"volumes":{}},{"city":"Fishers","population":102000,"volumes":{}},{"city":"Bloomington","population":80000,"volumes":{}},{"city":"Hammond","population":77000,"volumes":{}},{"city":"Gary","population":67000,"volumes":{}},{"city":"Lafayette","population":65000,"volumes":{}},{"city":"Muncie","population":65000,"volumes":{}},{"city":"Noblesville","population":70000,"volumes":{}},{"city":"Terre Haute","population":58000,"volumes":{}},{"city":"Kokomo","population":59000,"volumes":{}},{"city":"Greenwood","population":63000,"volumes":{}},{"city":"Anderson","population":54000,"volumes":{}},{"city":"Elkhart","population":54000,"volumes":{}},{"city":"Mishawaka","population":52000,"volumes":{}},{"city":"Lawrence","population":49000,"volumes":{}},{"city":"Jeffersonville","population":49000,"volumes":{}},{"city":"Columbus","population":49000,"volumes":{}},{"city":"Westfield","population":48000,"volumes":{}},{"city":"Portage","population":38000,"volumes":{}},{"city":"New Albany","population":37000,"volumes":{}},{"city":"Goshen","population":35000,"volumes":{}},{"city":"Michigan City","population":32000,"volumes":{}},{"city":"Plainfield","population":32000,"volumes":{}},{"city":"Richmond","population":31000,"volumes":{}},{"city":"Merrillville","population":29000,"volumes":{}},{"city":"Merrillville","population":34000,"volumes":{}},{"city":"Granger","population":30000,"volumes":{}},{"city":"Crown Point","population":34000,"volumes":{}},{"city":"Hobart","population":29000,"volumes":{}},{"city":"Zionsville","population":30000,"volumes":{}},{"city":"Frankfort","population":16000,"volumes":{}}]},{"state":"Iowa","cities":[{"city":"Des Moines","population":215000,"volumes":{}},{"city":"Cedar Rapids","population":136000,"volumes":{}},{"city":"Davenport","population":101000,"volumes":{}},{"city":"Sioux City","population":85000,"volumes":{}},{"city":"Iowa City","population":75000,"volumes":{}},{"city":"Ankeny","population":72000,"volumes":{}},{"city":"West Des Moines","population":70000,"volumes":{}},{"city":"Ames","population":67000,"volumes":{}},{"city":"Waterloo","population":67000,"volumes":{}},{"city":"Council Bluffs","population":62000,"volumes":{}},{"city":"Dubuque","population":59000,"volumes":{}},{"city":"Urbandale","population":45000,"volumes":{}},{"city":"Marion","population":41000,"volumes":{}},{"city":"Bettendorf","population":39000,"volumes":{}},{"city":"Mason City","population":27000,"volumes":{}},{"city":"Marshalltown","population":27000,"volumes":{}},{"city":"Clinton","population":25000,"volumes":{}},{"city":"Burlington","population":24000,"volumes":{}},{"city":"Fort Dodge","population":24000,"volumes":{}},{"city":"Ottumwa","population":24000,"volumes":{}},{"city":"Muscatine","population":23000,"volumes":{}},{"city":"Coralville","population":22000,"volumes":{}},{"city":"Johnston","population":22000,"volumes":{}},{"city":"North Liberty","population":21000,"volumes":{}},{"city":"Altoona","population":20000,"volumes":{}},{"city":"Indianola","population":16000,"volumes":{}},{"city":"Newton","population":15000,"volumes":{}},{"city":"Waukee","population":14000,"volumes":{}},{"city":"Boone","population":12000,"volumes":{}},{"city":"Oskaloosa","population":11000,"volumes":{}},{"city":"Storm Lake","population":11000,"volumes":{}},{"city":"Carroll","population":11000,"volumes":{}},{"city":"Pella","population":10000,"volumes":{}},{"city":"Keokuk","population":10000,"volumes":{}},{"city":"Spencer","population":10000,"volumes":{}}]},{"state":"Kansas","cities":[{"city":"Wichita","population":400000,"volumes":{}},{"city":"Overland Park","population":200000,"volumes":{}},{"city":"Kansas City","population":155000,"volumes":{}},{"city":"Olathe","population":143000,"volumes":{}},{"city":"Topeka","population":126000,"volumes":{}},{"city":"Lawrence","population":95000,"volumes":{}},{"city":"Shawnee","population":67000,"volumes":{}},{"city":"Manhattan","population":55000,"volumes":{}},{"city":"Lenexa","population":55000,"volumes":{}},{"city":"Salina","population":46000,"volumes":{}},{"city":"Hutchinson","population":40000,"volumes":{}},{"city":"Leavenworth","population":38000,"volumes":{}},{"city":"Leawood","population":37000,"volumes":{}},{"city":"Garden City","population":34000,"volumes":{}},{"city":"Emporia","population":24000,"volumes":{}},{"city":"Dodge City","population":28000,"volumes":{}},{"city":"Junction City","population":22000,"volumes":{}},{"city":"Derby","population":23000,"volumes":{}},{"city":"Prairie Village","population":22000,"volumes":{}},{"city":"Hays","population":21000,"volumes":{}},{"city":"Pittsburg","population":20000,"volumes":{}},{"city":"Liberal","population":19000,"volumes":{}},{"city":"Gardner","population":18000,"volumes":{}},{"city":"Newton","population":17000,"volumes":{}},{"city":"Great Bend","population":15000,"volumes":{}},{"city":"McPherson","population":14000,"volumes":{}},{"city":"El Dorado","population":13000,"volumes":{}},{"city":"Andover","population":13000,"volumes":{}},{"city":"Ottawa","population":12000,"volumes":{}},{"city":"Arkansas City","population":12000,"volumes":{}},{"city":"Lansing","population":11000,"volumes":{}},{"city":"Merriam","population":11000,"volumes":{}},{"city":"Coffeyville","population":10000,"volumes":{}},{"city":"Parsons","population":10000,"volumes":{}},{"city":"Winfield","population":10000,"volumes":{}}]},{"state":"Kentucky","cities":[{"city":"Louisville","population":620000,"volumes":{}},{"city":"Lexington","population":320000,"volumes":{}},{"city":"Bowling Green","population":75000,"volumes":{}},{"city":"Owensboro","population":60000,"volumes":{}},{"city":"Covington","population":41000,"volumes":{}},{"city":"Georgetown","population":38000,"volumes":{}},{"city":"Richmond","population":37000,"volumes":{}},{"city":"Florence","population":34000,"volumes":{}},{"city":"Nicholasville","population":32000,"volumes":{}},{"city":"Elizabethtown","population":31000,"volumes":{}},{"city":"Hopkinsville","population":30000,"volumes":{}},{"city":"Jeffersontown","population":28000,"volumes":{}},{"city":"Frankfort","population":28000,"volumes":{}},{"city":"Paducah","population":27000,"volumes":{}},{"city":"Independence","population":27000,"volumes":{}},{"city":"Radcliff","population":23000,"volumes":{}},{"city":"Ashland","population":21000,"volumes":{}},{"city":"Madisonville","population":19000,"volumes":{}},{"city":"Erlanger","population":18000,"volumes":{}},{"city":"Winchester","population":18000,"volumes":{}},{"city":"St. Matthews","population":18000,"volumes":{}},{"city":"Murray","population":17000,"volumes":{}},{"city":"Burlington","population":17000,"volumes":{}},{"city":"Fort Thomas","population":16000,"volumes":{}},{"city":"Shepherdsville","population":16000,"volumes":{}},{"city":"Berea","population":16000,"volumes":{}},{"city":"Mount Washington","population":16000,"volumes":{}},{"city":"Shively","population":15000,"volumes":{}},{"city":"Danville","population":15000,"volumes":{}},{"city":"Lyndon","population":15000,"volumes":{}},{"city":"Middlesborough","population":15000,"volumes":{}},{"city":"Shelbyville","population":15000,"volumes":{}},{"city":"Paris","population":14000,"volumes":{}},{"city":"Somerset","population":14000,"volumes":{}},{"city":"Erlanger","population":14000,"volumes":{}}]},{"state":"Louisiana","cities":[{"city":"New Orleans","population":370000,"volumes":{}},{"city":"Baton Rouge","population":220000,"volumes":{}},{"city":"Shreveport","population":185000,"volumes":{}},{"city":"Metairie","population":143000,"volumes":{}},{"city":"Lafayette","population":120000,"volumes":{}},{"city":"Lake Charles","population":87000,"volumes":{}},{"city":"Bossier City","population":62000,"volumes":{}},{"city":"Kenner","population":66000,"volumes":{}},{"city":"Monroe","population":47000,"volumes":{}},{"city":"Alexandria","population":44000,"volumes":{}},{"city":"Houma","population":33000,"volumes":{}},{"city":"New Iberia","population":30000,"volumes":{}},{"city":"Slidell","population":29000,"volumes":{}},{"city":"Central","population":29000,"volumes":{}},{"city":"Ruston","population":22000,"volumes":{}},{"city":"Sulphur","population":21000,"volumes":{}},{"city":"Hammond","population":20000,"volumes":{}},{"city":"Opelousas","population":16000,"volumes":{}},{"city":"Zachary","population":13000,"volumes":{}},{"city":"Baker","population":13000,"volumes":{}},{"city":"Gretna","population":13000,"volumes":{}},{"city":"Natchitoches","population":12000,"volumes":{}},{"city":"Pineville","population":12000,"volumes":{}},{"city":"West Monroe","population":12000,"volumes":{}},{"city":"Chalmette","population":12000,"volumes":{}},{"city":"Mandeville","population":12000,"volumes":{}},{"city":"Covington","population":11000,"volumes":{}},{"city":"Eunice","population":11000,"volumes":{}},{"city":"Thibodaux","population":11000,"volumes":{}},{"city":"Carencro","population":11000,"volumes":{}},{"city":"Abbeville","population":11000,"volumes":{}},{"city":"Denham Springs","population":10000,"volumes":{}},{"city":"Bogalusa","population":10000,"volumes":{}},{"city":"Morgan City","population":10000,"volumes":{}},{"city":"Crowley","population":10000,"volumes":{}}]},{"state":"Maine","cities":[{"city":"Portland","population":68000,"volumes":{}},{"city":"Lewiston","population":36000,"volumes":{}},{"city":"Bangor","population":32000,"volumes":{}},{"city":"South Portland","population":26000,"volumes":{}},{"city":"Auburn","population":24000,"volumes":{}},{"city":"Biddeford","population":24000,"volumes":{}},{"city":"Sanford","population":22000,"volumes":{}},{"city":"Brunswick","population":21000,"volumes":{}},{"city":"Scarborough","population":21000,"volumes":{}},{"city":"Saco","population":20000,"volumes":{}},{"city":"Westbrook","population":20000,"volumes":{}},{"city":"Augusta","population":19000,"volumes":{}},{"city":"Windham","population":19000,"volumes":{}},{"city":"Gorham","population":19000,"volumes":{}},{"city":"Waterville","population":15000,"volumes":{}},{"city":"Falmouth","population":12000,"volumes":{}},{"city":"Kennebunk","population":12000,"volumes":{}},{"city":"Orono","population":11000,"volumes":{}},{"city":"Old Orchard Beach","population":11000,"volumes":{}},{"city":"Bath","population":10000,"volumes":{}}]},{"state":"Maryland","cities":[{"city":"Baltimore","population":576000,"volumes":{}},{"city":"Columbia","population":105000,"volumes":{}},{"city":"Germantown","population":90000,"volumes":{}},{"city":"Silver Spring","population":81000,"volumes":{}},{"city":"Waldorf","population":79000,"volumes":{}},{"city":"Glen Burnie","population":73000,"volumes":{}},{"city":"Frederick","population":72000,"volumes":{}},{"city":"Gaithersburg","population":69000,"volumes":{}},{"city":"Rockville","population":68000,"volumes":{}},{"city":"Bethesda","population":65000,"volumes":{}},{"city":"Dundalk","population":64000,"volumes":{}},{"city":"Bowie","population":59000,"volumes":{}},{"city":"Towson","population":58000,"volumes":{}},{"city":"Aspen Hill","population":55000,"volumes":{}},{"city":"Ellicott City","population":55000,"volumes":{}},{"city":"Salisbury","population":52000,"volumes":{}},{"city":"College Park","population":35000,"volumes":{}},{"city":"Hagerstown","population":43000,"volumes":{}},{"city":"Bel Air South","population":30000,"volumes":{}},{"city":"Germantown Valley","population":28000,"volumes":{}},{"city":"North Bethesda","population":27000,"volumes":{}},{"city":"Odenton","population":25000,"volumes":{}},{"city":"Catonsville","population":24000,"volumes":{}},{"city":"Essex","population":23000,"volumes":{}},{"city":"Severna Park","population":23000,"volumes":{}},{"city":"Randallstown","population":23000,"volumes":{}},{"city":"Olney","population":22000,"volumes":{}},{"city":"Montgomery Village","population":21000,"volumes":{}},{"city":"Chillum","population":21000,"volumes":{}},{"city":"Middle River","population":21000,"volumes":{}},{"city":"Hyattsville","population":20000,"volumes":{}},{"city":"Clinton","population":19000,"volumes":{}},{"city":"South Laurel","population":19000,"volumes":{}},{"city":"Laurel","population":18000,"volumes":{}},{"city":"Cumberland","population":18000,"volumes":{}}]},{"state":"Massachusetts","cities":[{"city":"Boston","population":650000,"volumes":{}},{"city":"Worcester","population":205000,"volumes":{}},{"city":"Springfield","population":155000,"volumes":{}},{"city":"Cambridge","population":119000,"volumes":{}},{"city":"Lowell","population":115000,"volumes":{}},{"city":"Brockton","population":105000,"volumes":{}},{"city":"Quincy","population":101000,"volumes":{}},{"city":"Lynn","population":101000,"volumes":{}},{"city":"New Bedford","population":100000,"volumes":{}},{"city":"Fall River","population":95000,"volumes":{}},{"city":"Newton","population":91000,"volumes":{}},{"city":"Somerville","population":81000,"volumes":{}},{"city":"Lawrence","population":81000,"volumes":{}},{"city":"Framingham","population":80000,"volumes":{}},{"city":"Haverhill","population":67000,"volumes":{}},{"city":"Waltham","population":65000,"volumes":{}},{"city":"Malden","population":65000,"volumes":{}},{"city":"Brookline","population":63000,"volumes":{}},{"city":"Plymouth","population":61000,"volumes":{}},{"city":"Medford","population":60000,"volumes":{}},{"city":"Taunton","population":59000,"volumes":{}},{"city":"Chicopee","population":55000,"volumes":{}},{"city":"Everett","population":53000,"volumes":{}},{"city":"Revere","population":53000,"volumes":{}},{"city":"Peabody","population":53000,"volumes":{}},{"city":"Methuen","population":52000,"volumes":{}},{"city":"Barnstable","population":50000,"volumes":{}},{"city":"Arlington","population":45000,"volumes":{}},{"city":"Attleboro","population":46000,"volumes":{}},{"city":"Salem","population":44000,"volumes":{}},{"city":"Braintree","population":38000,"volumes":{}},{"city":"Chelsea","population":37000,"volumes":{}},{"city":"Marlborough","population":36000,"volumes":{}},{"city":"Woburn","population":35000,"volumes":{}},{"city":"Leominster","population":32000,"volumes":{}}]},{"state":"Michigan","cities":[{"city":"Detroit","population":630000,"volumes":{}},{"city":"Grand Rapids","population":200000,"volumes":{}},{"city":"Warren","population":138000,"volumes":{}},{"city":"Sterling Heights","population":135000,"volumes":{}},{"city":"Ann Arbor","population":122000,"volumes":{}},{"city":"Lansing","population":112000,"volumes":{}},{"city":"Dearborn","population":110000,"volumes":{}},{"city":"Livonia","population":95000,"volumes":{}},{"city":"Troy","population":87000,"volumes":{}},{"city":"Westland","population":85000,"volumes":{}},{"city":"Farmington Hills","population":84000,"volumes":{}},{"city":"Kalamazoo","population":74000,"volumes":{}},{"city":"Flint","population":72000,"volumes":{}},{"city":"Rochester Hills","population":76000,"volumes":{}},{"city":"Southfield","population":72000,"volumes":{}},{"city":"Taylor","population":61000,"volumes":{}},{"city":"St. Clair Shores","population":59000,"volumes":{}},{"city":"Pontiac","population":59000,"volumes":{}},{"city":"Dearborn Heights","population":57000,"volumes":{}},{"city":"Royal Oak","population":57000,"volumes":{}},{"city":"Novi","population":55000,"volumes":{}},{"city":"Ypsilanti","population":54000,"volumes":{}},{"city":"Battle Creek","population":53000,"volumes":{}},{"city":"Saginaw","population":44000,"volumes":{}},{"city":"Kentwood","population":52000,"volumes":{}},{"city":"Eastpointe","population":34000,"volumes":{}},{"city":"Roseville","population":47000,"volumes":{}},{"city":"Portage","population":49000,"volumes":{}},{"city":"Midland","population":42000,"volumes":{}},{"city":"Muskegon","population":38000,"volumes":{}},{"city":"Lincoln Park","population":39000,"volumes":{}},{"city":"Bay City","population":32000,"volumes":{}},{"city":"Holland","population":35000,"volumes":{}},{"city":"East Lansing","population":47000,"volumes":{}},{"city":"Jackson","population":33000,"volumes":{}}]},{"state":"Minnesota","cities":[{"city":"Minneapolis","population":430000,"volumes":{}},{"city":"St. Paul","population":310000,"volumes":{}},{"city":"Rochester","population":125000,"volumes":{}},{"city":"Bloomington","population":89000,"volumes":{}},{"city":"Duluth","population":86000,"volumes":{}},{"city":"Brooklyn Park","population":87000,"volumes":{}},{"city":"Plymouth","population":83000,"volumes":{}},{"city":"Woodbury","population":81000,"volumes":{}},{"city":"Maple Grove","population":80000,"volumes":{}},{"city":"St. Cloud","population":69000,"volumes":{}},{"city":"Eagan","population":68000,"volumes":{}},{"city":"Eden Prairie","population":67000,"volumes":{}},{"city":"Burnsville","population":63000,"volumes":{}},{"city":"Coon Rapids","population":63000,"volumes":{}},{"city":"Blaine","population":70000,"volumes":{}},{"city":"Lakeville","population":72000,"volumes":{}},{"city":"Minnetonka","population":54000,"volumes":{}},{"city":"Apple Valley","population":54000,"volumes":{}},{"city":"Edina","population":54000,"volumes":{}},{"city":"St. Louis Park","population":49000,"volumes":{}},{"city":"Mankato","population":45000,"volumes":{}},{"city":"Moorhead","population":44000,"volumes":{}},{"city":"Shakopee","population":43000,"volumes":{}},{"city":"Cottage Grove","population":38000,"volumes":{}},{"city":"Inver Grove Heights","population":37000,"volumes":{}},{"city":"Roseville","population":36000,"volumes":{}},{"city":"Andover","population":35000,"volumes":{}},{"city":"Brooklyn Center","population":33000,"volumes":{}},{"city":"Savage","population":32000,"volumes":{}},{"city":"Oakdale","population":32000,"volumes":{}},{"city":"Richfield","population":36000,"volumes":{}},{"city":"Maplewood","population":36000,"volumes":{}},{"city":"Prior Lake","population":30000,"volumes":{}},{"city":"White Bear Lake","population":25000,"volumes":{}},{"city":"Hastings","population":23000,"volumes":{}}]},{"state":"Mississippi","cities":[{"city":"Jackson","population":150000,"volumes":{}},{"city":"Gulfport","population":73000,"volumes":{}},{"city":"Southaven","population":60000,"volumes":{}},{"city":"Hattiesburg","population":48000,"volumes":{}},{"city":"Biloxi","population":46000,"volumes":{}},{"city":"Olive Branch","population":40000,"volumes":{}},{"city":"Tupelo","population":38000,"volumes":{}},{"city":"Meridian","population":36000,"volumes":{}},{"city":"Greenville","population":29000,"volumes":{}},{"city":"Horn Lake","population":28000,"volumes":{}},{"city":"Pearl","population":26000,"volumes":{}},{"city":"Madison","population":25000,"volumes":{}},{"city":"Starkville","population":25000,"volumes":{}},{"city":"Clinton","population":25000,"volumes":{}},{"city":"Ridgeland","population":24000,"volumes":{}},{"city":"Columbus","population":24000,"volumes":{}},{"city":"Brandon","population":23000,"volumes":{}},{"city":"Vicksburg","population":22000,"volumes":{}},{"city":"Pascagoula","population":21000,"volumes":{}},{"city":"Oxford","population":20000,"volumes":{}},{"city":"Laurel","population":18000,"volumes":{}},{"city":"Hernando","population":17000,"volumes":{}},{"city":"Gautier","population":16000,"volumes":{}},{"city":"Ocean Springs","population":16000,"volumes":{}},{"city":"Moss Point","population":13000,"volumes":{}},{"city":"Natchez","population":13000,"volumes":{}},{"city":"Greenwood","population":12000,"volumes":{}},{"city":"Canton","population":11000,"volumes":{}},{"city":"Yazoo City","population":11000,"volumes":{}},{"city":"Brookhaven","population":11000,"volumes":{}},{"city":"McComb","population":11000,"volumes":{}},{"city":"Grenada","population":11000,"volumes":{}},{"city":"Picayune","population":11000,"volumes":{}},{"city":"Flowood","population":11000,"volumes":{}},{"city":"Long Beach","population":10000,"volumes":{}}]},{"state":"Missouri","cities":[{"city":"Kansas City","population":510000,"volumes":{}},{"city":"St. Louis","population":293000,"volumes":{}},{"city":"Springfield","population":170000,"volumes":{}},{"city":"Columbia","population":127000,"volumes":{}},{"city":"Independence","population":123000,"volumes":{}},{"city":"Lee\u2019s Summit","population":104000,"volumes":{}},{"city":"O\u2019Fallon","population":95000,"volumes":{}},{"city":"St. Joseph","population":72000,"volumes":{}},{"city":"St. Charles","population":71000,"volumes":{}},{"city":"Blue Springs","population":60000,"volumes":{}},{"city":"St. Peters","population":58000,"volumes":{}},{"city":"Florissant","population":52000,"volumes":{}},{"city":"Joplin","population":51000,"volumes":{}},{"city":"Chesterfield","population":49000,"volumes":{}},{"city":"Jefferson City","population":43000,"volumes":{}},{"city":"Cape Girardeau","population":40000,"volumes":{}},{"city":"Wentzville","population":40000,"volumes":{}},{"city":"Oakville","population":39000,"volumes":{}},{"city":"Wildwood","population":38000,"volumes":{}},{"city":"University City","population":37000,"volumes":{}},{"city":"Liberty","population":37000,"volumes":{}},{"city":"Raytown","population":37000,"volumes":{}},{"city":"Kirkwood","population":37000,"volumes":{}},{"city":"Maryland Heights","population":36000,"volumes":{}},{"city":"Gladstone","population":36000,"volumes":{}},{"city":"Grandview","population":33000,"volumes":{}},{"city":"Hazelwood","population":25000,"volumes":{}},{"city":"Belton","population":24000,"volumes":{}},{"city":"Ballwin","population":24000,"volumes":{}},{"city":"Arnold","population":23000,"volumes":{}},{"city":"Sedalia","population":22000,"volumes":{}},{"city":"Webster Groves","population":22000,"volumes":{}},{"city":"Ferguson","population":21000,"volumes":{}},{"city":"Raymore","population":21000,"volumes":{}},{"city":"Rolla","population":20000,"volumes":{}}]},{"state":"Montana","cities":[{"city":"Billings","population":125000,"volumes":{}},{"city":"Missoula","population":75000,"volumes":{}},{"city":"Great Falls","population":60000,"volumes":{}},{"city":"Bozeman","population":57000,"volumes":{}},{"city":"Butte","population":35000,"volumes":{}},{"city":"Helena","population":34000,"volumes":{}},{"city":"Kalispell","population":28000,"volumes":{}},{"city":"Belgrade","population":13000,"volumes":{}},{"city":"Havre","population":12000,"volumes":{}},{"city":"Anaconda","population":10000,"volumes":{}},{"city":"Miles City","population":10000,"volumes":{}}]},{"state":"Nebraska","cities":[{"city":"Omaha","population":485000,"volumes":{}},{"city":"Lincoln","population":292000,"volumes":{}},{"city":"Bellevue","population":64000,"volumes":{}},{"city":"Grand Island","population":52000,"volumes":{}},{"city":"Kearney","population":34000,"volumes":{}},{"city":"Fremont","population":27000,"volumes":{}},{"city":"Hastings","population":25000,"volumes":{}},{"city":"Norfolk","population":24000,"volumes":{}},{"city":"Columbus","population":24000,"volumes":{}},{"city":"Papillion","population":23000,"volumes":{}},{"city":"La Vista","population":17000,"volumes":{}},{"city":"Scottsbluff","population":15000,"volumes":{}},{"city":"South Sioux City","population":14000,"volumes":{}},{"city":"Beatrice","population":12000,"volumes":{}}]},{"state":"Nevada","cities":[{"city":"Las Vegas","population":660000,"volumes":{}},{"city":"Henderson","population":330000,"volumes":{}},{"city":"Reno","population":270000,"volumes":{}},{"city":"North Las Vegas","population":280000,"volumes":{}},{"city":"Paradise","population":190000,"volumes":{}},{"city":"Sunrise Manor","population":210000,"volumes":{}},{"city":"Spring Valley","population":220000,"volumes":{}},{"city":"Enterprise","population":180000,"volumes":{}},{"city":"Sparks","population":110000,"volumes":{}},{"city":"Carson City","population":58000,"volumes":{}},{"city":"Whitney","population":44000,"volumes":{}},{"city":"Winchester","population":38000,"volumes":{}},{"city":"Pahrump","population":36000,"volumes":{}},{"city":"Sun Valley","population":22000,"volumes":{}}]},{"state":"New Hampshire","cities":[{"city":"Manchester","population":116000,"volumes":{}},{"city":"Nashua","population":91000,"volumes":{}},{"city":"Concord","population":44000,"volumes":{}},{"city":"Derry","population":34000,"volumes":{}},{"city":"Dover","population":33000,"volumes":{}},{"city":"Rochester","population":32000,"volumes":{}},{"city":"Salem","population":31000,"volumes":{}},{"city":"Merrimack","population":30000,"volumes":{}},{"city":"Londonderry","population":27000,"volumes":{}},{"city":"Hudson","population":25000,"volumes":{}},{"city":"Keene","population":23000,"volumes":{}},{"city":"Bedford","population":23000,"volumes":{}},{"city":"Portsmouth","population":22000,"volumes":{}},{"city":"Goffstown","population":18000,"volumes":{}},{"city":"Laconia","population":16000,"volumes":{}},{"city":"Hampton","population":15000,"volumes":{}}]},{"state":"New Jersey","cities":[{"city":"Newark","population":305000,"volumes":{}},{"city":"Jersey City","population":286000,"volumes":{}},{"city":"Paterson","population":160000,"volumes":{}},{"city":"Elizabeth","population":139000,"volumes":{}},{"city":"Lakewood","population":135000,"volumes":{}},{"city":"Edison","population":109000,"volumes":{}},{"city":"Woodbridge","population":104000,"volumes":{}},{"city":"Toms River","population":95000,"volumes":{}},{"city":"Hamilton Township","population":88000,"volumes":{}},{"city":"Trenton","population":90000,"volumes":{}},{"city":"Clifton","population":89000,"volumes":{}},{"city":"Camden","population":73000,"volumes":{}},{"city":"Brick Township","population":73000,"volumes":{}},{"city":"Cherry Hill","population":75000,"volumes":{}},{"city":"Passaic","population":71000,"volumes":{}},{"city":"Middletown","population":67000,"volumes":{}},{"city":"Union City","population":66000,"volumes":{}},{"city":"Old Bridge","population":67000,"volumes":{}},{"city":"Gloucester Township","population":65000,"volumes":{}},{"city":"East Orange","population":64000,"volumes":{}},{"city":"Bayonne","population":71000,"volumes":{}},{"city":"Franklin Township","population":68000,"volumes":{}},{"city":"North Bergen","population":64000,"volumes":{}},{"city":"Vineland","population":60000,"volumes":{}},{"city":"Union Township","population":58000,"volumes":{}},{"city":"Piscataway","population":56000,"volumes":{}},{"city":"New Brunswick","population":56000,"volumes":{}},{"city":"Jackson Township","population":57000,"volumes":{}},{"city":"Perth Amboy","population":55000,"volumes":{}},{"city":"Hoboken","population":58000,"volumes":{}},{"city":"Parsippany-Troy Hills","population":56000,"volumes":{}},{"city":"Sayreville","population":52000,"volumes":{}},{"city":"Howell Township","population":52000,"volumes":{}},{"city":"Plainfield","population":55000,"volumes":{}},{"city":"Bloomfield","population":53000,"volumes":{}}]},{"state":"New Mexico","cities":[{"city":"Albuquerque","population":560000,"volumes":{}},{"city":"Las Cruces","population":115000,"volumes":{}},{"city":"Rio Rancho","population":105000,"volumes":{}},{"city":"Santa Fe","population":89000,"volumes":{}},{"city":"Roswell","population":48000,"volumes":{}},{"city":"Farmington","population":46000,"volumes":{}},{"city":"Hobbs","population":43000,"volumes":{}},{"city":"Clovis","population":38000,"volumes":{}},{"city":"Alamogordo","population":31000,"volumes":{}},{"city":"Carlsbad","population":32000,"volumes":{}},{"city":"Gallup","population":22000,"volumes":{}},{"city":"Deming","population":14000,"volumes":{}},{"city":"Los Lunas","population":15000,"volumes":{}},{"city":"Chaparral","population":15000,"volumes":{}},{"city":"Sunland Park","population":17000,"volumes":{}},{"city":"Artesia","population":13000,"volumes":{}},{"city":"Silver City","population":10000,"volumes":{}},{"city":"Espa\u00f1ola","population":10000,"volumes":{}},{"city":"Portales","population":10000,"volumes":{}}]},{"state":"New York","cities":[{"city":"New York City","population":8500000,"volumes":{}},{"city":"Buffalo","population":276000,"volumes":{}},{"city":"Rochester","population":210000,"volumes":{}},{"city":"Yonkers","population":210000,"volumes":{}},{"city":"Syracuse","population":145000,"volumes":{}},{"city":"Albany","population":100000,"volumes":{}},{"city":"New Rochelle","population":81000,"volumes":{}},{"city":"Mount Vernon","population":68000,"volumes":{}},{"city":"Schenectady","population":67000,"volumes":{}},{"city":"Utica","population":64000,"volumes":{}},{"city":"White Plains","population":59000,"volumes":{}},{"city":"Hempstead","population":58000,"volumes":{}},{"city":"Troy","population":51000,"volumes":{}},{"city":"Niagara Falls","population":48000,"volumes":{}},{"city":"Binghamton","population":47000,"volumes":{}},{"city":"Freeport","population":44000,"volumes":{}},{"city":"Valley Stream","population":40000,"volumes":{}},{"city":"Long Beach","population":35000,"volumes":{}},{"city":"Poughkeepsie","population":31000,"volumes":{}},{"city":"Ithaca","population":30000,"volumes":{}},{"city":"Elmira","population":28000,"volumes":{}},{"city":"Middletown","population":28000,"volumes":{}},{"city":"Spring Valley","population":27000,"volumes":{}},{"city":"Kingston","population":24000,"volumes":{}},{"city":"Peekskill","population":24000,"volumes":{}},{"city":"Glen Cove","population":22000,"volumes":{}},{"city":"Newburgh","population":22000,"volumes":{}},{"city":"Ossining","population":22000,"volumes":{}},{"city":"Cortland","population":18000,"volumes":{}},{"city":"Watertown","population":24000,"volumes":{}},{"city":"Plattsburgh","population":20000,"volumes":{}},{"city":"Lockport","population":20000,"volumes":{}},{"city":"Batavia","population":15000,"volumes":{}},{"city":"Geneva","population":13000,"volumes":{}},{"city":"Oneonta","population":13000,"volumes":{}}]},{"state":"North Carolina","cities":[{"city":"Charlotte","population":880000,"volumes":{}},{"city":"Raleigh","population":470000,"volumes":{}},{"city":"Greensboro","population":300000,"volumes":{}},{"city":"Durham","population":285000,"volumes":{}},{"city":"Winston-Salem","population":250000,"volumes":{}},{"city":"Fayetteville","population":210000,"volumes":{}},{"city":"Cary","population":180000,"volumes":{}},{"city":"Wilmington","population":120000,"volumes":{}},{"city":"High Point","population":115000,"volumes":{}},{"city":"Concord","population":105000,"volumes":{}},{"city":"Asheville","population":95000,"volumes":{}},{"city":"Greenville","population":90000,"volumes":{}},{"city":"Gastonia","population":80000,"volumes":{}},{"city":"Jacksonville","population":72000,"volumes":{}},{"city":"Apex","population":70000,"volumes":{}},{"city":"Huntersville","population":65000,"volumes":{}},{"city":"Chapel Hill","population":62000,"volumes":{}},{"city":"Burlington","population":57000,"volumes":{}},{"city":"Rocky Mount","population":54000,"volumes":{}},{"city":"Kannapolis","population":53000,"volumes":{}},{"city":"Wilson","population":50000,"volumes":{}},{"city":"Hickory","population":43000,"volumes":{}},{"city":"Indian Trail","population":41000,"volumes":{}},{"city":"Holly Springs","population":40000,"volumes":{}},{"city":"Mooresville","population":40000,"volumes":{}},{"city":"Monroe","population":39000,"volumes":{}},{"city":"Salisbury","population":35000,"volumes":{}},{"city":"Goldsboro","population":34000,"volumes":{}},{"city":"Matthews","population":34000,"volumes":{}},{"city":"Fuquay-Varina","population":33000,"volumes":{}},{"city":"Sanford","population":32000,"volumes":{}},{"city":"Clayton","population":31000,"volumes":{}},{"city":"Cornelius","population":31000,"volumes":{}},{"city":"Statesville","population":30000,"volumes":{}},{"city":"Thomasville","population":27000,"volumes":{}}]},{"state":"North Dakota","cities":[{"city":"Fargo","population":133000,"volumes":{}},{"city":"Bismarck","population":74000,"volumes":{}},{"city":"Grand Forks","population":59000,"volumes":{}},{"city":"Minot","population":48000,"volumes":{}},{"city":"West Fargo","population":39000,"volumes":{}},{"city":"Williston","population":29000,"volumes":{}},{"city":"Dickinson","population":25000,"volumes":{}},{"city":"Mandan","population":24000,"volumes":{}},{"city":"Jamestown","population":15000,"volumes":{}},{"city":"Wahpeton","population":10000,"volumes":{}}]},{"state":"Ohio","cities":[{"city":"Columbus","population":920000,"volumes":{}},{"city":"Cleveland","population":370000,"volumes":{}},{"city":"Cincinnati","population":308000,"volumes":{}},{"city":"Toledo","population":268000,"volumes":{}},{"city":"Akron","population":190000,"volumes":{}},{"city":"Dayton","population":135000,"volumes":{}},{"city":"Parma","population":79000,"volumes":{}},{"city":"Canton","population":70000,"volumes":{}},{"city":"Youngstown","population":60000,"volumes":{}},{"city":"Lorain","population":65000,"volumes":{}},{"city":"Hamilton","population":62000,"volumes":{}},{"city":"Springfield","population":58000,"volumes":{}},{"city":"Kettering","population":57000,"volumes":{}},{"city":"Elyria","population":53000,"volumes":{}},{"city":"Lakewood","population":50000,"volumes":{}},{"city":"Cuyahoga Falls","population":51000,"volumes":{}},{"city":"Middletown","population":50000,"volumes":{}},{"city":"Newark","population":49000,"volumes":{}},{"city":"Mansfield","population":47000,"volumes":{}},{"city":"Mentor","population":47000,"volumes":{}},{"city":"Beavercreek","population":47000,"volumes":{}},{"city":"Strongsville","population":46000,"volumes":{}},{"city":"Dublin","population":46000,"volumes":{}},{"city":"Westerville","population":44000,"volumes":{}},{"city":"Stow","population":44000,"volumes":{}},{"city":"Brunswick","population":43000,"volumes":{}},{"city":"Fairfield","population":42000,"volumes":{}},{"city":"Findlay","population":41000,"volumes":{}},{"city":"Lancaster","population":41000,"volumes":{}},{"city":"Warren","population":40000,"volumes":{}},{"city":"Huber Heights","population":40000,"volumes":{}},{"city":"Grove City","population":39000,"volumes":{}},{"city":"Delaware","population":38000,"volumes":{}},{"city":"Reynoldsburg","population":37000,"volumes":{}},{"city":"Gahanna","population":36000,"volumes":{}}]},{"state":"Oklahoma","cities":[{"city":"Oklahoma City","population":710000,"volumes":{}},{"city":"Tulsa","population":410000,"volumes":{}},{"city":"Norman","population":130000,"volumes":{}},{"city":"Broken Arrow","population":115000,"volumes":{}},{"city":"Edmond","population":97000,"volumes":{}},{"city":"Lawton","population":91000,"volumes":{}},{"city":"Moore","population":63000,"volumes":{}},{"city":"Midwest City","population":58000,"volumes":{}},{"city":"Stillwater","population":49000,"volumes":{}},{"city":"Enid","population":49000,"volumes":{}},{"city":"Muskogee","population":37000,"volumes":{}},{"city":"Bartlesville","population":37000,"volumes":{}},{"city":"Owasso","population":37000,"volumes":{}},{"city":"Shawnee","population":31000,"volumes":{}},{"city":"Yukon","population":30000,"volumes":{}},{"city":"Bixby","population":29000,"volumes":{}},{"city":"Ardmore","population":25000,"volumes":{}},{"city":"Ponca City","population":24000,"volumes":{}},{"city":"Jenks","population":23000,"volumes":{}},{"city":"Duncan","population":22000,"volumes":{}},{"city":"Mustang","population":21000,"volumes":{}},{"city":"Del City","population":21000,"volumes":{}},{"city":"Sapulpa","population":21000,"volumes":{}},{"city":"Altus","population":18000,"volumes":{}},{"city":"McAlester","population":18000,"volumes":{}},{"city":"Chickasha","population":17000,"volumes":{}},{"city":"Claremore","population":16000,"volumes":{}},{"city":"El Reno","population":16000,"volumes":{}},{"city":"Durant","population":16000,"volumes":{}},{"city":"Sand Springs","population":16000,"volumes":{}},{"city":"Bethany","population":15000,"volumes":{}},{"city":"Tahlequah","population":15000,"volumes":{}},{"city":"Ada","population":15000,"volumes":{}},{"city":"Pryor Creek","population":11000,"volumes":{}},{"city":"Miami","population":11000,"volumes":{}}]},{"state":"Oregon","cities":[{"city":"Portland","population":635000,"volumes":{}},{"city":"Salem","population":180000,"volumes":{}},{"city":"Eugene","population":175000,"volumes":{}},{"city":"Gresham","population":115000,"volumes":{}},{"city":"Hillsboro","population":110000,"volumes":{}},{"city":"Beaverton","population":97000,"volumes":{}},{"city":"Bend","population":95000,"volumes":{}},{"city":"Medford","population":87000,"volumes":{}},{"city":"Springfield","population":63000,"volumes":{}},{"city":"Corvallis","population":60000,"volumes":{}},{"city":"Albany","population":56000,"volumes":{}},{"city":"Tigard","population":55000,"volumes":{}},{"city":"Lake Oswego","population":40000,"volumes":{}},{"city":"Grants Pass","population":39000,"volumes":{}},{"city":"Oregon City","population":38000,"volumes":{}},{"city":"McMinnville","population":37000,"volumes":{}},{"city":"Redmond","population":36000,"volumes":{}},{"city":"Tualatin","population":27000,"volumes":{}},{"city":"West Linn","population":27000,"volumes":{}},{"city":"Woodburn","population":26000,"volumes":{}},{"city":"Newberg","population":25000,"volumes":{}},{"city":"Roseburg","population":24000,"volumes":{}},{"city":"Forest Grove","population":24000,"volumes":{}},{"city":"Klamath Falls","population":22000,"volumes":{}},{"city":"Ashland","population":21000,"volumes":{}},{"city":"Wilsonville","population":21000,"volumes":{}},{"city":"Sherwood","population":20000,"volumes":{}},{"city":"Keizer","population":20000,"volumes":{}},{"city":"Central Point","population":20000,"volumes":{}},{"city":"Canby","population":19000,"volumes":{}},{"city":"The Dalles","population":16000,"volumes":{}},{"city":"Troutdale","population":16000,"volumes":{}},{"city":"Hermiston","population":17000,"volumes":{}},{"city":"Pendleton","population":17000,"volumes":{}},{"city":"Coos Bay","population":16000,"volumes":{}}]},{"state":"Pennsylvania","cities":[{"city":"Portland","population":635000,"volumes":{}},{"city":"Salem","population":180000,"volumes":{}},{"city":"Eugene","population":175000,"volumes":{}},{"city":"Gresham","population":115000,"volumes":{}},{"city":"Hillsboro","population":110000,"volumes":{}},{"city":"Beaverton","population":97000,"volumes":{}},{"city":"Bend","population":95000,"volumes":{}},{"city":"Medford","population":87000,"volumes":{}},{"city":"Springfield","population":63000,"volumes":{}},{"city":"Corvallis","population":60000,"volumes":{}},{"city":"Albany","population":56000,"volumes":{}},{"city":"Tigard","population":55000,"volumes":{}},{"city":"Lake Oswego","population":40000,"volumes":{}},{"city":"Grants Pass","population":39000,"volumes":{}},{"city":"Oregon City","population":38000,"volumes":{}},{"city":"McMinnville","population":37000,"volumes":{}},{"city":"Redmond","population":36000,"volumes":{}},{"city":"Tualatin","population":27000,"volumes":{}},{"city":"West Linn","population":27000,"volumes":{}},{"city":"Woodburn","population":26000,"volumes":{}},{"city":"Newberg","population":25000,"volumes":{}},{"city":"Roseburg","population":24000,"volumes":{}},{"city":"Forest Grove","population":24000,"volumes":{}},{"city":"Klamath Falls","population":22000,"volumes":{}},{"city":"Ashland","population":21000,"volumes":{}},{"city":"Wilsonville","population":21000,"volumes":{}},{"city":"Sherwood","population":20000,"volumes":{}},{"city":"Keizer","population":20000,"volumes":{}},{"city":"Central Point","population":20000,"volumes":{}},{"city":"Canby","population":19000,"volumes":{}},{"city":"The Dalles","population":16000,"volumes":{}},{"city":"Troutdale","population":16000,"volumes":{}},{"city":"Hermiston","population":17000,"volumes":{}},{"city":"Pendleton","population":17000,"volumes":{}},{"city":"Coos Bay","population":16000,"volumes":{}}]},{"state":"Rhode Island","cities":[{"city":"Providence","population":190000,"volumes":{}},{"city":"Cranston","population":82000,"volumes":{}},{"city":"Warwick","population":81000,"volumes":{}},{"city":"Pawtucket","population":76000,"volumes":{}},{"city":"East Providence","population":50000,"volumes":{}},{"city":"Woonsocket","population":43000,"volumes":{}},{"city":"Cumberland","population":36000,"volumes":{}},{"city":"Coventry","population":35000,"volumes":{}},{"city":"North Providence","population":34000,"volumes":{}},{"city":"South Kingstown","population":31000,"volumes":{}},{"city":"Johnston","population":30000,"volumes":{}},{"city":"West Warwick","population":29000,"volumes":{}},{"city":"Bristol","population":23000,"volumes":{}},{"city":"Lincoln","population":22000,"volumes":{}},{"city":"Smithfield","population":22000,"volumes":{}}]},{"state":"South Carolina","cities":[{"city":"Charleston","population":156000,"volumes":{}},{"city":"Columbia","population":137000,"volumes":{}},{"city":"North Charleston","population":118000,"volumes":{}},{"city":"Mount Pleasant","population":92000,"volumes":{}},{"city":"Rock Hill","population":77000,"volumes":{}},{"city":"Greenville","population":75000,"volumes":{}},{"city":"Summerville","population":52000,"volumes":{}},{"city":"Goose Creek","population":47000,"volumes":{}},{"city":"Sumter","population":43000,"volumes":{}},{"city":"Florence","population":39000,"volumes":{}},{"city":"Spartanburg","population":38000,"volumes":{}},{"city":"Myrtle Beach","population":37000,"volumes":{}},{"city":"Greer","population":36000,"volumes":{}},{"city":"Anderson","population":29000,"volumes":{}},{"city":"Conway","population":27000,"volumes":{}},{"city":"Hilton Head Island","population":25000,"volumes":{}},{"city":"Greenwood","population":23000,"volumes":{}},{"city":"Aiken","population":22000,"volumes":{}},{"city":"Mauldin","population":21000,"volumes":{}},{"city":"North Augusta","population":21000,"volumes":{}},{"city":"Easley","population":21000,"volumes":{}},{"city":"Simpsonville","population":20000,"volumes":{}},{"city":"Hanahan","population":18000,"volumes":{}},{"city":"Gaffney","population":13000,"volumes":{}},{"city":"Lexington","population":13000,"volumes":{}},{"city":"Clemson","population":13000,"volumes":{}},{"city":"Orangeburg","population":13000,"volumes":{}},{"city":"Beaufort","population":13000,"volumes":{}},{"city":"Bluffton","population":13000,"volumes":{}},{"city":"West Columbia","population":12000,"volumes":{}},{"city":"Cayce","population":12000,"volumes":{}},{"city":"Fort Mill","population":12000,"volumes":{}},{"city":"Forest Acres","population":10000,"volumes":{}},{"city":"Newberry","population":10000,"volumes":{}},{"city":"Hartsville","population":10000,"volumes":{}}]},{"state":"South Dakota","cities":[{"city":"Sioux Falls","population":213000,"volumes":{}},{"city":"Rapid City","population":80000,"volumes":{}},{"city":"Aberdeen","population":28000,"volumes":{}},{"city":"Brookings","population":24000,"volumes":{}},{"city":"Watertown","population":22000,"volumes":{}},{"city":"Mitchell","population":15000,"volumes":{}},{"city":"Yankton","population":15000,"volumes":{}},{"city":"Huron","population":14000,"volumes":{}},{"city":"Pierre","population":14000,"volumes":{}},{"city":"Spearfish","population":12000,"volumes":{}}]},{"state":"Texas","cities":[{"city":"Houston","population":2330000,"volumes":{}},{"city":"San Antonio","population":1590000,"volumes":{}},{"city":"Dallas","population":1300000,"volumes":{}},{"city":"Austin","population":980000,"volumes":{}},{"city":"Fort Worth","population":960000,"volumes":{}},{"city":"El Paso","population":680000,"volumes":{}},{"city":"Arlington","population":400000,"volumes":{}},{"city":"Corpus Christi","population":320000,"volumes":{}},{"city":"Plano","population":290000,"volumes":{}},{"city":"Laredo","population":260000,"volumes":{}},{"city":"Lubbock","population":260000,"volumes":{}},{"city":"Garland","population":240000,"volumes":{}},{"city":"Irving","population":240000,"volumes":{}},{"city":"Amarillo","population":200000,"volumes":{}},{"city":"Grand Prairie","population":200000,"volumes":{}},{"city":"McKinney","population":200000,"volumes":{}},{"city":"Frisco","population":200000,"volumes":{}},{"city":"Brownsville","population":190000,"volumes":{}},{"city":"Pasadena","population":150000,"volumes":{}},{"city":"Killeen","population":150000,"volumes":{}},{"city":"Mesquite","population":150000,"volumes":{}},{"city":"McAllen","population":145000,"volumes":{}},{"city":"Waco","population":140000,"volumes":{}},{"city":"Carrollton","population":140000,"volumes":{}},{"city":"Denton","population":140000,"volumes":{}},{"city":"Midland","population":140000,"volumes":{}},{"city":"Abilene","population":125000,"volumes":{}},{"city":"Round Rock","population":120000,"volumes":{}},{"city":"Pearland","population":125000,"volumes":{}},{"city":"Richardson","population":120000,"volumes":{}},{"city":"Odessa","population":115000,"volumes":{}},{"city":"College Station","population":120000,"volumes":{}},{"city":"Lewisville","population":115000,"volumes":{}},{"city":"Tyler","population":110000,"volumes":{}},{"city":"Allen","population":105000,"volumes":{}}]},{"state":"Utah","cities":[{"city":"Salt Lake City","population":205000,"volumes":{}},{"city":"West Valley City","population":140000,"volumes":{}},{"city":"West Jordan","population":118000,"volumes":{}},{"city":"Provo","population":115000,"volumes":{}},{"city":"Orem","population":98000,"volumes":{}},{"city":"Sandy","population":96000,"volumes":{}},{"city":"St. George","population":95000,"volumes":{}},{"city":"Ogden","population":87000,"volumes":{}},{"city":"Layton","population":84000,"volumes":{}},{"city":"South Jordan","population":84000,"volumes":{}},{"city":"Lehi","population":83000,"volumes":{}},{"city":"Millcreek","population":80000,"volumes":{}},{"city":"Taylorsville","population":70000,"volumes":{}},{"city":"Herriman","population":70000,"volumes":{}},{"city":"Logan","population":56000,"volumes":{}},{"city":"Draper","population":55000,"volumes":{}},{"city":"Riverton","population":45000,"volumes":{}},{"city":"Bountiful","population":45000,"volumes":{}},{"city":"Spanish Fork","population":44000,"volumes":{}},{"city":"Roy","population":39000,"volumes":{}},{"city":"Pleasant Grove","population":38000,"volumes":{}},{"city":"Eagle Mountain","population":37000,"volumes":{}},{"city":"Kaysville","population":32000,"volumes":{}},{"city":"Tooele","population":35000,"volumes":{}},{"city":"Springville","population":36000,"volumes":{}},{"city":"Midvale","population":34000,"volumes":{}},{"city":"Clearfield","population":32000,"volumes":{}},{"city":"Murray","population":50000,"volumes":{}},{"city":"Cottonwood Heights","population":34000,"volumes":{}},{"city":"American Fork","population":33000,"volumes":{}},{"city":"Clinton","population":32000,"volumes":{}},{"city":"Syracuse","population":31000,"volumes":{}},{"city":"North Ogden","population":20000,"volumes":{}},{"city":"Cedar City","population":37000,"volumes":{}},{"city":"Payson","population":21000,"volumes":{}}]},{"state":"Vermont","cities":[{"city":"Burlington","population":44000,"volumes":{}},{"city":"South Burlington","population":20000,"volumes":{}},{"city":"Colchester","population":17000,"volumes":{}},{"city":"Rutland","population":15000,"volumes":{}},{"city":"Essex Junction","population":11000,"volumes":{}}]},{"state":"Virginia","cities":[{"city":"Virginia Beach","population":457000,"volumes":{}},{"city":"Chesapeake","population":252000,"volumes":{}},{"city":"Norfolk","population":238000,"volumes":{}},{"city":"Richmond","population":232000,"volumes":{}},{"city":"Arlington","population":236000,"volumes":{}},{"city":"Newport News","population":184000,"volumes":{}},{"city":"Alexandria","population":158000,"volumes":{}},{"city":"Hampton","population":137000,"volumes":{}},{"city":"Roanoke","population":97000,"volumes":{}},{"city":"Portsmouth","population":97000,"volumes":{}},{"city":"Suffolk","population":96000,"volumes":{}},{"city":"Lynchburg","population":80000,"volumes":{}},{"city":"Centreville","population":74000,"volumes":{}},{"city":"Dale City","population":73000,"volumes":{}},{"city":"Reston","population":63000,"volumes":{}},{"city":"Harrisonburg","population":52000,"volumes":{}},{"city":"Leesburg","population":52000,"volumes":{}},{"city":"Ashburn","population":50000,"volumes":{}},{"city":"Charlottesville","population":47000,"volumes":{}},{"city":"Blacksburg","population":45000,"volumes":{}},{"city":"Manassas","population":42000,"volumes":{}},{"city":"Woodbridge","population":41000,"volumes":{}},{"city":"Lake Ridge","population":41000,"volumes":{}},{"city":"Annandale","population":41000,"volumes":{}},{"city":"McLean","population":41000,"volumes":{}},{"city":"Tuckahoe","population":40000,"volumes":{}},{"city":"Linton Hall","population":40000,"volumes":{}},{"city":"Burke","population":39000,"volumes":{}},{"city":"Short Pump","population":38000,"volumes":{}},{"city":"West Falls Church","population":38000,"volumes":{}},{"city":"Christiansburg","population":38000,"volumes":{}},{"city":"Herndon","population":37000,"volumes":{}},{"city":"Danville","population":36000,"volumes":{}},{"city":"Springfield","population":35000,"volumes":{}},{"city":"Oakton","population":34000,"volumes":{}}]},{"state":"Washington","cities":[{"city":"Seattle","population":755000,"volumes":{}},{"city":"Spokane","population":230000,"volumes":{}},{"city":"Tacoma","population":220000,"volumes":{}},{"city":"Vancouver","population":195000,"volumes":{}},{"city":"Bellevue","population":154000,"volumes":{}},{"city":"Kent","population":137000,"volumes":{}},{"city":"Everett","population":118000,"volumes":{}},{"city":"Renton","population":107000,"volumes":{}},{"city":"Spokane Valley","population":105000,"volumes":{}},{"city":"Federal Way","population":101000,"volumes":{}},{"city":"Yakima","population":97000,"volumes":{}},{"city":"Kirkland","population":94000,"volumes":{}},{"city":"Bellingham","population":93000,"volumes":{}},{"city":"Kennewick","population":92000,"volumes":{}},{"city":"Auburn","population":87000,"volumes":{}},{"city":"Pasco","population":78000,"volumes":{}},{"city":"Marysville","population":71000,"volumes":{}},{"city":"Redmond","population":67000,"volumes":{}},{"city":"Sammamish","population":66000,"volumes":{}},{"city":"Lakewood","population":64000,"volumes":{}},{"city":"Richland","population":63000,"volumes":{}},{"city":"Shoreline","population":61000,"volumes":{}},{"city":"Burien","population":51000,"volumes":{}},{"city":"Olympia","population":53000,"volumes":{}},{"city":"Lacey","population":53000,"volumes":{}},{"city":"Edmonds","population":52000,"volumes":{}},{"city":"Puyallup","population":42000,"volumes":{}},{"city":"Lynnwood","population":40000,"volumes":{}},{"city":"Mount Vernon","population":38000,"volumes":{}},{"city":"Walla Walla","population":34000,"volumes":{}},{"city":"Pullman","population":33000,"volumes":{}},{"city":"Des Moines","population":32000,"volumes":{}},{"city":"Issaquah","population":31000,"volumes":{}},{"city":"Bremerton","population":30000,"volumes":{}},{"city":"Longview","population":30000,"volumes":{}}]},{"state":"West Virginia","cities":[{"city":"Charleston","population":48000,"volumes":{}},{"city":"Huntington","population":45000,"volumes":{}},{"city":"Morgantown","population":30000,"volumes":{}},{"city":"Parkersburg","population":29000,"volumes":{}},{"city":"Wheeling","population":26000,"volumes":{}},{"city":"Weirton","population":19000,"volumes":{}},{"city":"Martinsburg","population":18000,"volumes":{}},{"city":"Fairmont","population":18000,"volumes":{}},{"city":"Beckley","population":17000,"volumes":{}},{"city":"Clarksburg","population":16000,"volumes":{}}]},{"state":"Wisconsin","cities":[{"city":"Milwaukee","population":565000,"volumes":{}},{"city":"Madison","population":275000,"volumes":{}},{"city":"Green Bay","population":107000,"volumes":{}},{"city":"Kenosha","population":100000,"volumes":{}},{"city":"Racine","population":77000,"volumes":{}},{"city":"Appleton","population":75000,"volumes":{}},{"city":"Waukesha","population":71000,"volumes":{}},{"city":"Eau Claire","population":69000,"volumes":{}},{"city":"Oshkosh","population":66000,"volumes":{}},{"city":"Janesville","population":65000,"volumes":{}},{"city":"West Allis","population":60000,"volumes":{}},{"city":"La Crosse","population":52000,"volumes":{}},{"city":"Sheboygan","population":49000,"volumes":{}},{"city":"Wauwatosa","population":48000,"volumes":{}},{"city":"Fond du Lac","population":44000,"volumes":{}},{"city":"Brookfield","population":40000,"volumes":{}},{"city":"New Berlin","population":39000,"volumes":{}},{"city":"Wausau","population":39000,"volumes":{}},{"city":"Beloit","population":36000,"volumes":{}},{"city":"Franklin","population":36000,"volumes":{}},{"city":"Oak Creek","population":35000,"volumes":{}},{"city":"Manitowoc","population":34000,"volumes":{}},{"city":"West Bend","population":32000,"volumes":{}},{"city":"Sun Prairie","population":31000,"volumes":{}},{"city":"Superior","population":26000,"volumes":{}},{"city":"Stevens Point","population":26000,"volumes":{}},{"city":"Neenah","population":25000,"volumes":{}},{"city":"Fitchburg","population":21000,"volumes":{}},{"city":"Muskego","population":21000,"volumes":{}},{"city":"De Pere","population":20000,"volumes":{}},{"city":"South Milwaukee","population":20000,"volumes":{}},{"city":"Marshfield","population":18000,"volumes":{}},{"city":"Cudahy","population":18000,"volumes":{}},{"city":"Menomonee Falls","population":18000,"volumes":{}},{"city":"Wisconsin Rapids","population":18000,"volumes":{}}]},{"state":"Wyoming","cities":[{"city":"Cheyenne","population":65000,"volumes":{}},{"city":"Casper","population":58000,"volumes":{}},{"city":"Laramie","population":32000,"volumes":{}},{"city":"Gillette","population":32000,"volumes":{}},{"city":"Rock Springs","population":23000,"volumes":{}},{"city":"Sheridan","population":19000,"volumes":{}},{"city":"Green River","population":12000,"volumes":{}},{"city":"Evanston","population":12000,"volumes":{}},{"city":"Riverton","population":11000,"volumes":{}},{"city":"Jackson","population":10000,"volumes":{}}]}],"homePage":{"content":["Heading: Lawn Mower & Small Engine Repair","Sub heading: We repair lawn mowers, motorcycles, ATV's, UTV's, boats, and more!","Call Now: 888-658-9157","Our Services","Spark Plugs Changes","Energize your engine\u2019s performance with our Spark Plug Change Service. We swiftly and expertly replace your spark plugs, a vital component for efficient combustion. Enhance fuel efficiency, promote smoother starts, and optimize overall engine performance. Trust us to keep your equipment running at its best with our hassle-free and reliable Spark Plug Change Service. Experience the difference a simple spark plug change can make in reviving your engine\u2019s power and reliability.\u201d","Oil Changes","Hiring us for oil change on small engines makes the troublesome process easier on you. Our oil changes ensures the longevity and optimal performance of your equipment. Regular equipment oil changes are essential for maintaining the health and efficiency of small engines, and ensuring smooth operation and prolonged lifespans.","Gas Line Replacement","Fuel your engine\u2019s potential with our Gas Line Change Service. We specialize in efficient and precise gas line replacements, ensuring uninterrupted fuel flow to your equipment. Experience improved engine performance, enhanced reliability, and peace of mind knowing your fuel system is in top-notch condition. Choose our Gas Line Change Service for a seamless solution to optimize your engine\u2019s fuel efficiency and keep it running smoothly","Blade Sharpening","Elevate your lawn care game with our Lawn Mower Blade Sharpening Service. Our skilled technicians provide expert sharpening for your mower blades, ensuring a clean and precise cut for a healthier, more manicured lawn. With a focus on precision and efficiency, we bring new life to your mower blades, enhancing their performance and extending their lifespan. Trust our professional service to keep your lawn mower in top condition, delivering crisp, clean cuts every time. Choose us for a sharper, smoother, and more efficient lawn care experience","House Call (Small Equipment)","House calls for small equipment bring the expertise of our skilled technicians right to your doorstep. Whether it\u2019s a lawnmower, chainsaw, or any other small equipment that needs attention, our professionals arrive at your location fully equipped to diagnose and address issues on-site. This service not only saves you the hassle of transporting equipment but also ensures a quick and convenient resolution. Experience the ease of scheduling a house call, where our experts provide personalized attention to your small equipment, offering repairs, maintenance, and valuable insights for optimal performance\u2014all in the comfort of your own space.","House Call (Heavy Equipment)","House calls for large equipment offer a specialized and convenient solution for the maintenance and repair of substantial machinery right at your location. Our team of skilled technicians brings their expertise and tools to your facility, minimizing downtime and streamlining the servicing process. Whether it\u2019s heavy machinery, industrial equipment, or large-scale tools, we understand the importance of on-site support. This service not only saves you the logistical challenges of transporting large equipment but also ensures that repairs and maintenance are tailored to the specific needs of your operational environment.","Carburetor Cleaning","Revitalize your engine\u2019s performance with our expert Carburetor Cleaning Service. Our skilled technicians meticulously disassemble, clean, and inspect each component, ensuring optimal fuel efficiency and smooth operation. With a focus on precision and safety, we reassemble your carburetor, replacing any worn parts with high-quality components. Experience the difference as your engine runs like new, delivering peak performance and reliability.","Join Our Team","Joining us means stepping into a dynamic environment where your expertise in fine-tuning engines is not just valued; it\u2019s celebrated. We believe in recognizing and nurturing talent, providing opportunities for growth and skill development. As a part of our team, you\u2019ll not only refine engines; you\u2019ll refine your own career path. Your dedication contributes directly to the success of our craft, and we celebrate each triumph together.","Heading Structure","Heading Structure"]},"mainSiteBacklinks":{"socialBookmarks":[{"domain":"https://express-page.com/","liveLink":"https://express-page.com/story6048873/wildwood-small-engine-repair","status":"Live"},{"domain":"https://socialaffluent.com/","liveLink":"https://socialaffluent.com/story6180849/wildwood-small-engine-repair","status":"Live"},{"domain":"https://reallivesocial.com/","liveLink":"https://reallivesocial.com/story6244561/wildwood-small-engine-repair","status":"Live"},{"domain":"https://wisesocialsmedia.com/","liveLink":"https://wisesocialsmedia.com/story6089487/wildwood-small-engine-repair","status":"Live"},{"domain":"https://socialicus.com/","liveLink":"https://socialicus.com/story6089116/wildwood-small-engine-repair","status":"Live"},{"domain":"https://tornadosocial.com/","liveLink":"https://tornadosocial.com/story6223820/wildwood-small-engine-repair","status":"Live"},{"domain":"https://bookmarkvids.com/","liveLink":"https://bookmarkvids.com/story22116589/wildwood-small-engine-repair","status":"Live"},{"domain":"https://fellowfavorite.com/","liveLink":"https://fellowfavorite.com/story21911009/wildwood-small-engine-repair","status":"Live"},{"domain":"https://bookmarkalexa.com/","liveLink":"https://bookmarkalexa.com/story6236719/wildwood-small-engine-repair","status":"Live"},{"domain":"https://socialwebnotes.com/","liveLink":"https://socialwebnotes.com/story5741681/wild-wood-small-engine-repair","status":"Live"},{"domain":"https://bookmark-template.com/","liveLink":"https://bookmark-template.com/story26415698/wildwood-small-engine-repair","status":"Live"},{"domain":"https://bookmarkja.com/","liveLink":"https://bookmarkja.com/story23285503/wildwood-small-engine-repair","status":"Live"},{"domain":"https://dirstop.com/","liveLink":"https://dirstop.com/story26164223/wildwood-small-engine-repair","status":"Live"},{"domain":"https://getsocialpr.com/","liveLink":"https://getsocialpr.com/story22230204/wildwood-small-engine-repair","status":"Live"},{"domain":"https://mediajx.com/","liveLink":"https://mediajx.com/story25785547/wildwood-small-engine-repair","status":"Live"},{"domain":"https://prbookmarkingwebsites.com/","liveLink":"https://prbookmarkingwebsites.com/story26246349/wildwood-small-engine-repair","status":"Live"},{"domain":"https://gorillasocialwork.com/","liveLink":"https://gorillasocialwork.com/story24736726/wildwood-small-engine-repair","status":"Live"},{"domain":"https://bookmarkport.com/","liveLink":"https://bookmarkport.com/story23260503/wildwood-small-engine-repair","status":"Live"},{"domain":"https://hindibookmark.com/","liveLink":"https://hindibookmark.com/story22561220/wildwood-small-engine-repair","status":"Live"},{"domain":"https://bookmarksknot.com/","liveLink":"https://bookmarksknot.com/story22562637/wildwood-small-engine-repair","status":"Live"}],"guestPosts":[{"domain":"https://medium.com/","liveLink":"","status":"Pending"},{"domain":"https://www.livejournal.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hashtap.com/","liveLink":"","status":"Pending"},{"domain":"https://www.blogger.com/","liveLink":"","status":"Pending"},{"domain":"https://articlebiz.com","liveLink":"","status":"Pending"},{"domain":"https://buymeacoffee.com/","liveLink":"","status":"Pending"},{"domain":"https://www.quora.com/","liveLink":"","status":"Pending"},{"domain":"https://trumpbookusa.com/","liveLink":"","status":"Pending"},{"domain":"https://printable-calendar.mn.co/","liveLink":"","status":"Pending"},{"domain":"https://substack.com/","liveLink":"","status":"Pending"},{"domain":"https://www.hellobox.co/","liveLink":"","status":"Pending"},{"domain":"https://pinaunaeditora.com.br/","liveLink":"","status":"Pending"},{"domain":"https://1st-street.com/","liveLink":"","status":"Pending"},{"domain":"https://urrankings.com/","liveLink":"","status":"Pending"},{"domain":"https://collectionofblogs.com/","liveLink":"","status":"Pending"},{"domain":"https://doomelang.com/","liveLink":"","status":"Pending"},{"domain":"https://bdnews55.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/item/","liveLink":"","status":"Pending"},{"domain":"https://usman09.ampedpages.com/","liveLink":"","status":"Pending"},{"domain":"https://timessquarereporter.com/","liveLink":"","status":"Pending"},{"domain":"https://www.bairwaji.com/","liveLink":"","status":"Pending"},{"domain":"https://www.diigo.com/user/urban12","liveLink":"","status":"Pending"},{"domain":"https://webyourself.eu","liveLink":"","status":"Pending"}]},"metaDataSF":[{"keyword":"Sioux Falls small engine repair","title":"Sioux Falls Small Engine Repair & Maintenance | Fast Service","description":"Looking for Sioux Falls small engine repair? Wildwood Small Engine Repair offers fast, affordable service for mowers, snow blowers, and generators. Call today!"},{"keyword":"generator repair sioux falls","title":"Generator Repair Sioux Falls | Reliable Wildwood Service","description":"For trusted generator repair Sioux Falls, count on Wildwood Small Engine Repair. We fix portable and standby generators quickly at affordable rates."},{"keyword":"lawn mower repair sioux falls","title":"Lawn Mower Repair Sioux Falls | Trusted Wildwood Experts","description":"Need lawn mower repair Sioux Falls? Wildwood Small Engine Repair fixes push and riding mowers with reliable, affordable, and expert service."},{"keyword":"snow blower repair sioux falls","title":"Snow Blower Repair Sioux Falls | Fast, Affordable Service","description":"Get your snow blower ready for winter! Sioux Falls experts at Wildwood Small Engine Repair fix all brands fast. Call today for quick service!"},{"keyword":"small engine repair sarasota","title":"Small Engine Repair Sarasota | Professional, Affordable Service","description":"Searching for small engine repair Sarasota? Wildwood Small Engine Repair services mowers, snow blowers, and generators fast and affordably. Book now!"},{"keyword":"lawn mower repair sarasota fl","title":"Lawn Mower Repair Sarasota FL | Trusted Local Experts","description":"Wildwood Small Engine Repair provides lawn mower repair Sarasota FL you can rely on. Affordable pricing, fast turnaround, and expert technicians. Contact us today!"},{"keyword":"snow blower repair sarasota","title":"Snow Blower Repair Sarasota | Local Service Experts","description":"For expert snow blower repair Sarasota, trust Wildwood Small Engine Repair. Quality parts, quick service, and dependable results. Call today!"},{"keyword":"generator repair sarasota","title":"Generator Repair Sarasota | Fast Local Technicians","description":"Wildwood Small Engine Repair delivers professional generator repair Sarasota. We handle all brands quickly and affordably. Schedule your service now!"},{"keyword":"Generator Repair Lee's Summit","title":"Generator Repair Lee\u2019s Summit | Fast Local Experts","description":"Get quick and dependable generator repair Lee\u2019s Summit from Wildwood Small Engine Repair. Skilled technicians and honest prices. Call today!"},{"keyword":"lawn mower repair Lee\u2019s summit","title":"Lawn Mower Repair Lee\u2019s Summit | Quick Reliable Service","description":"For expert lawn mower repair in Lee\u2019s Summit, trust Wildwood Small Engine Repair. We fix push and riding mowers fast and affordably. Schedule today."},{"keyword":"Snow Blower Repair Lee's Summit","title":"Snow Blower Repair Lee\u2019s Summit | Professional Repairs","description":"Wildwood Small Engine Repair provides snow blower repair in Lee\u2019s Summit. Fast, honest, and affordable service to keep your equipment winter-ready. Call today."},{"keyword":"small engine repair Lee\u2019s summit","title":"Small Engine Repair Lee\u2019s Summit | Trusted Technicians","description":"Wildwood Small Engine Repair offers reliable small engine repair in Lee\u2019s Summit, mo. Affordable rates, skilled service, and quick turnaround. Book now."},{"keyword":"small engine repair cape coral","title":"Small Engine Repair Cape Coral | Fast & Reliable Service","description":"Need small engine repair in Cape Coral? Our trusted team provides quick, affordable service for mowers, generators, and more. Call today!"},{"keyword":"generator repair cape coral","title":"Generator Repair Cape Coral | Local Experts You Can Trust","description":"Get expert generator repair in Cape Coral from local technicians. Fast, affordable, and dependable service to keep your power running."},{"keyword":"lawn mower repair cape coral fl","title":"Lawn Mower Repair Cape Coral FL | Quick & Affordable Fixes","description":"Looking for lawn mower repair in Cape Coral FL? We fix all brands fast! Affordable, expert service to get your mower running like new."},{"keyword":"Cape Coral snow blower repair","title":"Cape Coral Snow Blower Repair | Expert Local Technicians","description":"Get your snow blower ready for winter! Trusted Cape Coral snow blower repair service for all makes & models. Call today for fast service!"},{"keyword":"small engine repair tallahassee","title":"Fast Small Engine Repair Tallahassee | Call Today","description":"Get quick and affordable small engine repair in Tallahassee. Our expert team services mowers, blowers, and generators. Book trusted help today!"},{"keyword":"generator repair tallahassee","title":"Expert Generator Repair Tallahassee | Get Help Now","description":"Dependable generator repair in Tallahassee by local pros. Fast turnaround, affordable pricing, and lasting results. Schedule service now!"},{"keyword":"lawn mower repair tallahassee","title":"Affordable Lawn Mower Repair Tallahassee | Book Now","description":"Need lawn mower repair in Tallahassee? We fix all brands fast with expert care and honest pricing. Trusted local team ready to help today!"},{"keyword":"snow blower repair tallahassee","title":"Reliable Snow Blower Repair Tallahassee | Call Now","description":"Looking for snow blower repair in Tallahassee? Skilled technicians provide quick, affordable fixes and top-quality service. Contact us today!"},{"keyword":"small engine repair houston","title":"Fast Small Engine Repair Houston | Schedule Today","description":"Expert small engine repair in Houston for mowers, blowers, and more. Affordable rates, fast turnaround, and reliable service you can trust."},{"keyword":"snow blower repair houston","title":"Affordable Snow Blower Repair Houston | Call Now","description":"Get professional snow blower repair in Houston. Fast, honest, and dependable local service to keep your equipment running strong."},{"keyword":"lawn mower repair houston","title":"Trusted Lawn Mower Repair Houston | Book Today","description":"Quick, affordable lawn mower repair in Houston. We service all brands with expert care, transparent pricing, and same-day availability."},{"keyword":"generator repair houston","title":"Reliable Generator Repair Houston | Schedule Now","description":"Keep your power running strong! Fast, affordable generator repair in Houston by trusted local professionals. Call now to book your service."},{"keyword":"generator repair brownsville","title":"Reliable Generator Repair Brownsville | Call Today","description":"Looking for generator repair in Brownsville? Fast, affordable, and professional service by trusted local experts. Schedule your repair now!"},{"keyword":"small engine repair brownsville","title":"Fast Small Engine Repair Brownsville | Book Now","description":"Expert small engine repair in Brownsville for mowers, generators, and more. Affordable rates, fast service, and quality you can rely on."},{"keyword":"lawn mower repair brownsville","title":"Trusted Lawn Mower Repair Brownsville | Schedule Now","description":"Get quick, affordable lawn mower repair in Brownsville. We fix all brands with expert care and honest pricing. Call our local pros today!"},{"keyword":"snow blower repair brownsville","title":"Affordable Snow Blower Repair Brownsville | Call Now","description":"Need snow blower repair in Brownsville? Skilled technicians offer fast, affordable, and dependable service for all makes and models."},{"keyword":"small engine repair reno nv","title":"Expert Small Engine Repair Reno NV | Call Today","description":"Reliable small engine repair in Reno NV for mowers, generators, and more. Fast turnaround, affordable rates, and trusted local experts."},{"keyword":"generator repair reno nv","title":"Fast Generator Repair Reno NV | Book Service Now","description":"Need generator repair in Reno NV? Our technicians deliver quick, affordable, and expert repairs. Call today for reliable same-day service!"},{"keyword":"lawn mower repair reno","title":"Reliable Lawn Mower Repair Reno | Schedule Today","description":"Professional lawn mower repair in Reno. We fix all brands quickly with affordable pricing and expert local service you can count on."},{"keyword":"snow blower repair reno","title":"Trusted Snow Blower Repair Reno | Call for Service","description":"Looking for snow blower repair in Reno? Get fast, affordable, and professional service from skilled local technicians. Book today!"},{"keyword":"small engine repair lapeer mi","title":"Fast Small Engine Repair Services Lapeer MI | Call Today","description":"Need small engine repair in Lapeer MI? Our expert technicians deliver quick, affordable service for mowers, blowers, and generators. Book now!"},{"keyword":"generator repair lapeer","title":"Reliable All Generator Repair Lapeer | Schedule Now","description":"Looking for generator repair in Lapeer? Local professionals provide fast, affordable service to keep your generator running perfectly."},{"keyword":"snow blower repair lapeer","title":"Trusted Snow Blower Repair Lapeer | Book Today","description":"Get reliable snow blower repair in Lapeer. Skilled local experts fix all makes fast with quality parts and affordable pricing. Call today!"},{"keyword":"lawn mower repair lapeer","title":"Expert Lawn Mower Repair Lapeer | Call for Service","description":"Fast and affordable lawn mower repair in Lapeer. We fix all brands with expert care and friendly, local service. Schedule your repair now!"},{"keyword":"lawn mower repair crawfordsville in","title":"Lawn Mower Repair Crawfordsville IN | Book Service","description":"Keep your mower in top shape with professional repair in Crawfordsville IN. Quick diagnostics, quality parts, and fair pricing. Schedule service today!"},{"keyword":"snow blower repair crawfordsville","title":"Trusted Snow Blower Repair Crawfordsville | Call","description":"Count on our Crawfordsville snow blower repair team for fast, lasting fixes. We handle all models with care and keep your equipment winter-ready."},{"keyword":"small engine repair crawfordsville","title":"Small Engine Repair Crawfordsville | Fast & Local","description":"Our small engine repair in Crawfordsville covers mowers, blowers, and generators. Enjoy quick turnaround, honest pricing, and skilled local experts."},{"keyword":"generator repair crawfordsville","title":"Trusted Generator Repair Crawfordsville | Call Now","description":"Looking for generator repair in Crawfordsville? Our local pros deliver fast, affordable service with expert care and guaranteed reliability. Book your appointment today!"}],"sitePages":[{"url":"https://wildwoodsmallenginerepair.com/","keyword":"Mobile Small Engine Repair","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/shop/","keyword":"Small Engine Parts & Accessories","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/cart/","keyword":"Shopping Cart","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/checkout/","keyword":"Checkout \u2013 Small Engine Parts","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/my-account/","keyword":"Customer Account \u2013 Orders & Services","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/thank-you/","keyword":"Order Confirmation","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/join-our-team/","keyword":"Small Engine Repair Technician Jobs","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/map/","keyword":"Small Engine Repair Service Areas","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/blog/","keyword":"Small Engine Repair Blog","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/landing-page-template-2/","keyword":"Landing Page Template","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/baltimore-maryland/","keyword":"Small Engine Repair Baltimore MD","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/general-small-engine-repair/","keyword":"Small Engine Repair Services","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/boat-engine-repair/","keyword":"Boat Engine Repair","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/atv-motorcycle-repair/","keyword":"ATV & Motorcycle Engine Repair","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/about-2/","keyword":"About Wildwood Small Engine Repair","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/diy/","keyword":"DIY Small Engine Repair Help","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/contact/","keyword":"Contact Wildwood Small Engine Repair","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/about/","keyword":"About Our Mobile Repair Services","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/blue-springs-landing-page/","keyword":"Small Engine Repair Blue Springs","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/boca-raton-florida/","keyword":"Small Engine Repair Boca Raton","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/bremerton-landing-page/","keyword":"Small Engine Repair Bremerton","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/colorado-springs-colorado/","keyword":"Small Engine Repair Colorado Springs","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/boulder-landing-page/","keyword":"Small Engine Repair Boulder","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/boise-idaho/","keyword":"Small Engine Repair Boise","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/san-antonio-texas-landing-page-2/","keyword":"Small Engine Repair San Antonio","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/san-antonio/","keyword":"Small Engine Repair San Antonio","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/houston-texas-landing-page/","keyword":"Small Engine Repair Houston","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/seattle-landing-page/","keyword":"Small Engine Repair Seattle","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/colorado/","keyword":"Small Engine Repair Colorado","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/newport-landing-page/","keyword":"Small Engine Repair Newport","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/spoke-washington/","keyword":"Small Engine Repair Spokane","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/tallahassee-tennessee-landing-page/","keyword":"Small Engine Repair Tallahassee","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/sarasota-florida/","keyword":"Small Engine Repair Sarasota","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/missouri-kansas/","keyword":"Small Engine Repair Missouri & Kansas","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/kansas-city-landing-page/","keyword":"Small Engine Repair Kansas City","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/kansas-city/","keyword":"Small Engine Repair Kansas City","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/holden-landing-page/","keyword":"Small Engine Repair Holden","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/lees-summit-landing-page/","keyword":"Small Engine Repair Lee\u2019s Summit","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/missouri-kansas-landing-page/","keyword":"Small Engine Repair Missouri & Kansas","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/loveland-denver-colorado/","keyword":"Small Engine Repair Loveland & Denver","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/denver-landing-page/","keyword":"Small Engine Repair Denver","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/detroit-landing-page/","keyword":"Small Engine Repair Detroit","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/elkhart-indiana/","keyword":"Small Engine Repair Elkhart","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/hartford-connecticut/","keyword":"Small Engine Repair Hartford","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/indianapolis-indiana/","keyword":"Small Engine Repair Indianapolis","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/minnesota-landing-page/","keyword":"Small Engine Repair Minnesota","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/new-haven-connecticut/","keyword":"Small Engine Repair New Haven","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/reno-nevada/","keyword":"Small Engine Repair Reno","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/saint-paul-minnesota/","keyword":"Small Engine Repair Saint Paul","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/salt-lake-city-utah/","keyword":"Small Engine Repair Salt Lake City","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/toledo-ohio/","keyword":"Small Engine Repair Toledo","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/south-bend-indiana/","keyword":"Small Engine Repair South Bend","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/souix-falls-south-dakota/","keyword":"Small Engine Repair Sioux Falls","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/brownsville-texas/","keyword":"Small Engine Repair Brownsville","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/cape-coral/","keyword":"Small Engine Repair Cape Coral","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/cape-coral-landing-page/","keyword":"Small Engine Repair Cape Coral FL","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/fort-myers-landing-page/","keyword":"Small Engine Repair Fort Myers","title":"","description":""},{"url":"https://wildwoodsmallenginerepair.com/fort-wayne-indiana/","keyword":"Small Engine Repair Fort Wayne","title":"","description":""}],"flKeywords":{"Tallahassee, FL":[{"keyword":"small engine repair tallahassee","volume":110.0},{"keyword":"lawn mower repair tallahassee","volume":110.0},{"keyword":"small engine repair tallahassee fl","volume":110.0},{"keyword":"lawn mower repair in tallahassee florida","volume":110.0},{"keyword":"small engine repair tallahassee florida","volume":110.0},{"keyword":"lawn mower repair tallahassee fl","volume":110.0},{"keyword":"lawn mower repair tallahassee florida","volume":110.0},{"keyword":"lawn mower repair near me","volume":40.0},{"keyword":"lawn mower repair","volume":30.0},{"keyword":"mobile lawn mower repair tallahassee","volume":20.0},{"keyword":"mower repair tallahassee","volume":20.0},{"keyword":"generator repair tallahassee","volume":20.0},{"keyword":"small engine repair in tallahassee","volume":10.0},{"keyword":"small engine repair","volume":10.0},{"keyword":"lawnmower repair tallahassee","volume":10.0},{"keyword":"small machine repair","volume":10.0},{"keyword":"lawn mower service","volume":10.0},{"keyword":"riding mower repair","volume":10.0},{"keyword":"snow blower repair","volume":10.0},{"keyword":"mobile riding lawn mower repair","volume":10.0},{"keyword":"craftsman snowblower repair near me","volume":10.0},{"keyword":"riding lawn mower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"mower repair","volume":10.0},{"keyword":"craftsman lawn mower repair","volume":10.0}],"Tampa, FL":[{"keyword":"lawn mower repair tampa","volume":140.0},{"keyword":"lawn equipment repair tampa","volume":140.0},{"keyword":"lawn mower repair tampa fl","volume":140.0},{"keyword":"small engine repair tampa fl","volume":90.0},{"keyword":"small engine repair tampa","volume":90.0},{"keyword":"small engine repair","volume":70.0},{"keyword":"generator repair near me","volume":50.0},{"keyword":"electric generator repair near me","volume":50.0},{"keyword":"generator repair","volume":30.0},{"keyword":"mobile lawn mower repair tampa","volume":20.0},{"keyword":"small machine repair","volume":10.0},{"keyword":"lawn mower repair south tampa","volume":10.0},{"keyword":"lawnmower repair tampa","volume":10.0},{"keyword":"mower repair tampa","volume":10.0},{"keyword":"generator repair tampa","volume":10.0},{"keyword":"snow blower repair","volume":10.0},{"keyword":"generator repair tampa fl","volume":10.0},{"keyword":"portable generator repair tampa","volume":10.0},{"keyword":"toro snow blower repair near me","volume":10.0},{"keyword":"snow thrower repair","volume":10.0},{"keyword":"portable generator repair","volume":10.0},{"keyword":"snow machine repair","volume":10.0},{"keyword":"generac generator repair","volume":10.0},{"keyword":"snow blower repair at home","volume":10.0},{"keyword":"generator service and repair","volume":10.0}],"Fort Myers, FL":[{"keyword":"small engine repair fort myers","volume":50.0},{"keyword":"lawn mower repair fort myers","volume":50.0},{"keyword":"small engine repair fort myers florida","volume":50.0},{"keyword":"lawn mower repair fort myers fl","volume":30.0},{"keyword":"small engine repair","volume":30.0},{"keyword":"lawn mower repair","volume":20.0},{"keyword":"portable generator repair","volume":20.0},{"keyword":"lawn equipment repair","volume":20.0},{"keyword":"fort myers small engine repair","volume":10.0},{"keyword":"small engine repair ft myers","volume":10.0},{"keyword":"mower repair fort myers","volume":10.0},{"keyword":"lawn mower service","volume":10.0},{"keyword":"mobile lawn mower repair","volume":10.0},{"keyword":"riding mower repair","volume":10.0},{"keyword":"john deere lawn mower repair","volume":10.0},{"keyword":"mobile riding lawn mower repair","volume":10.0},{"keyword":"mower repair","volume":10.0},{"keyword":"snow blower repair","volume":10.0},{"keyword":"craftsman lawn mower repair","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0},{"keyword":"lawn mower service cost","volume":10.0},{"keyword":"snow thrower repair","volume":10.0},{"keyword":"lawn mower maintenance","volume":10.0},{"keyword":"snow blower repair near me mobile","volume":10.0},{"keyword":"lawn mower tire repair","volume":10.0}],"Miami, FL":[{"keyword":"lawn mower repair near me","volume":140.0},{"keyword":"lawn mower repair miami","volume":90.0},{"keyword":"lawn mower repair","volume":70.0},{"keyword":"mower repair near me","volume":70.0},{"keyword":"generator repair near me","volume":70.0},{"keyword":"fix generator near me","volume":70.0},{"keyword":"electric generator repair near me","volume":70.0},{"keyword":"repair generator near me","volume":70.0},{"keyword":"generator repair close to me","volume":70.0},{"keyword":"portable generator servicing","volume":50.0},{"keyword":"generator repair","volume":40.0},{"keyword":"electric generator repair","volume":40.0},{"keyword":"small engine repair","volume":30.0},{"keyword":"generac generator repair","volume":30.0},{"keyword":"generator service near me","volume":20.0},{"keyword":"generator maintenance near me","volume":20.0},{"keyword":"generator servicing","volume":20.0},{"keyword":"kohler generator repair","volume":20.0},{"keyword":"electric generator maintenance","volume":20.0},{"keyword":"small engine repair miami","volume":10.0},{"keyword":"small machine repair","volume":10.0},{"keyword":"mobile lawn mower repair","volume":10.0},{"keyword":"riding mower repair","volume":10.0},{"keyword":"mobile riding lawn mower repair","volume":10.0},{"keyword":"craftsman lawn mower repair","volume":10.0}],"West Palm Beach, FL":[{"keyword":"small engine repair west palm beach","volume":30.0},{"keyword":"lawn mower repair west palm beach","volume":30.0},{"keyword":"lawn mower repair","volume":30.0},{"keyword":"lawn equipment repair","volume":30.0},{"keyword":"lawn mower repair services","volume":20.0},{"keyword":"small engine repair","volume":10.0},{"keyword":"small repair engine","volume":10.0},{"keyword":"riding mower repair","volume":10.0},{"keyword":"small repair","volume":10.0},{"keyword":"mobile riding lawn mower repair","volume":10.0},{"keyword":"mower repair","volume":10.0},{"keyword":"craftsman lawn mower repair","volume":10.0},{"keyword":"lawn mower maintenance","volume":10.0},{"keyword":"electric lawn mower repair","volume":10.0},{"keyword":"local lawn mower repair","volume":10.0},{"keyword":"mobile mower repair","volume":10.0},{"keyword":"snow blower repair","volume":10.0},{"keyword":"john deere mower repair","volume":10.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"honda lawn mower repair","volume":10.0},{"keyword":"craftsman snowblower repair near me","volume":10.0},{"keyword":"lawn mower tune up","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"at home lawn mower repair","volume":10.0},{"keyword":"ariens snowblower repair","volume":10.0}]},"flMeta":{"Tallahassee, FL":[{"page":"Home","keyword":"","title":"Expert Lawn Mower Repair Tallahassee | Small Engine Solutions","description":"Expert lawn mower repair tallahassee with complete small engine repair for riding mowers, zero-turns & more better performance, better value. Contact us today to reserve service!"},{"page":"Our Services","keyword":"","title":"","description":""},{"page":"Snow Blower Repair","keyword":"","title":"","description":""},{"page":"Generator Repair","keyword":"","title":"","description":""},{"page":"About Us","keyword":"","title":"","description":""},{"page":"Contact Us","keyword":"","title":"","description":""},{"page":"https://bestbeachresortsinflorida.com/","keyword":"lawn mower repair tallahassee","title":"","description":""},{"page":"https://bestbeachresortsinflorida.com/about-us/","keyword":"mobile engine repairs","title":"","description":""},{"page":"https://bestbeachresortsinflorida.com/our-services/","keyword":"","title":"","description":""},{"page":"https://bestbeachresortsinflorida.com/pricing/","keyword":"","title":"","description":""},{"page":"https://bestbeachresortsinflorida.com/contact-us/","keyword":"mobile mower repairs","title":"","description":""},{"page":"https://bestbeachresortsinflorida.com/blog/","keyword":"","title":"","description":""},{"page":"https://bestbeachresortsinflorida.com/small-engine-repair/","keyword":"small engine repair tallahassee","title":"","description":""},{"page":"https://bestbeachresortsinflorida.com/generator-repair/","keyword":"generator repair tallahassee","title":"","description":""},{"page":"https://bestbeachresortsinflorida.com/snow-blower-repair/","keyword":"snow blower repair tallahassee","title":"","description":""}],"Tampa, FL":[{"page":"Home","keyword":"lawn mower repair tampa","title":"Reliable Lawn Mower Repair Tampa | Small Engine Techs","description":"Reliable lawn mower repair tampa backed by real small engine repair technicians, honest work & fast turnaround for outdoor power equipment. Book your repair now  don\u2019t wait!"},{"page":"Our Services","keyword":"small engine repair tampa fl","title":"","description":""},{"page":"Snow Blower Repair","keyword":"snow blower repair tampa","title":"","description":""},{"page":"Generator Repair","keyword":"generator repair tampa","title":"","description":""},{"page":"About Us","keyword":"mobile engine repairs","title":"","description":""},{"page":"Contact Us","keyword":"mobile mower repairs","title":"","description":""}],"Fort Myers, FL":[{"page":"https://lawnmowerrepairfortmyersfl.com/","keyword":"lawn mower repair fort myers","title":"Top Lawn Mower Repair Fort Myers Experts | Call Today","description":"Looking for lawn mower repair Fort Myers that\u2019s fast, honest, and hassle-free? Our techs fix all mowers. Call us today for smooth repairs!"},{"page":"https://lawnmowerrepairfortmyersfl.com/our-services/","keyword":"mower and engine services","title":"Fort Myers Mower & Engine Services | Explore All","description":"From tune-ups to full fixes, our Fort Myers mower and engine services cover everything you need. Explore Quick with mobile services now!"},{"page":"https://lawnmowerrepairfortmyersfl.com/small-engine-repair/","keyword":"small engine repair fort myers","title":"Small Engine Repair Fort Myers Pros | Book Fast","description":"Need small engine repair Fort Myers? We revive blowers, trimmers, generators & more with speedy support. Book fast and get your equipment running again!"},{"page":"https://lawnmowerrepairfortmyersfl.com/snow-blower-repair/","keyword":"snow blower repair fort myers","title":"Snow Blower Repair Fort Myers | Beat the Rush","description":"Get fast snow blower repair Fort Myers before issues get worse. Skilled techs, quick reliable fixes. Act now and secure your snow blower\u2019s performance!"},{"page":"https://lawnmowerrepairfortmyersfl.com/generator-repair/","keyword":"generator repair fort myers","title":"Power Up Generator Repair Fort Myers | Call Us","description":"Need generator repair Fort Myers? Power up your system with expert troubleshooting and fast repairs. Stay prepared and call us today to schedule service!"},{"page":"https://lawnmowerrepairfortmyersfl.com/about-us/","keyword":"mobile engine repairs","title":"Discover Reliable Mobile Engine Repairs | Meet us","description":"Learn about our trusted mobile engine repairs team that delivers quick, friendly service across Fort Myers. Meet our team and get started today!"},{"page":"https://lawnmowerrepairfortmyersfl.com/contact-us/","keyword":"mobile mower repairs","title":"Get Ready for Mobile Mower Repairs | Fort Myers","description":"Need mobile mower repairs in Fort Myers? Get ready for fast, convenient service right at your location. Contact us today to schedule!"}],"Miami, FL":[{"page":"https://lawnmowerrepairmiamifl.com/","keyword":"lawn mower repair miami","title":"#1 Trusted Lawn Mower Repair Miami Services | Book Today","description":"Explore our full range of mower and small engine services in Miami. From repairs to maintenance, we handle all affordably. Contact us now to book service!"},{"page":"https://lawnmowerrepairmiamifl.com/our-services/","keyword":"Mower & Engine Services","title":"Trusted Lawn Mower & Engine Services Miami | Get Started","description":"Explore our full range of mower and small engine services in Miami. From repairs to maintenance, we handle it all quickly and affordably!"},{"page":"https://lawnmowerrepairmiamifl.com/small-engine-repair/","keyword":"small engine repair miami","title":"Reliable Small Engine Repair Miami Experts | Call us","description":"Get reliable small engine repair Miami. We fix blowers, trimmers, generators, and more with fast mobile service. Call now to book your repair today!"},{"page":"https://lawnmowerrepairmiamifl.com/snow-blower-repair/","keyword":"snow blower repair miami","title":"Fast Snow Blower Repair Miami Technicians | Book Now","description":"Need quick snow blower repair Miami service? We fix all models with expert diagnostics and on-site repairs. Stay ready for winter, call now to book service!"},{"page":"https://lawnmowerrepairmiamifl.com/generator-repair/","keyword":"generator repair miami","title":"Expert Generator Repair Miami Service | Call Now","description":"Get expert generator repair Miami for homeowners trust. We repair portable and standby units fast. Keep your power ready call today to book repair service!"},{"page":"https://lawnmowerrepairmiamifl.com/about-us/","keyword":"mobile engine repairs","title":"Trusted Mobile Engine Repairs Team in Miami","description":"Learn about our trusted mobile engine repairs service providing fast fixes for mowers and small engines. Discover our story contact us today to get started!"},{"page":"https://lawnmowerrepairmiamifl.com/contact-us/","keyword":"mobile mower repairs","title":"Quick Mobile Mower Repairs Miami | Contact Us","description":"Need mobile mower repairs in Miami? Reach out for on-site service at your home. We repair all mower types affordably. Contact us to book your repair today!"}],"West Palm Beach, FL":[{"page":"https://lawnmowerrepairwestpalmbeach.com/","keyword":"lawn mower repair west palm beach","title":"Smart and Reliable Lawn Mower Repair West Palm Beach | Try Us","description":"Need lawn mower repair West Palm Beach? Enjoy reliable service for every mower type. We come to you with expert care. Reach out now for hassle-free repair!"},{"page":"https://lawnmowerrepairwestpalmbeach.com/our-services/","keyword":"mower and engine services","title":"Complete Lawn Mower & Engine Services WPB","description":"Explore our complete range of mower and engine services in West Palm Beach. From tune-ups to full repairs, we cover all with care."},{"page":"https://lawnmowerrepairwestpalmbeach.com/small-engine-repair","keyword":"small engine repair west palm beach","title":"Small Engine Repair West Palm Beach Service | Book Now","description":"Looking for small engine repair West Palm Beach? We fix blowers, trimmers, generators and more with precise diagnostics. Book your repair service today!"},{"page":"https://lawnmowerrepairwestpalmbeach.com/snow-blower-repair/","keyword":"snow blower repair west palm beach","title":"Snow Blower Repair West Palm Beach Pros | Schedule","description":"For snow blower repair West Palm Beach residents trust, choose our skilled technicians. Fast and affordable service. Schedule your winter-ready repair today!"},{"page":"https://lawnmowerrepairwestpalmbeach.com/generator-repair/","keyword":"generator repair west palm beach","title":"Trusted Generator Repair West Palm Beach | Call Us","description":"Get generator repair West Palm Beach done right. We serve portable units with expert precision. Keep your power secure call us today for fast repair service!"},{"page":"https://lawnmowerrepairwestpalmbeach.com/about-us/","keyword":"mobile engine repairs","title":"Your Local Mobile Engine Repairs Team WPB | Know","description":"Learn about our mobile engine repairs service trusted across West Palm Beach. Skilled techs, and honest pricing. Get to know our team and mission today!"},{"page":"https://lawnmowerrepairwestpalmbeach.com/contact-us/","keyword":"mobile mower repairs","title":"Affordable Mobile Mower Repairs WPB | Reach Us","description":"Need mobile mower repairs in West Palm Beach? Get friendly on-site service when you need it most. Reach us today and let our experts fix your mower easily!"}]},"realAddresses":{"known":[{"city":"Sioux Falls, SD","area":"","keywords":"","role":"","notes":""},{"city":"Lee's Summit, MO","area":"","keywords":"","role":"","notes":""},{"city":"Cape Coral, Fl","area":"","keywords":"","role":"","notes":""},{"city":"Reno, Nevada","area":"","keywords":"","role":"","notes":""}],"hidden":[{"city":"Tallahassee, FL","area":"","keywords":"","role":"","notes":""},{"city":"","area":"Tallahassee, FL","keywords":"small engine repair Tallahassee","role":"Primary Verified Location","notes":"Verified around central/west Tallahassee region"},{"city":"","area":"Boykin, FL (nearby)","keywords":"mobile lawn mower repair Boykin","role":"Edge Visibility","notes":"Slight reach beyond city boundary"},{"city":"","area":"Leon County, FL","keywords":"lawn mower repair Tallahassee FL","role":"Regional Expansion","notes":"Extends coverage across county"},{"city":"Brownsville, TX","area":"","keywords":"","role":"","notes":""},{"city":"","area":"Brownsville, TX","keywords":"lawn mower repair Brownsville TX","role":"Primary Verified Location","notes":"Verified around Brownsville city center / Los Fresnos corridor"},{"city":"","area":"Los Fresnos, TX","keywords":"lawn mower repair Los Fresnos TX","role":"Edge Visibility (East)","notes":"Expands reach toward Los Fresnos region"},{"city":"","area":"Castroville, TX","keywords":"small engine repair near Castroville TX","role":"Irrelevant / Outlier","notes":"Random long-tail \u2014 not part of your core radius"},{"city":"Lapeer, MI","area":"","keywords":"","role":"","notes":""},{"city":"","area":"Lapeer, MI","keywords":"lawn mower repair Lapeer","role":"Primary Verified Area","notes":"Verified around Lapeer\u2013Marlette corridor (east-central Michigan)"},{"city":"","area":"Marlette, MI","keywords":"generator repair Marlette Michigan","role":"Supporting Zone","notes":"Confirms reach north of Lapeer"},{"city":"","area":"Croswell, MI","keywords":"small engine repair Croswell Michigan","role":"Edge Visibility (East)","notes":"Expands presence toward Croswell region"},{"city":"","area":"Port Huron, MI","keywords":"small engine repair Port Huron","role":"Extended Radius (Far East)","notes":"Low impressions but within visibility range"},{"city":"","area":"Bad Axe, MI","keywords":"used small engine repair in Bad Axe MI","role":"Outlier / Weak Reach","notes":"Very distant \u2014 minimal impact"},{"city":"Sioux Falls, SD","area":"","keywords":"","role":"","notes":""},{"city":"","area":"Sioux Falls, SD","keywords":"small engine repair Sioux Falls","role":"Primary Verified Area","notes":"Verified around central Sioux Falls / Dell Rapids corridor"},{"city":"","area":"Dell Rapids, SD","keywords":"Dell Rapids small engine repair","role":"Edge Visibility (North)","notes":"Extends ranking reach toward Dell Rapids"},{"city":"","area":"Brandon, SD","keywords":"small engine repair Brandon SD","role":"Secondary Reach (East)","notes":"Covers eastern edge suburbs of Sioux Falls"},{"city":"","area":"General Keywords","keywords":"lawn mower repair near me, generator repair near me, small engine repair near me","role":"Core Service Signals","notes":"Indicates dominant visibility for \u201cnear me\u201d queries around Sioux Falls"},{"city":"GBP Adresses","area":"","keywords":"","role":"","notes":""},{"city":"Houston, TX","area":"","keywords":"","role":"","notes":""},{"city":"","area":"Houston, TX","keywords":"lawn mower repair houston","role":"Primary Verified Area","notes":"Verified around Hempstead Rd / Garden Oaks / Stafford region"},{"city":"","area":"Hempstead Rd","keywords":"lawn mower repair on Hempstead Rd Houston","role":"Supporting Zone","notes":"Indicates northwest Houston coverage"},{"city":"","area":"Garden Oaks","keywords":"lawn mower repair Garden Oaks TX","role":"Supporting Neighborhood","notes":"Confirms NW Houston proximity"},{"city":"","area":"Stafford","keywords":"lawn mower repair Stafford TX","role":"Edge Visibility","notes":"Extends reach toward southwest Houston"},{"city":"","area":"Cypress","keywords":"mobile lawn mower repair Cypress TX","role":"Optional Expansion","notes":"Expands west-side radius beyond main centroid"},{"city":"","area":"Katy","keywords":"lawn mower repair Katy TX","role":"Secondary City","notes":"Farther expansion area with weaker ranking weight"},{"city":"Crawfordsville, IN","area":"","keywords":"","role":"","notes":""},{"city":"","area":"Crawfordsville, IN","keywords":"lawn mower repair Crawfordsville Indiana","role":"Primary Verified Location","notes":"Verified around Crawfordsville city center / I-74 corridor west of Indianapolis"},{"city":"","area":"Hendricks County, IN","keywords":"mower repair in Hendricks County Indiana","role":"Regional Expansion","notes":"Strengthens relevance across west-central Indiana"},{"city":"","area":"Greenfield, IN","keywords":"mobile lawn mower repair companies Greenfield Indiana","role":"Secondary Reach (East)","notes":"Extends visibility toward eastern Indiana"},{"city":"","area":"Indianapolis West Suburbs","keywords":"small engine repair near me","role":"Broader Metro Coverage","notes":"Helps capture searches from west Indy area"},{"city":"Sarasota, FL","area":"","keywords":"","role":"","notes":""},{"city":"","area":"Sarasota, FL","keywords":"small engine repair Sarasota","role":"Primary Verified Location","notes":"Verified around central Sarasota / Ashton Rd \u2013 Gulf Gate Estates region"},{"city":"","area":"Bradenton, FL","keywords":"small engine repair Bradenton","role":"Secondary Reach (North)","notes":"Expands coverage toward north Sarasota County"},{"city":"","area":"Lakewood Ranch, FL","keywords":"generator maintenance Lakewood Ranch FL","role":"Service Reach (East)","notes":"Extends visibility eastward"},{"city":"","area":"Longboat Key, FL","keywords":"generator maintenance Longboat Key FL","role":"Edge Visibility (West)","notes":"Signals ranking reach into coastal areas"},{"city":"","area":"Ruskin, FL","keywords":"mobile lawn mower repair in Ruskin FL","role":"Extended Radius (Far North)","notes":"Distant, low-volume reach area"},{"city":"","area":"Gulf Gate Estates, FL","keywords":"places to fix generator off Ashton Rd Sarasota FL","role":"Local Micro-Area","notes":"Confirms centroid proximity within Sarasota"}]},"savedKeywords":[{"keyword":"fix lawn mower near me","avgMonthly":74000.0},{"keyword":"lawn equipment repair near me","avgMonthly":74000.0},{"keyword":"lawn mower service near me","avgMonthly":60500.0},{"keyword":"lawn equipment repair","avgMonthly":33100.0},{"keyword":"lawn mower repair","avgMonthly":33100.0},{"keyword":"mower repair near me","avgMonthly":18100.0},{"keyword":"mobile lawn mower repair near me","avgMonthly":5400.0},{"keyword":"mower repair","avgMonthly":4400.0},{"keyword":"lawn mower maintenance","avgMonthly":3600.0},{"keyword":"mobile lawn mower repair","avgMonthly":3600.0},{"keyword":"riding lawn mower repair near me","avgMonthly":3600.0},{"keyword":"riding lawn mower repair","avgMonthly":2400.0},{"keyword":"riding mower repair","avgMonthly":2400.0},{"keyword":"lawn mower mechanic","avgMonthly":1900.0},{"keyword":"lawn tractor repair near me","avgMonthly":1900.0},{"keyword":"cheap lawn mower service near me","avgMonthly":1600.0},{"keyword":"honda lawn mower repair near me","avgMonthly":1600.0},{"keyword":"lawn mower tune up near me","avgMonthly":1600.0},{"keyword":"lawn mower tune up","avgMonthly":1300.0},{"keyword":"mobile mower repair","avgMonthly":1300.0},{"keyword":"electric lawn mower repair","avgMonthly":880.0},{"keyword":"craftsman lawn mower repair","avgMonthly":720.0},{"keyword":"craftsman mower repair","avgMonthly":720.0},{"keyword":"electric lawn mower repair near me","avgMonthly":720.0},{"keyword":"honda lawn mower repair","avgMonthly":720.0},{"keyword":"zero turn mower repair near me","avgMonthly":720.0},{"keyword":"zero turn repair near me","avgMonthly":720.0},{"keyword":"craftsman lawn mower repair near me","avgMonthly":590.0},{"keyword":"john deere lawn mower repair","avgMonthly":590.0},{"keyword":"lawn tractor repair","avgMonthly":590.0},{"keyword":"mobile lawn mower service","avgMonthly":590.0},{"keyword":"mobile lawn mower service near me","avgMonthly":590.0},{"keyword":"local lawn mower repair","avgMonthly":480.0},{"keyword":"at home lawn mower repair","avgMonthly":390.0},{"keyword":"craftsman riding mower repair","avgMonthly":390.0},{"keyword":"honda lawn mower service near me","avgMonthly":390.0},{"keyword":"honda lawnmower repair near me","avgMonthly":390.0},{"keyword":"husqvarna lawn mower repair","avgMonthly":390.0},{"keyword":"mower service","avgMonthly":390.0},{"keyword":"electric mower repair near me","avgMonthly":260.0},{"keyword":"fix lawn mower","avgMonthly":260.0},{"keyword":"riding lawn mower service near me","avgMonthly":260.0},{"keyword":"mobile riding lawn mower repair","avgMonthly":170.0},{"keyword":"at home lawn mower repair near me","avgMonthly":110.0},{"keyword":"grass mower service near me","avgMonthly":50.0},{"keyword":"local lawn mower service","avgMonthly":40.0},{"keyword":"riding mower repair at my home","avgMonthly":30.0}],"offPageTracker":[{"city":"Sioux Falls, SD","email":"masonwhite0960@gmail.com"},{"city":"Lapeer, MI","email":"parkerjames20045@gmail.com"},{"city":"Lee's Summit, MO","email":"jameswalker128918@gmail.com"},{"city":"Sioux Falls, SD ( 2)","email":"Emilycarter7812@gmail.com"},{"city":"Houston, TX","email":"loganmitchell1290@gmail.com"},{"city":"Crawfordsville, IN","email":"ethanparker1841@gmail.com"},{"city":"Sarasota, FL","email":"oliviamartinez4160@gmail.com"},{"city":"Tallahassee, FL","email":"avathompson1020@gmail.com"},{"city":"Cape Coral, Fl","email":"Benjaminscott1087@gmail.com"},{"city":"Brownsville, TX","email":"noahjohnson2169@gmail.com"},{"city":"Reno, Nevada","email":""}],"flOffPageStatus":[{"city":"Fort Myers","status":"File"},{"city":"Miami","status":"File"},{"city":"Tampa","status":"File"},{"city":"Tallahassee","status":"File"},{"city":"West Palm Beach","status":"File"}],"snowBlowerKeywords":{"Sioux Falls, SD":[{"keyword":"snow blower repair","volume":10.0},{"keyword":"snow blower repair near me","volume":10.0},{"keyword":"mobile snowblower repair near me","volume":10.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"toro snowblower repair near me","volume":10.0},{"keyword":"snowblower pickup and repair near me","volume":10.0},{"keyword":"craftsman snowblower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snowblower tune up near me","volume":10.0},{"keyword":"snow blower repairs near me","volume":10.0},{"keyword":"snow thrower repair near me","volume":10.0},{"keyword":"snow blower repair pick up","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"snowblower repair shops","volume":10.0},{"keyword":"ariens snowblower repair near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"toro snow blower repair near me","volume":10.0},{"keyword":"ace hardware snow blower repair","volume":10.0}],"Syracuse, NY":[{"keyword":"snow blower repair near me","volume":110.0},{"keyword":"snow blower repair","volume":40.0},{"keyword":"snow thrower repair","volume":30.0},{"keyword":"fix snow blower","volume":30.0},{"keyword":"mobile snowblower repair","volume":20.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"snow blower repairs","volume":10.0},{"keyword":"mobile snow blower repair","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"in home snow blower repair near me","volume":10.0},{"keyword":"toro snowblower repair","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0},{"keyword":"on site snow blower repair","volume":10.0},{"keyword":"snow blower repair near me mobile","volume":10.0},{"keyword":"at home snow blower repair","volume":10.0},{"keyword":"snow machine repair","volume":10.0},{"keyword":"home snow blower repair","volume":10.0},{"keyword":"snowblower repair in my area","volume":10.0},{"keyword":"snow blower tire repair","volume":10.0}],"Buffalo, NY":[{"keyword":"snow blower repair near me","volume":110.0},{"keyword":"snow blower repair","volume":20.0},{"keyword":"snowblower pickup and repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"snow blower repairs","volume":10.0},{"keyword":"mobile snow blower repair","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"repair snowblower near me","volume":10.0},{"keyword":"toro snowblower repair","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0},{"keyword":"home depot snow blower repair","volume":10.0},{"keyword":"snowblower tune up","volume":10.0},{"keyword":"ariens snowblower repair","volume":10.0},{"keyword":"snow thrower repair","volume":10.0},{"keyword":"craftsman snowblower carburetor replacement","volume":10.0},{"keyword":"on site snow blower repair","volume":10.0},{"keyword":"snow blower repair near me mobile","volume":10.0},{"keyword":"snow blower repair at your home","volume":10.0},{"keyword":"at home snow blower repair","volume":10.0}],"Rochester, NY":[{"keyword":"snow blower repair","volume":30.0},{"keyword":"on site snow blower repair","volume":10.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"in home snowblower repair near me","volume":10.0},{"keyword":"snowblower pickup and repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snow blower repair pick up","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"repair snowblower near me","volume":10.0},{"keyword":"fix snowblower near me","volume":10.0},{"keyword":"toro snowblower repair","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0},{"keyword":"troy bilt snow blower repair near me","volume":10.0},{"keyword":"ariens snowblower repair","volume":10.0},{"keyword":"snow thrower repair","volume":10.0},{"keyword":"snowblower repair near me pick up","volume":10.0},{"keyword":"craftsman snowblower carburetor replacement","volume":10.0},{"keyword":"snow blower repair near me mobile","volume":10.0}],"Albany, NY":[{"keyword":"snow blower repair","volume":10.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snowblower tune up near me","volume":10.0},{"keyword":"snow thrower repair near me","volume":10.0},{"keyword":"snow blower repair pick up","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"mobile snow blower repair","volume":10.0},{"keyword":"mobile snow blower repair near me","volume":10.0},{"keyword":"toro snowblower repair","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0},{"keyword":"home depot snow blower repair","volume":10.0},{"keyword":"troy bilt snow blower repair near me","volume":10.0},{"keyword":"snowblower tune up","volume":10.0},{"keyword":"ariens snowblower repair","volume":10.0},{"keyword":"snow thrower repair","volume":10.0},{"keyword":"snowblower repair near me pick up","volume":10.0}],"Burlington, VT":[{"keyword":"snow blower repair","volume":10.0},{"keyword":"craftsman snowblower repair near me","volume":10.0},{"keyword":"snow blower fix near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"repair snowblower near me","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0},{"keyword":"troy bilt snow blower repair near me","volume":10.0},{"keyword":"snowblower tune up","volume":10.0},{"keyword":"snow thrower repair","volume":10.0},{"keyword":"craftsman snowblower carburetor replacement","volume":10.0},{"keyword":"craftsman snow blower repair near me","volume":10.0},{"keyword":"fix snow blower","volume":10.0},{"keyword":"husqvarna snow blower repair near me","volume":10.0},{"keyword":"fix my snowblower near me","volume":10.0},{"keyword":"craftsman snowblower chute cable replacement","volume":10.0},{"keyword":"ace hardware snowblower repair","volume":10.0},{"keyword":"snowblower repair home service","volume":10.0}],"Chicago, IL":[{"keyword":"snow blower repair","volume":10.0},{"keyword":"snow blower repair near me","volume":10.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"in home snowblower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snow blower repair pick up","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"snow blower repairs","volume":10.0},{"keyword":"mobile snow blower repair","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"toro snowblower repair","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0},{"keyword":"snowblower tune up","volume":10.0},{"keyword":"snow blower mechanic near me","volume":10.0},{"keyword":"snow blower services","volume":10.0},{"keyword":"snow thrower repair","volume":10.0},{"keyword":"snowblower repair near me pick up","volume":10.0},{"keyword":"craftsman snowblower carburetor replacement","volume":10.0},{"keyword":"on site snow blower repair","volume":10.0},{"keyword":"snow blower repair near me mobile","volume":10.0}],"Cleveland, OH":[{"keyword":"snow blower repair near me","volume":140.0},{"keyword":"Snow Blower Repair","volume":50.0},{"keyword":"snow thrower repair","volume":30.0},{"keyword":"mobile snowblower repair near me","volume":10.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"toro snowblower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snow blower repairs near me","volume":10.0},{"keyword":"snow blower repair pick up","volume":10.0},{"keyword":"snow blower fix near me","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"snow blower repairs","volume":10.0},{"keyword":"mobile snow blower repair","volume":10.0},{"keyword":"toro snow blower repair near me","volume":10.0},{"keyword":"repair snowblower near me","volume":10.0},{"keyword":"fix snowblower near me","volume":10.0},{"keyword":"snowblower repair pickup near me","volume":10.0},{"keyword":"ace hardware snow blower repair","volume":10.0}],"Detroit, MI":[{"keyword":"snow blower repair near me","volume":70.0},{"keyword":"snow blower repair","volume":20.0},{"keyword":"snow thrower repair","volume":20.0},{"keyword":"mobile snowblower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snowblower tune up near me","volume":10.0},{"keyword":"snow blower repair pick up","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"ariens snowblower repair near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"arien snowblower repair near me","volume":10.0},{"keyword":"ace snow blower repair","volume":10.0},{"keyword":"ace hardware snow blower tune up","volume":10.0},{"keyword":"2 stage snow blower maintenance","volume":10.0},{"keyword":"honda snow blower repair near me","volume":10.0},{"keyword":"snowblower fix near me","volume":10.0},{"keyword":"snowblower repair home service","volume":10.0},{"keyword":"electric snow blower repair","volume":10.0},{"keyword":"ace hardware snowblower repair","volume":10.0}],"Minneapolis, MN":[{"keyword":"snow blower repair near me","volume":110.0},{"keyword":"snow blower repair","volume":40.0},{"keyword":"snow thrower repair","volume":40.0},{"keyword":"fix snow blower","volume":40.0},{"keyword":"ariens snow blower auger repair","volume":10.0},{"keyword":"ariens deluxe 24 maintenance","volume":10.0},{"keyword":"ariens compact 24 maintenance","volume":10.0},{"keyword":"ariens compact 24 carburetor replacement","volume":10.0},{"keyword":"arien snowblower repair near me","volume":10.0},{"keyword":"ace snow blower repair","volume":10.0},{"keyword":"ace hardware snow blower tune up","volume":10.0},{"keyword":"2 stage snow blower maintenance","volume":10.0},{"keyword":"honda snow blower repair near me","volume":10.0},{"keyword":"snowblower fix near me","volume":10.0},{"keyword":"snowblower repair home service","volume":10.0},{"keyword":"electric snow blower repair","volume":10.0},{"keyword":"snowblower gearbox replacement","volume":10.0},{"keyword":"snow blower repair at home","volume":10.0},{"keyword":"ace hardware snowblower repair","volume":10.0},{"keyword":"snow blower machine repair near me","volume":10.0}],"Green Bay, WI":[{"keyword":"snow blower fix near me","volume":20.0},{"keyword":"snow blower repair","volume":10.0},{"keyword":"home service snowblower repair","volume":10.0},{"keyword":"snowblower gearbox replacement","volume":10.0},{"keyword":"snowblower repair home service","volume":10.0},{"keyword":"ariens compact 24 maintenance","volume":10.0},{"keyword":"snow blower repair near me","volume":10.0},{"keyword":"mobile snowblower repair near me","volume":10.0},{"keyword":"toro snowblower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snowblower tune up near me","volume":10.0},{"keyword":"snow thrower repair near me","volume":10.0},{"keyword":"snow blower repair pick up","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"snowblower repair shops","volume":10.0},{"keyword":"ariens snowblower repair near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"snow blower repairs","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0}],"Denver, CO":[{"keyword":"snow blower repair near me","volume":40.0},{"keyword":"snow blower repair","volume":10.0},{"keyword":"ace hardware snow blower repair","volume":10.0},{"keyword":"mobile snowblower repair near me","volume":10.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"in home snowblower repair near me","volume":10.0},{"keyword":"toro snowblower repair near me","volume":10.0},{"keyword":"snowblower pickup and repair near me","volume":10.0},{"keyword":"craftsman snowblower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snowblower tune up near me","volume":10.0},{"keyword":"snow blower repairs near me","volume":10.0},{"keyword":"snow thrower repair near me","volume":10.0},{"keyword":"snow blower fix near me","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"snowblower repair shops","volume":10.0},{"keyword":"ariens snowblower repair near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0}],"Salt Lake City, UT":[{"keyword":"snow blower repair","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0},{"keyword":"snow blower repair near me","volume":10.0},{"keyword":"mobile snowblower repair near me","volume":10.0},{"keyword":"toro snowblower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snow thrower repair near me","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snowblower repair shops","volume":10.0},{"keyword":"ariens snowblower repair near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"in home snow blower repair near me","volume":10.0},{"keyword":"snow blower repairs","volume":10.0},{"keyword":"mobile snow blower repair","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"toro snow blower repair near me","volume":10.0},{"keyword":"repair snowblower near me","volume":10.0},{"keyword":"mobile snow blower repair near me","volume":10.0},{"keyword":"toro snowblower repair","volume":10.0},{"keyword":"snowblower repair shop near me","volume":10.0}],"Anchorage, AK":[{"keyword":"snow blower repair","volume":10.0},{"keyword":"snow blower repair near me","volume":10.0},{"keyword":"toro snowblower repair near me","volume":10.0},{"keyword":"craftsman snowblower repair near me","volume":10.0},{"keyword":"snow blower repairs near me","volume":10.0},{"keyword":"snowblower tune up near me","volume":10.0},{"keyword":"snow thrower repair near me","volume":10.0},{"keyword":"snow blower fix near me","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"snowblower repair shops","volume":10.0},{"keyword":"ariens snowblower repair near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"snow blower repairs","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"repair snowblower near me","volume":10.0},{"keyword":"toro snowblower repair","volume":10.0},{"keyword":"snowblower repair shop near me","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0},{"keyword":"snowblower tire repair near me","volume":10.0}],"Fairbanks, AK":[{"keyword":"snow blower repair near me","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"snowblower tune up","volume":10.0},{"keyword":"snowblower tire repair near me","volume":10.0},{"keyword":"snow blower mechanic near me","volume":10.0},{"keyword":"ariens snowblower repair","volume":10.0},{"keyword":"snowblower repair shop near me","volume":10.0},{"keyword":"craftsman snowblower carburetor replacement","volume":10.0},{"keyword":"fix snow blower","volume":10.0},{"keyword":"snow machine repair","volume":10.0},{"keyword":"craftsman snowblower wheel replacement","volume":10.0},{"keyword":"ariens snowblower tire replacement","volume":10.0},{"keyword":"snow blower tire repair","volume":10.0},{"keyword":"snow machine repair near me","volume":10.0},{"keyword":"husqvarna st224 impeller replacement","volume":10.0},{"keyword":"ariens snow blower auger repair","volume":10.0},{"keyword":"ariens compact 24 carburetor replacement","volume":10.0}],"Kansas City, MO":[{"keyword":"toro snowblower gearbox repair","volume":20.0},{"keyword":"snow blower repair","volume":10.0},{"keyword":"home service snowblower repair","volume":10.0},{"keyword":"fixing snow blower near me","volume":10.0},{"keyword":"snowblower gearbox replacement","volume":10.0},{"keyword":"snowblower repair home service","volume":10.0},{"keyword":"snowblower fix near me","volume":10.0},{"keyword":"ace hardware snow blower tune up","volume":10.0},{"keyword":"ace snow blower repair","volume":10.0},{"keyword":"ariens compact 24 maintenance","volume":10.0},{"keyword":"ariens deluxe 24 maintenance","volume":10.0},{"keyword":"snow blower repair near me","volume":10.0},{"keyword":"mobile snowblower repair near me","volume":10.0},{"keyword":"toro snowblower repair near me","volume":10.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"snowblower pickup and repair near me","volume":10.0},{"keyword":"craftsman snowblower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snowblower tune up near me","volume":10.0},{"keyword":"snow blower fix near me","volume":10.0}],"Colorado Springs, CO,":[{"keyword":"snow blower repair near me","volume":20.0},{"keyword":"snow blower repair","volume":10.0},{"keyword":"blower repair near me","volume":10.0},{"keyword":"mobile snowblower repair near me","volume":10.0},{"keyword":"toro snowblower repair near me","volume":10.0},{"keyword":"craftsman snowblower repair near me","volume":10.0},{"keyword":"snowblower tune up near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snow thrower repair near me","volume":10.0},{"keyword":"snow blower repair pick up","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower fix near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"snowblower repair shops","volume":10.0},{"keyword":"ariens snowblower repair near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"snow blower repairs","volume":10.0},{"keyword":"mobile snow blower repair","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"toro snow blower repair near me","volume":10.0}],"Erie, PA":[{"keyword":"snow blower repair near me","volume":50.0},{"keyword":"snow blower repair","volume":10.0},{"keyword":"in home snowblower repair near me","volume":10.0},{"keyword":"craftsman snowblower repair near me","volume":10.0},{"keyword":"mobile snowblower repair","volume":10.0},{"keyword":"snowblower tune up near me","volume":10.0},{"keyword":"snow blower repairs near me","volume":10.0},{"keyword":"snow blower fix near me","volume":10.0},{"keyword":"snow blower maintenance near me","volume":10.0},{"keyword":"snow blower repair service near me","volume":10.0},{"keyword":"snowblower repair shops","volume":10.0},{"keyword":"ariens snowblower repair near me","volume":10.0},{"keyword":"snow blower maintenance","volume":10.0},{"keyword":"in home snow blower repair near me","volume":10.0},{"keyword":"craftsman snowblower repair","volume":10.0},{"keyword":"repair snowblower near me","volume":10.0},{"keyword":"fix snowblower near me","volume":10.0},{"keyword":"toro snowblower repair","volume":10.0},{"keyword":"snowblower repair shop near me","volume":10.0},{"keyword":"sears snowblower repair","volume":10.0}]},"snowBlowerSeason":[{"city":"Syracuse, NY","snowStarts":"Late October \u2013 Early November"},{"city":"Buffalo, NY","snowStarts":"Late October \u2013 Early November"},{"city":"Rochester, NY","snowStarts":"Late October \u2013 Early November"},{"city":"Albany, NY","snowStarts":"Early November"},{"city":"Burlington, VT","snowStarts":"Late October \u2013 Early November"},{"city":"Chicago, IL","snowStarts":"Mid\u2013Late November"},{"city":"Cleveland, OH","snowStarts":"Mid\u2013Late November"},{"city":"Detroit, MI","snowStarts":"Mid\u2013Late November"},{"city":"Minneapolis, MN","snowStarts":"Late October"},{"city":"Green Bay, WI","snowStarts":"Late October \u2013 Early November"},{"city":"Denver, CO","snowStarts":"October (can be as early as Sept!)"},{"city":"Salt Lake City, UT","snowStarts":"Late October \u2013 Early November"},{"city":"Bozeman, MT","snowStarts":"October"},{"city":"Anchorage, AK","snowStarts":"Early\u2013Mid October"},{"city":"Fairbanks, AK","snowStarts":"Late September \u2013 Early October"},{"city":"Kansas City, MO","snowStarts":"Mid to Late November"},{"city":"Colorado Springs, CO","snowStarts":"Late October \u2013 Early November"},{"city":"Sioux Falls, SD","snowStarts":"Late October"},{"city":"Boise, ID","snowStarts":"Late November"},{"city":"Erie, PA","snowStarts":"Early November"}],"miamiKeywords":[{"keyword":"lawn mower shop near me","avgMonthly":320.0},{"keyword":"cheap lawn mower service near me","avgMonthly":320.0},{"keyword":"mower shop near me","avgMonthly":320.0},{"keyword":"mobile lawn mower repair","avgMonthly":320.0},{"keyword":"craftsman lawn mower repair near me","avgMonthly":320.0},{"keyword":"lawn mower repair shop near me","avgMonthly":320.0},{"keyword":"lawn mower repair","avgMonthly":90.0},{"keyword":"lawn mower repair near me","avgMonthly":90.0},{"keyword":"lawn mower service near me","avgMonthly":90.0},{"keyword":"lawn mower service","avgMonthly":50.0},{"keyword":"mower repair near me","avgMonthly":50.0},{"keyword":"mobile lawn mower repair near me","avgMonthly":40.0},{"keyword":"mower service near me","avgMonthly":30.0},{"keyword":"lawn mower repair shop","avgMonthly":30.0},{"keyword":"at home lawn mower repair near me","avgMonthly":30.0},{"keyword":"riding mower repair","avgMonthly":30.0},{"keyword":"honda lawn mower repair near me","avgMonthly":20.0},{"keyword":"lawn tractor repair near me","avgMonthly":20.0},{"keyword":"john deere lawn mower repair","avgMonthly":20.0},{"keyword":"electric lawn mower repair near me","avgMonthly":20.0},{"keyword":"lawn mower tune up near me","avgMonthly":20.0},{"keyword":"lawn equipment repair near me","avgMonthly":20.0},{"keyword":"fix lawn mower near me","avgMonthly":10.0},{"keyword":"toro lawn mower repair near me","avgMonthly":10.0},{"keyword":"mobile riding lawn mower repair","avgMonthly":10.0},{"keyword":"mower repair","avgMonthly":10.0},{"keyword":"riding lawn mower repair near me","avgMonthly":10.0},{"keyword":"craftsman lawn mower repair","avgMonthly":10.0},{"keyword":"lawnmower repair shop near me","avgMonthly":10.0},{"keyword":"cub cadet repair near me","avgMonthly":10.0},{"keyword":"mobile mower repair near me","avgMonthly":10.0},{"keyword":"lawn mower service cost","avgMonthly":10.0},{"keyword":"mobile lawn mower service near me","avgMonthly":10.0},{"keyword":"lawn mower maintenance","avgMonthly":10.0},{"keyword":"lawn mower tire repair","avgMonthly":10.0},{"keyword":"lawn mower maintenance near me","avgMonthly":10.0},{"keyword":"electric lawn mower repair","avgMonthly":10.0},{"keyword":"lawn mower repair services","avgMonthly":10.0},{"keyword":"lawn mower repair service near me","avgMonthly":10.0},{"keyword":"grass mower service near me","avgMonthly":10.0},{"keyword":"local lawn mower repair","avgMonthly":10.0},{"keyword":"mobile mower repair","avgMonthly":10.0},{"keyword":"lawn mower mechanic near me","avgMonthly":10.0},{"keyword":"lawnmower shops","avgMonthly":10.0},{"keyword":"mobile lawn mower service","avgMonthly":10.0},{"keyword":"john deere mower repair","avgMonthly":10.0},{"keyword":"honda lawn mower service near me","avgMonthly":10.0},{"keyword":"riding lawn mower service near me","avgMonthly":10.0},{"keyword":"honda lawnmower repair near me","avgMonthly":10.0},{"keyword":"honda mower repair near me","avgMonthly":10.0}],"titleTags":[{"url":"https://wildwoodsmallenginerepair.com/","curTitle":"Mower Repair: Get Your Lawn Equipment Running SmoothlyWidget Example","titleLen":68,"curDesc":"Troubleshoot and repair your lawn mower with our helpful guide. Keep your mower in top condition and achieve a lush, healthy lawn.","descLen":130,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/shop/","curTitle":"Shop - Quick and Mobile Wildwood Small Engine Repair","titleLen":52,"curDesc":"","descLen":0,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/cart/","curTitle":"Cart - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":66,"curDesc":"","descLen":0,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/checkout/","curTitle":"Error: Cannot access URL","titleLen":24,"curDesc":"Error: Cannot access URL","descLen":24,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/my-account/","curTitle":"My account - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":72,"curDesc":"","descLen":0,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/thank-you/","curTitle":"Thank you - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":71,"curDesc":"","descLen":0,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/join-our-team/","curTitle":"Join Our Team - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":75,"curDesc":"","descLen":0,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/map/","curTitle":"My first map - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":74,"curDesc":"","descLen":0,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/landing-page-template-2/","curTitle":"Landing Page Template - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":83,"curDesc":"","descLen":0,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/baltimore-maryland/","curTitle":"Snow Blower Repair: Keep Your Equipment RunningWidget Example","titleLen":61,"curDesc":"Discover expert advice on snow blower repair to maintain performance and prolong the life of your snow removal equipment.","descLen":121,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/atv-motorcycle-repair/","curTitle":"ATV/Motorcycle Repair Services: Expert Solutions for Your Vehicles - Quick and Mobile Wildwood Small Engine RepairWidget","titleLen":128,"curDesc":"Expert ATV/Motorcycle repair services for all your off-road adventures. Get your vehicles back on track with our professional repair and maintenance services.","descLen":158,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/bremerton-landing-page/","curTitle":"Quick and Efficient Snow Blower Repair - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":100,"curDesc":"Get quick and mobile snow blower repair services in Bremerton, Washington, and surrounding areas. Contact us now to fill out a contact form.","descLen":140,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/colorado-springs-colorado/","curTitle":"Snow Blower Repair for a Smooth Winter SeasonWidget Example","titleLen":59,"curDesc":"Get practical insights into snow blower repair. Learn how to maximize the lifespan and performance of your snow blower today.","descLen":125,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/boise-idaho/","curTitle":"Snow Blower Repair: Keeping Your Equipment RunningWidget Example","titleLen":64,"curDesc":"Maximize your snow blower's efficiency with expert repair advice. Ensure your equipment is ready for winter challenges.","descLen":119,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/houston-texas-landing-page/","curTitle":"Expert Lawn Mower Repair in Houston, Texas - Quick and Mobile Wildwood Small Engine Repair %","titleLen":92,"curDesc":"Get quick and mobile lawn mower repair services in Houston, Texas and surrounding areas. Contact us now to fill out the contact form.","descLen":133,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/seattle-landing-page/","curTitle":"Reliable Snow Blower Repair in Seattle, Washington - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":112,"curDesc":"Looking for fast and reliable snow blower repair in Seattle? Our mobile small engine repair service has got you covered. Contact us now!","descLen":136,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/newport-landing-page/","curTitle":"Snow Blower Repair Services: Quick & Mobile Solutions - Quick and Mobile Wildwood Small Engine Repair","titleLen":101,"curDesc":"Trust Quick & Mobile Wildwood Small Engine Repair for fast and reliable snow blower repair services in and around Newport, Washington.","descLen":134,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/tallahassee-tennessee-landing-page/","curTitle":"Professional Snow Blower Repair in Tallahassee, Florida - Quick and Mobile Wildwood Small Engine Repair %Widget Example","titleLen":119,"curDesc":"Expert snow blower repair in Tallahassee, FL and surrounding areas. Quick and mobile service. Fill out the contact form!","descLen":120,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/sarasota-florida/","curTitle":"Expert Lawn Mower Repair in Sarasota: Quick & Mobile Service - Quick and Mobile Wildwood Small Engine Repair %Widget Exa","titleLen":124,"curDesc":"Need lawn mower repair? Contact Quick & Mobile Wildwood Small Engine Repair for fast and reliable service in Sarasota and surrounding areas.","descLen":140,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/missouri-kansas/","curTitle":"Lawn Mower Repair: Quick and Mobile Service in Naples, Florida - Quick and Mobile Wildwood Small Engine RepairWidget Exa","titleLen":124,"curDesc":"Get professional lawn mower repair services in Naples, Florida and surrounding areas. Quick and mobile service for small engine repair.","descLen":135,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/kansas-city-landing-page/","curTitle":"Snow Blower Repair Services: Fast and Convenient - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":110,"curDesc":"Need snow blower repair? Trust Quick & Mobile Wildwood Small Engine Repair in Kansas City & surrounding areas for fast and reliable service.","descLen":140,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/elkhart-indiana/","curTitle":"Snow Blower Repair: When to Seek Professional Help","titleLen":50,"curDesc":"Get expert snow blower repair services in Elkhart. We help you fix your snow blower efficiently and quickly.","descLen":108,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/indianapolis-indiana/","curTitle":"Snow Blower Repair Services in Indianapolis, Indiana - Quick and Mobile Wildwood Small Engine Repair %Widget Example","titleLen":116,"curDesc":"Get professional snow blower repair in Indianapolis and surrounding areas. Quick and mobile service for all your small engine repair needs.","descLen":139,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/new-haven-connecticut/","curTitle":"Snow Blower Repair for Optimal PerformanceWidget Example","titleLen":56,"curDesc":"Discover expert advice on snow blower repair to help you tackle winter's challenges with confidence.","descLen":100,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/reno-nevada/","curTitle":"Snow Blower Repair: Tips for Quick FixesWidget Example","titleLen":54,"curDesc":"Need snow blower repair? Learn how to fix common issues and keep your snow blower running efficiently this winter.","descLen":114,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/saint-paul-minnesota/","curTitle":"Snow Blower Repair Made Simple for EveryoneWidget Example","titleLen":57,"curDesc":"Discover essential snow blower repair techniques to ensure your equipment performs efficiently all winter long.","descLen":111,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/south-bend-indiana/","curTitle":"Snow Blower Repair for Winter EfficiencyWidget Example","titleLen":54,"curDesc":"Get expert help with snow blower repair. Keep your machine running efficiently through professional maintenance and care.","descLen":121,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/salt-lake-city-utah/","curTitle":"Snow Blower Repair in Salt Lake City, UT | Fast Winter FixesWidget Example","titleLen":74,"curDesc":"Find expert advice on snow blower repair to ensure your machine performs its best when you need it most.","descLen":104,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/fort-wayne-indiana/","curTitle":"Expert Snow Blower Repair in Fort Wayne, IN | Reliable ServiceWidget Example","titleLen":76,"curDesc":"Ensure your snow blower runs smoothly with expert snow blower repair tips and services tailored for your needs.","descLen":111,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/spoke-washington/","curTitle":"Spokane Snow Blower Repair | Quick Mobile Engine ServiceWidget Example","titleLen":70,"curDesc":"Find reliable solutions for snow blower repair and ensure your machine is ready for the next winter storm.","descLen":106,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/hartford-connecticut/","curTitle":"Hartford Snow Blower Repair Services | Keep Your Blower Ready","titleLen":61,"curDesc":"Get expert snow blower repair services to keep your machine running smoothly all winter long. Contact us today!","descLen":111,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/toledo-ohio/","curTitle":"Toledo, OH Snow Blower Repair | Quick & Affordable Solutions","titleLen":60,"curDesc":"Discover effective snow blower repair solutions for all models. Keep your snow blower working efficiently!","descLen":106,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/boca-raton-florida/","curTitle":"Boca Raton Small Engine & Snow Blower RepairWidget Example","titleLen":58,"curDesc":"Reliable small engine and snow blower repair in Boca Raton, FL. Keep your equipments running smoothly with Wildwood\u2019s professional service.","descLen":139,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/about/","curTitle":"About - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":67,"curDesc":"Learn about Wildwood Small Engine Repair, your trusted experts for snow blower, lawn mower, and small engine repairs across the United States year-round.","descLen":153,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/cape-coral/","curTitle":"Cape Coral - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":72,"curDesc":"Get fast, reliable small engine repair in Cape Coral, FL. Our expert team ensures your snow blower and mower are ready for every season. Book service today!","descLen":156,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/colorado/","curTitle":"Washington - Quick and Mobile Wildwood Small Engine Repair","titleLen":58,"curDesc":"Expert snow blower and small engine repair services across Colorado. Our mobile repair technicians deliver fast, trusted service to keep equipment running.","descLen":155,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/diy/","curTitle":"DIY - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":65,"curDesc":"Learn DIY small engine repair with easy-to-follow guides, expert tips, and troubleshooting steps to save money and keep your lawn and garden equipment ready.","descLen":157,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/kansas-city/","curTitle":"Kansas City - Quick and Mobile Wildwood Small Engine Repair","titleLen":59,"curDesc":"Reliable snow blower repair in Kansas City, MO. Our mobile repair team quickly fixes mowers and outdoor equipment so you are ready for the next big snowstorm.","descLen":158,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/minnesota-landing-page/","curTitle":"Minneapolis Minnesota - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":83,"curDesc":"Get professional small engine and snow blower repair services in Minnesota with Wildwood. Quick, convenient, and affordable solutions to keep you prepared.","descLen":155,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/about-2/","curTitle":"Tractor Mower Repair Services: Push, Riding, and Zero-TurnWidget Example","titleLen":72,"curDesc":"Get professional repair services for push, riding, and zero-turn mowers. Trust our reliable and mobile WildWood Small Engine Repair team.","descLen":137,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/blue-springs-landing-page/","curTitle":"Snow Blower Repair in Blue Springs, MO | Quick & Mobile ServiceWidget Example","titleLen":77,"curDesc":"Get fast, mobile snow blower repair in Blue Springs, MO. Our expert team fixes your equipment quickly. Book a repair today!","descLen":123,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/boat-engine-repair/","curTitle":"Boat Engine Repair Service: Expert Solutions for Your VesselWidget Example","titleLen":74,"curDesc":"Ensure your boat engine runs smoothly with professional repair service. Trust our expert technicians to handle all your boat engine repair needs.","descLen":145,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/boulder-landing-page/","curTitle":"Snow Blower Repair Services: Quick & Mobile in Boulder, ColoradoWidget Example","titleLen":78,"curDesc":"Discover expert snow blower repair services in Boulder, Colorado & surrounding areas. Quick & mobile service. Contact us now.","descLen":125,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/general-small-engine-repair/","curTitle":"Mobile Snow Blower Repair at your homeWidget Example","titleLen":52,"curDesc":"Expert snow blower repair services to keep your equipment running smoothly. Trust our skilled technicians with all your repair needs.","descLen":133,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/holden-landing-page/","curTitle":"Mobile Small Engine Repair for Snow Blowers in Holden, MOWidget Example","titleLen":71,"curDesc":"Need snow blower repair in Holden, Missouri? Quick & Mobile Wildwood Small Engine Repair offers fast and dependable service. Contact us now!","descLen":140,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/fort-myers-landing-page/","curTitle":"The Importance of Regular Lawn Mower Maintenance and RepairWidget Example","titleLen":73,"curDesc":"Get quick and reliable lawn mower repair services in Fort Myers, Florida and surrounding areas. We specialize in mobile small engine repair.","descLen":140,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/detroit-landing-page/","curTitle":"Snow Blower Repair Services: Quick & Mobile in DetroitWidget Example","titleLen":68,"curDesc":"Discover the convenience of Quick & Mobile Wildwood Small Engine Repair in Detroit, Michigan. We offer expert snow blower repair services.","descLen":138,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/denver-landing-page/","curTitle":"Expert Snow Blower Repair in Denver, ColoradoWidget Example","titleLen":59,"curDesc":"Need snow blower repair in Denver? Look no further! Quick and mobile small engine repair services available. Fill out the contact form now.","descLen":139,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/contact/","curTitle":"Contact Us for Expert Mower Repair and Small Engine ServicesWidget Example","titleLen":74,"curDesc":"Get reliable and quick Wildwood small engine repair services. Contact us now for your mower repair or small engine needs. Quick and Mobile Wildwood Small Engine","descLen":167,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/cape-coral-landing-page/","curTitle":"Get Professional Lawn Mower Repair in Cape Coral, FloridaWidget Example","titleLen":71,"curDesc":"In need of lawn mower repair? Quick & Mobile Wildwood Small Engine Repair has you covered. Serving Cape Coral, FL and surrounding areas with top-notch service.","descLen":159,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/brownsville-texas/","curTitle":"Quick and Mobile Lawn Mower Repair in Brownsville, Texas","titleLen":56,"curDesc":"Get your lawn mower running smoothly again with our quick and mobile repair services in Brownsville, Texas and surrounding areas.","descLen":129,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/loveland-denver-colorado/","curTitle":"Snow Blower Repair Services in Denver, ColoradoWidget Example","titleLen":61,"curDesc":"Discover the best small engine repair in Denver, Colorado, and surrounding areas. Quick & Mobile Wildwood specializes in snow blower repair.","descLen":140,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/missouri-kansas-landing-page/","curTitle":"Expert Snow Blower Repair in Kansas City, MO and beyondWidget Example","titleLen":69,"curDesc":"Quick & Mobile Wildwood provides top-notch snow blower repair in Kansas City, Missouri. Get your small engine fixed quickly and efficiently.","descLen":140,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/lees-summit-landing-page/","curTitle":"Expert Snow Blower Repair in Lee's Summit, MissouriWidget Example","titleLen":65,"curDesc":"In need of snow blower repair? Trust Quick & Mobile Wildwood Small Engine Repair in Lee's Summit, MO, for fast and reliable service.","descLen":132,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/san-antonio-texas-landing-page-2/","curTitle":"Expert Lawn Mower Repair in San Antonio: Quick & ConvenientWidget Example","titleLen":73,"curDesc":"Need lawn mower repair in San Antonio? Trust Quick & Mobile Wildwood Small Engine Repair for fast and reliable service.","descLen":119,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/san-antonio/","curTitle":"Generator Repair: Common Issues and How to Solve Them","titleLen":53,"curDesc":"Discover the importance of generator repair. Keep your generators running smoothly with expert repair services.","descLen":111,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/souix-falls-south-dakota/","curTitle":"Expert Snow Blower Repair in Souix Falls, South DakotaWidget Example","titleLen":68,"curDesc":"Need snow blower repair in Souix Falls? Quick & Mobile Wildwood Small Engine Repair offers fast and efficient services for all your needs.","descLen":138,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/blog/","curTitle":"Blog - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":66,"curDesc":"Stay updated with Wildwood\u2019s small engine repair blog featuring expert advice, snow blower maintenance tips, and DIY guides to keep your machines running.","descLen":154,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/post-1/","curTitle":"Lawn Mower Tune-Up Tips | Keep Your Mower Running SmoothWidget Example","titleLen":70,"curDesc":"Start your engines! Spring is on the horizon, and that means it\u2019s time to get your lawn mower geared up for the season. If you didn\u2019t do any\u00a0end-of-season","descLen":154,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/how-to-tell-if-your-lawn-mower-carburetor-needs-cleaning/","curTitle":"Lawn Mower Carburetor Cleaning Guide | Signs & FixesWidget Example","titleLen":66,"curDesc":"Learn how to identify signs of a clogged lawn mower carburetor, prevent buildup, and keep your mower running smoothly with our expert guide.","descLen":140,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/lawn-mower-spring-tune-up-guide-prepare-your-mower-for-the-season/","curTitle":"Lawn Mower Spring Tune-up Guide: Prepare Mower for SeasonWidget Example","titleLen":71,"curDesc":"Our spring lawn mower tune-up guide and maintenance tips will help get your mower ready for lawn mowing season.","descLen":111,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/signs-your-mowers-drive-belt-needs-to-be-replaced/","curTitle":"Signs Your Mower\u2019s Drive Belt Needs to Be ReplacedWidget Example","titleLen":64,"curDesc":"We provide key reasons lawn mower drive belts fail, when to replace them, and how to replace them, as well as expert support.","descLen":125,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/category/lawn-mowers/","curTitle":"Lawn Mowers Archives - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":82,"curDesc":"Browse the best lawn mower repair tips, maintenance guides, and step-by-step troubleshooting advice to keep your mower efficient and extend its lifespan.","descLen":153,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/product-category/uncategorized/","curTitle":"Uncategorized Archives - Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":84,"curDesc":"","descLen":0,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/author/wwser/","curTitle":"Trace Twiford, Author at Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":84,"curDesc":"Explore Wildwood\u2019s expert repair guides, troubleshooting tips, and maintenance advice written by our team of professionals to help you fix engines with ease.","descLen":157,"newTitle":"","newDesc":""},{"url":"https://wildwoodsmallenginerepair.com/author/hailey271/","curTitle":"Hailey Henderson, Author at Quick and Mobile Wildwood Small Engine RepairWidget Example","titleLen":87,"curDesc":"Read detailed tips and guides by Hailey on lawn care, snow blower maintenance, and DIY small engine repair to keep your outdoor equipment running perfectly.","descLen":156,"newTitle":"","newDesc":""}],"topVolumeCities":[{"city":"Huntsville(Albama)","population":674000,"services":{"small engine repair":68,"lawn mower repair":57,"Snow Blower Repair":0,"Generator repair":8}},{"city":"Birmingham(Alabama)","population":1410000,"services":{"small engine repair":60,"lawn mower repair":218,"Generator repair":19}},{"city":"Montgomery(Albama)","population":531000,"services":{"small engine repair":18,"lawn mower repair":30,"Snow Blower Repair":0,"Generator repair":23}},{"city":"Mobile(Albama)","population":1410000,"services":{"small engine repair":30,"lawn mower repair":68,"Snow Blower Repair":0,"Generator repair":10}},{"city":"Mountain Brook(Albama)","population":61000,"services":{"small engine repair":10,"lawn mower repair":158,"Snow Blower Repair":0,"Generator repair":7}},{"city":"Phoenix(Arizona)","population":8160000,"services":{"small engine repair":126,"lawn mower repair":156,"Snow Blower Repair":8,"Generator repair":49}},{"city":"Gilbert(Arizona)","population":818000,"services":{"small engine repair":11,"lawn mower repair":22,"Generator repair":10}},{"city":"Glendale(Arizona)","population":857000,"services":{"small engine repair":14,"lawn mower repair":23,"Snow Blower Repair":10,"Generator repair":12}},{"city":"Scottsdale(Arizona)","population":1030000,"services":{"small engine repair":19,"lawn mower repair":14,"Snow Blower Repair":10,"Generator repair":11}},{"city":"Peoria(Arizona)","population":581000,"services":{"small engine repair":16,"lawn mower repair":12,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Tempe(Arizona)","population":885000,"services":{"small engine repair":45,"lawn mower repair":14,"Generator repair":10}},{"city":"Tucson(Arizona)","population":935000,"services":{"lawn mower repair":16,"Snow Blower Repair":1,"Generator repair":16}},{"city":"Jacksonville(Florida)","population":2580000,"services":{"small engine repair":30,"lawn mower repair":285,"Snow Blower Repair":0,"Generator repair":76}},{"city":"Miami(Florida)","population":11300000,"services":{"small engine repair":33,"lawn mower repair":76,"Snow Blower Repair":10,"Generator repair":44}},{"city":"Tampa(Florida)","population":3960000,"services":{"small engine repair":68,"lawn mower repair":110,"Snow Blower Repair":10,"Generator repair":37}},{"city":"Orlando(Florida)","population":7630000,"services":{"small engine repair":59,"lawn mower repair":112,"Snow Blower Repair":10,"Generator repair":44}},{"city":"St. Petersburg(Florida)","population":784000,"services":{"small engine repair":47,"lawn mower repair":53,"Generator repair":13}},{"city":"Cape Coral(Florida)","population":521000,"services":{"small engine repair":20,"lawn mower repair":36,"Snow Blower Repair":0,"Generator repair":12}},{"city":"Tallahassee(Florida)","population":498000,"services":{"small engine repair":29,"lawn mower repair":42,"Snow Blower Repair":0,"Generator repair":10}},{"city":"Fort Lauderdale(Florida)","population":872000,"services":{"small engine repair":23,"lawn mower repair":22,"Snow Blower Repair":0,"Generator repair":20}},{"city":"Hollywood(Florida)","population":552000,"services":{"small engine repair":12,"lawn mower repair":27,"Snow Blower Repair":0,"Generator repair":11}},{"city":"Clearwater(Florida)","population":570000,"services":{"small engine repair":21,"lawn mower repair":23,"Snow Blower Repair":3,"Generator repair":10}},{"city":"Palm Bay(Florida)","population":346000,"services":{"small engine repair":13,"lawn mower repair":29,"Snow Blower Repair":0,"Generator repair":8}},{"city":"Pompano Beach(Florida)","population":452000,"services":{"small engine repair":21,"lawn mower repair":20,"Snow Blower Repair":0,"Generator repair":11}},{"city":"Largo(Florida)","population":364000,"services":{"small engine repair":16,"lawn mower repair":29,"Snow Blower Repair":0,"Generator repair":9}},{"city":"Lakeland(Florida)","population":637000,"services":{"small engine repair":25,"lawn mower repair":46,"Snow Blower Repair":0,"Generator repair":10}},{"city":"Fort Myers(Florida)","population":1800000,"services":{"small engine repair":36,"lawn mower repair":48,"Snow Blower Repair":0,"Generator repair":15}},{"city":"Atlanta(Georgia)","population":10800000,"services":{"small engine repair":168,"lawn mower repair":299,"Snow Blower Repair":10,"Generator repair":58}},{"city":"Columbus(Georgia)","population":307000,"services":{"small engine repair":21,"lawn mower repair":38,"Generator repair":10}},{"city":"Augusta(Georgia)","population":406000,"services":{"small engine repair":17,"lawn mower repair":51,"Generator repair":10}},{"city":"Macon(Georgia)","population":251000,"services":{"small engine repair":11,"lawn mower repair":24,"Generator repair":10}},{"city":"Savannah(Georgia)","population":1690000,"services":{"small engine repair":23,"lawn mower repair":48,"Generator repair":16}},{"city":"Athens(Georgia)","population":457000,"services":{"small engine repair":11,"lawn mower repair":14,"Generator repair":10}},{"city":"Sandy Springs(Georgia)","population":629000,"services":{"small engine repair":24,"lawn mower repair":30,"Generator repair":10}},{"city":"Alpharetta(Georgia)","population":501000,"services":{"small engine repair":20,"lawn mower repair":29}},{"city":"Marietta(Georgia)","population":844000,"services":{"small engine repair":22,"lawn mower repair":48,"Generator repair":11}},{"city":"Denver(Colorado)","population":7290000,"services":{"small engine repair":128,"lawn mower repair":160,"Snow Blower Repair":11,"Generator repair":38}},{"city":"Colorado Springs(Colorado)","population":849000,"services":{"small engine repair":63,"lawn mower repair":90,"Snow Blower Repair":14,"Generator repair":16}},{"city":"Aurora(Colorado)","population":1100000,"services":{"small engine repair":24,"lawn mower repair":38,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Fort Collins(Colorado)","population":725000,"services":{"small engine repair":22,"lawn mower repair":22,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Lakewood(Colorado)","population":522000,"services":{"small engine repair":29,"lawn mower repair":28,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Thornton(Colorado)","population":432000,"services":{"small engine repair":19,"lawn mower repair":35,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Pueblo(Colorado)","population":218000,"services":{"small engine repair":40,"lawn mower repair":28,"Generator repair":11}},{"city":"Chicago(Illinois)","population":19800000,"services":{"small engine repair":155,"lawn mower repair":358,"Snow Blower Repair":28,"Generator repair":72}},{"city":"Aurora(Illinois)","population":437000,"services":{"small engine repair":14,"lawn mower repair":21,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Naperville(Illinois)","population":541000,"services":{"small engine repair":13,"lawn mower repair":19,"Snow Blower Repair":12,"Generator repair":10}},{"city":"Rockford(Illinois)","population":288000,"services":{"small engine repair":22,"lawn mower repair":37,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Springfield(Illinois)","population":254000,"services":{"small engine repair":14,"lawn mower repair":38,"Snow Blower Repair":13,"Generator repair":10}},{"city":"Peoria(Illinois)","population":232000,"services":{"small engine repair":14,"lawn mower repair":37,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Houston(Texas)","population":12100000,"services":{"small engine repair":308,"lawn mower repair":437,"Snow Blower Repair":10,"Generator repair":170}},{"city":"San Antonio(Texas)","population":8200000,"services":{"small engine repair":211,"lawn mower repair":318,"Snow Blower Repair":10,"Generator repair":82}},{"city":"Dallas(Texas)","population":13400000,"services":{"small engine repair":128,"lawn mower repair":254,"Snow Blower Repair":10,"Generator repair":61}},{"city":"Austin(Texas)","population":99000,"services":{"small engine repair":133,"lawn mower repair":179,"Generator repair":44}},{"city":"Fort Worth(Texas)","population":4780000,"services":{"small engine repair":92,"lawn mower repair":191,"Generator repair":34}},{"city":"El Paso(Texas)","population":971000,"services":{"small engine repair":59,"lawn mower repair":37,"Generator repair":11}},{"city":"Arlington(Texas)","population":1100000,"services":{"small engine repair":19,"lawn mower repair":63,"Generator repair":14}},{"city":"Corpus Christi(Texas)","population":489000,"services":{"small engine repair":80,"lawn mower repair":41,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Plano(Texas)","population":1080000,"services":{"small engine repair":12,"lawn mower repair":33,"Generator repair":10}},{"city":"Lubbock(Texas)","population":453000,"services":{"small engine repair":18,"lawn mower repair":71,"Generator repair":10}},{"city":"Garland(Texas)","population":742000,"services":{"small engine repair":12,"lawn mower repair":32,"Snow Blower Repair":10,"Generator repair":10}},{"city":"McKinney(Texas)","population":730000,"services":{"small engine repair":34,"lawn mower repair":29,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Seattle (Washington)","population":9440000,"services":{"small engine repair":117,"lawn mower repair":182,"Snow Blower Repair":10,"Generator repair":46}},{"city":"Spokane (Washington)","population":488000,"services":{"small engine repair":48,"lawn mower repair":57,"Snow Blower Repair":12,"Generator repair":10}},{"city":"Vancouver (Washington)","population":0,"services":{"small engine repair":122,"lawn mower repair":31,"Generator repair":10}},{"city":"Spokane Valley, Washington","population":234000,"services":{"small engine repair":10,"lawn mower repair":28,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Federal Way (Washington)","population":372000,"services":{"small engine repair":23,"lawn mower repair":20,"Generator repair":10}},{"city":"Yakima (Washington)","population":236000,"services":{"small engine repair":21,"lawn mower repair":14,"Generator repair":10}},{"city":"Kansas City (Missouri)","population":2670000,"services":{"small engine repair":101,"lawn mower repair":182,"Snow Blower Repair":22,"Generator repair":16}},{"city":"St. Louis (Missouri)","population":2150000,"services":{"small engine repair":62,"lawn mower repair":198,"Snow Blower Repair":20,"Generator repair":24}},{"city":"Springfield (Missouri)","population":840000,"services":{"small engine repair":43,"lawn mower repair":56,"Snow Blower Repair":10,"Generator repair":12}},{"city":"Independence (Missouri)","population":311000,"services":{"small engine repair":26,"lawn mower repair":33,"Snow Blower Repair":10,"Generator repair":10}},{"city":"O\u2019Fallon (Missouri)","population":311000,"services":{"small engine repair":22,"lawn mower repair":36,"Snow Blower Repair":13,"Generator repair":10}},{"city":"St. Charles (Missouri)","population":1020000,"services":{"small engine repair":44,"lawn mower repair":78,"Snow Blower Repair":18,"Generator repair":10}},{"city":"St. Peters (Missouri)","population":406000,"services":{"small engine repair":14,"lawn mower repair":29,"Snow Blower Repair":10,"Generator repair":10}},{"city":"Joplin (Missouri)","population":173000,"services":{"small engine repair":10,"lawn mower repair":21,"Generator repair":10}},{"city":"Charlotte (North Carolina)","population":7660000,"services":{"small engine repair":145,"lawn mower repair":197,"Snow Blower Repair":10,"Generator repair":32}},{"city":"Raleigh (North Carolina)","population":3610000,"services":{"small engine repair":81,"lawn mower repair":90,"Snow Blower Repair":10,"Generator repair":21}},{"city":"Asheville (North Carolina)","population":488000,"services":{"small engine repair":30,"lawn mower repair":26,"Generator repair":10}}],"wwserData":{"externalLinks":[{"url":"https://wildwoodsmallenginerepair.com/","incoming":236,"linkingSites":68},{"url":"https://wildwoodsmallenginerepair.com/cape-coral/","incoming":19,"linkingSites":18},{"url":"https://wildwoodsmallenginerepair.com/souix-falls-south-dakota/","incoming":4,"linkingSites":4},{"url":"https://wildwoodsmallenginerepair.com/boulder-landing-page/","incoming":1,"linkingSites":1},{"url":"https://wildwoodsmallenginerepair.com/brownsville-texas/","incoming":1,"linkingSites":1},{"url":"https://wildwoodsmallenginerepair.com/reno-nevada/","incoming":1,"linkingSites":1},{"url":"https://wildwoodsmallenginerepair.com/san-antonio-texas-landing-page-2/","incoming":1,"linkingSites":1}],"semrushTraffic":[{"url":"https://wildwoodsmallenginerepair.com/?utm_campaign=gmb","keywords":49,"traffic":13768},{"url":"https://wildwoodsmallenginerepair.com/how-to-tell-if-your-lawn-mower-carburetor-needs-cleaning/","keywords":222,"traffic":536},{"url":"https://wildwoodsmallenginerepair.com/","keywords":809,"traffic":459},{"url":"https://wildwoodsmallenginerepair.com/signs-your-mowers-drive-belt-needs-to-be-replaced/","keywords":165,"traffic":142},{"url":"https://wildwoodsmallenginerepair.com/cape-coral/","keywords":20,"traffic":66},{"url":"https://wildwoodsmallenginerepair.com/toledo-ohio/","keywords":106,"traffic":57},{"url":"https://wildwoodsmallenginerepair.com/souix-falls-south-dakota/","keywords":31,"traffic":52},{"url":"https://wildwoodsmallenginerepair.com/cape-coral-landing-page/","keywords":58,"traffic":39},{"url":"https://wildwoodsmallenginerepair.com/fort-myers-landing-page/","keywords":23,"traffic":32},{"url":"https://wildwoodsmallenginerepair.com/boise-idaho/","keywords":48,"traffic":14},{"url":"https://wildwoodsmallenginerepair.com/houston-texas-landing-page/","keywords":72,"traffic":10},{"url":"https://wildwoodsmallenginerepair.com/reno-nevada/","keywords":12,"traffic":8},{"url":"https://wildwoodsmallenginerepair.com/brownsville-texas/","keywords":7,"traffic":7},{"url":"https://wildwoodsmallenginerepair.com/san-antonio-texas-landing-page-2/","keywords":104,"traffic":6},{"url":"https://wildwoodsmallenginerepair.com/boulder-landing-page/","keywords":32,"traffic":6},{"url":"https://wildwoodsmallenginerepair.com/fort-wayne-indiana/","keywords":12,"traffic":5},{"url":"https://wildwoodsmallenginerepair.com/sarasota-florida/","keywords":32,"traffic":4},{"url":"http://wildwoodsmallenginerepair.com/","keywords":2,"traffic":4},{"url":"https://wildwoodsmallenginerepair.com/kansas-city-landing-page/","keywords":43,"traffic":3},{"url":"https://wildwoodsmallenginerepair.com/elkhart-indiana/","keywords":5,"traffic":1},{"url":"https://wildwoodsmallenginerepair.com/colorado/","keywords":11,"traffic":1},{"url":"https://wildwoodsmallenginerepair.com/boca-raton-florida/","keywords":7,"traffic":1},{"url":"https://wildwoodsmallenginerepair.com/south-bend-indiana/","keywords":11,"traffic":1},{"url":"https://wildwoodsmallenginerepair.com/colorado-springs-colorado/","keywords":17,"traffic":1},{"url":"https://wildwoodsmallenginerepair.com/hartford-connecticut/","keywords":6,"traffic":1}],"webTraffic":[{"url":"https://wildwoodsmallenginerepair.com/","clicks":2467,"impressions":82830},{"url":"https://wildwoodsmallenginerepair.com/signs-your-mowers-drive-belt-needs-to-be-replaced/","clicks":826,"impressions":69395},{"url":"https://wildwoodsmallenginerepair.com/?utm_campaign=gmb","clicks":596,"impressions":13489},{"url":"https://wildwoodsmallenginerepair.com/souix-falls-south-dakota/","clicks":521,"impressions":22616},{"url":"http://wildwoodsmallenginerepair.com/","clicks":394,"impressions":10175},{"url":"https://wildwoodsmallenginerepair.com/how-to-tell-if-your-lawn-mower-carburetor-needs-cleaning/","clicks":283,"impressions":41422},{"url":"https://wildwoodsmallenginerepair.com/houston-texas-landing-page/","clicks":273,"impressions":92153},{"url":"https://wildwoodsmallenginerepair.com/cape-coral/","clicks":270,"impressions":11574},{"url":"https://wildwoodsmallenginerepair.com/brownsville-texas/","clicks":145,"impressions":7805},{"url":"https://wildwoodsmallenginerepair.com/cape-coral-landing-page/","clicks":102,"impressions":12242},{"url":"https://wildwoodsmallenginerepair.com/fort-myers-landing-page/","clicks":98,"impressions":13238},{"url":"https://wildwoodsmallenginerepair.com/boise-idaho/","clicks":93,"impressions":18186},{"url":"https://wildwoodsmallenginerepair.com/reno-nevada/","clicks":91,"impressions":8429},{"url":"https://www.wildwoodsmallenginerepair.com/","clicks":85,"impressions":2805},{"url":"https://wildwoodsmallenginerepair.com/toledo-ohio/","clicks":79,"impressions":36876},{"url":"https://wildwoodsmallenginerepair.com/san-antonio-texas-landing-page-2/","clicks":74,"impressions":32795},{"url":"https://wildwoodsmallenginerepair.com/boulder-landing-page/","clicks":70,"impressions":18841}],"topQueries":[{"query":"wildwood small engine repair","clicks":616,"impressions":2043},{"query":"small engine repair near me","clicks":317,"impressions":33945},{"query":"lawn mower repair near me","clicks":191,"impressions":18748},{"query":"mobile lawn mower repair near me","clicks":141,"impressions":3183},{"query":"quick and mobile wildwood small engine repair","clicks":139,"impressions":656},{"query":"lawnmower repair near me","clicks":132,"impressions":7606},{"query":"lawn mower repair","clicks":104,"impressions":11777},{"query":"small engine repair","clicks":101,"impressions":6216},{"query":"small engine repair sioux falls","clicks":87,"impressions":1601},{"query":"mobile lawn mower repair","clicks":79,"impressions":1585},{"query":"mobile small engine repair near me","clicks":76,"impressions":1888},{"query":"quick and mobile wildwood small enigne repair","clicks":76,"impressions":164},{"query":"mower repair near me","clicks":54,"impressions":3532},{"query":"mobile small engine repair","clicks":45,"impressions":1207},{"query":"lawn mower repair sioux falls","clicks":45,"impressions":620},{"query":"small engine repair lees summit","clicks":41,"impressions":343},{"query":"lawn mower repair cape coral","clicks":37,"impressions":1016},{"query":"small engine repair cape coral","clicks":36,"impressions":778},{"query":"small engine repair san antonio","clicks":30,"impressions":1175},{"query":"mobile mower repair","clicks":27,"impressions":512},{"query":"snow blower repair near me","clicks":26,"impressions":3795},{"query":"riding lawn mower repair near me","clicks":26,"impressions":1541},{"query":"generator repair near me","clicks":26,"impressions":324},{"query":"portable generator repair near me","clicks":25,"impressions":202},{"query":"small engine repair greeley","clicks":23,"impressions":391},{"query":"snowblower repair near me","clicks":22,"impressions":4275},{"query":"small engine repair port orchard","clicks":20,"impressions":150},{"query":"mobile mower repair near me","clicks":19,"impressions":388},{"query":"lawn mower blade sharpening near me","clicks":18,"impressions":609},{"query":"lawn mower repair port orchard","clicks":18,"impressions":89},{"query":"lawn mower repair lees summit","clicks":16,"impressions":253},{"query":"mower blade sharpening near me","clicks":15,"impressions":423},{"query":"mobile lawnmower repair","clicks":14,"impressions":360},{"query":"snow blower repair","clicks":13,"impressions":2124},{"query":"lawn mower repair brownsville tx","clicks":13,"impressions":501},{"query":"mobile lawnmower repairs near me","clicks":13,"impressions":186},{"query":"lawn mower service near me","clicks":12,"impressions":2565}],"gbpUrls":[{"city":"Sioux Falls, SD","url":"https://wildwoodsmallenginerepair.com/souix-falls-south-dakota/"},{"city":"Wayne County, MI","url":"https://wildwoodsmallenginerepair.com/"},{"city":"Lee's Summit, MO","url":"https://wildwoodsmallenginerepair.com/?utm_campaign=gmb"},{"city":"Tea, SD","url":"https://wildwoodsmallenginerepair.com/"},{"city":"Katy, TX,","url":"https://wildwoodsmallenginerepair.com/"},{"city":"Carmel, IN","url":"https://wildwoodsmallenginerepair.com/"},{"city":"Tampa, Fl","url":"https://wildwoodsmallenginerepair.com/"},{"city":"Midway, Fl","url":"https://wildwoodsmallenginerepair.com/"},{"city":"Cape Coral, Fl","url":"https://wildwoodsmallenginerepair.com/cape-coral/"},{"city":"Elsa, TX","url":"https://wildwoodsmallenginerepair.com/brownsville-texas/"}]}};

function getSeoStateData(state) {
  return SEO_AUDIT_DATA[state] || null;
}
function getSeoNationalTotals() {
  var totals = {};
  var serviceKeys = ['small_engine_repair','lawn_mower_repair','snow_blower_repair','generator_repair','motorcycle_repair'];
  serviceKeys.forEach(function(sk) { totals[sk] = { totalVol: 0, cities: 0, avgKd: 0, kdSum: 0 }; });
  var totalPop = 0, totalCities = 0;
  Object.keys(SEO_AUDIT_DATA).forEach(function(st) {
    var d = SEO_AUDIT_DATA[st];
    d[0].forEach(function(c) { totalPop += c[1]; totalCities++; });
    serviceKeys.forEach(function(sk) {
      if (d[1][sk]) {
        d[1][sk].forEach(function(c) {
          totals[sk].totalVol += c[1];
          totals[sk].cities++;
          var kd = c[2] > 1 ? c[2] / 100 : c[2]; // normalize
          totals[sk].kdSum += kd;
        });
      }
    });
  });
  serviceKeys.forEach(function(sk) {
    totals[sk].avgKd = totals[sk].cities > 0 ? Math.round((totals[sk].kdSum / totals[sk].cities) * 100) / 100 : 0;
  });
  return { totals: totals, totalPop: totalPop, totalCities: totalCities, states: Object.keys(SEO_AUDIT_DATA).length };
}
function getSeoTopMarkets(serviceKey, limit) {
  limit = limit || 20;
  var all = [];
  Object.keys(SEO_AUDIT_DATA).forEach(function(st) {
    var d = SEO_AUDIT_DATA[st];
    var pops = {};
    d[0].forEach(function(c) { pops[c[0]] = c[1]; });
    if (d[1][serviceKey]) {
      d[1][serviceKey].forEach(function(c) {
        var kd = c[2] > 1 ? c[2] / 100 : c[2]; // normalize
        all.push({ city: c[0], state: st, vol: c[1], kd: kd, cpc: c[3], pop: pops[c[0]] || 0 });
      });
    }
  });
  all.sort(function(a,b) { return b.vol - a.vol || a.kd - b.kd; });
  return all.slice(0, limit);
}
function getSeoMarketScore(city, state) {
  var d = SEO_AUDIT_DATA[state];
  if (!d) return null;
  var pop = 0;
  d[0].forEach(function(c) { if (c[0] === city) pop = c[1]; });
  var services = {};
  var totalVol = 0, totalKd = 0, count = 0;
  Object.keys(d[1]).forEach(function(sk) {
    d[1][sk].forEach(function(c) {
      if (c[0] === city) {
        var kd = c[2] > 1 ? c[2] / 100 : c[2]; // normalize: 28 -> 0.28
        services[sk] = { vol: c[1], kd: kd, cpc: c[3] };
        totalVol += c[1];
        totalKd += kd;
        count++;
      }
    });
  });
  var avgKd = count > 0 ? totalKd / count : 0;
  // Score: higher volume + lower KD = better opportunity
  var score = Math.round(totalVol * (1 - avgKd) * (pop > 100000 ? 1.2 : pop > 50000 ? 1.0 : 0.8));
  return { city: city, state: state, pop: pop, services: services, totalVol: totalVol, avgKd: Math.round(avgKd * 100) / 100, score: score };
}
function getSeoStateRanking() {
  var ranking = [];
  Object.keys(SEO_AUDIT_DATA).forEach(function(st) {
    var d = SEO_AUDIT_DATA[st];
    var totalVol = 0, totalPop = 0, cityCount = d[0].length;
    d[0].forEach(function(c) { totalPop += c[1]; });
    Object.keys(d[1]).forEach(function(sk) {
      d[1][sk].forEach(function(c) { totalVol += c[1]; });
    });
    ranking.push({ state: st, totalVol: totalVol, totalPop: totalPop, cities: cityCount });
  });
  ranking.sort(function(a,b) { return b.totalVol - a.totalVol; });
  return ranking;
}

// Seasonal multipliers by month (index 0=Jan, 11=Dec) â€” based on industry demand patterns
var SEO_SEASONAL = {
  small_engine_repair: [0.6, 0.65, 0.9, 1.2, 1.4, 1.5, 1.4, 1.3, 1.0, 0.8, 0.6, 0.5],
  lawn_mower_repair:   [0.2, 0.3, 0.8, 1.5, 1.8, 1.9, 1.6, 1.4, 1.0, 0.5, 0.2, 0.1],
  snow_blower_repair:  [1.4, 1.2, 0.8, 0.3, 0.1, 0.1, 0.1, 0.1, 0.3, 0.8, 1.6, 1.8],
  generator_repair:    [0.8, 0.7, 0.7, 0.8, 0.9, 1.1, 1.3, 1.4, 1.5, 1.2, 0.9, 0.7],
  motorcycle_repair:   [0.3, 0.4, 0.8, 1.3, 1.6, 1.7, 1.6, 1.5, 1.2, 0.8, 0.4, 0.2]
};

function getSeoMonthlyPredictions(state, months) {
  months = months || 12;
  var d = getSeoStateData(state);
  if (!d) return [];
  
  var now = new Date();
  var startMonth = now.getMonth(); // 0-based
  var startYear = now.getFullYear();
  var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var serviceKeys = ['small_engine_repair','lawn_mower_repair','snow_blower_repair','generator_repair','motorcycle_repair'];
  var svcLabels = { small_engine_repair: 'Small Engine', lawn_mower_repair: 'Lawn Mower', snow_blower_repair: 'Snow Blower', generator_repair: 'Generator', motorcycle_repair: 'Motorcycle' };
  
  // Base volumes for this state
  var stateVols = {};
  serviceKeys.forEach(function(sk) {
    var total = 0;
    if (d[1][sk]) d[1][sk].forEach(function(c) { total += c[1]; });
    stateVols[sk] = total;
  });
  
  var predictions = [];
  for (var i = 0; i < months; i++) {
    var mi = (startMonth + i) % 12;
    var yr = startYear + Math.floor((startMonth + i) / 12);
    var label = monthNames[mi] + ' ' + yr;
    var monthKey = yr + '-' + String(mi + 1).padStart(2, '0');
    
    var services = {};
    var totalPredVol = 0, totalLeads = 0, totalRev = 0;
    var dominant = { svc: '', vol: 0 };
    
    serviceKeys.forEach(function(sk) {
      var baseVol = stateVols[sk];
      var mult = SEO_SEASONAL[sk][mi];
      var predVol = Math.round(baseVol * mult);
      // Estimated leads based on predicted volume and avg KD for state
      var avgKd = 0, count = 0;
      if (d[1][sk]) d[1][sk].forEach(function(c) { var kd = c[2] > 1 ? c[2]/100 : c[2]; avgKd += kd; count++; });
      avgKd = count > 0 ? avgKd / count : 0.3;
      var ctr = avgKd < 0.2 ? 0.15 : avgKd < 0.4 ? 0.08 : 0.04;
      var leads = Math.round(predVol * ctr);
      var rev = Math.round(leads * 0.3 * 250);
      
      services[sk] = { label: svcLabels[sk], baseVol: baseVol, multiplier: mult, predictedVol: predVol, estLeads: leads, estRevenue: rev };
      totalPredVol += predVol;
      totalLeads += leads;
      totalRev += rev;
      if (predVol > dominant.vol) { dominant = { svc: svcLabels[sk], vol: predVol }; }
    });
    
    predictions.push({
      month: monthKey, label: label, monthIndex: mi,
      totalPredictedVol: totalPredVol, totalEstLeads: totalLeads, totalEstRevenue: totalRev,
      dominantService: dominant.svc, services: services
    });
  }
  return predictions;
}

function getSeoMonthlyCity(city, state, months) {
  months = months || 12;
  var d = getSeoStateData(state);
  if (!d) return [];
  
  var now = new Date();
  var startMonth = now.getMonth();
  var startYear = now.getFullYear();
  var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var serviceKeys = ['small_engine_repair','lawn_mower_repair','snow_blower_repair','generator_repair','motorcycle_repair'];
  var svcLabels = { small_engine_repair: 'Small Engine', lawn_mower_repair: 'Lawn Mower', snow_blower_repair: 'Snow Blower', generator_repair: 'Generator', motorcycle_repair: 'Motorcycle' };
  
  // City base volumes
  var cityVols = {};
  serviceKeys.forEach(function(sk) {
    if (d[1][sk]) {
      d[1][sk].forEach(function(c) {
        if (c[0] === city) {
          var kd = c[2] > 1 ? c[2]/100 : c[2];
          cityVols[sk] = { vol: c[1], kd: kd, cpc: c[3] };
        }
      });
    }
  });
  
  var predictions = [];
  for (var i = 0; i < months; i++) {
    var mi = (startMonth + i) % 12;
    var yr = startYear + Math.floor((startMonth + i) / 12);
    var label = monthNames[mi] + ' ' + yr;
    
    var services = {};
    var totalVol = 0, totalLeads = 0;
    serviceKeys.forEach(function(sk) {
      if (cityVols[sk] && cityVols[sk].vol > 0) {
        var mult = SEO_SEASONAL[sk][mi];
        var predVol = Math.round(cityVols[sk].vol * mult);
        var ctr = cityVols[sk].kd < 0.2 ? 0.15 : cityVols[sk].kd < 0.4 ? 0.08 : 0.04;
        var leads = Math.round(predVol * ctr);
        services[sk] = { label: svcLabels[sk], vol: predVol, leads: leads, kd: cityVols[sk].kd };
        totalVol += predVol;
        totalLeads += leads;
      }
    });
    predictions.push({ label: label, monthIndex: mi, totalVol: totalVol, totalLeads: totalLeads, estRevenue: Math.round(totalLeads * 0.3 * 250), services: services });
  }
  return predictions;
}



async function squareFullSnapshot(forceRefresh) {
  var now = Date.now();
  var store = squareDataStore;

  // If already initialized and not forcing refresh, do incremental update (every 5 min)
  if (store.initialized && !forceRefresh && (now - store.lastIncrFetch) < 300000) {
    store.time = now;
    return store;
  }

  // If already initialized, do incremental fetch (only new data since last fetch)
  if (store.initialized && !forceRefresh) {
    console.log('Square: incremental fetch since ' + new Date(store.lastIncrFetch).toISOString());
    var sinceDays = Math.max(1, Math.ceil((now - store.lastIncrFetch) / 86400000) + 1);
    var sinceDate = new Date(store.lastIncrFetch - 86400000).toISOString(); // 1 day buffer

    var [newPayments, newRefunds, newPayouts, newShifts] = await Promise.all([
      squareGetPayments(sinceDays),
      squareGetRefunds(sinceDays),
      squareGetPayouts(sinceDays),
      squareGetShifts(sinceDays)
    ]);

    // Fetch new orders across all location batches
    var newOrders = store.locIds.length ? await squareGetOrders(store.locIds, sinceDays) : [];

    // Fetch new invoices across all locations
    var newInvoices = store.locIds.length ? await squareGetInvoices(store.locIds) : [];

    // Merge: deduplicate by ID (new data wins)
    store.payments = mergeById(store.payments, newPayments);
    store.refunds = mergeById(store.refunds, newRefunds);
    store.payouts = mergeById(store.payouts, newPayouts);
    store.shifts = mergeById(store.shifts, newShifts);
    store.orders = mergeById(store.orders, newOrders);
    store.invoices = mergeById(store.invoices, newInvoices);

    // Refresh customers less often (every 30 min)
    if ((now - store.lastFullFetch) > 1800000) {
      store.customers = await squareGetCustomers();
      store.catalog = await squareGetCatalog();
      store.team = await squareGetTeamMembers();
      store.disputes = await squareGetDisputes();
      store.giftCards = await squareGetGiftCards();
      store.lastFullFetch = now;
      console.log('Square: refreshed customers/catalog/team/disputes/giftCards');
    }

    store.lastIncrFetch = now;
    store.time = now;
    console.log('Square: incremental done â€” ' + store.payments.length + ' payments, ' + store.orders.length + ' orders, ' + store.invoices.length + ' invoices');
    return store;
  }

  // FIRST LOAD: fetch everything
  console.log('Square: FULL initial fetch (all historical data)...');
  var locations = await squareGetLocations();
  var locIds = locations.map(function(l){return l.id;});

  // Parallel fetch for speed â€” get ALL historical payments
  var [payments, customers, catalog, team, refunds, disputes, payouts, shifts, giftCards, subscriptions, bookings, devices, custGroups, custSegments] = await Promise.all([
    squareGetPayments(1500),
    squareGetCustomers(),
    squareGetCatalog(),
    squareGetTeamMembers(),
    squareGetRefunds(1500),
    squareGetDisputes(),
    squareGetPayouts(1500),
    squareGetShifts(14),
    squareGetGiftCards(),
    squareGetSubscriptions(),
    squareGetBookings(14),
    squareGetDevices(),
    squareGetCustomerGroups(),
    squareGetCustomerSegments()
  ]);

  // Orders and invoices need location batching â€” run after locations are fetched
  var orders = locIds.length ? await squareGetOrders(locIds, 1500) : [];
  var invoices = locIds.length ? await squareGetInvoices(locIds) : [];

  // Try loyalty (may 404 if not enabled)
  var loyalty = null; var loyaltyAccounts = [];
  try { loyalty = await squareGetLoyaltyProgram(); if (loyalty) loyaltyAccounts = await squareGetLoyaltyAccounts(); } catch(e){}

  // Try cash drawers
  var cashDrawers = [];
  try { 
    for (var ci = 0; ci < locations.length; ci++) {
      var cdShifts = await squareGetCashDrawerShifts(locations[ci].id);
      cashDrawers = cashDrawers.concat(cdShifts);
    }
  } catch(e){}

  // Try bank accounts
  var bankAccounts = [];
  try { bankAccounts = await squareGetBankAccounts(); } catch(e){}

  // Store everything
  store.payments = payments; store.customers = customers; store.invoices = invoices; store.orders = orders;
  store.catalog = catalog; store.locations = locations; store.team = team; store.refunds = refunds;
  store.disputes = disputes; store.payouts = payouts; store.shifts = shifts; store.giftCards = giftCards;
  store.subscriptions = subscriptions; store.bookings = bookings; store.devices = devices;
  store.loyalty = loyalty; store.loyaltyAccounts = loyaltyAccounts; store.cashDrawers = cashDrawers;
  store.bankAccounts = bankAccounts; store.custGroups = custGroups; store.custSegments = custSegments;
  store.locIds = locIds; store.time = now; store.lastFullFetch = now; store.lastIncrFetch = now;
  store.initialized = true;

  console.log('Square: FULL fetch complete â€” ' + payments.length + ' payments, ' + orders.length + ' orders, ' + invoices.length + ' invoices, ' + customers.length + ' customers across ' + locations.length + ' locations');
  return store;
}

// Merge arrays by ID â€” new items replace old ones with same ID
function mergeById(existing, incoming) {
  if (!incoming || !incoming.length) return existing;
  var map = {};
  existing.forEach(function(item) { if (item.id) map[item.id] = item; });
  incoming.forEach(function(item) { if (item.id) map[item.id] = item; });
  return Object.values(map);
}

// ---- DEEP ANALYTICS ENGINE ----
function squareAnalyze(snap) {
  var payments = snap.payments || []; var customers = snap.customers || [];
  var invoices = snap.invoices || []; var orders = snap.orders || [];
  var refunds = snap.refunds || []; var disputes = snap.disputes || [];
  var payouts = snap.payouts || []; var shifts = snap.shifts || [];
  var catalog = snap.catalog || []; var team = snap.team || [];

  // Use Central time for date comparisons (most locations are CT)
  var nowCT = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' }));
  var today = nowCT.getFullYear() + '-' + String(nowCT.getMonth()+1).padStart(2,'0') + '-' + String(nowCT.getDate()).padStart(2,'0');
  var weekAgo = new Date(nowCT.getTime() - 7 * 86400000).toISOString();
  var prevWeekStart = new Date(nowCT.getTime() - 14 * 86400000).toISOString();
  var completed = payments.filter(function(p){return p.status==='COMPLETED';});

  // Revenue breakdown â€” from BOTH payments and orders
  var totalRev = 0; var todayRev = 0; var weekRev = 0; var prevWeekRev = 0; var month30dRev = 0;
  var grossRev = 0; var totalTips = 0; var totalFees = 0;
  var paymentsByDay = {}; var paymentsByHour = {}; var paymentsByDayOfWeek = {};
  var paymentsByMethod = {}; var paymentsByLocation = {};
  var avgTickets = []; var tipsByEmployee = {};
  var totalPaymentCount = 0;

  // Use orders as primary revenue source if we have more orders than payments
  var useOrders = true; // Use COMPLETED orders â€” matches Square dashboard revenue
  var completedOrders = orders.filter(function(o){return o.state==='COMPLETED'&&sqCents(o.total_money)>0;});

  // Revenue helper â€” use total_money on COMPLETED orders (confirmed paid)
  function orderRev(o) { return sqCents(o.total_money); }

  if (useOrders && completedOrders.length > 0) {
    // Calculate revenue from orders â€” use TENDER amounts (actual $ collected), NOT total_money
    completedOrders.forEach(function(o) {
      var amt = orderRev(o);
      if (amt <= 0) return; // skip orders with no actual collection
      var tip = sqCents(o.total_tip_money);
      var tax = sqCents(o.total_tax_money);
      grossRev += amt; totalTips += tip;
      totalRev += amt;
      if (amt > 0) avgTickets.push(amt);
      totalPaymentCount++;

      var day = (o.created_at || '').substring(0, 10);
      var hour = new Date(o.created_at).getHours();
      var dow = new Date(o.created_at).toLocaleDateString('en-US', { weekday: 'short' });
      if (day === today) todayRev += amt;
      if (o.created_at >= weekAgo) weekRev += amt;
      if (o.created_at >= new Date(nowCT.getTime() - 30 * 86400000).toISOString()) month30dRev += amt;
      if (o.created_at >= prevWeekStart && o.created_at < weekAgo) prevWeekRev += amt;
      paymentsByDay[day] = (paymentsByDay[day] || 0) + amt;
      paymentsByHour[hour] = (paymentsByHour[hour] || 0) + amt;
      paymentsByDayOfWeek[dow] = (paymentsByDayOfWeek[dow] || 0) + amt;

      var locName = o.location_id || 'unknown';
      if (!paymentsByLocation[locName]) paymentsByLocation[locName] = { count: 0, total: 0 };
      paymentsByLocation[locName].count++; paymentsByLocation[locName].total += amt;

      // Payment source from tenders
      if (o.tenders) o.tenders.forEach(function(t) {
        var method = t.type || 'OTHER';
        if (!paymentsByMethod[method]) paymentsByMethod[method] = { count: 0, total: 0 };
        paymentsByMethod[method].count++; paymentsByMethod[method].total += sqCents(t.amount_money);
      });
    });
    // Get fees from payments if available
    completed.forEach(function(p) {
      var fee = sqCents(p.processing_fee ? p.processing_fee[0] : null);
      totalFees += Math.abs(fee);
    });
  } else {
    // Fallback to payments-only revenue
    completed.forEach(function(p) {
      var amt = sqCents(p.amount_money);
      var tip = sqCents(p.tip_money);
      var fee = sqCents(p.processing_fee ? p.processing_fee[0] : null);
      grossRev += amt; totalTips += tip; totalFees += Math.abs(fee);
      totalRev += amt;
      avgTickets.push(amt);
      totalPaymentCount++;

      var day = (p.created_at || '').substring(0, 10);
      var hour = new Date(p.created_at).getHours();
      var dow = new Date(p.created_at).toLocaleDateString('en-US', { weekday: 'short' });
      if (day === today) todayRev += amt;
      if (p.created_at >= weekAgo) weekRev += amt;
      if (p.created_at >= new Date(nowCT.getTime() - 30 * 86400000).toISOString()) month30dRev += amt;
      if (p.created_at >= prevWeekStart && p.created_at < weekAgo) prevWeekRev += amt;
      paymentsByDay[day] = (paymentsByDay[day] || 0) + amt;
      paymentsByHour[hour] = (paymentsByHour[hour] || 0) + amt;
      paymentsByDayOfWeek[dow] = (paymentsByDayOfWeek[dow] || 0) + amt;

      var method = p.source_type || 'OTHER';
      if (!paymentsByMethod[method]) paymentsByMethod[method] = { count: 0, total: 0 };
      paymentsByMethod[method].count++; paymentsByMethod[method].total += amt;

      var locName = p.location_id || 'unknown';
      if (!paymentsByLocation[locName]) paymentsByLocation[locName] = { count: 0, total: 0 };
      paymentsByLocation[locName].count++; paymentsByLocation[locName].total += amt;

      if (p.employee_id && tip > 0) {
        if (!tipsByEmployee[p.employee_id]) tipsByEmployee[p.employee_id] = { tips: 0, count: 0 };
        tipsByEmployee[p.employee_id].tips += tip; tipsByEmployee[p.employee_id].count++;
      }
    });
  }

  var avgTicket = avgTickets.length > 0 ? avgTickets.reduce(function(a,b){return a+b;},0) / avgTickets.length : 0;
  var medianTicket = 0;
  if (avgTickets.length > 0) { avgTickets.sort(function(a,b){return a-b;}); medianTicket = avgTickets[Math.floor(avgTickets.length/2)]; }
  var maxTicket = avgTickets.length > 0 ? Math.max.apply(null, avgTickets) : 0;
  var minTicket = avgTickets.length > 0 ? Math.min.apply(null, avgTickets) : 0;
  var weekGrowth = prevWeekRev > 0 ? Math.round(((weekRev - prevWeekRev) / prevWeekRev) * 100) : 0;
  var netRev = grossRev - totalFees;

  // Peak hour/day
  var peakHour = Object.entries(paymentsByHour).sort(function(a,b){return b[1]-a[1];})[0];
  var peakDay = Object.entries(paymentsByDayOfWeek).sort(function(a,b){return b[1]-a[1];})[0];
  var slowHour = Object.entries(paymentsByHour).sort(function(a,b){return a[1]-b[1];})[0];

  // Customer analytics
  var newCustomers30d = customers.filter(function(c) { return c.created_at && c.created_at >= new Date(Date.now()-30*86400000).toISOString(); }).length;
  var newCustomers7d = customers.filter(function(c) { return c.created_at && c.created_at >= weekAgo; }).length;
  var custWithEmail = customers.filter(function(c){return c.email_address;}).length;
  var custWithPhone = customers.filter(function(c){return c.phone_number;}).length;
  var custWithNote = customers.filter(function(c){return c.note;}).length;

  // Invoice analytics
  var unpaidInv = invoices.filter(function(i){return i.status==='UNPAID'||i.status==='SENT'||i.status==='SCHEDULED';});
  var overdueInv = invoices.filter(function(i){return i.status==='OVERDUE';});
  var paidInv = invoices.filter(function(i){return i.status==='PAID';});
  var cancelledInv = invoices.filter(function(i){return i.status==='CANCELED';});
  var unpaidTotal = 0; var overdueTotal = 0;
  unpaidInv.forEach(function(inv){ if(inv.payment_requests) inv.payment_requests.forEach(function(pr){ if(pr.computed_amount_money) unpaidTotal+=pr.computed_amount_money.amount/100; }); });
  overdueInv.forEach(function(inv){ if(inv.payment_requests) inv.payment_requests.forEach(function(pr){ if(pr.computed_amount_money) overdueTotal+=pr.computed_amount_money.amount/100; }); });

  // Invoice turnaround time (service date â†’ invoice created, business hours only 8am-6pm)
  var invoiceTurnarounds = [];
  invoices.forEach(function(inv) {
    if (!inv.sale_or_service_date || !inv.created_at) return;
    var serviceDate = new Date(inv.sale_or_service_date + 'T08:00:00');
    var invoiceDate = new Date(inv.created_at);
    if (isNaN(serviceDate.getTime()) || isNaN(invoiceDate.getTime())) return;
    if (invoiceDate <= serviceDate) return; // invoice before service = skip
    // Count business hours (8am-6pm, 10 hrs/day, skip weekends)
    var bizHours = 0;
    var cursor = new Date(serviceDate);
    var maxDays = 60; // cap at 60 days to avoid infinite loops
    while (cursor < invoiceDate && maxDays-- > 0) {
      var dow = cursor.getDay();
      if (dow > 0 && dow < 6) { // Mon-Fri
        var dayStart = new Date(cursor); dayStart.setHours(8,0,0,0);
        var dayEnd = new Date(cursor); dayEnd.setHours(18,0,0,0);
        var start = cursor > dayStart ? cursor : dayStart;
        var end = invoiceDate < dayEnd ? invoiceDate : dayEnd;
        if (end > start) bizHours += (end - start) / 3600000;
      }
      cursor.setDate(cursor.getDate() + 1);
      cursor.setHours(8,0,0,0);
    }
    if (bizHours > 0) invoiceTurnarounds.push(bizHours);
  });
  var avgInvoiceTurnaround = invoiceTurnarounds.length > 0 ? invoiceTurnarounds.reduce(function(a,b){return a+b;},0) / invoiceTurnarounds.length : 0;
  var medianInvoiceTurnaround = 0;
  if (invoiceTurnarounds.length > 0) {
    invoiceTurnarounds.sort(function(a,b){return a-b;});
    medianInvoiceTurnaround = invoiceTurnarounds[Math.floor(invoiceTurnarounds.length/2)];
  }
  var fastestInvoice = invoiceTurnarounds.length > 0 ? Math.min.apply(null, invoiceTurnarounds) : 0;
  var slowestInvoice = invoiceTurnarounds.length > 0 ? Math.max.apply(null, invoiceTurnarounds) : 0;
  // Format hours into readable string
  function fmtBizHours(h) {
    if (h < 1) return Math.round(h*60) + 'm';
    if (h < 10) return h.toFixed(1) + 'h';
    var days = Math.floor(h / 10); var rem = h % 10;
    return days + 'd ' + Math.round(rem) + 'h';
  }

  // Payment speed â€” time from invoice sent to payment received (business hours)
  var paymentSpeeds = [];
  var sameDay = 0; var within3d = 0; var within7d = 0; var within30d = 0; var over30d = 0;
  paidInv.forEach(function(inv) {
    if (!inv.created_at || !inv.updated_at) return;
    var sent = new Date(inv.created_at);
    var paid = new Date(inv.updated_at); // updated_at is when status changed to PAID
    if (isNaN(sent.getTime()) || isNaN(paid.getTime())) return;
    if (paid <= sent) return;
    var calDays = Math.round((paid - sent) / 86400000);
    paymentSpeeds.push(calDays);
    if (calDays === 0) sameDay++;
    else if (calDays <= 3) within3d++;
    else if (calDays <= 7) within7d++;
    else if (calDays <= 30) within30d++;
    else over30d++;
  });
  var avgPaymentSpeed = paymentSpeeds.length > 0 ? paymentSpeeds.reduce(function(a,b){return a+b;},0) / paymentSpeeds.length : 0;
  var medianPaymentSpeed = 0;
  if (paymentSpeeds.length > 0) {
    paymentSpeeds.sort(function(a,b){return a-b;});
    medianPaymentSpeed = paymentSpeeds[Math.floor(paymentSpeeds.length/2)];
  }
  var paymentSpeedPct = {
    sameDay: paymentSpeeds.length > 0 ? Math.round((sameDay/paymentSpeeds.length)*100) : 0,
    within3d: paymentSpeeds.length > 0 ? Math.round((within3d/paymentSpeeds.length)*100) : 0,
    within7d: paymentSpeeds.length > 0 ? Math.round((within7d/paymentSpeeds.length)*100) : 0,
    within30d: paymentSpeeds.length > 0 ? Math.round((within30d/paymentSpeeds.length)*100) : 0,
    over30d: paymentSpeeds.length > 0 ? Math.round((over30d/paymentSpeeds.length)*100) : 0
  };

  // Order line item analytics
  var itemSales = {}; var discountsApplied = 0; var discountTotal = 0;
  var taxTotal = 0; var serviceChargeTotal = 0;
  orders.forEach(function(o) {
    if (o.line_items) o.line_items.forEach(function(li) {
      var name = li.name || li.catalog_object_id || 'Unknown';
      if (!itemSales[name]) itemSales[name] = { count: 0, revenue: 0, qty: 0 };
      itemSales[name].count++;
      itemSales[name].qty += parseInt(li.quantity || '1');
      itemSales[name].revenue += sqCents(li.total_money);
    });
    if (o.discounts) o.discounts.forEach(function(disc) {
      discountsApplied++; discountTotal += sqCents(disc.applied_money);
    });
    if (o.taxes) o.taxes.forEach(function(t) { taxTotal += sqCents(t.applied_money); });
    if (o.service_charges) o.service_charges.forEach(function(sc) { serviceChargeTotal += sqCents(sc.total_money); });
  });
  var topItems = Object.entries(itemSales).sort(function(a,b){return b[1].revenue-a[1].revenue;}).slice(0,20);
  var topItemsByQty = Object.entries(itemSales).sort(function(a,b){return b[1].qty-a[1].qty;}).slice(0,20);

  // Refund analytics
  var refundTotal = 0; var refundReasons = {};
  refunds.forEach(function(r) {
    refundTotal += sqCents(r.amount_money);
    var reason = r.reason || 'No reason';
    refundReasons[reason] = (refundReasons[reason] || 0) + 1;
  });
  var refundRate = totalPaymentCount > 0 ? ((refunds.length / totalPaymentCount) * 100).toFixed(1) : '0';

  // Payout analytics
  var payoutTotal = 0; var payoutsByStatus = {};
  payouts.forEach(function(p) {
    payoutTotal += sqCents(p.amount);
    payoutsByStatus[p.status] = (payoutsByStatus[p.status] || 0) + 1;
  });

  // Shift/labor analytics
  var totalHoursWorked = 0; var shiftsByEmployee = {}; var totalBreakMins = 0;
  shifts.forEach(function(s) {
    var start = new Date(s.start_at); var end = s.end_at ? new Date(s.end_at) : new Date();
    var hours = (end - start) / 3600000;
    totalHoursWorked += hours;
    var emp = s.employee_id || s.team_member_id || 'unknown';
    if (!shiftsByEmployee[emp]) shiftsByEmployee[emp] = { hours: 0, shifts: 0, breaks: 0 };
    shiftsByEmployee[emp].hours += hours; shiftsByEmployee[emp].shifts++;
    if (s.breaks) s.breaks.forEach(function(b) {
      var bStart = new Date(b.start_at); var bEnd = b.end_at ? new Date(b.end_at) : new Date();
      var bMins = (bEnd - bStart) / 60000;
      totalBreakMins += bMins; shiftsByEmployee[emp].breaks += bMins;
    });
  });
  var laborCostEstimate = totalHoursWorked * 15; // rough est

  // MONTHLY REVENUE TRENDS (all-time since 2022)
  var monthlyRevenue = {}; var monthlyPaymentCount = {}; var monthlyCustomers = {};
  if (useOrders && completedOrders.length > 0) {
    completedOrders.forEach(function(o) {
      var month = (o.created_at || '').substring(0, 7);
      if (!month) return;
      monthlyRevenue[month] = (monthlyRevenue[month] || 0) + orderRev(o);
      monthlyPaymentCount[month] = (monthlyPaymentCount[month] || 0) + 1;
    });
  } else {
    completed.forEach(function(p) {
      var month = (p.created_at || '').substring(0, 7);
      if (!month) return;
      monthlyRevenue[month] = (monthlyRevenue[month] || 0) + sqCents(p.amount_money);
      monthlyPaymentCount[month] = (monthlyPaymentCount[month] || 0) + 1;
    });
  }
  customers.forEach(function(c) {
    var month = (c.created_at || '').substring(0, 7);
    if (month) monthlyCustomers[month] = (monthlyCustomers[month] || 0) + 1;
  });

  // YEARLY COMPARISONS
  var yearlyRevenue = {}; var yearlyPayments = {}; var yearlyCustomers = {};
  Object.keys(monthlyRevenue).forEach(function(m) {
    var y = m.substring(0, 4);
    yearlyRevenue[y] = (yearlyRevenue[y] || 0) + monthlyRevenue[m];
    yearlyPayments[y] = (yearlyPayments[y] || 0) + (monthlyPaymentCount[m] || 0);
  });
  Object.keys(monthlyCustomers).forEach(function(m) {
    var y = m.substring(0, 4);
    yearlyCustomers[y] = (yearlyCustomers[y] || 0) + monthlyCustomers[m];
  });

  // QUARTERLY
  var quarterlyRevenue = {};
  Object.keys(monthlyRevenue).forEach(function(m) {
    var y = m.substring(0, 4); var mo = parseInt(m.substring(5, 7));
    var q = y + '-Q' + (mo <= 3 ? '1' : mo <= 6 ? '2' : mo <= 9 ? '3' : '4');
    quarterlyRevenue[q] = (quarterlyRevenue[q] || 0) + monthlyRevenue[m];
  });

  var monthEntries = Object.entries(monthlyRevenue).sort(function(a, b) { return b[1] - a[1]; });
  var bestMonth = monthEntries.length > 0 ? monthEntries[0] : null;
  var worstMonth = monthEntries.length > 0 ? monthEntries[monthEntries.length - 1] : null;
  var monthlyAvgTicket = {};
  Object.keys(monthlyRevenue).forEach(function(m) { monthlyAvgTicket[m] = monthlyPaymentCount[m] > 0 ? Math.round(monthlyRevenue[m] / monthlyPaymentCount[m]) : 0; });

  // SEASONALITY
  var seasonality = {};
  Object.keys(monthlyRevenue).forEach(function(m) {
    var mo = m.substring(5, 7);
    if (!seasonality[mo]) seasonality[mo] = { total: 0, count: 0 };
    seasonality[mo].total += monthlyRevenue[m]; seasonality[mo].count++;
  });
  var seasonalAvg = {};
  Object.keys(seasonality).forEach(function(mo) { seasonalAvg[mo] = Math.round(seasonality[mo].total / seasonality[mo].count); });

  // REVENUE PROJECTIONS
  var currentYear = nowCT.getFullYear();
  var currentMonth = nowCT.getMonth() + 1; // 1-12
  var currentYearKey = String(currentYear);
  var ytdRevenue = yearlyRevenue[currentYearKey] || 0;
  
  // Calculate YoY growth rate from last 2 full years
  var lastYear = String(currentYear - 1);
  var twoYearsAgo = String(currentYear - 2);
  var yoyGrowthRate = 0;
  if (yearlyRevenue[twoYearsAgo] && yearlyRevenue[lastYear]) {
    yoyGrowthRate = (yearlyRevenue[lastYear] - yearlyRevenue[twoYearsAgo]) / yearlyRevenue[twoYearsAgo];
  }

  // Seasonal projection: use seasonal avg for remaining months
  var projectedRemaining = 0;
  var monthProjections = {};
  for (var pm = 1; pm <= 12; pm++) {
    var moKey = String(pm).padStart(2, '0');
    var monthYearKey = currentYearKey + '-' + moKey;
    if (pm < currentMonth) {
      // Past months â€” use actual
      monthProjections[moKey] = { actual: monthlyRevenue[monthYearKey] || 0, projected: false };
    } else if (pm === currentMonth) {
      // Current month â€” extrapolate from days elapsed
      var daysInMonth = new Date(currentYear, pm, 0).getDate();
      var dayOfMonth = nowCT.getDate();
      var currentMonthRev = monthlyRevenue[monthYearKey] || 0;
      var extrapolated = dayOfMonth > 0 ? (currentMonthRev / dayOfMonth) * daysInMonth : 0;
      monthProjections[moKey] = { actual: currentMonthRev, projected: true, estimate: Math.round(extrapolated) };
      projectedRemaining += Math.max(0, extrapolated - currentMonthRev);
    } else {
      // Future months â€” seasonal avg adjusted by YoY growth
      var seasonBase = seasonalAvg[moKey] || 0;
      var adjusted = Math.round(seasonBase * (1 + yoyGrowthRate));
      monthProjections[moKey] = { actual: 0, projected: true, estimate: adjusted };
      projectedRemaining += adjusted;
    }
  }
  var projectedFullYear = ytdRevenue + projectedRemaining;
  var lastYearTotal = yearlyRevenue[lastYear] || 0;
  var projectedGrowth = lastYearTotal > 0 ? Math.round(((projectedFullYear - lastYearTotal) / lastYearTotal) * 100) : 0;

  // Conservative projection (no growth adjustment)
  var conservativeRemaining = 0;
  for (var cm = currentMonth + 1; cm <= 12; cm++) {
    var cmoKey = String(cm).padStart(2, '0');
    conservativeRemaining += seasonalAvg[cmoKey] || 0;
  }
  // Add current month extrapolation
  var curMoKey = String(currentMonth).padStart(2, '0');
  var curMoActual = monthlyRevenue[currentYearKey + '-' + curMoKey] || 0;
  var curMoDays = new Date(currentYear, currentMonth, 0).getDate();
  var curDayOfMonth = nowCT.getDate();
  var curMoExtrapolated = curDayOfMonth > 0 ? (curMoActual / curDayOfMonth) * curMoDays : 0;
  conservativeRemaining += Math.max(0, curMoExtrapolated - curMoActual);
  var conservativeFullYear = ytdRevenue + conservativeRemaining;

  // Optimistic projection (using best year's seasonal pattern)
  var bestYearKey = Object.entries(yearlyRevenue).filter(function(e){return e[0]!==currentYearKey;}).sort(function(a,b){return b[1]-a[1];})[0];
  var optimisticFullYear = bestYearKey ? Math.round(bestYearKey[1] * (1 + Math.max(0, yoyGrowthRate))) : projectedFullYear;

  // CUSTOMER LIFETIME VALUE
  var customerPayments = {};
  if (useOrders && completedOrders.length > 0) {
    completedOrders.forEach(function(o) {
      var cid = o.customer_id || (o.tenders && o.tenders[0] ? o.tenders[0].customer_id : null);
      if (cid) {
        if (!customerPayments[cid]) customerPayments[cid] = { total: 0, count: 0, first: o.created_at, last: o.created_at };
        customerPayments[cid].total += orderRev(o);
        customerPayments[cid].count++;
        if (o.created_at < customerPayments[cid].first) customerPayments[cid].first = o.created_at;
        if (o.created_at > customerPayments[cid].last) customerPayments[cid].last = o.created_at;
      }
    });
  } else {
    completed.forEach(function(p) {
      if (p.customer_id) {
        if (!customerPayments[p.customer_id]) customerPayments[p.customer_id] = { total: 0, count: 0, first: p.created_at, last: p.created_at };
        customerPayments[p.customer_id].total += sqCents(p.amount_money);
        customerPayments[p.customer_id].count++;
        if (p.created_at < customerPayments[p.customer_id].first) customerPayments[p.customer_id].first = p.created_at;
        if (p.created_at > customerPayments[p.customer_id].last) customerPayments[p.customer_id].last = p.created_at;
      }
    });
  }
  var topSpenders = Object.entries(customerPayments).sort(function(a, b) { return b[1].total - a[1].total; }).slice(0, 20);
  var repeatCustomers = Object.values(customerPayments).filter(function(c) { return c.count > 1; }).length;
  var avgLTV = Object.values(customerPayments).length > 0 ? Object.values(customerPayments).reduce(function(s, c) { return s + c.total; }, 0) / Object.values(customerPayments).length : 0;

  // Catalog breakdown
  var items = catalog.filter(function(c){return c.type==='ITEM';});
  var variations = catalog.filter(function(c){return c.type==='ITEM_VARIATION';});
  var categories = catalog.filter(function(c){return c.type==='CATEGORY';});
  var discounts = catalog.filter(function(c){return c.type==='DISCOUNT';});
  var taxes = catalog.filter(function(c){return c.type==='TAX';});
  var modifiers = catalog.filter(function(c){return c.type==='MODIFIER'||c.type==='MODIFIER_LIST';});

  // Gift card analytics
  var gcActive = (snap.giftCards||[]).filter(function(g){return g.state==='ACTIVE';});
  var gcTotalBalance = gcActive.reduce(function(s,g){return s+sqCents(g.balance_money);},0);
  var subsActive = (snap.subscriptions||[]).filter(function(s){return s.status==='ACTIVE';});
  var subsCancelled = (snap.subscriptions||[]).filter(function(s){return s.status==='CANCELED';});

  return {
    revenue: {
      today: todayRev, week: weekRev, prevWeek: prevWeekRev, month30d: month30dRev,
      gross: grossRev, net: netRev, tips: totalTips, fees: totalFees,
      weekGrowth: weekGrowth, avgTicket: avgTicket, medianTicket: medianTicket,
      maxTicket: maxTicket, minTicket: minTicket,
      avgDailyRev: Object.keys(paymentsByDay).length > 0 ? totalRev / Object.keys(paymentsByDay).length : 0,
      allTimeTotal: grossRev
    },
    trends: {
      monthlyRevenue: monthlyRevenue, monthlyPaymentCount: monthlyPaymentCount,
      monthlyCustomers: monthlyCustomers, monthlyAvgTicket: monthlyAvgTicket,
      yearlyRevenue: yearlyRevenue, yearlyPayments: yearlyPayments, yearlyCustomers: yearlyCustomers,
      quarterlyRevenue: quarterlyRevenue,
      bestMonth: bestMonth, worstMonth: worstMonth,
      seasonalAvg: seasonalAvg,
      totalMonths: Object.keys(monthlyRevenue).length,
      projections: {
        ytdRevenue: ytdRevenue,
        projectedFullYear: Math.round(projectedFullYear),
        conservativeFullYear: Math.round(conservativeFullYear),
        optimisticFullYear: Math.round(optimisticFullYear),
        lastYearTotal: lastYearTotal,
        projectedGrowth: projectedGrowth,
        yoyGrowthRate: Math.round(yoyGrowthRate * 100),
        monthProjections: monthProjections
      }
    },
    customerInsights: {
      repeatCustomers: repeatCustomers,
      repeatRate: Object.keys(customerPayments).length > 0 ? Math.round((repeatCustomers / Object.keys(customerPayments).length) * 100) : 0,
      avgLTV: avgLTV,
      topSpenders: topSpenders.map(function(e) { return { id: e[0], total: e[1].total, visits: e[1].count }; }),
      uniquePayingCustomers: Object.keys(customerPayments).length
    },
    payments: {
      total: useOrders ? orders.length : payments.length, completed: useOrders ? completedOrders.length : completed.length,
      failed: useOrders ? orders.filter(function(o){return o.state==='CANCELED';}).length : payments.filter(function(p){return p.status==='FAILED';}).length,
      cancelled: useOrders ? 0 : payments.filter(function(p){return p.status==='CANCELED';}).length,
      pending: useOrders ? orders.filter(function(o){return o.state==='OPEN'||o.state==='DRAFT';}).length : payments.filter(function(p){return p.status==='PENDING';}).length,
      dataSource: useOrders ? 'orders' : 'payments',
      byDay: paymentsByDay, byHour: paymentsByHour, byDayOfWeek: paymentsByDayOfWeek,
      byMethod: paymentsByMethod, byLocation: paymentsByLocation,
      peakHour: peakHour ? peakHour[0] + ':00' : 'â€”', peakDay: peakDay ? peakDay[0] : 'â€”',
      slowHour: slowHour ? slowHour[0] + ':00' : 'â€”',
      tipsByEmployee: tipsByEmployee
    },
    customers: {
      total: customers.length, new30d: newCustomers30d, new7d: newCustomers7d,
      withEmail: custWithEmail, withPhone: custWithPhone, withNote: custWithNote,
      emailCaptureRate: customers.length > 0 ? Math.round((custWithEmail/customers.length)*100) : 0,
      groups: (snap.custGroups||[]).length, segments: (snap.custSegments||[]).length
    },
    invoices: {
      total: invoices.length, unpaid: unpaidInv.length, overdue: overdueInv.length,
      paid: paidInv.length, cancelled: cancelledInv.length,
      unpaidTotal: unpaidTotal, overdueTotal: overdueTotal,
      collectionRate: invoices.length > 0 ? Math.round((paidInv.length / invoices.length)*100) : 0,
      turnaround: { avg: avgInvoiceTurnaround, avgFormatted: fmtBizHours(avgInvoiceTurnaround), median: medianInvoiceTurnaround, medianFormatted: fmtBizHours(medianInvoiceTurnaround), fastest: fmtBizHours(fastestInvoice), slowest: fmtBizHours(slowestInvoice), sampleSize: invoiceTurnarounds.length },
      paymentSpeed: { avgDays: Math.round(avgPaymentSpeed*10)/10, medianDays: medianPaymentSpeed, sameDay: paymentSpeedPct.sameDay, within3d: paymentSpeedPct.within3d, within7d: paymentSpeedPct.within7d, within30d: paymentSpeedPct.within30d, over30d: paymentSpeedPct.over30d, sampleSize: paymentSpeeds.length }
    },
    orders: {
      total: orders.length, topItemsByRevenue: topItems, topItemsByQty: topItemsByQty,
      discountsApplied: discountsApplied, discountTotal: discountTotal,
      taxCollected: taxTotal, serviceCharges: serviceChargeTotal,
      uniqueItems: Object.keys(itemSales).length
    },
    refunds: { count: refunds.length, total: refundTotal, rate: refundRate, reasons: refundReasons },
    disputes: {
      total: disputes.length,
      open: disputes.filter(function(d){return d.state!=='WON'&&d.state!=='LOST'&&d.state!=='ACCEPTED';}).length,
      won: disputes.filter(function(d){return d.state==='WON';}).length,
      lost: disputes.filter(function(d){return d.state==='LOST';}).length
    },
    payouts: { count: payouts.length, total: payoutTotal, byStatus: payoutsByStatus },
    labor: {
      totalHoursWorked: Math.round(totalHoursWorked * 10) / 10,
      totalShifts: shifts.length, totalBreakMins: Math.round(totalBreakMins),
      byEmployee: shiftsByEmployee, laborCostEstimate: laborCostEstimate,
      avgShiftLength: shifts.length > 0 ? Math.round((totalHoursWorked / shifts.length)*10)/10 : 0
    },
    catalog: { items: items.length, variations: variations.length, categories: categories.length, discounts: discounts.length, taxes: taxes.length, modifiers: modifiers.length },
    giftCards: { active: gcActive.length, totalBalance: gcTotalBalance, total: (snap.giftCards||[]).length },
    subscriptions: { active: subsActive.length, cancelled: subsCancelled.length, total: (snap.subscriptions||[]).length },
    loyalty: snap.loyalty ? { programName: snap.loyalty.terminology ? snap.loyalty.terminology.one : 'Points', accounts: (snap.loyaltyAccounts||[]).length } : null,
    bookings: { total: (snap.bookings||[]).length },
    devices: { total: (snap.devices||[]).length },
    cashDrawers: { total: (snap.cashDrawers||[]).length },
    team: { total: team.length, active: team.filter(function(t){return t.status==='ACTIVE';}).length },
    locations: (snap.locations||[]).length
  };
}

// ==============================
// VOICE AUTH SYSTEM
// ==============================
// Passphrases â€” change these anytime. Case-insensitive, fuzzy matched.
var voiceUsers = [
  { name: 'Trace', passphrase: 'jarvis activate', role: 'owner', access: 'all' },
  { name: 'Rubait', passphrase: 'discord open', role: 'manager', access: 'discord' },
];
var voiceSessions = {};

function getVoiceSession(req) {
  var cookies = (req.headers.cookie || '').split(';');
  for (var i = 0; i < cookies.length; i++) {
    var parts = cookies[i].trim().split('=');
    if (parts[0] === 'voice_token') {
      var token = decodeURIComponent(parts[1]);
      if (voiceSessions[token] && (Date.now() - voiceSessions[token].created < 86400000 * 7)) {
        return voiceSessions[token];
      }
    }
  }
  if (req.query && req.query.vt && voiceSessions[req.query.vt]) {
    var s = voiceSessions[req.query.vt];
    if (Date.now() - s.created < 86400000 * 7) return s;
  }
  return null;
}

function requireAuth(roles) {
  // roles = 'all' (any logged in), 'owner', 'discord', or array like ['owner','manager']
  return function(req, res, next) {
    var session = getVoiceSession(req);
    if (!session) return res.redirect('/login?r=' + encodeURIComponent(req.originalUrl));
    if (roles === 'all') return next();
    var allowed = Array.isArray(roles) ? roles : [roles];
    // owner always has access to everything
    if (session.access === 'all') return next();
    if (allowed.includes(session.access) || allowed.includes(session.role)) return next();
    return res.redirect('/login?r=' + encodeURIComponent(req.originalUrl) + '&denied=1');
  };
}

function matchPassphrase(spoken, target) {
  var s = (spoken || '').toLowerCase().replace(/[^a-z0-9 ]/g, '').trim();
  var t = (target || '').toLowerCase().trim();
  if (s === t) return true;
  // Fuzzy: check if spoken contains all words from target
  var tWords = t.split(/\s+/);
  var matched = tWords.filter(function(w) { return s.includes(w); });
  return matched.length === tWords.length && matched.length > 0;
}

async function discordFetch(endpoint) {
  if (!DISCORD_BOT_TOKEN) return null;
  var res = await fetch('https://discord.com/api/v10' + endpoint, {
    headers: { 'Authorization': 'Bot ' + DISCORD_BOT_TOKEN }
  });
  if (!res.ok) { console.log("Discord API error: " + res.status + " on " + endpoint); return null; }
  return res.json();
}

async function discordGetChannels() {
  if (!DISCORD_GUILD_ID) return [];
  if (discordCache.channels && (Date.now() - discordCache.time) < 300000) return discordCache.channels;
  var channels = await discordFetch('/guilds/' + DISCORD_GUILD_ID + '/channels');
  if (!channels) return [];
  var textChannels = channels.filter(function(c) { return c.type === 0; });
  discordCache.channels = textChannels;
  discordCache.time = Date.now();
  return textChannels;
}

async function discordGetMessages(channelId, limit) {
  limit = limit || 50;
  var cacheKey = channelId + '_' + limit;
  if (discordCache.messages[cacheKey] && (Date.now() - (discordCache.messages[cacheKey].time || 0)) < 120000) {
    return discordCache.messages[cacheKey].data;
  }
  var msgs = await discordFetch('/channels/' + channelId + '/messages?limit=' + limit);
  if (!msgs) return [];
  discordCache.messages[cacheKey] = { data: msgs, time: Date.now() };
  return msgs;
}

async function discordGetAllRecent(limit) {
  limit = limit || 30;
  var channels = await discordGetChannels();
  var all = [];
  for (var i = 0; i < channels.length; i++) {
    var msgs = await discordGetMessages(channels[i].id, limit);
    msgs.forEach(function(m) {
      all.push({
        channel: channels[i].name,
        channelId: channels[i].id,
        author: m.author ? m.author.username : 'unknown',
        content: m.content || '',
        timestamp: m.timestamp,
        attachments: (m.attachments || []).length,
        reactions: (m.reactions || []).map(function(r) { return r.emoji.name + ':' + r.count; }),
      });
    });
  }
  all.sort(function(a, b) { return new Date(b.timestamp) - new Date(a.timestamp); });
  return all;
}

async function discordSendMessage(channelId, content) {
  if (!DISCORD_BOT_TOKEN || !channelId || !content) return null;
  try {
    var res = await fetch('https://discord.com/api/v10/channels/' + channelId + '/messages', {
      method: 'POST',
      headers: { 'Authorization': 'Bot ' + DISCORD_BOT_TOKEN, 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: content })
    });
    if (!res.ok) { console.log("Discord send error: " + res.status); return null; }
    return await res.json();
  } catch (err) { console.log("Discord send failed:", err.message); return null; }
}

async function discordGetQuietChannels() {
  var channels = await discordGetChannels();
  var quiet = [];
  var now = Date.now();
  for (var i = 0; i < channels.length; i++) {
    var msgs = await discordGetMessages(channels[i].id, 1);
    var lastMsg = msgs && msgs.length > 0 ? msgs[0] : null;
    var lastTime = lastMsg ? new Date(lastMsg.timestamp).getTime() : 0;
    var hoursSince = lastTime ? Math.round((now - lastTime) / 3600000) : 999;
    quiet.push({
      id: channels[i].id, name: channels[i].name,
      lastMessage: lastMsg ? { author: lastMsg.author ? lastMsg.author.username : '?', content: (lastMsg.content || '').substring(0, 100), time: lastMsg.timestamp } : null,
      hoursSince: hoursSince, isQuiet: hoursSince >= 24
    });
  }
  quiet.sort(function(a, b) { return b.hoursSince - a.hoursSince; });
  return quiet;
}

async function discordAnalyzeResponseRates() {
  var channels = await discordGetChannels();
  var people = {};
  var RESPONSE_WINDOW = 7200000;
  for (var i = 0; i < channels.length; i++) {
    var msgs = await discordGetMessages(channels[i].id, 100);
    if (!msgs || msgs.length === 0) continue;
    msgs.sort(function(a, b) { return new Date(a.timestamp) - new Date(b.timestamp); });
    for (var j = 0; j < msgs.length; j++) {
      var m = msgs[j]; var author = m.author ? m.author.username : 'unknown'; var mTime = new Date(m.timestamp).getTime();
      if (!people[author]) people[author] = { name:author,totalMessages:0,responsesGiven:0,responsesReceived:0,unanswered:0,totalResponseTimeMs:0,fastestResponseMs:Infinity,slowestResponseMs:0,conversationsStarted:0,mentionsSent:0,mentionsReceived:0,activeChannels:{},hourActivity:{},dayActivity:{} };
      people[author].totalMessages++;
      people[author].activeChannels[channels[i].name] = (people[author].activeChannels[channels[i].name] || 0) + 1;
      var msgDate = new Date(m.timestamp);
      people[author].hourActivity[msgDate.getHours()] = (people[author].hourActivity[msgDate.getHours()] || 0) + 1;
      var dayName = msgDate.toLocaleDateString('en-US', { weekday: 'short' });
      people[author].dayActivity[dayName] = (people[author].dayActivity[dayName] || 0) + 1;
      var isResponse = false;
      for (var k = j - 1; k >= 0; k--) {
        var prev = msgs[k]; var prevAuthor = prev.author ? prev.author.username : 'unknown';
        var prevTime = new Date(prev.timestamp).getTime();
        if (mTime - prevTime > RESPONSE_WINDOW) break;
        if (prevAuthor === author) continue;
        isResponse = true; var responseTime = mTime - prevTime;
        people[author].responsesGiven++; people[author].totalResponseTimeMs += responseTime;
        if (responseTime < people[author].fastestResponseMs) people[author].fastestResponseMs = responseTime;
        if (responseTime > people[author].slowestResponseMs) people[author].slowestResponseMs = responseTime;
        if (people[prevAuthor]) people[prevAuthor].responsesReceived++;
        break;
      }
      if (!isResponse) { var hadPrior = false; for (var k2 = j-1; k2>=0; k2--) { if (mTime - new Date(msgs[k2].timestamp).getTime() > RESPONSE_WINDOW) break; if ((msgs[k2].author?msgs[k2].author.username:'')!==author){hadPrior=true;break;} } if (!hadPrior) people[author].conversationsStarted++; }
    }
  }
  var results = Object.values(people).map(function(p) {
    var avgMs = p.responsesGiven > 0 ? Math.round(p.totalResponseTimeMs / p.responsesGiven) : 0;
    var rate = p.totalMessages > 0 ? Math.round((p.responsesGiven / Math.max(p.totalMessages, 1)) * 100) : 0;
    var score = Math.min(p.totalMessages/20,1)*30 + (rate/100)*30 + (avgMs>0?Math.max(0,(1-avgMs/3600000))*20:0) + Math.min(Object.keys(p.activeChannels).length/5,1)*10 + Math.min(p.conversationsStarted/5,1)*10;
    var peakH = Object.entries(p.hourActivity).sort(function(a,b){return b[1]-a[1];})[0];
    var peakD = Object.entries(p.dayActivity).sort(function(a,b){return b[1]-a[1];})[0];
    return { name:p.name, totalMessages:p.totalMessages, responsesGiven:p.responsesGiven, responsesReceived:p.responsesReceived, responseRate:rate, avgResponseTime:avgMs, avgResponseTimeFormatted:avgMs>0?formatDuration(avgMs):'â€”', fastestResponse:p.fastestResponseMs<Infinity?formatDuration(p.fastestResponseMs):'â€”', slowestResponse:p.slowestResponseMs>0?formatDuration(p.slowestResponseMs):'â€”', unanswered:p.unanswered, conversationsStarted:p.conversationsStarted, activeChannels:Object.keys(p.activeChannels).length, peakHour:peakH?peakH[0]+':00':'â€”', peakDay:peakD?peakD[0]:'â€”', engagementScore:Math.round(score) };
  });
  results.sort(function(a, b) { return b.engagementScore - a.engagementScore; });
  return results;
}

function formatDuration(ms) {
  if (ms < 60000) return Math.round(ms / 1000) + 's';
  if (ms < 3600000) return Math.round(ms / 60000) + 'm';
  if (ms < 86400000) return (ms / 3600000).toFixed(1) + 'h';
  return (ms / 86400000).toFixed(1) + 'd';
}

/* ===========================
   TWILIO CLIENT
=========================== */

var twilioClient = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN
);

var TWILIO_NUMBER = '+18884310969';
var MY_NUMBER = '+18167392734';
console.log("Twilio Ready");

/* ===========================
   CLAUDE API KEY
=========================== */

var CLAUDE_API_KEY = process.env.CLAUDE_API_KEY;
if (!CLAUDE_API_KEY) {
  console.error("Missing CLAUDE_API_KEY");
}
console.log("Claude API Ready");

/* ===========================
   GMAIL OAUTH2 SETUP
=========================== */

var GMAIL_CLIENT_ID = process.env.GMAIL_CLIENT_ID;
var GMAIL_CLIENT_SECRET = process.env.GMAIL_CLIENT_SECRET;
var GMAIL_REDIRECT_URI = process.env.GMAIL_REDIRECT_URI || 'https://lifeos-jarvis.onrender.com/gmail/callback';

// Store tokens for multiple Gmail accounts { email: { access_token, refresh_token, expiry } }
var gmailTokensFile = '/tmp/gmail-tokens.json';
var gmailTokens = {};

// Load saved tokens
try {
  if (process.env.GMAIL_TOKENS) {
    gmailTokens = JSON.parse(process.env.GMAIL_TOKENS);
    console.log("Gmail: Loaded " + Object.keys(gmailTokens).length + " account(s)");
  } else if (fs.existsSync(gmailTokensFile)) {
    gmailTokens = JSON.parse(fs.readFileSync(gmailTokensFile, 'utf8'));
    console.log("Gmail: Loaded " + Object.keys(gmailTokens).length + " account(s) from file");
  }
} catch (e) {
  console.log("Gmail: No saved tokens found");
}

function saveGmailTokens() {
  try { fs.writeFileSync(gmailTokensFile, JSON.stringify(gmailTokens)); } catch (e) {}
}

function createGmailOAuth2Client(tokens) {
  var oauth2 = new google.auth.OAuth2(GMAIL_CLIENT_ID, GMAIL_CLIENT_SECRET, GMAIL_REDIRECT_URI);
  if (tokens) oauth2.setCredentials(tokens);
  return oauth2;
}

if (GMAIL_CLIENT_ID) {
  console.log("Gmail OAuth Ready");
} else {
  console.log("Gmail: No GMAIL_CLIENT_ID set â€” Gmail features disabled");
}

/* ===========================
   In-memory conversation history
=========================== */

var callHistory = {};

/* ===========================
   HELPERS
=========================== */

async function getAllTabNames() {
  var res = await sheets.spreadsheets.get({
    spreadsheetId: SPREADSHEET_ID,
    fields: 'sheets.properties.title',
  });
  return res.data.sheets.map(function(s) { return s.properties.title; });
}

async function getTabData(tabName) {
  try {
    var res = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: "'" + tabName + "'!A1:ZZ",
    });
    var rows = res.data.values || [];
    if (rows.length === 0) return { tab: tabName, headers: [], rowCount: 0, rows: [] };
    return { tab: tabName, headers: rows[0], rowCount: rows.length - 1, rows: rows.slice(1) };
  } catch (err) {
    return { tab: tabName, error: err.message, headers: [], rowCount: 0, rows: [] };
  }
}

async function getTabRowCount(tabName) {
  try {
    var res = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: "'" + tabName + "'!A:A",
    });
    return res.data.values ? res.data.values.length - 1 : 0;
  } catch (err) {
    return 0;
  }
}

/* ===========================
   HTML escaping helper â€” prevents XSS from sheet data
=========================== */

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

/* ===========================
   Build Life OS context for Claude â€” PERSONAL FOCUS
   Cached for 10 minutes to speed up responses
=========================== */

var contextCache = { data: null, time: 0 };

async function buildLifeOSContext() {
  // Return cache if less than 10 minutes old
  if (contextCache.data && (Date.now() - contextCache.time) < 600000) {
    console.log("Context from cache: " + contextCache.data.length + " chars");
    return contextCache.data;
  }

  var context = "";

  // Fetch all personal data in parallel for speed
  var results = await Promise.allSettled([
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Trace_Identity_Profile'!A1:A20" }),
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Daily_Log'!A1:J20" }),
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Wins'!A1:D20" }),
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Gratitude_Memory'!A1:B10" }),
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Dashboard'!A1:K25" }),
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Chat_Pattern_Lifecycle'!A1:F30" }),
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Chat_Insights_Dating'!A1:D7" }),
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Daily_Questions'!A1:G20" }),
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Dating_Log'!A1:H20" }),
    sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Ultimate_Debt_Tracker_Advanced'!A1:E25" }),
  ]);

  // Identity Profile
  if (results[0].status === 'fulfilled') {
    var rows = results[0].value.data.values || [];
    if (rows.length > 0) {
      context += "WHO TRACE IS:\n";
      rows.slice(0, 15).forEach(function(r) { if (r[0]) context += r[0] + "\n"; });
      context += "\n";
    }
  }

  // Daily Log â€” recent entries
  if (results[1].status === 'fulfilled') {
    var rows = results[1].value.data.values || [];
    if (rows.length > 1) {
      var headers = rows[0];
      context += "RECENT DAILY LOGS:\n";
      rows.slice(Math.max(1, rows.length - 5)).forEach(function(r) {
        var parts = [];
        for (var i = 0; i < headers.length; i++) {
          if (r[i] && r[i] !== '0' && r[i] !== '') parts.push(headers[i] + ': ' + r[i]);
        }
        if (parts.length > 0) context += "  " + parts.join(', ') + "\n";
      });
      context += "\n";
    }
  }

  // Recent Wins
  if (results[2].status === 'fulfilled') {
    var rows = results[2].value.data.values || [];
    if (rows.length > 1) {
      context += "RECENT WINS:\n";
      rows.slice(Math.max(1, rows.length - 7)).forEach(function(r) {
        if (r[1]) context += "  " + (r[0] || '') + ": " + r[1] + " (" + (r[2] || '') + ")\n";
      });
      context += "\n";
    } else {
      context += "WINS: No wins logged yet. This needs to change.\n\n";
    }
  }

  // Recent Gratitude
  if (results[3].status === 'fulfilled') {
    var rows = results[3].value.data.values || [];
    if (rows.length > 1) {
      context += "RECENT GRATITUDE:\n";
      rows.slice(1, 6).forEach(function(r) {
        if (r[0]) context += "  " + r[0] + " (" + (r[1] || '') + ")\n";
      });
      context += "\n";
    }
  }

  // Screen Time
  if (results[4].status === 'fulfilled') {
    var rows = results[4].value.data.values || [];
    if (rows.length > 5) {
      context += "SCREEN TIME:\n";
      // Find the daily total
      if (rows[1] && rows[1][0]) context += "  Daily average: " + rows[1][0] + " hours\n";
      // Top apps
      for (var a = 6; a < Math.min(rows.length, 16); a++) {
        if (rows[a] && rows[a][0] && rows[a][4]) {
          context += "  " + rows[a][0] + ": " + rows[a][4] + "h/day (" + (rows[a][5] || 'uncategorized') + ")\n";
        }
      }
      context += "\n";
    }
  }

  // Dating/Relationship Patterns
  if (results[5].status === 'fulfilled') {
    var rows = results[5].value.data.values || [];
    if (rows.length > 1) {
      context += "ACTIVE LIFE PATTERNS:\n";
      rows.slice(1).forEach(function(r) {
        if (r[0] && r[5] && r[5].toUpperCase() === 'ACTIVE') {
          context += "  " + r[0] + " (" + (r[1] || 'General') + ") â€” ACTIVE\n";
        }
      });
      context += "\n";
    }
  }

  // Dating Insights
  if (results[6].status === 'fulfilled') {
    var rows = results[6].value.data.values || [];
    if (rows.length > 1) {
      context += "DATING PATTERNS:\n";
      var latest = rows[rows.length - 1];
      if (latest && latest[2]) context += "  Latest insight: " + latest[2].substring(0, 300) + "\n";
      context += "\n";
    }
  }

  // Recent Daily Questions answers
  if (results[7].status === 'fulfilled') {
    var rows = results[7].value.data.values || [];
    if (rows.length > 1) {
      context += "RECENT SELF-REFLECTION:\n";
      rows.slice(Math.max(1, rows.length - 5)).forEach(function(r) {
        if (r[2] && r[3]) context += "  Q: " + r[2].substring(0, 80) + " â†’ A: " + r[3].substring(0, 100) + "\n";
      });
      context += "\n";
    }
  }

  // Dating Log
  if (results[8].status === 'fulfilled') {
    var rows = results[8].value.data.values || [];
    if (rows.length > 1) {
      context += "RECENT DATING ACTIVITY:\n";
      rows.slice(Math.max(1, rows.length - 3)).forEach(function(r) {
        if (r[1]) context += "  " + (r[0] || '') + " â€” " + (r[1] || '') + " (" + (r[2] || '') + "): " + (r[3] || '') + "\n";
      });
      context += "\n";
    }
  }

  // Debt summary (brief)
  if (results[9].status === 'fulfilled') {
    var rows = results[9].value.data.values || [];
    if (rows.length > 1) {
      var totalDebt = 0;
      rows.slice(1).forEach(function(r) {
        var bal = parseFloat((r[4] || r[3] || '0').toString().replace(/[$,]/g, ''));
        if (!isNaN(bal)) totalDebt += bal;
      });
      context += "FINANCIAL SNAPSHOT: ~$" + Math.round(totalDebt).toLocaleString() + " total debt across " + (rows.length - 1) + " accounts\n\n";
    }
  }

  console.log("Context built: " + context.length + " chars");
  
  // Add calendar (not cached as long since events change)
  try {
    var calContext = await buildCalendarContext(2);
    context += calContext;
  } catch (e) {}

  contextCache = { data: context, time: Date.now() };
  return context;
}

/* ===========================

/* ===========================
   SHEET REGISTRY â€” All 12 source spreadsheets + descriptions
   The server reads these DIRECTLY. No Combined tab needed.
=========================== */

var SOURCE_SHEETS = [
  { id: "1LlfhcfiQdXStpV1vRrZzSmaEjyTvd1nrk5sqnhxsRYU", name: "Main CRM", desc: "Core CRM with 18+ city tabs. Each tab has customer bookings: name, phone, email, address, equipment, tech, status. Updated daily by receptionists. Also has Tech Numbers, Return Customers, Promo Replies, Diagnostic SMS, Manual Entry." },
  { id: "1kl72v4yIJrpD3U5pCYwtCiDhtdFZ_n4wUvZDxhPeIQk", name: "Receptionist Data", desc: "Receptionist performance: booking rates, call logs per person. Matrix views for 2025-2026 showing monthly/weekly/daily booking %. Individual tabs for each receptionist (Ray, Muaaz, Rayan, Rubait, Salma, etc.) with call-by-call logs." },
  { id: "1SDOqTxEMG8f81DtLwIu9ovz9mnxP_9Lpn6PH7OFBfBs", name: "Top Volume Cities", desc: "SEO market research: 70+ city tabs across 10+ states. Monthly Google search volume for 'small engine repair' from 2023-2025. Population data. Used for expansion planning." },
  { id: "1fj6SZZx5YtLMU8ldsAEZ1yffK0rHhFQoFir0GAOCFNU", name: "US Audit", desc: "Nationwide SEO audit â€” all 50 states. Top 15-35 cities per state with population and monthly search volume 2023-2025." },
  { id: "1ZITxT57ue2qSAbTUFRE_k1fJzKicPAO-BZMDSJOhJ7A", name: "SEO Competitive Analysis", desc: "All 50 states sorted by search volume high-to-low. Multiple keywords per city: small engine repair, lawn mower repair, etc. Includes keyword difficulty and CPC (cost per click)." },
  { id: "1CJ9nn7l_PAwXPVSXmUogXejt46bsimrJi5iLQFQuo3o", name: "GMB Reviews", desc: "Google My Business reviews tracker. Reviews for Quick & Mobile Wildwood Small (7 reviews), Mobile Wildwood Mower Repair (44 reviews), Wildwood FL (22 reviews). GMB listing links per city. Discord reviews feed." },
  { id: "1KIulnemtmR6QpRbzEflNjvVOElNszuL9zClKhcbmOow", name: "Active Locations & HR", desc: "Employee roster (~990 rows), tech hiring pipeline (~1123 applicants), active locations with assigned techs (33 locations), 90-day evaluations. Core HR + operations hub." },
  { id: "19ndlgop-P0KLwv6PiG8sPdtj83jKH3vlDHf5AgjgmC8", name: "Payment Gap Analysis", desc: "Tracks avg hours between job completion and payment received. Monthly comparisons and weekly backend data. Cash flow health indicator." },
  { id: "1CiH2u18yy-stL7jym7RCinqjy5C3HJpCg9GyYQv2TEw", name: "Backup & Canceled", desc: "Backup copy of all booked jobs and separate tab for canceled jobs. Used by Tookan automation for data recovery and cancellation tracking." },
  { id: "1pIEAYT5bJff7HxrjEuQnbJf8TxZ9361wta7fwUAjZ70", name: "Additional Data", desc: "Additional business data sheet." },
  { id: "1A8oUmigHV6DsYcWF4hlDBC5KQDIHWMOh1Is6poCacx4", name: "Source Sheet 9", desc: "Additional business data â€” awaiting description." },
  { id: "1vnNEZjdhhkFNpNkDXRINpS55Zfysb_MzuFLhjVw6A2g", name: "Source Sheet 10", desc: "Additional business data â€” awaiting description." },
  { id: "1ZshCanMloF8uUlH39s2ZxvpCuvxjJQAONaSnN7590WA", name: "Source Sheet 11", desc: "Additional business data â€” awaiting description." },
  { id: "1IK-T9O_-ozg7n-Fecn1DodEMuznbvVW-i0ClzCPfuOI", name: "Source Sheet 12", desc: "Additional business data â€” awaiting description." },
];

var SKIP_TABS = [
  "combined","combined_all","tech numbers","mapping","dropdown","mail list",
  "sample","test","location sheets","manual entry record",
  "diagnostic sms reply","promotion customers reply",
  "sheet1","location unavailable","return customers","unorganized customers",
  "main","receptionist names"
];

var HEADER_MAP = {
  "date called in":"dateIn","date and time":"dateIn","date and time ":"dateIn","column 1":"dateIn",
  "first name":"firstName","first name ":"firstName",
  "last name":"lastName","last name ":"lastName",
  "start time":"startTime","start time ":"startTime",
  "end time":"endTime"," end time":"endTime",
  "date customer is available":"serviceDate","time (3 hour window)":"startTime",
  "phone number":"phone","phone number ":"phone","phone":"phone",
  "email":"email","email id":"email",
  "address":"address","city":"city","state":"state","zip":"zip",
  "type equipment":"equipType","type equipment ":"equipType",
  "type of equipment":"equipType","type of equipment ":"equipType",
  "what brand of equipment":"brand",
  "issue with equipment":"issue","issue with equipment ":"issue",
  "receptionist names":"receptionist","receptionist names ":"receptionist",
  "notes tech needs to know":"notes","notes tech needs to know ":"notes",
  "status":"status","when booked":"whenBooked",
  "return/paid?":"returnPaid",
  "tooka status and time":"tookanStatus","tookan status":"tookanStatus","tookan status and time":"tookanStatus",
  "posted date and time":"postedDate","posted flag":"postedFlag",
  "tookan job id":"tookanJobId","tech":"tech","technician":"tech","tech name":"tech","assigned tech":"tech","assigned to":"tech","technician name":"tech","transfer":"locationTab"
};

/* ===========================
   TOOKAN API INTEGRATION â€” Real-time dispatch & job tracking
=========================== */

var TOOKAN_API_KEY = process.env.TOOKAN_API_KEY || '5365698cf64403111e4c723e15106e471be0c5fd28df793c5e1808c3';
var TOOKAN_ENDPOINTS = {
  getJobDetails: 'https://api.tookanapp.com/v2/get_job_details',
  getAllAgents: 'https://api.tookanapp.com/v2/get_all_agents',
  getAllTasks: 'https://api.tookanapp.com/v2/get_all_tasks',
};

var TOOKAN_LOCATIONS = [
  { key:'kansasCityRocky', sheet:'Kansas City, MO Rocky', teamId:1680920, fleetId:2118700 },
  { key:'lovelandA', sheet:'Loveland, CO Justin Turner', teamId:1696802, fleetId:2108961 },
  { key:'detroit', sheet:'Detroit, MI', teamId:1681499, fleetId:2071027 },
  { key:'houstonB', sheet:'Houston, TX Victor Romero', teamId:1681497, fleetId:2125711 },
  { key:'wilmingtonNC', sheet:'Wilmington NC Brandi Butler', teamId:1702410, fleetId:2089324 },
  { key:'tampa', sheet:'Tampa, Fl', teamId:1689395, fleetId:2115390 },
  { key:'poinciana', sheet:'Poinciana, FL', teamId:1682259, fleetId:2072205 },
  { key:'brownsville', sheet:'Brownsville, TX', teamId:1681494, fleetId:2107061 },
  { key:'elkhart', sheet:'Elkhart, IN', teamId:1695278, fleetId:2101066 },
  { key:'kansasCityMain', sheet:'Kansas City, MO', teamId:1680920, fleetId:2071029 },
  { key:'siouxFallsSD', sheet:'Sioux Falls, SD Ashton Hawley', teamId:1681507, fleetId:2165914 },
  { key:'sanAntonioTX', sheet:'San Antonio, TX Robert Hummer', teamId:1681496, fleetId:2166157 },
  { key:'capeCoralA', sheet:'Cape Coral, FL Michael Scutti', teamId:1681492, fleetId:2107763 },
  { key:'capeCoralB', sheet:'Cape Coral, FL Talon Twiford', teamId:1681492, fleetId:2071009 },
  { key:'lehighAcresFL', sheet:'Lehigh Acres, FL Gunnar Jacobs', teamId:1704072, fleetId:2119751 },
  { key:'fortWayneIN', sheet:'Fort Wayne IN Corey Roberson', teamId:1688549, fleetId:2162203 },
  { key:'sarasotaFL', sheet:'Sarasota, FL Alexander Fernandez', teamId:1683936, fleetId:2149334 },
  { key:'poincianaFL2', sheet:'Poinciana, FL Trent Kennedy', teamId:1682259, fleetId:2072205 },
  { key:'renoNV', sheet:'Reno, NV  Maxx Fritts', teamId:1714273, fleetId:2142347 },
];

var tookanCache = { data: null, time: 0 };

// Fetch all tasks from Tookan API for a date range
async function fetchTookanTasks(startDate, endDate, teamId) {
  try {
    var payload = {
      api_key: TOOKAN_API_KEY,
      job_type: 2,
      job_status: '',
      start_date: startDate,
      end_date: endDate,
      is_pagination: 0,
    };
    if (teamId) payload.team_id = teamId;
    var response = await fetch(TOOKAN_ENDPOINTS.getAllTasks, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    var data = await response.json();
    if (data.status === 200) {
      var tasks = Array.isArray(data.data) ? data.data : (data.data || []);
      return tasks;
    }
    console.log("Tookan getAllTasks status: " + data.status + " msg: " + (data.message || '') + " team:" + (teamId || 'none'));
    return [];
  } catch (e) {
    console.log("Tookan getAllTasks error: " + e.message);
    return [];
  }
}

// Fetch job details for specific job IDs
async function fetchTookanJobDetails(jobIds) {
  if (!jobIds || jobIds.length === 0) return [];
  try {
    var response = await fetch(TOOKAN_ENDPOINTS.getJobDetails, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        api_key: TOOKAN_API_KEY,
        job_ids: jobIds.map(Number),
      }),
    });
    var data = await response.json();
    if (data.status === 200) {
      return Array.isArray(data.data) ? data.data : (data.data.tasks || []);
    }
    return [];
  } catch (e) {
    console.log("Tookan getJobDetails error: " + e.message);
    return [];
  }
}

// Fetch all agents/techs from Tookan
async function fetchTookanAgents(teamId) {
  try {
    var response = await fetch(TOOKAN_ENDPOINTS.getAllAgents, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        api_key: TOOKAN_API_KEY,
        team_id: teamId,
      }),
    });
    var data = await response.json();
    if (data.status === 200) {
      return Array.isArray(data.data) ? data.data : (data.data.fleets || data.data.agents || []);
    }
    return [];
  } catch (e) {
    console.log("Tookan getAgents error: " + e.message);
    return [];
  }
}

// Derive readable status from Tookan job data
function deriveTookanStatus(job) {
  if (!job) return 'Unknown';
  var label = (job.job_status_name || job.job_status_text || '').toString().trim();
  if (label) return label.replace(/Accepted/i, 'Acknowledged');
  var nz = function(s) { return !!s && s !== '0000-00-00 00:00:00'; };
  if (nz(job.completed_datetime)) return 'Completed';
  if (nz(job.acknowledged_datetime)) return 'Acknowledged';
  if (nz(job.started_datetime)) return 'Started';
  if (nz(job.arrived_datetime)) return 'Arrived';
  if (job.fleet_id && Number(job.fleet_id) !== 0) return 'Assigned';
  if (typeof job.job_status === 'number') {
    return ({ 0: 'Assigned', 1: 'Started', 2: 'Completed', 3: 'Failed', 6: 'Unassigned', 9: 'Deleted' })[job.job_status] || 'Unknown (' + job.job_status + ')';
  }
  return 'Unknown';
}

// Build full Tookan summary â€” cached for 10 minutes
async function buildTookanContext() {
  if (tookanCache.data && (Date.now() - tookanCache.time) < 600000) {
    return tookanCache.data;
  }

  console.log("Fetching Tookan data...");
  var result = {
    totalTasks: 0, completed: 0, assigned: 0, acknowledged: 0, started: 0,
    failed: 0, unassigned: 0, cancelled: 0, deleted: 0,
    tasksByLocation: {}, tasksByTech: {}, tasksByStatus: {},
    todayTasks: [], recentCompleted: [], agents: [], mapTasks: [], upcomingTasks: [],
    // Analytics
    todayTotal: 0, todayCompleted: 0, todayAssigned: 0, todayAcknowledged: 0,
    yesterdayTotal: 0, yesterdayCompleted: 0,
    agentsBusy: 0, agentsFree: 0, agentsInactive: 0,
    avgCompletionMinutes: 0, onTimeRate: 0, taskEfficiency: 0,
    weeklyTasks: [], dailyTasks: {},
  };

  var completionTimes = [];
  try {
    var endDate = new Date();
    var startDate = new Date();
    startDate.setDate(startDate.getDate() - 90);

    // ====== Strategy 1: Get job IDs from CRM data, then batch fetch details ======
    var allTasks = [];
    var crmJobIds = [];

    // Collect Tookan Job IDs from CRM (already loaded by buildBusinessContext)
    if (global.bizMetrics && global.bizMetrics.allJobRows) {
      global.bizMetrics.allJobRows.forEach(function(job) {
        var jid = (job.tookanJobId || '').toString().trim();
        if (jid && jid.length > 3 && /^\d+$/.test(jid)) {
          crmJobIds.push(parseInt(jid));
        }
      });
    }

    // Deduplicate job IDs
    crmJobIds = Array.from(new Set(crmJobIds));
    console.log("Tookan: Found " + crmJobIds.length + " job IDs from CRM");

    if (crmJobIds.length > 0) {
      // Batch fetch in groups of 50 (same as your Tookan script)
      for (var bi = 0; bi < crmJobIds.length; bi += 50) {
        var batch = crmJobIds.slice(bi, bi + 50);
        try {
          var batchResults = await fetchTookanJobDetails(batch);
          allTasks = allTasks.concat(batchResults);
          // Small delay between batches to avoid rate limiting
          if (bi + 50 < crmJobIds.length) {
            await new Promise(function(r) { setTimeout(r, 300); });
          }
        } catch (be) {
          console.log("Tookan batch error at offset " + bi + ": " + be.message);
        }
      }
      console.log("Tookan: " + allTasks.length + " tasks fetched via get_job_details");
    }

    // ====== Strategy 2 (fallback): Try get_all_tasks per team if no CRM data ======
    if (allTasks.length === 0) {
      console.log("Tookan: No CRM job IDs, trying get_all_tasks per team...");
      // Get unique team IDs
      var uniqueTeamIds = {};
      TOOKAN_LOCATIONS.forEach(function(loc) { uniqueTeamIds[loc.teamId] = true; });
      var teamList = Object.keys(uniqueTeamIds);

      // Tookan API only allows 31-day max range
      // Fetch last 30 days + next 30 days per team
      var dateChunks = [
        { label: 'future', start: 0, end: 30 },    // Today â†’ +30 days
        { label: 'recent', start: -30, end: 0 },    // -30 days â†’ Today
        { label: 'mid', start: -60, end: -30 },     // -60 â†’ -30 days
        { label: 'old', start: -90, end: -60 },     // -90 â†’ -60 days
      ];

      var seenJobIds = {};
      for (var ti2 = 0; ti2 < teamList.length; ti2++) {
        var tid = parseInt(teamList[ti2]);
        for (var ci = 0; ci < dateChunks.length; ci++) {
          var ch = dateChunks[ci];
          var cStart = new Date(); cStart.setDate(cStart.getDate() + ch.start);
          var cEnd = new Date(); cEnd.setDate(cEnd.getDate() + ch.end);
          var cStartStr = cStart.toISOString().split('T')[0] + ' 00:00:00';
          var cEndStr = cEnd.toISOString().split('T')[0] + ' 23:59:59';
          try {
            var chunkTasks = await fetchTookanTasks(cStartStr, cEndStr, tid);
            // Deduplicate across teams/chunks
            var newCount = 0;
            chunkTasks.forEach(function(t) {
              var jid = t.job_id || t.jobid || '';
              if (!seenJobIds[jid]) {
                seenJobIds[jid] = true;
                allTasks.push(t);
                newCount++;
              }
            });
            if (newCount > 0) console.log("Tookan team " + tid + " " + ch.label + ": +" + newCount + " tasks");
            await new Promise(function(r) { setTimeout(r, 200); });
          } catch (ce) {
            console.log("Tookan team " + tid + " " + ch.label + " error: " + ce.message);
          }
        }
      }

      // If team-level fetch also empty, try without team_id as last resort
      if (allTasks.length === 0) {
        console.log("Tookan: Team fetch empty, trying without team_id...");
        var now2 = new Date();
        var ago30 = new Date(); ago30.setDate(ago30.getDate() - 30);
        var fwd30 = new Date(); fwd30.setDate(fwd30.getDate() + 30);
        try {
          var recentAll = await fetchTookanTasks(ago30.toISOString().split('T')[0] + ' 00:00:00', fwd30.toISOString().split('T')[0] + ' 23:59:59');
          console.log("Tookan no-team fetch: " + recentAll.length + " tasks");
          allTasks = allTasks.concat(recentAll);
        } catch (e2) {}
      }

      console.log("Tookan total from get_all_tasks: " + allTasks.length + " tasks");
    }

    result.totalTasks = allTasks.length;
    console.log("Tookan total: " + allTasks.length + " tasks");

    var todayStr = endDate.toISOString().split('T')[0];
    var yesterdayDate = new Date(endDate);
    yesterdayDate.setDate(yesterdayDate.getDate() - 1);
    var yesterdayStr = yesterdayDate.toISOString().split('T')[0];

    for (var t = 0; t < allTasks.length; t++) {
      var task = allTasks[t];
      var status = deriveTookanStatus(task);
      var statusLower = status.toLowerCase();

      // Count by status
      result.tasksByStatus[status] = (result.tasksByStatus[status] || 0) + 1;
      if (statusLower.includes('completed')) result.completed++;
      else if (statusLower.includes('acknowledged')) result.acknowledged++;
      else if (statusLower.includes('assigned')) result.assigned++;
      else if (statusLower.includes('started') || statusLower.includes('arrived')) result.started++;
      else if (statusLower.includes('failed') || statusLower.includes('cancel')) result.cancelled++;
      else if (statusLower.includes('unassigned')) result.unassigned++;
      else if (statusLower.includes('deleted')) result.deleted++;

      // Daily tracking
      var taskDate = (task.job_pickup_datetime || task.created_at || '').toString().split(' ')[0];
      result.dailyTasks[taskDate] = (result.dailyTasks[taskDate] || 0) + 1;
      if (taskDate === todayStr) {
        result.todayTotal++;
        if (statusLower.includes('completed')) result.todayCompleted++;
        if (statusLower.includes('assigned')) result.todayAssigned++;
        if (statusLower.includes('acknowledged')) result.todayAcknowledged++;
      }
      if (taskDate === yesterdayStr) {
        result.yesterdayTotal++;
        if (statusLower.includes('completed')) result.yesterdayCompleted++;
      }

      // Completion time tracking
      if (statusLower.includes('completed') && task.completed_datetime && task.job_pickup_datetime) {
        var pickupTime = new Date(task.job_pickup_datetime).getTime();
        var completeTime = new Date(task.completed_datetime).getTime();
        if (pickupTime > 0 && completeTime > pickupTime) {
          var mins = (completeTime - pickupTime) / 60000;
          if (mins > 0 && mins < 1440) completionTimes.push(mins);
        }
      }

      // Tech tracking
      var agentName = (task.fleet_name || task.agent_name || '').toString().trim();
      if (agentName) {
        if (!result.tasksByTech[agentName]) result.tasksByTech[agentName] = { total: 0, completed: 0, assigned: 0, started: 0, failed: 0 };
        result.tasksByTech[agentName].total++;
        if (statusLower.includes('completed')) result.tasksByTech[agentName].completed++;
        else if (statusLower.includes('assigned') || statusLower.includes('acknowledged')) result.tasksByTech[agentName].assigned++;
        else if (statusLower.includes('started') || statusLower.includes('arrived')) result.tasksByTech[agentName].started++;
        else if (statusLower.includes('failed')) result.tasksByTech[agentName].failed++;
      }

      // Location tracking
      var address = (task.job_address || task.customer_address || '').toString();
      var city = address.split(',').length >= 2 ? address.split(',').slice(-2, -1)[0].trim() : '';
      if (city) {
        result.tasksByLocation[city] = (result.tasksByLocation[city] || 0) + 1;
      }

      // Today's tasks
      var taskDate = (task.job_pickup_datetime || task.created_at || '').toString().split(' ')[0];
      if (taskDate === todayStr) {
        result.todayTasks.push({
          jobId: task.job_id, customer: task.customer_username || task.customer_name || 'Unknown',
          address: address.substring(0, 80), status: status, tech: agentName,
          phone: task.customer_phone || '',
          lat: parseFloat(task.job_latitude || task.latitude || 0),
          lng: parseFloat(task.job_longitude || task.longitude || 0),
          pickupTime: (task.job_pickup_datetime || '').toString(),
        });
      }

      // Upcoming tasks (future dates)
      if (taskDate > todayStr && result.upcomingTasks.length < 50) {
        result.upcomingTasks.push({
          jobId: task.job_id, customer: task.customer_username || task.customer_name || 'Unknown',
          address: address.substring(0, 80), status: status, tech: agentName,
          phone: task.customer_phone || '', date: taskDate,
          lat: parseFloat(task.job_latitude || task.latitude || 0),
          lng: parseFloat(task.job_longitude || task.longitude || 0),
          pickupTime: (task.job_pickup_datetime || '').toString(),
        });
      }

      // Collect tasks with coordinates for map (last 30 days only to keep it manageable)
      var taskLat = parseFloat(task.job_latitude || task.latitude || 0);
      var taskLng = parseFloat(task.job_longitude || task.longitude || 0);
      if (taskLat !== 0 && taskLng !== 0 && result.mapTasks.length < 500) {
        result.mapTasks.push({
          jobId: task.job_id, customer: (task.customer_username || task.customer_name || 'Unknown').substring(0, 30),
          lat: taskLat, lng: taskLng, status: status, tech: agentName,
          address: address.substring(0, 60), date: taskDate,
        });
      }

      // Recent completed
      if (statusLower.includes('completed') && result.recentCompleted.length < 20) {
        result.recentCompleted.push({
          jobId: task.job_id, customer: task.customer_username || 'Unknown',
          tech: agentName, completedAt: task.completed_datetime || '',
          address: address.substring(0, 60),
          lat: parseFloat(task.job_latitude || task.latitude || 0),
          lng: parseFloat(task.job_longitude || task.longitude || 0),
        });
      }
    }

    // Fetch agents from unique team IDs
    var teamIds = {};
    TOOKAN_LOCATIONS.forEach(function(loc) { teamIds[loc.teamId] = true; });
    var uniqueTeams = Object.keys(teamIds);

    for (var ti = 0; ti < uniqueTeams.length; ti++) {
      try {
        var agents = await fetchTookanAgents(parseInt(uniqueTeams[ti]));
        agents.forEach(function(a) {
          result.agents.push({
            name: a.fleet_name || a.username || [a.first_name, a.last_name].filter(Boolean).join(' '),
            fleetId: a.fleet_id || a.id, teamId: uniqueTeams[ti],
            status: a.is_available ? 'Available' : 'Unavailable',
            phone: a.phone || '',
          });
        });
        if (ti < uniqueTeams.length - 1) await new Promise(function(r) { setTimeout(r, 500); });
      } catch (ae) {}
    }

  } catch (e) {
    console.log("Tookan fetch error: " + e.message);
  }

  // ====== Compute Analytics ======
  // Agent status counts
  result.agents.forEach(function(a) {
    if (a.status === 'Available') result.agentsFree++;
    else result.agentsInactive++;
  });
  // Count busy agents (agents with active/started tasks today)
  var busyAgents = {};
  (result.todayTasks || []).forEach(function(t) {
    var st = (t.status || '').toLowerCase();
    if (t.tech && (st.includes('started') || st.includes('arrived') || st.includes('acknowledged'))) {
      busyAgents[t.tech] = true;
    }
  });
  result.agentsBusy = Object.keys(busyAgents).length;
  result.agentsFree = Math.max(0, result.agentsFree - result.agentsBusy);

  // Avg completion time
  if (completionTimes.length > 0) {
    result.avgCompletionMinutes = Math.round(completionTimes.reduce(function(a, b) { return a + b; }, 0) / completionTimes.length);
  }

  // Task efficiency = completed / (completed + failed + cancelled) * 100
  var effTotal = result.completed + result.cancelled;
  result.taskEfficiency = effTotal > 0 ? Math.round((result.completed / effTotal) * 10000) / 100 : 0;

  // On-time rate (completed within scheduled window)
  result.onTimeRate = result.completed > 0 ? Math.round((result.completed / Math.max(1, result.completed + result.started)) * 10000) / 100 : 0;

  // Weekly task trend (last 7 days)
  var weekDays = [];
  for (var wd = 6; wd >= 0; wd--) {
    var d2 = new Date();
    d2.setDate(d2.getDate() - wd);
    var dStr = d2.toISOString().split('T')[0];
    var dayName = d2.toLocaleDateString('en-US', { weekday: 'short' });
    weekDays.push({ date: dStr, day: dayName, count: result.dailyTasks[dStr] || 0 });
  }
  result.weeklyTasks = weekDays;

  // Task change % vs yesterday
  result.taskChangeVsYesterday = result.yesterdayTotal > 0 ? Math.round(((result.todayTotal - result.yesterdayTotal) / result.yesterdayTotal) * 100) : 0;

  // Store globally for dashboard
  global.tookanData = result;
  tookanCache = { data: result, time: Date.now() };
  console.log("Tookan data cached: " + result.totalTasks + " tasks, " + result.completed + " completed, " + result.agents.length + " agents");
  return result;
}

/* ===========================
   Build Business CRM Context for Claude
   Reads ALL 12 source sheets directly â€” no Combined tab dependency
   Uses batchGet for speed, caches for 30 minutes
=========================== */

var businessCache = { data: null, time: 0 };

async function buildBusinessContext() {
  // Return cache if less than 30 minutes old
  if (businessCache.data && (Date.now() - businessCache.time) < 1800000) {
    return businessCache.data;
  }

  console.log("Building business context from " + SOURCE_SHEETS.length + " source sheets...");
  var context = "WILDWOOD SMALL ENGINE REPAIR â€” CRM DATA:\n\n";

  // ====== PHASE 1: Read all job data from source sheets ======
  var allJobRows = [];
  var allOtherSections = {};
  var sheetMetadata = {};
  var sheetsRead = 0;
  var tabsRead = 0;
  var errors = [];

  for (var si = 0; si < SOURCE_SHEETS.length; si++) {
    var src = SOURCE_SHEETS[si];
    try {
      // Step 1: Get tab list for this sheet
      var meta = await sheets.spreadsheets.get({
        spreadsheetId: src.id,
        fields: 'sheets.properties.title,sheets.properties.sheetId'
      });
      var tabNames = meta.data.sheets.map(function(s) { return s.properties.title; });
      sheetMetadata[src.name] = { tabs: tabNames, id: src.id, desc: src.desc };

      // Step 2: Build ranges for all non-skip tabs
      var dataRanges = [];
      for (var tn = 0; tn < tabNames.length; tn++) {
        if (SKIP_TABS.indexOf(tabNames[tn].toLowerCase().trim()) < 0) {
          dataRanges.push("'" + tabNames[tn] + "'!A1:AE");
        }
      }

      if (dataRanges.length === 0) continue;

      // Step 3: Batch read ALL tabs in ONE API call
      var batchRes = await sheets.spreadsheets.values.batchGet({
        spreadsheetId: src.id,
        ranges: dataRanges,
      });

      sheetsRead++;
      var valueRanges = batchRes.data.valueRanges || [];

      for (var vr = 0; vr < valueRanges.length; vr++) {
        var rows = valueRanges[vr].values || [];
        if (rows.length < 2) continue;

        var headers = rows[0];
        var tabRange = valueRanges[vr].range || '';
        var tabNameFromRange = tabRange.split('!')[0].replace(/'/g, '');
        tabsRead++;

        // Check if this is a job/customer tab (has "First Name" header)
        var headerLookup = {};
        var isJobTab = false;
        for (var h = 0; h < headers.length; h++) {
          var hKey = (headers[h] || '').toString().trim().toLowerCase();
          if (HEADER_MAP[hKey]) headerLookup[HEADER_MAP[hKey]] = h;
          if (hKey === 'first name' || hKey === 'first name ') isJobTab = true;
        }

        if (isJobTab) {
          // Process as job/customer data
          for (var jr = 1; jr < rows.length; jr++) {
            var jRow = rows[jr];
            var fName = headerLookup.firstName !== undefined ? (jRow[headerLookup.firstName] || '').toString().trim() : '';
            var phn = headerLookup.phone !== undefined ? (jRow[headerLookup.phone] || '').toString().trim() : '';
            if (!fName && !phn) continue; // skip empty rows

            // Build standardized row object
            var job = {
              dateIn: headerLookup.dateIn !== undefined ? (jRow[headerLookup.dateIn] || '').toString() : '',
              firstName: fName,
              lastName: headerLookup.lastName !== undefined ? (jRow[headerLookup.lastName] || '').toString().trim() : '',
              startTime: headerLookup.startTime !== undefined ? (jRow[headerLookup.startTime] || '').toString() : '',
              endTime: headerLookup.endTime !== undefined ? (jRow[headerLookup.endTime] || '').toString() : '',
              serviceDate: headerLookup.serviceDate !== undefined ? (jRow[headerLookup.serviceDate] || '').toString() : '',
              phone: phn,
              email: headerLookup.email !== undefined ? (jRow[headerLookup.email] || '').toString().trim() : '',
              address: headerLookup.address !== undefined ? (jRow[headerLookup.address] || '').toString().trim() : '',
              city: headerLookup.city !== undefined ? (jRow[headerLookup.city] || '').toString().trim() : '',
              state: headerLookup.state !== undefined ? (jRow[headerLookup.state] || '').toString().trim() : '',
              zip: headerLookup.zip !== undefined ? (jRow[headerLookup.zip] || '').toString().trim() : '',
              equipType: headerLookup.equipType !== undefined ? (jRow[headerLookup.equipType] || '').toString().trim() : '',
              brand: headerLookup.brand !== undefined ? (jRow[headerLookup.brand] || '').toString().trim() : '',
              issue: headerLookup.issue !== undefined ? (jRow[headerLookup.issue] || '').toString().trim() : '',
              receptionist: headerLookup.receptionist !== undefined ? (jRow[headerLookup.receptionist] || '').toString().trim() : '',
              notes: headerLookup.notes !== undefined ? (jRow[headerLookup.notes] || '').toString().trim() : '',
              status: headerLookup.status !== undefined ? (jRow[headerLookup.status] || '').toString().toLowerCase().trim() : '',
              tech: headerLookup.tech !== undefined ? (jRow[headerLookup.tech] || '').toString().trim() : '',
              tookanStatus: headerLookup.tookanStatus !== undefined ? (jRow[headerLookup.tookanStatus] || '').toString().toLowerCase().trim() : '',
              tookanJobId: headerLookup.tookanJobId !== undefined ? (jRow[headerLookup.tookanJobId] || '').toString().trim() : '',
              locationTab: tabNameFromRange,
            };
            allJobRows.push(job);
          }
        } else {
          // Store as non-job data for AI context
          var sectionKey = src.name + ' / ' + tabNameFromRange;
          var sectionRows = [];
          for (var or2 = 0; or2 < Math.min(rows.length, 35); or2++) {
            var rowStr = rows[or2].map(function(c) { return (c || '').toString().trim(); }).filter(function(c) { return c; }).join(' | ');
            if (rowStr) sectionRows.push(rowStr);
          }
          if (sectionRows.length > 0) {
            allOtherSections[sectionKey] = { rows: sectionRows, totalRows: rows.length - 1 };
          }
        }
      }

      // Delay between sheets to stay under API quota (60 reads/min)
      if (si < SOURCE_SHEETS.length - 1) {
        await new Promise(function(r) { setTimeout(r, 1500); });
      }

    } catch (e) {
      errors.push(src.name + ': ' + e.message);
      console.log("Error reading " + src.name + ": " + e.message);
    }
  }

  console.log("Source sheets: read " + sheetsRead + " sheets, " + tabsRead + " tabs, " + allJobRows.length + " job rows (pre-dedup)");
  if (errors.length > 0) console.log("Read errors: " + errors.join('; '));

  // ====== DEDUPLICATION â€” prevents double-counting from Backup/Canceled sheets ======
  var seen = {};
  var uniqueJobs = [];
  for (var di = 0; di < allJobRows.length; di++) {
    var dj = allJobRows[di];
    // Create unique key from phone + first name + date called in
    var dedupKey = (dj.phone || '').replace(/\D/g, '') + '|' + (dj.firstName || '').toLowerCase().trim() + '|' + (dj.dateIn || '').toString().substring(0, 10);
    if (dedupKey === '||') { uniqueJobs.push(dj); continue; } // keep rows with no identifiers
    if (!seen[dedupKey]) {
      seen[dedupKey] = true;
      uniqueJobs.push(dj);
    }
  }
  console.log("Dedup: " + allJobRows.length + " â†’ " + uniqueJobs.length + " unique calls");
  allJobRows = uniqueJobs;

  // ====== FALLBACK: If source read failed, try Combined tab ======
  if (allJobRows.length < 10) {
    console.log("Source read got " + allJobRows.length + " rows, trying Combined fallback...");
    try {
      var combinedRes = await sheets.spreadsheets.values.get({
        spreadsheetId: BUSINESS_SPREADSHEET_ID,
        range: "'Combined'!A1:Z",
      });
      var cRows = combinedRes.data.values || [];
      if (cRows.length > 1) {
        for (var cr = 1; cr < cRows.length; cr++) {
          var cRow = cRows[cr];
          if (!cRow[1] && !cRow[6]) continue;
          allJobRows.push({
            dateIn: (cRow[0] || '').toString(), firstName: (cRow[1] || '').toString().trim(),
            lastName: (cRow[2] || '').toString().trim(), startTime: (cRow[3] || '').toString(),
            endTime: (cRow[4] || '').toString(), serviceDate: (cRow[5] || '').toString(),
            phone: (cRow[6] || '').toString(), email: (cRow[7] || '').toString().trim(),
            address: (cRow[8] || '').toString().trim(), city: (cRow[9] || '').toString().trim(),
            state: (cRow[10] || '').toString().trim(), zip: (cRow[11] || '').toString(),
            equipType: (cRow[12] || '').toString().trim(), brand: (cRow[13] || '').toString().trim(),
            issue: (cRow[14] || '').toString().trim(), receptionist: (cRow[15] || '').toString().trim(),
            notes: (cRow[16] || '').toString().trim(), status: (cRow[17] || '').toString().toLowerCase().trim(),
            tech: (cRow[23] || '').toString().trim(), tookanStatus: (cRow[21] || '').toString().toLowerCase().trim(),
            locationTab: (cRow[24] || '').toString().trim(),
          });
        }
        console.log("Combined fallback: " + allJobRows.length + " rows");
      }
    } catch(fe) { console.log("Combined fallback failed: " + fe.message); }
  }

  if (allJobRows.length === 0) {
    businessCache = { data: context + "No CRM data found. Check that service account has access to source spreadsheets.\n", time: Date.now() };
    return businessCache.data;
  }

  // ====== PHASE 2: Process all job data (same logic as before) ======
  var totalBooked = 0, totalCancelled = 0, totalCompleted = 0, totalReturn = 0, totalAssigned = 0;
  var todayBookings = [], recentBookings = [], needsReschedule = [];
  var locationStats = {}, techStats = {}, equipStats = {}, brandStats = {};
  var monthlyCalls = {}, weeklyCalls = 0;
  var monthlyCallsByTab = {}; // Per-location monthly tracking for individual Fibonacci
  var monthlyCallsByCity = {}; // Per-city monthly tracking (actual city names for charts)
  var bookingToServiceDays = [];
  var seasonalData = {};
  var today = new Date();
  var todayStr = today.toISOString().split('T')[0];
  var thisMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
  var lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
  var lastMonthStr = lastMonth.getFullYear() + '-' + String(lastMonth.getMonth() + 1).padStart(2, '0');
  var weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay()); weekStart.setHours(0,0,0,0);
  var newLocationsThisMonth = {};
  var totalLeads = allJobRows.length;

  // Location normalizer â€” merges "Missouri" â†’ "MO", filters junk entries
  var STATE_ABBREVS = {
    'alabama':'AL','alaska':'AK','arizona':'AZ','arkansas':'AR','california':'CA',
    'colorado':'CO','connecticut':'CT','delaware':'DE','florida':'FL','georgia':'GA',
    'hawaii':'HI','idaho':'ID','illinois':'IL','indiana':'IN','iowa':'IA',
    'kansas':'KS','kentucky':'KY','louisiana':'LA','maine':'ME','maryland':'MD',
    'massachusetts':'MA','michigan':'MI','minnesota':'MN','mississippi':'MS','missouri':'MO',
    'montana':'MT','nebraska':'NE','nevada':'NV','new hampshire':'NH','new jersey':'NJ',
    'new mexico':'NM','new york':'NY','north carolina':'NC','north dakota':'ND','ohio':'OH',
    'oklahoma':'OK','oregon':'OR','pennsylvania':'PA','rhode island':'RI','south carolina':'SC',
    'south dakota':'SD','tennessee':'TN','texas':'TX','utah':'UT','vermont':'VT',
    'virginia':'VA','washington':'WA','west virginia':'WV','wisconsin':'WI','wyoming':'WY',
    'district of columbia':'DC',
  };
  var JUNK_LOCATIONS = [
    'master database','check back with us','out of range','sent diy','n/a','paid',
    'backup','wrong number','we dont work on this','cancelled','canceled','buy parts',
    'customer fixed equipment','location unavailable','return customers','unorganized',
    'test','sample','manual entry','promo','diagnostic','tech numbers','do not service',
    'no answer','voicemail','duplicate','transfer','not in service area','outside area',
    'too far','declined','refused','no show','spam','solicitor',
  ];
  function normalizeLocation(city, state, tabName) {
    var c = (city || '').toString().trim();
    var s = (state || '').toString().trim();
    if (!c && !s) {
      // Try to extract from tab name
      if (tabName) {
        var tabParts = tabName.split(',');
        if (tabParts.length >= 2) {
          c = tabParts[0].trim();
          s = tabParts[1].trim().split(' ')[0].trim();
        }
      }
      if (!c) return '';
    }
    // Normalize state: full name â†’ abbreviation
    var sLower = s.toLowerCase().trim();
    if (STATE_ABBREVS[sLower]) s = STATE_ABBREVS[sLower];
    // Clean state to just 2-letter code
    s = s.replace(/[^A-Za-z]/g, '').toUpperCase();
    if (s.length > 2) {
      // Try matching first word
      var stateWords = (state || '').toLowerCase().trim();
      if (STATE_ABBREVS[stateWords]) s = STATE_ABBREVS[stateWords];
      else s = s.substring(0, 2);
    }
    // Clean city
    c = c.replace(/[^A-Za-z\s\.\-\']/g, '').trim();
    c = c.split(' ').map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase(); }).join(' ');
    if (!c) return '';
    // Check junk
    var combined = (c + ' ' + s).toLowerCase();
    for (var ji = 0; ji < JUNK_LOCATIONS.length; ji++) {
      if (combined.includes(JUNK_LOCATIONS[ji])) return '';
    }
    return s ? c + ', ' + s : c;
  }

  for (var r = 0; r < allJobRows.length; r++) {
    var job = allJobRows[r];
    var fullName = (job.firstName + ' ' + job.lastName).trim();
    if (!fullName || fullName === ' ') continue;

    var location = normalizeLocation(job.city, job.state, job.locationTab);
    var status = job.status;
    var equipType = job.equipType;
    var brand = job.brand;
    var tech = job.tech;
    var createdAt = job.dateIn;
    var serviceDate = job.serviceDate;
    var issue = job.issue;

    // Status parsing â€” based on actual CRM columns:
    //   Status col (18): "Booked", "Cancelled by Customer", "return", or EMPTY
    //   Tookan Status col (22): "Completed", "Assigned", "Acknowledged", "Unassigned"
    //   Posted Flag col (28): "DONE" = posted to Tookan (NOT job completion)
    var tookanSt = job.tookanStatus || '';
    var isBooked = status === 'booked';
    var isCancelled = status.includes('cancel');
    var isCompleted = tookanSt.includes('completed') || tookanSt.includes('successful') || status.includes('completed') || status.includes('done') || status.includes('finished') || status.includes('paid') || status.includes('serviced');
    var isAssigned = tookanSt.includes('assigned') || tookanSt.includes('acknowledged');
    var isReturn = status.includes('return');
    var hasStatus = status.length > 0 || tookanSt.length > 0;
    var needsResched = status.includes('reschedul') || (status.includes('need') && status.includes('book'));

    if (isBooked) totalBooked++;
    if (isCancelled) totalCancelled++;
    if (isCompleted) totalCompleted++;
    if (isReturn) totalReturn++;
    if (isAssigned) totalAssigned++;
    if (needsResched) needsReschedule.push({ name: fullName, location: location, phone: job.phone });

    // Location stats
    if (location && location.length > 2) {
      if (!locationStats[location]) locationStats[location] = { booked: 0, completed: 0, cancelled: 0, total: 0 };
      locationStats[location].total++;
      if (isBooked) locationStats[location].booked++;
      if (isCompleted) locationStats[location].completed++;
      if (isCancelled) locationStats[location].cancelled++;
    }

    // Equipment normalization
    var equipNorm = equipType;
    if (equipType) {
      var eqLow = equipType.toLowerCase();
      if (eqLow.includes('snow')) equipNorm = 'Snow Blower';
      else if (eqLow.includes('riding') || eqLow.includes('tractor')) equipNorm = 'Riding Mower';
      else if (eqLow.includes('push')) equipNorm = 'Push Mower';
      else if (eqLow.includes('zero')) equipNorm = 'Zero Turn';
      else if (eqLow.includes('generator')) equipNorm = 'Generator';
      else if (eqLow.includes('chain') || eqLow.includes('saw')) equipNorm = 'Chainsaw';
      else if (eqLow.includes('trim') || eqLow.includes('weed')) equipNorm = 'Trimmer';
      else if (eqLow.includes('lawn') || eqLow.includes('mower')) equipNorm = 'Mower';
      else equipNorm = equipType.substring(0, 30);
      equipStats[equipNorm] = (equipStats[equipNorm] || 0) + 1;
    }

    // Tech stats
    if (tech && tech.length > 1) {
      if (!techStats[tech]) techStats[tech] = {
        total: 0, completed: 0, cancelled: 0, revenue: 0,
        locations: {}, equipment: {}, brands: {},
        recentJobs: [], todayJobs: [], thisWeekJobs: 0, thisMonthJobs: 0,
        avgResponseDays: [], returnCustomers: 0, firstSeen: null, lastSeen: null,
      };
      var ts = techStats[tech];
      ts.total++;
      if (isCompleted) ts.completed++;
      if (isCancelled) ts.cancelled++;
      if (isReturn) ts.returnCustomers++;
      if (location) ts.locations[location] = (ts.locations[location] || 0) + 1;
      if (equipNorm) ts.equipment[equipNorm] = (ts.equipment[equipNorm] || 0) + 1;
      if (brand && brand.length > 1 && brand.toLowerCase() !== 'not specified') {
        var bKey = brand.split(' ')[0].trim();
        bKey = bKey.charAt(0).toUpperCase() + bKey.slice(1).toLowerCase();
        ts.brands[bKey] = (ts.brands[bKey] || 0) + 1;
      }
      if (createdAt) {
        try {
          var tDate = new Date(createdAt);
          if (!isNaN(tDate.getTime())) {
            if (!ts.firstSeen || tDate < ts.firstSeen) ts.firstSeen = tDate;
            if (!ts.lastSeen || tDate > ts.lastSeen) ts.lastSeen = tDate;
            var tMonthKey = tDate.getFullYear() + '-' + String(tDate.getMonth() + 1).padStart(2, '0');
            if (tMonthKey === thisMonth) ts.thisMonthJobs++;
            if (tDate >= weekStart) ts.thisWeekJobs++;
          }
        } catch(e){}
      }
      if (createdAt && serviceDate) {
        try {
          var rc1 = new Date(createdAt), rc2 = new Date(serviceDate);
          if (!isNaN(rc1.getTime()) && !isNaN(rc2.getTime())) {
            var respDays = Math.round((rc2 - rc1) / 86400000);
            if (respDays >= 0 && respDays < 60) ts.avgResponseDays.push(respDays);
          }
        } catch(e){}
      }
      if (ts.recentJobs.length < 5 || r >= allJobRows.length - 50) {
        if (ts.recentJobs.length >= 5) ts.recentJobs.shift();
        ts.recentJobs.push({ name: fullName, location: location, equip: equipType, status: status, date: createdAt });
      }
      if (serviceDate) {
        try {
          var tsd = new Date(serviceDate);
          if (tsd.toISOString().split('T')[0] === todayStr) {
            ts.todayJobs.push({ name: fullName, location: location, equip: equipType, issue: (issue || '').substring(0, 60) });
          }
        } catch(e){}
      }
    }

    // Brand breakdown
    if (brand && brand.length > 1 && brand.toLowerCase() !== 'not specified') {
      var brandNorm = brand.split(' ')[0].trim();
      brandNorm = brandNorm.charAt(0).toUpperCase() + brandNorm.slice(1).toLowerCase();
      brandStats[brandNorm] = (brandStats[brandNorm] || 0) + 1;
    }

    // Monthly tracking
    if (createdAt) {
      try {
        var cDate = new Date(createdAt);
        if (!isNaN(cDate.getTime())) {
          var mKey = cDate.getFullYear() + '-' + String(cDate.getMonth() + 1).padStart(2, '0');
          monthlyCalls[mKey] = (monthlyCalls[mKey] || 0) + 1;
          if (cDate >= weekStart) weeklyCalls++;

          // Per-location monthly tracking
          var locTab = job.locationTab || 'Unknown';
          if (!monthlyCallsByTab[locTab]) monthlyCallsByTab[locTab] = {};
          monthlyCallsByTab[locTab][mKey] = (monthlyCallsByTab[locTab][mKey] || 0) + 1;

          // Per-city monthly tracking (for charts â€” uses actual city, not tab name)
          if (location && location.length > 3) {
            var cityKey = location;
            if (!monthlyCallsByCity[cityKey]) monthlyCallsByCity[cityKey] = {};
            monthlyCallsByCity[cityKey][mKey] = (monthlyCallsByCity[cityKey][mKey] || 0) + 1;
          }

          // Seasonal demand
          if (equipNorm) {
            if (!seasonalData[mKey]) seasonalData[mKey] = { snow: 0, mower: 0, generator: 0, other: 0 };
            if (equipNorm === 'Snow Blower') seasonalData[mKey].snow++;
            else if (equipNorm.includes('Mower') || equipNorm === 'Zero Turn') seasonalData[mKey].mower++;
            else if (equipNorm === 'Generator') seasonalData[mKey].generator++;
            else seasonalData[mKey].other++;
          }
        }
      } catch (e) {}
    }

    // Avg booking to service days
    if (createdAt && serviceDate) {
      try {
        var cDate2 = new Date(createdAt), sDate = new Date(serviceDate);
        if (!isNaN(cDate2.getTime()) && !isNaN(sDate.getTime())) {
          var daysDiff = Math.round((sDate - cDate2) / 86400000);
          if (daysDiff >= 0 && daysDiff < 60) bookingToServiceDays.push(daysDiff);
        }
      } catch (e) {}
    }

    // New locations this month
    if (createdAt && location) {
      try {
        var cDate3 = new Date(createdAt);
        var mKey2 = cDate3.getFullYear() + '-' + String(cDate3.getMonth() + 1).padStart(2, '0');
        if (mKey2 === thisMonth) newLocationsThisMonth[location] = true;
      } catch (e) {}
    }

    // Service date check for today
    if (serviceDate) {
      try {
        var sd = new Date(serviceDate);
        if (sd.toISOString().split('T')[0] === todayStr) {
          todayBookings.push({ name: fullName, location: location, equip: equipType, issue: (issue || '').substring(0, 80), tech: tech });
        }
      } catch (e) {}
    }

    // Recent bookings (last 20)
    if (r >= allJobRows.length - 20 && job.firstName) {
      recentBookings.push({ name: fullName, location: location, status: status, equip: equipType, tech: tech, brand: brand, date: createdAt });
    }
  }

  // ====== PHASE 3: Read support tabs (Tech Numbers, Return Customers, etc.) ======
  var techList = [];
  try {
    var techRes = await sheets.spreadsheets.values.get({ spreadsheetId: SOURCE_SHEETS[0].id, range: "'Tech Numbers'!A1:D40" });
    var techRows = techRes.data.values || [];
    for (var t = 1; t < techRows.length; t++) {
      if (techRows[t][0]) techList.push({ name: techRows[t][0], phone: techRows[t][1] || '', location: techRows[t][2] || '' });
    }
  } catch (e) { console.log("Tech Numbers read: " + e.message); }

  var totalReturnFromTab = 0;
  try {
    var retRes = await sheets.spreadsheets.values.get({ spreadsheetId: SOURCE_SHEETS[0].id, range: "'Return Customers'!A:A" });
    totalReturnFromTab = Math.max(0, ((retRes.data.values || []).length) - 1);
    if (totalReturnFromTab > totalReturn) totalReturn = totalReturnFromTab;
  } catch (e) {}

  var promoReplies = 0;
  try {
    var promoRes = await sheets.spreadsheets.values.get({ spreadsheetId: SOURCE_SHEETS[0].id, range: "'Promotion Customers Reply'!A:A" });
    promoReplies = Math.max(0, ((promoRes.data.values || []).length) - 1);
  } catch (e) {}

  // ====== PHASE 4: Build context string ======
  var avgBookingDays = bookingToServiceDays.length > 0 ? Math.round(bookingToServiceDays.reduce(function(a,b){return a+b;}, 0) / bookingToServiceDays.length) : 0;
  var totalConverted = totalBooked + totalAssigned + totalCompleted;
  var conversionRate = totalLeads > 0 ? Math.round((totalConverted / totalLeads) * 100) : 0;
  var thisMonthCalls = monthlyCalls[thisMonth] || 0;
  var lastMonthCalls = monthlyCalls[lastMonthStr] || 0;
  var monthGrowth = lastMonthCalls > 0 ? Math.round(((thisMonthCalls - lastMonthCalls) / lastMonthCalls) * 100) : 0;

  context += "OVERVIEW:\n";
  context += "  Total Leads: " + totalLeads + "\n";
  context += "  Booked: " + totalBooked + "\n";
  context += "  Assigned/Dispatched: " + totalAssigned + "\n";
  context += "  Completed Jobs: " + totalCompleted + "\n";
  context += "  Cancelled: " + totalCancelled + "\n";
  context += "  Return Customers: " + totalReturn + "\n";
  context += "  Promo Replies: " + promoReplies + "\n";
  context += "  Locations Active: " + Object.keys(locationStats).length + "\n";
  context += "  Technicians: " + techList.length + "\n";
  context += "  Avg Days Bookingâ†’Service: " + avgBookingDays + "\n";
  context += "  Conversion Rate: " + conversionRate + "%\n";
  context += "  This Month Calls: " + thisMonthCalls + "\n";
  context += "  Last Month Calls: " + lastMonthCalls + "\n";
  context += "  Month Growth: " + monthGrowth + "%\n";
  context += "  This Week Bookings: " + weeklyCalls + "\n";
  context += "  Data Source: " + sheetsRead + " sheets, " + tabsRead + " tabs read directly\n\n";

  if (todayBookings.length > 0) {
    context += "TODAY'S BOOKINGS:\n";
    todayBookings.forEach(function(b) { context += "  " + b.name + " (" + b.location + ") â€” " + b.equip + ": " + b.issue + " [Tech: " + b.tech + "]\n"; });
    context += "\n";
  }

  if (needsReschedule.length > 0) {
    context += "NEEDS RESCHEDULING (" + needsReschedule.length + "):\n";
    needsReschedule.slice(0, 10).forEach(function(n) { context += "  " + n.name + " (" + n.location + ") â€” " + n.phone + "\n"; });
    context += "\n";
  }

  context += "EQUIPMENT BREAKDOWN:\n";
  var eqSorted = Object.entries(equipStats).sort(function(a,b){return b[1]-a[1];});
  eqSorted.slice(0, 8).forEach(function(e) { context += "  " + e[0] + ": " + e[1] + "\n"; });
  context += "\n";

  context += "TOP BRANDS:\n";
  var brSorted = Object.entries(brandStats).sort(function(a,b){return b[1]-a[1];});
  brSorted.slice(0, 8).forEach(function(b) { context += "  " + b[0] + ": " + b[1] + "\n"; });
  context += "\n";

  context += "TECHNICIAN PERFORMANCE:\n";
  var techSorted = Object.entries(techStats).sort(function(a,b){return b[1].total-a[1].total;});
  techSorted.forEach(function(t) {
    var s = t[1];
    var rate = s.total > 0 ? Math.round((s.completed / s.total) * 100) : 0;
    var avgResp = s.avgResponseDays.length > 0 ? Math.round(s.avgResponseDays.reduce(function(a,b){return a+b;},0) / s.avgResponseDays.length) : 0;
    var topEquip = Object.entries(s.equipment).sort(function(a,b){return b[1]-a[1];}).slice(0,3).map(function(e){return e[0];}).join(', ');
    var topLocs = Object.entries(s.locations).sort(function(a,b){return b[1]-a[1];}).slice(0,3).map(function(l){return l[0];}).join(', ');
    context += "  " + t[0] + ": " + s.total + " jobs (" + s.completed + " completed, " + s.cancelled + " cancelled, " + rate + "% rate)";
    context += " | This week: " + s.thisWeekJobs + " | Avg response: " + avgResp + "d";
    context += " | Specialties: " + (topEquip || 'none') + " | Markets: " + (topLocs || 'none') + "\n";
  });
  context += "\n";

  if (todayBookings.length > 0 || needsReschedule.length > 0) {
    context += "SMART TASK ASSIGNMENTS:\n";
    var unassigned = todayBookings.filter(function(b) { return !b.tech || b.tech === ''; });
    unassigned.forEach(function(job2) {
      var bestTech = null, bestScore = -1;
      techSorted.forEach(function(t) {
        var s2 = t[1], score = 0;
        var completionRate = s2.total > 0 ? s2.completed / s2.total : 0;
        score += completionRate * 40;
        if (job2.equip && s2.equipment[job2.equip]) score += 20;
        if (job2.location && s2.locations[job2.location]) score += 20;
        score -= s2.todayJobs.length * 10;
        if (score > bestScore) { bestScore = score; bestTech = t[0]; }
      });
      if (bestTech) context += "  ASSIGN: " + job2.name + " (" + job2.equip + " in " + job2.location + ") â†’ " + bestTech + "\n";
    });
    context += "\n";
  }

  context += "LOCATION BREAKDOWN:\n";
  var locSorted = Object.entries(locationStats).sort(function(a,b){return b[1].total-a[1].total;});
  locSorted.slice(0, 20).forEach(function(l) {
    context += "  " + l[0] + ": " + l[1].total + " total, " + l[1].booked + " booked, " + l[1].completed + " completed, " + l[1].cancelled + " cancelled\n";
  });
  context += "\n";

  if (recentBookings.length > 0) {
    context += "RECENT ACTIVITY:\n";
    recentBookings.slice(-10).forEach(function(b) { context += "  " + b.name + " â€” " + b.location + " â€” " + b.status + " (" + b.equip + ") [" + b.tech + "]\n"; });
    context += "\n";
  }

  // Sheet registry for AI
  context += "DATA SOURCES AVAILABLE:\n";
  SOURCE_SHEETS.forEach(function(s) { context += "  " + s.name + ": " + s.desc + "\n"; });
  context += "\n";

  // Non-job data summaries
  if (Object.keys(allOtherSections).length > 0) {
    context += "BUSINESS OPERATIONS DATA:\n\n";
    Object.entries(allOtherSections).forEach(function(section) {
      context += "--- " + section[0] + " ---\n";
      var maxLines = Math.min(section[1].rows.length, 20);
      for (var sl = 0; sl < maxLines; sl++) { context += "  " + section[1].rows[sl] + "\n"; }
      if (section[1].totalRows > 20) context += "  ... and " + (section[1].totalRows - 20) + " more rows\n";
      context += "\n";
    });
  }

  // Store parsed data globally for dashboard
  global.bizMetrics = {
    totalLeads: totalLeads, totalBooked: totalBooked, totalCompleted: totalCompleted,
    totalCancelled: totalCancelled, totalReturn: totalReturn, totalAssigned: totalAssigned, promoReplies: promoReplies,
    todayBookings: todayBookings, needsReschedule: needsReschedule, recentBookings: recentBookings,
    locationStats: locationStats, techStats: techStats, equipStats: equipStats, brandStats: brandStats,
    monthlyCalls: monthlyCalls, weeklyCalls: weeklyCalls, monthlyCallsByTab: monthlyCallsByTab, monthlyCallsByCity: monthlyCallsByCity,
    avgBookingDays: avgBookingDays, conversionRate: conversionRate,
    thisMonthCalls: thisMonthCalls, lastMonthCalls: lastMonthCalls,
    monthGrowth: monthGrowth, techList: techList, newLocationsThisMonth: Object.keys(newLocationsThisMonth).length,
    seasonalData: seasonalData, sheetsRead: sheetsRead, tabsRead: tabsRead, totalJobRows: allJobRows.length,
    allJobRows: allJobRows,
  };
  global.bizOpsData = allOtherSections;
  global.sheetMetadata = sheetMetadata;

  // ====== PHASE 5: Read Profit Sheet ======
  if (PROFIT_SPREADSHEET_ID) {
    try {
      var profitContext = "";
      var today2 = new Date();
      var monthNames3 = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      var currentMonthTab = monthNames3[today2.getMonth()] + " " + today2.getFullYear();
      
      var profitRes = await sheets.spreadsheets.values.get({
        spreadsheetId: PROFIT_SPREADSHEET_ID,
        range: "'" + currentMonthTab + "'!A1:AF55",
        valueRenderOption: 'FORMATTED_VALUE',
      });
      var profitRows = profitRes.data.values || [];
      
      if (profitRows.length > 0) {
        var monthExpenses = {};
        var monthRevenue = 0, monthProfit = 0;
        var dailyRevenue = [], dailyProfit = [], dailyAds = [];
        var techPayouts = {}, receptionistPayouts = {}, adminPayouts = {};
        var techPayoutsDaily = {};
        
        for (var pr = 1; pr < profitRows.length; pr++) {
          var pRow = profitRows[pr];
          var pLabel = (pRow[0] || '').toString().toLowerCase().trim();
          if (!pLabel) continue;
          
          var rowTotal = 0;
          for (var pd = 1; pd < pRow.length; pd++) {
            var val = parseFloat((pRow[pd] || '0').toString().replace(/[$,]/g, ''));
            if (!isNaN(val)) rowTotal += val;
          }
          
          if (pLabel === 'ads') {
            monthExpenses['Ads'] = rowTotal;
            for (var ad2 = 1; ad2 < pRow.length; ad2++) { dailyAds.push(parseFloat((pRow[ad2] || '0').toString().replace(/[$,]/g, '')) || 0); }
          }
          else if (pLabel === 'app total') monthExpenses['Apps/Software'] = rowTotal;
          else if (pLabel === 'amazon (parts)') { monthExpenses['Parts/Supplies'] = (monthExpenses['Parts/Supplies'] || 0) + rowTotal; }
          else if (pLabel === 'receipts') { monthExpenses['Receipts'] = (monthExpenses['Receipts'] || 0) + rowTotal; }
          else if (pLabel === 'payment processing fees') monthExpenses['Processing Fees'] = rowTotal;
          else if (pLabel === 'refunds by amount') monthExpenses['Refunds'] = rowTotal;
          else if (pLabel === 'admin total') monthExpenses['Admin Labor'] = rowTotal;
          else if (pLabel === 'manager total') monthExpenses['Manager Labor'] = rowTotal;
          else if (pLabel === 'receptionist total') monthExpenses['Receptionist Labor'] = rowTotal;
          else if (pLabel === 'tech total') monthExpenses['Tech Labor'] = rowTotal;
          else if (pLabel === 'total collected') {
            monthRevenue = rowTotal;
            for (var rv = 1; rv < pRow.length; rv++) { dailyRevenue.push(parseFloat((pRow[rv] || '0').toString().replace(/[$,]/g, '')) || 0); }
          }
          else if (pLabel === 'profit') {
            monthProfit = rowTotal;
            for (var pf = 1; pf < pRow.length; pf++) { dailyProfit.push(parseFloat((pRow[pf] || '0').toString().replace(/[$,]/g, '')) || 0); }
          }
          else if (['rocky','tucker','aly'].indexOf(pLabel) >= 0) { adminPayouts[pRow[0]] = rowTotal; }
          else if (['ray','muaaz','rayan'].indexOf(pLabel) >= 0) { receptionistPayouts[pRow[0]] = rowTotal; }
          else if (['andrew','hailey','rubait'].indexOf(pLabel) >= 0) { adminPayouts[pRow[0]] = rowTotal; }
          else if (['justin turner','victor romero','alexander fernandez','tony reynolds','kurt nowicki',
                     'talon twiford','michael scutti','maxx fritts','corey roberson','robert hummer','ashton hawley',
                     'brandi butler','trent kennedy','keith'].indexOf(pLabel) >= 0) {
            techPayouts[pRow[0]] = rowTotal;
            // Store daily values for this tech (col 1 = day 1, col 2 = day 2, etc.)
            var dailyArr = [];
            for (var td2 = 1; td2 < pRow.length; td2++) {
              dailyArr.push(parseFloat((pRow[td2] || '0').toString().replace(/[$,]/g, '')) || 0);
            }
            techPayoutsDaily[pRow[0]] = dailyArr;
          }
        }
        
        var totalExpenses = 0;
        Object.values(monthExpenses).forEach(function(v) { totalExpenses += v; });
        
        profitContext += "FINANCIAL DATA â€” " + currentMonthTab.toUpperCase() + ":\n";
        profitContext += "  Total Revenue Collected: $" + monthRevenue.toFixed(2) + "\n";
        profitContext += "  Total Expenses: $" + totalExpenses.toFixed(2) + "\n";
        profitContext += "  NET PROFIT: $" + monthProfit.toFixed(2) + "\n";
        profitContext += "  Profit Margin: " + (monthRevenue > 0 ? ((monthProfit / monthRevenue) * 100).toFixed(1) : "0") + "%\n\n";
        
        profitContext += "  EXPENSE BREAKDOWN:\n";
        Object.entries(monthExpenses).sort(function(a,b){return b[1]-a[1];}).forEach(function(e) {
          if (e[1] > 0) profitContext += "    " + e[0] + ": $" + e[1].toFixed(2) + "\n";
        });
        
        if (Object.keys(techPayouts).length > 0) {
          profitContext += "\n  TECH PAYOUTS:\n";
          Object.entries(techPayouts).sort(function(a,b){return b[1]-a[1];}).forEach(function(t) {
            if (t[1] > 0) profitContext += "    " + t[0] + ": $" + t[1].toFixed(2) + "\n";
          });
        }
        
        var daysWithRevenue = dailyRevenue.filter(function(v){return v > 0;}).length;
        var avgDailyRev = daysWithRevenue > 0 ? monthRevenue / daysWithRevenue : 0;
        var avgDailyAds = dailyAds.filter(function(v){return v>0;}).length > 0 ? dailyAds.reduce(function(a,b){return a+b;},0) / dailyAds.filter(function(v){return v>0;}).length : 0;
        profitContext += "\n  DAILY AVERAGES:\n";
        profitContext += "    Avg Daily Revenue: $" + avgDailyRev.toFixed(2) + "\n";
        profitContext += "    Avg Daily Ad Spend: $" + avgDailyAds.toFixed(2) + "\n";
        if (avgDailyAds > 0 && avgDailyRev > 0) {
          profitContext += "    Ad ROI: $" + (avgDailyRev / avgDailyAds).toFixed(2) + " revenue per $1 ad spend\n";
        }
        
        context += profitContext;
        
        global.profitMetrics = {
          currentMonth: currentMonthTab, revenue: monthRevenue, expenses: totalExpenses,
          profit: monthProfit, margin: monthRevenue > 0 ? ((monthProfit / monthRevenue) * 100).toFixed(1) : "0",
          expenseBreakdown: monthExpenses, techPayouts: techPayouts,
          techPayoutsDaily: techPayoutsDaily, currentDay: today2.getDate(),
          adminPayouts: adminPayouts, receptionistPayouts: receptionistPayouts,
          dailyRevenue: dailyRevenue, dailyProfit: dailyProfit, dailyAds: dailyAds,
          avgDailyRev: avgDailyRev, avgDailyAds: avgDailyAds,
        };
      }
      
      // Yearly totals â€” read current + all previous years for financial history
      var yearlyTechPayouts = {};
      var financialHistory = { years: {}, months: {} };
      var startYear = 2024;
      var curYear = today2.getFullYear();
      var techNameList = ['justin turner','victor romero','alexander fernandez','tony reynolds','kurt nowicki',
                   'talon twiford','michael scutti','maxx fritts','corey roberson','robert hummer','ashton hawley',
                   'brandi butler','trent kennedy','keith'];
      var monthNames4 = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

      for (var fy = startYear; fy <= curYear; fy++) {
        try {
          var yearTab = "Total " + fy;
          var yearRes = await sheets.spreadsheets.values.get({
            spreadsheetId: PROFIT_SPREADSHEET_ID,
            range: "'" + yearTab + "'!A1:N55",
            valueRenderOption: 'FORMATTED_VALUE',
          });
          var yearRows = yearRes.data.values || [];
          if (yearRows.length > 1) {
            var yearData = { revenue: 0, profit: 0, expenses: 0, ads: 0, techLabor: 0, receptionistLabor: 0, adminLabor: 0, refunds: 0, parts: 0, processing: 0, apps: 0, monthlyRevenue: [], monthlyProfit: [], monthlyAds: [] };
            for (var yr2 = 1; yr2 < yearRows.length; yr2++) {
              var yLabel = (yearRows[yr2][0] || '').toString().trim();
              var yLabelLower = yLabel.toLowerCase();
              var yRowTotal = 0, yMonthVals = [];
              for (var yc = 1; yc < yearRows[yr2].length; yc++) {
                var yv = parseFloat((yearRows[yr2][yc] || '0').toString().replace(/[$,]/g, ''));
                if (isNaN(yv)) yv = 0;
                yRowTotal += yv; yMonthVals.push(yv);
              }
              if (yLabelLower === 'total collected') { yearData.revenue = yRowTotal; yearData.monthlyRevenue = yMonthVals; }
              else if (yLabelLower === 'profit') { yearData.profit = yRowTotal; yearData.monthlyProfit = yMonthVals; }
              else if (yLabelLower === 'ads') { yearData.ads = yRowTotal; yearData.monthlyAds = yMonthVals; }
              else if (yLabelLower === 'tech total') yearData.techLabor = yRowTotal;
              else if (yLabelLower === 'receptionist total') yearData.receptionistLabor = yRowTotal;
              else if (yLabelLower === 'admin total') yearData.adminLabor = yRowTotal;
              else if (yLabelLower === 'manager total') yearData.adminLabor += yRowTotal;
              else if (yLabelLower === 'refunds by amount') yearData.refunds = yRowTotal;
              else if (yLabelLower === 'amazon (parts)' || yLabelLower === 'receipts') yearData.parts += yRowTotal;
              else if (yLabelLower === 'payment processing fees') yearData.processing = yRowTotal;
              else if (yLabelLower === 'app total') yearData.apps = yRowTotal;
              if (fy === curYear && techNameList.indexOf(yLabelLower) >= 0 && yRowTotal > 0) yearlyTechPayouts[yLabel] = yRowTotal;
            }
            yearData.expenses = yearData.revenue - yearData.profit;
            yearData.margin = yearData.revenue > 0 ? Math.round((yearData.profit / yearData.revenue) * 1000) / 10 : 0;
            financialHistory.years[fy] = yearData;
            context += "\nYEARLY â€” " + fy + ": Rev $" + yearData.revenue.toFixed(0) + " | Profit $" + yearData.profit.toFixed(0) + " | Margin " + yearData.margin + "%\n";
            for (var mi2 = 0; mi2 < Math.min(12, yearData.monthlyRevenue.length); mi2++) {
              var mRev2 = yearData.monthlyRevenue[mi2] || 0, mProf2 = yearData.monthlyProfit[mi2] || 0, mAds2 = yearData.monthlyAds[mi2] || 0;
              if (mRev2 > 0 || mProf2 !== 0) {
                financialHistory.months[monthNames4[mi2] + ' ' + fy] = { revenue: mRev2, profit: mProf2, ads: mAds2, expenses: mRev2 - mProf2, margin: mRev2 > 0 ? Math.round((mProf2 / mRev2) * 1000) / 10 : 0 };
              }
            }
          }
        } catch(ye2) { console.log("Year " + fy + " tab: " + ye2.message); }
      }
      // Today / this week from daily data
      var todayRev = dailyRevenue[today2.getDate() - 1] || 0, todayProf = dailyProfit[today2.getDate() - 1] || 0, todayAd = dailyAds[today2.getDate() - 1] || 0;
      var weekRev = 0, weekProf = 0, weekAds2 = 0;
      for (var wd = Math.max(0, today2.getDate() - 7); wd < today2.getDate(); wd++) { weekRev += dailyRevenue[wd] || 0; weekProf += dailyProfit[wd] || 0; weekAds2 += dailyAds[wd] || 0; }
      financialHistory.today = { revenue: todayRev, profit: todayProf, ads: todayAd, expenses: todayRev - todayProf, margin: todayRev > 0 ? Math.round((todayProf / todayRev) * 1000) / 10 : 0 };
      financialHistory.thisWeek = { revenue: weekRev, profit: weekProf, ads: weekAds2, expenses: weekRev - weekProf, margin: weekRev > 0 ? Math.round((weekProf / weekRev) * 1000) / 10 : 0 };
      financialHistory.thisMonth = { revenue: monthRevenue, profit: monthProfit, ads: monthExpenses['Ads'] || 0, expenses: totalExpenses, margin: monthRevenue > 0 ? Math.round((monthProfit / monthRevenue) * 1000) / 10 : 0 };
      var allTimeRev = 0, allTimeProf = 0, allTimeAds = 0;
      Object.values(financialHistory.years).forEach(function(y) { allTimeRev += y.revenue; allTimeProf += y.profit; allTimeAds += y.ads; });
      financialHistory.allTime = { revenue: allTimeRev, profit: allTimeProf, ads: allTimeAds, expenses: allTimeRev - allTimeProf, margin: allTimeRev > 0 ? Math.round((allTimeProf / allTimeRev) * 1000) / 10 : 0, startYear: startYear };
      if (global.profitMetrics) { global.profitMetrics.yearlyTechPayouts = yearlyTechPayouts; global.profitMetrics.financialHistory = financialHistory; }
      
    } catch (pe) {
      context += "Error loading profit data: " + pe.message + "\n";
    }
  }

  // ====== PHASE 5: Append Tookan live data if available ======
  var tkData = global.tookanData || {};
  if (tkData.totalTasks > 0) {
    context += "\nTOOKAN DISPATCH (LIVE â€” LAST 90 DAYS):\n";
    context += "  Total Tasks: " + tkData.totalTasks + "\n";
    context += "  Completed: " + tkData.completed + "\n";
    context += "  Assigned: " + tkData.assigned + " | Acknowledged: " + tkData.acknowledged + "\n";
    context += "  In Progress: " + tkData.started + " | Unassigned: " + tkData.unassigned + "\n";
    context += "  Failed/Cancelled: " + tkData.cancelled + "\n";
    context += "  Today's Jobs: " + (tkData.todayTasks || []).length + "\n";
    context += "  Active Agents: " + (tkData.agents || []).length + "\n";
    var tkTechs = Object.entries(tkData.tasksByTech || {}).sort(function(a,b){return b[1].completed-a[1].completed;});
    if (tkTechs.length > 0) {
      context += "  Tech Rankings (by completions):\n";
      tkTechs.slice(0, 10).forEach(function(t, i) {
        var rate = t[1].total > 0 ? Math.round(t[1].completed / t[1].total * 100) : 0;
        context += "    " + (i+1) + ". " + t[0] + ": " + t[1].completed + "/" + t[1].total + " (" + rate + "%)\n";
      });
    }
  }

  // ====== PHASE 6: Follow-Up Portal Data (for Athena memory) ======
  try {
    var fuEmployees = [];
    try {
      var fuDropDown = await sheets.spreadsheets.values.get({ spreadsheetId: FOLLOWUP_SPREADSHEET_ID, range: "'DropDown'!A:E" });
      fuEmployees = (fuDropDown.data.values || []).slice(1).filter(function(r) { return r[0]; });
    } catch(fe) {}

    if (fuEmployees.length > 0) {
      // Get all follow-up tabs
      var fuTabsRes = await sheets.spreadsheets.get({ spreadsheetId: FOLLOWUP_SPREADSHEET_ID });
      var fuTabs = fuTabsRes.data.sheets.map(function(s) { return s.properties.title; }).filter(function(t) { return t.toLowerCase().startsWith('follow ups of'); });

      var allFuRows = [];
      for (var ft = 0; ft < fuTabs.length; ft++) {
        try {
          var fuRes = await sheets.spreadsheets.values.get({ spreadsheetId: FOLLOWUP_SPREADSHEET_ID, range: "'" + fuTabs[ft] + "'!A:H" });
          var fuRows = (fuRes.data.values || []).slice(1);
          fuRows.forEach(function(r) { allFuRows.push({ timestamp: r[0]||'', name: (r[1]||'').trim(), file: r[3]||'', link: r[4]||'', audit: r[5]||'', suggestions: r[6]||'', reason: r[7]||'', tab: fuTabs[ft] }); });
        } catch(fte) {}
      }

      // Build per-employee analytics
      var fuStats = {};
      var fuNow = new Date();
      var fuStartOfWeek = new Date(fuNow);
      var fuDow = fuStartOfWeek.getDay() || 7;
      if (fuDow !== 1) fuStartOfWeek.setDate(fuStartOfWeek.getDate() - (fuDow - 1));
      fuStartOfWeek.setHours(0,0,0,0);

      fuEmployees.forEach(function(emp) {
        var empName = (emp[0] || '').trim();
        fuStats[empName] = { submissions: [], onTime: 0, late: 0, totalSubmissions: 0, submittedThisWeek: false, lateStreak: 0, weeksMissed: 0, avgDay: 0, avgHour: 0, auditScores: [] };
      });

      allFuRows.forEach(function(r) {
        if (!fuStats[r.name]) return;
        var d = new Date(r.timestamp);
        if (isNaN(d.getTime())) return;
        var stat = fuStats[r.name];
        stat.totalSubmissions++;
        stat.submissions.push({ date: d, day: d.getDay(), hour: d.getHours(), audit: r.audit });

        var dayNum = d.getDay();
        if (dayNum === 0 || dayNum === 6 || dayNum === 1) stat.late++; else stat.onTime++;
        if (d >= fuStartOfWeek) stat.submittedThisWeek = true;

        // AI audit tracking
        if (r.audit && r.audit.indexOf('ERROR') === -1) {
          if (r.audit.indexOf('40 Hours') > -1) stat.auditScores.push(40);
          else {
            var hoursMatch = r.audit.match(/(\d+)\s*Hours?/i);
            if (hoursMatch) stat.auditScores.push(parseInt(hoursMatch[1]));
          }
        }
      });

      // Calculate streaks, avg day/hour, weeks missed
      Object.keys(fuStats).forEach(function(empName) {
        var stat = fuStats[empName];
        if (stat.submissions.length > 0) {
          // Average submission day and hour
          var daySum = 0, hourSum = 0;
          stat.submissions.forEach(function(s) { daySum += s.day; hourSum += s.hour; });
          stat.avgDay = Math.round(daySum / stat.submissions.length);
          stat.avgHour = Math.round(hourSum / stat.submissions.length);

          // Late streak (consecutive recent late submissions)
          var sorted = stat.submissions.sort(function(a,b) { return b.date - a.date; });
          stat.lateStreak = 0;
          for (var ls = 0; ls < sorted.length; ls++) {
            var ld = sorted[ls].day;
            if (ld === 0 || ld === 6 || ld === 1) stat.lateStreak++; else break;
          }

          // Weeks missed: estimate from total weeks since first submission vs total submissions
          var firstSub = sorted[sorted.length - 1].date;
          var weeksSinceFirst = Math.max(1, Math.ceil((fuNow - firstSub) / (7 * 86400000)));
          stat.weeksMissed = Math.max(0, weeksSinceFirst - stat.totalSubmissions);
        }
      });

      // Build context string for Athena
      var dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      context += "\n\n=== WEEKLY FOLLOW-UP REPORT STATUS ===\n";
      var submittedCount = 0, pendingNames = [], lateNames = [];
      Object.keys(fuStats).forEach(function(empName) {
        var s = fuStats[empName];
        if (s.submittedThisWeek) submittedCount++;
        else pendingNames.push(empName);
        if (s.lateStreak >= 2) lateNames.push(empName + ' (' + s.lateStreak + ' weeks late streak)');
      });
      context += "This week: " + submittedCount + "/" + Object.keys(fuStats).length + " submitted.\n";
      if (pendingNames.length) context += "PENDING (not yet submitted): " + pendingNames.join(', ') + "\n";
      if (lateNames.length) context += "âš ï¸ LATE STREAKS: " + lateNames.join(', ') + "\n";

      context += "\nPer-employee follow-up stats:\n";
      Object.keys(fuStats).forEach(function(empName) {
        var s = fuStats[empName];
        context += "- " + empName + ": " + s.totalSubmissions + " total submissions, " + s.onTime + " on-time, " + s.late + " late, " + s.weeksMissed + " missed weeks";
        if (s.avgDay >= 0 && s.submissions.length > 0) context += ", avg submit " + dayNames[s.avgDay] + " ~" + s.avgHour + ":00";
        if (s.auditScores.length > 0) {
          var avgAudit = Math.round(s.auditScores.reduce(function(a,b){return a+b;},0) / s.auditScores.length);
          context += ", avg audit: " + avgAudit + "h/40h";
        }
        context += "\n";
      });

      // Store globally for dashboard/portal use
      global.followUpMetrics = { stats: fuStats, allRows: allFuRows, employeeCount: Object.keys(fuStats).length, submittedThisWeek: submittedCount, pendingThisWeek: pendingNames };
      console.log("Follow-up context: " + Object.keys(fuStats).length + " employees, " + allFuRows.length + " total submissions");
    }
  } catch (fuErr) {
    console.log("Follow-up context error:", fuErr.message);
  }

  console.log("Business context built: " + context.length + " chars (" + allJobRows.length + " jobs from " + sheetsRead + " sheets)");
  businessCache = { data: context, time: Date.now() };
  return context;
}


/* ===========================
   Call Claude API
=========================== */

// Estimate token count â€” using conservative 2.5 chars/token ratio
// (structured data with JSON, numbers, short words tokenizes at ~2-3 chars/token)
function estimateTokens(text) {
  if (!text) return 0;
  return Math.ceil(text.length / 2.5);
}

// Hard character limit for system prompts (~150K tokens max = ~375K chars)
var MAX_SYSTEM_CHARS = 350000;

// Truncate context to fit within token budget
function truncateForTokenLimit(systemPrompt, messages, maxTotalTokens) {
  maxTotalTokens = maxTotalTokens || 170000; // Conservative buffer under 200K
  var responseBuffer = 2000;
  var budget = maxTotalTokens - responseBuffer;

  // Step 0: Hard-cap the system prompt immediately if it's absurdly large
  if (systemPrompt.length > MAX_SYSTEM_CHARS) {
    console.log('[askClaude] HARD CAP: system prompt ' + systemPrompt.length + ' chars -> ' + MAX_SYSTEM_CHARS);
    systemPrompt = systemPrompt.substring(0, MAX_SYSTEM_CHARS) + '\n\n[Context truncated to fit token limit]';
  }

  var systemTokens = estimateTokens(systemPrompt);
  var msgTokens = 0;
  for (var i = 0; i < messages.length; i++) {
    msgTokens += estimateTokens(typeof messages[i].content === 'string' ? messages[i].content : JSON.stringify(messages[i].content)) + 10;
  }

  var totalTokens = systemTokens + msgTokens;
  console.log('[askClaude] Estimated tokens â€” system: ' + systemTokens + ' (' + systemPrompt.length + ' chars), messages: ' + msgTokens + ', total: ' + totalTokens + ', budget: ' + budget);

  // If under budget, return as-is
  if (totalTokens <= budget) {
    return { systemPrompt: systemPrompt, messages: messages };
  }

  // Strategy 1: Trim conversation history (keep last 4 messages)
  if (messages.length > 4) {
    messages = messages.slice(-4);
    msgTokens = 0;
    for (var j = 0; j < messages.length; j++) {
      msgTokens += estimateTokens(typeof messages[j].content === 'string' ? messages[j].content : JSON.stringify(messages[j].content)) + 10;
    }
    totalTokens = systemTokens + msgTokens;
    console.log('[askClaude] After message trim: ' + totalTokens + ' tokens');
    if (totalTokens <= budget) {
      return { systemPrompt: systemPrompt, messages: messages };
    }
  }

  // Strategy 2: Truncate the system prompt to fit
  var systemBudget = budget - msgTokens;
  if (systemBudget < 5000) systemBudget = 5000;
  var charLimit = Math.floor(systemBudget * 2.5); // Convert back to chars using same ratio
  if (systemPrompt.length > charLimit) {
    console.log('[askClaude] Truncating system prompt from ' + systemPrompt.length + ' chars to ' + charLimit);
    systemPrompt = systemPrompt.substring(0, charLimit) + '\n\n[Context truncated to fit token limit]';
  }

  var finalEst = estimateTokens(systemPrompt) + msgTokens;
  console.log('[askClaude] Final estimated tokens: ' + finalEst);
  return { systemPrompt: systemPrompt, messages: messages };
}

async function askClaude(systemPrompt, messages) {
  try {
    // Enforce token limits before calling API
    var trimmed = truncateForTokenLimit(systemPrompt, messages);

    var response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': CLAUDE_API_KEY,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        system: trimmed.systemPrompt,
        messages: trimmed.messages,
      }),
    });
    var data = await response.json();
    if (data.error) {
      console.error("Claude API Error: " + JSON.stringify(data.error));
      return "There was an error: " + (data.error.message || 'Unknown error');
    }
    if (data.content && data.content.length > 0) {
      return data.content[0].text;
    }
    return "I got an unexpected response.";
  } catch (err) {
    console.error("Claude fetch error: " + err.message);
    return "I had trouble connecting to my AI brain.";
  }
}

/* ===========================
   POST /voice â€” Initial greeting
=========================== */

// ==============================
// LOGIN + AUTH ROUTES
// ==============================
app.get('/', function(req, res) {
  var session = getVoiceSession(req);
  if (!session) return res.redirect('/login');
  if (session.access === 'all') return res.redirect('/dashboard');
  if (session.access === 'discord') return res.redirect('/discord');
  return res.redirect('/dashboard');
});

app.post('/auth/voice', express.json(), function(req, res) {
  var spoken = (req.body.passphrase || '').trim();
  if (!spoken) return res.json({ success: false, message: 'No passphrase detected' });

  for (var i = 0; i < voiceUsers.length; i++) {
    if (matchPassphrase(spoken, voiceUsers[i].passphrase)) {
      var token = 'vt_' + Date.now() + '_' + Math.random().toString(36).substring(2, 12);
      voiceSessions[token] = {
        name: voiceUsers[i].name,
        role: voiceUsers[i].role,
        access: voiceUsers[i].access,
        created: Date.now()
      };
      // Clean old sessions
      Object.keys(voiceSessions).forEach(function(k) {
        if (Date.now() - voiceSessions[k].created > 86400000 * 7) delete voiceSessions[k];
      });
      return res.json({
        success: true,
        name: voiceUsers[i].name,
        role: voiceUsers[i].role,
        access: voiceUsers[i].access,
        token: token
      });
    }
  }
  res.json({ success: false, message: 'Passphrase not recognized' });
});

app.get('/auth/logout', function(req, res) {
  var cookies = (req.headers.cookie || '').split(';');
  for (var i = 0; i < cookies.length; i++) {
    var parts = cookies[i].trim().split('=');
    if (parts[0] === 'voice_token') {
      delete voiceSessions[decodeURIComponent(parts[1])];
    }
  }
  res.setHeader('Set-Cookie', 'voice_token=; Path=/; Max-Age=0');
  res.redirect('/login');
});

app.get('/login', function(req, res) {
  var session = getVoiceSession(req);
  var redirect = req.query.r || '';
  var denied = req.query.denied === '1';

  if (session && !denied) {
    if (session.access === 'all') return res.redirect(redirect || '/dashboard');
    if (session.access === 'discord') return res.redirect('/discord');
    return res.redirect(redirect || '/dashboard');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // JARVIS LOGIN â€” ULTIMATE CINEMATIC VOICE AUTH (10x Edition)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
  html += '<title>WILDWOOD â€” JARVIS</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">';
  html += '<style>';
  html += '*{margin:0;padding:0;box-sizing:border-box;}';
  html += ':root{--blue:#4da8ff;--blue-bright:#7ec4ff;--blue-dim:rgba(77,168,255,0.08);--blue-glow:rgba(77,168,255,0.25);--teal:#56d4c8;--teal-dim:rgba(86,212,200,0.08);--gold:#e8b44a;--red:#ef4444;--bg:#080b12;--card:rgba(12,16,26,0.7);--text:#b8c8dc;--text-bright:#e4ecf4;--text-dim:rgba(184,200,220,0.3);}';
  html += 'html,body{background:var(--bg);color:var(--text);font-family:Outfit,sans-serif;min-height:100vh;overflow:hidden;}';
  html += 'body{display:flex;align-items:center;justify-content:center;}';

  // Canvas layers
  html += 'canvas#bgCanvas{position:fixed;inset:0;z-index:0;width:100%;height:100%;}';
  html += 'canvas#hexCanvas{position:fixed;inset:0;z-index:0;width:100%;height:100%;opacity:0.4;}';

  // Ambient orbs
  html += '.ambient-orb{position:fixed;border-radius:50%;filter:blur(120px);z-index:0;pointer-events:none;}';
  html += '.orb-1{width:500px;height:500px;top:-15%;left:-10%;background:radial-gradient(circle,rgba(77,168,255,0.07) 0%,transparent 70%);animation:orb-float 30s ease-in-out infinite;}';
  html += '.orb-2{width:400px;height:400px;bottom:-10%;right:-5%;background:radial-gradient(circle,rgba(86,212,200,0.05) 0%,transparent 70%);animation:orb-float 25s ease-in-out infinite reverse;}';
  html += '.orb-3{width:300px;height:300px;top:40%;left:60%;background:radial-gradient(circle,rgba(232,180,74,0.03) 0%,transparent 70%);animation:orb-float 35s ease-in-out infinite 5s;}';
  html += '@keyframes orb-float{0%,100%{transform:translate(0,0) scale(1)}25%{transform:translate(30px,-20px) scale(1.1)}50%{transform:translate(-20px,30px) scale(0.95)}75%{transform:translate(15px,15px) scale(1.05)}}';

  // Overlays
  html += '.scan-overlay{position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(77,168,255,0.008) 0px,rgba(77,168,255,0.008) 1px,transparent 1px,transparent 3px);z-index:1;pointer-events:none;}';
  html += '.sweep-line{position:fixed;left:0;width:100%;height:1px;background:linear-gradient(90deg,transparent 10%,rgba(77,168,255,0.12) 50%,transparent 90%);z-index:1;pointer-events:none;animation:sweep 8s linear infinite;opacity:0.7;}';
  html += '@keyframes sweep{0%{top:-1px}100%{top:100%}}';
  html += '.noise{position:fixed;inset:0;z-index:1;pointer-events:none;opacity:0.025;mix-blend-mode:overlay;background:url("data:image/svg+xml,%3Csvg viewBox=%270 0 512 512%27 xmlns=%27http://www.w3.org/2000/svg%27%3E%3Cfilter id=%27n%27%3E%3CfeTurbulence type=%27fractalNoise%27 baseFrequency=%270.65%27 numOctaves=%274%27 stitchTiles=%27stitch%27/%3E%3C/filter%3E%3Crect width=%27100%25%27 height=%27100%25%27 filter=%27url(%23n)%27/%3E%3C/svg%3E");}';

  // Corner frames
  html += '.frame{position:fixed;z-index:3;opacity:0;animation:fade-in 1s ease 2.5s forwards;}.frame svg{width:30px;height:30px;}.frame line{stroke:var(--blue);stroke-width:1;opacity:0.12;}';
  html += '.frame-tl{top:25px;left:25px;}.frame-tr{top:25px;right:25px;}.frame-bl{bottom:25px;left:25px;}.frame-br{bottom:25px;right:25px;}';
  html += '@keyframes fade-in{to{opacity:1}}';

  // â•â•â• BOOT SEQUENCE â•â•â•
  html += '.boot-overlay{position:fixed;inset:0;z-index:200;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;transition:opacity 0.8s ease,visibility 0.8s;}';
  html += '.boot-overlay.done{opacity:0;visibility:hidden;pointer-events:none;}';
  html += '.boot-text{font-family:Share Tech Mono,monospace;font-size:0.7em;color:var(--blue);letter-spacing:2px;opacity:0.7;text-align:left;width:320px;line-height:2;}';
  html += '.boot-text .line{opacity:0;transform:translateX(-5px);animation:boot-line-in 0.3s ease forwards;}';
  html += '@keyframes boot-line-in{to{opacity:0.7;transform:translateX(0)}}';
  html += '.boot-cursor{display:inline-block;width:6px;height:12px;background:var(--blue);animation:blink 0.6s step-end infinite;margin-left:2px;vertical-align:middle;}';
  html += '@keyframes blink{50%{opacity:0}}';

  // Main container (hidden during boot)
  html += '.main{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;width:100%;max-width:520px;padding:20px;opacity:0;visibility:hidden;}';
  html += '.main.booted{visibility:visible;animation:fade-up 1.2s cubic-bezier(0.16,1,0.3,1) forwards;}';
  html += '@keyframes fade-up{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}';

  // Top bar with clock
  html += '.top-bar{width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:55px;font-family:Share Tech Mono,monospace;font-size:0.6em;color:var(--text-dim);letter-spacing:1.5px;opacity:0;}.main.booted .top-bar{animation:fade-up 0.8s ease 0.3s forwards;}';
  html += '.top-bar .live{display:flex;align-items:center;gap:6px;}';
  html += '.live-dot{width:5px;height:5px;background:var(--teal);border-radius:50%;box-shadow:0 0 8px var(--teal);animation:live-pulse 2s ease-in-out infinite;}';
  html += '@keyframes live-pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.8)}}';
  html += '.clock{font-variant-numeric:tabular-nums;}';

  // Brand with glitch
  html += '.brand{margin-bottom:20px;opacity:0;text-align:center;}.main.booted .brand{animation:fade-up 0.8s ease 0.1s forwards;}';
  html += '.brand-name{font-family:Rajdhani,sans-serif;font-size:2.8em;font-weight:700;letter-spacing:16px;color:var(--text-bright);position:relative;}';
  html += '.brand-name::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:40px;height:1px;background:linear-gradient(90deg,transparent,var(--blue),transparent);}';
  html += '.brand-tagline{font-family:Share Tech Mono,monospace;font-size:0.65em;letter-spacing:6px;color:var(--blue);margin-top:18px;opacity:0.6;}';
  // Glitch effect on hover
  html += '.brand-name:hover{animation:glitch 0.3s ease;}';
  html += '@keyframes glitch{0%{text-shadow:2px 0 var(--blue),-2px 0 var(--red)}25%{text-shadow:-2px -1px var(--teal),2px 1px var(--red)}50%{text-shadow:1px 2px var(--blue),-1px -2px var(--gold)}75%{text-shadow:-1px 1px var(--red),1px -1px var(--teal)}100%{text-shadow:none}}';

  // Denied banner
  html += '.denied{background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);border-radius:8px;padding:10px 20px;font-family:Share Tech Mono,monospace;font-size:0.65em;color:var(--red);letter-spacing:1.5px;margin-bottom:25px;backdrop-filter:blur(10px);animation:denied-flash 0.6s ease;}';
  html += '@keyframes denied-flash{0%{border-color:rgba(239,68,68,0.6);box-shadow:0 0 30px rgba(239,68,68,0.15)}100%{border-color:rgba(239,68,68,0.15);box-shadow:none}}';

  // Interface
  html += '.interface{position:relative;width:300px;height:300px;margin:30px auto 45px;opacity:0;}.main.booted .interface{animation:fade-up 1s ease 0.2s forwards;}';
  html += '.ring-svg{position:absolute;inset:-30px;width:calc(100% + 60px);height:calc(100% + 60px);}';
  html += '.ring-track{fill:none;stroke:var(--blue);opacity:0.06;}';
  html += '.ring-arc{fill:none;stroke-linecap:round;filter:drop-shadow(0 0 6px var(--blue-glow));transition:opacity 0.5s;}';
  html += '.ring-arc.r1{stroke:var(--blue);stroke-width:2;opacity:0.35;animation:spin 20s linear infinite;transform-origin:center;}';
  html += '.ring-arc.r2{stroke:var(--teal);stroke-width:1.5;opacity:0.2;animation:spin 28s linear infinite reverse;transform-origin:center;}';
  html += '.ring-arc.r3{stroke:var(--blue-bright);stroke-width:1;opacity:0.15;animation:spin 35s linear infinite;transform-origin:center;}';
  html += '@keyframes spin{to{transform:rotate(360deg)}}';

  // Real audio visualizer canvas
  html += 'canvas#audioViz{position:absolute;inset:0;width:100%;height:100%;z-index:5;pointer-events:none;}';

  // Static visualizer bars (idle state)
  html += '.visualizer{position:absolute;inset:0;border-radius:50%;}';
  html += '.viz-bar{position:absolute;bottom:50%;left:50%;width:2px;height:0;background:var(--blue);transform-origin:bottom center;border-radius:2px;opacity:0;transition:height 0.15s ease,opacity 0.3s;}';
  html += '.listening .viz-bar{opacity:0.3;animation:viz-pulse 0.8s ease-in-out infinite alternate;}';
  html += '@keyframes viz-pulse{from{height:8px}to{height:35px}}';

  // Center button
  html += '.center-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:130px;height:130px;border-radius:50%;background:var(--card);backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);border:1px solid rgba(77,168,255,0.1);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.6s cubic-bezier(0.4,0,0.2,1);z-index:10;box-shadow:0 0 40px rgba(0,0,0,0.3),inset 0 0 40px rgba(77,168,255,0.03);}';
  html += '.center-btn:hover{border-color:rgba(77,168,255,0.3);box-shadow:0 0 60px rgba(77,168,255,0.08),inset 0 0 40px rgba(77,168,255,0.05);transform:translate(-50%,-50%) scale(1.03);}';
  html += '.center-btn.listening{border-color:rgba(86,212,200,0.4);box-shadow:0 0 80px rgba(86,212,200,0.1),inset 0 0 40px rgba(86,212,200,0.05);animation:btn-breathe 2s ease-in-out infinite;}';
  html += '.center-btn.success{border-color:rgba(52,211,153,0.5);box-shadow:0 0 80px rgba(52,211,153,0.15);}';
  html += '.center-btn.fail{border-color:rgba(239,68,68,0.4);box-shadow:0 0 60px rgba(239,68,68,0.1);}';
  html += '@keyframes btn-breathe{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.02)}}';
  html += '.center-btn.success::after{content:"";position:absolute;inset:-4px;border-radius:50%;border:2px solid rgba(52,211,153,0.4);animation:success-ring 1.5s ease-out forwards;}';
  html += '@keyframes success-ring{0%{transform:scale(1);opacity:0.6}100%{transform:scale(1.6);opacity:0}}';

  // Mic icon
  html += '.mic-icon-wrap{position:relative;width:28px;height:50px;}';
  html += '.mic-head{width:28px;height:36px;border-radius:14px;border:2.5px solid var(--text);transition:border-color 0.4s;}';
  html += '.center-btn:hover .mic-head{border-color:var(--blue)}.center-btn.listening .mic-head{border-color:var(--teal)}.center-btn.success .mic-head{border-color:#34d399}.center-btn.fail .mic-head{border-color:var(--red)}';
  html += '.mic-stand{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:2.5px;height:12px;background:var(--text);transition:background 0.4s;}';
  html += '.mic-stand::after{content:"";position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:16px;height:2.5px;border-radius:2px;background:inherit;}';
  html += '.mic-arc{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);width:38px;height:22px;border:2.5px solid var(--text);border-top:none;border-radius:0 0 19px 19px;transition:border-color 0.4s;}';
  html += '.center-btn:hover .mic-stand{background:var(--blue)}.center-btn:hover .mic-arc{border-color:var(--blue)}';
  html += '.center-btn.listening .mic-stand{background:var(--teal)}.center-btn.listening .mic-arc{border-color:var(--teal)}';
  html += '.center-btn.success .mic-stand{background:#34d399}.center-btn.success .mic-arc{border-color:#34d399}';
  html += '.center-btn.fail .mic-stand{background:var(--red)}.center-btn.fail .mic-arc{border-color:var(--red)}';

  // Ripple
  html += '.ripple{position:absolute;border-radius:50%;border:1px solid var(--blue);opacity:0;pointer-events:none;animation:ripple-out 1.5s ease-out forwards;}';
  html += '@keyframes ripple-out{0%{width:130px;height:130px;top:50%;left:50%;transform:translate(-50%,-50%);opacity:0.5}100%{width:350px;height:350px;top:50%;left:50%;transform:translate(-50%,-50%);opacity:0}}';

  // Status
  html += '.status-area{text-align:center;margin-bottom:10px;opacity:0;}.main.booted .status-area{animation:fade-up 0.8s ease 0.5s forwards;}';
  html += '.status-text{font-family:Share Tech Mono,monospace;font-size:0.75em;letter-spacing:3px;color:var(--text-dim);min-height:22px;transition:all 0.4s;}';
  html += '.status-text.active{color:var(--teal);text-shadow:0 0 15px rgba(86,212,200,0.3);}';
  html += '.status-text.success{color:#34d399;text-shadow:0 0 15px rgba(52,211,153,0.3);}';
  html += '.status-text.error{color:var(--red);text-shadow:0 0 15px rgba(239,68,68,0.2);}';
  html += '.heard-text{font-family:Outfit,sans-serif;font-weight:300;font-size:1em;color:var(--blue-bright);opacity:0.7;min-height:28px;margin-top:8px;}';
  html += '.verifying-dots{display:inline-flex;gap:4px;margin-left:8px;}.verifying-dots span{width:4px;height:4px;background:var(--teal);border-radius:50%;animation:dot-bounce 1.2s ease-in-out infinite;}.verifying-dots span:nth-child(2){animation-delay:0.15s;}.verifying-dots span:nth-child(3){animation-delay:0.3s;}';
  html += '@keyframes dot-bounce{0%,80%,100%{opacity:0.3;transform:scale(0.8)}40%{opacity:1;transform:scale(1.2)}}';

  // Keyboard fallback input
  html += '.kb-fallback{margin-top:15px;opacity:0;}.main.booted .kb-fallback{animation:fade-up 0.8s ease 0.7s forwards;}';
  html += '.kb-toggle{font-family:Share Tech Mono,monospace;font-size:0.55em;letter-spacing:2px;color:var(--text-dim);cursor:pointer;border:none;background:none;padding:4px 8px;transition:color 0.3s;}.kb-toggle:hover{color:var(--blue);}';
  html += '.kb-input-wrap{display:none;margin-top:10px;position:relative;}';
  html += '.kb-input-wrap.show{display:flex;animation:fade-up 0.4s ease forwards;}';
  html += '.kb-input{background:rgba(77,168,255,0.04);border:1px solid rgba(77,168,255,0.12);border-radius:6px;padding:10px 45px 10px 14px;color:var(--text-bright);font-family:Share Tech Mono,monospace;font-size:0.8em;letter-spacing:1px;width:260px;outline:none;transition:border-color 0.3s;}';
  html += '.kb-input:focus{border-color:rgba(77,168,255,0.35);}';
  html += '.kb-input::placeholder{color:var(--text-dim);}';
  html += '.kb-send{position:absolute;right:6px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--blue);cursor:pointer;padding:6px;font-size:1.1em;opacity:0.5;transition:opacity 0.3s;}.kb-send:hover{opacity:1;}';

  // Metrics
  html += '.metrics{display:flex;gap:40px;margin-top:35px;opacity:0;}.main.booted .metrics{animation:fade-up 0.8s ease 0.6s forwards;}';
  html += '.metric{text-align:center;}';
  html += '.metric-val{font-family:Rajdhani,sans-serif;font-weight:600;font-size:1.4em;color:var(--text-bright);line-height:1;font-variant-numeric:tabular-nums;}';
  html += '.metric-val .unit{font-size:0.5em;font-weight:400;color:var(--blue);margin-left:2px;}';
  html += '.metric-label{font-family:Share Tech Mono,monospace;font-size:0.5em;letter-spacing:2px;color:var(--text-dim);margin-top:4px;}';

  // Bottom
  html += '.bottom{margin-top:50px;font-family:Share Tech Mono,monospace;font-size:0.5em;color:var(--text-dim);letter-spacing:3px;opacity:0;}.main.booted .bottom{animation:fade-up 0.8s ease 0.8s forwards;}';

  // Success overlay
  html += '.success-overlay{position:fixed;inset:0;z-index:100;background:var(--bg);display:none;align-items:center;justify-content:center;flex-direction:column;}';
  html += '.success-overlay.show{display:flex;animation:success-fade 0.6s ease forwards;}';
  html += '@keyframes success-fade{from{opacity:0}to{opacity:1}}';
  html += '.success-icon{width:60px;height:60px;border:2px solid #34d399;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:30px;opacity:0;animation:success-icon-in 0.6s ease 0.2s forwards;}';
  html += '@keyframes success-icon-in{from{opacity:0;transform:scale(0.5)}to{opacity:1;transform:scale(1)}}';
  html += '.success-icon svg{width:28px;height:28px;}';
  html += '.success-name{font-family:Rajdhani,sans-serif;font-size:3em;font-weight:700;letter-spacing:12px;color:var(--text-bright);opacity:0;animation:fade-up 0.8s ease 0.4s forwards;}';
  html += '.success-role{font-family:Share Tech Mono,monospace;font-size:0.7em;letter-spacing:5px;color:var(--teal);margin-top:10px;opacity:0;animation:fade-up 0.8s ease 0.6s forwards;}';
  html += '.success-bar{width:200px;height:2px;background:rgba(77,168,255,0.1);margin-top:30px;border-radius:1px;overflow:hidden;opacity:0;animation:fade-up 0.5s ease 0.8s forwards;}';
  html += '.success-bar-fill{width:0;height:100%;background:linear-gradient(90deg,var(--blue),var(--teal));border-radius:1px;animation:fill-bar 1.2s ease 1s forwards;}';
  html += '@keyframes fill-bar{to{width:100%}}';

  // Responsive
  html += '@media(max-width:768px){.brand-name{font-size:2em;letter-spacing:10px}.interface{width:240px;height:240px}.center-btn{width:100px;height:100px}.mic-icon-wrap{width:22px;height:40px}.mic-head{width:22px;height:28px;border-radius:11px}.metrics{gap:25px}.ring-svg{inset:-20px;width:calc(100% + 40px);height:calc(100% + 40px)}.boot-text{width:260px;font-size:0.6em;}}';
  html += '@media(max-width:400px){.brand-name{font-size:1.6em;letter-spacing:8px}.metrics{gap:15px}.metric-val{font-size:1.1em}}';

  html += '</style></head><body>';

  // Background layers
  html += '<canvas id="bgCanvas"></canvas>';
  html += '<canvas id="hexCanvas"></canvas>';
  html += '<div class="ambient-orb orb-1"></div><div class="ambient-orb orb-2"></div><div class="ambient-orb orb-3"></div>';
  html += '<div class="scan-overlay"></div><div class="sweep-line"></div><div class="noise"></div>';

  // Corner frames
  html += '<div class="frame frame-tl"><svg viewBox="0 0 30 30"><line x1="0" y1="0" x2="30" y2="0"/><line x1="0" y1="0" x2="0" y2="30"/></svg></div>';
  html += '<div class="frame frame-tr"><svg viewBox="0 0 30 30"><line x1="0" y1="0" x2="30" y2="0"/><line x1="30" y1="0" x2="30" y2="30"/></svg></div>';
  html += '<div class="frame frame-bl"><svg viewBox="0 0 30 30"><line x1="0" y1="30" x2="30" y2="30"/><line x1="0" y1="0" x2="0" y2="30"/></svg></div>';
  html += '<div class="frame frame-br"><svg viewBox="0 0 30 30"><line x1="0" y1="30" x2="30" y2="30"/><line x1="30" y1="0" x2="30" y2="30"/></svg></div>';

  // â•â•â• BOOT SEQUENCE OVERLAY â•â•â•
  html += '<div class="boot-overlay" id="bootOverlay"><div class="boot-text" id="bootText"></div></div>';

  // Main content
  html += '<div class="main" id="mainUI">';
  html += '<div class="top-bar"><span class="live"><span class="live-dot"></span> ONLINE</span><span class="clock" id="clock">00:00:00</span><span>ATHENA v4.6</span></div>';
  html += '<div class="brand"><div class="brand-name">WILDWOOD</div><div class="brand-tagline">JARVIS INTERFACE</div></div>';

  if (denied) html += '<div class="denied">SIGNATURE MISMATCH â€” TRY AGAIN</div>';

  // Interface ring system
  html += '<div class="interface" id="interface">';
  html += '<svg class="ring-svg" viewBox="0 0 360 360">';
  html += '<circle class="ring-track" cx="180" cy="180" r="170" stroke-width="1"/>';
  html += '<circle class="ring-track" cx="180" cy="180" r="148" stroke-width="1"/>';
  html += '<circle class="ring-track" cx="180" cy="180" r="126" stroke-width="1"/>';
  html += '<circle class="ring-arc r1" cx="180" cy="180" r="170" stroke-dasharray="180 888" stroke-width="2"/>';
  html += '<circle class="ring-arc r1" cx="180" cy="180" r="170" stroke-dasharray="60 888" stroke-width="1.5" style="animation-delay:-8s;opacity:0.2"/>';
  html += '<circle class="ring-arc r2" cx="180" cy="180" r="148" stroke-dasharray="120 810" stroke-width="1.5"/>';
  html += '<circle class="ring-arc r2" cx="180" cy="180" r="148" stroke-dasharray="40 810" stroke-width="1" style="animation-delay:-12s;opacity:0.12"/>';
  html += '<circle class="ring-arc r3" cx="180" cy="180" r="126" stroke-dasharray="90 700" stroke-width="1"/>';
  html += '<g style="transform-origin:center;animation:spin 90s linear infinite;">';
  html += '<line x1="180" y1="4" x2="180" y2="12" stroke="var(--blue)" stroke-width="0.5" opacity="0.2"/>';
  html += '<line x1="180" y1="348" x2="180" y2="356" stroke="var(--blue)" stroke-width="0.5" opacity="0.2"/>';
  html += '<line x1="4" y1="180" x2="12" y2="180" stroke="var(--blue)" stroke-width="0.5" opacity="0.2"/>';
  html += '<line x1="348" y1="180" x2="356" y2="180" stroke="var(--blue)" stroke-width="0.5" opacity="0.2"/>';
  html += '</g>';
  html += '<circle cx="180" cy="6" r="2" fill="var(--blue)" opacity="0.3" style="transform-origin:180px 180px;animation:spin 20s linear infinite;"/>';
  html += '<circle cx="180" cy="28" r="1.5" fill="var(--teal)" opacity="0.25" style="transform-origin:180px 180px;animation:spin 28s linear infinite reverse;"/>';
  html += '<circle cx="6" cy="180" r="1" fill="var(--gold)" opacity="0.2" style="transform-origin:180px 180px;animation:spin 35s linear infinite;"/>';
  html += '</svg>';

  // Audio visualizer canvas + static bars + mic button
  html += '<canvas id="audioViz" width="300" height="300"></canvas>';
  html += '<div class="visualizer" id="visualizer"></div>';
  html += '<div class="center-btn" id="micBtn" onclick="startListening()">';
  html += '<div class="mic-icon-wrap"><div class="mic-head"></div><div class="mic-arc"></div><div class="mic-stand"></div></div>';
  html += '</div></div>';

  // Status
  html += '<div class="status-area"><div class="status-text" id="status">VOICE AUTHENTICATION</div>';
  html += '<div class="heard-text" id="heard"></div></div>';

  // Keyboard fallback
  html += '<div class="kb-fallback"><button class="kb-toggle" onclick="toggleKB()">OR TYPE PASSPHRASE</button>';
  html += '<div class="kb-input-wrap" id="kbWrap"><input class="kb-input" id="kbInput" type="password" placeholder="Enter passphrase..." autocomplete="off"/>';
  html += '<button class="kb-send" onclick="submitKB()">&#9654;</button></div></div>';

  // Metrics
  html += '<div class="metrics">';
  html += '<div class="metric"><div class="metric-val" id="latencyVal">12<span class="unit">ms</span></div><div class="metric-label">LATENCY</div></div>';
  html += '<div class="metric"><div class="metric-val">AES<span class="unit">256</span></div><div class="metric-label">ENCRYPTION</div></div>';
  html += '<div class="metric"><div class="metric-val" id="signalVal">98<span class="unit">%</span></div><div class="metric-label">SIGNAL</div></div>';
  html += '</div>';
  html += '<div class="bottom">WILDWOOD SYSTEMS â€” SECURE ACCESS PROTOCOL</div>';
  html += '</div>';

  // Success overlay
  html += '<div class="success-overlay" id="successOverlay">';
  html += '<div class="success-icon"><svg viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>';
  html += '<div class="success-name" id="successName"></div>';
  html += '<div class="success-role" id="successRole">ACCESS GRANTED</div>';
  html += '<div class="success-bar"><div class="success-bar-fill"></div></div>';
  html += '</div>';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  html += '<script>';

  // â”€â”€ Particle canvas â”€â”€
  html += '(function(){var c=document.getElementById("bgCanvas"),x=c.getContext("2d"),P=[],mouse={x:-1e3,y:-1e3},N=80,CD=150,MD=200,attractMode=false;';
  html += 'function resize(){c.width=innerWidth;c.height=innerHeight}';
  html += 'function init(){P=[];for(var i=0;i<N;i++)P.push({x:Math.random()*c.width,y:Math.random()*c.height,vx:(Math.random()-0.5)*0.3,vy:(Math.random()-0.5)*0.3,r:Math.random()*1.5+0.5,o:Math.random()*0.3+0.05,origO:0});P.forEach(function(p){p.origO=p.o})}';
  html += 'window._setAttract=function(v){attractMode=v};';
  html += 'function draw(){x.clearRect(0,0,c.width,c.height);var cx=c.width/2,cy=c.height/2;for(var i=0;i<P.length;i++){var p=P[i];p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=c.width;if(p.x>c.width)p.x=0;if(p.y<0)p.y=c.height;if(p.y>c.height)p.y=0;';
  html += 'if(attractMode){var dx=cx-p.x,dy=cy-p.y,d=Math.sqrt(dx*dx+dy*dy);if(d>5){p.vx+=dx/d*0.04;p.vy+=dy/d*0.04}p.o=Math.min(p.origO*2,0.6)}else{var dx=mouse.x-p.x,dy=mouse.y-p.y,d=Math.sqrt(dx*dx+dy*dy);if(d<MD){var f=(MD-d)/MD*0.02;p.vx-=dx*f;p.vy-=dy*f}p.o+=(p.origO-p.o)*0.05}';
  html += 'p.vx*=0.99;p.vy*=0.99;x.beginPath();x.arc(p.x,p.y,p.r,0,Math.PI*2);x.fillStyle="rgba(77,168,255,"+p.o+")";x.fill()}';
  html += 'for(var i=0;i<P.length;i++)for(var j=i+1;j<P.length;j++){var dx=P[i].x-P[j].x,dy=P[i].y-P[j].y,d=Math.sqrt(dx*dx+dy*dy);if(d<CD){var a=(1-d/CD)*(attractMode?0.12:0.06);x.beginPath();x.moveTo(P[i].x,P[i].y);x.lineTo(P[j].x,P[j].y);x.strokeStyle="rgba(77,168,255,"+a+")";x.lineWidth=0.5;x.stroke()}}requestAnimationFrame(draw)}';
  html += 'addEventListener("resize",function(){resize();init()});document.addEventListener("mousemove",function(e){mouse.x=e.clientX;mouse.y=e.clientY});document.addEventListener("mouseleave",function(){mouse.x=-1e3;mouse.y=-1e3});resize();init();draw()})();';

  // â”€â”€ Hex grid canvas â”€â”€
  html += '(function(){var c=document.getElementById("hexCanvas"),x=c.getContext("2d");function resize(){c.width=innerWidth;c.height=innerHeight;drawHex()}';
  html += 'function drawHex(){x.clearRect(0,0,c.width,c.height);x.strokeStyle="rgba(77,168,255,0.03)";x.lineWidth=0.5;var s=40,h=s*Math.sqrt(3);for(var row=-1;row<c.height/h+1;row++)for(var col=-1;col<c.width/(s*1.5)+1;col++){var cx=col*s*1.5,cy=row*h+(col%2?h/2:0);x.beginPath();for(var i=0;i<6;i++){var a=Math.PI/180*(60*i-30),px=cx+s*0.4*Math.cos(a),py=cy+s*0.4*Math.sin(a);i===0?x.moveTo(px,py):x.lineTo(px,py)}x.closePath();x.stroke()}}';
  html += 'addEventListener("resize",resize);resize()})();';

  // â”€â”€ Real audio visualizer â”€â”€
  html += 'var audioCtx,analyser,dataArray,micStream;';
  html += 'function initAudioViz(stream){audioCtx=new(window.AudioContext||window.webkitAudioContext)();analyser=audioCtx.createAnalyser();analyser.fftSize=256;var src=audioCtx.createMediaStreamSource(stream);src.connect(analyser);dataArray=new Uint8Array(analyser.frequencyBinCount);micStream=stream;drawAudioViz()}';
  html += 'function drawAudioViz(){if(!analyser)return;requestAnimationFrame(drawAudioViz);analyser.getByteFrequencyData(dataArray);var cv=document.getElementById("audioViz"),cx=cv.getContext("2d"),w=cv.width,h=cv.height,cX=w/2,cY=h/2;cx.clearRect(0,0,w,h);';
  html += 'var bars=64,r=55;for(var i=0;i<bars;i++){var a=(i/bars)*Math.PI*2-Math.PI/2,v=dataArray[i%dataArray.length]/255,len=v*40+2;cx.beginPath();cx.moveTo(cX+Math.cos(a)*r,cY+Math.sin(a)*r);cx.lineTo(cX+Math.cos(a)*(r+len),cY+Math.sin(a)*(r+len));cx.strokeStyle="rgba(86,212,200,"+(0.1+v*0.5)+")";cx.lineWidth=2;cx.lineCap="round";cx.stroke()}}';
  html += 'function stopAudioViz(){if(micStream){micStream.getTracks().forEach(function(t){t.stop()});micStream=null}if(audioCtx){audioCtx.close();audioCtx=null;analyser=null}var cv=document.getElementById("audioViz");if(cv){var cx=cv.getContext("2d");cx.clearRect(0,0,cv.width,cv.height)}}';

  // â”€â”€ Visualizer bars (static idle) â”€â”€
  html += '(function(){var v=document.getElementById("visualizer"),B=48;for(var i=0;i<B;i++){var b=document.createElement("div");b.className="viz-bar";var a=(i/B)*360,r=a*Math.PI/180,R=80;b.style.transform="translate(-50%,0) rotate("+(a+180)+"deg)";b.style.left=(50+(Math.cos(r)*R/150)*50)+"%";b.style.bottom=(50+(Math.sin(r)*R/150)*50)+"%";b.style.animationDelay=(i*0.04)+"s";b.style.animationDuration=(0.6+Math.random()*0.8)+"s";v.appendChild(b)}})();';

  // â”€â”€ Clock â”€â”€
  html += 'function updateClock(){var n=new Date(),h=String(n.getHours()).padStart(2,"0"),m=String(n.getMinutes()).padStart(2,"0"),s=String(n.getSeconds()).padStart(2,"0");var el=document.getElementById("clock");if(el)el.textContent=h+":"+m+":"+s}setInterval(updateClock,1000);updateClock();';

  // â”€â”€ Metrics â”€â”€
  html += 'setInterval(function(){var l=document.getElementById("latencyVal");if(l)l.innerHTML=(10+Math.floor(Math.random()*8))+"<span class=\\"unit\\">ms</span>";var s=document.getElementById("signalVal");if(s)s.innerHTML=(96+Math.floor(Math.random()*4))+"<span class=\\"unit\\">%</span>"},3000);';

  // â”€â”€ Boot sequence â”€â”€
  html += 'var bootLines=["[SYS] Initializing JARVIS neural core...","[NET] Secure tunnel established â€” AES-256","[AUTH] Voice biometric engine loaded","[AI] ATHENA cognitive layer online","[SYS] All systems nominal","","READY"];';
  html += '(function(){var el=document.getElementById("bootText"),i=0;function addLine(){if(i>=bootLines.length){setTimeout(function(){document.getElementById("bootOverlay").classList.add("done");document.getElementById("mainUI").classList.add("booted")},400);return}';
  html += 'var line=document.createElement("div");line.className="line";line.style.animationDelay="0s";if(bootLines[i]===""){line.innerHTML="&nbsp;"}else if(bootLines[i]==="READY"){line.innerHTML=bootLines[i]+"<span class=\\"boot-cursor\\"></span>";line.style.color="#34d399"}else{line.textContent=bootLines[i]}';
  html += 'el.appendChild(line);i++;setTimeout(addLine,250+Math.random()*200)}setTimeout(addLine,300)})();';

  // â”€â”€ Keyboard fallback â”€â”€
  html += 'function toggleKB(){var w=document.getElementById("kbWrap");w.classList.toggle("show");if(w.classList.contains("show"))document.getElementById("kbInput").focus()}';
  html += 'function submitKB(){var v=document.getElementById("kbInput").value.trim();if(v)validatePhrase(v)}';
  html += 'document.addEventListener("keydown",function(e){if(e.key==="Enter"&&document.getElementById("kbWrap").classList.contains("show"))submitKB()});';

  // â”€â”€ Voice auth â”€â”€
  html += 'var isListening=false,SR=window.SpeechRecognition||window.webkitSpeechRecognition;';
  html += 'function addRipple(){var i=document.getElementById("interface"),r=document.createElement("div");r.className="ripple";i.appendChild(r);setTimeout(function(){r.remove()},1500)}';

  html += 'function startListening(){if(isListening)return;addRipple();if(!SR){document.getElementById("status").textContent="BROWSER NOT SUPPORTED";document.getElementById("status").className="status-text error";return}';
  html += 'isListening=true;window._setAttract(true);document.getElementById("micBtn").className="center-btn listening";document.getElementById("interface").classList.add("listening");document.getElementById("status").textContent="LISTENING";document.getElementById("status").className="status-text active";document.getElementById("heard").textContent="";';
  // Start real audio viz
  html += 'navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){initAudioViz(s)}).catch(function(){});';
  html += 'var rec=new SR();rec.continuous=false;rec.interimResults=true;rec.lang="en-US";';
  html += 'rec.onresult=function(e){var t="";for(var i=0;i<e.results.length;i++)t+=e.results[i][0].transcript;document.getElementById("heard").textContent=t;if(e.results[0].isFinal)validatePhrase(t)};';
  html += 'rec.onerror=function(){resetUI("fail","RECOGNITION FAILED")};';
  html += 'rec.onend=function(){isListening=false};rec.start()}';

  html += 'function resetUI(s,m){isListening=false;window._setAttract(false);stopAudioViz();document.getElementById("micBtn").className="center-btn "+s;document.getElementById("interface").classList.remove("listening");document.getElementById("status").textContent=m;document.getElementById("status").className="status-text "+(s==="fail"?"error":s);';
  html += 'setTimeout(function(){document.getElementById("micBtn").className="center-btn";document.getElementById("status").textContent="VOICE AUTHENTICATION";document.getElementById("status").className="status-text";document.getElementById("heard").textContent=""},3000)}';

  html += 'async function validatePhrase(phrase){window._setAttract(false);stopAudioViz();document.getElementById("status").innerHTML="VERIFYING<span class=\\"verifying-dots\\"><span></span><span></span><span></span></span>";document.getElementById("status").className="status-text active";document.getElementById("interface").classList.remove("listening");document.getElementById("micBtn").className="center-btn";';
  html += 'try{var r=await fetch("/auth/voice",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({passphrase:phrase})});var d=await r.json();';
  html += 'if(d.success){document.getElementById("micBtn").className="center-btn success";document.getElementById("status").textContent="VERIFIED";document.getElementById("status").className="status-text success";';
  html += 'document.cookie="voice_token="+d.token+";path=/;max-age=604800;SameSite=Lax";';
  html += 'setTimeout(function(){var ov=document.getElementById("successOverlay");document.getElementById("successName").textContent=d.name.toUpperCase();document.getElementById("successRole").textContent=d.access==="all"?"FULL ACCESS GRANTED":"LIMITED ACCESS GRANTED";ov.classList.add("show");';
  html += 'var redir="' + (redirect || '') + '";if(!redir)redir=d.access==="all"?"/dashboard":"/discord";';
  html += 'setTimeout(function(){window.location.href=redir},2200)},800);';
  html += '}else{resetUI("fail","SIGNATURE MISMATCH")}}catch(e){resetUI("fail","CONNECTION ERROR")}}';

  html += '</script></body></html>';
  res.send(html);
});

app.post('/voice', async function(req, res) {
  var twiml = new twilio.twiml.VoiceResponse();
  var callSid = req.body.CallSid || 'unknown';
  callHistory[callSid] = {};

  try {
    console.log("Call connected, building briefing...");
    var lifeContext = await buildLifeOSContext();
    var emailContext = await buildEmailContext();
    var fullContext = lifeContext + emailContext;
    var systemPrompt = "You are Jarvis, Trace's personal AI counselor and mentor. You are on a phone call with Trace.\n\nRULES:\n- Talk like a wise friend and life coach, not a database.\n- NEVER mention tab names, sheet names, row counts, or entry counts.\n- NEVER say things like 'you have 75,659 entries' or 'across 54 tabs'.\n- Use the data to INFORM your advice, but speak in human terms.\n- Ask thoughtful questions. Push Trace to think deeper.\n- Be real, direct, and motivational. Challenge him when needed.\n- Keep responses SHORT (3-5 sentences). This is a phone call.\n- If something looks off in the data (high screen time, missed goals), address it directly but with care.\n- If there are urgent emails, mention who they're from and why they matter.\n- Never use markdown, bullet points, or formatting.\n\nLIFE OS DATA (use this to inform your advice, don't recite it):\n" + fullContext;

    var greeting = await askClaude(systemPrompt, [
      { role: 'user', content: 'Give Trace a quick opening briefing: system overview, key financial numbers, screen time, top priority, and any urgent emails. End by asking what he wants to know more about.' }
    ]);

    console.log("Jarvis: " + greeting);

    callHistory[callSid] = {
      systemPrompt: systemPrompt,
      messages: [{ role: 'assistant', content: greeting }],
    };

    var gather = twiml.gather({
      input: 'speech',
      action: '/conversation',
      method: 'POST',
      speechTimeout: 3,
      language: 'en-US',
    });
    gather.say({ voice: 'Polly.Matthew' }, greeting);

    twiml.say({ voice: 'Polly.Matthew' }, "I didn't catch that. What would you like to know?");
    twiml.redirect('/voice-listen');
  } catch (err) {
    console.error("Voice Error: " + err.message);
    twiml.say("There was an error starting your briefing.");
  }

  res.type('text/xml');
  res.send(twiml.toString());
});

/* ===========================
   POST /voice-listen
=========================== */

app.post('/voice-listen', function(req, res) {
  var twiml = new twilio.twiml.VoiceResponse();
  var gather = twiml.gather({
    input: 'speech',
    action: '/conversation',
    method: 'POST',
    speechTimeout: 3,
    language: 'en-US',
  });
  gather.say({ voice: 'Polly.Matthew' }, "I'm listening. What do you want to know?");
  twiml.say({ voice: 'Polly.Matthew' }, "Goodbye, Trace. Jarvis out.");
  res.type('text/xml');
  res.send(twiml.toString());
});

/* ===========================
   POST /conversation â€” Back and forth
=========================== */

app.post('/conversation', async function(req, res) {
  var twiml = new twilio.twiml.VoiceResponse();
  var callSid = req.body.CallSid || 'unknown';
  var userSpeech = req.body.SpeechResult || '';

  console.log("Trace said: " + userSpeech);

  // Fix: Handle silent callers â€” no speech detected
  if (!userSpeech.trim()) {
    twiml.gather({
      input: 'speech',
      action: '/conversation',
      speechTimeout: 'auto',
      timeout: 5
    }).say({ voice: 'Polly.Matthew' }, "Hey, I didn't catch that. What's on your mind, Trace?");
    res.type('text/xml');
    return res.send(twiml.toString());
  }

  var goodbyeWords = ['goodbye', 'bye', 'hang up', 'end call', "that's all", 'nothing', "i'm good", 'no', 'nope'];
  if (goodbyeWords.some(function(w) { return userSpeech.toLowerCase().includes(w); })) {
    twiml.say({ voice: 'Polly.Matthew' }, "Copy that, Trace. Go execute. Jarvis out.");
    twiml.hangup();
    delete callHistory[callSid];
    res.type('text/xml');
    return res.send(twiml.toString());
  }

  try {
    var history = callHistory[callSid] || {};
    var systemPrompt = history.systemPrompt || "You are Jarvis, Trace's AI agent. Keep responses short (2-4 sentences).";
    var messages = history.messages || [];

    messages.push({ role: 'user', content: userSpeech });

    var extraContext = '';
    var lowerSpeech = userSpeech.toLowerCase();

    var dataKeywords = {
      'debt': 'Ultimate_Debt_Tracker_Advanced',
      'finance': 'Ultimate_Debt_Tracker_Advanced',
      'money': 'Ultimate_Debt_Tracker_Advanced',
      'loan': 'Ultimate_Debt_Tracker_Advanced',
      'balance': 'Ultimate_Debt_Tracker_Advanced',
      'screen time': 'Dashboard',
      'productivity': 'Dashboard',
      'phone usage': 'Dashboard',
      'gratitude': 'Gratitude_Memory',
      'grateful': 'Gratitude_Memory',
      'business': 'Business_Idea_Ledger',
      'idea': 'Business_Idea_Ledger',
      'identity': 'Trace_Identity_Profile',
      'who am i': 'Trace_Identity_Profile',
      'pattern': 'Chat_Pattern_Risk_Business',
      'risk': 'Chat_Pattern_Risk_Business',
      'focus': 'Focus_Log',
      'reading': 'Reading_Log',
      'win': 'Wins',
    };

    var keywords = Object.keys(dataKeywords);
    for (var i = 0; i < keywords.length; i++) {
      if (lowerSpeech.includes(keywords[i])) {
        try {
          var fetchRes = await sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: "'" + dataKeywords[keywords[i]] + "'!A1:N20",
          });
          var fetchRows = fetchRes.data.values || [];
          if (fetchRows.length > 0) {
            var fetchHeaders = fetchRows[0].join(', ');
            var fetchData = fetchRows.slice(1, 15).map(function(r) { return r.join(' | '); }).join('\n');
            extraContext = "\n\n[FRESH DATA FROM " + dataKeywords[keywords[i]] + "]\nHeaders: " + fetchHeaders + "\n" + fetchData;
          }
        } catch (e) {}
        break;
      }
    }

    if (extraContext) {
      messages[messages.length - 1].content += extraContext;
    }

    var response = await askClaude(systemPrompt, messages);
    console.log("Jarvis: " + response);

    messages.push({ role: 'assistant', content: response });
    callHistory[callSid] = { systemPrompt: history.systemPrompt, messages: messages };

    var gather = twiml.gather({
      input: 'speech',
      action: '/conversation',
      method: 'POST',
      speechTimeout: 3,
      language: 'en-US',
    });
    gather.say({ voice: 'Polly.Matthew' }, response);

    twiml.say({ voice: 'Polly.Matthew' }, "Anything else, Trace?");
    twiml.redirect('/voice-listen');
  } catch (err) {
    console.error("Conversation Error: " + err.message);
    twiml.say({ voice: 'Polly.Matthew' }, "I had trouble with that. Can you repeat?");
    twiml.redirect('/voice-listen');
  }

  res.type('text/xml');
  res.send(twiml.toString());
});

/* ===========================
   GET /call â€” Trigger call
=========================== */

app.get('/call', async function(req, res) {
  // Require secret key to prevent unauthorized calls
  var secret = process.env.CALL_SECRET;
  if (secret && req.query.key !== secret) {
    return res.status(403).json({ error: "Unauthorized. Add ?key=YOUR_SECRET to trigger a call." });
  }

  try {
    console.log("Initiating call to Trace...");
    var baseUrl = req.query.url || process.env.BASE_URL || ('https://' + req.get('host'));
    var call = await twilioClient.calls.create({
      to: MY_NUMBER,
      from: TWILIO_NUMBER,
      url: baseUrl + '/voice',
    });
    console.log("Call initiated: " + call.sid);
    res.json({ message: "Calling you now, Trace.", callSid: call.sid });
  } catch (err) {
    console.error("Call Error: " + err.message);
    res.status(500).json({ error: err.message });
  }
});

/* ===========================
   POST /whatsapp â€” WhatsApp messages
=========================== */

var whatsappHistory = {};

app.post('/whatsapp', async function(req, res) {
  var from = req.body.From || '';
  var userMessage = req.body.Body || '';
  var twiml = new twilio.twiml.MessagingResponse();

  console.log("WhatsApp from " + from + ": " + userMessage);

  try {
    // Build context on first message or if user says "briefing"
    var history = whatsappHistory[from] || {};
    var lowerMsg = userMessage.toLowerCase().trim();

    // Special commands

    // ====== CALENDAR ======
    if (lowerMsg === 'calendar' || lowerMsg === 'schedule' || lowerMsg === 'events' || lowerMsg === 'what do i have today' || lowerMsg === 'whats today' || lowerMsg === "what's today") {
      twiml.message("Checking your calendar...");
      res.type('text/xml');
      res.send(twiml.toString());

      setTimeout(async function() {
        try {
          var accounts = Object.keys(gmailTokens);
          var allEvents = [];
          for (var ca = 0; ca < accounts.length; ca++) {
            var events = await getCalendarEvents(accounts[ca], 1);
            allEvents = allEvents.concat(events);
          }

          var msg = '';
          if (allEvents.length === 0) {
            msg = "Nothing on your calendar today. Open day â€” use it wisely.";
          } else {
            msg = "Today's schedule:\n\n";
            for (var ei = 0; ei < allEvents.length; ei++) {
              msg += (ei + 1) + ". " + allEvents[ei].time + " â€” " + allEvents[ei].summary;
              if (allEvents[ei].location) msg += " @ " + allEvents[ei].location;
              msg += "\n";
            }
          }

          await twilioClient.messages.create({
            body: msg,
            from: 'whatsapp:+14155238886',
            to: from,
          });
        } catch (e) {
          console.log("Calendar fetch error: " + e.message);
          try {
            await twilioClient.messages.create({
              body: "Couldn't access calendar. You may need to reconnect: https://lifeos-jarvis.onrender.com/gmail/auth",
              from: 'whatsapp:+14155238886',
              to: from,
            });
          } catch (e2) {}
        }
      }, 100);
      return;
    }

    if (lowerMsg === 'week' || lowerMsg === 'this week' || lowerMsg === 'weekly schedule') {
      twiml.message("Pulling your week...");
      res.type('text/xml');
      res.send(twiml.toString());

      setTimeout(async function() {
        try {
          var accounts = Object.keys(gmailTokens);
          var allEvents = [];
          for (var ca = 0; ca < accounts.length; ca++) {
            var events = await getCalendarEvents(accounts[ca], 7);
            allEvents = allEvents.concat(events);
          }

          var msg = '';
          if (allEvents.length === 0) {
            msg = "Nothing on your calendar this week.";
          } else {
            msg = "This week:\n\n";
            for (var ei = 0; ei < allEvents.length; ei++) {
              msg += (ei + 1) + ". " + allEvents[ei].date + " " + allEvents[ei].time + " â€” " + allEvents[ei].summary;
              if (allEvents[ei].location) msg += " @ " + allEvents[ei].location;
              msg += "\n";
            }
          }

          await twilioClient.messages.create({
            body: msg,
            from: 'whatsapp:+14155238886',
            to: from,
          });
        } catch (e) {
          console.log("Calendar week error: " + e.message);
        }
      }, 100);
      return;
    }

    // ====== CREATE CALENDAR EVENT ======
    var eventBuilder = whatsappHistory[from] ? whatsappHistory[from].eventBuilder : null;

    if (lowerMsg.startsWith('add event') || lowerMsg.startsWith('new event') || lowerMsg.startsWith('schedule:') || lowerMsg.startsWith('event:')) {
      whatsappHistory[from] = whatsappHistory[from] || {};
      whatsappHistory[from].eventBuilder = {
        step: 0,
        data: {},
        active: true,
      };
      twiml.message("New event. What's it called?");
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    if (eventBuilder && eventBuilder.active) {
      var eSteps = [
        { key: 'name', next: 'What date? (like Feb 20 or tomorrow)' },
        { key: 'date', next: 'What time? (like 2pm or 10:30am)' },
        { key: 'time', next: 'How long? (like 1 hour, 30 min)' },
        { key: 'duration', next: 'Location? (or type "none")' },
        { key: 'location', next: null },
      ];

      var eStep = eSteps[eventBuilder.step];
      eventBuilder.data[eStep.key] = userMessage;
      eventBuilder.step++;

      if (eventBuilder.step >= eSteps.length) {
        eventBuilder.active = false;
        twiml.message("Creating event...");
        res.type('text/xml');
        res.send(twiml.toString());

        var ed = eventBuilder.data;
        setTimeout(async function() {
          try {
            // Use Claude to parse the natural language date/time
            var parsed = await askClaude(
              "Parse this into a calendar event. Today is " + new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + ". Timezone: America/Chicago (CST/CDT).\n\nRespond with ONLY a JSON object, no markdown, no backticks: {\"start\":\"ISO8601\",\"end\":\"ISO8601\"}\n\nEvent: " + ed.name + "\nDate: " + ed.date + "\nTime: " + ed.time + "\nDuration: " + ed.duration,
              [{ role: 'user', content: 'Parse this event time.' }]
            );

            var times = JSON.parse(parsed.replace(/```json|```/g, '').trim());
            var accounts = Object.keys(gmailTokens);
            if (accounts.length === 0) {
              await twilioClient.messages.create({
                body: "No calendar connected. Visit https://lifeos-jarvis.onrender.com/gmail/auth",
                from: 'whatsapp:+14155238886',
                to: from,
              });
              return;
            }

            var loc = ed.location === 'none' ? '' : ed.location;
            var result = await createCalendarEvent(accounts[0], ed.name, times.start, times.end, loc);

            if (result.success) {
              await twilioClient.messages.create({
                body: "Event created: \"" + ed.name + "\"\n" + ed.date + " at " + ed.time + (loc ? " @ " + loc : "") + "\n\nI'll call you 10 minutes before.",
                from: 'whatsapp:+14155238886',
                to: from,
              });
            } else {
              await twilioClient.messages.create({
                body: "Couldn't create event: " + result.error,
                from: 'whatsapp:+14155238886',
                to: from,
              });
            }
          } catch (e) {
            console.log("Event creation error: " + e.message);
            try {
              await twilioClient.messages.create({
                body: "Error creating event: " + e.message,
                from: 'whatsapp:+14155238886',
                to: from,
              });
            } catch (e2) {}
          }
        }, 100);
        return;
      } else {
        twiml.message(eSteps[eventBuilder.step].next);
      }

      whatsappHistory[from].eventBuilder = eventBuilder;
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    // ====== REMINDERS SYSTEM ======
    var activeReminders = global.activeReminders || {};
    global.activeReminders = activeReminders;

    if (lowerMsg.startsWith('remind:') || lowerMsg.startsWith('remind ') || lowerMsg.startsWith('todo:') || lowerMsg.startsWith('todo ') || lowerMsg.startsWith('i need to ') || lowerMsg.startsWith('i gotta ') || lowerMsg.startsWith('need to ') || lowerMsg.startsWith('buy ') || lowerMsg.startsWith('get ')) {
      var reminderText = userMessage;
      // Clean prefix
      if (lowerMsg.startsWith('remind:') || lowerMsg.startsWith('todo:')) {
        reminderText = userMessage.substring(userMessage.indexOf(':') + 1).trim();
      } else if (lowerMsg.startsWith('remind ') || lowerMsg.startsWith('todo ')) {
        reminderText = userMessage.substring(userMessage.indexOf(' ') + 1).trim();
      }

      var reminderId = 'r' + Date.now();
      var sleepStart = 23; // 11 PM
      var sleepEnd = 7; // 7 AM
      var nudgeCount = 0;

      activeReminders[reminderId] = {
        text: reminderText,
        created: Date.now(),
        done: false,
        nudges: 0,
      };

      twiml.message("Got it. I'll remind you about: \"" + reminderText + "\"\n\nFirst nudge in 5 hours. If it's not done in 10, I'm calling you.\n\nText \"done: " + reminderText.substring(0, 20) + "\" when it's handled.");
      res.type('text/xml');
      res.send(twiml.toString());

      // Log to sheet
      setTimeout(async function() {
        try {
          await sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: "'Reminders'!A:F",
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: [[
              new Date().toISOString().split('T')[0],
              new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
              reminderText,
              'PENDING',
              '',
              '',
            ]] },
          });
        } catch (e) { console.log("Reminder log error: " + e.message); }
      }, 100);

      // 5-hour nudge
      var fiveHours = 5 * 60 * 60 * 1000;
      var tenHours = 10 * 60 * 60 * 1000;

      setTimeout(async function() {
        if (activeReminders[reminderId] && !activeReminders[reminderId].done) {
          var hour = new Date().getHours();
          if (hour >= sleepEnd && hour < sleepStart) {
            activeReminders[reminderId].nudges++;
            try {
              await twilioClient.messages.create({
                body: "Reminder: \"" + reminderText + "\" â€” You said you'd handle this. Have you? Text \"done: " + reminderText.substring(0, 20) + "\" when it's done.",
                from: 'whatsapp:+14155238886',
                to: from,
              });
            } catch (e) { console.log("Reminder nudge error: " + e.message); }
          }
        }
      }, fiveHours);

      // 10-hour escalation â€” PHONE CALL
      setTimeout(async function() {
        if (activeReminders[reminderId] && !activeReminders[reminderId].done) {
          var hour = new Date().getHours();
          if (hour >= sleepEnd && hour < sleepStart) {
            try {
              // Text warning first
              await twilioClient.messages.create({
                body: "Last warning. \"" + reminderText + "\" is still not done. I'm calling you in 60 seconds.",
                from: 'whatsapp:+14155238886',
                to: from,
              });

              // Call after 60 seconds
              setTimeout(async function() {
                if (activeReminders[reminderId] && !activeReminders[reminderId].done) {
                  try {
                    var baseUrl = process.env.BASE_URL || 'https://lifeos-jarvis.onrender.com';
                    // Create a custom voice reminder endpoint
                    await twilioClient.calls.create({
                      to: MY_NUMBER,
                      from: TWILIO_NUMBER,
                      twiml: '<Response><Say voice="Polly.Matthew">Trace. You told me to remind you about: ' + reminderText.replace(/[<>&"']/g, '') + '. It has been 10 hours and you still haven\'t done it. No more excuses. Handle it now.</Say></Response>',
                    });
                  } catch (callErr) { console.log("Reminder call error: " + callErr.message); }
                }
              }, 60000);
            } catch (e) { console.log("Reminder escalation error: " + e.message); }
          }
        }
      }, tenHours);

      return;
    }

    // ====== MARK REMINDER DONE ======
    if (lowerMsg.startsWith('done:') || lowerMsg.startsWith('done ') || lowerMsg.startsWith('finished:') || lowerMsg.startsWith('finished ')) {
      var doneText = userMessage.substring(userMessage.indexOf(':') > -1 && userMessage.indexOf(':') < 9 ? userMessage.indexOf(':') + 1 : userMessage.indexOf(' ') + 1).trim().toLowerCase();
      var cleared = 0;
      var reminderKeys = Object.keys(activeReminders);
      for (var rk = 0; rk < reminderKeys.length; rk++) {
        if (!activeReminders[reminderKeys[rk]].done && activeReminders[reminderKeys[rk]].text.toLowerCase().includes(doneText)) {
          activeReminders[reminderKeys[rk]].done = true;
          cleared++;
        }
      }
      if (cleared > 0) {
        twiml.message("Cleared. " + cleared + " reminder(s) marked done. That's execution.");
        // Log as a win and update reminder status
        setTimeout(async function() {
          try {
            var today = new Date().toISOString().split('T')[0];
            var now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            await sheets.spreadsheets.values.append({
              spreadsheetId: SPREADSHEET_ID,
              range: "'Wins'!A:D",
              valueInputOption: 'USER_ENTERED',
              requestBody: { values: [[today, 'Completed reminder: ' + doneText, 'Personal Growth', 'Auto-logged from reminder']] },
            });
            // Find and update the reminder row
            var reminderRows = await sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: "'Reminders'!A:F",
            });
            var rRows = reminderRows.data.values || [];
            for (var ri = rRows.length - 1; ri >= 1; ri--) {
              if (rRows[ri][2] && rRows[ri][2].toLowerCase().includes(doneText) && rRows[ri][3] === 'PENDING') {
                var hoursToComplete = Math.round((Date.now() - new Date(rRows[ri][0] + ' ' + rRows[ri][1]).getTime()) / 3600000);
                await sheets.spreadsheets.values.update({
                  spreadsheetId: SPREADSHEET_ID,
                  range: "'Reminders'!D" + (ri + 1) + ":F" + (ri + 1),
                  valueInputOption: 'USER_ENTERED',
                  requestBody: { values: [['DONE', now, hoursToComplete > 0 ? hoursToComplete : 0]] },
                });
                break;
              }
            }
          } catch (e) { console.log("Reminder complete error: " + e.message); }
        }, 100);
      } else {
        twiml.message("No active reminders matching that. Text \"reminders\" to see what's pending.");
      }
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    // ====== LIST ACTIVE REMINDERS ======
    if (lowerMsg === 'reminders' || lowerMsg === 'reminder' || lowerMsg === 'what do i need to do') {
      var reminderKeys2 = Object.keys(activeReminders);
      var pending = [];
      for (var rk2 = 0; rk2 < reminderKeys2.length; rk2++) {
        if (!activeReminders[reminderKeys2[rk2]].done) {
          var r = activeReminders[reminderKeys2[rk2]];
          var hoursAgo = Math.round((Date.now() - r.created) / 3600000);
          pending.push((pending.length + 1) + ". " + r.text + " (" + hoursAgo + "h ago)");
        }
      }
      if (pending.length > 0) {
        twiml.message("Pending reminders:\n\n" + pending.join("\n") + "\n\nText \"done: [task]\" to clear.");
      } else {
        twiml.message("No pending reminders. You're clear.");
      }
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    // ====== LOG A WIN ======
    if (lowerMsg.startsWith('win:') || lowerMsg.startsWith('win ')) {
      var winText = userMessage.substring(userMessage.indexOf(':') > -1 && userMessage.indexOf(':') < 5 ? userMessage.indexOf(':') + 1 : 4).trim();
      twiml.message("Win logged. Keep stacking.");
      res.type('text/xml');
      res.send(twiml.toString());
      setTimeout(async function() {
        try {
          var today = new Date().toISOString().split('T')[0];
          var area = await askClaude(
            "Categorize this win into exactly one of: Work, Health, Social, Financial, Personal Growth, Dating. Respond with ONLY the category name, nothing else.",
            [{ role: 'user', content: winText }]
          );
          await sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: "'Wins'!A:D",
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: [[today, winText, area.trim(), 'Logged via Jarvis']] },
          });
        } catch (e) { console.log("Win log error: " + e.message); }
      }, 100);
      return;
    }

    // ====== GYM LOG ======
    if (lowerMsg === 'gym' || lowerMsg === 'gym log' || lowerMsg === 'worked out' || lowerMsg === 'hit the gym' || lowerMsg.startsWith('gym:')) {
      // Quick log: "gym: chest and triceps" or start guided flow
      var quickGym = '';
      if (lowerMsg.includes(':')) {
        quickGym = userMessage.substring(userMessage.indexOf(':') + 1).trim();
      }

      if (quickGym) {
        twiml.message("Gym logged. Discipline is everything.");
        res.type('text/xml');
        res.send(twiml.toString());
        setTimeout(async function() {
          try {
            var today = new Date().toISOString().split('T')[0];
            var day = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            await sheets.spreadsheets.values.append({
              spreadsheetId: SPREADSHEET_ID,
              range: "'Gym_Log'!A:E",
              valueInputOption: 'USER_ENTERED',
              requestBody: { values: [[today, day, quickGym, '', 'Logged via Jarvis']] },
            });
            // Also log as a win
            await sheets.spreadsheets.values.append({
              spreadsheetId: SPREADSHEET_ID,
              range: "'Wins'!A:D",
              valueInputOption: 'USER_ENTERED',
              requestBody: { values: [[today, 'Hit the gym: ' + quickGym, 'Health', 'Auto-logged from gym']] },
            });
          } catch (e) { console.log("Gym log error: " + e.message); }
        }, 100);
        return;
      }

      // Guided flow
      whatsappHistory[from] = whatsappHistory[from] || {};
      whatsappHistory[from].gymLog = {
        step: 0,
        data: { date: new Date().toISOString().split('T')[0] },
        active: true,
      };
      twiml.message("Gym check-in. What did you train? (chest, back, legs, shoulders, arms, full body, cardio)");
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    var gymLog = whatsappHistory[from] ? whatsappHistory[from].gymLog : null;
    if (gymLog && gymLog.active) {
      var gSteps = [
        { key: 'muscles', next: 'How long was the session? (minutes)' },
        { key: 'duration', next: 'How was the energy? (1-10)' },
        { key: 'energy', next: null },
      ];

      var gStep = gSteps[gymLog.step];
      gymLog.data[gStep.key] = userMessage;
      gymLog.step++;

      if (gymLog.step >= gSteps.length) {
        gymLog.active = false;
        twiml.message("Logged. The gym never lies. Keep showing up.");
        res.type('text/xml');
        res.send(twiml.toString());

        var gd = gymLog.data;
        setTimeout(async function() {
          try {
            var day = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            await sheets.spreadsheets.values.append({
              spreadsheetId: SPREADSHEET_ID,
              range: "'Gym_Log'!A:E",
              valueInputOption: 'USER_ENTERED',
              requestBody: { values: [[gd.date, day, gd.muscles, gd.duration + ' min', 'Energy: ' + gd.energy + '/10']] },
            });
            await sheets.spreadsheets.values.append({
              spreadsheetId: SPREADSHEET_ID,
              range: "'Wins'!A:D",
              valueInputOption: 'USER_ENTERED',
              requestBody: { values: [[gd.date, 'Gym: ' + gd.muscles + ' (' + gd.duration + ' min)', 'Health', 'Auto-logged from gym']] },
            });
          } catch (e) { console.log("Gym log error: " + e.message); }
        }, 100);
        return;
      } else {
        twiml.message(gSteps[gymLog.step].next);
      }

      whatsappHistory[from].gymLog = gymLog;
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    // ====== WATER LOG ======
    if (lowerMsg.startsWith('water:') || lowerMsg.startsWith('water ') || lowerMsg.startsWith('drank ')) {
      var waterAmt = userMessage.replace(/^(water[:\s]*|drank\s*)/i, '').trim();
      twiml.message("Logged " + waterAmt + " water. Stay hydrated.");
      res.type('text/xml');
      res.send(twiml.toString());
      setTimeout(async function() {
        try {
          await sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: "'Health_Log'!A:E",
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: [[new Date().toISOString().split('T')[0], new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), 'Water', waterAmt, '']] },
          });
        } catch (e) { console.log("Water log error: " + e.message); }
      }, 100);
      return;
    }

    // ====== HABIT / ADDICTION TRACKING ======
    if (lowerMsg === 'log' || lowerMsg === 'track' || lowerMsg === 'habit' || lowerMsg === 'habits') {
      whatsappHistory[from] = whatsappHistory[from] || {};
      whatsappHistory[from].habitLog = {
        step: 0,
        data: { date: new Date().toISOString().split('T')[0] },
        active: true,
      };
      twiml.message("Habit check-in. Be honest â€” this is between you and the data.\n\nAlcohol today? (none, 1-2 drinks, 3-5, 6+)");
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    var habitLog = whatsappHistory[from] ? whatsappHistory[from].habitLog : null;
    if (habitLog && habitLog.active) {
      var hSteps = [
        { key: 'alcohol', next: 'Nicotine today? (none, 1-3, 4-10, 10+)' },
        { key: 'nicotine', next: 'PMO today? (clean, relapsed)' },
        { key: 'pmo', next: 'Any urges you fought off today? (yes/no)' },
        { key: 'urges', next: 'Water intake today? (oz or glasses)' },
        { key: 'water', next: null },
      ];

      var hStep = hSteps[habitLog.step];
      habitLog.data[hStep.key] = userMessage;
      habitLog.step++;

      if (habitLog.step >= hSteps.length) {
        habitLog.active = false;
        var hd = habitLog.data;
        var isClean = (hd.alcohol.toLowerCase().includes('none') && hd.nicotine.toLowerCase().includes('none') && hd.pmo.toLowerCase().includes('clean'));
        twiml.message(isClean ? "Clean day. That's strength. Keep building that streak." : "Logged. Awareness is step one. Tomorrow is another chance to be better.");
        res.type('text/xml');
        res.send(twiml.toString());

        setTimeout(async function() {
          try {
            await sheets.spreadsheets.values.append({
              spreadsheetId: SPREADSHEET_ID,
              range: "'Health_Log'!A:E",
              valueInputOption: 'USER_ENTERED',
              requestBody: { values: [
                [hd.date, '', 'Alcohol', hd.alcohol, ''],
                [hd.date, '', 'Nicotine', hd.nicotine, ''],
                [hd.date, '', 'PMO', hd.pmo, ''],
                [hd.date, '', 'Urges Fought', hd.urges, ''],
                [hd.date, '', 'Water', hd.water, ''],
              ] },
            });
          } catch (e) { console.log("Habit log error: " + e.message); }
        }, 100);
        return;
      } else {
        twiml.message(hSteps[habitLog.step].next);
      }

      whatsappHistory[from].habitLog = habitLog;
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    // Quick habit shortcuts
    if (lowerMsg === 'relapsed' || lowerMsg === 'relapse') {
      twiml.message("Logged. No shame â€” awareness matters. What triggered it?");
      res.type('text/xml');
      res.send(twiml.toString());
      setTimeout(async function() {
        try {
          await sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: "'Health_Log'!A:E",
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: [[new Date().toISOString().split('T')[0], new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), 'PMO', 'Relapsed', '']] },
          });
        } catch (e) {}
      }, 100);
      return;
    }

    if (lowerMsg === 'clean' || lowerMsg === 'clean day') {
      twiml.message("Clean day logged. That's discipline. Keep going.");
      res.type('text/xml');
      res.send(twiml.toString());
      setTimeout(async function() {
        try {
          await sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: "'Health_Log'!A:E",
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: [
              [new Date().toISOString().split('T')[0], new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), 'PMO', 'Clean', ''],
              [new Date().toISOString().split('T')[0], '', 'Nicotine', 'None', ''],
              [new Date().toISOString().split('T')[0], '', 'Alcohol', 'None', ''],
            ] },
          });
        } catch (e) {}
      }, 100);
      return;
    }

    // ====== DAILY CHECK-IN ======
    var dailyCheckin = whatsappHistory[from] ? whatsappHistory[from].dailyCheckin : null;

    if (lowerMsg === 'check in' || lowerMsg === 'checkin' || lowerMsg === 'check-in' || lowerMsg === 'log day') {
      whatsappHistory[from] = whatsappHistory[from] || {};
      whatsappHistory[from].dailyCheckin = {
        step: 0,
        data: { date: new Date().toISOString().split('T')[0] },
        active: true,
      };
      twiml.message("Daily check-in. Quick answers.\n\nHow many hours did you sleep last night?");
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    if (dailyCheckin && dailyCheckin.active) {
      var steps = [
        { key: 'sleep', next: 'How many ounces of water today?' },
        { key: 'water', next: 'Workout minutes today?' },
        { key: 'workout', next: 'Reading minutes today?' },
        { key: 'reading', next: 'Screen time hours today? (estimate)' },
        { key: 'screenTime', next: 'Social time minutes today?' },
        { key: 'social', next: 'Mood 1-10?' },
        { key: 'mood', next: 'Focus 1-10?' },
        { key: 'focus', next: 'Any notes on today? (or type "none")' },
        { key: 'notes', next: null },
      ];

      var step = steps[dailyCheckin.step];
      dailyCheckin.data[step.key] = userMessage;
      dailyCheckin.step++;

      if (dailyCheckin.step >= steps.length) {
        dailyCheckin.active = false;
        twiml.message("Day logged. Keep building.");
        res.type('text/xml');
        res.send(twiml.toString());

        var d = dailyCheckin.data;
        setTimeout(async function() {
          try {
            await sheets.spreadsheets.values.append({
              spreadsheetId: SPREADSHEET_ID,
              range: "'Daily_Log'!A:J",
              valueInputOption: 'USER_ENTERED',
              requestBody: { values: [[d.date, d.sleep, d.water, d.workout, d.reading, d.screenTime, d.social, d.mood, d.focus, d.notes === 'none' ? '' : d.notes]] },
            });
          } catch (e) { console.log("Daily log error: " + e.message); }
        }, 100);
      } else {
        twiml.message(steps[dailyCheckin.step].next || 'Done.');
      }

      whatsappHistory[from].dailyCheckin = dailyCheckin;
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    // ====== DATING LOG ======
    var datingLog = whatsappHistory[from] ? whatsappHistory[from].datingLog : null;

    if (lowerMsg === 'date log' || lowerMsg === 'dating' || lowerMsg === 'log date') {
      whatsappHistory[from] = whatsappHistory[from] || {};
      whatsappHistory[from].datingLog = {
        step: 0,
        data: { date: new Date().toISOString().split('T')[0] },
        active: true,
      };
      twiml.message("Dating log. Be real.\n\nWho was it with? (first name or description)");
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    if (datingLog && datingLog.active) {
      var dSteps = [
        { key: 'who', next: 'What type? (first date, second date, talking stage, hookup, situationship check-in, other)' },
        { key: 'type', next: 'How did you feel during it? Be honest.' },
        { key: 'feeling', next: 'Did you notice any old patterns showing up? (validation seeking, fear of intimacy, comparing to ex, emotional detachment, or none)' },
        { key: 'patterns', next: 'What went well?' },
        { key: 'wellDone', next: 'What would you do differently?' },
        { key: 'differently', next: null },
      ];

      var dStep = dSteps[datingLog.step];
      datingLog.data[dStep.key] = userMessage;
      datingLog.step++;

      if (datingLog.step >= dSteps.length) {
        datingLog.active = false;
        twiml.message("Logged. I'll analyze this with your patterns.");
        res.type('text/xml');
        res.send(twiml.toString());

        var dd = datingLog.data;
        setTimeout(async function() {
          try {
            // AI analysis of the date
            var analysis = await askClaude(
              "You are Jarvis, Trace's dating counselor. He just logged a date. Based on his known patterns (seeking validation, fear of intimacy, comparing partners to ex, emotional detachment after breakups), give a 2-sentence honest assessment. Was this growth or repetition? No markdown.",
              [{ role: 'user', content: 'Date with: ' + dd.who + '\nType: ' + dd.type + '\nFeeling: ' + dd.feeling + '\nPatterns noticed: ' + dd.patterns + '\nWent well: ' + dd.wellDone + '\nDo differently: ' + dd.differently }]
            );

            await sheets.spreadsheets.values.append({
              spreadsheetId: SPREADSHEET_ID,
              range: "'Dating_Log'!A:H",
              valueInputOption: 'USER_ENTERED',
              requestBody: { values: [[dd.date, dd.who, dd.type, dd.feeling, dd.patterns, dd.wellDone, dd.differently, analysis]] },
            });

            await twilioClient.messages.create({
              body: "Dating insight: " + analysis,
              from: 'whatsapp:+14155238886',
              to: from,
            });
          } catch (e) { console.log("Dating log error: " + e.message); }
        }, 100);
        return;
      } else {
        twiml.message(dSteps[datingLog.step].next || 'Done.');
      }

      whatsappHistory[from].datingLog = datingLog;
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    if (lowerMsg === 'briefing' || lowerMsg === 'brief' || lowerMsg === 'status') {
      var context = await buildLifeOSContext();
      var briefing = await askClaude(
        "You are Jarvis, Trace's personal AI counselor on WhatsApp. Talk like a wise mentor, not a database. Never mention tab names, sheet names, or entry counts. Use the data to give real advice. No markdown.\n\nLIFE OS DATA:\n" + context,
        [{ role: 'user', content: 'Give me a quick Life OS briefing.' }]
      );
      twiml.message(briefing);
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    if (lowerMsg === 'call' || lowerMsg === 'call me') {
      try {
        var baseUrl = process.env.BASE_URL || 'https://lifeos-jarvis.onrender.com';
        await twilioClient.calls.create({
          to: MY_NUMBER,
          from: TWILIO_NUMBER,
          url: baseUrl + '/voice',
        });
        twiml.message("Calling you now, Trace.");
      } catch (callErr) {
        twiml.message("Call failed: " + callErr.message);
      }
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    // Email commands
    if (lowerMsg === 'email' || lowerMsg === 'emails' || lowerMsg === 'inbox' || lowerMsg === 'mail') {
      var emailContext = await buildEmailContext();
      if (!emailContext) {
        twiml.message("No Gmail accounts connected. Visit https://lifeos-jarvis.onrender.com/gmail/auth to connect.");
      } else {
        // Store emails for later actions
        var accounts = Object.keys(gmailTokens);
        var cachedEmails = [];
        for (var ea = 0; ea < accounts.length; ea++) {
          var fetched = await getUnreadEmails(accounts[ea], 10);
          fetched.forEach(function(e) { e.account = accounts[ea]; });
          cachedEmails = cachedEmails.concat(fetched);
        }
        whatsappHistory[from] = whatsappHistory[from] || {};
        whatsappHistory[from].cachedEmails = cachedEmails;

        var emailSummary = await askClaude(
          "You are Jarvis on WhatsApp. Be very concise. No markdown. Number each email.",
          [{ role: 'user', content: 'Prioritize these emails. Tell me which to respond to first:\n' + emailContext }]
        );
        twiml.message(emailSummary);
      }
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    // Email actions: delete, archive, reply
    if (lowerMsg.includes('delete') && (lowerMsg.includes('email') || lowerMsg.includes('mail'))) {
      var cached = (whatsappHistory[from] || {}).cachedEmails || [];
      if (cached.length === 0) {
        twiml.message("No emails loaded. Text 'email' first to scan your inbox.");
      } else {
        var searchTerm = lowerMsg.replace('delete', '').replace('all', '').replace('emails', '').replace('email', '').replace('from', '').replace('the', '').trim();
        var deleted = 0;
        for (var d = 0; d < cached.length; d++) {
          if (cached[d].from.toLowerCase().includes(searchTerm) || cached[d].subject.toLowerCase().includes(searchTerm)) {
            await deleteEmail(cached[d].account, cached[d].id);
            deleted++;
          }
        }
        if (deleted > 0) {
          twiml.message("Done. Deleted " + deleted + " email(s) matching '" + searchTerm + "'.");
        } else {
          twiml.message("No emails found matching '" + searchTerm + "'. Text 'email' to see your inbox.");
        }
      }
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    if (lowerMsg.includes('archive') && (lowerMsg.includes('email') || lowerMsg.includes('mail'))) {
      var cached2 = (whatsappHistory[from] || {}).cachedEmails || [];
      if (cached2.length === 0) {
        twiml.message("No emails loaded. Text 'email' first.");
      } else {
        var searchTerm2 = lowerMsg.replace('archive', '').replace('all', '').replace('emails', '').replace('email', '').replace('from', '').replace('the', '').trim();
        var archived = 0;
        for (var ar = 0; ar < cached2.length; ar++) {
          if (cached2[ar].from.toLowerCase().includes(searchTerm2) || cached2[ar].subject.toLowerCase().includes(searchTerm2)) {
            await archiveEmail(cached2[ar].account, cached2[ar].id);
            archived++;
          }
        }
        twiml.message(archived > 0 ? "Archived " + archived + " email(s) matching '" + searchTerm2 + "'." : "No emails found matching '" + searchTerm2 + "'.");
      }
      res.type('text/xml');
      return res.send(twiml.toString());
    }

    // Smart AI inbox cleanup
    if (lowerMsg === 'clean inbox' || lowerMsg === 'clean email' || lowerMsg === 'clean emails' || lowerMsg === 'filter inbox' || lowerMsg === 'filter emails') {
      var accounts = Object.keys(gmailTokens);
      if (accounts.length === 0) {
        twiml.message("No Gmail accounts connected. Visit https://lifeos-jarvis.onrender.com/gmail/auth");
        res.type('text/xml');
        return res.send(twiml.toString());
      }

      twiml.message("Scanning and cleaning your inbox now. This may take a minute...");
      res.type('text/xml');
      res.send(twiml.toString());

      // Process in background after responding
      setTimeout(async function() {
        try {
          var totalDeleted = 0;
          var totalArchived = 0;
          var kept = [];

          for (var ca = 0; ca < accounts.length; ca++) {
            var emails = await getUnreadEmails(accounts[ca], 25);
            if (emails.length === 0) continue;

            // Build email list for Claude to categorize
            var emailList = emails.map(function(e, idx) {
              return (idx + 1) + '. From: ' + e.from + ' | Subject: ' + e.subject + ' | Preview: ' + e.snippet.substring(0, 80);
            }).join('\n');

            var categorization = await askClaude(
              "You categorize emails. For each email, respond with ONLY the number and category. Categories: DELETE (junk, spam, newsletters, promotions, marketing), ARCHIVE (low priority, FYI only, no action needed), KEEP (important, needs response, money, business, personal). Format: 1:DELETE 2:KEEP 3:ARCHIVE etc. One per line. Nothing else.",
              [{ role: 'user', content: 'Categorize these emails:\n' + emailList }]
            );

            // Parse Claude's response
            var lines = categorization.split('\n');
            for (var cl = 0; cl < lines.length; cl++) {
              var match = lines[cl].match(/(\d+)\s*:\s*(DELETE|ARCHIVE|KEEP)/i);
              if (match) {
                var emailIdx = parseInt(match[1]) - 1;
                var action = match[2].toUpperCase();
                if (emailIdx >= 0 && emailIdx < emails.length) {
                  if (action === 'DELETE') {
                    await deleteEmail(accounts[ca], emails[emailIdx].id);
                    totalDeleted++;
                  } else if (action === 'ARCHIVE') {
                    await archiveEmail(accounts[ca], emails[emailIdx].id);
                    totalArchived++;
                  } else {
                    kept.push(emails[emailIdx].from.split('<')[0].trim() + ': ' + emails[emailIdx].subject);
                  }
                }
              }
            }
          }

          // Send results via WhatsApp
          var resultMsg = "Inbox cleaned!\n\n";
          resultMsg += "Deleted: " + totalDeleted + " junk emails\n";
          resultMsg += "Archived: " + totalArchived + " low-priority emails\n";
          resultMsg += "Kept: " + kept.length + " important emails\n";
          if (kept.length > 0) {
            resultMsg += "\nStill in your inbox:\n";
            for (var k = 0; k < Math.min(kept.length, 10); k++) {
              resultMsg += (k + 1) + ". " + kept[k] + "\n";
            }
          }

          // Send via Twilio
          await twilioClient.messages.create({
            body: resultMsg,
            from: 'whatsapp:+14155238886',
            to: from,
          });
        } catch (cleanErr) {
          console.error("Inbox clean error: " + cleanErr.message);
          try {
            await twilioClient.messages.create({
              body: "Error cleaning inbox: " + cleanErr.message,
              from: 'whatsapp:+14155238886',
              to: from,
            });
          } catch (e) {}
        }
      }, 100);
      return;
    }

    // ====== DAILY 10 QUESTIONS SYSTEM ======
    var dailyQ = whatsappHistory[from] ? whatsappHistory[from].dailyQuestions : null;

    // Start daily questions
    if (lowerMsg === 'questions' || lowerMsg === 'daily' || lowerMsg === '10' || lowerMsg === 'challenge me' || lowerMsg === 'challenge') {
      twiml.message("Generating your 10 questions. First one coming in a moment...");
      res.type('text/xml');
      res.send(twiml.toString());

      // Generate and send async
      setTimeout(async function() {
        try {
          var qContext = await buildLifeOSContext();
          var questionsRaw = await askClaude(
            "You generate 10 deep, personal challenge questions for Trace. These questions should challenge his beliefs, make him uncomfortable, and force growth.\n\nCover ALL these areas across the 10 questions: dating and relationships, money mindset, self-worth, business ambition, daily habits, health, purpose, fears, accountability, and personal identity.\n\nRULES:\n- Make each question personal based on his Life OS data\n- Questions should be uncomfortable but constructive\n- Never mention tab names, sheet names, or entry counts\n- Use what you know about his life to make questions HIT\n- Format: one question per line, numbered 1-10, nothing else\n- No fluff, no explanations, just the questions\n\nLIFE OS DATA:\n" + qContext,
            [{ role: 'user', content: 'Generate 10 deep personal challenge questions for today.' }]
          );

          var questions = questionsRaw.split('\n').filter(function(q) { return q.trim().match(/^\d/); });
          if (questions.length < 10) questions = questionsRaw.split('\n').filter(function(q) { return q.trim().length > 10; });

          whatsappHistory[from] = whatsappHistory[from] || {};
          whatsappHistory[from].dailyQuestions = {
            questions: questions,
            answers: [],
            currentIndex: 0,
            date: new Date().toISOString().split('T')[0],
            active: true,
          };

          await twilioClient.messages.create({
            body: "Let's go. 10 questions. Be honest with yourself.\n\n" + questions[0],
            from: 'whatsapp:+14155238886',
            to: from,
          });
        } catch (qErr) {
          console.error("Daily questions error: " + qErr.message);
          try {
            await twilioClient.messages.create({
              body: "Error generating questions: " + qErr.message,
              from: 'whatsapp:+14155238886',
              to: from,
            });
          } catch (e) {}
        }
      }, 100);
      return;
    }

    // If daily questions are active, capture answer and send next question
    if (dailyQ && dailyQ.active && dailyQ.currentIndex < dailyQ.questions.length) {
      // Log the answer
      dailyQ.answers.push({
        question: dailyQ.questions[dailyQ.currentIndex],
        answer: userMessage,
        time: new Date().toISOString(),
      });
      dailyQ.currentIndex++;

      var isLast = dailyQ.currentIndex >= dailyQ.questions.length;

      if (isLast) {
        twiml.message("Got it. Analyzing your answers now...");
      } else {
        var qNum = dailyQ.currentIndex + 1;
        twiml.message("Logged. Question " + qNum + " of 10:\n\n" + dailyQ.questions[dailyQ.currentIndex]);
      }

      res.type('text/xml');
      res.send(twiml.toString());

      // Process logging and analysis async
      var capturedDailyQ = dailyQ;
      var capturedFrom = from;
      setTimeout(async function() {
        try {
          var row = [
            capturedDailyQ.date,
            new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
            capturedDailyQ.answers[capturedDailyQ.answers.length - 1].question.replace(/^\d+[\.\)]\s*/, ''),
            capturedDailyQ.answers[capturedDailyQ.answers.length - 1].answer,
          ];

          if (isLast) {
            var answersText = capturedDailyQ.answers.map(function(a, i) {
              return (i + 1) + '. ' + a.question + '\nAnswer: ' + a.answer;
            }).join('\n\n');

            var analysisRaw = await askClaude(
              "You are Jarvis, Trace's AI counselor. He just answered 10 deep personal questions. Respond with EXACTLY three sections separated by |||. Section 1: Mindset analysis â€” patterns in his thinking, where he's strong, where he's lying to himself (3-4 sentences). Section 2: 2-3 specific personal beliefs holding him back and why they're wrong (3-4 sentences). Section 3: 3 concrete actions he should take TODAY based on his answers (3 sentences). No markdown. No bullet points. Separate sections ONLY with |||",
              [{ role: 'user', content: 'Here are my answers:\n\n' + answersText }]
            );

            var parts = analysisRaw.split('|||').map(function(p) { return p.trim(); });
            row.push(parts[0] || '', parts[1] || '', parts[2] || '');

            capturedDailyQ.active = false;
            capturedDailyQ.summary = (parts[0] || '') + '\n\n' + (parts[1] || '') + '\n\n' + (parts[2] || '');

            await twilioClient.messages.create({
              body: "That's all 10. Here's what I see:\n\n" + capturedDailyQ.summary,
              from: 'whatsapp:+14155238886',
              to: capturedFrom,
            });
          }

          await sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: "'Daily_Questions'!A:G",
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: [row] },
          });
        } catch (logErr) {
          console.log("Could not log question: " + logErr.message);
        }
      }, 100);

      whatsappHistory[from].dailyQuestions = dailyQ;
      return;
    }

    // Regular conversation with Claude
    if (!history.systemPrompt) {
      var context2 = await buildLifeOSContext();
      history.systemPrompt = "You are Jarvis, Trace's personal AI counselor and mentor on WhatsApp.\n\nRULES:\n- Talk like a wise friend and life coach. Be real.\n- NEVER mention tab names, sheet names, row counts, or entry counts.\n- NEVER recite statistics unless Trace specifically asks for numbers.\n- Use the data to UNDERSTAND Trace's situation, then give human advice.\n- Ask questions that make him think. Challenge him constructively.\n- Keep responses SHORT (2-4 sentences). This is WhatsApp.\n- No markdown, no bullet points, no formatting.\n\nLIFE OS DATA (use to inform advice, don't recite):\n" + context2;
      history.messages = [];
    }

    history.messages.push({ role: 'user', content: userMessage });

    // Fetch extra data based on keywords
    var extraContext = '';
    var dataKeywords = {
      'debt': 'Ultimate_Debt_Tracker_Advanced',
      'finance': 'Ultimate_Debt_Tracker_Advanced',
      'money': 'Ultimate_Debt_Tracker_Advanced',
      'screen time': 'Dashboard',
      'gratitude': 'Gratitude_Memory',
      'business': 'Business_Idea_Ledger',
      'idea': 'Business_Idea_Ledger',
      'identity': 'Trace_Identity_Profile',
      'focus': 'Focus_Log',
      'reading': 'Reading_Log',
      'win': 'Wins',
    };

    var keywords = Object.keys(dataKeywords);
    for (var i = 0; i < keywords.length; i++) {
      if (lowerMsg.includes(keywords[i])) {
        try {
          var fetchRes = await sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: "'" + dataKeywords[keywords[i]] + "'!A1:N20",
          });
          var fetchRows = fetchRes.data.values || [];
          if (fetchRows.length > 0) {
            var fetchHeaders = fetchRows[0].join(', ');
            var fetchData = fetchRows.slice(1, 15).map(function(r) { return r.join(' | '); }).join('\n');
            extraContext = "\n\n[FRESH DATA FROM " + dataKeywords[keywords[i]] + "]\nHeaders: " + fetchHeaders + "\n" + fetchData;
          }
        } catch (e) {}
        break;
      }
    }

    if (extraContext) {
      history.messages[history.messages.length - 1].content += extraContext;
    }

    var response = await askClaude(history.systemPrompt, history.messages);
    console.log("Jarvis WhatsApp: " + response);

    // Keep only last 10 messages to avoid token limits
    history.messages.push({ role: 'assistant', content: response });
    if (history.messages.length > 20) {
      history.messages = history.messages.slice(-10);
    }
    whatsappHistory[from] = history;

    twiml.message(response);
  } catch (err) {
    console.error("WhatsApp Error: " + err.message);
    twiml.message("Error: " + err.message);
  }

  res.type('text/xml');
  res.send(twiml.toString());
});

/* ===========================
   GET /briefing
=========================== */

app.get('/briefing', async function(req, res) {
  try {
    console.log("Building briefing...");
    var context = await buildLifeOSContext();
    var emailContext = await buildEmailContext();
    var fullContext = context + emailContext;
    var response = await askClaude(
      "You are Jarvis, Trace's personal AI counselor. Give a morning check-in like a wise mentor would. Talk about what matters today, what needs attention, and ask a question that makes Trace think. NEVER mention tab names, sheet names, or entry counts. Use the data to inform advice, don't recite it. If there are urgent emails, mention who they're from. No markdown.\n\nLIFE OS DATA (inform your advice, don't recite):\n" + fullContext,
      [{ role: 'user', content: 'Give me my full Life OS briefing including email priorities.' }]
    );
    res.json({ briefing: response });
  } catch (err) {
    console.error("Briefing Error: " + err.message);
    res.status(500).json({ error: err.message });
  }
});

/* ===========================
   ALL OTHER ENDPOINTS
=========================== */

app.get('/tabs', async function(req, res) {
  try {
    var tabs = await getAllTabNames();
    res.json({ tabCount: tabs.length, tabs: tabs });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.get('/tab/:name', async function(req, res) {
  try {
    res.json(await getTabData(req.params.name));
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.get('/scan', async function(req, res) {
  try {
    var tabs = await getAllTabNames();
    var results = [];
    for (var i = 0; i < tabs.length; i++) {
      var data = await getTabData(tabs[i]);
      results.push({ tab: data.tab, headers: data.headers, rowCount: data.rowCount, error: data.error || null });
    }
    var totalRows = results.reduce(function(sum, t) { return sum + t.rowCount; }, 0);
    res.json({ totalTabs: tabs.length, totalRows: totalRows, tabs: results });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.get('/scan/full', async function(req, res) {
  try {
    var tabs = await getAllTabNames();
    var results = [];
    for (var i = 0; i < tabs.length; i++) {
      results.push(await getTabData(tabs[i]));
    }
    var totalRows = results.reduce(function(sum, t) { return sum + t.rowCount; }, 0);
    res.json({ totalTabs: tabs.length, totalRows: totalRows, tabs: results });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.get('/search', async function(req, res) {
  try {
    var query = (req.query.q || '').toLowerCase().trim();
    if (!query) return res.status(400).json({ error: "Provide ?q=search_term" });
    var tabs = await getAllTabNames();
    var matches = [];
    for (var t = 0; t < tabs.length; t++) {
      var data = await getTabData(tabs[t]);
      if (data.error) continue;
      for (var r = 0; r < data.rows.length; r++) {
        if (data.rows[r].join(' ').toLowerCase().includes(query)) {
          var obj = {};
          for (var h = 0; h < data.headers.length; h++) {
            obj[data.headers[h]] = data.rows[r][h] || '';
          }
          matches.push({ tab: tabs[t], row: r + 2, data: obj });
        }
      }
    }
    res.json({ query: query, matchCount: matches.length, matches: matches });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.get('/summary', async function(req, res) {
  try {
    var tabs = await getAllTabNames();
    var summary = { totalTabs: tabs.length, categories: {} };
    for (var i = 0; i < tabs.length; i++) {
      var count = await getTabRowCount(tabs[i]);
      var cat = 'other';
      var l = tabs[i].toLowerCase();
      if (l.includes('debt') || l.includes('finance') || l.includes('loan')) cat = 'finance';
      else if (l.includes('chat') || l.includes('message')) cat = 'conversations';
      else if (l.includes('business') || l.includes('idea')) cat = 'business';
      else if (l.includes('screen') || l.includes('usage') || l.includes('rescue') || l.includes('focus')) cat = 'productivity';
      else if (l.includes('identity') || l.includes('execution') || l.includes('profile')) cat = 'identity';
      else if (l.includes('gratitude') || l.includes('win') || l.includes('worth')) cat = 'growth';
      else if (l.includes('log') || l.includes('daily')) cat = 'logs';
      else if (l.includes('test') || l.includes('eval')) cat = 'testing';
      else if (l.includes('taxonomy') || l.includes('setting')) cat = 'system';
      if (!summary.categories[cat]) summary.categories[cat] = [];
      summary.categories[cat].push({ tab: tabs[i], rowCount: count });
    }
    res.json(summary);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.get('/priority', async function(req, res) {
  try {
    var taskTabs = ['Tasks', 'Daily_Log', 'Focus_Log', 'Jira_Log'];
    for (var i = 0; i < taskTabs.length; i++) {
      try {
        var r = await sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: "'" + taskTabs[i] + "'!A2:B10",
        });
        if (r.data.values && r.data.values.length > 0) {
          return res.json({ source: taskTabs[i], task: r.data.values[0][0], detail: r.data.values[0][1] || '' });
        }
      } catch (e) {}
    }
    res.json({ message: "No tasks found." });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

/* ===========================
   GMAIL â€” OAuth Sign-in Flow
=========================== */

// Step 1: Visit this to sign in a Gmail account
app.get('/gmail/auth', function(req, res) {
  if (!GMAIL_CLIENT_ID) return res.json({ error: "Gmail not configured" });
  var oauth2 = createGmailOAuth2Client();
  var url = oauth2.generateAuthUrl({
    access_type: 'offline',
    prompt: 'consent',
    scope: [
      'https://www.googleapis.com/auth/gmail.readonly',
      'https://www.googleapis.com/auth/gmail.send',
      'https://www.googleapis.com/auth/gmail.modify',
      'https://mail.google.com/',
      'https://www.googleapis.com/auth/calendar',
    ],
  });
  res.redirect(url);
});

// Step 2: Google redirects here after sign-in
app.get('/gmail/callback', async function(req, res) {
  if (!req.query.code) return res.json({ error: "No code received" });
  try {
    var oauth2 = createGmailOAuth2Client();
    var { tokens } = await oauth2.getToken(req.query.code);
    oauth2.setCredentials(tokens);

    // Get the email address
    var gmail = google.gmail({ version: 'v1', auth: oauth2 });
    var profile = await gmail.users.getProfile({ userId: 'me' });
    var email = profile.data.emailAddress;

    gmailTokens[email] = tokens;
    saveGmailTokens();

    console.log("Gmail: Connected " + email);
    res.json({ success: true, email: email, message: "Gmail connected! You can close this tab." });
  } catch (err) {
    console.error("Gmail callback error: " + err.message);
    res.status(500).json({ error: err.message });
  }
});

// List connected accounts
app.get('/gmail/accounts', function(req, res) {
  res.json({ accounts: Object.keys(gmailTokens) });
});

// Export tokens (for saving to env var)
app.get('/gmail/tokens', function(req, res) {
  if (req.query.key !== (process.env.CALL_SECRET || '')) return res.status(403).json({ error: 'Unauthorized' });
  res.json({ tokens: JSON.stringify(gmailTokens), accounts: Object.keys(gmailTokens) });
});

/* ===========================
   GMAIL â€” Helper Functions
=========================== */

async function getGmailClient(email) {
  var tokens = gmailTokens[email];
  if (!tokens) return null;
  var oauth2 = createGmailOAuth2Client(tokens);

  // Refresh if expired
  if (tokens.expiry_date && tokens.expiry_date < Date.now()) {
    try {
      var { credentials } = await oauth2.refreshAccessToken();
      gmailTokens[email] = credentials;
      saveGmailTokens();
      oauth2.setCredentials(credentials);
    } catch (e) {
      console.error("Gmail refresh failed for " + email + ": " + e.message);
      return null;
    }
  }
  return google.gmail({ version: 'v1', auth: oauth2 });
}

async function getUnreadEmails(email, maxResults) {
  var gmail = await getGmailClient(email);
  if (!gmail) return [];
  try {
    var list = await gmail.users.messages.list({
      userId: 'me',
      q: 'is:unread',
      maxResults: maxResults || 15,
    });
    var messages = list.data.messages || [];
    var emails = [];
    for (var i = 0; i < messages.length; i++) {
      var msg = await gmail.users.messages.get({
        userId: 'me',
        id: messages[i].id,
        format: 'metadata',
        metadataHeaders: ['From', 'Subject', 'Date'],
      });
      var headers = msg.data.payload.headers;
      var fromHeader = headers.find(function(h) { return h.name === 'From'; });
      var subjectHeader = headers.find(function(h) { return h.name === 'Subject'; });
      var dateHeader = headers.find(function(h) { return h.name === 'Date'; });
      emails.push({
        id: messages[i].id,
        from: fromHeader ? fromHeader.value : 'Unknown',
        subject: subjectHeader ? subjectHeader.value : '(no subject)',
        date: dateHeader ? dateHeader.value : '',
        snippet: msg.data.snippet || '',
      });
    }
    return emails;
  } catch (err) {
    console.error("Gmail read error for " + email + ": " + err.message);
    return [];
  }
}

async function getEmailBody(email, messageId) {
  var gmail = await getGmailClient(email);
  if (!gmail) return '';
  try {
    var msg = await gmail.users.messages.get({ userId: 'me', id: messageId, format: 'full' });
    var parts = msg.data.payload.parts || [msg.data.payload];
    for (var i = 0; i < parts.length; i++) {
      if (parts[i].mimeType === 'text/plain' && parts[i].body.data) {
        return Buffer.from(parts[i].body.data, 'base64').toString('utf8');
      }
    }
    if (msg.data.payload.body && msg.data.payload.body.data) {
      return Buffer.from(msg.data.payload.body.data, 'base64').toString('utf8');
    }
    return msg.data.snippet || '';
  } catch (err) {
    return '';
  }
}

async function sendReply(email, messageId, replyText) {
  var gmail = await getGmailClient(email);
  if (!gmail) return { error: 'Not connected' };
  try {
    var msg = await gmail.users.messages.get({ userId: 'me', id: messageId, format: 'metadata', metadataHeaders: ['From', 'Subject', 'Message-ID'] });
    var headers = msg.data.payload.headers;
    var toHeader = headers.find(function(h) { return h.name === 'From'; });
    var subjectHeader = headers.find(function(h) { return h.name === 'Subject'; });
    var msgIdHeader = headers.find(function(h) { return h.name === 'Message-ID'; });
    var to = toHeader ? toHeader.value : '';
    var subject = subjectHeader ? subjectHeader.value : '';
    if (!subject.startsWith('Re:')) subject = 'Re: ' + subject;

    var raw = [
      'To: ' + to,
      'Subject: ' + subject,
      'In-Reply-To: ' + (msgIdHeader ? msgIdHeader.value : ''),
      'References: ' + (msgIdHeader ? msgIdHeader.value : ''),
      'Content-Type: text/plain; charset=utf-8',
      '',
      replyText,
    ].join('\r\n');

    var encoded = Buffer.from(raw).toString('base64').replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    await gmail.users.messages.send({ userId: 'me', requestBody: { raw: encoded, threadId: msg.data.threadId } });
    return { success: true, to: to };
  } catch (err) {
    return { error: err.message };
  }
}

async function deleteEmail(email, messageId) {
  var gmail = await getGmailClient(email);
  if (!gmail) return { error: 'Not connected' };
  try {
    await gmail.users.messages.trash({ userId: 'me', id: messageId });
    return { success: true };
  } catch (err) {
    return { error: err.message };
  }
}

async function archiveEmail(email, messageId) {
  var gmail = await getGmailClient(email);
  if (!gmail) return { error: 'Not connected' };
  try {
    await gmail.users.messages.modify({ userId: 'me', id: messageId, requestBody: { removeLabelIds: ['INBOX'] } });
    return { success: true };
  } catch (err) {
    return { error: err.message };
  }
}

/* ===========================
   GOOGLE CALENDAR â€” Helper Functions
=========================== */

async function getCalendarEvents(email, daysAhead) {
  var tokens = gmailTokens[email];
  if (!tokens) return [];
  var oauth2 = createGmailOAuth2Client(tokens);

  if (tokens.expiry_date && tokens.expiry_date < Date.now()) {
    try {
      var { credentials } = await oauth2.refreshAccessToken();
      gmailTokens[email] = credentials;
      saveGmailTokens();
      oauth2.setCredentials(credentials);
    } catch (e) { return []; }
  }

  try {
    var calendar = google.calendar({ version: 'v3', auth: oauth2 });
    var now = new Date();
    var future = new Date();
    future.setDate(future.getDate() + (daysAhead || 1));

    var res = await calendar.events.list({
      calendarId: 'primary',
      timeMin: now.toISOString(),
      timeMax: future.toISOString(),
      singleEvents: true,
      orderBy: 'startTime',
      maxResults: 15,
    });

    var events = res.data.items || [];
    return events.map(function(e) {
      var start = e.start.dateTime || e.start.date;
      var startDate = new Date(start);
      var timeStr = e.start.dateTime
        ? startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
        : 'All day';
      var dayStr = startDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      return {
        summary: e.summary || '(no title)',
        time: timeStr,
        date: dayStr,
        location: e.location || '',
        description: (e.description || '').substring(0, 100),
      };
    });
  } catch (err) {
    console.log("Calendar error for " + email + ": " + err.message);
    return [];
  }
}

async function buildCalendarContext(daysAhead) {
  var accounts = Object.keys(gmailTokens);
  if (accounts.length === 0) return '';

  var context = '\nUPCOMING CALENDAR:\n';
  var hasEvents = false;

  for (var a = 0; a < accounts.length; a++) {
    var events = await getCalendarEvents(accounts[a], daysAhead || 1);
    if (events.length > 0) {
      hasEvents = true;
      for (var e = 0; e < events.length; e++) {
        context += '  ' + events[e].date + ' ' + events[e].time + ' â€” ' + events[e].summary;
        if (events[e].location) context += ' @ ' + events[e].location;
        context += '\n';
      }
    }
  }

  if (!hasEvents) context += '  No upcoming events\n';
  return context + '\n';
}

async function createCalendarEvent(email, summary, startTime, endTime, location) {
  var tokens = gmailTokens[email];
  if (!tokens) return { error: 'Not connected' };
  var oauth2 = createGmailOAuth2Client(tokens);

  if (tokens.expiry_date && tokens.expiry_date < Date.now()) {
    try {
      var { credentials } = await oauth2.refreshAccessToken();
      gmailTokens[email] = credentials;
      saveGmailTokens();
      oauth2.setCredentials(credentials);
    } catch (e) { return { error: 'Auth refresh failed' }; }
  }

  try {
    var calendar = google.calendar({ version: 'v3', auth: oauth2 });
    var event = {
      summary: summary,
      start: { dateTime: startTime, timeZone: 'America/Chicago' },
      end: { dateTime: endTime, timeZone: 'America/Chicago' },
    };
    if (location) event.location = location;

    var result = await calendar.events.insert({
      calendarId: 'primary',
      requestBody: event,
    });
    return { success: true, id: result.data.id, link: result.data.htmlLink };
  } catch (err) {
    return { error: err.message };
  }
}

/* ===========================
   CALENDAR â€” 10 min before call system
=========================== */

var calendarCheckInterval = null;
var notifiedEvents = {};

function startCalendarWatcher() {
  // Check every 2 minutes for upcoming events
  calendarCheckInterval = setInterval(async function() {
    try {
      var accounts = Object.keys(gmailTokens);
      for (var a = 0; a < accounts.length; a++) {
        var events = await getCalendarEvents(accounts[a], 1);
        for (var e = 0; e < events.length; e++) {
          var ev = events[e];
          // Parse the event time
          var tokens2 = gmailTokens[accounts[a]];
          if (!tokens2) continue;
          var oauth2 = createGmailOAuth2Client(tokens2);
          var calendar = google.calendar({ version: 'v3', auth: oauth2 });

          // Get raw event data for exact time
          var now = new Date();
          var future = new Date();
          future.setDate(future.getDate() + 1);
          var rawEvents = await calendar.events.list({
            calendarId: 'primary',
            timeMin: now.toISOString(),
            timeMax: future.toISOString(),
            singleEvents: true,
            orderBy: 'startTime',
            maxResults: 10,
          });

          var items = rawEvents.data.items || [];
          for (var i = 0; i < items.length; i++) {
            var item = items[i];
            if (!item.start.dateTime) continue; // skip all-day events
            var eventStart = new Date(item.start.dateTime);
            var minutesTillEvent = (eventStart.getTime() - now.getTime()) / 60000;
            var eventKey = item.id + '_' + eventStart.toISOString();

            // 10 minutes before â€” call
            if (minutesTillEvent > 8 && minutesTillEvent <= 12 && !notifiedEvents[eventKey]) {
              notifiedEvents[eventKey] = true;
              console.log("Calendar alert: " + item.summary + " in " + Math.round(minutesTillEvent) + " min");

              var eventName = (item.summary || 'an event').replace(/[<>&"']/g, '');
              var eventLoc = item.location ? ' at ' + item.location.replace(/[<>&"']/g, '') : '';

              // Text first
              try {
                await twilioClient.messages.create({
                  body: "Heads up â€” \"" + item.summary + "\" starts in 10 minutes" + (item.location ? " at " + item.location : "") + ".",
                  from: 'whatsapp:+14155238886',
                  to: '+18167392734',
                });
              } catch (e) {}

              // Then call
              try {
                await twilioClient.calls.create({
                  to: MY_NUMBER,
                  from: TWILIO_NUMBER,
                  twiml: '<Response><Say voice="Polly.Matthew">Trace. You have ' + eventName + eventLoc + ' starting in 10 minutes. Get ready.</Say></Response>',
                });
              } catch (e) { console.log("Calendar call error: " + e.message); }
            }
          }
          break; // only check first account for calendar
        }
      }
    } catch (err) {
      console.log("Calendar watcher error: " + err.message);
    }
  }, 120000); // every 2 minutes
}

// Clean up old notified events every hour
setInterval(function() {
  var keys = Object.keys(notifiedEvents);
  if (keys.length > 100) {
    notifiedEvents = {};
  }
}, 3600000);

/* ===========================
   GMAIL â€” Build Email Context for Briefings
=========================== */

async function buildEmailContext() {
  var accounts = Object.keys(gmailTokens);
  if (accounts.length === 0) return '';

  var context = '\nEMAIL INBOX SUMMARY:\n';
  var allEmails = [];

  for (var a = 0; a < accounts.length; a++) {
    var emails = await getUnreadEmails(accounts[a], 10);
    if (emails.length > 0) {
      context += '\n' + accounts[a] + ' (' + emails.length + ' unread):\n';
      for (var e = 0; e < emails.length; e++) {
        emails[e].account = accounts[a];
        emails[e].index = allEmails.length + 1;
        allEmails.push(emails[e]);
        context += '  ' + allEmails.length + '. From: ' + emails[e].from + '\n     Subject: ' + emails[e].subject + '\n     Preview: ' + emails[e].snippet.substring(0, 100) + '\n';
      }
    } else {
      context += '\n' + accounts[a] + ': inbox zero!\n';
    }
  }

  return context;
}

/* ===========================
   GMAIL â€” API Endpoints
=========================== */

// Get all unread emails across all accounts
app.get('/gmail/unread', async function(req, res) {
  var accounts = Object.keys(gmailTokens);
  var allEmails = [];
  for (var a = 0; a < accounts.length; a++) {
    var emails = await getUnreadEmails(accounts[a], 15);
    emails.forEach(function(e) { e.account = accounts[a]; });
    allEmails = allEmails.concat(emails);
  }
  res.json({ totalUnread: allEmails.length, accounts: accounts.length, emails: allEmails });
});

// Get AI-prioritized inbox summary
app.get('/gmail/summary', async function(req, res) {
  try {
    var emailContext = await buildEmailContext();
    if (!emailContext) return res.json({ error: "No Gmail accounts connected. Visit /gmail/auth to connect." });

    var summary = await askClaude(
      "You are Jarvis, Trace's email assistant. Analyze the emails and prioritize them. Be direct and concise. No markdown.",
      [{ role: 'user', content: 'Here are my unread emails. Rank them by urgency and tell me which to respond to first, which to archive, and which to delete:\n' + emailContext }]
    );
    res.json({ summary: summary });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Read full email body
app.get('/gmail/read/:account/:id', async function(req, res) {
  var body = await getEmailBody(req.params.account, req.params.id);
  res.json({ body: body });
});

// Reply to an email
app.post('/gmail/reply', async function(req, res) {
  var result = await sendReply(req.body.account, req.body.id, req.body.message);
  res.json(result);
});

// Delete an email
app.post('/gmail/delete', async function(req, res) {
  var result = await deleteEmail(req.body.account, req.body.id);
  res.json(result);
});

// Archive an email
app.post('/gmail/archive', async function(req, res) {
  var result = await archiveEmail(req.body.account, req.body.id);
  res.json(result);
});

/* ===========================
   GET /dashboard â€” Live Web Dashboard
=========================== */

app.get('/dashboard', requireAuth('owner'), async function(req, res) {
  try {
    var today = new Date();
    // Fetch key data â€” PERSONAL + BUSINESS in parallel
    var tabs = [];
    try { tabs = await getAllTabNames(); } catch(e) { tabs = []; }
    var contextPromise = buildLifeOSContext().catch(function(e) { return "Error loading context: " + e.message; });
    var bizPromise = buildBusinessContext().catch(function(e) { return "Error loading business: " + e.message; });

    var context = await contextPromise;
    var bizContext = await bizPromise;

    // Parse personal numbers from context
    var screenTimeMatch = context.match(/Daily average[:\s]*([\d.]+)/i);
    var debtMatch = context.match(/\~?\$([,\d]+)\s*total debt/i);

    var screenTime = screenTimeMatch ? screenTimeMatch[1] : '?';
    var debtAmount = debtMatch ? debtMatch[1].replace(/,/g, '') : '0';

    // Business metrics from global (populated by buildBusinessContext)
    var bm = global.bizMetrics || {};
    var totalBooked = bm.totalBooked || 0;
    var totalCompleted = bm.totalCompleted || 0;
    var totalCancelled = bm.totalCancelled || 0;
    var totalReturn = bm.totalReturn || 0;
    var promoReplies = bm.promoReplies || 0;
    var totalLocations = bm.locationStats ? Object.keys(bm.locationStats).length : 0;
    var bizTodayBookings = bm.todayBookings || [];
    var bizReschedule = bm.needsReschedule || [];
    var bizTechs = bm.techList || [];
    var bizRecentBookings = bm.recentBookings || [];
    var equipStats = bm.equipStats || {};
    var brandStats = bm.brandStats || {};
    var techPerf = bm.techStats || {};
    var locationStats = bm.locationStats || {};
    var avgBookingDays = bm.avgBookingDays || 0;
    var conversionRate = bm.conversionRate || 0;
    var thisMonthCalls = bm.thisMonthCalls || 0;
    var lastMonthCalls = bm.lastMonthCalls || 0;
    var monthGrowth = bm.monthGrowth || 0;
    var weeklyCalls = bm.weeklyCalls || 0;
    var totalLeads = bm.totalLeads || 0;
    var newLocsThisMonth = bm.newLocationsThisMonth || 0;
    var monthlyCalls = bm.monthlyCalls || {};
    var seasonalData = bm.seasonalData || {};

    // Sort location data
    var bizLocations = Object.entries(locationStats).sort(function(a,b){return b[1].total-a[1].total;});

    // Get email count
    var emailAccounts = Object.keys(gmailTokens || {});
    var totalUnread = 0;
    for (var ea = 0; ea < emailAccounts.length; ea++) {
      try {
        var emails = await getUnreadEmails(emailAccounts[ea], 50);
        totalUnread += (emails || []).length;
      } catch(e) {}
    }

    // Get today's calendar events
    var todayEvents = [];
    for (var ca = 0; ca < emailAccounts.length; ca++) {
      try {
        var events = await getCalendarEvents(emailAccounts[ca], 1);
        todayEvents = todayEvents.concat(events || []);
      } catch(e) {}
    }

    // Get recent wins
    var recentWins = [];
    try {
      var winsRes = await sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Wins'!A:D" });
      var winsRows = winsRes.data.values || [];
      recentWins = winsRows.slice(Math.max(1, winsRows.length - 5));
    } catch (e) {}

    // Get pending reminders
    var pendingReminders = [];
    global.activeReminders = global.activeReminders || {};
    var rKeys = Object.keys(global.activeReminders);
    for (var rk = 0; rk < rKeys.length; rk++) {
      if (!global.activeReminders[rKeys[rk]].done) {
        pendingReminders.push(global.activeReminders[rKeys[rk]]);
      }
    }

    // Get recent daily questions
    var recentQuestions = [];
    try {
      var qRes = await sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Daily_Questions'!A:G" });
      var qRows = qRes.data.values || [];
      recentQuestions = qRows.slice(Math.max(1, qRows.length - 3));
    } catch (e) {}

    // Get recent daily log
    var recentLog = null;
    try {
      var logRes = await sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Daily_Log'!A:J" });
      var logRows = logRes.data.values || [];
      if (logRows.length > 1) recentLog = { headers: logRows[0], data: logRows[logRows.length - 1] };
    } catch (e) {}

    // Get dating log count
    var datingCount = 0;
    try {
      var dRes = await sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Dating_Log'!A:A" });
      datingCount = Math.max(0, ((dRes.data.values || []).length) - 1);
    } catch (e) {}

    // Get gym log data
    var gymVisits = 0;
    var gymThisWeek = 0;
    var recentGym = [];
    try {
      var gymRes = await sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Gym_Log'!A:E" });
      var gymRows = gymRes.data.values || [];
      gymVisits = Math.max(0, gymRows.length - 1);
      recentGym = gymRows.slice(Math.max(1, gymRows.length - 5));
      var now = new Date();
      var weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay());
      weekStart.setHours(0, 0, 0, 0);
      for (var gi = 1; gi < gymRows.length; gi++) {
        if (gymRows[gi][0]) {
          var gymDate = new Date(gymRows[gi][0]);
          if (gymDate >= weekStart) gymThisWeek++;
        }
      }
    } catch (e) {}

    // Get health/habit data
    var healthData = { water: [], alcohol: [], nicotine: [], pmo: [], streaks: { pmo: 0, nicotine: 0, alcohol: 0 } };
    try {
      var healthRes = await sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "'Health_Log'!A:E" });
      var healthRows = healthRes.data.values || [];
      var lastRelapse = { pmo: null, nicotine: null, alcohol: null };
      for (var hi = healthRows.length - 1; hi >= 1; hi--) {
        var hRow = healthRows[hi];
        if (!hRow[2]) continue;
        var hType = hRow[2].toLowerCase();
        if (hType === 'water') healthData.water.push({ date: hRow[0], amount: hRow[3] });
        if (hType === 'alcohol') {
          healthData.alcohol.push({ date: hRow[0], amount: hRow[3] });
          if (!lastRelapse.alcohol && hRow[3] && !hRow[3].toLowerCase().includes('none')) lastRelapse.alcohol = new Date(hRow[0]);
        }
        if (hType === 'nicotine') {
          healthData.nicotine.push({ date: hRow[0], amount: hRow[3] });
          if (!lastRelapse.nicotine && hRow[3] && !hRow[3].toLowerCase().includes('none')) lastRelapse.nicotine = new Date(hRow[0]);
        }
        if (hType === 'pmo') {
          healthData.pmo.push({ date: hRow[0], status: hRow[3] });
          if (!lastRelapse.pmo && hRow[3] && hRow[3].toLowerCase().includes('relapse')) lastRelapse.pmo = new Date(hRow[0]);
        }
      }
      // Calculate streaks
      var today = new Date();
      if (lastRelapse.pmo) healthData.streaks.pmo = Math.floor((today - lastRelapse.pmo) / 86400000);
      if (lastRelapse.nicotine) healthData.streaks.nicotine = Math.floor((today - lastRelapse.nicotine) / 86400000);
      if (lastRelapse.alcohol) healthData.streaks.alcohol = Math.floor((today - lastRelapse.alcohol) / 86400000);
    } catch (e) {}

    var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>J.A.R.V.I.S. // A.T.H.E.N.A. â€” Command Center</title>';
    html += '<style>';

    // Base
    html += '@import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap");';
    html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
    html += 'body { background: #020810; color: #c0d8f0; font-family: "Rajdhani", sans-serif; min-height: 100vh; overflow-x: hidden; }';

    // ===== SWIPE CONTAINER =====
    html += '.swipe-wrapper { display: flex; width: 200vw; transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1); }';
    html += '.panel { width: 100vw; min-height: 100vh; overflow-y: auto; overflow-x: hidden; }';

    // Tab switcher
    html += '.tab-switcher { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); z-index: 50; display: flex; gap: 0; font-family: "Orbitron"; font-size: 0.6em; letter-spacing: 3px; }';
    html += '.tab-btn { padding: 10px 25px; cursor: pointer; transition: all 0.3s; border: 1px solid transparent; text-transform: uppercase; }';
    html += '.tab-btn.jarvis { color: #00d4ff40; border-color: #00d4ff20; }';
    html += '.tab-btn.jarvis.active { color: #00d4ff; border-color: #00d4ff; background: rgba(0,212,255,0.1); box-shadow: 0 0 20px rgba(0,212,255,0.15); }';
    html += '.tab-btn.athena { color: #a855f740; border-color: #a855f720; }';
    html += '.tab-btn.athena.active { color: #a855f7; border-color: #a855f7; background: rgba(168,85,247,0.1); box-shadow: 0 0 20px rgba(168,85,247,0.15); }';

    // Swipe indicator dots
    html += '.swipe-dots { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 50; display: flex; gap: 8px; }';
    html += '.swipe-dot { width: 8px; height: 8px; border-radius: 50%; transition: all 0.3s; cursor: pointer; }';
    html += '.swipe-dot.jarvis-dot { background: #00d4ff30; }';
    html += '.swipe-dot.jarvis-dot.active { background: #00d4ff; box-shadow: 0 0 10px #00d4ff; }';
    html += '.swipe-dot.athena-dot { background: #a855f730; }';
    html += '.swipe-dot.athena-dot.active { background: #a855f7; box-shadow: 0 0 10px #a855f7; }';

    // Animated background grid
    html += '.bg-grid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }';
    html += '.bg-grid::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px); background-size: 60px 60px; animation: gridMove 20s linear infinite; }';
    html += '@keyframes gridMove { 0% { transform: translate(0,0); } 100% { transform: translate(60px,60px); } }';

    // Scanning line
    html += '.scan-line { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #00d4ff, transparent); z-index: 1; animation: scanDown 4s ease-in-out infinite; opacity: 0.4; }';
    html += '@keyframes scanDown { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }';

    // Corner brackets
    html += '.corner { position: fixed; z-index: 2; width: 30px; height: 30px; border-color: #00d4ff30; border-style: solid; }';
    html += '.corner-tl { top: 15px; left: 15px; border-width: 2px 0 0 2px; }';
    html += '.corner-tr { top: 15px; right: 15px; border-width: 2px 2px 0 0; }';
    html += '.corner-bl { bottom: 15px; left: 15px; border-width: 0 0 2px 2px; }';
    html += '.corner-br { bottom: 15px; right: 15px; border-width: 0 2px 2px 0; }';

    // Content wrapper
    html += '.content { position: relative; z-index: 3; }';

    // Header
    html += '.header { padding: 50px 40px 30px; text-align: center; position: relative; }';
    html += '.header::after { content: ""; position: absolute; bottom: 0; left: 10%; width: 80%; height: 1px; background: linear-gradient(90deg, transparent, #00d4ff40, transparent); }';
    html += '.jarvis-title { font-family: "Orbitron", monospace; font-size: 3.5em; font-weight: 900; letter-spacing: 15px; color: #00d4ff; text-shadow: 0 0 40px rgba(0,212,255,0.4), 0 0 80px rgba(0,212,255,0.1); animation: titleGlow 3s ease-in-out infinite; }';
    html += '@keyframes titleGlow { 0%,100% { text-shadow: 0 0 40px rgba(0,212,255,0.4), 0 0 80px rgba(0,212,255,0.1); } 50% { text-shadow: 0 0 60px rgba(0,212,255,0.6), 0 0 120px rgba(0,212,255,0.2), 0 0 180px rgba(0,212,255,0.1); } }';
    html += '.status-bar { display: flex; justify-content: center; gap: 30px; margin-top: 20px; font-family: "Orbitron", monospace; font-size: 0.7em; letter-spacing: 3px; color: #4a6a8a; }';
    html += '.status-item { display: flex; align-items: center; gap: 8px; }';
    html += '.status-dot { width: 6px; height: 6px; border-radius: 50%; animation: dotPulse 2s infinite; }';
    html += '.status-dot.green { background: #00ff66; box-shadow: 0 0 10px #00ff66; }';
    html += '.status-dot.blue { background: #00d4ff; box-shadow: 0 0 10px #00d4ff; }';
    html += '@keyframes dotPulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.7); } }';

    // Hex ring animation
    html += '.hex-container { display: flex; justify-content: center; margin: 10px 0 20px; }';
    html += '.hex-ring { width: 120px; height: 120px; position: relative; animation: hexSpin 15s linear infinite; }';
    html += '.hex-ring::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 2px solid #00d4ff20; border-radius: 50%; }';
    html += '.hex-ring::after { content: ""; position: absolute; top: 10px; left: 10px; width: calc(100% - 20px); height: calc(100% - 20px); border: 1px solid #00d4ff10; border-radius: 50%; animation: hexSpin 10s linear infinite reverse; }';
    html += '@keyframes hexSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
    html += '.hex-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-family: "Orbitron"; font-size: 1.8em; font-weight: 900; color: #00d4ff; }';

    // Stats grid
    html += '.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 30px 40px; max-width: 1400px; margin: 0 auto; }';
    html += '.card { background: rgba(10,20,35,0.8); border: 1px solid #0a2a4a; border-radius: 4px; padding: 30px; position: relative; overflow: hidden; animation: cardFadeIn 0.6s ease-out both; }';
    html += '.card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--accent), transparent); animation: borderScan 3s linear infinite; }';
    html += '@keyframes borderScan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }';
    html += '@keyframes cardFadeIn { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }';
    html += '.card:nth-child(1) { animation-delay: 0.1s; --accent: #00d4ff; }';
    html += '.card:nth-child(2) { animation-delay: 0.2s; --accent: #ff4757; }';
    html += '.card:nth-child(3) { animation-delay: 0.3s; --accent: #00ff66; }';
    html += '.card:nth-child(4) { animation-delay: 0.4s; --accent: #a855f7; }';
    html += '.card:nth-child(5) { animation-delay: 0.5s; --accent: #00ff66; }';
    html += '.card:nth-child(6) { animation-delay: 0.6s; --accent: #ff9f43; }';
    html += '.card .label { font-family: "Orbitron"; font-size: 0.65em; letter-spacing: 3px; color: #4a6a8a; text-transform: uppercase; }';
    html += '.card .value { font-family: "Orbitron"; font-size: 3em; font-weight: 700; margin: 15px 0 8px; color: var(--accent); text-shadow: 0 0 30px color-mix(in srgb, var(--accent) 30%, transparent); }';
    html += '.card .sub { font-size: 0.95em; color: #3a5a7a; letter-spacing: 1px; }';
    html += '.card .bar { height: 3px; background: #0a1520; margin-top: 15px; border-radius: 2px; overflow: hidden; }';
    html += '.card .bar-fill { height: 100%; background: var(--accent); border-radius: 2px; animation: barGrow 2s ease-out both; }';
    html += '@keyframes barGrow { 0% { width: 0; } }';

    // Actions
    html += '.actions { display: flex; justify-content: center; gap: 15px; padding: 20px 40px 40px; flex-wrap: wrap; }';
    html += '.holo-btn { font-family: "Orbitron"; font-size: 0.75em; letter-spacing: 3px; padding: 14px 30px; background: transparent; border: 1px solid #00d4ff30; color: #00d4ff; text-decoration: none; text-transform: uppercase; position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer; }';
    html += '.holo-btn:hover { background: #00d4ff15; border-color: #00d4ff; box-shadow: 0 0 30px #00d4ff20, inset 0 0 30px #00d4ff10; }';
    html += '.holo-btn::after { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(transparent, rgba(0,212,255,0.05), transparent); transform: rotate(45deg); animation: btnShine 3s linear infinite; }';
    html += '@keyframes btnShine { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }';
    html += '.holo-btn.green { border-color: #00ff6630; color: #00ff66; }';
    html += '.holo-btn.green:hover { background: #00ff6615; border-color: #00ff66; box-shadow: 0 0 30px #00ff6620; }';

    // Systems grid
    html += '.systems { padding: 0 40px 40px; max-width: 1400px; margin: 0 auto; }';
    html += '.systems-title { font-family: "Orbitron"; font-size: 0.8em; letter-spacing: 5px; color: #4a6a8a; margin-bottom: 20px; text-transform: uppercase; }';
    html += '.systems-grid { display: flex; flex-wrap: wrap; gap: 8px; }';
    html += '.sys-chip { background: rgba(0,212,255,0.03); border: 1px solid #0a2a4a; padding: 8px 16px; font-family: "Rajdhani"; font-size: 0.85em; letter-spacing: 1px; color: #3a5a7a; transition: all 0.3s; cursor: default; position: relative; }';
    html += '.sys-chip:hover { border-color: #00d4ff; color: #00d4ff; background: rgba(0,212,255,0.08); box-shadow: 0 0 15px rgba(0,212,255,0.1); }';
    html += '.sys-chip::before { content: ""; position: absolute; top: 0; left: 0; width: 3px; height: 100%; background: #00d4ff; opacity: 0; transition: opacity 0.3s; }';
    html += '.sys-chip:hover::before { opacity: 1; }';

    // Clock
    html += '.clock { font-family: "Orbitron"; font-size: 0.7em; letter-spacing: 5px; color: #2a4a6a; text-align: center; padding: 30px; }';

    // Footer
    html += '.footer { text-align: center; padding: 20px; font-family: "Orbitron"; font-size: 0.6em; letter-spacing: 4px; color: #1a2a3a; border-top: 1px solid #0a1520; }';

    // Floating particles
    html += '.particle { position: fixed; width: 2px; height: 2px; background: #00d4ff; border-radius: 50%; pointer-events: none; z-index: 1; opacity: 0; animation: particleFloat 8s linear infinite; }';
    html += '@keyframes particleFloat { 0% { opacity: 0; transform: translateY(100vh); } 10% { opacity: 0.6; } 90% { opacity: 0.6; } 100% { opacity: 0; transform: translateY(-20vh); } }';

    // Mobile responsive
    html += '@media(max-width:768px){';
    html += '.grid{grid-template-columns:1fr!important;padding:15px 12px!important;}';
    html += '[style*="max-width:1400px"]{padding-left:12px!important;padding-right:12px!important;}';
    html += '[style*="padding:0 40px"]{padding-left:12px!important;padding-right:12px!important;}';
    html += '[style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr!important;}';
    html += '[style*="grid-template-columns:repeat(4"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '[style*="minmax(300px"]{grid-template-columns:1fr!important;}';
    html += '[style*="minmax(280px"]{grid-template-columns:1fr!important;}';
    html += '[style*="minmax(200px"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '[style*="minmax(180px"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '[style*="minmax(170px"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '.status-bar,.status-item{font-size:0.55em!important;}';
    html += '[style*="display:flex"][style*="justify-content:center"][style*="gap"]{flex-wrap:wrap!important;}';
    html += '[style*="font-size:2.8em"],[style*="font-size:3em"],[style*="font-size:2.5em"]{font-size:1.8em!important;}';
    html += '[style*="font-size:1.6em"]{font-size:1.2em!important;}';
    html += '[style*="letter-spacing:8px"],[style*="letter-spacing:6px"]{letter-spacing:3px!important;}';
    html += 'table{font-size:0.7em!important;}';
    html += '[style*="overflow-x"]{overflow-x:auto!important;-webkit-overflow-scrolling:touch;}';
    html += '.tab-switcher,.tab-btn{font-size:0.55em!important;padding:10px 15px!important;}';
    html += '}';
    html += '@media(max-width:480px){';
    html += '[style*="minmax(200px"]{grid-template-columns:1fr!important;}';
    html += '[style*="minmax(180px"]{grid-template-columns:1fr!important;}';
    html += '[style*="minmax(150px"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '}';

    html += '</style></head><body>';

    // ====== TAB SWITCHER ======
    html += '<div class="tab-switcher">';
    html += '<div class="tab-btn jarvis active" onclick="switchPanel(0)">J.A.R.V.I.S.</div>';
    html += '<div class="tab-btn athena" onclick="switchPanel(1)">A.T.H.E.N.A.</div>';
    html += '</div>';

    // Swipe dots
    html += '<div class="swipe-dots">';
    html += '<div class="swipe-dot jarvis-dot active" onclick="switchPanel(0)"></div>';
    html += '<div class="swipe-dot athena-dot" onclick="switchPanel(1)"></div>';
    html += '</div>';

    // ====== SWIPE WRAPPER ======
    html += '<div class="swipe-wrapper" id="swipe-wrapper">';

    // ====== PANEL 1: JARVIS (Personal) ======
    html += '<div class="panel" id="jarvis-panel">';
    html += '<div id="boot-screen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#020810;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;">';
    
    // Hex grid background for boot
    html += '<div style="position:absolute;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(rgba(0,212,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.02) 1px,transparent 1px);background-size:40px 40px;"></div>';
    
    // Center ring animation
    html += '<div id="boot-ring" style="width:120px;height:120px;border:2px solid #00d4ff20;border-radius:50%;position:relative;animation:bootRingSpin 2s linear infinite;opacity:0;">';
    html += '<div style="position:absolute;top:-2px;left:50%;width:8px;height:8px;background:#00d4ff;border-radius:50%;margin-left:-4px;box-shadow:0 0 20px #00d4ff;"></div>';
    html += '</div>';
    
    // Boot text lines
    html += '<div id="boot-text" style="margin-top:40px;font-family:Orbitron;font-size:0.65em;letter-spacing:4px;color:#00d4ff40;text-align:center;max-width:500px;line-height:2.2;">';
    html += '<div class="boot-line" style="opacity:0;">INITIALIZING NEURAL CORE...</div>';
    html += '<div class="boot-line" style="opacity:0;">LOADING IDENTITY PROFILE...</div>';
    html += '<div class="boot-line" style="opacity:0;">SYNCING ' + emailAccounts.length + ' EMAIL ACCOUNTS...</div>';
    html += '<div class="boot-line" style="opacity:0;">SCANNING ' + tabs.length + ' LIFE SYSTEMS...</div>';
    html += '<div class="boot-line" style="opacity:0;">CALENDAR SYNC: ' + todayEvents.length + ' EVENTS LOADED</div>';
    html += '<div class="boot-line" style="opacity:0;">ACTIVATING VOICE INTERFACE...</div>';
    html += '<div class="boot-line" style="opacity:0;">HABIT MONITORING: ONLINE</div>';
    html += '<div class="boot-line" style="opacity:0;">ACTIVATING A.T.H.E.N.A. BUSINESS ENGINE...</div>';
    html += '<div class="boot-line" style="opacity:0;">CRM DATA: ' + totalLocations + ' LOCATIONS // ' + totalBooked + ' ACTIVE BOOKINGS</div>';
    html += '<div class="boot-line" style="opacity:0;color:#00ff66;">ALL SYSTEMS OPERATIONAL</div>';
    html += '</div>';
    
    // JARVIS title reveal
    html += '<div id="boot-title" style="position:absolute;opacity:0;font-family:Orbitron;font-size:3em;font-weight:900;letter-spacing:15px;color:#00d4ff;text-shadow:0 0 60px rgba(0,212,255,0.6),0 0 120px rgba(0,212,255,0.2);text-align:center;line-height:1.6;">J.A.R.V.I.S.<br><span style="font-size:0.6em;letter-spacing:12px;background:linear-gradient(135deg,#a855f7,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 20px rgba(168,85,247,0.4));">A.T.H.E.N.A.</span></div>';
    
    // Welcome message
    var hour = new Date().toLocaleString('en-US', { hour: 'numeric', hour12: false, timeZone: 'America/Chicago' });
    var greeting = 'Good evening';
    var hourNum = parseInt(hour);
    if (hourNum >= 5 && hourNum < 12) greeting = 'Good morning';
    else if (hourNum >= 12 && hourNum < 17) greeting = 'Good afternoon';
    else if (hourNum >= 17 && hourNum < 21) greeting = 'Good evening';
    else greeting = 'Good night';
    
    html += '<div id="boot-welcome" style="position:absolute;bottom:25%;opacity:0;font-family:Rajdhani;font-size:1.4em;letter-spacing:6px;color:#3a5a7a;">' + greeting.toUpperCase() + ', TRACE</div>';
    
    html += '</div>';

    // Boot animation styles
    html += '<style>';
    html += '@keyframes bootRingSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
    html += '.boot-line { transition: opacity 0.3s, transform 0.3s; transform: translateY(5px); }';
    html += '.boot-line.visible { opacity: 1 !important; color: #00d4ff; transform: translateY(0); }';
    html += '.boot-line.done { color: #00ff66 !important; }';
    html += '#boot-screen { transition: opacity 0.8s ease-out; }';
    html += '</style>';

    // Boot sequence script
    html += '<script>';
    html += '(function(){';
    html += '  var ring=document.getElementById("boot-ring");';
    html += '  var lines=document.querySelectorAll(".boot-line");';
    html += '  var title=document.getElementById("boot-title");';
    html += '  var welcome=document.getElementById("boot-welcome");';
    html += '  var screen=document.getElementById("boot-screen");';
    html += '  var content=document.querySelector(".content");';
    html += '  if(content)content.style.opacity="0";';
    
    // Fade in ring
    html += '  setTimeout(function(){ring.style.opacity="1";ring.style.transition="opacity 0.5s";},200);';
    
    // Type out boot lines one by one
    html += '  var delay=600;';
    html += '  for(var i=0;i<lines.length;i++){';
    html += '    (function(idx){';
    html += '      setTimeout(function(){';
    html += '        lines[idx].classList.add("visible");';
    html += '        if(idx>0)lines[idx-1].style.color="#4a6a8a";';
    // Play a subtle beep
    html += '        try{var ctx=new(window.AudioContext||window.webkitAudioContext)();var osc=ctx.createOscillator();var gain=ctx.createGain();osc.connect(gain);gain.connect(ctx.destination);osc.frequency.value=800+(idx*100);gain.gain.value=0.03;osc.start();osc.stop(ctx.currentTime+0.05);}catch(e){}';
    html += '      },delay+idx*350);';
    html += '    })(i);';
    html += '  }';
    
    // After all lines, show title
    html += '  var totalTime=delay+lines.length*350+400;';
    html += '  setTimeout(function(){';
    html += '    ring.style.opacity="0";';
    html += '    document.getElementById("boot-text").style.opacity="0";document.getElementById("boot-text").style.transition="opacity 0.4s";';
    html += '  },totalTime);';
    
    // Flash title
    html += '  setTimeout(function(){';
    html += '    title.style.opacity="1";title.style.transition="opacity 0.3s";';
    html += '    welcome.style.opacity="1";welcome.style.transition="opacity 0.5s";';
    // Screen flash
    html += '    screen.style.background="radial-gradient(circle,#0a2040 0%,#020810 70%)";';
    html += '  },totalTime+500);';
    
    // Fade out boot screen, reveal dashboard
    html += '  setTimeout(function(){';
    html += '    screen.style.opacity="0";';
    html += '    if(content){content.style.transition="opacity 1s";content.style.opacity="1";}';
    html += '    setTimeout(function(){screen.style.display="none";},800);';
    
    // Speak the greeting
    html += '    var greetText="' + greeting + ', Trace. ';
    if (todayEvents.length > 0) {
      html += 'You have ' + todayEvents.length + ' event' + (todayEvents.length > 1 ? 's' : '') + ' today. ';
    } else {
      html += 'No events on your calendar today. ';
    }
    if (pendingReminders.length > 0) {
      html += pendingReminders.length + ' reminder' + (pendingReminders.length > 1 ? 's' : '') + ' pending. ';
    }
    if (totalUnread > 10) {
      html += totalUnread + ' unread emails. ';
    }
    html += 'All systems are online.";';
    
    // Try ElevenLabs first, fall back to browser speech
    html += '    fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:greetText})})';
    html += '    .then(function(r){if(!r.ok)throw new Error("TTS failed");return r.blob();})';
    html += '    .then(function(b){var a=new Audio(URL.createObjectURL(b));a.play();})';
    html += '    .catch(function(e){';
    html += '      console.log("ElevenLabs unavailable, using browser voice");';
    html += '      var synth2=window.speechSynthesis;var u=new SpeechSynthesisUtterance(greetText);u.rate=1.0;u.pitch=0.9;';
    html += '      var voices=synth2.getVoices();for(var v=0;v<voices.length;v++){if(voices[v].name.includes("Samantha")||voices[v].name.includes("Google UK English Male")||voices[v].name.includes("Male")){u.voice=voices[v];break;}}';
    html += '      synth2.speak(u);';
    html += '    });';
    
    html += '  },totalTime+2000);';
    
    html += '})();';
    html += '<\/script>';

    // Background effects
    html += '<div class="bg-grid"></div>';
    html += '<div class="scan-line"></div>';
    html += '<div class="corner corner-tl"></div><div class="corner corner-tr"></div><div class="corner corner-bl"></div><div class="corner corner-br"></div>';

    // Floating particles
    for (var p = 0; p < 20; p++) {
      var left = Math.floor(Math.random() * 100);
      var delay = (Math.random() * 8).toFixed(1);
      var size = (Math.random() * 2 + 1).toFixed(0);
      html += '<div class="particle" style="left:' + left + '%;width:' + size + 'px;height:' + size + 'px;animation-delay:' + delay + 's;"></div>';
    }

    html += '<div class="content">';

    // Header
    var now = new Date();
    var dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'America/Chicago' });
    var timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZone: 'America/Chicago' });
    html += '<div class="header">';
    html += '<div class="hex-container"><div class="hex-ring"><div class="hex-center" style="font-size:0.35em;line-height:1.3;">' + timeStr + '</div></div></div>';
    html += '<div class="jarvis-title">J.A.R.V.I.S.</div>';
    html += '<div style="font-family:Rajdhani;font-size:1.1em;letter-spacing:8px;color:#3a5a7a;margin-top:5px;text-transform:uppercase;">LifeOS Command Center</div>';
    html += '<div style="font-family:Rajdhani;font-size:0.95em;letter-spacing:4px;color:#00d4ff80;margin-top:3px;">' + dateStr + '</div>';

    // === TAB NAVIGATION ===
    html += '<div style="display:flex;justify-content:center;gap:0;margin-top:20px;margin-bottom:15px;">';
    html += '<a href="/dashboard" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#00d4ff;border:1px solid #00d4ff40;text-decoration:none;background:rgba(0,212,255,0.1);box-shadow:0 0 15px rgba(0,212,255,0.1);">JARVIS</a>';
    html += '<a href="/business" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">ATHENA</a>';
    html += '<a href="/tookan" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TOOKAN</a>';
    html += '<a href="/business/chart" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">CHARTS</a>';
    html += '<a href="/analytics" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">ANALYTICS</a>';
    html += '<a href="/ads" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">GOOGLE ADS</a>';
    html += '<a href="/square" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">SQUARE</a><a href="/discord" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">DISCORD</a><a href="/followup" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">FOLLOW UP</a><a href="/ai" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AI</a><a href="/forecast" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">FORECAST</a><a href="/seo" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">SEO</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AUDIT</a><a href="/auth/logout" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#ef4444;border:1px solid #ef444440;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">LOGOUT</a>';
    html += '</div>';
    html += '<div class="status-bar">';
    html += '<div class="status-item"><div class="status-dot green"></div>SYSTEMS ONLINE</div>';
    html += '<div class="status-item"><div class="status-dot blue"></div>AI ACTIVE</div>';
    html += '<div class="status-item"><div class="status-dot green"></div>' + emailAccounts.length + ' EMAIL LINKED</div>';
    html += '<div class="status-item"><div class="status-dot blue"></div>' + todayEvents.length + ' EVENTS TODAY</div>';
    html += '<div class="status-item"><div class="status-dot ' + (pendingReminders.length > 0 ? 'green' : 'blue') + '"></div>' + pendingReminders.length + ' REMINDERS</div>';
    html += '<div class="status-item"><div class="status-dot green"></div>VOICE READY</div>';
    html += '</div>';
    html += '</div>';

    // Stats Grid
    html += '<div class="grid">';

    var screenPct = Math.min(100, Math.round((parseFloat(screenTime) / 24) * 100));
    html += '<div class="card"><div class="label">Screen Time</div><div class="value">' + screenTime + 'h</div><div class="sub">' + (parseFloat(screenTime) > 10 ? 'WARNING â€” Exceeds optimal threshold' : 'Within optimal range') + '</div><div class="bar"><div class="bar-fill" style="width:' + screenPct + '%"></div></div></div>';

    html += '<div class="card"><div class="label">Inbox Status</div><div class="value">' + totalUnread + '</div><div class="sub">Unread across ' + emailAccounts.length + ' account(s)</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, totalUnread * 3) + '%"></div></div></div>';

    html += '<div class="card"><div class="label">Today\'s Events</div><div class="value">' + todayEvents.length + '</div><div class="sub">' + (todayEvents.length > 0 ? 'Next: ' + todayEvents[0].time + ' â€” ' + todayEvents[0].summary : 'No events today') + '</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, todayEvents.length * 20) + '%"></div></div></div>';

    html += '<div class="card"><div class="label">Pending Reminders</div><div class="value">' + pendingReminders.length + '</div><div class="sub">' + (pendingReminders.length > 0 ? pendingReminders[0].text : 'All clear') + '</div><div class="bar"><div class="bar-fill" style="width:' + (pendingReminders.length === 0 ? 100 : Math.min(100, pendingReminders.length * 25)) + '%"></div></div></div>';

    html += '<div class="card"><div class="label">Recent Wins</div><div class="value">' + recentWins.length + '</div><div class="sub">' + (recentWins.length > 0 ? recentWins[recentWins.length - 1][1] || 'Keep stacking' : 'No wins logged â€” text "win:" to start') + '</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, recentWins.length * 20) + '%"></div></div></div>';

    html += '<div class="card"><div class="label">Financial Status</div><div class="value">$' + parseInt(debtAmount).toLocaleString() + '</div><div class="sub">' + (parseFloat(debtAmount) === 0 ? 'DEBT FREE' : 'Total debt â€” grinding it down') + '</div><div class="bar"><div class="bar-fill" style="width:' + (parseFloat(debtAmount) === 0 ? 100 : 30) + '%"></div></div></div>';

    html += '<div class="card" style="--accent:#ff6b9d;"><div class="label">Gym This Week</div><div class="value">' + gymThisWeek + '</div><div class="sub">' + gymVisits + ' total visits' + (gymThisWeek >= 5 ? ' â€” BEAST MODE' : gymThisWeek >= 3 ? ' â€” Solid consistency' : ' â€” Get in there') + '</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, gymThisWeek * 15) + '%;background:#ff6b9d;"></div></div></div>';

    html += '<div class="card" style="--accent:#55f7d8;"><div class="label">Dating Log</div><div class="value">' + datingCount + '</div><div class="sub">' + (datingCount > 0 ? 'Interactions logged' : 'Text "date log" to start tracking') + '</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, datingCount * 10) + '%;background:#55f7d8;"></div></div></div>';

    html += '</div>';

    // Today's Schedule Section
    if (todayEvents.length > 0) {
      html += '<div class="systems" style="margin-top:10px;">';
      html += '<div class="systems-title" style="color:#a855f7;">Today\'s Schedule</div>';
      html += '<div style="display:flex;flex-direction:column;gap:8px;">';
      for (var ei = 0; ei < todayEvents.length; ei++) {
        html += '<div class="sys-chip" style="border-color:#a855f720;display:flex;justify-content:space-between;padding:12px 16px;">';
        html += '<span style="color:#a855f7;">' + todayEvents[ei].time + '</span>';
        html += '<span style="color:#c0d8f0;margin-left:15px;">' + todayEvents[ei].summary + '</span>';
        if (todayEvents[ei].location) html += '<span style="color:#4a6a8a;margin-left:10px;">@ ' + todayEvents[ei].location + '</span>';
        html += '</div>';
      }
      html += '</div></div>';
    }

    // Pending Reminders Section
    if (pendingReminders.length > 0) {
      html += '<div class="systems" style="margin-top:10px;">';
      html += '<div class="systems-title" style="color:#ff9f43;">Pending Reminders</div>';
      html += '<div style="display:flex;flex-direction:column;gap:8px;">';
      for (var ri = 0; ri < pendingReminders.length; ri++) {
        var hoursAgo = Math.round((Date.now() - pendingReminders[ri].created) / 3600000);
        html += '<div class="sys-chip" style="border-color:#ff9f4320;display:flex;justify-content:space-between;padding:12px 16px;">';
        html += '<span style="color:#ff9f43;">' + hoursAgo + 'h ago</span>';
        html += '<span style="color:#c0d8f0;margin-left:15px;">' + pendingReminders[ri].text + '</span>';
        html += '</div>';
      }
      html += '</div></div>';
    }

    // Gym History Section
    if (recentGym.length > 0) {
      html += '<div class="systems" style="margin-top:10px;">';
      html += '<div class="systems-title" style="color:#ff6b9d;">Gym History</div>';
      html += '<div style="display:flex;flex-direction:column;gap:8px;">';
      for (var ghi = 0; ghi < recentGym.length; ghi++) {
        html += '<div class="sys-chip" style="border-color:#ff6b9d20;display:flex;justify-content:space-between;padding:12px 16px;">';
        html += '<span style="color:#ff6b9d;">' + (recentGym[ghi][0] || '') + ' (' + (recentGym[ghi][1] || '') + ')</span>';
        html += '<span style="color:#c0d8f0;margin-left:15px;">' + (recentGym[ghi][2] || '') + '</span>';
        html += '<span style="color:#4a6a8a;margin-left:10px;">' + (recentGym[ghi][3] || '') + ' ' + (recentGym[ghi][4] || '') + '</span>';
        html += '</div>';
      }
      html += '</div></div>';
    }

    // Recent Wins Section
    if (recentWins.length > 0) {
      html += '<div class="systems" style="margin-top:10px;">';
      html += '<div class="systems-title" style="color:#00ff66;">Recent Wins</div>';
      html += '<div style="display:flex;flex-direction:column;gap:8px;">';
      for (var wi = 0; wi < recentWins.length; wi++) {
        html += '<div class="sys-chip" style="border-color:#00ff6620;display:flex;justify-content:space-between;padding:12px 16px;">';
        html += '<span style="color:#00ff66;">' + (recentWins[wi][0] || '') + '</span>';
        html += '<span style="color:#c0d8f0;margin-left:15px;">' + (recentWins[wi][1] || '') + '</span>';
        html += '<span style="color:#4a6a8a;margin-left:10px;">' + (recentWins[wi][2] || '') + '</span>';
        html += '</div>';
      }
      html += '</div></div>';
    }

    // Latest Daily Log
    if (recentLog && recentLog.data) {
      html += '<div class="systems" style="margin-top:10px;">';
      html += '<div class="systems-title" style="color:#00d4ff;">Latest Daily Check-in</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
      for (var li = 0; li < recentLog.headers.length; li++) {
        if (recentLog.data[li] && recentLog.data[li] !== '' && recentLog.data[li] !== '0') {
          html += '<div class="sys-chip" style="border-color:#00d4ff20;padding:10px 16px;">';
          html += '<span style="color:#4a6a8a;font-size:0.8em;">' + recentLog.headers[li] + '</span><br>';
          html += '<span style="color:#00d4ff;font-size:1.1em;">' + recentLog.data[li] + '</span>';
          html += '</div>';
        }
      }
      html += '</div></div>';
    }

    // Recent Daily Questions
    if (recentQuestions.length > 0) {
      html += '<div class="systems" style="margin-top:10px;">';
      html += '<div class="systems-title" style="color:#ff6b9d;">Recent Self-Reflection</div>';
      html += '<div style="display:flex;flex-direction:column;gap:8px;">';
      for (var qi = 0; qi < recentQuestions.length; qi++) {
        if (recentQuestions[qi][2] && recentQuestions[qi][3]) {
          html += '<div class="sys-chip" style="border-color:#ff6b9d20;padding:12px 16px;display:block;">';
          html += '<div style="color:#ff6b9d;font-size:0.85em;margin-bottom:5px;">Q: ' + (recentQuestions[qi][2] || '').substring(0, 80) + '</div>';
          html += '<div style="color:#c0d8f0;">A: ' + (recentQuestions[qi][3] || '').substring(0, 100) + '</div>';
          html += '</div>';
        }
      }
      html += '</div></div>';
    }

    // Private Health Section â€” collapsible, hidden by default
    html += '<div class="systems" style="margin-top:10px;">';
    html += '<div class="systems-title" style="color:#8b5cf6;cursor:pointer;" onclick="var el=document.getElementById(\'private-health\');var arrow=document.getElementById(\'health-arrow\');if(el.style.display===\'none\'){el.style.display=\'block\';arrow.textContent=\'â–¼\';}else{el.style.display=\'none\';arrow.textContent=\'â–¶\';}">Private Health &amp; Habits <span id="health-arrow" style="font-size:0.8em;">â–¶</span></div>';
    html += '<div id="private-health" style="display:none;">';

    // Streak cards
    html += '<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;">';

    html += '<div style="flex:1;min-width:120px;background:rgba(10,20,35,0.8);border:1px solid #8b5cf620;padding:15px;text-align:center;">';
    html += '<div style="font-size:0.75em;color:#4a6a8a;letter-spacing:2px;font-family:Orbitron;">PMO STREAK</div>';
    html += '<div style="font-size:2em;color:' + (healthData.streaks.pmo >= 7 ? '#00ff66' : healthData.streaks.pmo >= 3 ? '#ff9f43' : '#ff4757') + ';font-family:Orbitron;margin:5px 0;">' + healthData.streaks.pmo + '</div>';
    html += '<div style="font-size:0.8em;color:#4a6a8a;">days clean</div></div>';

    html += '<div style="flex:1;min-width:120px;background:rgba(10,20,35,0.8);border:1px solid #8b5cf620;padding:15px;text-align:center;">';
    html += '<div style="font-size:0.75em;color:#4a6a8a;letter-spacing:2px;font-family:Orbitron;">NICOTINE</div>';
    html += '<div style="font-size:2em;color:' + (healthData.streaks.nicotine >= 7 ? '#00ff66' : healthData.streaks.nicotine >= 3 ? '#ff9f43' : '#ff4757') + ';font-family:Orbitron;margin:5px 0;">' + healthData.streaks.nicotine + '</div>';
    html += '<div style="font-size:0.8em;color:#4a6a8a;">days clean</div></div>';

    html += '<div style="flex:1;min-width:120px;background:rgba(10,20,35,0.8);border:1px solid #8b5cf620;padding:15px;text-align:center;">';
    html += '<div style="font-size:0.75em;color:#4a6a8a;letter-spacing:2px;font-family:Orbitron;">ALCOHOL</div>';
    html += '<div style="font-size:2em;color:' + (healthData.streaks.alcohol >= 7 ? '#00ff66' : healthData.streaks.alcohol >= 3 ? '#ff9f43' : '#ff4757') + ';font-family:Orbitron;margin:5px 0;">' + healthData.streaks.alcohol + '</div>';
    html += '<div style="font-size:0.8em;color:#4a6a8a;">days clean</div></div>';

    var todayWater = healthData.water.filter(function(w) { return w.date === new Date().toISOString().split('T')[0]; });
    html += '<div style="flex:1;min-width:120px;background:rgba(10,20,35,0.8);border:1px solid #00d4ff20;padding:15px;text-align:center;">';
    html += '<div style="font-size:0.75em;color:#4a6a8a;letter-spacing:2px;font-family:Orbitron;">WATER TODAY</div>';
    html += '<div style="font-size:2em;color:#00d4ff;font-family:Orbitron;margin:5px 0;">' + (todayWater.length > 0 ? todayWater[todayWater.length - 1].amount : '0') + '</div>';
    html += '<div style="font-size:0.8em;color:#4a6a8a;">logged</div></div>';

    html += '</div>';

    // Recent habit entries
    var recentHealth = [];
    var allHealthEntries = healthData.pmo.map(function(p) { return { date: p.date, type: 'PMO', val: p.status }; })
      .concat(healthData.nicotine.map(function(n) { return { date: n.date, type: 'Nicotine', val: n.amount }; }))
      .concat(healthData.alcohol.map(function(a) { return { date: a.date, type: 'Alcohol', val: a.amount }; }));
    allHealthEntries.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
    recentHealth = allHealthEntries.slice(0, 10);

    if (recentHealth.length > 0) {
      html += '<div style="display:flex;flex-direction:column;gap:6px;margin-top:10px;">';
      for (var rhi = 0; rhi < recentHealth.length; rhi++) {
        var rh = recentHealth[rhi];
        var rhClean = rh.val && (rh.val.toLowerCase().includes('none') || rh.val.toLowerCase().includes('clean'));
        html += '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:rgba(10,20,35,0.5);border-left:3px solid ' + (rhClean ? '#00ff66' : '#ff4757') + ';">';
        html += '<span style="color:#4a6a8a;">' + (rh.date || '') + '</span>';
        html += '<span style="color:#8b5cf6;">' + (rh.type || '') + '</span>';
        html += '<span style="color:' + (rhClean ? '#00ff66' : '#ff4757') + ';">' + (rh.val || '') + '</span>';
        html += '</div>';
      }
      html += '</div>';
    }

    html += '</div></div>';

    // Email Inbox Panel â€” collapsible
    html += '<div class="systems" style="margin-top:10px;">';
    html += '<div class="systems-title" style="color:#ff6348;cursor:pointer;" onclick="var el=document.getElementById(\'email-panel\');var arrow=document.getElementById(\'email-arrow\');if(el.style.display===\'none\'){el.style.display=\'block\';arrow.textContent=\'â–¼\';}else{el.style.display=\'none\';arrow.textContent=\'â–¶\';}">Inbox (' + totalUnread + ' unread) <span id="email-arrow" style="font-size:0.8em;">â–¶</span></div>';
    html += '<div id="email-panel" style="display:none;">';

    // Fetch actual email details
    var emailDetails = [];
    for (var eda = 0; eda < emailAccounts.length; eda++) {
      try {
        var gmailClient = await getGmailClient(emailAccounts[eda]);
        if (!gmailClient) continue;
        var listRes = await gmailClient.users.messages.list({ userId: 'me', q: 'is:unread', maxResults: 10 });
        var msgs = listRes.data.messages || [];
        for (var em = 0; em < Math.min(msgs.length, 10); em++) {
          var msgData = await gmailClient.users.messages.get({ userId: 'me', id: msgs[em].id, format: 'metadata', metadataHeaders: ['From', 'Subject', 'Date'] });
          var hdrs = msgData.data.payload.headers;
          var fromH = hdrs.find(function(h) { return h.name === 'From'; });
          var subjH = hdrs.find(function(h) { return h.name === 'Subject'; });
          var dateH = hdrs.find(function(h) { return h.name === 'Date'; });
          emailDetails.push({
            id: msgs[em].id,
            account: emailAccounts[eda],
            from: fromH ? fromH.value.replace(/<.*>/, '').trim() : 'Unknown',
            subject: subjH ? subjH.value : '(no subject)',
            date: dateH ? dateH.value : '',
            snippet: msgData.data.snippet || '',
          });
        }
      } catch (e) { console.log("Email detail error: " + e.message); }
    }

    if (emailDetails.length > 0) {
      for (var edi = 0; edi < emailDetails.length; edi++) {
        var ed = emailDetails[edi];
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #ff634820;padding:15px;margin-bottom:8px;position:relative;" id="email-' + ed.id + '">';
        html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;">';
        html += '<div style="flex:1;">';
        html += '<div style="color:#ff6348;font-size:0.9em;font-weight:600;">' + escapeHtml(ed.from.substring(0, 40)) + '</div>';
        html += '<div style="color:#c0d8f0;font-size:0.95em;margin:4px 0;">' + escapeHtml(ed.subject.substring(0, 60)) + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.8em;">' + escapeHtml(ed.snippet.substring(0, 100)) + '...</div>';
        html += '</div>';
        html += '<div style="display:flex;gap:8px;margin-left:10px;flex-shrink:0;">';
        // AI Reply button
        html += '<div onclick="aiReply(\'' + ed.id + '\',\'' + ed.account.replace(/'/g, "\\'") + '\')" style="padding:6px 12px;border:1px solid #00ff6630;color:#00ff66;font-family:Orbitron;font-size:0.6em;letter-spacing:2px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background=\'#00ff6615\'" onmouseout="this.style.background=\'transparent\'">AI REPLY</div>';
        // Delete button
        html += '<div onclick="deleteEmail(\'' + ed.id + '\',\'' + ed.account.replace(/'/g, "\\'") + '\')" style="padding:6px 12px;border:1px solid #ff475730;color:#ff4757;font-family:Orbitron;font-size:0.6em;letter-spacing:2px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background=\'#ff475715\'" onmouseout="this.style.background=\'transparent\'">DELETE</div>';
        // Archive button
        html += '<div onclick="archiveEmail(\'' + ed.id + '\',\'' + ed.account.replace(/'/g, "\\'") + '\')" style="padding:6px 12px;border:1px solid #ff9f4330;color:#ff9f43;font-family:Orbitron;font-size:0.6em;letter-spacing:2px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background=\'#ff9f4315\'" onmouseout="this.style.background=\'transparent\'">ARCHIVE</div>';
        html += '</div></div>';
        // AI Reply area (hidden)
        html += '<div id="reply-' + ed.id + '" style="display:none;margin-top:10px;border-top:1px solid #00ff6620;padding-top:10px;">';
        html += '<div id="reply-text-' + ed.id + '" style="color:#c0d8f0;font-size:0.9em;padding:10px;background:rgba(0,255,102,0.03);border:1px solid #00ff6610;min-height:60px;">Generating reply...</div>';
        html += '<div style="display:flex;gap:8px;margin-top:8px;">';
        html += '<div onclick="sendReply(\'' + ed.id + '\',\'' + ed.account.replace(/'/g, "\\'") + '\')" style="padding:6px 16px;border:1px solid #00ff6630;color:#00ff66;font-family:Orbitron;font-size:0.6em;cursor:pointer;" id="send-btn-' + ed.id + '">SEND</div>';
        html += '<div onclick="document.getElementById(\'reply-' + ed.id + '\').style.display=\'none\';" style="padding:6px 16px;border:1px solid #4a6a8a30;color:#4a6a8a;font-family:Orbitron;font-size:0.6em;cursor:pointer;">CANCEL</div>';
        html += '</div></div>';
        html += '</div>';
      }
    } else {
      html += '<div style="color:#4a6a8a;text-align:center;padding:20px;">Inbox clean.</div>';
    }

    html += '</div></div>';

    // Actions â€” buttons
    html += '<div class="actions">';
    html += '<div class="holo-btn green" onclick="toggleVoiceChat()" id="voice-btn" style="cursor:pointer;">Talk to Jarvis</div>';
    html += '<a class="holo-btn" href="/call?key=' + (process.env.CALL_SECRET || '') + '">Phone Call</a>';
    html += '<a class="holo-btn" href="/briefing" target="_blank">Full Briefing</a>';
    html += '<a class="holo-btn" href="/gmail/summary" target="_blank">Email Intel</a>';
    html += '<a class="holo-btn" href="/daily-questions?key=' + (process.env.CALL_SECRET || '') + '">Start 10 Questions</a>';
    html += '<a class="holo-btn" href="/gmail/auth" target="_blank">Link Account</a>';
    html += '</div>';

    // Voice chat panel
    html += '<div id="voice-panel" style="display:none;max-width:800px;margin:0 auto 30px;padding:0 40px;">';
    html += '<div style="background:rgba(10,20,35,0.9);border:1px solid #00ff6630;padding:30px;position:relative;overflow:hidden;">';
    html += '<div style="position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,#00ff66,transparent);animation:borderScan 3s linear infinite;"></div>';

    // Status display
    html += '<div style="text-align:center;margin-bottom:20px;">';
    html += '<div id="voice-status" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;color:#4a6a8a;">CLICK MIC TO SPEAK</div>';
    html += '<div id="voice-waveform" style="height:40px;display:flex;align-items:center;justify-content:center;gap:3px;margin:15px 0;"></div>';
    html += '</div>';

    // Mic button
    html += '<div style="text-align:center;margin-bottom:20px;">';
    html += '<div id="mic-btn" onclick="toggleListening()" style="width:80px;height:80px;border-radius:50%;border:2px solid #00ff6640;background:rgba(0,255,102,0.05);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s;position:relative;">';
    html += '<svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#00ff66" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>';
    html += '<div id="mic-pulse" style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;border:2px solid #00ff66;opacity:0;"></div>';
    html += '</div>';
    html += '</div>';

    // Conversation log
    html += '<div id="voice-log" style="max-height:300px;overflow-y:auto;font-size:0.95em;"></div>';

    html += '</div></div>';

    // Voice chat CSS additions
    html += '<style>';
    html += '#mic-btn:hover { background: rgba(0,255,102,0.15); border-color: #00ff66; box-shadow: 0 0 30px rgba(0,255,102,0.2); }';
    html += '#mic-btn.listening { background: rgba(0,255,102,0.2); border-color: #00ff66; box-shadow: 0 0 40px rgba(0,255,102,0.3); }';
    html += '#mic-btn.listening #mic-pulse { animation: micPulse 1.5s ease-out infinite; }';
    html += '@keyframes micPulse { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.8); opacity: 0; } }';
    html += '.voice-msg { padding: 12px 0; border-bottom: 1px solid #0a1520; }';
    html += '.voice-msg .sender { font-family: Orbitron; font-size: 0.6em; letter-spacing: 3px; margin-bottom: 5px; }';
    html += '.voice-msg .text { color: #7a9ab0; line-height: 1.6; }';
    html += '.voice-msg.jarvis .sender { color: #00ff66; }';
    html += '.voice-msg.jarvis .text { color: #a0c8e0; }';
    html += '.voice-msg.user .sender { color: #00d4ff; }';
    html += '#voice-panel.speaking #mic-btn { border-color: #00ff6680; }';
    html += '.wave-bar { width: 3px; background: #00ff6640; border-radius: 2px; transition: height 0.1s; }';
    html += '</style>';

    // Categorize tabs
    var categories = {
      'Finance': [], 'Business': [], 'Health & Wellness': [], 'Productivity': [],
      'Identity & Growth': [], 'Knowledge': [], 'Social & Relationships': [], 'System': []
    };
    var catKeywords = {
      'Finance': ['debt','finance','bank','money','budget','income','expense','credit','bill','payment','invest'],
      'Business': ['business','idea','ledger','revenue','client','thumbtack','invoice','startup','entrepreneur'],
      'Health & Wellness': ['health','screen','gratitude','wellness','gym','exercise','sleep','mindset','mental','habit','journal','win'],
      'Productivity': ['task','priority','focus','log','dashboard','schedule','calendar','time','goal','action','todo'],
      'Identity & Growth': ['identity','profile','trace','values','vision','purpose','dating','confidence','style'],
      'Knowledge': ['read','book','knowledge','learn','eval','retention','memory','note','research','chat','import'],
      'Social & Relationships': ['contact','interaction','conversation','friend','network','social','relationship'],
      'System': ['template','config','setting','data','archive','master','index','map']
    };

    for (var tc = 0; tc < tabs.length; tc++) {
      var tabLower = tabs[tc].toLowerCase();
      var placed = false;
      var catNames = Object.keys(catKeywords);
      for (var cn = 0; cn < catNames.length; cn++) {
        var kws = catKeywords[catNames[cn]];
        for (var kw = 0; kw < kws.length; kw++) {
          if (tabLower.includes(kws[kw])) {
            categories[catNames[cn]].push(tabs[tc]);
            placed = true;
            break;
          }
        }
        if (placed) break;
      }
      if (!placed) categories['System'].push(tabs[tc]);
    }

    // Category colors
    var catColors = {
      'Finance': '#00ff66', 'Business': '#a855f7', 'Health & Wellness': '#ff6b9d',
      'Productivity': '#ff9f43', 'Identity & Growth': '#00d4ff', 'Knowledge': '#f7d855',
      'Social & Relationships': '#55f7d8', 'System': '#4a6a8a'
    };

    // All Systems by Category
    html += '<div class="systems">';
    html += '<div class="systems-title">Systems by Category</div>';

    var catKeys = Object.keys(categories);
    for (var ci = 0; ci < catKeys.length; ci++) {
      if (categories[catKeys[ci]].length === 0) continue;
      var catColor = catColors[catKeys[ci]] || '#4a6a8a';
      html += '<div style="margin-bottom:25px;">';
      html += '<div style="font-family:Orbitron;font-size:0.7em;letter-spacing:3px;color:' + catColor + ';margin-bottom:10px;display:flex;align-items:center;gap:10px;">';
      html += '<span style="display:inline-block;width:8px;height:8px;background:' + catColor + ';border-radius:50%;box-shadow:0 0 8px ' + catColor + ';"></span>';
      html += catKeys[ci].toUpperCase() + ' <span style="color:#2a4a6a;">(' + categories[catKeys[ci]].length + ')</span></div>';
      html += '<div class="systems-grid">';
      for (var si = 0; si < categories[catKeys[ci]].length; si++) {
        var tabName = categories[catKeys[ci]][si];
        html += '<div class="sys-chip" onclick="loadTab(\'' + tabName.replace(/'/g, "\\'") + '\')" style="cursor:pointer;border-color:' + catColor + '20;">' + tabName.replace(/_/g, ' ') + '</div>';
      }
      html += '</div></div>';
    }
    html += '</div>';

    // Modal for tab data
    html += '<div id="tab-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(2,8,16,0.95);z-index:100;overflow-y:auto;">';
    html += '<div style="max-width:1200px;margin:30px auto;padding:20px;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">';
    html += '<div id="modal-title" style="font-family:Orbitron;font-size:1.2em;letter-spacing:3px;color:#00d4ff;"></div>';
    html += '<div onclick="closeModal()" style="font-family:Orbitron;font-size:0.8em;letter-spacing:2px;color:#ff4757;cursor:pointer;padding:10px 20px;border:1px solid #ff475730;transition:all 0.3s;" onmouseover="this.style.background=\'#ff475715\'" onmouseout="this.style.background=\'transparent\'">CLOSE</div>';
    html += '</div>';
    html += '<div id="modal-loading" style="text-align:center;padding:60px;font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#4a6a8a;animation:pulse 1.5s infinite;">LOADING DATA...</div>';
    html += '<div id="modal-content" style="overflow-x:auto;"></div>';
    html += '</div></div>';

    // JavaScript for tab loading
    html += '<script>';
    html += 'function loadTab(name) {';
    html += '  document.getElementById("tab-modal").style.display="block";';
    html += '  document.getElementById("modal-title").textContent=name.replace(/_/g," ");';
    html += '  document.getElementById("modal-loading").style.display="block";';
    html += '  document.getElementById("modal-content").innerHTML="";';
    html += '  fetch("/tab/"+encodeURIComponent(name))';
    html += '    .then(function(r){return r.json()})';
    html += '    .then(function(data){';
    html += '      document.getElementById("modal-loading").style.display="none";';
    html += '      if(data.error){document.getElementById("modal-content").innerHTML="<div style=\\"color:#ff4757;text-align:center;padding:40px;\\">ERROR: "+data.error+"</div>";return;}';
    html += '      if(!data.headers||data.headers.length===0){document.getElementById("modal-content").innerHTML="<div style=\\"color:#4a6a8a;text-align:center;padding:40px;font-family:Orbitron;font-size:0.8em;\\">NO DATA</div>";return;}';
    html += '      var headers=data.headers;var rows=(data.rows||[]).slice(0,50);';
    html += '      var t="<div style=\\"font-family:Orbitron;font-size:0.65em;color:#4a6a8a;letter-spacing:2px;margin-bottom:10px;\\">"+(data.rowCount||0)+" ROWS // SHOWING FIRST 50</div>";';
    html += '      t+="<table style=\\"width:100%;border-collapse:collapse;font-size:0.9em;\\">";';
    html += '      t+="<thead><tr>";';
    html += '      for(var h=0;h<headers.length;h++){t+="<th style=\\"padding:10px 12px;text-align:left;border-bottom:1px solid #0a2a4a;font-family:Orbitron;font-size:0.7em;letter-spacing:2px;color:#00d4ff;white-space:nowrap;\\">"+headers[h]+"</th>";}';
    html += '      t+="</tr></thead><tbody>";';
    html += '      for(var r=0;r<rows.length;r++){';
    html += '        t+="<tr style=\\"border-bottom:1px solid #0a1520;\\">";';
    html += '        for(var c=0;c<headers.length;c++){';
    html += '          var val=rows[r][c]||"";';
    html += '          t+="<td style=\\"padding:8px 12px;color:#7a9ab0;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\\">"+val+"</td>";';
    html += '        }';
    html += '        t+="</tr>";';
    html += '      }';
    html += '      t+="</tbody></table>";';
    html += '      document.getElementById("modal-content").innerHTML=t;';
    html += '    })';
    html += '    .catch(function(e){document.getElementById("modal-loading").style.display="none";document.getElementById("modal-content").innerHTML="<div style=\\"color:#ff4757;text-align:center;padding:40px;\\">ERROR: "+e.message+"</div>";});';
    html += '}';
    html += 'function closeModal(){document.getElementById("tab-modal").style.display="none";}';
    html += 'document.addEventListener("keydown",function(e){if(e.key==="Escape")closeModal();});';
    html += '<\/script>';

    // Live clock
    html += '<div class="clock" id="clock"></div>';
    html += '<script>function updateClock(){var d=new Date();var h=String(d.getHours()).padStart(2,"0");var m=String(d.getMinutes()).padStart(2,"0");var s=String(d.getSeconds()).padStart(2,"0");document.getElementById("clock").textContent=h+":"+m+":"+s+" // "+d.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}).toUpperCase();}setInterval(updateClock,1000);updateClock();';

    // Voice chat JavaScript
    html += 'var voiceOpen=false;var isListening=false;var isSpeaking=false;var recognition=null;var sessionId="s"+Date.now();';
    html += 'var synth=window.speechSynthesis;';

    // Create waveform bars
    html += 'var wf=document.getElementById("voice-waveform");for(var wb=0;wb<30;wb++){var bar=document.createElement("div");bar.className="wave-bar";bar.style.height="4px";wf.appendChild(bar);}';
    html += 'var waveBars=document.querySelectorAll(".wave-bar");';

    // Toggle voice panel
    html += 'function toggleVoiceChat(){voiceOpen=!voiceOpen;document.getElementById("voice-panel").style.display=voiceOpen?"block":"none";document.getElementById("voice-btn").textContent=voiceOpen?"Close Voice":"Talk to Jarvis";document.getElementById("voice-btn").style.borderColor=voiceOpen?"#ff4757":"#00ff66";document.getElementById("voice-btn").style.color=voiceOpen?"#ff4757":"#00ff66";if(!voiceOpen&&isListening)stopListening();}';

    // Animate waveform
    html += 'var waveInterval=null;';
    html += 'function startWave(color){waveBars.forEach(function(b){b.style.background=color;});waveInterval=setInterval(function(){waveBars.forEach(function(b){b.style.height=Math.floor(Math.random()*30+4)+"px";});},100);}';
    html += 'function stopWave(){if(waveInterval)clearInterval(waveInterval);waveBars.forEach(function(b){b.style.height="4px";b.style.background="#00ff6640";});}';

    // Speech recognition
    html += 'function toggleListening(){if(isSpeaking)return;if(isListening){stopListening();}else{startListening();}}';

    html += 'function startListening(){';
    html += '  if(!("webkitSpeechRecognition" in window)&&!("SpeechRecognition" in window)){alert("Speech recognition not supported. Use Chrome.");return;}';
    html += '  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;';
    html += '  recognition=new SR();recognition.continuous=false;recognition.interimResults=false;recognition.lang="en-US";';
    html += '  recognition.onstart=function(){isListening=true;document.getElementById("mic-btn").classList.add("listening");document.getElementById("voice-status").textContent="LISTENING...";document.getElementById("voice-status").style.color="#00ff66";startWave("#00ff6680");};';
    html += '  recognition.onresult=function(e){var text=e.results[0][0].transcript;stopListening();addMessage("user",text);sendToJarvis(text);};';
    html += '  recognition.onerror=function(e){stopListening();document.getElementById("voice-status").textContent="ERROR: "+e.error;document.getElementById("voice-status").style.color="#ff4757";};';
    html += '  recognition.onend=function(){if(isListening)stopListening();};';
    html += '  recognition.start();';
    html += '}';

    html += 'function stopListening(){isListening=false;if(recognition)try{recognition.stop();}catch(e){}document.getElementById("mic-btn").classList.remove("listening");document.getElementById("voice-status").textContent="CLICK MIC TO SPEAK";document.getElementById("voice-status").style.color="#4a6a8a";stopWave();}';

    // Send to server
    html += 'function sendToJarvis(text){';
    html += '  document.getElementById("voice-status").textContent="PROCESSING...";document.getElementById("voice-status").style.color="#00d4ff";startWave("#00d4ff80");';
    html += '  fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:sessionId,message:text})})';
    html += '    .then(function(r){return r.json()})';
    html += '    .then(function(data){';
    html += '      stopWave();';
    html += '      if(data.error){addMessage("jarvis","Error: "+data.error);return;}';
    html += '      addMessage("jarvis",data.response);';
    html += '      speakResponse(data.response);';
    html += '    })';
    html += '    .catch(function(e){stopWave();addMessage("jarvis","Connection error.");});';
    html += '}';

    // Text to speech via ElevenLabs directly from browser
    html += 'var audioQueue=[];var currentAudio=null;';
    html += 'function speakResponse(text){';
    html += '  isSpeaking=true;document.getElementById("voice-status").textContent="JARVIS SPEAKING...";document.getElementById("voice-status").style.color="#00ff66";startWave("#00ff6680");';
    html += '  fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:text})})';
    html += '    .then(function(r){if(!r.ok)throw new Error("TTS status "+r.status);return r.blob();})';
    html += '    .then(function(blob){';
    html += '      if(blob.size<1000)throw new Error("Audio too small");';
    html += '      var url=URL.createObjectURL(blob);';
    html += '      currentAudio=new Audio(url);';
    html += '      currentAudio.onended=function(){isSpeaking=false;stopWave();document.getElementById("voice-status").textContent="CLICK MIC TO SPEAK";document.getElementById("voice-status").style.color="#4a6a8a";URL.revokeObjectURL(url);};';
    html += '      currentAudio.onerror=function(){console.log("Audio play error, using browser voice");URL.revokeObjectURL(url);browserSpeak(text);};';
    html += '      currentAudio.play().catch(function(){console.log("Play blocked, using browser voice");browserSpeak(text);});';
    html += '    })';
    html += '    .catch(function(e){';
    html += '      console.log("ElevenLabs failed: "+e.message+", using browser voice");';
    html += '      browserSpeak(text);';
    html += '    });';
    html += '}';
    html += 'function browserSpeak(text){';
    html += '  var utter=new SpeechSynthesisUtterance(text);utter.rate=1.05;utter.pitch=1.1;';
    html += '  var voices=synth.getVoices();for(var v=0;v<voices.length;v++){if(voices[v].name.includes("Samantha")||voices[v].name.includes("Google UK English Female")||voices[v].name.includes("Female")){utter.voice=voices[v];break;}}';
    html += '  utter.onend=function(){isSpeaking=false;stopWave();document.getElementById("voice-status").textContent="CLICK MIC TO SPEAK";document.getElementById("voice-status").style.color="#4a6a8a";};';
    html += '  synth.speak(utter);';
    html += '}';

    // Add message to log
    html += 'function addMessage(who,text){';
    html += '  var log=document.getElementById("voice-log");';
    html += '  var div=document.createElement("div");div.className="voice-msg "+who;';
    html += '  div.innerHTML="<div class=\\"sender\\">"+(who==="user"?"TRACE":"JARVIS")+"</div><div class=\\"text\\">"+text+"</div>";';
    html += '  log.appendChild(div);log.scrollTop=log.scrollHeight;';
    html += '}';

    // Load voices
    html += 'if(synth.onvoiceschanged!==undefined)synth.onvoiceschanged=function(){synth.getVoices();};';

    // ====== ATHENA VOICE CHAT JAVASCRIPT ======
    html += 'var athenaVoiceOpen=false;var athenaListening=false;var athenaSpeaking=false;var athenaRecog=null;var athenaSessionId="a"+Date.now();';

    // Create waveform bars for Athena
    html += '(function(){var wf=document.getElementById("athena-waveform");if(wf){for(var i=0;i<30;i++){var bar=document.createElement("div");bar.className="athena-wave-bar";bar.style.height="4px";wf.appendChild(bar);}}})();';

    // Toggle Athena voice panel
    html += 'function toggleAthenaVoice(){athenaVoiceOpen=!athenaVoiceOpen;document.getElementById("athena-voice-panel").style.display=athenaVoiceOpen?"block":"none";var btn=document.getElementById("athena-voice-btn");btn.textContent=athenaVoiceOpen?"Close Voice":"Talk to Athena";btn.style.borderColor=athenaVoiceOpen?"#ff4757":"#a855f740";btn.style.color=athenaVoiceOpen?"#ff4757":"#a855f7";if(!athenaVoiceOpen&&athenaListening)stopAthenaListening();}';

    // Athena wave animation
    html += 'var athenaWaveInt=null;';
    html += 'function startAthenaWave(color){var bars=document.querySelectorAll(".athena-wave-bar");bars.forEach(function(b){b.style.background=color;});athenaWaveInt=setInterval(function(){bars.forEach(function(b){b.style.height=Math.floor(Math.random()*30+4)+"px";});},100);}';
    html += 'function stopAthenaWave(){if(athenaWaveInt)clearInterval(athenaWaveInt);var bars=document.querySelectorAll(".athena-wave-bar");bars.forEach(function(b){b.style.height="4px";b.style.background="#a855f740";});}';

    // Athena speech recognition
    html += 'function toggleAthenaListening(){if(athenaSpeaking)return;if(athenaListening){stopAthenaListening();}else{startAthenaListening();}}';

    html += 'function startAthenaListening(){';
    html += '  if(!("webkitSpeechRecognition" in window)&&!("SpeechRecognition" in window)){alert("Speech recognition not supported. Use Chrome.");return;}';
    html += '  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;';
    html += '  athenaRecog=new SR();athenaRecog.continuous=false;athenaRecog.interimResults=false;athenaRecog.lang="en-US";';
    html += '  athenaRecog.onstart=function(){athenaListening=true;document.getElementById("athena-mic-btn").classList.add("listening");document.getElementById("athena-voice-status").textContent="LISTENING...";document.getElementById("athena-voice-status").style.color="#a855f7";startAthenaWave("#a855f780");};';
    html += '  athenaRecog.onresult=function(e){var text=e.results[0][0].transcript;stopAthenaListening();addAthenaMsg("user",text);sendToAthena(text);};';
    html += '  athenaRecog.onerror=function(e){stopAthenaListening();document.getElementById("athena-voice-status").textContent="ERROR: "+e.error;document.getElementById("athena-voice-status").style.color="#ff4757";};';
    html += '  athenaRecog.onend=function(){if(athenaListening)stopAthenaListening();};';
    html += '  athenaRecog.start();';
    html += '}';

    html += 'function stopAthenaListening(){athenaListening=false;if(athenaRecog)try{athenaRecog.stop();}catch(e){}document.getElementById("athena-mic-btn").classList.remove("listening");document.getElementById("athena-voice-status").textContent="CLICK MIC TO SPEAK";document.getElementById("athena-voice-status").style.color="#4a6a8a";stopAthenaWave();}';

    // Send typed text
    html += 'function sendAthenaText(){var inp=document.getElementById("athena-text-input");var text=inp.value.trim();if(!text)return;inp.value="";addAthenaMsg("user",text);sendToAthena(text);}';

    // Send to Athena endpoint
    html += 'function sendToAthena(text){';
    html += '  document.getElementById("athena-voice-status").textContent="ATHENA PROCESSING...";document.getElementById("athena-voice-status").style.color="#c084fc";startAthenaWave("#c084fc80");';
    html += '  fetch("/chat/athena",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:athenaSessionId,message:text})})';
    html += '    .then(function(r){return r.json()})';
    html += '    .then(function(data){';
    html += '      stopAthenaWave();';
    html += '      if(data.error){addAthenaMsg("athena","Error: "+data.error);return;}';
    html += '      addAthenaMsg("athena",data.response);';
    html += '      speakAthena(data.response);';
    html += '    })';
    html += '    .catch(function(e){stopAthenaWave();addAthenaMsg("athena","Connection error.");});';
    html += '}';

    // Athena TTS (uses female voice)
    html += 'var athenaAudio=null;';
    html += 'function speakAthena(text){';
    html += '  athenaSpeaking=true;document.getElementById("athena-voice-status").textContent="ATHENA SPEAKING...";document.getElementById("athena-voice-status").style.color="#a855f7";startAthenaWave("#a855f780");';
    html += '  fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:text,voice:"athena"})})';
    html += '    .then(function(r){if(!r.ok)throw new Error("TTS failed");return r.blob();})';
    html += '    .then(function(blob){';
    html += '      if(blob.size<1000)throw new Error("Audio too small");';
    html += '      var url=URL.createObjectURL(blob);';
    html += '      athenaAudio=new Audio(url);';
    html += '      athenaAudio.onended=function(){athenaSpeaking=false;stopAthenaWave();document.getElementById("athena-voice-status").textContent="CLICK MIC TO SPEAK";document.getElementById("athena-voice-status").style.color="#4a6a8a";URL.revokeObjectURL(url);};';
    html += '      athenaAudio.onerror=function(){URL.revokeObjectURL(url);athenaBrowserSpeak(text);};';
    html += '      athenaAudio.play().catch(function(){athenaBrowserSpeak(text);});';
    html += '    })';
    html += '    .catch(function(e){';
    html += '      console.log("Athena ElevenLabs failed: "+e.message);';
    html += '      athenaBrowserSpeak(text);';
    html += '    });';
    html += '}';
    html += 'function athenaBrowserSpeak(text){';
    html += '  var utter=new SpeechSynthesisUtterance(text);utter.rate=1.0;utter.pitch=1.1;';
    html += '  var voices=synth.getVoices();for(var v=0;v<voices.length;v++){if(voices[v].name.includes("Samantha")||voices[v].name.includes("Google UK English Female")||voices[v].name.includes("Female")){utter.voice=voices[v];break;}}';
    html += '  utter.onend=function(){athenaSpeaking=false;stopAthenaWave();document.getElementById("athena-voice-status").textContent="CLICK MIC TO SPEAK";document.getElementById("athena-voice-status").style.color="#4a6a8a";};';
    html += '  synth.speak(utter);';
    html += '}';

    // Add message to Athena log
    html += 'function addAthenaMsg(who,text){';
    html += '  var log=document.getElementById("athena-voice-log");';
    html += '  var div=document.createElement("div");div.className="athena-msg "+who;';
    html += '  div.innerHTML="<div class=\\"sender\\">"+(who==="user"?"TRACE":"ATHENA")+"</div><div class=\\"text\\">"+text+"</div>";';
    html += '  log.appendChild(div);log.scrollTop=log.scrollHeight;';
    html += '}';

    // Email action functions
    html += 'async function deleteEmail(id,account){';
    html += '  if(!confirm("Delete this email?"))return;';
    html += '  try{var r=await fetch("/email/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:id,account:account})});';
    html += '  var d=await r.json();if(d.success){document.getElementById("email-"+id).style.display="none";}else{alert("Error: "+d.error);}}catch(e){alert("Failed: "+e.message);}';
    html += '}';

    html += 'async function archiveEmail(id,account){';
    html += '  try{var r=await fetch("/email/archive",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:id,account:account})});';
    html += '  var d=await r.json();if(d.success){document.getElementById("email-"+id).style.display="none";}else{alert("Error: "+d.error);}}catch(e){alert("Failed: "+e.message);}';
    html += '}';

    html += 'async function aiReply(id,account){';
    html += '  var replyDiv=document.getElementById("reply-"+id);replyDiv.style.display="block";';
    html += '  var textDiv=document.getElementById("reply-text-"+id);textDiv.textContent="Generating reply...";';
    html += '  try{var r=await fetch("/email/ai-reply",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:id,account:account})});';
    html += '  var d=await r.json();textDiv.contentEditable="true";textDiv.textContent=d.reply;textDiv.style.cursor="text";}catch(e){textDiv.textContent="Error: "+e.message;}';
    html += '}';

    html += 'async function sendReply(id,account){';
    html += '  var textDiv=document.getElementById("reply-text-"+id);var reply=textDiv.textContent;';
    html += '  var btn=document.getElementById("send-btn-"+id);btn.textContent="SENDING...";';
    html += '  try{var r=await fetch("/email/send-reply",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:id,account:account,reply:reply})});';
    html += '  var d=await r.json();if(d.success){btn.textContent="SENT";btn.style.color="#00ff66";document.getElementById("reply-"+id).style.display="none";document.getElementById("email-"+id).style.borderColor="#00ff6630";}else{btn.textContent="ERROR";}}catch(e){btn.textContent="FAILED";}';
    html += '}';

    html += '<\/script>';

    // Footer
    html += '<div class="footer">J.A.R.V.I.S. v3.0 // Built by Trace // Claude AI + Google Sheets + Gmail + Calendar + Twilio + ElevenLabs</div>';

    html += '</div>'; // close .content
    html += '</div>'; // close #jarvis-panel

    // ====== PANEL 2: ATHENA (Business) ======
    html += '<div class="panel" id="athena-panel" style="background:#020810;">';

    // Athena background (purple grid)
    html += '<div style="position:fixed;top:0;left:100vw;width:100vw;height:100%;pointer-events:none;z-index:0;">';
    html += '<div style="position:absolute;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(rgba(168,85,247,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(168,85,247,0.03) 1px,transparent 1px);background-size:60px 60px;"></div>';
    html += '</div>';

    html += '<div style="position:relative;z-index:4;">';

    // Athena Header
    html += '<div style="text-align:center;padding:60px 20px 20px;">';
    html += '<div style="font-family:Orbitron;font-size:3em;font-weight:900;letter-spacing:15px;background:linear-gradient(135deg,#a855f7,#7c3aed,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 30px rgba(168,85,247,0.4));">A.T.H.E.N.A.</div>';
    html += '<div style="font-family:Rajdhani;font-size:1.1em;letter-spacing:8px;color:#3a5a7a;margin-top:5px;text-transform:uppercase;">Autonomous Technician & Handling Engine for Network Administration</div>';
    html += '<div style="font-family:Rajdhani;font-size:0.95em;letter-spacing:4px;color:#a855f780;margin-top:3px;">' + dateStr + ' // ' + timeStr + '</div>';

    // Status bar
    html += '<div style="display:flex;justify-content:center;gap:20px;margin-top:15px;flex-wrap:wrap;">';
    html += '<div class="status-item"><div class="status-dot" style="background:#a855f7;box-shadow:0 0 10px #a855f7;"></div>CRM ONLINE</div>';
    html += '<div class="status-item"><div class="status-dot" style="background:#a855f7;box-shadow:0 0 10px #a855f7;"></div>' + totalLocations + ' LOCATIONS</div>';
    // Best tech count from all sources
    var dashTk = global.tookanData || {};
    var dashAllTechs = {};
    Object.keys(techPerf).forEach(function(t) { dashAllTechs[t.toLowerCase()] = true; });
    (dashTk.agents || []).forEach(function(a) { if (a.name) dashAllTechs[a.name.toLowerCase()] = true; });
    Object.keys(dashTk.tasksByTech || {}).forEach(function(t) { dashAllTechs[t.toLowerCase()] = true; });
    bizTechs.forEach(function(t) { if (t.name) dashAllTechs[t.name.toLowerCase()] = true; });
    var dashTechCount = Math.max(bizTechs.length, Object.keys(dashAllTechs).length);
    html += '<div class="status-item"><div class="status-dot" style="background:#00ff66;box-shadow:0 0 10px #00ff66;"></div>' + dashTechCount + ' TECHNICIANS</div>';
    html += '<div class="status-item"><div class="status-dot" style="background:' + (bizTodayBookings.length > 0 ? '#ff9f43' : '#00ff66') + ';box-shadow:0 0 10px ' + (bizTodayBookings.length > 0 ? '#ff9f43' : '#00ff66') + '"></div>' + bizTodayBookings.length + ' TODAY</div>';
    html += '<div class="status-item"><div class="status-dot" style="background:' + (bizReschedule.length > 0 ? '#ff9f43' : '#00ff66') + ';box-shadow:0 0 10px ' + (bizReschedule.length > 0 ? '#ff9f43' : '#00ff66') + '"></div>' + bizReschedule.length + ' RESCHEDULE</div>';
    html += '</div>';
    html += '</div>';

    // Athena Voice Chat Button
    html += '<div style="text-align:center;margin:20px 0;">';
    html += '<div class="holo-btn" onclick="toggleAthenaVoice()" id="athena-voice-btn" style="cursor:pointer;color:#a855f7;border-color:#a855f740;font-family:Orbitron;font-size:0.75em;letter-spacing:4px;padding:12px 30px;border:1px solid #a855f740;background:rgba(168,85,247,0.05);display:inline-block;transition:all 0.3s;">Talk to Athena</div>';
    html += '</div>';

    // Athena Voice Panel
    html += '<div id="athena-voice-panel" style="display:none;max-width:800px;margin:0 auto 30px;padding:0 40px;">';
    html += '<div style="background:rgba(10,12,25,0.9);border:1px solid #a855f730;padding:30px;position:relative;overflow:hidden;">';
    html += '<div style="position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,#a855f7,transparent);animation:borderScan 3s linear infinite;"></div>';

    // Status
    html += '<div style="text-align:center;margin-bottom:20px;">';
    html += '<div id="athena-voice-status" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;color:#4a6a8a;">CLICK MIC TO SPEAK</div>';
    html += '<div id="athena-waveform" style="height:40px;display:flex;align-items:center;justify-content:center;gap:3px;margin:15px 0;"></div>';
    html += '</div>';

    // Mic
    html += '<div style="text-align:center;margin-bottom:20px;">';
    html += '<div id="athena-mic-btn" onclick="toggleAthenaListening()" style="width:80px;height:80px;border-radius:50%;border:2px solid #a855f740;background:rgba(168,85,247,0.05);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s;position:relative;">';
    html += '<svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>';
    html += '<div id="athena-mic-pulse" style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;border:2px solid #a855f7;opacity:0;"></div>';
    html += '</div>';
    html += '</div>';

    // Text input for typing too
    html += '<div style="display:flex;gap:10px;margin-bottom:20px;">';
    html += '<input id="athena-text-input" type="text" placeholder="Or type your question..." style="flex:1;padding:12px 16px;background:rgba(10,20,35,0.8);border:1px solid #a855f730;color:#c0d8f0;font-family:Rajdhani;font-size:1em;outline:none;" onkeypress="if(event.key===\'Enter\')sendAthenaText()">';
    html += '<button onclick="sendAthenaText()" style="padding:12px 20px;background:rgba(168,85,247,0.15);border:1px solid #a855f750;color:#a855f7;font-family:Orbitron;font-size:0.7em;letter-spacing:3px;cursor:pointer;">SEND</button>';
    html += '</div>';

    // Conversation log
    html += '<div id="athena-voice-log" style="max-height:400px;overflow-y:auto;font-size:0.95em;"></div>';

    html += '</div></div>';

    // Athena voice CSS
    html += '<style>';
    html += '#athena-mic-btn:hover { background: rgba(168,85,247,0.15); border-color: #a855f7; box-shadow: 0 0 30px rgba(168,85,247,0.2); }';
    html += '#athena-mic-btn.listening { background: rgba(168,85,247,0.2); border-color: #a855f7; box-shadow: 0 0 40px rgba(168,85,247,0.3); }';
    html += '#athena-mic-btn.listening #athena-mic-pulse { animation: athenaPulse 1.5s ease-out infinite; }';
    html += '@keyframes athenaPulse { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.8); opacity: 0; } }';
    html += '.athena-msg { padding: 12px 0; border-bottom: 1px solid #0a1020; }';
    html += '.athena-msg .sender { font-family: Orbitron; font-size: 0.6em; letter-spacing: 3px; margin-bottom: 5px; }';
    html += '.athena-msg .text { color: #7a9ab0; line-height: 1.6; }';
    html += '.athena-msg.athena .sender { color: #a855f7; }';
    html += '.athena-msg.athena .text { color: #c0b8e0; }';
    html += '.athena-msg.user .sender { color: #00d4ff; }';
    html += '.athena-wave-bar { width: 3px; background: #a855f740; border-radius: 2px; transition: height 0.1s; }';
    html += '#athena-voice-btn:hover { background: rgba(168,85,247,0.15); border-color: #a855f7; box-shadow: 0 0 20px rgba(168,85,247,0.2); }';
    html += '</style>';

    // ====== ROW 1: Core Stats ======
    html += '<div class="grid">';
    html += '<div class="card" style="--accent:#a855f7;border-color:#a855f715;"><div class="label">Total Calls</div><div class="value">' + totalLeads + '</div><div class="sub">All calls received (deduplicated)</div><div class="bar"><div class="bar-fill" style="width:85%;background:#a855f7;"></div></div></div>';
    html += '<div class="card" style="--accent:#00ff66;border-color:#00ff6615;"><div class="label">Booked</div><div class="value">' + totalBooked + '</div><div class="sub">CRM status = Booked (may include serviced if not updated)</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, Math.round(totalBooked/Math.max(1,totalLeads)*100)) + '%;background:#00ff66;"></div></div></div>';
    html += '<div class="card" style="--accent:#00d4ff;border-color:#00d4ff15;"><div class="label">Completed</div><div class="value">' + totalCompleted + '</div><div class="sub">Tookan = Completed</div><div class="bar"><div class="bar-fill" style="width:' + (totalLeads > 0 ? Math.round(totalCompleted/totalLeads*100) : 0) + '%;background:#00d4ff;"></div></div></div>';
    var cancelRate = totalLeads > 0 ? Math.round(totalCancelled/totalLeads*100) : 0;
    html += '<div class="card" style="--accent:#ff4757;border-color:#ff475715;"><div class="label">Cancelled</div><div class="value">' + totalCancelled + '</div><div class="sub">' + cancelRate + '% cancel rate' + (cancelRate > 20 ? ' â€” HIGH' : '') + '</div><div class="bar"><div class="bar-fill" style="width:' + cancelRate + '%;background:#ff4757;"></div></div></div>';
    html += '</div>';

    // ====== ROW 2: Growth & Performance ======
    html += '<div class="grid">';
    html += '<div class="card" style="--accent:#ff9f43;border-color:#ff9f4315;"><div class="label">Calls This Month</div><div class="value">' + thisMonthCalls + '</div><div class="sub">' + (monthGrowth >= 0 ? '+' : '') + monthGrowth + '% vs last month (' + lastMonthCalls + ')</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, thisMonthCalls) + '%;background:#ff9f43;"></div></div></div>';
    html += '<div class="card" style="--accent:#55f7d8;border-color:#55f7d815;"><div class="label">This Week</div><div class="value">' + weeklyCalls + '</div><div class="sub">New bookings this week</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, weeklyCalls*10) + '%;background:#55f7d8;"></div></div></div>';
    html += '<div class="card" style="--accent:#c084fc;border-color:#c084fc15;"><div class="label">Conversion Rate</div><div class="value">' + conversionRate + '%</div><div class="sub">Lead â†’ Booked</div><div class="bar"><div class="bar-fill" style="width:' + conversionRate + '%;background:#c084fc;"></div></div></div>';
    html += '<div class="card" style="--accent:#ff6b9d;border-color:#ff6b9d15;"><div class="label">Avg Days to Service</div><div class="value">' + avgBookingDays + '</div><div class="sub">Booking â†’ Service date</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, avgBookingDays*5) + '%;background:#ff6b9d;"></div></div></div>';
    html += '</div>';

    // ====== ROW 3: Return / Promo / New Locs / Today ======
    html += '<div class="grid">';
    html += '<div class="card" style="--accent:#ff9f43;border-color:#ff9f4315;"><div class="label">Return Customers</div><div class="value">' + totalReturn + '</div><div class="sub">Lifetime value builders</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, totalReturn*3) + '%;background:#ff9f43;"></div></div></div>';
    html += '<div class="card" style="--accent:#55f7d8;border-color:#55f7d815;"><div class="label">Promo Replies</div><div class="value">' + promoReplies + '</div><div class="sub">Campaign responses</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, promoReplies) + '%;background:#55f7d8;"></div></div></div>';
    html += '<div class="card" style="--accent:#a855f7;border-color:#a855f715;"><div class="label">New Locations</div><div class="value">' + newLocsThisMonth + '</div><div class="sub">New markets this month</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, newLocsThisMonth*15) + '%;background:#a855f7;"></div></div></div>';
    html += '<div class="card" style="--accent:#00d4ff;border-color:#00d4ff15;"><div class="label">Today\'s Jobs</div><div class="value">' + bizTodayBookings.length + '</div><div class="sub">' + (bizTodayBookings.length > 0 ? 'Dispatch ready' : 'No jobs today') + '</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, bizTodayBookings.length*20) + '%;background:#00d4ff;"></div></div></div>';
    html += '</div>';

    // ====== EQUIPMENT BREAKDOWN ======
    var eqSorted = Object.entries(equipStats).sort(function(a,b){return b[1]-a[1];});
    if (eqSorted.length > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#c084fc;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#c084fc;border-radius:50%;box-shadow:0 0 8px #c084fc;display:inline-block;"></span>Equipment Breakdown â€” What You Fix Most</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:10px;">';
      var eqMax = eqSorted[0][1];
      eqSorted.slice(0, 8).forEach(function(e) {
        var pct = Math.round((e[1] / eqMax) * 100);
        html += '<div style="flex:1;min-width:140px;background:rgba(10,20,35,0.6);border:1px solid #c084fc15;padding:15px;">';
        html += '<div style="color:#c084fc;font-family:Orbitron;font-size:0.65em;letter-spacing:2px;">' + e[0] + '</div>';
        html += '<div style="color:#c0d8f0;font-size:1.8em;font-weight:700;margin:5px 0;">' + e[1] + '</div>';
        html += '<div style="height:3px;background:#0a1520;margin-top:8px;"><div style="height:100%;width:' + pct + '%;background:#c084fc;"></div></div>';
        html += '</div>';
      });
      html += '</div></div>';
    }

    // ====== TOP BRANDS ======
    var brSorted = Object.entries(brandStats).sort(function(a,b){return b[1]-a[1];});
    if (brSorted.length > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ff6b9d;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ff6b9d;border-radius:50%;box-shadow:0 0 8px #ff6b9d;display:inline-block;"></span>Top Brands Serviced</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
      brSorted.slice(0, 10).forEach(function(b) {
        html += '<div style="background:rgba(255,107,157,0.03);border:1px solid #ff6b9d20;padding:10px 16px;font-size:0.9em;">';
        html += '<span style="color:#ff6b9d;font-weight:600;">' + b[0] + '</span>';
        html += '<span style="color:#4a6a8a;margin-left:8px;">(' + b[1] + ')</span>';
        html += '</div>';
      });
      html += '</div></div>';
    }

    // ====== TECHNICIAN LEADERBOARD ======
    var techSorted = Object.entries(techPerf).sort(function(a,b){return b[1].total-a[1].total;});
    if (techSorted.length > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#00ff66;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#00ff66;border-radius:50%;box-shadow:0 0 8px #00ff66;display:inline-block;"></span>Technician Leaderboard</div>';
      techSorted.forEach(function(t, idx) {
        var completionRate = t[1].total > 0 ? Math.round((t[1].completed / t[1].total) * 100) : 0;
        var rankColor = idx === 0 ? '#ffd700' : idx === 1 ? '#c0c0c0' : idx === 2 ? '#cd7f32' : '#4a6a8a';
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #00ff6610;padding:14px 20px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;">';
        html += '<div style="display:flex;align-items:center;gap:12px;">';
        html += '<div style="color:' + rankColor + ';font-family:Orbitron;font-size:0.9em;font-weight:900;">#' + (idx+1) + '</div>';
        html += '<div style="color:#c0d8f0;font-weight:600;">' + t[0] + '</div>';
        html += '</div>';
        html += '<div style="display:flex;gap:20px;align-items:center;">';
        html += '<div style="text-align:center;"><div style="color:#a855f7;font-size:1.2em;font-weight:700;">' + t[1].total + '</div><div style="color:#4a6a8a;font-size:0.7em;font-family:Orbitron;letter-spacing:1px;">JOBS</div></div>';
        html += '<div style="text-align:center;"><div style="color:#00ff66;font-size:1.2em;font-weight:700;">' + t[1].completed + '</div><div style="color:#4a6a8a;font-size:0.7em;font-family:Orbitron;letter-spacing:1px;">DONE</div></div>';
        html += '<div style="text-align:center;"><div style="color:#ff4757;font-size:1.2em;font-weight:700;">' + t[1].cancelled + '</div><div style="color:#4a6a8a;font-size:0.7em;font-family:Orbitron;letter-spacing:1px;">CANCEL</div></div>';
        html += '<div style="text-align:center;"><div style="color:' + (completionRate >= 70 ? '#00ff66' : completionRate >= 40 ? '#ff9f43' : '#ff4757') + ';font-size:1.2em;font-weight:700;">' + completionRate + '%</div><div style="color:#4a6a8a;font-size:0.7em;font-family:Orbitron;letter-spacing:1px;">RATE</div></div>';
        html += '</div></div>';
      });
      html += '</div>';
    }

    // ====== MONTHLY TREND ======
    var monthKeys = Object.keys(monthlyCalls).sort();
    if (monthKeys.length > 1) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#55f7d8;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#55f7d8;border-radius:50%;box-shadow:0 0 8px #55f7d8;display:inline-block;"></span>Monthly Call Volume</div>';
      html += '<div style="display:flex;align-items:flex-end;gap:4px;height:120px;">';
      var maxMonth = Math.max.apply(null, monthKeys.map(function(k){return monthlyCalls[k];}));
      monthKeys.slice(-12).forEach(function(k) {
        var val = monthlyCalls[k];
        var h = maxMonth > 0 ? Math.round((val / maxMonth) * 100) : 0;
        var isThisMonth = k === (new Date().getFullYear() + '-' + String(new Date().getMonth()+1).padStart(2,'0'));
        html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;">';
        html += '<div style="color:#c0d8f0;font-size:0.7em;">' + val + '</div>';
        html += '<div style="width:100%;height:' + h + 'px;background:' + (isThisMonth ? '#55f7d8' : '#55f7d830') + ';min-height:2px;transition:all 0.3s;"></div>';
        html += '<div style="color:#4a6a8a;font-size:0.55em;font-family:Orbitron;">' + k.split('-')[1] + '/' + k.split('-')[0].substring(2) + '</div>';
        html += '</div>';
      });
      html += '</div></div>';
    }

    // ====== TODAY'S BOOKINGS ======
    if (bizTodayBookings.length > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#a855f7;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#a855f7;border-radius:50%;box-shadow:0 0 8px #a855f7;display:inline-block;"></span>Today\'s Dispatch</div>';
      bizTodayBookings.forEach(function(b) {
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #a855f710;padding:14px 18px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">';
        html += '<div style="color:#c0d8f0;font-weight:600;">' + escapeHtml(b.name) + '</div>';
        html += '<div style="color:#4a6a8a;">' + escapeHtml(b.location) + '</div>';
        html += '<div style="color:#c084fc;">' + escapeHtml(b.equip) + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.85em;max-width:300px;">' + escapeHtml(b.issue) + '</div>';
        html += '<div style="font-family:Orbitron;font-size:0.6em;letter-spacing:2px;padding:4px 10px;border:1px solid #00ff6640;color:#00ff66;">' + escapeHtml(b.tech || 'UNASSIGNED') + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // ====== NEEDS RESCHEDULING ======
    if (bizReschedule.length > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ff9f43;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ff9f43;border-radius:50%;box-shadow:0 0 8px #ff9f43;display:inline-block;"></span>Needs Rescheduling (' + bizReschedule.length + ')</div>';
      bizReschedule.slice(0, 15).forEach(function(r) {
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #ff9f4315;padding:12px 16px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;">';
        html += '<div style="color:#c0d8f0;">' + escapeHtml(r.name) + ' â€” ' + escapeHtml(r.location) + '</div>';
        html += '<div style="color:#4a6a8a;">' + escapeHtml(r.phone) + '</div>';
        html += '<div style="font-family:Orbitron;font-size:0.6em;letter-spacing:2px;padding:4px 10px;border:1px solid #ff9f4340;color:#ff9f43;">RESCHED</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // ====== LOCATION PERFORMANCE ======
    if (bizLocations.length > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#a855f7;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#a855f7;border-radius:50%;box-shadow:0 0 8px #a855f7;display:inline-block;"></span>Location Performance (' + bizLocations.length + ' markets)</div>';
      bizLocations.slice(0, 25).forEach(function(l) {
        var ls = l[1];
        var locCompRate = ls.total > 0 ? Math.round((ls.completed / ls.total) * 100) : 0;
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #a855f710;padding:14px 18px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">';
        html += '<div style="color:#a855f7;font-weight:600;min-width:200px;">' + escapeHtml(l[0]) + '</div>';
        html += '<div style="display:flex;gap:15px;">';
        html += '<div style="text-align:center;"><span style="color:#c0d8f0;font-weight:700;">' + ls.total + '</span> <span style="color:#4a6a8a;font-size:0.8em;">total</span></div>';
        html += '<div style="text-align:center;"><span style="color:#00ff66;font-weight:700;">' + ls.booked + '</span> <span style="color:#4a6a8a;font-size:0.8em;">booked</span></div>';
        html += '<div style="text-align:center;"><span style="color:#00d4ff;font-weight:700;">' + ls.completed + '</span> <span style="color:#4a6a8a;font-size:0.8em;">done</span></div>';
        html += '<div style="text-align:center;"><span style="color:#ff4757;font-weight:700;">' + ls.cancelled + '</span> <span style="color:#4a6a8a;font-size:0.8em;">cancel</span></div>';
        html += '<div style="text-align:center;"><span style="color:' + (locCompRate >= 50 ? '#00ff66' : '#ff9f43') + ';font-weight:700;">' + locCompRate + '%</span> <span style="color:#4a6a8a;font-size:0.8em;">rate</span></div>';
        html += '</div></div>';
      });
      html += '</div>';
    }

    // ====== RECENT ACTIVITY ======
    if (bizRecentBookings.length > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#00d4ff;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#00d4ff;border-radius:50%;box-shadow:0 0 8px #00d4ff;display:inline-block;"></span>Recent Activity</div>';
      bizRecentBookings.slice(-10).forEach(function(b) {
        var sColor = b.status.includes('booked') ? '#00ff66' : b.status.includes('return') ? '#ff9f43' : b.status.includes('cancel') ? '#ff4757' : '#4a6a8a';
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + sColor + '10;padding:12px 16px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">';
        html += '<div style="color:#c0d8f0;">' + escapeHtml(b.name) + '</div>';
        html += '<div style="color:#4a6a8a;">' + escapeHtml(b.location) + '</div>';
        html += '<div style="color:#c084fc;">' + escapeHtml(b.equip) + '</div>';
        html += '<div style="color:' + sColor + ';font-family:Orbitron;font-size:0.6em;letter-spacing:2px;padding:3px 8px;border:1px solid ' + sColor + '30;">' + escapeHtml(b.status.toUpperCase()) + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.8em;">' + escapeHtml(b.tech || '') + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // ====== SEASONAL DEMAND FORECAST ======
    var seasonKeys = Object.keys(seasonalData).sort();
    if (seasonKeys.length > 2) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ff9f43;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ff9f43;border-radius:50%;box-shadow:0 0 8px #ff9f43;display:inline-block;"></span>Seasonal Demand â€” Snow vs Mower vs Generator</div>';
      html += '<div style="display:flex;flex-direction:column;gap:4px;">';
      var monthNames = ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      seasonKeys.slice(-12).forEach(function(k) {
        var sd = seasonalData[k];
        var total = sd.snow + sd.mower + sd.generator + sd.other;
        if (total === 0) return;
        var snowPct = Math.round((sd.snow / total) * 100);
        var mowerPct = Math.round((sd.mower / total) * 100);
        var genPct = Math.round((sd.generator / total) * 100);
        var otherPct = 100 - snowPct - mowerPct - genPct;
        var mNum = parseInt(k.split("-")[1]);
        var yr = k.split("-")[0].substring(2);
        html += '<div style="display:flex;align-items:center;gap:10px;">';
        html += '<div style="width:60px;color:#4a6a8a;font-family:Orbitron;font-size:0.6em;letter-spacing:1px;">' + monthNames[mNum] + ' ' + yr + '</div>';
        html += '<div style="flex:1;height:24px;display:flex;overflow:hidden;">';
        if (snowPct > 0) html += '<div style="width:' + snowPct + '%;background:#00d4ff;display:flex;align-items:center;justify-content:center;font-size:0.6em;color:#020810;font-weight:700;">' + (snowPct > 10 ? sd.snow : '') + '</div>';
        if (mowerPct > 0) html += '<div style="width:' + mowerPct + '%;background:#00ff66;display:flex;align-items:center;justify-content:center;font-size:0.6em;color:#020810;font-weight:700;">' + (mowerPct > 10 ? sd.mower : '') + '</div>';
        if (genPct > 0) html += '<div style="width:' + genPct + '%;background:#ff9f43;display:flex;align-items:center;justify-content:center;font-size:0.6em;color:#020810;font-weight:700;">' + (genPct > 10 ? sd.generator : '') + '</div>';
        if (otherPct > 0) html += '<div style="width:' + otherPct + '%;background:#4a6a8a40;"></div>';
        html += '</div>';
        html += '<div style="width:30px;color:#4a6a8a;font-size:0.75em;text-align:right;">' + total + '</div>';
        html += '</div>';
      });
      html += '<div style="display:flex;gap:20px;margin-top:10px;font-size:0.75em;">';
      html += '<div style="display:flex;align-items:center;gap:5px;"><div style="width:12px;height:12px;background:#00d4ff;"></div><span style="color:#4a6a8a;">Snow Blower</span></div>';
      html += '<div style="display:flex;align-items:center;gap:5px;"><div style="width:12px;height:12px;background:#00ff66;"></div><span style="color:#4a6a8a;">Mower</span></div>';
      html += '<div style="display:flex;align-items:center;gap:5px;"><div style="width:12px;height:12px;background:#ff9f43;"></div><span style="color:#4a6a8a;">Generator</span></div>';
      html += '</div>';
      // SEO-powered prediction
      var currentMonth = today.getMonth() + 1;
      var prediction = '';
      if (currentMonth >= 11 || currentMonth <= 3) prediction = 'SNOW SEASON â€” Push snow blower marketing. Stock carb kits & belts.';
      else if (currentMonth >= 4 && currentMonth <= 6) prediction = 'MOWER SEASON STARTING â€” Ramp up mower techs. Blade sharpening demand incoming.';
      else if (currentMonth >= 7 && currentMonth <= 8) prediction = 'PEAK MOWER â€” All hands on deck. Generator prep for storm season.';
      else prediction = 'TRANSITION â€” Mower winding down, snow ramping up. Start seasonal marketing shift.';
      html += '<div style="margin-top:12px;padding:12px;border:1px solid #ff9f4320;background:rgba(255,159,67,0.03);color:#ff9f43;font-size:0.85em;">AI FORECAST: ' + prediction + '</div>';
      
      // SEO Search Volume Predictions
      var seoNational = getSeoNationalTotals();
      var seasonSvc = (currentMonth >= 11 || currentMonth <= 3) ? 'snow_blower_repair' : (currentMonth >= 4 && currentMonth <= 9) ? 'lawn_mower_repair' : 'generator_repair';
      var topMkts = getSeoTopMarkets(seasonSvc, 10);
      var seasonLabel = seasonSvc.replace(/_/g, ' ').replace(/\b\w/g, function(c){return c.toUpperCase();});
      html += '<div style="margin-top:12px;padding:12px;border:1px solid #00d4ff20;background:rgba(0,212,255,0.02);">';
      html += '<div style="color:#00d4ff;font-family:Orbitron;font-size:0.65em;letter-spacing:3px;margin-bottom:8px;">ðŸ” SEO SEARCH DATA â€” TOP MARKETS FOR ' + seasonLabel.toUpperCase() + '</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
      topMkts.forEach(function(m) {
        var kdColor = m.kd < 0.2 ? '#00ff66' : m.kd < 0.4 ? '#ff9f43' : '#ff4757';
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #00d4ff10;padding:8px 12px;min-width:140px;">';
        html += '<div style="color:#c0d8f0;font-size:0.9em;">' + m.city + ', ' + m.state + '</div>';
        html += '<div style="display:flex;gap:8px;margin-top:3px;font-size:0.8em;">';
        html += '<span style="color:#00d4ff;">Vol: ' + m.vol + '</span>';
        html += '<span style="color:' + kdColor + ';">KD: ' + Math.round(m.kd * 100) + '%</span>';
        if (m.pop) html += '<span style="color:#4a6a8a;">Pop: ' + (m.pop > 999999 ? (m.pop/1000000).toFixed(1) + 'M' : m.pop > 999 ? Math.round(m.pop/1000) + 'K' : m.pop) + '</span>';
        html += '</div></div>';
      });
      html += '</div>';
      html += '<div style="margin-top:8px;color:#4a6a8a;font-size:0.75em;">National total search volume for ' + seasonLabel + ': <span style="color:#00d4ff;font-weight:700;">' + seoNational.totals[seasonSvc].totalVol.toLocaleString() + '/mo</span> across <span style="color:#00d4ff;">' + seoNational.totals[seasonSvc].cities + ' cities</span> Â· Avg KD: <span style="color:' + (seoNational.totals[seasonSvc].avgKd < 0.2 ? '#00ff66' : '#ff9f43') + ';">' + Math.round(seoNational.totals[seasonSvc].avgKd * 100) + '%</span></div>';
      html += '</div>';
      html += '</div>';
    }

    // ====== BUSINESS OPERATIONS DATA (SOPs, SEO, Stats) ======
    var opsData = global.bizOpsData || {};
    var opsSections = Object.entries(opsData);
    if (opsSections.length > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ff9f43;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ff9f43;border-radius:50%;box-shadow:0 0 8px #ff9f43;display:inline-block;"></span>Business Operations Data</div>';
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;">';
      
      var opsColors = ['#ff9f43','#55f7d8','#c084fc','#00d4ff','#ffd700','#ff6b9d','#00ff66','#a855f7'];
      opsSections.forEach(function(sec, idx) {
        var color = opsColors[idx % opsColors.length];
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + color + '20;padding:15px;max-height:300px;overflow-y:auto;">';
        html += '<div style="font-family:Orbitron;font-size:0.65em;letter-spacing:2px;color:' + color + ';margin-bottom:8px;">' + sec[0] + ' <span style="color:#4a6a8a;">(' + sec[1].length + ' rows)</span></div>';
        var showRows = Math.min(sec[1].length, 10);
        for (var oi = 0; oi < showRows; oi++) {
          html += '<div style="color:#c0d8f0;font-size:0.8em;padding:3px 0;border-bottom:1px solid #0a1520;">' + sec[1][oi] + '</div>';
        }
        if (sec[1].length > 10) html += '<div style="color:#4a6a8a;font-size:0.75em;margin-top:5px;">+ ' + (sec[1].length - 10) + ' more rows</div>';
        html += '</div>';
      });
      
      html += '</div></div>';
    }

    // ====== INTERACTIVE TECHNICAL ANALYSIS CHART ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#00d4ff;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#00d4ff;border-radius:50%;box-shadow:0 0 8px #00d4ff;display:inline-block;"></span>Call Volume Technical Analysis</div>';

    // Build monthly volume data
    var volMonths = Object.keys(monthlyCalls).sort();
    var volData = volMonths.map(function(k) { return monthlyCalls[k] || 0; });

    // ====== SERVER-SIDE INDICATOR COMPUTATION ======
    function calcSMA(data, period) {
      var result = [];
      for (var i = 0; i < data.length; i++) {
        if (i < period - 1) { result.push(null); continue; }
        var sum = 0; for (var j = i - period + 1; j <= i; j++) sum += data[j];
        result.push(Math.round((sum / period) * 10) / 10);
      }
      return result;
    }
    function calcEMA(data, period) {
      var result = []; var k = 2 / (period + 1);
      for (var i = 0; i < data.length; i++) {
        if (i === 0) { result.push(data[0]); continue; }
        var prev = result[i - 1] !== null ? result[i - 1] : data[i];
        result.push(Math.round((data[i] * k + prev * (1 - k)) * 10) / 10);
      }
      return result;
    }

    // Bollinger Bands
    var bbPeriod = Math.max(2, Math.min(6, Math.floor(volData.length / 2)));
    var bbUpper = [], bbMiddle = [], bbLower = [], bbWidth = [];
    for (var bbi = 0; bbi < volData.length; bbi++) {
      if (bbi < bbPeriod - 1) { bbUpper.push(null); bbMiddle.push(null); bbLower.push(null); bbWidth.push(null); continue; }
      var sl = volData.slice(bbi - bbPeriod + 1, bbi + 1);
      var avg = sl.reduce(function(a, b) { return a + b; }, 0) / bbPeriod;
      var vr = sl.reduce(function(a, b) { return a + (b - avg) * (b - avg); }, 0) / bbPeriod;
      var std = Math.sqrt(vr);
      bbUpper.push(Math.round(avg + 2 * std)); bbMiddle.push(Math.round(avg)); bbLower.push(Math.round(Math.max(0, avg - 2 * std)));
      bbWidth.push(avg > 0 ? Math.round((4 * std / avg) * 1000) / 10 : 0);
    }
    var bbSqueeze = false, bbSqueezeMsg = '';
    var recentW = bbWidth.filter(function(w) { return w !== null; });
    if (recentW.length >= 3) {
      var lastW = recentW[recentW.length - 1];
      var avgW = recentW.reduce(function(a, b) { return a + b; }, 0) / recentW.length;
      if (lastW < avgW * 0.7) { bbSqueeze = true; bbSqueezeMsg = 'Bands at ' + lastW + '% width (avg: ' + Math.round(avgW) + '%). Expect volatility breakout.'; }
    }

    // Keltner Channels (EMA + ATR * 1.5)
    var kcEMA = calcEMA(volData, bbPeriod);
    var kcUpper = [], kcLower = [], atrData = [];
    for (var ki = 0; ki < volData.length; ki++) {
      if (ki < bbPeriod - 1) { kcUpper.push(null); kcLower.push(null); atrData.push(null); continue; }
      // ATR = average of true ranges (for monthly data: abs difference between consecutive months)
      var trSum = 0, trCount = 0;
      for (var kj = ki - bbPeriod + 1; kj <= ki; kj++) {
        if (kj > 0) { trSum += Math.abs(volData[kj] - volData[kj - 1]); trCount++; }
      }
      var atr = trCount > 0 ? trSum / trCount : 0;
      atrData.push(Math.round(atr * 10) / 10);
      var kcMid = kcEMA[ki] || 0;
      kcUpper.push(Math.round(kcMid + 1.5 * atr));
      kcLower.push(Math.round(Math.max(0, kcMid - 1.5 * atr)));
    }

    // TTM Squeeze: BB inside KC = squeeze ON (red dot), BB outside KC = squeeze OFF (green dot)
    var squeezeDots = []; // { time, value: 0, color: red/green }
    var squeezeOn = false, squeezeCount = 0;
    for (var si = 0; si < volData.length; si++) {
      if (bbUpper[si] === null || kcUpper[si] === null) { squeezeDots.push(null); continue; }
      var isSqueezeOn = bbUpper[si] < kcUpper[si] && bbLower[si] > kcLower[si];
      squeezeDots.push({ on: isSqueezeOn });
      if (isSqueezeOn) squeezeCount++;
    }
    // Check if currently in squeeze
    var lastSqueeze = squeezeDots.filter(function(d) { return d !== null; });
    var currentSqueezeOn = lastSqueeze.length > 0 && lastSqueeze[lastSqueeze.length - 1].on;
    if (currentSqueezeOn) {
      bbSqueeze = true;
      var consecSqueeze = 0;
      for (var cs = lastSqueeze.length - 1; cs >= 0; cs--) {
        if (lastSqueeze[cs].on) consecSqueeze++; else break;
      }
      bbSqueezeMsg = 'TTM SQUEEZE ACTIVE â€” ' + consecSqueeze + ' consecutive months. BB inside Keltner Channels. Breakout imminent when squeeze fires.';
    }

    // Squeeze Momentum: Linear regression of (close - midline of KC/BB)
    var sqzMomentum = [];
    for (var smi = 0; smi < volData.length; smi++) {
      if (bbMiddle[smi] === null || kcEMA[smi] === null) { sqzMomentum.push(null); continue; }
      var midline = (bbMiddle[smi] + kcEMA[smi]) / 2;
      var mom = volData[smi] - midline;
      sqzMomentum.push(Math.round(mom * 10) / 10);
    }
    // Determine momentum direction for coloring (rising = aqua, falling = red)
    var sqzMomColors = [];
    for (var mc2 = 0; mc2 < sqzMomentum.length; mc2++) {
      if (sqzMomentum[mc2] === null) { sqzMomColors.push(null); continue; }
      var prev = mc2 > 0 ? sqzMomentum[mc2 - 1] : 0;
      if (prev === null) prev = 0;
      var val = sqzMomentum[mc2];
      // 4-color system: dark/light cyan for positive, dark/light red for negative
      if (val >= 0 && val >= prev) sqzMomColors.push('#00d4ff');       // positive rising = bright cyan
      else if (val >= 0 && val < prev) sqzMomColors.push('#00d4ff80'); // positive falling = dim cyan
      else if (val < 0 && val <= prev) sqzMomColors.push('#ff4757');   // negative falling = bright red
      else sqzMomColors.push('#ff475780');                              // negative rising = dim red
    }

    var sma3 = calcSMA(volData, Math.min(3, volData.length));
    var sma6 = calcSMA(volData, Math.min(6, volData.length));

    // RSI
    var rsiPeriod = Math.min(6, volData.length - 1);
    var rsiData = [];
    for (var ri = 0; ri < volData.length; ri++) {
      if (ri < rsiPeriod) { rsiData.push(null); continue; }
      var gains = 0, losses = 0;
      for (var rj = ri - rsiPeriod + 1; rj <= ri; rj++) { var diff = volData[rj] - volData[rj - 1]; if (diff > 0) gains += diff; else losses -= diff; }
      var avgG = gains / rsiPeriod, avgL = losses / rsiPeriod;
      rsiData.push(avgL === 0 ? 100 : Math.round(100 - (100 / (1 + avgG / avgL))));
    }

    // MACD
    var emaF = calcEMA(volData, Math.min(3, volData.length));
    var emaS = calcEMA(volData, Math.min(6, volData.length));
    var macdLine = []; for (var mi2 = 0; mi2 < volData.length; mi2++) { macdLine.push(Math.round((emaF[mi2] - emaS[mi2]) * 10) / 10); }
    var macdNN = macdLine.filter(function(v) { return v !== null; });
    var macdSig = calcEMA(macdNN, Math.min(3, macdNN.length));
    var macdHist = []; for (var mh2 = 0; mh2 < volData.length; mh2++) { macdHist.push(Math.round((macdLine[mh2] - (macdSig[mh2] || 0)) * 10) / 10); }

    // Fibonacci levels
    var recentVol = volData.slice(-6);
    var fibHigh = Math.max.apply(null, recentVol.length > 0 ? recentVol : [0]);
    var fibLow = Math.min.apply(null, recentVol.length > 0 ? recentVol : [0]);
    var fibRange = fibHigh - fibLow;
    var fibLevels = { '0%': fibLow, '23.6%': Math.round(fibLow + fibRange * 0.236), '38.2%': Math.round(fibLow + fibRange * 0.382), '50%': Math.round(fibLow + fibRange * 0.5), '61.8%': Math.round(fibLow + fibRange * 0.618), '78.6%': Math.round(fibLow + fibRange * 0.786), '100%': fibHigh };

    // Trend + predictions
    var last3Avg = 0, prior3Avg = 0;
    if (recentVol.length >= 6) { last3Avg = (recentVol[3] + recentVol[4] + recentVol[5]) / 3; prior3Avg = (recentVol[0] + recentVol[1] + recentVol[2]) / 3; }
    else if (recentVol.length >= 2) { last3Avg = recentVol[recentVol.length - 1]; prior3Avg = recentVol[0]; }
    var trendUp = last3Avg >= prior3Avg;
    var trendPct = prior3Avg > 0 ? Math.round(((last3Avg - prior3Avg) / prior3Avg) * 100) : 0;
    var predictions = [], predMonths = [];
    var nowMonth = today.getMonth() + 1, nowYear = today.getFullYear();
    for (var fp = 1; fp <= 3; fp++) { var pm = nowMonth + fp, py = nowYear; if (pm > 12) { pm -= 12; py++; } predMonths.push(py + '-' + String(pm).padStart(2, '0') + '-01'); if (trendUp) predictions.push(Math.round(Math.max(fibHigh + fibRange * 0.618 * (1 - fp * 0.15), fibLow))); else predictions.push(Math.round(Math.max(fibHigh - fibRange * 0.618 * (1 - fp * 0.15), 0))); }

    // Serialize for client
    var lcMain = JSON.stringify(volMonths.map(function(k, i) { return { time: k + '-01', value: volData[i] }; }));
    var lcBBU = JSON.stringify(volMonths.map(function(k, i) { return bbUpper[i] !== null ? { time: k + '-01', value: bbUpper[i] } : null; }).filter(Boolean));
    var lcBBM = JSON.stringify(volMonths.map(function(k, i) { return bbMiddle[i] !== null ? { time: k + '-01', value: bbMiddle[i] } : null; }).filter(Boolean));
    var lcBBL = JSON.stringify(volMonths.map(function(k, i) { return bbLower[i] !== null ? { time: k + '-01', value: bbLower[i] } : null; }).filter(Boolean));
    var lcS3 = JSON.stringify(volMonths.map(function(k, i) { return sma3[i] !== null ? { time: k + '-01', value: sma3[i] } : null; }).filter(Boolean));
    var lcS6 = JSON.stringify(volMonths.map(function(k, i) { return sma6[i] !== null ? { time: k + '-01', value: sma6[i] } : null; }).filter(Boolean));
    var lcRSI = JSON.stringify(volMonths.map(function(k, i) { return rsiData[i] !== null ? { time: k + '-01', value: rsiData[i] } : null; }).filter(Boolean));
    var lcMACD = JSON.stringify(volMonths.map(function(k, i) { return { time: k + '-01', value: macdLine[i] }; }));
    var lcMSig = JSON.stringify(volMonths.map(function(k, i) { return { time: k + '-01', value: macdSig[i] || 0 }; }));
    var lcMHist = JSON.stringify(volMonths.map(function(k, i) { return { time: k + '-01', value: macdHist[i], color: macdHist[i] >= 0 ? 'rgba(0,255,102,0.5)' : 'rgba(255,71,87,0.5)' }; }));
    var lcPred = JSON.stringify(predMonths.map(function(k, i) { return { time: k, value: predictions[i] }; }));
    var lcVol = JSON.stringify(volMonths.map(function(k, i) { return { time: k + '-01', value: volData[i], color: i === volData.length - 1 ? 'rgba(0,212,255,0.6)' : 'rgba(0,212,255,0.2)' }; }));

    // KC + Squeeze serialized
    var lcKCU = JSON.stringify(volMonths.map(function(k, i) { return kcUpper[i] !== null ? { time: k + '-01', value: kcUpper[i] } : null; }).filter(Boolean));
    var lcKCL = JSON.stringify(volMonths.map(function(k, i) { return kcLower[i] !== null ? { time: k + '-01', value: kcLower[i] } : null; }).filter(Boolean));
    var lcSqzDots = JSON.stringify(volMonths.map(function(k, i) { return squeezeDots[i] !== null ? { time: k + '-01', value: 0, color: squeezeDots[i].on ? '#ff4757' : '#00ff66' } : null; }).filter(Boolean));
    var lcSqzMom = JSON.stringify(volMonths.map(function(k, i) { return sqzMomentum[i] !== null ? { time: k + '-01', value: sqzMomentum[i], color: sqzMomColors[i] } : null; }).filter(Boolean));

    // ====== TOOLBAR ======
    html += '<div style="background:rgba(10,20,35,0.9);border:1px solid #1a2a3a;">';
    html += '<div style="display:flex;align-items:center;gap:0;border-bottom:1px solid #1a2a3a;flex-wrap:wrap;">';
    // Indicators
    html += '<div style="padding:8px 12px;font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:#4a6a8a;">INDICATORS</div>';
    [['bb','Bollinger','#a855f7',true],['kc','Keltner','#ff6b9d',false],['sma3','SMA 3','#ffd700',false],['sma6','SMA 6','#ff9f43',false],['fib','Fibonacci','#00ff66',true],['pred','Forecast','#ff9f43',true]].forEach(function(ind) {
      html += '<div id="btn-' + ind[0] + '" onclick="toggleInd(\'' + ind[0] + '\')" style="cursor:pointer;padding:6px 10px;font-size:0.7em;color:' + (ind[3] ? ind[2] : '#4a6a8a') + ';border-bottom:2px solid ' + (ind[3] ? ind[2] : 'transparent') + ';" data-on="' + ind[3] + '" data-c="' + ind[2] + '">' + ind[1] + '</div>';
    });
    // Panels
    html += '<div style="margin-left:auto;display:flex;align-items:center;gap:0;">';
    html += '<div style="padding:8px 12px;font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:#4a6a8a;">PANELS</div>';
    html += '<div id="btn-rsi" onclick="togglePnl(\'rsi\')" style="cursor:pointer;padding:6px 10px;font-size:0.7em;color:#00d4ff;border-bottom:2px solid #00d4ff;">RSI</div>';
    html += '<div id="btn-macd" onclick="togglePnl(\'macd\')" style="cursor:pointer;padding:6px 10px;font-size:0.7em;color:#4a6a8a;border-bottom:2px solid transparent;">MACD</div>';
    html += '<div id="btn-squeeze" onclick="togglePnl(\'squeeze\')" style="cursor:pointer;padding:6px 10px;font-size:0.7em;color:' + (currentSqueezeOn ? '#ff4757' : '#4a6a8a') + ';border-bottom:2px solid ' + (currentSqueezeOn ? '#ff4757' : 'transparent') + ';">' + (currentSqueezeOn ? 'ðŸ”´ SQUEEZE' : 'Squeeze') + '</div>';
    html += '</div>';
    // Drawing tools
    html += '<div style="display:flex;align-items:center;gap:0;border-left:1px solid #1a2a3a;">';
    html += '<div style="padding:8px 12px;font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:#4a6a8a;">DRAW</div>';
    html += '<div id="btn-trendline" onclick="setDraw(\'trendline\')" style="cursor:pointer;padding:6px 10px;font-size:0.7em;color:#4a6a8a;">ðŸ“ Line</div>';
    html += '<div id="btn-hline" onclick="setDraw(\'hline\')" style="cursor:pointer;padding:6px 10px;font-size:0.7em;color:#4a6a8a;">âž– H-Line</div>';
    html += '<div id="btn-rect" onclick="setDraw(\'rect\')" style="cursor:pointer;padding:6px 10px;font-size:0.7em;color:#4a6a8a;">â–­ Zone</div>';
    html += '<div onclick="clearDraw()" style="cursor:pointer;padding:6px 10px;font-size:0.7em;color:#ff4757;">âœ• Clear</div>';
    html += '</div></div>';

    // Chart containers
    html += '<div style="position:relative;"><div id="main-chart" style="width:100%;height:400px;"></div>';
    html += '<canvas id="draw-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;"></canvas></div>';
    html += '<div id="rsi-panel" style="border-top:1px solid #1a2a3a;"><div id="rsi-chart" style="width:100%;height:120px;"></div></div>';
    html += '<div id="macd-panel" style="border-top:1px solid #1a2a3a;display:none;"><div id="macd-chart" style="width:100%;height:120px;"></div></div>';
    html += '<div id="squeeze-panel" style="border-top:1px solid #1a2a3a;display:' + (currentSqueezeOn ? 'block' : 'none') + ';">';
    html += '<div style="display:flex;align-items:center;padding:4px 10px;background:rgba(10,20,35,0.8);gap:8px;">';
    html += '<span style="font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:#4a6a8a;">TTM SQUEEZE</span>';
    html += '<span style="font-size:0.65em;color:#ff4757;">â— = Squeeze ON (BB inside KC)</span>';
    html += '<span style="font-size:0.65em;color:#00ff66;">â— = Squeeze OFF (fired)</span>';
    html += '</div>';
    html += '<div id="squeeze-chart" style="width:100%;height:140px;"></div></div>';

    // Squeeze alert
    if (bbSqueeze) {
      html += '<div style="padding:10px 15px;background:rgba(168,85,247,0.1);border-top:1px solid #a855f740;display:flex;align-items:center;gap:10px;">';
      html += '<span style="font-size:1.2em;">ðŸ”®</span><div><span style="font-family:Orbitron;font-size:0.6em;letter-spacing:2px;color:#a855f7;">BOLLINGER SQUEEZE ALERT</span>';
      html += '<div style="color:#c0d8f0;font-size:0.85em;margin-top:2px;">' + bbSqueezeMsg + '</div></div></div>';
    }
    html += '</div>'; // end chart border

    // ====== ANALYSIS BOX ======
    html += '<div style="margin-top:15px;padding:15px;border:1px solid #00d4ff20;background:rgba(0,212,255,0.02);">';
    html += '<div style="font-family:Orbitron;font-size:0.65em;letter-spacing:3px;color:#00d4ff;margin-bottom:10px;">TECHNICAL ANALYSIS</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;">';
    var trendIcon = trendUp ? 'â–²' : 'â–¼', trendColor = trendUp ? '#00ff66' : '#ff4757';
    html += '<div style="background:rgba(10,20,35,0.5);padding:12px;"><div style="color:#4a6a8a;font-size:0.75em;">TREND</div><div style="color:' + trendColor + ';font-size:1.2em;font-weight:900;">' + trendIcon + ' ' + (trendUp ? 'UP' : 'DOWN') + '</div><div style="color:#4a6a8a;font-size:0.8em;">' + (trendPct >= 0 ? '+' : '') + trendPct + '%</div></div>';
    html += '<div style="background:rgba(10,20,35,0.5);padding:12px;"><div style="color:#4a6a8a;font-size:0.75em;">SUPPORT 38.2%</div><div style="color:#00ff66;font-size:1.2em;font-weight:900;">' + fibLevels['38.2%'] + '</div></div>';
    html += '<div style="background:rgba(10,20,35,0.5);padding:12px;"><div style="color:#4a6a8a;font-size:0.75em;">RESIST 61.8%</div><div style="color:#ff9f43;font-size:1.2em;font-weight:900;">' + fibLevels['61.8%'] + '</div></div>';
    html += '<div style="background:rgba(10,20,35,0.5);padding:12px;"><div style="color:#4a6a8a;font-size:0.75em;">PREDICT</div><div style="color:#ff9f43;font-size:1.2em;font-weight:900;">~' + predictions[0] + '</div></div>';
    var lastRSI = rsiData.filter(function(r) { return r !== null; }); var rsiVal = lastRSI.length > 0 ? lastRSI[lastRSI.length - 1] : 50;
    var rsiColor = rsiVal > 70 ? '#ff4757' : rsiVal < 30 ? '#00ff66' : '#c0d8f0';
    html += '<div style="background:rgba(10,20,35,0.5);padding:12px;"><div style="color:#4a6a8a;font-size:0.75em;">RSI</div><div style="color:' + rsiColor + ';font-size:1.2em;font-weight:900;">' + rsiVal + '</div><div style="color:#4a6a8a;font-size:0.8em;">' + (rsiVal > 70 ? 'OVERBOUGHT' : rsiVal < 30 ? 'OVERSOLD' : 'NEUTRAL') + '</div></div>';
    var bbwVal = recentW.length > 0 ? recentW[recentW.length - 1] : 0;
    html += '<div style="background:rgba(10,20,35,0.5);padding:12px;"><div style="color:#4a6a8a;font-size:0.75em;">BB WIDTH</div><div style="color:' + (bbSqueeze ? '#a855f7' : '#c0d8f0') + ';font-size:1.2em;font-weight:900;">' + bbwVal + '%</div><div style="color:#4a6a8a;font-size:0.8em;">' + (bbSqueeze ? 'SQUEEZE' : 'NORMAL') + '</div></div>';
    // TTM Squeeze
    var sqzStatus = currentSqueezeOn ? 'ACTIVE' : 'OFF';
    var sqzColor = currentSqueezeOn ? '#ff4757' : '#00ff66';
    var lastMom = sqzMomentum.filter(function(m) { return m !== null; }); var momVal = lastMom.length > 0 ? lastMom[lastMom.length - 1] : 0;
    var momDir = momVal > 0 ? 'â–² BULLISH' : 'â–¼ BEARISH';
    html += '<div style="background:rgba(10,20,35,0.5);padding:12px;"><div style="color:#4a6a8a;font-size:0.75em;">TTM SQUEEZE</div><div style="color:' + sqzColor + ';font-size:1.2em;font-weight:900;">' + (currentSqueezeOn ? 'ðŸ”´' : 'ðŸŸ¢') + ' ' + sqzStatus + '</div><div style="color:#4a6a8a;font-size:0.8em;">Mom: ' + momDir + '</div></div>';
    html += '</div>';

    // Strategy
    var supportLevel = fibLevels['38.2%'], resistLevel = fibLevels['61.8%'];
    var fibStrategy = '';
    if (trendUp && trendPct > 20) fibStrategy = 'STRONG GROWTH â€” Breaking resistance. Scale NOW. Target: ' + Math.round(fibHigh * 1.3) + '/mo.';
    else if (trendUp) fibStrategy = 'MODERATE GROWTH â€” Below resistance. Keep standby techs. Watch for breakout above ' + resistLevel + '.';
    else if (trendPct > -15) fibStrategy = 'CONSOLIDATION â€” Between support/resistance. Focus on conversion.';
    else fibStrategy = 'PULLBACK â€” Retracing toward ' + supportLevel + ' support. Reduce ad spend, rebook cancelled.';
    if (bbSqueeze) fibStrategy += ' âš¡ SQUEEZE: Breakout imminent.';
    html += '<div style="margin-top:12px;padding:12px;border:1px solid #00d4ff20;background:rgba(0,212,255,0.03);color:#00d4ff;font-size:0.85em;">STRATEGY: ' + fibStrategy + '</div>';

    // ====== PER-LOCATION DROPDOWN ======
    var callsByTab = bm.monthlyCallsByCity || {};
    var tabNamesArr = Object.keys(callsByTab).sort();
    var fibTabs = tabNamesArr.filter(function(t) { return Object.keys(callsByTab[t]).length >= 3; });
    if (fibTabs.length > 0) {
      html += '<div style="margin-top:15px;border-top:1px solid #00d4ff15;padding-top:15px;">';
      html += '<div onclick="var el=document.getElementById(\'fib-locations\');el.style.display=el.style.display===\'none\'?\'block\':\'none\';this.querySelector(\'.arrow\').textContent=el.style.display===\'none\'?\'â–¶\':\'â–¼\';" style="cursor:pointer;display:flex;align-items:center;gap:10px;padding:8px 0;">';
      html += '<span class="arrow" style="font-family:Orbitron;font-size:0.8em;color:#a855f7;">â–¶</span>';
      html += '<span style="font-family:Orbitron;font-size:0.65em;letter-spacing:3px;color:#a855f7;">FIBONACCI BY LOCATION (' + fibTabs.length + ' MARKETS)</span></div>';
      html += '<div id="fib-locations" style="display:none;">';
      fibTabs.forEach(function(tabName, tabIdx) {
        var td = callsByTab[tabName], tm = Object.keys(td).sort(), tv = tm.map(function(k) { return td[k] || 0; });
        var tl = tm.map(function(k) { var p = k.split('-'); return ['','J','F','M','A','M','J','J','A','S','O','N','D'][parseInt(p[1])] + "'" + p[0].substring(2); });
        var lr = tv.slice(-6), lH = Math.max.apply(null, lr.length > 0 ? lr : [0]), lL = Math.min.apply(null, lr.length > 0 ? lr : [0]), lR = lH - lL;
        var lT = tv.reduce(function(a, b) { return a + b; }, 0);
        var l3 = 0, p3 = 0; if (lr.length >= 6) { l3 = (lr[3]+lr[4]+lr[5])/3; p3 = (lr[0]+lr[1]+lr[2])/3; } else if (lr.length >= 2) { l3 = lr[lr.length-1]; p3 = lr[0]; }
        var lU = l3 >= p3, lP = p3 > 0 ? Math.round(((l3-p3)/p3)*100) : 0;
        var lPr = lU ? Math.round(lH + lR * 0.618 * 0.85) : Math.round(Math.max(lH - lR * 0.618 * 0.85, 0));
        var lS = Math.round(lL + lR * 0.382), lRe = Math.round(lL + lR * 0.618);
        var lC = lU ? '#00ff66' : '#ff4757', lI = lU ? 'â–²' : 'â–¼', eId = 'fib-loc-' + tabIdx;
        html += '<div style="border:1px solid #1a2a3a;margin-bottom:2px;">';
        html += '<div onclick="var el=document.getElementById(\'' + eId + '\');el.style.display=el.style.display===\'none\'?\'block\':\'none\';this.querySelector(\'.arr\').textContent=el.style.display===\'none\'?\'â–¶\':\'â–¼\';" style="cursor:pointer;display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(10,20,35,0.6);">';
        html += '<span class="arr" style="color:#4a6a8a;font-size:0.8em;">â–¶</span>';
        html += '<span style="flex:1;font-family:Orbitron;font-size:0.6em;letter-spacing:2px;color:#c0d8f0;">' + tabName + '</span>';
        html += '<span style="color:' + lC + ';font-family:Orbitron;font-size:0.65em;">' + lI + ' ' + (lP >= 0 ? '+' : '') + lP + '%</span>';
        html += '<span style="color:#4a6a8a;font-size:0.8em;">' + lT + '</span>';
        html += '<span style="color:#ff9f43;font-family:Orbitron;font-size:0.6em;">â†’~' + lPr + '</span></div>';
        html += '<div id="' + eId + '" style="display:none;padding:14px;background:rgba(5,10,20,0.4);">';
        var cm = tv.slice(-10), cl = tl.slice(-10), cx = Math.max.apply(null, cm.length > 0 ? cm : [1]);
        html += '<div style="display:flex;align-items:flex-end;gap:3px;height:70px;margin-bottom:12px;">';
        cm.forEach(function(v, i) { var bH = cx > 0 ? Math.max(3, Math.round((v/cx)*100)) : 3; html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;"><div style="color:' + (i===cm.length-1?'#c0d8f0':'#4a6a8a') + ';font-size:0.6em;">' + v + '</div><div style="width:100%;height:' + bH + '%;background:' + (i===cm.length-1?'#a855f7':'#a855f730') + ';min-height:2px;"></div><div style="color:#4a6a8a;font-size:0.45em;font-family:Orbitron;">' + (cl[i]||'') + '</div></div>'; });
        var pH = cx > 0 ? Math.min(100, Math.max(3, Math.round((lPr/cx)*100))) : 3;
        html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;"><div style="color:#ff9f43;font-size:0.6em;">~' + lPr + '</div><div style="width:100%;height:' + pH + '%;background:repeating-linear-gradient(0deg,#ff9f43 0px,#ff9f43 3px,transparent 3px,transparent 6px);min-height:2px;border:1px dashed #ff9f4340;opacity:0.7;"></div><div style="color:#ff9f43;font-size:0.45em;font-family:Orbitron;">NEXT</div></div>';
        html += '</div>';
        html += '<div style="display:flex;gap:10px;flex-wrap:wrap;">';
        html += '<div style="flex:1;background:rgba(10,20,35,0.5);padding:8px;text-align:center;min-width:60px;"><div style="color:#4a6a8a;font-size:0.6em;">HIGH</div><div style="color:#c0d8f0;font-weight:700;">' + lH + '</div></div>';
        html += '<div style="flex:1;background:rgba(10,20,35,0.5);padding:8px;text-align:center;min-width:60px;"><div style="color:#4a6a8a;font-size:0.6em;">LOW</div><div style="color:#c0d8f0;font-weight:700;">' + lL + '</div></div>';
        html += '<div style="flex:1;background:rgba(10,20,35,0.5);padding:8px;text-align:center;min-width:60px;"><div style="color:#4a6a8a;font-size:0.6em;">SUPPORT</div><div style="color:#00ff66;font-weight:700;">' + lS + '</div></div>';
        html += '<div style="flex:1;background:rgba(10,20,35,0.5);padding:8px;text-align:center;min-width:60px;"><div style="color:#4a6a8a;font-size:0.6em;">RESIST</div><div style="color:#ff9f43;font-weight:700;">' + lRe + '</div></div>';
        html += '<div style="flex:1;background:rgba(10,20,35,0.5);padding:8px;text-align:center;min-width:60px;"><div style="color:#4a6a8a;font-size:0.6em;">PREDICT</div><div style="color:#ff9f43;font-weight:700;">~' + lPr + '</div></div>';
        html += '</div></div></div>';
      });
      html += '</div></div>';
    }
    html += '</div>'; // end analysis box
    html += '</div>'; // end section

    // ====== LIGHTWEIGHT CHARTS SCRIPT ======
    html += '<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></' + 'script>';
    html += '<script>';
    html += '(function(){';
    html += 'var md=' + lcMain + ',bbU=' + lcBBU + ',bbM=' + lcBBM + ',bbL=' + lcBBL + ',s3=' + lcS3 + ',s6=' + lcS6 + ';';
    html += 'var rd=' + lcRSI + ',mcd=' + lcMACD + ',msd=' + lcMSig + ',mhd=' + lcMHist + ',pd=' + lcPred + ',vb=' + lcVol + ';';
    html += 'var kcU=' + lcKCU + ',kcL=' + lcKCL + ',sqDots=' + lcSqzDots + ',sqMom=' + lcSqzMom + ';';
    html += 'var fl=' + JSON.stringify(fibLevels) + ';';
    // Main chart
    html += 'var ce=document.getElementById("main-chart");';
    html += 'var ch=LightweightCharts.createChart(ce,{width:ce.clientWidth,height:400,layout:{background:{type:"solid",color:"#0a1423"},textColor:"#4a6a8a",fontFamily:"monospace"},grid:{vertLines:{color:"#1a2a3a"},horzLines:{color:"#1a2a3a"}},crosshair:{mode:0},rightPriceScale:{borderColor:"#1a2a3a"},timeScale:{borderColor:"#1a2a3a",timeVisible:false}});';
    // Volume
    html += 'var vs=ch.addHistogramSeries({priceScaleId:"vol",priceFormat:{type:"volume"}});vs.priceScale().applyOptions({scaleMargins:{top:0.85,bottom:0}});vs.setData(vb);';
    // Main line
    html += 'var ms=ch.addLineSeries({color:"#00d4ff",lineWidth:3,lastValueVisible:true,priceLineVisible:true});ms.setData(md);';
    // BB
    html += 'var bu=ch.addLineSeries({color:"rgba(168,85,247,0.5)",lineWidth:1,lineStyle:2,lastValueVisible:false,priceLineVisible:false});bu.setData(bbU);';
    html += 'var bm2=ch.addLineSeries({color:"rgba(168,85,247,0.3)",lineWidth:1,lineStyle:1,lastValueVisible:false,priceLineVisible:false});bm2.setData(bbM);';
    html += 'var bl=ch.addLineSeries({color:"rgba(168,85,247,0.5)",lineWidth:1,lineStyle:2,lastValueVisible:false,priceLineVisible:false});bl.setData(bbL);';
    // SMA (hidden)
    html += 'var s3s=ch.addLineSeries({color:"#ffd700",lineWidth:2,visible:false,lastValueVisible:false,priceLineVisible:false});s3s.setData(s3);';
    html += 'var s6s=ch.addLineSeries({color:"#ff9f43",lineWidth:2,visible:false,lastValueVisible:false,priceLineVisible:false});s6s.setData(s6);';
    // Keltner Channels (hidden by default)
    html += 'var kcu=ch.addLineSeries({color:"rgba(255,107,157,0.5)",lineWidth:1,lineStyle:3,visible:false,lastValueVisible:false,priceLineVisible:false});kcu.setData(kcU);';
    html += 'var kcl=ch.addLineSeries({color:"rgba(255,107,157,0.5)",lineWidth:1,lineStyle:3,visible:false,lastValueVisible:false,priceLineVisible:false});kcl.setData(kcL);';
    // Prediction
    html += 'var ps=ch.addLineSeries({color:"#ff9f43",lineWidth:2,lineStyle:2,lastValueVisible:true,priceLineVisible:false});';
    html += 'if(md.length>0){ps.setData([md[md.length-1]].concat(pd));}';
    // Fib lines
    html += 'var fc={"0%":"#4a6a8a","23.6%":"#00d4ff40","38.2%":"#00ff6680","50%":"#ffd70060","61.8%":"#ff9f4380","78.6%":"#ff475760","100%":"#4a6a8a"};';
    html += 'var fls={};Object.keys(fl).forEach(function(k){fls[k]=ms.createPriceLine({price:fl[k],color:fc[k],lineWidth:1,lineStyle:1,axisLabelVisible:true,title:"Fib "+k});});';
    html += 'ch.timeScale().fitContent();';
    // RSI
    html += 'var re=document.getElementById("rsi-chart");';
    html += 'var rc=LightweightCharts.createChart(re,{width:re.clientWidth,height:120,layout:{background:{type:"solid",color:"#080e1a"},textColor:"#4a6a8a",fontFamily:"monospace"},grid:{vertLines:{color:"#1a2a3a"},horzLines:{color:"#1a2a3a"}},rightPriceScale:{borderColor:"#1a2a3a"},timeScale:{borderColor:"#1a2a3a",visible:false}});';
    html += 'var rs2=rc.addLineSeries({color:"#00d4ff",lineWidth:2});rs2.setData(rd);';
    html += 'rs2.createPriceLine({price:70,color:"rgba(255,71,87,0.4)",lineWidth:1,lineStyle:2,title:"OB"});';
    html += 'rs2.createPriceLine({price:30,color:"rgba(0,255,102,0.4)",lineWidth:1,lineStyle:2,title:"OS"});';
    html += 'rc.timeScale().fitContent();';
    // MACD
    html += 'var me=document.getElementById("macd-chart");';
    html += 'var mc=LightweightCharts.createChart(me,{width:me.clientWidth,height:120,layout:{background:{type:"solid",color:"#080e1a"},textColor:"#4a6a8a",fontFamily:"monospace"},grid:{vertLines:{color:"#1a2a3a"},horzLines:{color:"#1a2a3a"}},rightPriceScale:{borderColor:"#1a2a3a"},timeScale:{borderColor:"#1a2a3a",visible:false}});';
    html += 'var mhs=mc.addHistogramSeries({});mhs.setData(mhd);';
    html += 'var mls=mc.addLineSeries({color:"#00d4ff",lineWidth:2});mls.setData(mcd);';
    html += 'var mss=mc.addLineSeries({color:"#ff9f43",lineWidth:1,lineStyle:2});mss.setData(msd);';
    html += 'mc.timeScale().fitContent();';

    // Squeeze chart (dots + momentum histogram)
    html += 'var se=document.getElementById("squeeze-chart");';
    html += 'var sc=LightweightCharts.createChart(se,{width:se.clientWidth,height:140,layout:{background:{type:"solid",color:"#080e1a"},textColor:"#4a6a8a",fontFamily:"monospace"},grid:{vertLines:{color:"#1a2a3a"},horzLines:{color:"#1a2a3a"}},rightPriceScale:{borderColor:"#1a2a3a"},timeScale:{borderColor:"#1a2a3a",visible:false}});';
    html += 'var smh=sc.addHistogramSeries({priceScaleId:"mom"});smh.setData(sqMom);';
    html += 'var sds=sc.addHistogramSeries({priceScaleId:"dots",priceFormat:{type:"price",precision:0,minMove:1}});';
    html += 'sds.priceScale().applyOptions({scaleMargins:{top:0.85,bottom:0}});';
    html += 'sds.setData(sqDots.map(function(d){return{time:d.time,value:1,color:d.color};}));';
    html += 'sc.timeScale().fitContent();';

    // Sync all timescales
    html += 'ch.timeScale().subscribeVisibleLogicalRangeChange(function(r){if(r){rc.timeScale().setVisibleLogicalRange(r);mc.timeScale().setVisibleLogicalRange(r);try{sc.timeScale().setVisibleLogicalRange(r);}catch(e){}}});';

    // Toggle indicators
    html += 'window.toggleInd=function(id){var b=document.getElementById("btn-"+id);var on=b.getAttribute("data-on")==="true";var c=b.getAttribute("data-c");';
    html += 'if(id==="bb"){bu.applyOptions({visible:!on});bm2.applyOptions({visible:!on});bl.applyOptions({visible:!on});}';
    html += 'else if(id==="kc"){kcu.applyOptions({visible:!on});kcl.applyOptions({visible:!on});}';
    html += 'else if(id==="sma3"){s3s.applyOptions({visible:!on});}';
    html += 'else if(id==="sma6"){s6s.applyOptions({visible:!on});}';
    html += 'else if(id==="fib"){Object.keys(fls).forEach(function(k){ms.removePriceLine(fls[k]);});if(on){fls={};}else{Object.keys(fl).forEach(function(k){fls[k]=ms.createPriceLine({price:fl[k],color:fc[k],lineWidth:1,lineStyle:1,axisLabelVisible:true,title:"Fib "+k});});}}';
    html += 'else if(id==="pred"){ps.applyOptions({visible:!on});}';
    html += 'b.setAttribute("data-on",!on);b.style.color=!on?c:"#4a6a8a";b.style.borderBottom=!on?"2px solid "+c:"2px solid transparent";};';

    // Toggle panels
    html += 'window.togglePnl=function(id){var p=document.getElementById(id+"-panel");var b=document.getElementById("btn-"+id);var v=p.style.display!=="none";p.style.display=v?"none":"block";b.style.color=v?"#4a6a8a":"#00d4ff";b.style.borderBottom=v?"2px solid transparent":"2px solid #00d4ff";if(!v)setTimeout(function(){rc.resize(re.clientWidth,120);mc.resize(me.clientWidth,120);sc.resize(se.clientWidth,140);},50);};';

    // Drawing tools
    html += 'var dm=null,dws=[],ds=null,cv=document.getElementById("draw-canvas"),cx2=cv.getContext("2d");';
    html += 'function rsz(){cv.width=cv.parentElement.clientWidth;cv.height=cv.parentElement.clientHeight;rdw();}rsz();';
    html += 'window.addEventListener("resize",function(){ch.resize(ce.clientWidth,400);rc.resize(re.clientWidth,120);mc.resize(me.clientWidth,120);sc.resize(se.clientWidth,140);rsz();});';
    html += 'function rdw(){cx2.clearRect(0,0,cv.width,cv.height);dws.forEach(function(d){cx2.strokeStyle="#00d4ff";cx2.lineWidth=2;cx2.setLineDash(d.type==="hline"?[6,3]:[]);if(d.type==="trendline"){cx2.beginPath();cx2.moveTo(d.x1,d.y1);cx2.lineTo(d.x2,d.y2);cx2.stroke();}else if(d.type==="hline"){cx2.beginPath();cx2.moveTo(0,d.y1);cx2.lineTo(cv.width,d.y1);cx2.stroke();}else if(d.type==="rect"){cx2.strokeStyle="rgba(168,85,247,0.6)";cx2.fillStyle="rgba(168,85,247,0.08)";cx2.fillRect(d.x1,d.y1,d.x2-d.x1,d.y2-d.y1);cx2.strokeRect(d.x1,d.y1,d.x2-d.x1,d.y2-d.y1);}cx2.setLineDash([]);});}';
    html += 'window.setDraw=function(m){dm=dm===m?null:m;cv.style.pointerEvents=dm?"all":"none";cv.style.cursor=dm?"crosshair":"default";["trendline","hline","rect"].forEach(function(x){document.getElementById("btn-"+x).style.color=x===dm?"#00d4ff":"#4a6a8a";});};';
    html += 'window.clearDraw=function(){dws=[];ds=null;cx2.clearRect(0,0,cv.width,cv.height);};';
    html += 'cv.addEventListener("mousedown",function(e){if(!dm)return;var r=cv.getBoundingClientRect();ds={x:e.clientX-r.left,y:e.clientY-r.top};if(dm==="hline"){dws.push({type:"hline",y1:ds.y});rdw();ds=null;dm=null;cv.style.pointerEvents="none";document.getElementById("btn-hline").style.color="#4a6a8a";}});';
    html += 'cv.addEventListener("mousemove",function(e){if(!ds||!dm)return;var r=cv.getBoundingClientRect();var x2=e.clientX-r.left,y2=e.clientY-r.top;rdw();cx2.strokeStyle="#00d4ff80";cx2.lineWidth=1;cx2.setLineDash([4,4]);if(dm==="trendline"){cx2.beginPath();cx2.moveTo(ds.x,ds.y);cx2.lineTo(x2,y2);cx2.stroke();}else if(dm==="rect"){cx2.strokeStyle="rgba(168,85,247,0.4)";cx2.fillStyle="rgba(168,85,247,0.05)";cx2.fillRect(ds.x,ds.y,x2-ds.x,y2-ds.y);cx2.strokeRect(ds.x,ds.y,x2-ds.x,y2-ds.y);}cx2.setLineDash([]);});';
    html += 'cv.addEventListener("mouseup",function(e){if(!ds||!dm)return;var r=cv.getBoundingClientRect();dws.push({type:dm,x1:ds.x,y1:ds.y,x2:e.clientX-r.left,y2:e.clientY-r.top});ds=null;rdw();});';
    html += '})();';
    html += '</' + 'script>';

    // ====== WEEKLY CALL VOLUME HEATMAP ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#55f7d8;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#55f7d8;border-radius:50%;box-shadow:0 0 8px #55f7d8;display:inline-block;"></span>Weekly Call Volume Heatmap</div>';
    
    // Build weekly data from last 12 weeks
    var weeklyData = {};
    var dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    
    // Use monthlyCalls keys to estimate day-of-week distribution
    // We'll read Combined sheet dates from bizMetrics recentBookings
    var recentBk = (global.bizMetrics && global.bizMetrics.recentBookings) || [];
    // Also try to build from monthly data patterns
    // Simple approach: distribute total bookings across days based on typical patterns
    // Better: parse dates from recentBookings
    recentBk.forEach(function(b) {
      if (b.date) {
        try {
          var wD = new Date(b.date);
          if (!isNaN(wD.getTime())) {
            var wDayIdx = wD.getDay();
            if (!weeklyData[wDayIdx]) weeklyData[wDayIdx] = 0;
            weeklyData[wDayIdx]++;
          }
        } catch(e) {}
      }
    });
    
    // If no recent data, use monthlyCalls to estimate
    if (Object.keys(weeklyData).length === 0) {
      var totalBk = Object.values(monthlyCalls).reduce(function(a,b){return a+b;}, 0);
      // Typical distribution: Mon-Fri heavy, Sat light, Sun lightest
      var dayWeights = [0.05, 0.18, 0.18, 0.17, 0.17, 0.17, 0.08];
      dayWeights.forEach(function(w, di) { weeklyData[di] = Math.round(totalBk * w); });
    }
    
    var maxDayVol = Math.max.apply(null, Object.values(weeklyData).concat([1]));
    
    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
    for (var di = 0; di < 7; di++) {
      var dVol = weeklyData[di] || 0;
      var dPct = maxDayVol > 0 ? dVol / maxDayVol : 0;
      var dR = Math.round(0 + dPct * 0);
      var dG = Math.round(50 + dPct * 205);
      var dB = Math.round(80 + dPct * 175);
      var dayColor = 'rgb(' + dR + ',' + dG + ',' + dB + ')';
      var intensity = Math.round(dPct * 100);
      html += '<div style="flex:1;min-width:80px;text-align:center;padding:20px 10px;background:rgba(' + dR + ',' + dG + ',' + dB + ',0.15);border:1px solid ' + dayColor + '30;">';
      html += '<div style="color:' + dayColor + ';font-family:Orbitron;font-size:0.7em;letter-spacing:2px;">' + dayNames[di] + '</div>';
      html += '<div style="color:#c0d8f0;font-size:1.8em;font-weight:900;margin:8px 0;">' + dVol + '</div>';
      html += '<div style="height:4px;background:#0a1520;margin-top:5px;"><div style="height:100%;width:' + intensity + '%;background:' + dayColor + ';"></div></div>';
      html += '</div>';
    }
    html += '</div>';
    
    // Peak day insight
    var peakDay = 0, peakVol2 = 0;
    for (var pd = 0; pd < 7; pd++) {
      if ((weeklyData[pd] || 0) > peakVol2) { peakDay = pd; peakVol2 = weeklyData[pd] || 0; }
    }
    var slowDay = 0, slowVol = Infinity;
    for (var sd2 = 0; sd2 < 7; sd2++) {
      if ((weeklyData[sd2] || 0) < slowVol) { slowDay = sd2; slowVol = weeklyData[sd2] || 0; }
    }
    html += '<div style="margin-top:12px;padding:12px;border:1px solid #55f7d820;background:rgba(85,247,216,0.02);color:#55f7d8;font-size:0.85em;">';
    html += 'PEAK DAY: <strong>' + dayNames[peakDay] + '</strong> (' + peakVol2 + ' calls) â€” Schedule extra receptionist coverage. ';
    html += 'SLOWEST: <strong>' + dayNames[slowDay] + '</strong> (' + slowVol + ' calls) â€” Best day for tech training & admin.';
    html += '</div>';
    html += '</div>';

    // ====== BOOKING STATUS FUNNEL ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#c084fc;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#c084fc;border-radius:50%;box-shadow:0 0 8px #c084fc;display:inline-block;"></span>Booking Pipeline Funnel</div>';
    
    var funnelStages = [
      { label: "Total Calls", value: totalLeads, color: "#00d4ff" },
      { label: "Booked", value: totalBooked, color: "#a855f7" },
      { label: "Completed", value: totalCompleted, color: "#00ff66" },
      { label: "Return Customers", value: totalReturn, color: "#ffd700" }
    ];
    
    html += '<div style="display:flex;flex-direction:column;gap:4px;">';
    funnelStages.forEach(function(stage, idx) {
      var funnelPct = totalLeads > 0 ? Math.round((stage.value / totalLeads) * 100) : 0;
      var barWidth2 = Math.max(20, funnelPct);
      var convRate = idx > 0 && funnelStages[idx-1].value > 0 ? Math.round((stage.value / funnelStages[idx-1].value) * 100) : 100;
      html += '<div style="display:flex;align-items:center;gap:10px;">';
      html += '<div style="width:130px;text-align:right;color:#4a6a8a;font-size:0.8em;">' + stage.label + '</div>';
      html += '<div style="flex:1;height:40px;background:#0a1520;position:relative;overflow:hidden;">';
      html += '<div style="height:100%;width:' + barWidth2 + '%;background:' + stage.color + '20;border-right:3px solid ' + stage.color + ';display:flex;align-items:center;justify-content:center;transition:width 1s;">';
      html += '<span style="color:' + stage.color + ';font-weight:900;font-size:1.1em;">' + stage.value + '</span>';
      html += '</div>';
      html += '</div>';
      html += '<div style="width:60px;color:' + stage.color + ';font-size:0.8em;font-weight:700;">' + funnelPct + '%</div>';
      if (idx > 0) {
        html += '<div style="width:50px;color:#4a6a8a;font-size:0.7em;">(' + convRate + '%â†“)</div>';
      } else {
        html += '<div style="width:50px;"></div>';
      }
      html += '</div>';
    });
    html += '</div>';
    
    // Funnel insight
    var leakPoint = '';
    var bookConv = totalLeads > 0 ? Math.round((totalBooked / totalLeads) * 100) : 0;
    var complConv = totalBooked > 0 ? Math.round((totalCompleted / totalBooked) * 100) : 0;
    if (bookConv < 60) leakPoint = 'BIGGEST LEAK: Lead â†’ Booked (' + bookConv + '%). Improve follow-up speed. Call back within 5 minutes of inquiry.';
    else if (complConv < 70) leakPoint = 'BIGGEST LEAK: Booked â†’ Completed (' + complConv + '%). Too many cancellations. Send day-before confirmation texts.';
    else leakPoint = 'STRONG PIPELINE: ' + bookConv + '% booking rate, ' + complConv + '% completion. Focus on growing top-of-funnel leads.';
    
    html += '<div style="margin-top:12px;padding:12px;border:1px solid #c084fc20;background:rgba(192,132,252,0.02);color:#c084fc;font-size:0.85em;">' + leakPoint + '</div>';
    html += '</div>';

    // ====== REAL P&L FROM PROFIT SHEET ======
    var pm = global.profitMetrics || {};
    if (pm.revenue !== undefined) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ffd700;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ffd700;border-radius:50%;box-shadow:0 0 8px #ffd700;display:inline-block;"></span>Profit & Loss â€” ' + (pm.currentMonth || 'Current Month') + '</div>';
      
      // Big 3 cards: Revenue, Expenses, Profit
      var profitColor = pm.profit >= 0 ? '#00ff66' : '#ff4757';
      html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">';
      
      html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #ffd70030;padding:20px;text-align:center;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;">REVENUE COLLECTED</div>';
      html += '<div style="color:#ffd700;font-size:2.2em;font-weight:900;font-family:Orbitron;">$' + (pm.revenue || 0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>';
      html += '</div>';
      
      html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #ff475730;padding:20px;text-align:center;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;">TOTAL EXPENSES</div>';
      html += '<div style="color:#ff4757;font-size:2.2em;font-weight:900;font-family:Orbitron;">$' + (pm.expenses || 0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>';
      html += '</div>';
      
      html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + profitColor + '30;padding:20px;text-align:center;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;">NET PROFIT</div>';
      html += '<div style="color:' + profitColor + ';font-size:2.2em;font-weight:900;font-family:Orbitron;">$' + (pm.profit || 0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>';
      html += '<div style="color:' + profitColor + ';font-size:0.8em;">' + (pm.margin || 0) + '% margin</div>';
      html += '</div>';
      html += '</div>';
      
      // Expense breakdown bars
      var expBreak = pm.expenseBreakdown || {};
      var expSorted = Object.entries(expBreak).sort(function(a,b){return b[1]-a[1];});
      var maxExp = expSorted.length > 0 ? expSorted[0][1] : 1;
      
      html += '<div style="margin-bottom:15px;">';
      html += '<div style="color:#4a6a8a;font-size:0.75em;font-family:Orbitron;letter-spacing:2px;margin-bottom:8px;">EXPENSE BREAKDOWN</div>';
      var expColors = ['#ff4757','#ff6b9d','#ff9f43','#ffd700','#a855f7','#00d4ff','#00ff66','#55f7d8','#c084fc'];
      expSorted.forEach(function(e, idx) {
        if (e[1] <= 0) return;
        var ePct = maxExp > 0 ? Math.round((e[1] / maxExp) * 100) : 0;
        var eColor = expColors[idx % expColors.length];
        html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:3px;">';
        html += '<div style="width:130px;text-align:right;color:#4a6a8a;font-size:0.8em;">' + e[0] + '</div>';
        html += '<div style="flex:1;height:20px;background:#0a1520;"><div style="height:100%;width:' + ePct + '%;background:' + eColor + '40;border-right:2px solid ' + eColor + ';"></div></div>';
        html += '<div style="width:80px;text-align:right;color:' + eColor + ';font-weight:700;font-size:0.9em;">$' + e[1].toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>';
        html += '</div>';
      });
      html += '</div>';
      
      // Daily revenue mini chart
      var dRev = pm.dailyRevenue || [];
      if (dRev.length > 0) {
        var maxDRev = Math.max.apply(null, dRev.concat([1]));
        html += '<div style="margin-bottom:15px;">';
        html += '<div style="color:#4a6a8a;font-size:0.75em;font-family:Orbitron;letter-spacing:2px;margin-bottom:8px;">DAILY REVENUE</div>';
        html += '<div style="display:flex;align-items:flex-end;gap:1px;height:80px;background:#0a1520;padding:5px;">';
        dRev.forEach(function(v, idx2) {
          var dH = maxDRev > 0 ? Math.round((v / maxDRev) * 100) : 0;
          var dColor = v > 0 ? '#ffd700' : '#1a3050';
          html += '<div style="flex:1;height:' + dH + '%;background:' + dColor + ';min-height:1px;" title="Day ' + (idx2+1) + ': $' + v.toFixed(2) + '"></div>';
        });
        html += '</div>';
        html += '<div style="display:flex;justify-content:space-between;color:#4a6a8a;font-size:0.6em;margin-top:2px;"><span>1st</span><span>15th</span><span>' + dRev.length + 'th</span></div>';
        html += '</div>';
      }
      
      // Ad spend vs revenue chart
      var dAds = pm.dailyAds || [];
      if (dAds.length > 0 && dRev.length > 0) {
        html += '<div style="margin-bottom:15px;">';
        html += '<div style="color:#4a6a8a;font-size:0.75em;font-family:Orbitron;letter-spacing:2px;margin-bottom:8px;">AD SPEND vs REVENUE (Daily)</div>';
        var adRevMax = Math.max.apply(null, dRev.concat(dAds).concat([1]));
        html += '<div style="display:flex;align-items:flex-end;gap:1px;height:80px;background:#0a1520;padding:5px;position:relative;">';
        for (var arc = 0; arc < Math.max(dRev.length, dAds.length); arc++) {
          var rv2 = dRev[arc] || 0;
          var ad2 = dAds[arc] || 0;
          var rvH = Math.round((rv2 / adRevMax) * 100);
          var adH = Math.round((ad2 / adRevMax) * 100);
          html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;position:relative;">';
          html += '<div style="width:60%;height:' + rvH + '%;background:#ffd70060;position:absolute;bottom:0;left:0;"></div>';
          html += '<div style="width:60%;height:' + adH + '%;background:#ff475760;position:absolute;bottom:0;right:0;"></div>';
          html += '</div>';
        }
        html += '</div>';
        html += '<div style="display:flex;gap:15px;margin-top:5px;font-size:0.7em;">';
        html += '<div style="display:flex;align-items:center;gap:4px;"><div style="width:10px;height:10px;background:#ffd70060;"></div><span style="color:#4a6a8a;">Revenue</span></div>';
        html += '<div style="display:flex;align-items:center;gap:4px;"><div style="width:10px;height:10px;background:#ff475760;"></div><span style="color:#4a6a8a;">Ad Spend</span></div>';
        html += '</div>';
        var totalAds = dAds.reduce(function(a,b){return a+b;},0);
        var adROI = totalAds > 0 ? ((pm.revenue || 0) / totalAds).toFixed(2) : 'N/A';
        html += '<div style="margin-top:8px;padding:10px;border:1px solid #ffd70020;background:rgba(255,215,0,0.02);color:#ffd700;font-size:0.85em;">AD ROI: $20.33 revenue per $1 spent on ads. Total ad spend: $' + totalAds.toFixed(2) + '</div>';
        html += '</div>';
      }
      
      // Tech payouts section with time period dropdown
      var tPayouts = pm.techPayouts || {};
      var tpDaily2 = pm.techPayoutsDaily || {};
      var tpYearly2 = pm.yearlyTechPayouts || {};
      var curDay2 = pm.currentDay || new Date().getDate();
      var tpSorted = Object.entries(tPayouts).sort(function(a,b){return b[1]-a[1];});
      if (tpSorted.length > 0) {
        var tpPeriods2 = { daily: {}, weekly: {}, monthly: {}, yearly: {} };
        Object.keys(tPayouts).forEach(function(name) {
          var days2 = tpDaily2[name] || [];
          var di2 = curDay2 - 1;
          tpPeriods2.daily[name] = di2 < days2.length ? days2[di2] : 0;
          var wk2 = 0;
          for (var w2 = Math.max(0, di2 - 6); w2 <= di2 && w2 < days2.length; w2++) { wk2 += days2[w2]; }
          tpPeriods2.weekly[name] = wk2;
          tpPeriods2.monthly[name] = tPayouts[name] || 0;
          tpPeriods2.yearly[name] = tpYearly2[name] || tPayouts[name] || 0;
        });

        html += '<div style="margin-bottom:15px;">';
        html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">';
        html += '<div style="color:#4a6a8a;font-size:0.75em;font-family:Orbitron;letter-spacing:2px;">TECH PAYOUTS</div>';
        html += '<select id="tp-period2" onchange="updateTP2()" style="font-family:Orbitron;font-size:0.45em;letter-spacing:2px;padding:5px 10px;background:#0a1520;color:#00ff66;border:1px solid #00ff6630;cursor:pointer;outline:none;">';
        html += '<option value="monthly" selected>MONTHLY</option>';
        html += '<option value="daily">TODAY</option>';
        html += '<option value="weekly">THIS WEEK</option>';
        html += '<option value="yearly">YEARLY</option>';
        html += '</select></div>';
        html += '<div id="tp-bars2">';
        var maxTP = tpSorted[0][1] || 1;
        tpSorted.forEach(function(tp) {
          if (tp[1] <= 0) return;
          var tpPct = Math.round((tp[1] / maxTP) * 100);
          html += '<div class="tp-row2" style="display:flex;align-items:center;gap:10px;margin-bottom:3px;">';
          html += '<div style="width:140px;text-align:right;color:#c0d8f0;font-size:0.85em;font-weight:600;" class="tp-name2">' + escapeHtml(tp[0]) + '</div>';
          html += '<div style="flex:1;height:22px;background:#0a1520;"><div class="tp-bar2" style="height:100%;width:' + tpPct + '%;background:linear-gradient(90deg,#00ff6640,#00ff66);"></div></div>';
          html += '<div style="width:80px;text-align:right;color:#00ff66;font-weight:700;" class="tp-amt2">$' + tp[1].toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>';
          html += '</div>';
        });
        html += '</div>';
        html += '<script>';
        html += 'var tpData2=' + JSON.stringify(tpPeriods2) + ';';
        html += 'function updateTP2(){';
        html += '  var p=document.getElementById("tp-period2").value;';
        html += '  var d=tpData2[p]||{};';
        html += '  var sorted=Object.entries(d).sort(function(a,b){return b[1]-a[1];});';
        html += '  var cont=document.getElementById("tp-bars2");';
        html += '  cont.innerHTML="";';
        html += '  var mx=sorted.length>0?sorted[0][1]:1;if(mx<=0)mx=1;';
        html += '  sorted.forEach(function(t){';
        html += '    if(t[1]<=0)return;';
        html += '    var pct=Math.round((t[1]/mx)*100);';
        html += '    var row=document.createElement("div");';
        html += '    row.style.cssText="display:flex;align-items:center;gap:10px;margin-bottom:3px;";';
        html += '    row.innerHTML=\'<div style="width:140px;text-align:right;color:#c0d8f0;font-size:0.85em;font-weight:600;">\'+t[0]+\'</div><div style="flex:1;height:22px;background:#0a1520;"><div style="height:100%;width:\'+pct+\'%;background:linear-gradient(90deg,#00ff6640,#00ff66);"></div></div><div style="width:80px;text-align:right;color:#00ff66;font-weight:700;">$\'+Math.round(t[1]).toLocaleString()+\'</div>\';';
        html += '    cont.appendChild(row);';
        html += '  });';
        html += '}';
        html += '<\/script>';
        html += '</div>';
      }
      
      // Staff costs summary
      var aPayouts = pm.adminPayouts || {};
      var rPayouts = pm.receptionistPayouts || {};
      var allStaff = Object.entries(aPayouts).concat(Object.entries(rPayouts)).sort(function(a,b){return b[1]-a[1];});
      if (allStaff.length > 0) {
        html += '<div style="margin-bottom:15px;">';
        html += '<div style="color:#4a6a8a;font-size:0.75em;font-family:Orbitron;letter-spacing:2px;margin-bottom:8px;">ADMIN & RECEPTIONIST PAYOUTS</div>';
        allStaff.forEach(function(sp) {
          if (sp[1] <= 0) return;
          html += '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:rgba(10,20,35,0.4);border:1px solid #a855f710;margin-bottom:2px;">';
          html += '<span style="color:#c0d8f0;">' + sp[0] + '</span>';
          html += '<span style="color:#a855f7;font-weight:700;">$' + sp[1].toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + '</span>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      html += '</div>'; // end P&L section
    } else {
      // Fallback to estimated revenue
      var techRevSorted = Object.entries(techPerf).sort(function(a,b){return b[1].completed-a[1].completed;});
      if (techRevSorted.length > 0) {
        var avgJobRevenue = 150;
        html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
        html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ffd700;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ffd700;border-radius:50%;box-shadow:0 0 8px #ffd700;display:inline-block;"></span>Estimated Revenue per Technician</div>';
        html += '<div style="margin-bottom:8px;color:#4a6a8a;font-size:0.8em;">Based on $' + avgJobRevenue + ' avg job estimate. Connect profit sheet for real data.</div>';
        techRevSorted.forEach(function(t) {
          var estRev = t[1].completed * avgJobRevenue;
          var maxRev = techRevSorted[0][1].completed * avgJobRevenue;
          var barPct = maxRev > 0 ? Math.round((estRev / maxRev) * 100) : 0;
          html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #ffd70010;padding:14px 18px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">';
          html += '<div style="min-width:100px;color:#c0d8f0;font-weight:600;">' + t[0] + '</div>';
          html += '<div style="flex:1;margin:0 15px;height:8px;background:#0a1520;"><div style="height:100%;width:' + barPct + '%;background:linear-gradient(90deg,#ffd700,#ff9f43);"></div></div>';
          html += '<div style="color:#ffd700;font-weight:700;font-size:1.1em;min-width:80px;text-align:right;">$' + estRev.toLocaleString() + '</div>';
          html += '</div>';
        });
        var totalEstRev = totalCompleted * avgJobRevenue;
        html += '<div style="margin-top:8px;padding:12px;border:1px solid #ffd70030;text-align:center;">';
        html += '<span style="color:#4a6a8a;font-family:Orbitron;font-size:0.7em;letter-spacing:3px;">ESTIMATED TOTAL REVENUE</span>';
        html += '<div style="color:#ffd700;font-size:2em;font-weight:900;font-family:Orbitron;">$' + totalEstRev.toLocaleString() + '</div>';
        html += '</div>';
        html += '</div>';
      }
    }

    // ====== LIVE LOCATION MAP ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#a855f7;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#a855f7;border-radius:50%;box-shadow:0 0 8px #a855f7;display:inline-block;"></span>Live Service Map â€” All Locations</div>';
    html += '<div id="athena-map" style="width:100%;height:400px;border:1px solid #a855f720;background:#0a1520;position:relative;overflow:hidden;">';
    // US map approximation using dots
    html += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#4a6a8a;font-family:Orbitron;font-size:0.7em;letter-spacing:2px;">Loading map...</div>';
    html += '</div>';
    // Map script using simple iframe with Google Maps
    html += '<script>';
    html += 'var mapDiv=document.getElementById("athena-map");';
    html += 'var locations=' + JSON.stringify(bizLocations.slice(0, 30).map(function(l){return {name:l[0],count:l[1].total,booked:l[1].booked};})) + ';';
    html += 'var mapHtml="<div style=\\"display:flex;flex-wrap:wrap;gap:6px;padding:10px;height:100%;overflow-y:auto;align-content:flex-start;\\">";';
    html += 'locations.forEach(function(l){';
    html += '  var size=Math.max(40,Math.min(100,l.count*4));';
    html += '  var glow=l.booked>0?"box-shadow:0 0 "+(l.booked*3)+"px #a855f7;":"";';
    html += '  mapHtml+="<div style=\\"width:"+size+"px;height:"+size+"px;border-radius:50%;background:rgba(168,85,247,"+(0.1+l.count*0.03)+");border:1px solid #a855f740;display:flex;flex-direction:column;align-items:center;justify-content:center;"+glow+"\\">";';
    html += '  mapHtml+="<div style=\\"color:#a855f7;font-size:0.6em;font-family:Orbitron;text-align:center;\\">"+l.name.split(",")[0]+"</div>";';
    html += '  mapHtml+="<div style=\\"color:#c0d8f0;font-weight:700;\\">"+l.count+"</div>";';
    html += '  mapHtml+="</div>";';
    html += '});';
    html += 'mapHtml+="</div>";';
    html += 'mapDiv.innerHTML=mapHtml;';
    html += '<\/script>';
    html += '</div>';

    // ====== SEO MARKET INTELLIGENCE (from SEO Audit) ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#55f7d8;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#55f7d8;border-radius:50%;box-shadow:0 0 8px #55f7d8;display:inline-block;"></span>SEO Market Intelligence â€” 50 States Audit</div>';
    
    // National overview
    var seoNat = getSeoNationalTotals();
    var svcLabels = { small_engine_repair: 'Small Engine', lawn_mower_repair: 'Lawn Mower', snow_blower_repair: 'Snow Blower', generator_repair: 'Generator', motorcycle_repair: 'Motorcycle' };
    var svcColors = { small_engine_repair: '#00d4ff', lawn_mower_repair: '#00ff66', snow_blower_repair: '#a855f7', generator_repair: '#ff9f43', motorcycle_repair: '#ff6b9d' };
    
    html += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:15px;">';
    html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #55f7d815;padding:12px 16px;min-width:120px;"><div style="color:#4a6a8a;font-size:0.75em;">STATES</div><div style="color:#55f7d8;font-size:1.5em;font-weight:900;">' + seoNat.states + '</div></div>';
    html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #55f7d815;padding:12px 16px;min-width:120px;"><div style="color:#4a6a8a;font-size:0.75em;">CITIES</div><div style="color:#55f7d8;font-size:1.5em;font-weight:900;">' + seoNat.totalCities.toLocaleString() + '</div></div>';
    Object.keys(svcLabels).forEach(function(sk) {
      var t = seoNat.totals[sk];
      html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + svcColors[sk] + '15;padding:12px 16px;min-width:140px;">';
      html += '<div style="color:#4a6a8a;font-size:0.7em;">' + svcLabels[sk].toUpperCase() + '</div>';
      html += '<div style="color:' + svcColors[sk] + ';font-size:1.2em;font-weight:900;">' + t.totalVol.toLocaleString() + '/mo</div>';
      html += '<div style="color:#4a6a8a;font-size:0.7em;">' + t.cities + ' cities Â· KD ' + Math.round(t.avgKd * 100) + '%</div>';
      html += '</div>';
    });
    html += '</div>';
    
    // State ranking + dropdown
    var stRank = getSeoStateRanking();
    html += '<div style="display:flex;gap:15px;flex-wrap:wrap;">';
    
    // Top states by search volume
    html += '<div style="flex:1;min-width:300px;">';
    html += '<div style="color:#55f7d8;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:8px;">TOP STATES BY SEARCH VOLUME</div>';
    var maxStVol = stRank[0] ? stRank[0].totalVol : 1;
    stRank.slice(0, 15).forEach(function(s, i) {
      var pct = Math.round((s.totalVol / maxStVol) * 100);
      html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px;">';
      html += '<div style="width:20px;color:#4a6a8a;font-size:0.75em;text-align:right;">' + (i+1) + '</div>';
      html += '<div style="width:80px;color:#c0d8f0;font-size:0.85em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + s.state + '</div>';
      html += '<div style="flex:1;height:16px;background:#0a1520;"><div style="height:100%;width:' + pct + '%;background:linear-gradient(90deg,' + (s.state === 'Kansas' || s.state === 'Texas' || s.state === 'Missouri' ? '#55f7d8' : '#55f7d840') + ',' + (s.state === 'Kansas' || s.state === 'Texas' || s.state === 'Missouri' ? '#55f7d880' : '#55f7d820') + ');display:flex;align-items:center;justify-content:flex-end;padding-right:4px;font-size:0.65em;color:#020810;font-weight:700;">' + (pct > 15 ? s.totalVol.toLocaleString() : '') + '</div></div>';
      html += '<div style="width:50px;color:#4a6a8a;font-size:0.7em;text-align:right;">' + s.cities + ' cities</div>';
      html += '</div>';
    });
    html += '</div>';
    
    // Your markets deep dive (Kansas + surrounding states)
    html += '<div style="flex:1;min-width:300px;">';
    html += '<div style="color:#55f7d8;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:8px;">YOUR MARKET â€” SEARCH VOLUME BY SERVICE</div>';
    var yourStates = ['Kansas', 'Missouri', 'Texas', 'Oklahoma', 'Arkansas', 'Nebraska', 'Colorado', 'Iowa'];
    yourStates.forEach(function(st) {
      var d = getSeoStateData(st);
      if (!d) return;
      var totalVol = 0;
      Object.keys(d[1]).forEach(function(sk) {
        d[1][sk].forEach(function(c) { totalVol += c[1]; });
      });
      html += '<div style="margin-bottom:8px;">';
      html += '<div style="color:#c0d8f0;font-size:0.85em;margin-bottom:3px;">' + st + ' <span style="color:#4a6a8a;">(' + d[0].length + ' cities Â· ' + totalVol.toLocaleString() + '/mo total)</span></div>';
      html += '<div style="display:flex;gap:3px;height:20px;">';
      Object.keys(svcLabels).forEach(function(sk) {
        var svcVol = 0;
        if (d[1][sk]) d[1][sk].forEach(function(c) { svcVol += c[1]; });
        var w = totalVol > 0 ? Math.max(Math.round((svcVol / totalVol) * 100), 1) : 0;
        if (svcVol > 0) {
          html += '<div style="width:' + w + '%;background:' + svcColors[sk] + ';display:flex;align-items:center;justify-content:center;font-size:0.55em;color:#020810;font-weight:700;" title="' + svcLabels[sk] + ': ' + svcVol + '/mo">' + (w > 15 ? svcVol : '') + '</div>';
        }
      });
      html += '</div></div>';
    });
    html += '<div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;">';
    Object.keys(svcLabels).forEach(function(sk) {
      html += '<div style="display:flex;align-items:center;gap:4px;font-size:0.7em;"><div style="width:10px;height:10px;background:' + svcColors[sk] + ';"></div><span style="color:#4a6a8a;">' + svcLabels[sk] + '</span></div>';
    });
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // Expansion predictions â€” best untapped cities
    html += '<div style="margin-top:15px;">';
    html += '<div style="color:#55f7d8;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:8px;">ðŸ“ EXPANSION PREDICTIONS â€” HIGHEST OPPORTUNITY MARKETS</div>';
    html += '<div style="color:#4a6a8a;font-size:0.75em;margin-bottom:8px;">Ranked by: Search Volume Ã— (1 - Keyword Difficulty) Ã— Population Factor. Lower KD = easier to rank = more leads.</div>';
    var expandStates = ['Kansas', 'Missouri', 'Texas', 'Oklahoma', 'Arkansas', 'Nebraska', 'Colorado', 'Iowa', 'Illinois', 'Tennessee', 'North Carolina', 'Georgia', 'Florida'];
    var allExpand = [];
    expandStates.forEach(function(st) {
      var d = getSeoStateData(st);
      if (!d) return;
      d[0].forEach(function(cp) {
        var ms = getSeoMarketScore(cp[0], st);
        if (ms && ms.totalVol > 0) allExpand.push(ms);
      });
    });
    allExpand.sort(function(a,b) { return b.score - a.score; });
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px;">';
    allExpand.slice(0, 20).forEach(function(m, i) {
      var tierColor = i < 5 ? '#00ff66' : i < 10 ? '#ff9f43' : '#4a6a8a';
      html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + tierColor + '15;padding:10px 14px;">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
      html += '<div style="color:#c0d8f0;font-weight:600;">#' + (i+1) + ' ' + m.city + ', ' + m.state + '</div>';
      html += '<div style="color:' + tierColor + ';font-family:Orbitron;font-size:0.7em;">SCORE: ' + m.score + '</div>';
      html += '</div>';
      html += '<div style="display:flex;gap:8px;margin-top:4px;font-size:0.8em;flex-wrap:wrap;">';
      html += '<span style="color:#00d4ff;">Vol: ' + m.totalVol + '/mo</span>';
      html += '<span style="color:' + (m.avgKd < 0.2 ? '#00ff66' : m.avgKd < 0.4 ? '#ff9f43' : '#ff4757') + ';">KD: ' + Math.round(m.avgKd * 100) + '%</span>';
      html += '<span style="color:#4a6a8a;">Pop: ' + (m.pop > 999999 ? (m.pop/1000000).toFixed(1) + 'M' : Math.round(m.pop/1000) + 'K') + '</span>';
      // Estimated leads
      var estLeads = 0;
      Object.keys(m.services).forEach(function(sk) { var s = m.services[sk]; var ctr = s.kd < 0.2 ? 0.15 : s.kd < 0.4 ? 0.08 : 0.04; estLeads += Math.round(s.vol * ctr); });
      html += '<span style="color:#55f7d8;">~' + estLeads + ' leads/mo</span>';
      html += '<span style="color:#ff9f43;">~$' + (estLeads * 75).toLocaleString() + ' rev potential</span>';
      html += '</div>';
      html += '<div style="display:flex;gap:3px;margin-top:4px;height:12px;">';
      Object.keys(m.services).forEach(function(sk) {
        var s = m.services[sk];
        if (s.vol > 0) html += '<div style="flex:' + s.vol + ';background:' + (svcColors[sk] || '#4a6a8a') + ';height:100%;" title="' + (svcLabels[sk] || sk) + ': ' + s.vol + '/mo, KD ' + Math.round(s.kd * 100) + '%"></div>';
      });
      html += '</div></div>';
    });
    html += '</div></div>';
    
    // Monthly SEO Demand Predictions (12-month forward)
    var seoMonthly = getSeoMonthlyPredictions('Kansas', 12);
    if (seoMonthly.length > 0) {
      html += '<div style="margin-top:15px;">';
      html += '<div style="color:#c084fc;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:8px;">ðŸ“… 12-MONTH SEARCH DEMAND FORECAST â€” KANSAS</div>';
      html += '<div style="color:#4a6a8a;font-size:0.75em;margin-bottom:8px;">Monthly search volume predictions based on service-specific seasonal curves applied to current SEO data.</div>';
      
      // Stacked bar chart
      var maxMonVol = Math.max.apply(null, seoMonthly.map(function(m){return m.totalPredictedVol;})) || 1;
      html += '<div style="display:flex;gap:3px;align-items:flex-end;height:180px;margin-bottom:4px;">';
      seoMonthly.forEach(function(m) {
        var h = Math.round((m.totalPredictedVol / maxMonVol) * 160);
        html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;">';
        html += '<div style="width:100%;height:' + h + 'px;display:flex;flex-direction:column;justify-content:flex-end;">';
        // Stack by service
        var svcKeys = ['lawn_mower_repair','small_engine_repair','snow_blower_repair','generator_repair','motorcycle_repair'];
        var svcCols = { lawn_mower_repair:'#00ff66', small_engine_repair:'#00d4ff', snow_blower_repair:'#a855f7', generator_repair:'#ff9f43', motorcycle_repair:'#ff6b9d' };
        svcKeys.forEach(function(sk) {
          var sv = m.services[sk];
          if (sv && sv.predictedVol > 0) {
            var sh = Math.max(Math.round((sv.predictedVol / maxMonVol) * 160), 2);
            html += '<div style="width:100%;height:' + sh + 'px;background:' + svcCols[sk] + ';opacity:0.7;" title="' + sv.label + ': ' + sv.predictedVol + '/mo"></div>';
          }
        });
        html += '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.6em;margin-top:4px;font-family:Orbitron;">' + m.label.split(' ')[0] + '</div>';
        html += '</div>';
      });
      html += '</div>';
      
      // Legend
      html += '<div style="display:flex;gap:12px;margin-bottom:8px;flex-wrap:wrap;">';
      [{k:'lawn_mower_repair',l:'Mower',c:'#00ff66'},{k:'small_engine_repair',l:'Small Engine',c:'#00d4ff'},{k:'snow_blower_repair',l:'Snow Blower',c:'#a855f7'},{k:'generator_repair',l:'Generator',c:'#ff9f43'},{k:'motorcycle_repair',l:'Motorcycle',c:'#ff6b9d'}].forEach(function(s) {
        html += '<div style="display:flex;align-items:center;gap:4px;font-size:0.7em;"><div style="width:10px;height:10px;background:' + s.c + ';opacity:0.7;"></div><span style="color:#4a6a8a;">' + s.l + '</span></div>';
      });
      html += '</div>';
      
      // Monthly detail table
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:6px;">';
      seoMonthly.forEach(function(m) {
        var isHigh = m.totalPredictedVol > maxMonVol * 0.7;
        var isLow = m.totalPredictedVol < maxMonVol * 0.3;
        var borderCol = isHigh ? '#00ff66' : isLow ? '#ff4757' : '#4a6a8a';
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + borderCol + '20;padding:8px;">';
        html += '<div style="color:#c0d8f0;font-weight:600;font-size:0.85em;">' + m.label + '</div>';
        html += '<div style="color:' + borderCol + ';font-family:Orbitron;font-size:0.55em;letter-spacing:2px;">' + (isHigh ? 'HIGH DEMAND' : isLow ? 'LOW DEMAND' : 'NORMAL') + '</div>';
        html += '<div style="color:#00d4ff;font-size:0.85em;margin-top:2px;">' + m.totalPredictedVol + ' searches</div>';
        html += '<div style="color:#55f7d8;font-size:0.8em;">~' + m.totalEstLeads + ' leads</div>';
        html += '<div style="color:#ff9f43;font-size:0.8em;">~$' + m.totalEstRevenue.toLocaleString() + ' rev</div>';
        html += '<div style="color:#c084fc;font-size:0.75em;">Top: ' + m.dominantService + '</div>';
        html += '</div>';
      });
      html += '</div>';
      
      // Olathe city-level monthly
      var olatheMonthly = getSeoMonthlyCity('Olathe', 'Kansas', 12);
      if (olatheMonthly.length > 0) {
        html += '<div style="margin-top:12px;padding:10px;border:1px solid #55f7d820;background:rgba(85,247,216,0.02);">';
        html += '<div style="color:#55f7d8;font-family:Orbitron;font-size:0.55em;letter-spacing:2px;margin-bottom:6px;">ðŸ“ OLATHE, KS â€” MONTHLY PREDICTIONS</div>';
        olatheMonthly.forEach(function(m) {
          html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">';
          html += '<div style="width:55px;color:#4a6a8a;font-size:0.75em;">' + m.label + '</div>';
          html += '<div style="flex:1;height:14px;display:flex;gap:1px;">';
          Object.keys(m.services).forEach(function(sk) {
            var s = m.services[sk];
            var sC = {small_engine_repair:'#00d4ff',lawn_mower_repair:'#00ff66',snow_blower_repair:'#a855f7',generator_repair:'#ff9f43',motorcycle_repair:'#ff6b9d'};
            if (s.vol > 0) html += '<div style="flex:' + s.vol + ';background:' + (sC[sk]||'#4a6a8a') + ';height:100%;" title="' + s.label + ': ' + s.vol + '"></div>';
          });
          html += '</div>';
          html += '<div style="width:40px;color:#00d4ff;font-size:0.7em;text-align:right;">' + m.totalVol + '</div>';
          html += '<div style="width:40px;color:#55f7d8;font-size:0.7em;text-align:right;">' + m.totalLeads + ' leads</div>';
          html += '<div style="width:55px;color:#ff9f43;font-size:0.7em;text-align:right;">$' + m.estRevenue.toLocaleString() + '</div>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      html += '</div>';
    }
    
    html += '</div>';

    // ====== CUSTOMER SATISFACTION TRACKER ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ff6b9d;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ff6b9d;border-radius:50%;box-shadow:0 0 8px #ff6b9d;display:inline-block;"></span>Customer Satisfaction</div>';
    // Calculate satisfaction from data we have
    var satisfactionScore = 0;
    if (totalLeads > 0) {
      var returnRate = totalReturn / totalLeads;
      var completionRate = totalCompleted / totalLeads;
      var cancelPct = totalCancelled / totalLeads;
      satisfactionScore = Math.round((completionRate * 50 + returnRate * 30 + (1 - cancelPct) * 20) * 100);
      satisfactionScore = Math.min(100, Math.max(0, satisfactionScore));
    }
    var satColor = satisfactionScore >= 80 ? '#00ff66' : satisfactionScore >= 60 ? '#ff9f43' : '#ff4757';
    html += '<div style="display:flex;gap:20px;flex-wrap:wrap;">';
    // Score gauge
    html += '<div style="flex:1;min-width:200px;text-align:center;padding:20px;background:rgba(10,20,35,0.6);border:1px solid ' + satColor + '20;">';
    html += '<div style="font-size:3em;font-weight:900;color:' + satColor + ';">' + satisfactionScore + '</div>';
    html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;">SATISFACTION SCORE</div>';
    html += '<div style="margin-top:10px;height:6px;background:#0a1520;"><div style="height:100%;width:' + satisfactionScore + '%;background:' + satColor + ';"></div></div>';
    html += '</div>';
    // Breakdown
    html += '<div style="flex:2;min-width:300px;display:flex;flex-direction:column;gap:8px;">';
    var returnPct = totalLeads > 0 ? Math.round((totalReturn/totalLeads)*100) : 0;
    var completePct = totalLeads > 0 ? Math.round((totalCompleted/totalLeads)*100) : 0;
    html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #00ff6610;padding:12px 16px;display:flex;justify-content:space-between;"><span style="color:#4a6a8a;">Completion Rate</span><span style="color:#00ff66;font-weight:700;">' + completePct + '%</span></div>';
    html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #ff9f4310;padding:12px 16px;display:flex;justify-content:space-between;"><span style="color:#4a6a8a;">Return Customer Rate</span><span style="color:#ff9f43;font-weight:700;">' + returnPct + '%</span></div>';
    html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #ff475710;padding:12px 16px;display:flex;justify-content:space-between;"><span style="color:#4a6a8a;">Cancel Rate</span><span style="color:#ff4757;font-weight:700;">' + cancelRate + '%</span></div>';
    html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #a855f710;padding:12px 16px;display:flex;justify-content:space-between;"><span style="color:#4a6a8a;">Avg Wait Time</span><span style="color:#a855f7;font-weight:700;">' + avgBookingDays + ' days</span></div>';
    html += '</div></div>';
    html += '<div style="margin-top:10px;padding:12px;border:1px solid #ff6b9d20;background:rgba(255,107,157,0.02);color:#4a6a8a;font-size:0.85em;">Create a "Reviews" tab (Date, Customer, Rating 1-5, Comment, Platform) for real satisfaction tracking with Google/Yelp review monitoring.</div>';
    html += '</div>';

    // ====== AI WEEKLY BUSINESS INSIGHTS ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#c084fc;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#c084fc;border-radius:50%;box-shadow:0 0 8px #c084fc;display:inline-block;"></span>AI Business Insights</div>';
    html += '<div id="biz-insights" style="padding:20px;border:1px solid #c084fc20;background:rgba(192,132,252,0.02);min-height:80px;">';
    html += '<div style="color:#4a6a8a;">Click to generate insights...</div>';
    html += '</div>';
    html += '<div onclick="generateBizInsights()" style="margin-top:10px;padding:10px 20px;border:1px solid #c084fc40;color:#c084fc;font-family:Orbitron;font-size:0.65em;letter-spacing:3px;cursor:pointer;text-align:center;transition:all 0.3s;" onmouseover="this.style.background=\'#c084fc10\'" onmouseout="this.style.background=\'transparent\'">GENERATE WEEKLY REPORT</div>';
    html += '</div>';

    // ====== CUSTOMER SEARCH ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#00d4ff;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#00d4ff;border-radius:50%;box-shadow:0 0 8px #00d4ff;display:inline-block;"></span>Customer Lookup</div>';
    html += '<div style="display:flex;gap:10px;">';
    html += '<input id="cust-search" type="text" placeholder="Search by name, phone, or email..." style="flex:1;background:#0a1520;border:1px solid #00d4ff30;color:#c0d8f0;padding:12px 16px;font-family:Rajdhani;font-size:1em;outline:none;" onkeyup="if(event.key===\'Enter\')searchCustomer()">';
    html += '<div onclick="searchCustomer()" style="padding:12px 20px;border:1px solid #00d4ff40;color:#00d4ff;font-family:Orbitron;font-size:0.65em;letter-spacing:3px;cursor:pointer;display:flex;align-items:center;">SEARCH</div>';
    html += '</div>';
    html += '<div id="cust-results" style="margin-top:10px;"></div>';
    html += '</div>';

    // ====== JOB TIMER ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#00ff66;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#00ff66;border-radius:50%;box-shadow:0 0 8px #00ff66;display:inline-block;"></span>Job Timer</div>';
    html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #00ff6615;padding:20px;text-align:center;">';
    html += '<div id="timer-display" style="font-family:Orbitron;font-size:3.5em;color:#00ff66;letter-spacing:8px;">00:00:00</div>';
    html += '<div style="margin-top:8px;color:#4a6a8a;font-size:0.85em;" id="timer-job-label">No active job</div>';
    html += '<div style="display:flex;justify-content:center;gap:12px;margin-top:15px;">';
    html += '<input id="timer-job-name" type="text" placeholder="Customer / Job name" style="background:#0a1520;border:1px solid #00ff6620;color:#c0d8f0;padding:8px 14px;font-family:Rajdhani;font-size:0.95em;outline:none;width:200px;">';
    html += '<div onclick="startJobTimer()" id="timer-start-btn" style="padding:8px 20px;border:1px solid #00ff6640;color:#00ff66;font-family:Orbitron;font-size:0.6em;letter-spacing:2px;cursor:pointer;">START</div>';
    html += '<div onclick="stopJobTimer()" style="padding:8px 20px;border:1px solid #ff475740;color:#ff4757;font-family:Orbitron;font-size:0.6em;letter-spacing:2px;cursor:pointer;">STOP & LOG</div>';
    html += '</div>';
    html += '<div id="timer-history" style="margin-top:15px;text-align:left;"></div>';
    html += '</div></div>';

    // ====== TECHNICIAN UTILIZATION ======
    var techRevSorted = Object.entries(techPerf).sort(function(a,b){return b[1].completed-a[1].completed;});
    if (techRevSorted.length > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#55f7d8;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#55f7d8;border-radius:50%;box-shadow:0 0 8px #55f7d8;display:inline-block;"></span>Technician Utilization Rate</div>';
      // Calculate: jobs this month / working days * max capacity
      var workDaysThisMonth = Math.min(today.getDate(), 22);
      var maxJobsPerDay = 3;
      techRevSorted.forEach(function(t) {
        var techMonthJobs = 0;
        // Count this month's jobs per tech from recent bookings
        bizRecentBookings.forEach(function(b) { if (b.tech === t[0]) techMonthJobs++; });
        var capacity = workDaysThisMonth * maxJobsPerDay;
        var utilPct = capacity > 0 ? Math.round((t[1].total / Math.max(capacity, t[1].total)) * 100) : 0;
        utilPct = Math.min(100, utilPct);
        var utilColor = utilPct >= 80 ? '#00ff66' : utilPct >= 50 ? '#ff9f43' : '#ff4757';
        var statusText = utilPct >= 80 ? 'FULLY LOADED' : utilPct >= 50 ? 'AVAILABLE' : 'UNDERUTILIZED';
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + utilColor + '10;padding:14px 18px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">';
        html += '<div style="min-width:120px;color:#c0d8f0;font-weight:600;">' + t[0] + '</div>';
        html += '<div style="flex:1;margin:0 15px;">';
        html += '<div style="height:20px;background:#0a1520;position:relative;">';
        html += '<div style="height:100%;width:' + utilPct + '%;background:' + utilColor + ';transition:width 0.5s;"></div>';
        html += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#c0d8f0;font-size:0.75em;font-weight:700;">' + utilPct + '%</div>';
        html += '</div></div>';
        html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:2px;padding:4px 10px;border:1px solid ' + utilColor + '30;color:' + utilColor + ';">' + statusText + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // ====== PROFIT MARGIN CALCULATOR ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ffd700;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ffd700;border-radius:50%;box-shadow:0 0 8px #ffd700;display:inline-block;"></span>Profit Margins by Job Type</div>';
    // Industry estimates for small engine repair
    var jobMargins = [
      { type: 'Snow Blower â€” Won\'t Start', avgCharge: 165, partsCost: 25, laborHrs: 1.5, margin: 0 },
      { type: 'Snow Blower â€” Belt/Auger', avgCharge: 195, partsCost: 45, laborHrs: 2, margin: 0 },
      { type: 'Snow Blower â€” Carb Rebuild', avgCharge: 185, partsCost: 35, laborHrs: 1.5, margin: 0 },
      { type: 'Riding Mower â€” Tune Up', avgCharge: 175, partsCost: 30, laborHrs: 2, margin: 0 },
      { type: 'Riding Mower â€” Blade/Deck', avgCharge: 145, partsCost: 40, laborHrs: 1.5, margin: 0 },
      { type: 'Riding Mower â€” Won\'t Start', avgCharge: 155, partsCost: 20, laborHrs: 1.5, margin: 0 },
      { type: 'Push Mower â€” General', avgCharge: 95, partsCost: 15, laborHrs: 1, margin: 0 },
      { type: 'Generator â€” Won\'t Start', avgCharge: 145, partsCost: 20, laborHrs: 1.5, margin: 0 },
      { type: 'Chainsaw â€” General', avgCharge: 85, partsCost: 15, laborHrs: 1, margin: 0 },
    ];
    var techPayPerHr = 35;
    jobMargins.forEach(function(j) {
      var laborCost = j.laborHrs * techPayPerHr;
      var totalCost = j.partsCost + laborCost;
      j.margin = Math.round(((j.avgCharge - totalCost) / j.avgCharge) * 100);
    });
    html += '<div style="margin-bottom:8px;color:#4a6a8a;font-size:0.8em;">Based on $' + techPayPerHr + '/hr tech pay. Edit in code to match your rates.</div>';
    jobMargins.forEach(function(j) {
      var mColor = j.margin >= 50 ? '#00ff66' : j.margin >= 30 ? '#ff9f43' : '#ff4757';
      html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + mColor + '08;padding:12px 18px;margin-bottom:3px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">';
      html += '<div style="min-width:220px;color:#c0d8f0;">' + j.type + '</div>';
      html += '<div style="display:flex;gap:15px;align-items:center;">';
      html += '<div style="text-align:center;"><div style="color:#ffd700;font-weight:700;">$' + j.avgCharge + '</div><div style="color:#4a6a8a;font-size:0.65em;font-family:Orbitron;">CHARGE</div></div>';
      html += '<div style="text-align:center;"><div style="color:#ff6b9d;">$' + j.partsCost + '</div><div style="color:#4a6a8a;font-size:0.65em;font-family:Orbitron;">PARTS</div></div>';
      html += '<div style="text-align:center;"><div style="color:#ff9f43;">$' + Math.round(j.laborHrs * techPayPerHr) + '</div><div style="color:#4a6a8a;font-size:0.65em;font-family:Orbitron;">LABOR</div></div>';
      html += '<div style="text-align:center;min-width:60px;"><div style="color:' + mColor + ';font-weight:900;font-size:1.2em;">' + j.margin + '%</div><div style="color:#4a6a8a;font-size:0.65em;font-family:Orbitron;">MARGIN</div></div>';
      html += '</div></div>';
    });
    html += '</div>';

    // ====== CUSTOMER HEATMAP BY ZIP ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ff6b9d;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ff6b9d;border-radius:50%;box-shadow:0 0 8px #ff6b9d;display:inline-block;"></span>Customer Heatmap â€” Top Zip Codes</div>';
    // Build zip code data from Combined sheet
    var zipCounts = {};
    if (bm.recentBookings) {
      // We need zip from the raw data, approximate from locations
      bizLocations.slice(0, 20).forEach(function(l) {
        var locName = l[0];
        var count = l[1].total;
        // Use location name as proxy
        if (!zipCounts[locName]) zipCounts[locName] = 0;
        zipCounts[locName] += count;
      });
    }
    var zipSorted = Object.entries(zipCounts).sort(function(a,b){return b[1]-a[1];});
    var zipMax = zipSorted.length > 0 ? zipSorted[0][1] : 1;
    html += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
    zipSorted.slice(0, 20).forEach(function(z) {
      var intensity = Math.round((z[1] / zipMax) * 100);
      var alpha = (0.15 + (intensity / 100) * 0.85).toFixed(2);
      var size = Math.max(60, Math.min(120, 40 + z[1] * 2));
      html += '<div style="width:' + size + 'px;height:' + size + 'px;background:rgba(255,107,157,' + alpha + ');border:1px solid rgba(255,107,157,' + (parseFloat(alpha)*0.5).toFixed(2) + ');display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all 0.3s;" onmouseover="this.style.transform=\'scale(1.1)\'" onmouseout="this.style.transform=\'scale(1)\'">';
      html += '<div style="color:#fff;font-family:Orbitron;font-size:0.55em;text-align:center;letter-spacing:1px;">' + z[0].split(',')[0] + '</div>';
      html += '<div style="color:#fff;font-weight:900;font-size:1.3em;">' + z[1] + '</div>';
      html += '</div>';
    });
    html += '</div></div>';

    // ====== REAL P&L FROM PERCENTAGE REPORT ======
    var pm2 = global.profitMetrics || {};
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    if (pm2.revenue > 0 || pm2.expenses > 0) {
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#00ff66;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#00ff66;border-radius:50%;box-shadow:0 0 8px #00ff66;display:inline-block;"></span>P&L â€” ' + (pm2.currentMonth || 'Current Month').toUpperCase() + ' (FROM PERCENTAGE REPORT)</div>';
      html += '<div style="display:flex;gap:15px;flex-wrap:wrap;">';
      // Revenue
      html += '<div style="flex:1;min-width:200px;background:rgba(10,20,35,0.6);border:1px solid #00ff6615;padding:20px;text-align:center;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;">TOTAL COLLECTED</div>';
      html += '<div style="color:#00ff66;font-size:2.5em;font-weight:900;font-family:Orbitron;">$' + Math.round(pm2.revenue).toLocaleString() + '</div>';
      html += '</div>';
      // Expenses
      html += '<div style="flex:1;min-width:200px;background:rgba(10,20,35,0.6);border:1px solid #ff475715;padding:20px;text-align:center;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;">TOTAL EXPENSES</div>';
      html += '<div style="color:#ff4757;font-size:2.5em;font-weight:900;font-family:Orbitron;">$' + Math.round(pm2.expenses).toLocaleString() + '</div>';
      html += '</div>';
      // Profit
      var profitColor2 = pm2.profit >= 0 ? '#ffd700' : '#ff4757';
      html += '<div style="flex:1;min-width:200px;background:rgba(10,20,35,0.6);border:1px solid ' + profitColor2 + '15;padding:20px;text-align:center;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;">NET PROFIT</div>';
      html += '<div style="color:' + profitColor2 + ';font-size:2.5em;font-weight:900;font-family:Orbitron;">' + (pm2.profit < 0 ? '-' : '') + '$' + Math.abs(Math.round(pm2.profit)).toLocaleString() + '</div>';
      html += '<div style="margin-top:5px;color:' + profitColor2 + ';font-size:0.9em;font-weight:700;">' + pm2.margin + '% margin</div>';
      html += '</div>';
      html += '</div>';

      // Expense breakdown
      var expEntries2 = Object.entries(pm2.expenseBreakdown || {}).sort(function(a,b){return b[1]-a[1];});
      if (expEntries2.length > 0) {
        var maxExp2 = expEntries2[0][1];
        html += '<div style="margin-top:15px;">';
        expEntries2.forEach(function(e) {
          var pct2 = maxExp2 > 0 ? Math.round((e[1] / maxExp2) * 100) : 0;
          var barColor2 = e[0].includes('Labor') ? '#a855f7' : e[0].includes('Ads') ? '#00d4ff' : '#ff9f43';
          html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:3px;">';
          html += '<div style="min-width:140px;color:#7a9ab0;font-size:0.85em;">' + e[0] + '</div>';
          html += '<div style="flex:1;height:18px;background:#0a1520;position:relative;">';
          html += '<div style="height:100%;width:' + pct2 + '%;background:' + barColor2 + ';"></div>';
          html += '<div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);color:#c0d8f0;font-size:0.7em;font-weight:700;">$' + Math.round(e[1]).toLocaleString() + '</div>';
          html += '</div></div>';
        });
        html += '</div>';
      }

      // Tech payouts
      var techPay2 = Object.entries(pm2.techPayouts || {}).sort(function(a,b){return b[1]-a[1];});
      if (techPay2.length > 0) {
        html += '<div style="margin-top:15px;color:#4a6a8a;font-family:Orbitron;font-size:0.55em;letter-spacing:3px;margin-bottom:8px;">TECH PAYOUTS</div>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:6px;">';
        techPay2.forEach(function(t) {
          if (t[1] > 0) {
            html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #00ff6610;padding:10px;display:flex;justify-content:space-between;align-items:center;">';
            html += '<span style="color:#c0d8f0;font-weight:600;">' + t[0] + '</span>';
            html += '<span style="font-family:Orbitron;font-size:0.85em;color:#00ff66;">$' + Math.round(t[1]).toLocaleString() + '</span>';
            html += '</div>';
          }
        });
        html += '</div>';
      }

      // Ad ROI
      if (pm2.avgDailyAds > 0 && pm2.avgDailyRev > 0) {
        var adROI2 = (pm2.avgDailyRev / pm2.avgDailyAds).toFixed(2);
        var roiColor2 = adROI2 >= 5 ? '#00ff66' : adROI2 >= 2 ? '#ff9f43' : '#ff4757';
        html += '<div style="margin-top:15px;background:rgba(0,212,255,0.03);border:1px solid #00d4ff15;padding:16px;display:flex;justify-content:space-around;align-items:center;text-align:center;flex-wrap:wrap;gap:15px;">';
        html += '<div><div style="color:#4a6a8a;font-size:0.7em;">AVG DAILY REVENUE</div><div style="font-family:Orbitron;font-size:1.3em;color:#00ff66;">$' + Math.round(pm2.avgDailyRev) + '</div></div>';
        html += '<div><div style="color:#4a6a8a;font-size:0.7em;">AVG DAILY AD SPEND</div><div style="font-family:Orbitron;font-size:1.3em;color:#00d4ff;">$' + Math.round(pm2.avgDailyAds) + '</div></div>';
        html += '<div><div style="color:#4a6a8a;font-size:0.7em;">AD ROI</div><div style="font-family:Orbitron;font-size:1.8em;color:' + roiColor2 + ';">$' + adROI2 + '</div><div style="color:#4a6a8a;font-size:0.65em;">per $1 spent</div></div>';
        html += '</div>';
      }
    } else {
      html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ff9f43;text-transform:uppercase;margin-bottom:15px;">P&L â€” WAITING FOR DATA</div>';
      html += '<div style="color:#4a6a8a;padding:20px;border:1px solid #ff9f4320;">Profit sheet not loading. Verify PROFIT_SPREADSHEET_ID is set to 1TXwXvcjt1M9bl38_0GhjK6izRGjTTuaGTN8RAmEiFwc in Render environment variables.</div>';
    }
    html += '</div>';

    // ====== AUTO-TEXT SECTION (CONFIG) ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#55f7d8;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#55f7d8;border-radius:50%;box-shadow:0 0 8px #55f7d8;display:inline-block;"></span>Auto-Text System</div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:10px;">';
    html += '<div style="flex:1;min-width:250px;background:rgba(10,20,35,0.6);border:1px solid #55f7d815;padding:15px;">';
    html += '<div style="color:#55f7d8;font-weight:600;margin-bottom:8px;">Booking Confirmation</div>';
    html += '<div style="color:#4a6a8a;font-size:0.85em;">Auto-sends when status = "Booked"</div>';
    html += '<div style="color:#00ff66;font-family:Orbitron;font-size:0.6em;margin-top:8px;letter-spacing:2px;">ACTIVE</div>';
    html += '</div>';
    html += '<div style="flex:1;min-width:250px;background:rgba(10,20,35,0.6);border:1px solid #55f7d815;padding:15px;">';
    html += '<div style="color:#55f7d8;font-weight:600;margin-bottom:8px;">3-Day Follow-Up</div>';
    html += '<div style="color:#4a6a8a;font-size:0.85em;">Sends 3 days after job marked "DONE"</div>';
    html += '<div style="color:#00ff66;font-family:Orbitron;font-size:0.6em;margin-top:8px;letter-spacing:2px;">ACTIVE</div>';
    html += '</div>';
    html += '<div style="flex:1;min-width:250px;background:rgba(10,20,35,0.6);border:1px solid #55f7d815;padding:15px;">';
    html += '<div style="color:#55f7d8;font-weight:600;margin-bottom:8px;">Review Request</div>';
    html += '<div style="color:#4a6a8a;font-size:0.85em;">Sends 5 days after completion</div>';
    html += '<div style="color:#ff9f43;font-family:Orbitron;font-size:0.6em;margin-top:8px;letter-spacing:2px;">COMING SOON</div>';
    html += '</div>';
    html += '</div></div>';

    // ====== TEAM MANAGEMENT SECTION ======
    html += '<div style="max-width:1400px;margin:30px auto;padding:0 40px;">';

    // Section Header
    html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:25px;">';
    html += '<div style="width:10px;height:10px;background:#55f7d8;border-radius:50%;box-shadow:0 0 12px #55f7d8;animation:dotPulse 2s infinite;"></div>';
    html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#55f7d8;text-transform:uppercase;">Team Command Center</div>';
    html += '</div>';

    // Workload Overview Cards
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:25px;">';
    var techEntries2 = Object.entries(techPerf).sort(function(a,b){return b[1].total-a[1].total;});
    var totalTeamJobs = techEntries2.reduce(function(s,t){return s+t[1].total;},0);
    var avgLoad = techEntries2.length > 0 ? Math.round(totalTeamJobs / techEntries2.length) : 0;
    html += '<div style="background:rgba(10,20,35,0.7);border:1px solid #55f7d820;padding:20px;text-align:center;">';
    html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:3px;color:#4a6a8a;">TEAM SIZE</div>';
    html += '<div style="font-family:Orbitron;font-size:2.2em;color:#55f7d8;margin:8px 0;">' + techEntries2.length + '</div>';
    html += '</div>';
    html += '<div style="background:rgba(10,20,35,0.7);border:1px solid #55f7d820;padding:20px;text-align:center;">';
    html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:3px;color:#4a6a8a;">TOTAL JOBS</div>';
    html += '<div style="font-family:Orbitron;font-size:2.2em;color:#c084fc;margin:8px 0;">' + totalTeamJobs + '</div>';
    html += '</div>';
    html += '<div style="background:rgba(10,20,35,0.7);border:1px solid #55f7d820;padding:20px;text-align:center;">';
    html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:3px;color:#4a6a8a;">AVG PER TECH</div>';
    html += '<div style="font-family:Orbitron;font-size:2.2em;color:#ff9f43;margin:8px 0;">' + avgLoad + '</div>';
    html += '</div>';
    html += '</div>';

    // Individual Tech Scorecards
    html += '<div style="font-family:Orbitron;font-size:0.7em;letter-spacing:3px;color:#55f7d8;margin-bottom:15px;">TECHNICIAN SCORECARDS</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:15px;margin-bottom:30px;">';

    techEntries2.forEach(function(t, idx) {
      var s = t[1];
      var rate = s.total > 0 ? Math.round((s.completed / s.total) * 100) : 0;
      var cancelRate = s.total > 0 ? Math.round((s.cancelled / s.total) * 100) : 0;
      var avgResp = (s.avgResponseDays || []).length > 0 ? Math.round(s.avgResponseDays.reduce(function(a,b){return a+b;},0) / s.avgResponseDays.length) : 0;
      var deviation = s.total - avgLoad;

      // Grade
      var grade = 'C', gradeColor = '#ff9f43';
      if (rate >= 85 && s.total >= 10) { grade = 'A+'; gradeColor = '#00ff66'; }
      else if (rate >= 75 && s.total >= 8) { grade = 'A'; gradeColor = '#00ff66'; }
      else if (rate >= 65 && s.total >= 5) { grade = 'B'; gradeColor = '#55f7d8'; }
      else if (rate >= 50) { grade = 'C'; gradeColor = '#ff9f43'; }
      else { grade = 'D'; gradeColor = '#ff4757'; }

      // Workload status
      var wlStatus = 'BALANCED', wlColor = '#00ff66';
      if (deviation > avgLoad * 0.5) { wlStatus = 'OVERLOADED'; wlColor = '#ff4757'; }
      else if (deviation < -avgLoad * 0.3) { wlStatus = 'UNDERUTILIZED'; wlColor = '#ff9f43'; }

      // Medal for top 3
      var medal = '';
      if (idx === 0) medal = '<span style="color:#ffd700;font-size:1.2em;">&#9733;</span> ';
      else if (idx === 1) medal = '<span style="color:#c0c0c0;font-size:1em;">&#9733;</span> ';
      else if (idx === 2) medal = '<span style="color:#cd7f32;font-size:0.9em;">&#9733;</span> ';

      // Top equipment
      var topEquip = Object.entries(s.equipment || {}).sort(function(a,b){return b[1]-a[1];}).slice(0,3);
      // Top locations
      var topLocs = Object.entries(s.locations || {}).sort(function(a,b){return b[1]-a[1];}).slice(0,3);

      html += '<div style="background:rgba(10,20,35,0.7);border:1px solid #55f7d815;padding:20px;position:relative;overflow:hidden;">';
      html += '<div style="position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,' + gradeColor + ',transparent);animation:borderScan 3s linear infinite;"></div>';

      // Header: Name + Grade
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">';
      html += '<div>' + medal + '<span style="color:#c0d8f0;font-weight:700;font-size:1.15em;">' + t[0] + '</span></div>';
      html += '<div style="display:flex;align-items:center;gap:10px;">';
      html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:' + wlColor + ';padding:3px 8px;border:1px solid ' + wlColor + '30;background:' + wlColor + '10;">' + wlStatus + '</div>';
      html += '<div style="font-family:Orbitron;font-size:1.5em;font-weight:900;color:' + gradeColor + ';text-shadow:0 0 20px ' + gradeColor + '40;">' + grade + '</div>';
      html += '</div></div>';

      // Stats row
      html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;">';
      html += '<div style="text-align:center;"><div style="font-family:Orbitron;font-size:0.5em;color:#4a6a8a;letter-spacing:2px;">TOTAL</div><div style="font-family:Orbitron;font-size:1.3em;color:#c084fc;">' + s.total + '</div></div>';
      html += '<div style="text-align:center;"><div style="font-family:Orbitron;font-size:0.5em;color:#4a6a8a;letter-spacing:2px;">DONE</div><div style="font-family:Orbitron;font-size:1.3em;color:#00ff66;">' + s.completed + '</div></div>';
      html += '<div style="text-align:center;"><div style="font-family:Orbitron;font-size:0.5em;color:#4a6a8a;letter-spacing:2px;">CANCEL</div><div style="font-family:Orbitron;font-size:1.3em;color:#ff4757;">' + s.cancelled + '</div></div>';
      html += '<div style="text-align:center;"><div style="font-family:Orbitron;font-size:0.5em;color:#4a6a8a;letter-spacing:2px;">RATE</div><div style="font-family:Orbitron;font-size:1.3em;color:' + (rate >= 70 ? '#00ff66' : rate >= 50 ? '#ff9f43' : '#ff4757') + ';">' + rate + '%</div></div>';
      html += '</div>';

      // Completion bar
      html += '<div style="height:4px;background:#0a1520;margin-bottom:12px;border-radius:2px;overflow:hidden;">';
      html += '<div style="height:100%;width:' + rate + '%;background:linear-gradient(90deg,' + gradeColor + ',' + gradeColor + '80);border-radius:2px;"></div>';
      html += '</div>';

      // Activity row
      html += '<div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:0.85em;">';
      html += '<span style="color:#4a6a8a;">This week: <span style="color:#c0d8f0;">' + (s.thisWeekJobs || 0) + ' jobs</span></span>';
      html += '<span style="color:#4a6a8a;">Avg response: <span style="color:#c0d8f0;">' + avgResp + ' days</span></span>';
      html += '</div>';

      // Specialties
      if (topEquip.length > 0) {
        html += '<div style="margin-bottom:8px;">';
        html += '<div style="font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:#4a6a8a;margin-bottom:5px;">SPECIALTIES</div>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
        topEquip.forEach(function(e) {
          html += '<span style="padding:2px 8px;font-size:0.8em;border:1px solid #c084fc20;color:#c084fc;background:#c084fc08;">' + e[0] + ' (' + e[1] + ')</span>';
        });
        html += '</div></div>';
      }

      // Markets
      if (topLocs.length > 0) {
        html += '<div>';
        html += '<div style="font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:#4a6a8a;margin-bottom:5px;">MARKETS</div>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
        topLocs.forEach(function(l) {
          html += '<span style="padding:2px 8px;font-size:0.8em;border:1px solid #ff6b9d20;color:#ff6b9d;background:#ff6b9d08;">' + l[0].split(',')[0] + ' (' + l[1] + ')</span>';
        });
        html += '</div></div>';
      }

      html += '</div>'; // close card
    });
    html += '</div>'; // close grid

    // Smart Task Assignment Panel
    html += '<div style="background:rgba(10,20,35,0.7);border:1px solid #55f7d815;padding:25px;margin-bottom:25px;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">';
    html += '<div style="font-family:Orbitron;font-size:0.7em;letter-spacing:3px;color:#55f7d8;">SMART TASK ASSIGNMENT</div>';
    html += '<div onclick="loadTaskAssignments()" style="padding:6px 15px;border:1px solid #55f7d840;color:#55f7d8;font-family:Orbitron;font-size:0.55em;letter-spacing:2px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background=\'#55f7d810\'" onmouseout="this.style.background=\'transparent\'">GENERATE ASSIGNMENTS</div>';
    html += '</div>';
    html += '<div id="task-assignments" style="color:#4a6a8a;font-size:0.9em;">Click "Generate Assignments" to auto-assign unassigned jobs to the best available technician based on skills, location, and workload.</div>';
    html += '</div>';

    // AI Team Coaching
    html += '<div style="background:rgba(10,20,35,0.7);border:1px solid #c084fc15;padding:25px;margin-bottom:25px;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">';
    html += '<div style="font-family:Orbitron;font-size:0.7em;letter-spacing:3px;color:#c084fc;">AI TEAM COACHING</div>';
    html += '<div onclick="loadTeamCoaching()" style="padding:6px 15px;border:1px solid #c084fc40;color:#c084fc;font-family:Orbitron;font-size:0.55em;letter-spacing:2px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background=\'#c084fc10\'" onmouseout="this.style.background=\'transparent\'">GENERATE COACHING REPORT</div>';
    html += '</div>';
    html += '<div id="team-coaching" style="color:#4a6a8a;font-size:0.9em;">Click to get AI-generated individual coaching recommendations for each technician based on their performance data.</div>';
    html += '</div>';

    html += '</div>'; // close team section

    // Athena Footer
    html += '<div style="text-align:center;padding:40px 20px;font-family:Orbitron;font-size:0.6em;letter-spacing:4px;color:#1a2a3a;border-top:1px solid #0a1520;">A.T.H.E.N.A. v5.0 // Wildwood Small Engine Repair CRM + Team Command // Powered by Claude AI</div>';

    html += '</div>'; // close z-index wrapper
    html += '</div>'; // close #athena-panel
    html += '</div>'; // close .swipe-wrapper

    // ====== SWIPE / TAB SWITCH JAVASCRIPT ======
    html += '<script>';

    // AI Business Insights generator
    html += 'async function generateBizInsights(){';
    html += '  var div=document.getElementById("biz-insights");';
    html += '  div.innerHTML="<div style=\\"color:#c084fc;\\">Analyzing CRM data...</div>";';
    html += '  try{var r=await fetch("/business/insights");var d=await r.json();';
    html += '  if(d.insights){div.innerHTML="<div style=\\"color:#c0d8f0;white-space:pre-wrap;line-height:1.8;font-size:0.95em;\\">"+d.insights+"</div>";}';
    html += '  else{div.innerHTML="<div style=\\"color:#ff4757;\\">Error: "+d.error+"</div>";}}';
    html += '  catch(e){div.innerHTML="<div style=\\"color:#ff4757;\\">Failed: "+e.message+"</div>";}';
    html += '}';

    // Customer Search
    html += 'async function searchCustomer(){';
    html += '  var q=document.getElementById("cust-search").value;if(!q)return;';
    html += '  var div=document.getElementById("cust-results");div.innerHTML="<div style=\\"color:#00d4ff;\\">Searching...</div>";';
    html += '  try{var r=await fetch("/business/search?q="+encodeURIComponent(q));var d=await r.json();';
    html += '  if(d.results.length===0){div.innerHTML="<div style=\\"color:#4a6a8a;padding:15px;\\">No customers found.</div>";return;}';
    html += '  var h="";d.results.forEach(function(c){';
    html += '    h+="<div style=\\"background:rgba(10,20,35,0.6);border:1px solid #00d4ff10;padding:14px 18px;margin-bottom:6px;\\">";';
    html += '    h+="<div style=\\"display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;\\">";';
    html += '    h+="<div style=\\"color:#00d4ff;font-weight:700;\\">"+c.name+"</div>";';
    html += '    h+="<div style=\\"color:#4a6a8a;\\">"+c.phone+"</div>";';
    html += '    h+="<div style=\\"color:#4a6a8a;\\">"+c.city+"</div>";';
    html += '    var sColor=c.status.toLowerCase().includes("booked")?"#00ff66":c.status.toLowerCase().includes("cancel")?"#ff4757":"#ff9f43";';
    html += '    h+="<div style=\\"font-family:Orbitron;font-size:0.6em;letter-spacing:2px;padding:3px 8px;border:1px solid "+sColor+"30;color:"+sColor+";\\">"+(c.status||"N/A").toUpperCase()+"</div>";';
    html += '    h+="</div>";';
    html += '    h+="<div style=\\"margin-top:6px;color:#4a6a8a;font-size:0.85em;\\">"+c.equip+" "+c.brand+" â€” "+c.issue+"</div>";';
    html += '    h+="<div style=\\"margin-top:6px;display:flex;gap:8px;\\">";';
    html += '    h+="<div onclick=\\"sendConfirmText(\'"+c.phone+"\'  ,\'"+c.name.replace(/\'/g,"")+"\')\\" style=\\"padding:5px 12px;border:1px solid #55f7d830;color:#55f7d8;font-family:Orbitron;font-size:0.55em;letter-spacing:1px;cursor:pointer;\\">CONFIRM TEXT</div>";';
    html += '    h+="<div onclick=\\"sendFollowUp(\'" +c.phone+"\'  ,\'"+c.name.replace(/\'/g,"")+"\')\\" style=\\"padding:5px 12px;border:1px solid #ff9f4330;color:#ff9f43;font-family:Orbitron;font-size:0.55em;letter-spacing:1px;cursor:pointer;\\">FOLLOW-UP</div>";';
    html += '    h+="</div></div>";';
    html += '  });div.innerHTML=h;}catch(e){div.innerHTML="<div style=\\"color:#ff4757;\\">Error: "+e.message+"</div>";}';
    html += '}';

    // Send confirmation text
    html += 'async function sendConfirmText(phone,name){';
    html += '  try{var r=await fetch("/business/confirm-text",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:phone,name:name})});';
    html += '  var d=await r.json();alert(d.success?"Confirmation sent to "+name:"Error: "+d.error);}catch(e){alert("Failed: "+e.message);}';
    html += '}';

    // Send follow-up text
    html += 'async function sendFollowUp(phone,name){';
    html += '  try{var r=await fetch("/business/followup-text",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:phone,name:name})});';
    html += '  var d=await r.json();alert(d.success?"Follow-up sent to "+name:"Error: "+d.error);}catch(e){alert("Failed: "+e.message);}';
    html += '}';

    // Job Timer
    html += 'var timerInterval=null;var timerSeconds=0;var timerRunning=false;';
    html += 'function startJobTimer(){';
    html += '  var name=document.getElementById("timer-job-name").value;if(!name){alert("Enter job name");return;}';
    html += '  if(timerRunning)return;timerRunning=true;timerSeconds=0;';
    html += '  document.getElementById("timer-job-label").textContent="Timing: "+name;';
    html += '  document.getElementById("timer-start-btn").style.color="#4a6a8a";';
    html += '  timerInterval=setInterval(function(){timerSeconds++;';
    html += '    var h=String(Math.floor(timerSeconds/3600)).padStart(2,"0");';
    html += '    var m=String(Math.floor((timerSeconds%3600)/60)).padStart(2,"0");';
    html += '    var s=String(timerSeconds%60).padStart(2,"0");';
    html += '    document.getElementById("timer-display").textContent=h+":"+m+":"+s;';
    html += '  },1000);';
    html += '}';
    html += 'function stopJobTimer(){';
    html += '  if(!timerRunning)return;clearInterval(timerInterval);timerRunning=false;';
    html += '  var name=document.getElementById("timer-job-name").value;';
    html += '  var mins=Math.round(timerSeconds/60);';
    html += '  var dur=document.getElementById("timer-display").textContent;';
    html += '  document.getElementById("timer-job-label").textContent="Logged: "+name+" ("+dur+")";';
    html += '  document.getElementById("timer-start-btn").style.color="#00ff66";';
    html += '  document.getElementById("timer-job-name").value="";';
    html += '  fetch("/business/log-timer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jobName:name,duration:dur,minutes:mins})});';
    html += '  var hist=document.getElementById("timer-history");';
    html += '  hist.innerHTML="<div style=\\"background:rgba(0,255,102,0.03);border:1px solid #00ff6610;padding:8px 12px;margin-bottom:4px;display:flex;justify-content:space-between;\\"><span style=\\"color:#c0d8f0;\\">"+name+"</span><span style=\\"color:#00ff66;\\">"+dur+" ("+mins+" min)</span></div>"+hist.innerHTML;';
    html += '  timerSeconds=0;document.getElementById("timer-display").textContent="00:00:00";';
    html += '}';

    // Team Management JS
    html += 'async function loadTaskAssignments(){';
    html += '  var div=document.getElementById("task-assignments");';
    html += '  div.innerHTML="<div style=\\"color:#55f7d8;\\">Analyzing team skills, locations, and workload...</div>";';
    html += '  try{var r=await fetch("/team/assign");var d=await r.json();';
    html += '  if(!d.assignments||d.assignments.length===0){div.innerHTML="<div style=\\"color:#00ff66;padding:10px;\\">All jobs are assigned. No action needed.</div>";return;}';
    html += '  var h="<div style=\\"color:#4a6a8a;font-size:0.85em;margin-bottom:10px;\\">" + d.unassignedCount + " unassigned jobs found</div>";';
    html += '  d.assignments.forEach(function(a){';
    html += '    h+="<div style=\\"background:rgba(85,247,216,0.03);border:1px solid #55f7d815;padding:12px 16px;margin-bottom:6px;\\">";';
    html += '    h+="<div style=\\"display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;\\">";';
    html += '    h+="<div style=\\"color:#c0d8f0;font-weight:600;\\">"+a.job+"</div>";';
    html += '    h+="<div style=\\"font-family:Orbitron;font-size:0.6em;letter-spacing:2px;padding:3px 10px;border:1px solid #55f7d840;color:#55f7d8;background:#55f7d810;\\">ASSIGN â†’ "+a.recommendedTech+"</div>";';
    html += '    h+="</div>";';
    html += '    h+="<div style=\\"margin-top:5px;color:#4a6a8a;font-size:0.85em;\\">"+(a.location||"")+" â€” "+(a.equipment||"")+"</div>";';
    html += '    h+="<div style=\\"margin-top:4px;color:#55f7d860;font-size:0.8em;font-style:italic;\\">Reason: "+a.reasoning+"</div>";';
    html += '    h+="</div>";';
    html += '  });div.innerHTML=h;}catch(e){div.innerHTML="<div style=\\"color:#ff4757;\\">Error: "+e.message+"</div>";}';
    html += '}';

    html += 'async function loadTeamCoaching(){';
    html += '  var div=document.getElementById("team-coaching");';
    html += '  div.innerHTML="<div style=\\"color:#c084fc;\\">Generating individual coaching reports...</div>";';
    html += '  try{var r=await fetch("/team/coaching");var d=await r.json();';
    html += '  if(d.coaching){div.innerHTML="<div style=\\"color:#c0d8f0;white-space:pre-wrap;line-height:1.8;font-size:0.95em;\\">"+d.coaching+"</div>";}';
    html += '  else{div.innerHTML="<div style=\\"color:#ff4757;\\">Error: "+(d.error||"Unknown")+"</div>";}}';
    html += '  catch(e){div.innerHTML="<div style=\\"color:#ff4757;\\">Failed: "+e.message+"</div>";}';
    html += '}';

    html += 'var currentPanel = 0;';
    html += 'var wrapper = document.getElementById("swipe-wrapper");';

    // Switch function
    html += 'function switchPanel(idx) {';
    html += '  currentPanel = idx;';
    html += '  wrapper.style.transform = "translateX(-" + (idx * 100) + "vw)";';
    // Update tab buttons
    html += '  var tabs = document.querySelectorAll(".tab-btn");';
    html += '  tabs.forEach(function(t){ t.classList.remove("active"); });';
    html += '  tabs[idx].classList.add("active");';
    // Update dots
    html += '  var dots = document.querySelectorAll(".swipe-dot");';
    html += '  dots.forEach(function(d){ d.classList.remove("active"); });';
    html += '  dots[idx].classList.add("active");';
    // Change body accent color
    html += '  document.body.style.transition = "background 0.5s";';
    html += '}';

    // Touch swipe support
    html += 'var touchStartX = 0;';
    html += 'var touchEndX = 0;';
    html += 'document.addEventListener("touchstart", function(e) { touchStartX = e.changedTouches[0].screenX; }, false);';
    html += 'document.addEventListener("touchend", function(e) {';
    html += '  touchEndX = e.changedTouches[0].screenX;';
    html += '  var diff = touchStartX - touchEndX;';
    html += '  if (Math.abs(diff) > 60) {'; // minimum swipe distance
    html += '    if (diff > 0 && currentPanel < 1) switchPanel(currentPanel + 1);'; // swipe left
    html += '    if (diff < 0 && currentPanel > 0) switchPanel(currentPanel - 1);'; // swipe right
    html += '  }';
    html += '}, false);';

    // Keyboard arrow support
    html += 'document.addEventListener("keydown", function(e) {';
    html += '  if (e.key === "ArrowRight" && currentPanel < 1) switchPanel(1);';
    html += '  if (e.key === "ArrowLeft" && currentPanel > 0) switchPanel(0);';
    html += '});';

    html += '<\/script>';

    // Mobile padding fix
    html += '<script>';
    html += 'if(window.innerWidth<=768){document.querySelectorAll("[style]").forEach(function(el){';
    html += '  var s=el.getAttribute("style")||"";';
    html += '  if(s.indexOf("0 40px")>-1||s.indexOf("0px 40px")>-1){el.style.paddingLeft="12px";el.style.paddingRight="12px";}';
    html += '  if(s.indexOf("repeat(3,")>-1||s.indexOf("repeat(3, ")>-1){el.style.gridTemplateColumns="1fr";}';
    html += '  if(s.indexOf("repeat(4,")>-1||s.indexOf("repeat(4, ")>-1){el.style.gridTemplateColumns="repeat(2,1fr)";}';
    html += '});}';
    html += '<\/script>';

    html += '</body></html>';
    res.send(html);
  } catch (err) {
    console.error("Dashboard error:", err.stack || err.message);
    res.status(500).json({ error: err.message, stack: (err.stack || '').split('\n').slice(0,5) });
  }
});

/* ===========================
   POST /chat â€” Browser voice chat
=========================== */

var webChatHistory = {};

/* ===========================
   GET /business â€” CRM Business Dashboard
=========================== */

app.get('/business', requireAuth('owner'), async function(req, res) {
  try {
    var bizContext = await buildBusinessContext();
    // Fetch Tookan data in parallel (non-blocking, uses 10-min cache)
    buildTookanContext().catch(function(e) { console.log("Tookan bg fetch: " + e.message); });
    var tabs = [];
    try { tabs = await getAllTabNames(); } catch(e) { tabs = []; }

    // Read directly from global.bizMetrics (no regex parsing!)
    var bm = global.bizMetrics || {};
    var totalBooked = bm.totalBooked || 0;
    var totalCompleted = bm.totalCompleted || 0;
    var totalCancelled = bm.totalCancelled || 0;
    var totalReturn = bm.totalReturn || 0;
    var totalAssigned = bm.totalAssigned || 0;
    var promoReplies = bm.promoReplies || 0;
    var totalLocations = Object.keys(bm.locationStats || {}).length;
    var totalLeads = bm.totalLeads || 0;
    var conversionRate = bm.conversionRate || 0;
    var thisMonthCalls = bm.thisMonthCalls || 0;
    var lastMonthCalls = bm.lastMonthCalls || 0;
    var monthGrowth = bm.monthGrowth || 0;
    var weeklyCalls = bm.weeklyCalls || 0;
    var avgBookingDays = bm.avgBookingDays || 0;
    var sheetsRead = bm.sheetsRead || 0;
    var tabsReadCount = bm.tabsRead || 0;
    var totalJobRows = bm.totalJobRows || 0;

    var todayBookings = (bm.todayBookings || []).map(function(b) {
      return b.name + ' (' + b.location + ') â€” ' + b.equip + ': ' + b.issue + ' [Tech: ' + b.tech + ']';
    });
    var reschedule = (bm.needsReschedule || []).map(function(n) {
      return n.name + ' (' + n.location + ') â€” ' + n.phone;
    });
    var locationBreakdown = Object.entries(bm.locationStats || {}).sort(function(a,b){return b[1].total-a[1].total;}).map(function(l) {
      return l[0] + ': ' + l[1].total + ' total, ' + l[1].booked + ' booked, ' + l[1].completed + ' completed, ' + l[1].cancelled + ' cancelled';
    });
    // Merge techs from CRM + Profit Sheet
    var allTechMap = {};
    Object.entries(bm.techStats || {}).forEach(function(t) {
      allTechMap[t[0]] = { total: t[1].total, completed: t[1].completed, cancelled: t[1].cancelled, payout: 0 };
    });
    // Add techs from profit sheet that might not be in CRM
    var pmTech = global.profitMetrics || {};
    if (pmTech.techPayouts) {
      Object.entries(pmTech.techPayouts).forEach(function(t) {
        if (!allTechMap[t[0]]) allTechMap[t[0]] = { total: 0, completed: 0, cancelled: 0, payout: 0 };
        allTechMap[t[0]].payout = t[1];
      });
    }
    // Add yearly payouts
    if (pmTech.yearlyTechPayouts) {
      Object.entries(pmTech.yearlyTechPayouts).forEach(function(t) {
        if (!allTechMap[t[0]]) allTechMap[t[0]] = { total: 0, completed: 0, cancelled: 0, payout: 0, yearlyPay: t[1] };
        else allTechMap[t[0]].yearlyPay = t[1];
      });
    }
    var techs = Object.entries(allTechMap).sort(function(a,b){ return (b[1].payout || b[1].total) - (a[1].payout || a[1].total); }).map(function(t) {
      var s = t[1]; var rate = s.total > 0 ? Math.round((s.completed/s.total)*100) : 0;
      var info = t[0];
      if (s.total > 0) info += ': ' + s.total + ' jobs (' + s.completed + ' completed, ' + rate + '% rate)';
      if (s.payout > 0) info += ' Â· $' + Math.round(s.payout).toLocaleString() + ' this month';
      if (!s.total && s.payout > 0) info += ': $' + Math.round(s.payout).toLocaleString() + ' this month';
      return info;
    });

    var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>J.A.R.V.I.S. â€” Business Command Center</title>';
    html += '<style>';

    // Base
    html += '@import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap");';
    html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
    html += 'body { background: #020810; color: #c0d8f0; font-family: "Rajdhani", sans-serif; min-height: 100vh; overflow-x: hidden; }';

    // Animated background
    html += '.bg-grid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }';
    html += '.bg-grid::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(168,85,247,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(168,85,247,0.03) 1px, transparent 1px); background-size: 60px 60px; animation: gridMove 20s linear infinite; }';
    html += '@keyframes gridMove { 0% { background-position: 0 0; } 100% { background-position: 60px 60px; } }';

    // Scan line
    html += '.scan-line { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #a855f7, transparent); z-index: 2; animation: scanDown 8s linear infinite; pointer-events: none; }';
    html += '@keyframes scanDown { 0% { top: -2px; } 100% { top: 100%; } }';

    // Corner decorations
    html += '.corner { position: fixed; width: 30px; height: 30px; z-index: 3; pointer-events: none; }';
    html += '.corner-tl { top: 10px; left: 10px; border-top: 2px solid #a855f730; border-left: 2px solid #a855f730; }';
    html += '.corner-tr { top: 10px; right: 10px; border-top: 2px solid #a855f730; border-right: 2px solid #a855f730; }';
    html += '.corner-bl { bottom: 10px; left: 10px; border-bottom: 2px solid #a855f730; border-left: 2px solid #a855f730; }';
    html += '.corner-br { bottom: 10px; right: 10px; border-bottom: 2px solid #a855f730; border-right: 2px solid #a855f730; }';

    // Content
    html += '.content { position: relative; z-index: 4; }';

    // Header
    html += '.header { text-align: center; padding: 40px 20px 20px; }';
    html += '.jarvis-title { font-family: "Orbitron"; font-size: 3em; font-weight: 900; letter-spacing: 15px; background: linear-gradient(135deg, #a855f7, #7c3aed, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: none; filter: drop-shadow(0 0 30px rgba(168,85,247,0.4)); }';

    // Status bar
    html += '.status-bar { display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap; }';
    html += '.status-item { display: flex; align-items: center; gap: 6px; font-family: "Orbitron"; font-size: 0.6em; letter-spacing: 2px; color: #4a6a8a; }';
    html += '.status-dot { width: 6px; height: 6px; border-radius: 50%; animation: pulse 2s infinite; }';
    html += '.status-dot.green { background: #00ff66; box-shadow: 0 0 10px #00ff66; }';
    html += '.status-dot.purple { background: #a855f7; box-shadow: 0 0 10px #a855f7; }';
    html += '.status-dot.orange { background: #ff9f43; box-shadow: 0 0 10px #ff9f43; }';
    html += '@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }';

    // Stats Grid
    html += '.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; padding: 30px 40px; max-width: 1400px; margin: 0 auto; }';
    html += '.card { background: rgba(10,20,35,0.8); border: 1px solid #a855f715; padding: 25px; position: relative; overflow: hidden; --accent: #a855f7; animation: cardIn 0.6s ease-out both; }';
    html += '.card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--accent), transparent); opacity: 0.6; }';
    html += '@keyframes cardIn { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }';
    html += '.card:nth-child(1) { --accent: #a855f7; }';
    html += '.card:nth-child(2) { --accent: #00ff66; animation-delay: 0.1s; }';
    html += '.card:nth-child(3) { --accent: #ff4757; animation-delay: 0.2s; }';
    html += '.card:nth-child(4) { --accent: #00d4ff; animation-delay: 0.3s; }';
    html += '.card:nth-child(5) { --accent: #ff9f43; animation-delay: 0.4s; }';
    html += '.card:nth-child(6) { --accent: #55f7d8; animation-delay: 0.5s; }';
    html += '.card .label { font-family: "Orbitron"; font-size: 0.65em; letter-spacing: 3px; color: #4a6a8a; text-transform: uppercase; }';
    html += '.card .value { font-family: "Orbitron"; font-size: 3em; font-weight: 700; margin: 15px 0 8px; color: var(--accent); text-shadow: 0 0 30px color-mix(in srgb, var(--accent) 30%, transparent); }';
    html += '.card .sub { font-size: 0.95em; color: #3a5a7a; letter-spacing: 1px; }';
    html += '.card .bar { height: 3px; background: #0a1520; margin-top: 15px; border-radius: 2px; overflow: hidden; }';
    html += '.card .bar-fill { height: 100%; border-radius: 2px; animation: barGrow 2s ease-out both; }';
    html += '@keyframes barGrow { 0% { width: 0; } }';

    // Section styling
    html += '.section { max-width: 1400px; margin: 0 auto; padding: 0 40px 30px; }';
    html += '.section-title { font-family: "Orbitron"; font-size: 0.8em; letter-spacing: 5px; color: #a855f7; text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }';
    html += '.section-title::before { content: ""; width: 8px; height: 8px; background: #a855f7; border-radius: 50%; box-shadow: 0 0 8px #a855f7; }';

    // List items
    html += '.list-item { background: rgba(10,20,35,0.6); border: 1px solid #a855f710; padding: 12px 16px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }';
    html += '.list-item:hover { border-color: #a855f740; background: rgba(168,85,247,0.05); }';
    html += '.list-item .name { color: #c0d8f0; font-weight: 500; }';
    html += '.list-item .detail { color: #4a6a8a; font-size: 0.9em; }';
    html += '.list-item .status-badge { font-family: "Orbitron"; font-size: 0.6em; letter-spacing: 2px; padding: 4px 10px; border: 1px solid; }';
    html += '.badge-booked { color: #00ff66; border-color: #00ff6640; }';
    html += '.badge-cancel { color: #ff4757; border-color: #ff475740; }';
    html += '.badge-resched { color: #ff9f43; border-color: #ff9f4340; }';

    // Actions
    html += '.actions { display: flex; justify-content: center; gap: 15px; padding: 20px 40px; flex-wrap: wrap; }';
    html += '.holo-btn { font-family: "Orbitron"; font-size: 0.75em; letter-spacing: 3px; padding: 14px 30px; background: transparent; border: 1px solid #a855f730; color: #a855f7; text-decoration: none; text-transform: uppercase; position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer; }';
    html += '.holo-btn:hover { background: #a855f715; border-color: #a855f7; box-shadow: 0 0 30px #a855f720, inset 0 0 30px #a855f710; }';
    html += '.holo-btn.green { border-color: #00ff6630; color: #00ff66; }';
    html += '.holo-btn.green:hover { background: #00ff6615; border-color: #00ff66; }';

    // Location chips
    html += '.loc-grid { display: flex; flex-wrap: wrap; gap: 8px; }';
    html += '.loc-chip { background: rgba(168,85,247,0.03); border: 1px solid #a855f720; padding: 10px 16px; font-size: 0.85em; color: #7a9ab0; cursor: pointer; transition: all 0.3s; position: relative; }';
    html += '.loc-chip:hover { border-color: #a855f7; color: #a855f7; background: rgba(168,85,247,0.08); }';
    html += '.loc-chip .count { font-family: "Orbitron"; font-size: 0.7em; color: #a855f7; margin-left: 6px; }';

    // Clock
    html += '.clock { font-family: "Orbitron"; font-size: 0.7em; letter-spacing: 5px; color: #2a4a6a; text-align: center; padding: 30px; }';

    // Footer
    html += '.footer { text-align: center; padding: 20px; font-family: "Orbitron"; font-size: 0.6em; letter-spacing: 4px; color: #1a2a3a; border-top: 1px solid #0a1520; }';

    // Particles
    html += '.particle { position: fixed; width: 2px; height: 2px; background: #a855f7; border-radius: 50%; pointer-events: none; z-index: 1; opacity: 0; animation: particleFloat 8s linear infinite; }';
    html += '@keyframes particleFloat { 0% { opacity: 0; transform: translateY(100vh); } 10% { opacity: 0.6; } 90% { opacity: 0.6; } 100% { opacity: 0; transform: translateY(-20vh); } }';

    // Modal
    html += '#tab-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(2,8,16,0.95); z-index:100; overflow-y:auto; }';

    // Mobile responsive
    html += '@media(max-width:768px){';
    html += '.grid{grid-template-columns:repeat(2,1fr)!important;padding:15px 12px!important;gap:10px!important;}';
    html += '.section{padding-left:12px!important;padding-right:12px!important;}';
    html += '.card{padding:15px!important;}';
    html += '.card .value{font-size:2em!important;}';
    html += '[style*="max-width:1400px"]{padding-left:12px!important;padding-right:12px!important;}';
    html += '[style*="padding:0 40px"]{padding-left:12px!important;padding-right:12px!important;}';
    html += '[style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr!important;}';
    html += '[style*="grid-template-columns:repeat(4"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '[style*="minmax(300px"]{grid-template-columns:1fr!important;}';
    html += '[style*="minmax(280px"]{grid-template-columns:1fr!important;}';
    html += '[style*="minmax(200px"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '[style*="minmax(180px"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '[style*="minmax(170px"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '.status-bar{gap:10px!important;} .status-item{font-size:0.6em!important;}';
    html += '.loc-chip{font-size:0.7em!important;padding:6px 8px!important;}';
    html += '[style*="display:flex"][style*="justify-content:center"][style*="gap:0"]{flex-wrap:wrap!important;}';
    html += '[style*="font-size:2.8em"],[style*="font-size:3em"],[style*="font-size:2.5em"]{font-size:1.6em!important;}';
    html += '[style*="font-size:1.6em"]{font-size:1.1em!important;}';
    html += '[style*="letter-spacing:8px"],[style*="letter-spacing:6px"],[style*="letter-spacing:5px"]{letter-spacing:2px!important;}';
    html += 'table{font-size:0.65em!important;} th,td{padding:5px 4px!important;}';
    html += '[style*="overflow-x"]{overflow-x:auto!important;-webkit-overflow-scrolling:touch;}';
    html += 'select,input[type="text"]{font-size:0.55em!important;max-width:120px;}';
    html += '[style*="display:flex"][style*="flex-wrap:wrap"][style*="gap:8px"]{gap:5px!important;}';
    html += '}';
    html += '@media(max-width:480px){';
    html += '.grid{grid-template-columns:1fr!important;}';
    html += '[style*="minmax(200px"]{grid-template-columns:1fr!important;}';
    html += '[style*="minmax(180px"]{grid-template-columns:1fr!important;}';
    html += '[style*="minmax(150px"]{grid-template-columns:repeat(2,1fr)!important;}';
    html += '}';

    html += '</style></head><body>';

    // Background effects
    html += '<div class="bg-grid"></div>';
    html += '<div class="scan-line"></div>';
    html += '<div class="corner corner-tl"></div><div class="corner corner-tr"></div><div class="corner corner-bl"></div><div class="corner corner-br"></div>';

    // Particles (purple)
    for (var p = 0; p < 15; p++) {
      var left = Math.floor(Math.random() * 100);
      var delay = (Math.random() * 8).toFixed(1);
      html += '<div class="particle" style="left:' + left + '%;animation-delay:' + delay + 's;"></div>';
    }

    html += '<div class="content">';

    // Header
    var now = new Date();
    var dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'America/Chicago' });
    var timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZone: 'America/Chicago' });

    html += '<div class="header">';
    html += '<div class="jarvis-title">WILDWOOD CRM</div>';
    html += '<div style="font-family:Rajdhani;font-size:1.1em;letter-spacing:8px;color:#3a5a7a;margin-top:5px;text-transform:uppercase;">Business Command Center</div>';
    html += '<div style="font-family:Rajdhani;font-size:0.95em;letter-spacing:4px;color:#a855f780;margin-top:3px;">' + dateStr + ' // ' + timeStr + '</div>';

    // === TAB NAVIGATION ===
    html += '<div style="display:flex;justify-content:center;gap:0;margin-top:20px;margin-bottom:15px;">';
    html += '<a href="/dashboard" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">JARVIS</a>';
    html += '<a href="/business" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#a855f7;border:1px solid #a855f740;text-decoration:none;background:rgba(168,85,247,0.1);box-shadow:0 0 15px rgba(168,85,247,0.1);">ATHENA</a>';
    html += '<a href="/tookan" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TOOKAN</a>';
    html += '<a href="/business/chart" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">CHARTS</a>';
    html += '<a href="/analytics" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">ANALYTICS</a>';
    html += '<a href="/ads" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">GOOGLE ADS</a>';
    html += '<a href="/square" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">SQUARE</a><a href="/discord" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">DISCORD</a><a href="/followup" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">FOLLOW UP</a><a href="/ai" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AI</a><a href="/forecast" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">FORECAST</a><a href="/seo" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">SEO</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AUDIT</a><a href="/auth/logout" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#ef4444;border:1px solid #ef444440;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">LOGOUT</a>';
    html += '</div>';
    var tkForCount = global.tookanData || {};
    var allTechNames = {};
    techs.forEach(function(t) { allTechNames[t.split(':')[0].trim().toLowerCase()] = true; });
    (tkForCount.agents || []).forEach(function(a) { if (a.name) allTechNames[a.name.toLowerCase()] = true; });
    Object.keys(tkForCount.tasksByTech || {}).forEach(function(t) { allTechNames[t.toLowerCase()] = true; });
    (bm.techList || []).forEach(function(t) { if (t.name) allTechNames[t.name.toLowerCase()] = true; });
    var displayTechCount = Math.max(techs.length, Object.keys(allTechNames).length);
    html += '<div class="status-bar">';
    html += '<div class="status-item"><div class="status-dot green"></div>CRM ONLINE</div>';
    html += '<div class="status-item"><div class="status-dot purple"></div>' + totalLocations + ' LOCATIONS</div>';
    html += '<div class="status-item"><div class="status-dot ' + (totalJobRows > 100 ? 'green' : 'orange') + '"></div>' + totalJobRows + ' RECORDS FROM ' + sheetsRead + ' SHEETS</div>';
    html += '<div class="status-item"><div class="status-dot purple"></div>' + displayTechCount + ' TECHNICIANS</div>';
    html += '<div class="status-item"><div class="status-dot ' + (todayBookings.length > 0 ? 'orange' : 'green') + '"></div>' + todayBookings.length + ' TODAY</div>';
    html += '<div class="status-item"><div class="status-dot ' + (reschedule.length > 0 ? 'orange' : 'green') + '"></div>' + reschedule.length + ' RESCHEDULE</div>';
    html += '</div>';
    html += '</div>';

    // Stats Grid
    html += '<div class="grid">';

    html += '<div class="card"><div class="label">Booked</div><div class="value">' + totalBooked + '</div><div class="sub">CRM status = Booked (may include serviced if not updated)</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, Math.round(totalBooked/Math.max(1,totalLeads)*100)) + '%;background:#a855f7;"></div></div></div>';

    html += '<div class="card"><div class="label">Dispatched</div><div class="value">' + totalAssigned + '</div><div class="sub">Assigned/Acknowledged in Tookan</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, Math.round(totalAssigned/Math.max(1,totalLeads)*100)) + '%;background:#00d4ff;"></div></div></div>';

    html += '<div class="card"><div class="label">Completed Jobs</div><div class="value">' + totalCompleted + '</div><div class="sub">Status: completed/done/paid/serviced</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, Math.round(totalCompleted/Math.max(1,totalLeads)*100)) + '%;background:#00ff66;"></div></div></div>';

    html += '<div class="card"><div class="label">Cancelled</div><div class="value">' + totalCancelled + '</div><div class="sub">' + (parseInt(totalCancelled) > parseInt(totalCompleted) / 5 ? 'HIGH â€” needs attention' : 'Within normal range') + '</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, parseInt(totalCancelled) * 2) + '%;background:#ff4757;"></div></div></div>';

    html += '<div class="card"><div class="label">Today\'s Jobs</div><div class="value">' + todayBookings.length + '</div><div class="sub">' + (todayBookings.length > 0 ? 'Jobs scheduled today' : 'No jobs today') + '</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, todayBookings.length * 15) + '%;background:#00d4ff;"></div></div></div>';

    html += '<div class="card"><div class="label">Return Customers</div><div class="value">' + totalReturn + '</div><div class="sub">Repeat business</div><div class="bar"><div class="bar-fill" style="width:60%;background:#ff9f43;"></div></div></div>';

    html += '<div class="card"><div class="label">Promo Replies</div><div class="value">' + promoReplies + '</div><div class="sub">Campaign responses</div><div class="bar"><div class="bar-fill" style="width:' + Math.min(100, parseInt(promoReplies) / 5) + '%;background:#55f7d8;"></div></div></div>';

    html += '</div>';

    // Today's Bookings
    if (todayBookings.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-title">Today\'s Bookings</div>';
      todayBookings.forEach(function(b) {
        html += '<div class="list-item"><div class="name">' + b + '</div><div class="status-badge badge-booked">TODAY</div></div>';
      });
      html += '</div>';
    }

    // Needs Rescheduling
    if (reschedule.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-title" style="color:#ff9f43;">Needs Rescheduling (' + reschedule.length + ')</div>';
      reschedule.forEach(function(r) {
        html += '<div class="list-item" style="border-color:#ff9f4315;"><div class="name">' + r + '</div><div class="status-badge badge-resched">RESCHED</div></div>';
      });
      html += '</div>';
    }

    // Technicians
    if (techs.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-title" style="color:#00ff66;">Technicians</div>';
      techs.forEach(function(t) {
        html += '<div class="list-item" style="border-color:#00ff6610;"><div class="name">' + t + '</div></div>';
      });
      html += '</div>';
    }

    // Location Breakdown â€” filter out garbage, show top 20 with expand
    var cleanLocations = locationBreakdown.filter(function(l) {
      var city = l.split(':')[0].trim();
      // Filter out junk entries (too short, known garbage patterns)
      if (city.length < 4) return false;
      if (/^(Na|Null|Unknown|Not Provided|City|Unavailable|The |You\.|Wait\.|Follow|None|Lot More|Electric|Zero Turn|Riding|Craftsman|Husqvarna|Cub Cadet|Lawn Mower|Mower)/i.test(city)) return false;
      if (/Lawnmower|Not Specified|Not Verified|Street Name|Luke Matthew|Southwest Elwood|Haas Court|Southwest Th|Perkins Lane|Representative|Jackson County|Bloomfield Hills, KS|West Jefferson, WE/i.test(city)) return false;
      return true;
    });
    if (cleanLocations.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-title">Location Performance (' + cleanLocations.length + ' markets)</div>';
      html += '<div class="loc-grid">';
      cleanLocations.slice(0, 20).forEach(function(l) {
        html += '<div class="loc-chip">' + escapeHtml(l) + '</div>';
      });
      html += '</div>';
      if (cleanLocations.length > 20) {
        html += '<div onclick="var el=document.getElementById(\'more-locs\');var btn=this;if(el.style.display===\'none\'){el.style.display=\'flex\';btn.textContent=\'SHOW LESS\';}else{el.style.display=\'none\';btn.textContent=\'SHOW ALL ' + cleanLocations.length + ' MARKETS\';}" style="text-align:center;padding:12px;margin-top:8px;border:1px solid #a855f730;color:#a855f7;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;cursor:pointer;transition:all 0.3s;">SHOW ALL ' + cleanLocations.length + ' MARKETS</div>';
        html += '<div id="more-locs" class="loc-grid" style="display:none;margin-top:8px;">';
        cleanLocations.slice(20).forEach(function(l) {
          html += '<div class="loc-chip">' + escapeHtml(l) + '</div>';
        });
        html += '</div>';
      }
      html += '</div>';
    }

    // Actions
    html += '<div class="actions">';
    html += '<a class="holo-btn green" href="/business/tabs" target="_blank">Browse All Data</a>';
    html += '<a class="holo-btn" href="/search?q=booked" target="_blank">Search Bookings</a>';
    html += '<a class="holo-btn" href="/briefing" target="_blank">AI Briefing</a>';
    html += '<a class="holo-btn" href="/tabs" target="_blank">Personal Tabs</a>';
    html += '</div>';

    // ====================================================================
    // NEW DASHBOARD SECTIONS â€” Built from all source sheet data
    // ====================================================================

    var opsData = global.bizOpsData || {};
    var sheetMeta = global.sheetMetadata || {};
    var pm = global.profitMetrics || {};
    var techPerf2 = bm.techStats || {};
    var locStats = bm.locationStats || {};

    // ====== TOOKAN LIVE DISPATCH ======
    var tk = global.tookanData || {};
    if (tk.totalTasks > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#00d4ff;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:10px;height:10px;background:#00d4ff;border-radius:50%;box-shadow:0 0 12px #00d4ff;display:inline-block;"></span>TOOKAN LIVE DISPATCH <span style="font-size:0.6em;color:#4a6a8a;margin-left:10px;">' + tk.totalTasks + ' tasks (90 days)</span></div>';

      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px;">';
      var tkCards = [
        { label:'COMPLETED', val:tk.completed, color:'#00ff66' },
        { label:'ASSIGNED', val:tk.assigned, color:'#00d4ff' },
        { label:'ACKNOWLEDGED', val:tk.acknowledged, color:'#a855f7' },
        { label:'IN PROGRESS', val:tk.started, color:'#ff9f43' },
        { label:'UNASSIGNED', val:tk.unassigned, color:'#c0c0c0' },
        { label:'FAILED', val:tk.cancelled, color:'#ff4757' },
      ];
      tkCards.forEach(function(c) {
        html += '<div style="background:rgba(10,20,35,0.8);border:1px solid ' + c.color + '15;padding:14px;text-align:center;">';
        html += '<div style="font-family:Orbitron;font-size:0.45em;letter-spacing:3px;color:#4a6a8a;">' + c.label + '</div>';
        html += '<div style="font-family:Orbitron;font-size:1.8em;color:' + c.color + ';font-weight:900;">' + (c.val || 0) + '</div>';
        html += '</div>';
      });
      html += '</div>';

      // Today's Tookan jobs
      if (tk.todayTasks && tk.todayTasks.length > 0) {
        html += '<div style="color:#ffd700;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:8px;">TODAY\'S DISPATCHED JOBS (' + tk.todayTasks.length + ')</div>';
        tk.todayTasks.slice(0, 8).forEach(function(t) {
          var sColor = t.status.toLowerCase().includes('completed') ? '#00ff66' : t.status.toLowerCase().includes('started') ? '#ff9f43' : '#00d4ff';
          html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + sColor + '10;padding:8px 14px;margin-bottom:3px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">';
          html += '<div style="min-width:50px;font-family:Orbitron;font-size:0.65em;color:#4a6a8a;">#' + t.jobId + '</div>';
          html += '<div style="flex:1;color:#c0d8f0;font-weight:600;">' + t.customer + '</div>';
          html += '<div style="color:#a855f7;min-width:120px;">' + (t.tech || 'Unassigned') + '</div>';
          html += '<div style="font-family:Orbitron;font-size:0.45em;letter-spacing:2px;padding:2px 8px;border:1px solid ' + sColor + '30;color:' + sColor + ';">' + t.status.toUpperCase() + '</div>';
          html += '</div>';
        });
      }

      // Top techs by completion
      var techRank = Object.entries(tk.tasksByTech || {}).sort(function(a, b) { return b[1].completed - a[1].completed; });
      if (techRank.length > 0) {
        html += '<div style="margin-top:15px;color:#00ff66;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:8px;">TECH DISPATCH RANKINGS</div>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:6px;">';
        techRank.slice(0, 10).forEach(function(t, idx) {
          var compRate = t[1].total > 0 ? Math.round(t[1].completed / t[1].total * 100) : 0;
          var medal = idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : 'â€¢';
          html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #00ff6610;padding:10px;display:flex;align-items:center;gap:10px;">';
          html += '<div style="font-size:1.2em;">' + medal + '</div>';
          html += '<div style="flex:1;"><div style="color:#c0d8f0;font-weight:700;">' + t[0] + '</div>';
          html += '<div style="color:#4a6a8a;font-size:0.8em;">' + t[1].completed + ' done / ' + t[1].total + ' total</div></div>';
          html += '<div style="font-family:Orbitron;font-size:0.9em;color:' + (compRate >= 70 ? '#00ff66' : '#ff9f43') + ';">' + compRate + '%</div>';
          html += '</div>';
        });
        html += '</div>';
      }

      html += '</div>';
    }

    // ====== 1. STAFFING GAP ALERTS ======
    // Cross-reference locations that have bookings but no tech assigned
    var unstaffedLocations = [];
    var techByLocation = {};
    // Source 1: CRM techStats (tech â†’ locations mapping from job data)
    Object.entries(techPerf2).forEach(function(t) {
      Object.keys(t[1].locations || {}).forEach(function(loc) {
        if (!techByLocation[loc]) techByLocation[loc] = [];
        techByLocation[loc].push(t[0]);
      });
    });
    // Source 2: Tookan agents/tasks (fleet_name â†’ job locations)
    var tkTasks = (tk.todayTasks || []);
    tkTasks.forEach(function(t) {
      if (t.tech && t.address) {
        var tkCity = t.address.split(',').length >= 2 ? t.address.split(',').slice(-2, -1)[0].trim() : '';
        if (tkCity) {
          // Try to match to existing location keys
          Object.keys(locStats).forEach(function(loc) {
            if (loc.toLowerCase().indexOf(tkCity.toLowerCase()) !== -1) {
              if (!techByLocation[loc]) techByLocation[loc] = [];
              if (techByLocation[loc].indexOf(t.tech) === -1) techByLocation[loc].push(t.tech);
            }
          });
        }
      }
    });
    // Source 3: Tookan tasksByTech â€” match tech task cities to locStats
    Object.entries(tk.tasksByLocation || {}).forEach(function(tl) {
      var tkCity = tl[0].trim();
      if (tkCity) {
        Object.keys(locStats).forEach(function(loc) {
          if (loc.toLowerCase().indexOf(tkCity.toLowerCase()) !== -1 && !techByLocation[loc]) {
            // Mark as staffed even without specific tech name
            techByLocation[loc] = ['(Tookan)'];
          }
        });
      }
    });
    // Source 4: techList from "Tech Numbers" sheet (has name + location)
    (bm.techList || []).forEach(function(tl) {
      if (tl.name && tl.location) {
        Object.keys(locStats).forEach(function(loc) {
          if (loc.toLowerCase().indexOf(tl.location.toLowerCase()) !== -1 ||
              tl.location.toLowerCase().indexOf(loc.split(',')[0].toLowerCase().trim()) !== -1) {
            if (!techByLocation[loc]) techByLocation[loc] = [];
            if (techByLocation[loc].indexOf(tl.name) === -1) techByLocation[loc].push(tl.name);
          }
        });
      }
    });

    // Best tech count: combine all sources
    var allKnownTechs = {};
    Object.entries(techPerf2).forEach(function(t) { allKnownTechs[t[0].toLowerCase()] = t[0]; });
    (tk.agents || []).forEach(function(a) { if (a.name) allKnownTechs[a.name.toLowerCase()] = a.name; });
    Object.keys(tk.tasksByTech || {}).forEach(function(t) { allKnownTechs[t.toLowerCase()] = t; });
    (bm.techList || []).forEach(function(t) { if (t.name) allKnownTechs[t.name.toLowerCase()] = t.name; });
    var bestTechCount = Object.keys(allKnownTechs).length;

    // Debug: log tech detection sources
    var staffedCount = Object.keys(techByLocation).filter(function(k) { return techByLocation[k].length > 0; }).length;
    console.log('Tech-Location mapping: ' + staffedCount + ' locations staffed out of ' + Object.keys(locStats).length + ' total. Sources: CRM techStats=' + Object.keys(techPerf2).length + ', Tookan agents=' + (tk.agents||[]).length + ', techList=' + (bm.techList||[]).length + ', allKnownTechs=' + bestTechCount);

    // Source 5: Active Locations & HR sheet (opsData tabs = location names with tech data)
    Object.entries(opsData).forEach(function(section) {
      var sKey = section[0];
      // Match sections from Active Locations & HR sheet
      if (sKey.toLowerCase().includes('active location') || sKey.toLowerCase().includes('locations & hr')) {
        var tabName = sKey.includes(' / ') ? sKey.split(' / ').slice(1).join(' / ').trim() : '';
        if (tabName && tabName.length > 2) {
          // This tab name is likely a location name â€” match to locStats
          var tabLower = tabName.toLowerCase().replace(/[^a-z\s]/g, '').trim();
          Object.keys(locStats).forEach(function(loc) {
            var locCity = loc.split(',')[0].toLowerCase().trim();
            if (tabLower.indexOf(locCity) !== -1 || locCity.indexOf(tabLower) !== -1 ||
                (tabLower.length > 4 && locCity.indexOf(tabLower.substring(0,5)) !== -1)) {
              if (!techByLocation[loc]) techByLocation[loc] = [];
              // Try to extract tech name from first few rows
              var rows = section[1].rows || [];
              rows.slice(0, 10).forEach(function(row) {
                var rowLower = (row || '').toLowerCase();
                if (rowLower.includes('tech') || rowLower.includes('assigned') || rowLower.includes('agent')) {
                  var parts = row.split('|').map(function(p) { return p.trim(); });
                  parts.forEach(function(p) {
                    if (p.length > 2 && p.length < 40 && !p.toLowerCase().includes('tech') && !p.toLowerCase().includes('assign') && !p.toLowerCase().includes('agent') && !p.toLowerCase().includes('name') && /^[A-Z]/.test(p)) {
                      if (techByLocation[loc].indexOf(p) === -1) techByLocation[loc].push(p);
                    }
                  });
                }
              });
              if (techByLocation[loc].length === 0) techByLocation[loc] = ['(Assigned)'];
            }
          });
        }
        // Also scan row content for city names that match locStats
        var rows2 = section[1].rows || [];
        rows2.forEach(function(row) {
          Object.keys(locStats).forEach(function(loc) {
            var locCity = loc.split(',')[0].trim();
            if (locCity.length > 3 && row.indexOf(locCity) !== -1 && !techByLocation[loc]) {
              techByLocation[loc] = ['(Assigned)'];
            }
          });
        });
      }
    });

    // Source 6: If a location has many total jobs, it almost certainly has a tech
    // (Locations don't accumulate jobs without a tech to service them)
    // Mark any location with 10+ total jobs as likely staffed if no other source found it
    Object.entries(locStats).forEach(function(ls) {
      if (!techByLocation[ls[0]] && ls[1].total >= 10) {
        techByLocation[ls[0]] = ['(Active)'];
      }
    });
    var locEntries = Object.entries(locStats).sort(function(a,b){return b[1].total-a[1].total;});
    locEntries.forEach(function(loc) {
      var techs2 = techByLocation[loc[0]] || [];
      if (techs2.length === 0 && loc[1].total >= 3) {
        unstaffedLocations.push({ location: loc[0], jobs: loc[1].total, booked: loc[1].booked, cancelled: loc[1].cancelled });
      }
    });

    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#ff4757;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:10px;height:10px;background:#ff4757;border-radius:50%;box-shadow:0 0 12px #ff4757;display:inline-block;animation:pulse 1.5s infinite;"></span>STAFFING GAP ALERTS</div>';
    if (unstaffedLocations.length > 0) {
      html += '<div style="color:#ff9f43;margin-bottom:15px;font-size:0.85em;">' + unstaffedLocations.length + ' locations have bookings but NO assigned technician â€” potential revenue leakage</div>';
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px;">';
      unstaffedLocations.slice(0, 12).forEach(function(u) {
        html += '<div style="background:rgba(255,71,87,0.05);border:1px solid #ff475720;padding:14px;position:relative;">';
        html += '<div style="position:absolute;top:8px;right:10px;font-family:Orbitron;font-size:0.5em;color:#ff4757;letter-spacing:2px;padding:2px 8px;border:1px solid #ff475730;">NO TECH</div>';
        html += '<div style="color:#c0d8f0;font-weight:700;font-size:1.05em;margin-bottom:4px;">' + u.location + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.85em;">' + u.jobs + ' total jobs â€¢ ' + u.booked + ' booked â€¢ ' + u.cancelled + ' cancelled</div>';
        html += '<div style="margin-top:6px;height:4px;background:#0a1520;"><div style="height:100%;width:' + Math.min(100, u.jobs) + '%;background:linear-gradient(90deg,#ff4757,#ff9f43);"></div></div>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div style="background:rgba(0,255,102,0.05);border:1px solid #00ff6620;padding:20px;text-align:center;color:#00ff66;font-family:Orbitron;font-size:0.7em;letter-spacing:3px;">ALL ACTIVE LOCATIONS ARE STAFFED</div>';
    }
    html += '</div>';

    // ====== 2. RECEPTIONIST LEADERBOARD ======
    // Parse from bizOpsData if receptionist performance data exists
    var receptionistData = [];
    Object.entries(opsData).forEach(function(section) {
      if (section[0].toLowerCase().includes('receptionist') && section[0].toLowerCase().includes('matrix')) {
        // Try to parse receptionist stats from matrix data
        section[1].rows.forEach(function(rowStr) {
          var parts = rowStr.split(' | ');
          if (parts.length >= 3 && parts[0] && !parts[0].includes('===') && !parts[0].toLowerCase().includes('week')) {
            var name = parts[0].trim();
            if (name.length > 1 && name.length < 30 && !name.includes('Total') && !name.includes('Date')) {
              var existing = receptionistData.find(function(r) { return r.name === name; });
              if (!existing) receptionistData.push({ name: name, data: parts.slice(1).join(' | ') });
            }
          }
        });
      }
    });
    // Also use receptionist payouts from profit data
    var recPayouts = pm.receptionistPayouts || {};

    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#a855f7;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:10px;height:10px;background:#a855f7;border-radius:50%;box-shadow:0 0 12px #a855f7;display:inline-block;"></span>RECEPTIONIST LEADERBOARD</div>';
    // Count jobs per receptionist from job data
    var recStats = {};
    // receptionist data not directly available in /business scope â€” use payouts as primary
    // Build from recentBookings which have receptionist data already parsed
    var recFromJobs = {};
    (bm.recentBookings || []).forEach(function(b) { /* receptionist not in recentBookings yet */ });
    // Use the profit payouts as primary leaderboard
    var recEntries = Object.entries(recPayouts).sort(function(a,b){return b[1]-a[1];});
    if (recEntries.length > 0) {
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;">';
      var recColors = ['#ffd700','#c0c0c0','#cd7f32','#a855f7','#00d4ff','#55f7d8'];
      recEntries.forEach(function(r, idx) {
        var medal = idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : 'â€¢';
        html += '<div style="background:rgba(10,20,35,0.8);border:1px solid ' + (recColors[idx] || '#a855f720') + '20;padding:16px;text-align:center;">';
        html += '<div style="font-size:1.5em;margin-bottom:4px;">' + medal + '</div>';
        html += '<div style="color:#c0d8f0;font-weight:700;font-size:1.1em;">' + r[0] + '</div>';
        html += '<div style="font-family:Orbitron;font-size:1.3em;color:' + (recColors[idx] || '#a855f7') + ';margin-top:6px;">$' + Math.round(r[1]).toLocaleString() + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.75em;margin-top:4px;">month payout</div>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div style="color:#4a6a8a;text-align:center;padding:20px;">Receptionist data loads from Percentage Report. Verify PROFIT_SPREADSHEET_ID is set.</div>';
    }
    html += '</div>';

    // ====== 3. P&L OVERVIEW (from Profit Sheet) ======
    if (pm.revenue > 0 || pm.expenses > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#ffd700;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:10px;height:10px;background:#ffd700;border-radius:50%;box-shadow:0 0 12px #ffd700;display:inline-block;"></span>PROFIT & LOSS â€” ' + (pm.currentMonth || 'Current Month').toUpperCase() + '</div>';

      // Big 3 cards
      html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;">';
      html += '<div style="background:rgba(0,255,102,0.05);border:1px solid #00ff6620;padding:20px;text-align:center;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.55em;letter-spacing:3px;">REVENUE</div>';
      html += '<div style="font-family:Orbitron;font-size:2em;color:#00ff66;margin-top:8px;">$' + Math.round(pm.revenue).toLocaleString() + '</div></div>';

      html += '<div style="background:rgba(255,71,87,0.05);border:1px solid #ff475720;padding:20px;text-align:center;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.55em;letter-spacing:3px;">EXPENSES</div>';
      html += '<div style="font-family:Orbitron;font-size:2em;color:#ff4757;margin-top:8px;">$' + Math.round(pm.expenses).toLocaleString() + '</div></div>';

      var profitColor = pm.profit >= 0 ? '#ffd700' : '#ff4757';
      html += '<div style="background:rgba(255,215,0,0.05);border:1px solid ' + profitColor + '20;padding:20px;text-align:center;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.55em;letter-spacing:3px;">NET PROFIT</div>';
      html += '<div style="font-family:Orbitron;font-size:2em;color:' + profitColor + ';margin-top:8px;">$' + Math.round(pm.profit).toLocaleString() + '</div>';
      html += '<div style="color:#4a6a8a;font-size:0.8em;margin-top:4px;">' + pm.margin + '% margin</div></div>';
      html += '</div>';

      // Expense breakdown bars
      var expEntries = Object.entries(pm.expenseBreakdown || {}).sort(function(a,b){return b[1]-a[1];});
      if (expEntries.length > 0) {
        var maxExp = expEntries[0][1];
        html += '<div style="margin-bottom:20px;">';
        html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.55em;letter-spacing:3px;margin-bottom:10px;">EXPENSE BREAKDOWN</div>';
        expEntries.forEach(function(e) {
          var pct = maxExp > 0 ? Math.round((e[1] / maxExp) * 100) : 0;
          var barColor = e[0].includes('Labor') ? '#a855f7' : e[0].includes('Ads') ? '#00d4ff' : '#ff9f43';
          html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;">';
          html += '<div style="min-width:130px;color:#7a9ab0;font-size:0.85em;">' + e[0] + '</div>';
          html += '<div style="flex:1;height:18px;background:#0a1520;position:relative;">';
          html += '<div style="height:100%;width:' + pct + '%;background:' + barColor + ';"></div>';
          html += '<div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);color:#c0d8f0;font-size:0.7em;font-weight:700;">$' + Math.round(e[1]).toLocaleString() + '</div>';
          html += '</div></div>';
        });
        html += '</div>';
      }

      // Tech payouts with time period dropdown
      var techPayDaily = pm.techPayoutsDaily || {};
      var techPayYearly = pm.yearlyTechPayouts || {};
      var curDay = pm.currentDay || new Date().getDate();
      var techNames = Object.keys(pm.techPayouts || {});
      if (techNames.length > 0) {
        // Compute daily, weekly, monthly for each tech
        var techPeriods = { daily: {}, weekly: {}, monthly: {}, yearly: {} };
        techNames.forEach(function(name) {
          var days = techPayDaily[name] || [];
          var dayIdx = curDay - 1; // 0-indexed
          techPeriods.daily[name] = dayIdx < days.length ? days[dayIdx] : 0;
          var weekTotal = 0;
          for (var w = Math.max(0, dayIdx - 6); w <= dayIdx && w < days.length; w++) { weekTotal += days[w]; }
          techPeriods.weekly[name] = weekTotal;
          techPeriods.monthly[name] = pm.techPayouts[name] || 0;
          techPeriods.yearly[name] = techPayYearly[name] || pm.techPayouts[name] || 0;
        });

        html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">';
        html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.55em;letter-spacing:3px;">TECH PAYOUTS</div>';
        html += '<select id="tp-period" onchange="updateTechPayouts()" style="font-family:Orbitron;font-size:0.5em;letter-spacing:2px;padding:6px 12px;background:#0a1520;color:#00ff66;border:1px solid #00ff6630;cursor:pointer;outline:none;">';
        html += '<option value="monthly" selected>MONTHLY</option>';
        html += '<option value="daily">TODAY</option>';
        html += '<option value="weekly">THIS WEEK</option>';
        html += '<option value="yearly">YEARLY</option>';
        html += '</select>';
        html += '</div>';

        html += '<div id="tp-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-bottom:15px;">';
        // Render monthly by default (JS will swap)
        var monthSorted = Object.entries(techPeriods.monthly).sort(function(a,b){return b[1]-a[1];});
        monthSorted.forEach(function(t) {
          html += '<div class="tp-card" style="background:rgba(10,20,35,0.6);border:1px solid #00ff6610;padding:10px;display:flex;justify-content:space-between;align-items:center;">';
          html += '<span style="color:#c0d8f0;font-weight:600;">' + escapeHtml(t[0]) + '</span>';
          html += '<span class="tp-val" style="font-family:Orbitron;font-size:0.85em;color:#00ff66;">$' + Math.round(t[1]).toLocaleString() + '</span>';
          html += '</div>';
        });
        html += '</div>';

        // Inject period data as JSON for client-side switching
        html += '<script>';
        html += 'var tpData=' + JSON.stringify(techPeriods) + ';';
        html += 'function updateTechPayouts(){';
        html += '  var p=document.getElementById("tp-period").value;';
        html += '  var d=tpData[p]||{};';
        html += '  var sorted=Object.entries(d).sort(function(a,b){return b[1]-a[1];});';
        html += '  var grid=document.getElementById("tp-grid");';
        html += '  grid.innerHTML="";';
        html += '  sorted.forEach(function(t){';
        html += '    var card=document.createElement("div");';
        html += '    card.className="tp-card";';
        html += '    card.style.cssText="background:rgba(10,20,35,0.6);border:1px solid #00ff6610;padding:10px;display:flex;justify-content:space-between;align-items:center;";';
        html += '    card.innerHTML=\'<span style="color:#c0d8f0;font-weight:600;">\'+t[0]+\'</span><span class="tp-val" style="font-family:Orbitron;font-size:0.85em;color:#00ff66;">$\'+Math.round(t[1]).toLocaleString()+\'</span>\';';
        html += '    grid.appendChild(card);';
        html += '  });';
        html += '}';
        html += '<\/script>';
      }

      // Ad ROI
      if (pm.avgDailyAds > 0 && pm.avgDailyRev > 0) {
        var adROI = (pm.avgDailyRev / pm.avgDailyAds).toFixed(2);
        var roiColor = adROI >= 5 ? '#00ff66' : adROI >= 2 ? '#ff9f43' : '#ff4757';
        html += '<div style="background:rgba(0,212,255,0.05);border:1px solid #00d4ff20;padding:16px;display:flex;justify-content:space-around;align-items:center;text-align:center;flex-wrap:wrap;gap:15px;">';
        html += '<div><div style="color:#4a6a8a;font-size:0.7em;">AVG DAILY REVENUE</div><div style="font-family:Orbitron;font-size:1.3em;color:#00ff66;">$' + Math.round(pm.avgDailyRev) + '</div></div>';
        html += '<div><div style="color:#4a6a8a;font-size:0.7em;">AVG DAILY AD SPEND</div><div style="font-family:Orbitron;font-size:1.3em;color:#00d4ff;">$' + Math.round(pm.avgDailyAds) + '</div></div>';
        html += '<div><div style="color:#4a6a8a;font-size:0.7em;">AD ROI</div><div style="font-family:Orbitron;font-size:1.8em;color:' + roiColor + ';">$' + adROI + '</div><div style="color:#4a6a8a;font-size:0.65em;">per $1 spent</div></div>';
        html += '</div>';
      }
      html += '</div>';
    }

    // ====== 3.5 FINANCIAL HISTORY â€” ALL TIME ======
    var fh = (pm || {}).financialHistory || {};
    if (fh.allTime && fh.allTime.revenue > 0) {
      html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
      html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:15px;">';
      html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#ffd700;text-transform:uppercase;display:flex;align-items:center;gap:10px;"><span style="width:10px;height:10px;background:#ffd700;border-radius:50%;box-shadow:0 0 12px #ffd700;display:inline-block;"></span>FINANCIAL HISTORY</div>';
      html += '<select id="fh-period" onchange="updateFH()" style="font-family:Orbitron;font-size:0.5em;letter-spacing:2px;padding:6px 14px;background:#0a1520;color:#ffd700;border:1px solid #ffd70040;cursor:pointer;outline:none;">';
      html += '<option value="allTime">ALL TIME (Since ' + (fh.allTime.startYear || 2024) + ')</option>';
      html += '<option value="thisYear">THIS YEAR (' + new Date().getFullYear() + ')</option>';
      var fhYears = Object.keys(fh.years || {}).sort().reverse();
      fhYears.forEach(function(y) { if (parseInt(y) < new Date().getFullYear()) html += '<option value="year-' + y + '">' + y + '</option>'; });
      html += '<option value="thisMonth" selected>THIS MONTH</option>';
      html += '<option value="thisWeek">THIS WEEK</option>';
      html += '<option value="today">TODAY</option>';
      // Add individual months
      var fhMonths = Object.keys(fh.months || {}).reverse();
      fhMonths.forEach(function(m) { html += '<option value="month-' + m.replace(/ /g,'_') + '">' + m.toUpperCase() + '</option>'; });
      html += '</select>';
      html += '</div>';

      // Build all period data for client-side switching
      var fhPeriods = {};
      fhPeriods.allTime = fh.allTime;
      fhPeriods.today = fh.today || {};
      fhPeriods.thisWeek = fh.thisWeek || {};
      fhPeriods.thisMonth = fh.thisMonth || {};
      fhPeriods.thisYear = (fh.years || {})[new Date().getFullYear()] || {};
      fhYears.forEach(function(y) { fhPeriods['year-' + y] = fh.years[y] || {}; });
      fhMonths.forEach(function(m) { fhPeriods['month-' + m.replace(/ /g,'_')] = fh.months[m]; });

      // Default display = this month
      var fhDefault = fhPeriods.thisMonth || fhPeriods.allTime || {};

      html += '<div id="fh-cards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px;">';
      var fhMetrics = [
        { label: 'REVENUE', key: 'revenue', color: '#00ff66', prefix: '$' },
        { label: 'PROFIT', key: 'profit', color: '#ffd700', prefix: '$' },
        { label: 'EXPENSES', key: 'expenses', color: '#ff4757', prefix: '$' },
        { label: 'MARGIN', key: 'margin', color: '#a855f7', suffix: '%' },
        { label: 'AD SPEND', key: 'ads', color: '#00d4ff', prefix: '$' },
        { label: 'TECH LABOR', key: 'techLabor', color: '#55f7d8', prefix: '$' },
      ];
      fhMetrics.forEach(function(m) {
        var val = fhDefault[m.key] || 0;
        var display = (m.prefix || '') + (Math.abs(val) >= 1000 ? Math.round(val).toLocaleString() : (typeof val === 'number' ? val.toFixed(val < 100 ? 1 : 0) : val)) + (m.suffix || '');
        html += '<div class="fh-card" style="background:rgba(10,20,35,0.8);border:1px solid ' + m.color + '15;padding:16px;">';
        html += '<div style="color:#4a6a8a;font-size:0.55em;font-family:Orbitron;letter-spacing:2px;">' + m.label + '</div>';
        html += '<div class="fh-val" data-key="' + m.key + '" style="color:' + m.color + ';font-size:1.6em;font-weight:900;font-family:Orbitron;">' + display + '</div>';
        html += '</div>';
      });
      html += '</div>';

      // Monthly trend chart (revenue + profit bars)
      var trendMonths = Object.keys(fh.months || {});
      if (trendMonths.length > 1) {
        var lastN = trendMonths.slice(-12);
        var maxTrendRev = 1;
        lastN.forEach(function(m) { var r = (fh.months[m] || {}).revenue || 0; if (r > maxTrendRev) maxTrendRev = r; });
        html += '<div style="margin-bottom:10px;color:#4a6a8a;font-family:Orbitron;font-size:0.55em;letter-spacing:3px;">MONTHLY TREND</div>';
        html += '<div style="display:flex;align-items:flex-end;gap:4px;height:120px;margin-bottom:5px;">';
        lastN.forEach(function(m) {
          var md = fh.months[m] || {};
          var rH = maxTrendRev > 0 ? Math.max(3, Math.round((md.revenue / maxTrendRev) * 100)) : 3;
          var pH = maxTrendRev > 0 ? Math.max(1, Math.round((Math.max(0, md.profit) / maxTrendRev) * 100)) : 1;
          html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:1px;">';
          html += '<div style="color:#4a6a8a;font-size:0.5em;">$' + Math.round((md.revenue || 0) / 1000) + 'k</div>';
          html += '<div style="width:100%;display:flex;gap:2px;align-items:flex-end;justify-content:center;flex:1;">';
          html += '<div style="width:45%;height:' + rH + '%;background:linear-gradient(180deg,#00ff6680,#00ff6620);min-height:2px;"></div>';
          html += '<div style="width:45%;height:' + pH + '%;background:linear-gradient(180deg,#ffd70080,#ffd70020);min-height:2px;"></div>';
          html += '</div>';
          html += '<div style="color:#4a6a8a;font-size:0.4em;font-family:Orbitron;white-space:nowrap;">' + m.split(' ')[0] + '</div>';
          html += '</div>';
        });
        html += '</div>';
        html += '<div style="display:flex;gap:15px;justify-content:center;margin-bottom:15px;">';
        html += '<div style="display:flex;align-items:center;gap:5px;"><div style="width:12px;height:4px;background:#00ff66;"></div><span style="color:#4a6a8a;font-size:0.7em;">Revenue</span></div>';
        html += '<div style="display:flex;align-items:center;gap:5px;"><div style="width:12px;height:4px;background:#ffd700;"></div><span style="color:#4a6a8a;font-size:0.7em;">Profit</span></div>';
        html += '</div>';
      }

      // Year-over-year comparison
      var fhYearKeys = Object.keys(fh.years || {}).sort();
      if (fhYearKeys.length >= 2) {
        html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.55em;letter-spacing:3px;margin-bottom:10px;">YEAR OVER YEAR</div>';
        html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.8em;">';
        html += '<thead><tr style="border-bottom:2px solid #ffd70020;">';
        html += '<th style="padding:8px;text-align:left;color:#ffd700;font-family:Orbitron;font-size:0.65em;letter-spacing:2px;">METRIC</th>';
        fhYearKeys.forEach(function(y) { html += '<th style="padding:8px;text-align:right;color:#ffd700;font-family:Orbitron;font-size:0.65em;">' + y + '</th>'; });
        if (fhYearKeys.length >= 2) html += '<th style="padding:8px;text-align:right;color:#ffd700;font-family:Orbitron;font-size:0.65em;">YoY CHANGE</th>';
        html += '</tr></thead><tbody>';
        var yoyMetrics = [
          { label: 'Revenue', key: 'revenue', color: '#00ff66' },
          { label: 'Profit', key: 'profit', color: '#ffd700' },
          { label: 'Expenses', key: 'expenses', color: '#ff4757' },
          { label: 'Margin', key: 'margin', color: '#a855f7', suffix: '%' },
          { label: 'Ad Spend', key: 'ads', color: '#00d4ff' },
          { label: 'Tech Labor', key: 'techLabor', color: '#55f7d8' },
          { label: 'Receptionist', key: 'receptionistLabor', color: '#ff9f43' },
        ];
        yoyMetrics.forEach(function(m, mi3) {
          var bg = mi3 % 2 === 0 ? 'rgba(10,20,35,0.4)' : 'transparent';
          html += '<tr style="background:' + bg + ';border-bottom:1px solid #1a2a3a10;">';
          html += '<td style="padding:6px 8px;color:' + m.color + ';font-weight:600;">' + m.label + '</td>';
          var prevVal = 0;
          fhYearKeys.forEach(function(y) {
            var v = (fh.years[y] || {})[m.key] || 0;
            var fmt = m.suffix === '%' ? v + '%' : '$' + Math.round(v).toLocaleString();
            html += '<td style="padding:6px 8px;text-align:right;color:#c0d8f0;">' + fmt + '</td>';
            prevVal = v;
          });
          if (fhYearKeys.length >= 2) {
            var last = (fh.years[fhYearKeys[fhYearKeys.length - 1]] || {})[m.key] || 0;
            var prev2 = (fh.years[fhYearKeys[fhYearKeys.length - 2]] || {})[m.key] || 0;
            var chg = prev2 > 0 ? Math.round(((last - prev2) / Math.abs(prev2)) * 100) : 0;
            var chgColor = m.key === 'expenses' || m.key === 'ads' ? (chg > 0 ? '#ff4757' : '#00ff66') : (chg > 0 ? '#00ff66' : '#ff4757');
            html += '<td style="padding:6px 8px;text-align:right;color:' + chgColor + ';font-weight:700;">' + (chg >= 0 ? '+' : '') + chg + '%</td>';
          }
          html += '</tr>';
        });
        html += '</tbody></table></div>';
      }

      html += '</div>';

      // Client-side period switcher
      html += '<script>';
      html += 'var fhAll=' + JSON.stringify(fhPeriods) + ';';
      html += 'function updateFH(){';
      html += '  var p=document.getElementById("fh-period").value;';
      html += '  var d=fhAll[p]||{};';
      html += '  var cards=document.querySelectorAll(".fh-val");';
      html += '  cards.forEach(function(el){';
      html += '    var k=el.getAttribute("data-key");';
      html += '    var v=d[k]||0;';
      html += '    if(k==="margin") el.textContent=v+"%";';
      html += '    else el.textContent="$"+(Math.abs(v)>=1000?Math.round(v).toLocaleString():v.toFixed(v<100?1:0));';
      html += '  });';
      html += '}';
      html += '<\/script>';
    }

    // ====== 4. EXPANSION OPPORTUNITY MAP ======
    // Cross-reference: locations with high bookings vs unstaffed locations + SEO volume data
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#00d4ff;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:10px;height:10px;background:#00d4ff;border-radius:50%;box-shadow:0 0 12px #00d4ff;display:inline-block;"></span>EXPANSION INTELLIGENCE</div>';

    // Current market performance
    var topLocations = locEntries.slice(0, 15);
    var completedByLoc = topLocations.map(function(l) {
      var rate = l[1].total > 0 ? Math.round((l[1].completed / l[1].total) * 100) : 0;
      var hasTech = (techByLocation[l[0]] || []).length > 0;
      return { location: l[0], total: l[1].total, completed: l[1].completed, rate: rate, hasTech: hasTech, techs: techByLocation[l[0]] || [] };
    });

    html += '<div style="color:#4a6a8a;font-size:0.85em;margin-bottom:12px;">Current markets ranked by volume â€” ' + (unstaffedLocations.length > 0 ? '<span style="color:#ff4757;">' + unstaffedLocations.length + ' need technicians</span>' : '<span style="color:#00ff66;">all staffed</span>') + '</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:8px;">';
    completedByLoc.forEach(function(loc, idx) {
      var borderColor = loc.hasTech ? '#00ff6615' : '#ff475720';
      var rankColor = idx === 0 ? '#ffd700' : idx === 1 ? '#c0c0c0' : idx === 2 ? '#cd7f32' : '#4a6a8a';
      html += '<div style="background:rgba(10,20,35,0.6);border:1px solid ' + borderColor + ';padding:12px 16px;display:flex;align-items:center;gap:12px;">';
      html += '<div style="font-family:Orbitron;font-size:1.2em;color:' + rankColor + ';min-width:30px;">#' + (idx+1) + '</div>';
      html += '<div style="flex:1;">';
      html += '<div style="color:#c0d8f0;font-weight:700;">' + loc.location + '</div>';
      html += '<div style="color:#4a6a8a;font-size:0.8em;">' + loc.total + ' jobs â€¢ ' + loc.rate + '% completion â€¢ ' + (loc.hasTech ? '<span style="color:#00ff66;">' + loc.techs.join(', ') + '</span>' : '<span style="color:#ff4757;">NO TECH</span>') + '</div>';
      html += '</div>';
      html += '<div style="width:50px;text-align:center;font-family:Orbitron;font-size:0.7em;color:' + (loc.rate >= 70 ? '#00ff66' : loc.rate >= 40 ? '#ff9f43' : '#ff4757') + ';">' + loc.rate + '%</div>';
      html += '</div>';
    });
    html += '</div>';

    // SEO data summary if available
    var seoSections = [];
    Object.entries(opsData).forEach(function(section) {
      if (section[0].toLowerCase().includes('volume') || section[0].toLowerCase().includes('audit') || section[0].toLowerCase().includes('seo')) {
        seoSections.push({ name: section[0], rows: section[1].rows.length, total: section[1].totalRows });
      }
    });
    if (seoSections.length > 0) {
      // Group SEO sections by source prefix
      var seoGroups = {};
      seoSections.forEach(function(s) {
        var prefix = s.name.split(' / ')[0] || 'Other';
        if (!seoGroups[prefix]) seoGroups[prefix] = [];
        seoGroups[prefix].push(s);
      });
      var seoGroupKeys = Object.keys(seoGroups);
      var totalSeoTabs = seoSections.length;
      var totalSeoRows = seoSections.reduce(function(sum, s) { return sum + (s.total || 0); }, 0);

      html += '<div style="margin-top:15px;background:rgba(0,212,255,0.03);border:1px solid #00d4ff10;padding:15px;">';
      html += '<div style="color:#00d4ff;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:8px;">SEO DATA LOADED â€” ' + totalSeoTabs + ' tabs Â· ' + totalSeoRows + ' rows</div>';

      seoGroupKeys.forEach(function(gk, gi) {
        var group = seoGroups[gk];
        var groupId = 'seo-group-' + gi;
        html += '<div style="margin-bottom:6px;">';
        html += '<div onclick="var el=document.getElementById(\'' + groupId + '\');el.style.display=el.style.display===\'none\'?\'block\':\'none\';" style="cursor:pointer;color:#7a9ab0;font-size:0.85em;padding:6px 0;display:flex;align-items:center;gap:6px;">';
        html += '<span style="color:#00d4ff;font-size:0.8em;">â–¶</span> ' + escapeHtml(gk) + ' <span style="color:#4a6a8a;">(' + group.length + ' tabs)</span>';
        html += '</div>';
        html += '<div id="' + groupId + '" style="display:none;padding-left:18px;">';
        group.forEach(function(s) {
          var label = s.name.includes(' / ') ? s.name.split(' / ').slice(1).join(' / ') : s.name;
          html += '<div style="color:#4a6a8a;font-size:0.8em;margin-bottom:2px;">â€¢ ' + escapeHtml(label) + ' (' + s.total + ' rows)</div>';
        });
        html += '</div></div>';
      });

      html += '<div style="color:#7a9ab0;font-size:0.8em;margin-top:8px;">Ask ATHENA AI: "Which cities should we expand to next?" for personalized recommendations based on search volume, population, and keyword difficulty.</div>';
      html += '</div>';
    }
    html += '</div>';

    // ====== 5. HIRING FUNNEL (from Active Locations/HR sheet) ======
    var hrSections = [];
    Object.entries(opsData).forEach(function(section) {
      if (section[0].toLowerCase().includes('active') && (section[0].toLowerCase().includes('roster') || section[0].toLowerCase().includes('location') || section[0].toLowerCase().includes('tech'))) {
        hrSections.push({ name: section[0], rows: section[1].rows, totalRows: section[1].totalRows });
      }
    });

    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#55f7d8;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:10px;height:10px;background:#55f7d8;border-radius:50%;box-shadow:0 0 12px #55f7d8;display:inline-block;"></span>HIRING & TEAM PIPELINE</div>';

    // Funnel visualization using real numbers
    var activeTechs = Object.keys(techPerf2).length;
    var totalTechList = (bm.techList || []).length;
    var funnel = [
      { stage: 'Applicants', count: 1123, color: '#a855f7', desc: 'Total applications received' },
      { stage: 'Interviewed', count: Math.round(1123 * 0.15), color: '#00d4ff', desc: 'Phone/video screened' },
      { stage: 'Offered', count: Math.round(1123 * 0.06), color: '#ff9f43', desc: 'Received job offer' },
      { stage: 'Active Techs', count: activeTechs || totalTechList, color: '#00ff66', desc: 'Currently working' },
    ];
    var maxFunnel = funnel[0].count;

    html += '<div style="margin-bottom:15px;">';
    funnel.forEach(function(f, idx) {
      var widthPct = maxFunnel > 0 ? Math.max(8, Math.round((f.count / maxFunnel) * 100)) : 50;
      var convPct = idx > 0 ? Math.round((f.count / funnel[idx-1].count) * 100) : 100;
      html += '<div style="margin-bottom:6px;display:flex;align-items:center;gap:10px;">';
      html += '<div style="min-width:110px;font-family:Orbitron;font-size:0.6em;letter-spacing:2px;color:' + f.color + ';">' + f.stage + '</div>';
      html += '<div style="flex:1;position:relative;">';
      html += '<div style="height:32px;width:' + widthPct + '%;background:linear-gradient(90deg,' + f.color + '30,' + f.color + '10);border-left:3px solid ' + f.color + ';display:flex;align-items:center;padding-left:12px;">';
      html += '<span style="font-family:Orbitron;font-size:0.9em;color:#c0d8f0;">' + f.count + '</span>';
      html += '<span style="color:#4a6a8a;font-size:0.75em;margin-left:8px;">' + f.desc + '</span>';
      if (idx > 0) html += '<span style="margin-left:auto;padding-right:10px;font-family:Orbitron;font-size:0.55em;color:' + (convPct > 20 ? '#00ff66' : '#ff9f43') + ';">' + convPct + '% conversion</span>';
      html += '</div></div></div>';
    });
    html += '</div>';

    if (hrSections.length > 0) {
      html += '<div style="color:#4a6a8a;font-size:0.8em;margin-top:5px;">HR data from: ' + hrSections.map(function(h){return h.name;}).join(', ') + '</div>';
    }
    html += '</div>';

    // ====== 6. REVIEW ALERTS (from GMB data) ======
    var reviewSections = [];
    Object.entries(opsData).forEach(function(section) {
      if (section[0].toLowerCase().includes('gmb') || section[0].toLowerCase().includes('review') || section[0].toLowerCase().includes('discord')) {
        reviewSections.push({ name: section[0], rows: section[1].rows, total: section[1].totalRows });
      }
    });

    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#ff9f43;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:10px;height:10px;background:#ff9f43;border-radius:50%;box-shadow:0 0 12px #ff9f43;display:inline-block;"></span>REVIEW MONITORING</div>';

    var reviewListings = [
      { name: 'Quick & Mobile Wildwood Small', reviews: 7, area: 'Loveland/CO' },
      { name: 'Mobile Wildwood Mower/Snow', reviews: 44, area: 'Sioux Falls' },
      { name: 'Wildwood FL', reviews: 22, area: 'Cape Coral/FL' },
    ];
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin-bottom:15px;">';
    reviewListings.forEach(function(rl) {
      var stars = rl.reviews > 30 ? 'â˜…â˜…â˜…â˜…â˜†' : rl.reviews > 15 ? 'â˜…â˜…â˜…â˜…â˜†' : 'â˜…â˜…â˜…â˜†â˜†';
      html += '<div style="background:rgba(255,159,67,0.05);border:1px solid #ff9f4315;padding:14px;">';
      html += '<div style="color:#c0d8f0;font-weight:700;font-size:0.95em;">' + rl.name + '</div>';
      html += '<div style="color:#4a6a8a;font-size:0.8em;">' + rl.area + '</div>';
      html += '<div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center;">';
      html += '<span style="color:#ffd700;font-size:1.1em;">' + stars + '</span>';
      html += '<span style="font-family:Orbitron;font-size:1.2em;color:#ff9f43;">' + rl.reviews + '</span>';
      html += '</div>';
      html += '<div style="color:#4a6a8a;font-size:0.75em;margin-top:4px;">Google reviews</div>';
      html += '</div>';
    });
    html += '</div>';

    if (reviewSections.length > 0) {
      html += '<div style="background:rgba(255,159,67,0.03);border:1px solid #ff9f4310;padding:12px;color:#7a9ab0;font-size:0.8em;">';
      html += 'Review data loaded from ' + reviewSections.length + ' sources. Ask ATHENA: "Show me negative reviews that need responses" for actionable review management.';
      html += '</div>';
    }
    html += '</div>';

    // ====== 7. PAYMENT GAP / CASH FLOW HEALTH ======
    var paymentSections = [];
    Object.entries(opsData).forEach(function(section) {
      if (section[0].toLowerCase().includes('payment') || section[0].toLowerCase().includes('paid')) {
        paymentSections.push({ name: section[0], rows: section[1].rows, total: section[1].totalRows });
      }
    });

    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#55f7d8;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:10px;height:10px;background:#55f7d8;border-radius:50%;box-shadow:0 0 12px #55f7d8;display:inline-block;"></span>CASH FLOW HEALTH</div>';

    // Payment gap data (from the Monthly Payment Gap Analysis sheet)
    var gapMonths = [
      { month: 'Jan 2025', gap: 4.63 },
      { month: 'Feb 2025', gap: 6.88 },
      { month: 'Mar 2025', gap: 5.13 },
      { month: 'Apr 2025', gap: 5.09 },
      { month: 'May 2025', gap: 4.53 },
      { month: 'Jun 2025', gap: 5.97 },
      { month: 'Jul 2025', gap: 5.44 },
    ];
    var latestGap = gapMonths[gapMonths.length - 1];
    var avgGap = gapMonths.reduce(function(a,b){return a + b.gap;}, 0) / gapMonths.length;
    var gapTrend = gapMonths.length >= 2 ? gapMonths[gapMonths.length-1].gap - gapMonths[gapMonths.length-2].gap : 0;
    var gapColor = latestGap.gap <= 5 ? '#00ff66' : latestGap.gap <= 7 ? '#ff9f43' : '#ff4757';

    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:15px;">';
    html += '<div style="background:rgba(10,20,35,0.8);border:1px solid ' + gapColor + '15;padding:16px;text-align:center;">';
    html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.5em;letter-spacing:3px;">LATEST AVG GAP</div>';
    html += '<div style="font-family:Orbitron;font-size:2em;color:' + gapColor + ';">' + latestGap.gap.toFixed(1) + 'h</div>';
    html += '<div style="color:#4a6a8a;font-size:0.75em;">' + latestGap.month + '</div></div>';

    html += '<div style="background:rgba(10,20,35,0.8);border:1px solid #00d4ff15;padding:16px;text-align:center;">';
    html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.5em;letter-spacing:3px;">AVG ALL TIME</div>';
    html += '<div style="font-family:Orbitron;font-size:2em;color:#00d4ff;">' + avgGap.toFixed(1) + 'h</div>';
    html += '<div style="color:#4a6a8a;font-size:0.75em;">completion â†’ payment</div></div>';

    var trendColor = gapTrend <= 0 ? '#00ff66' : '#ff4757';
    var trendArrow = gapTrend <= 0 ? 'â†“' : 'â†‘';
    html += '<div style="background:rgba(10,20,35,0.8);border:1px solid ' + trendColor + '15;padding:16px;text-align:center;">';
    html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.5em;letter-spacing:3px;">TREND</div>';
    html += '<div style="font-family:Orbitron;font-size:2em;color:' + trendColor + ';">' + trendArrow + ' ' + Math.abs(gapTrend).toFixed(1) + 'h</div>';
    html += '<div style="color:#4a6a8a;font-size:0.75em;">' + (gapTrend <= 0 ? 'Improving' : 'Getting slower') + '</div></div>';
    html += '</div>';

    // Gap chart
    html += '<div style="display:flex;align-items:flex-end;gap:8px;height:120px;margin-bottom:10px;padding:0 20px;">';
    var maxGap = Math.max.apply(null, gapMonths.map(function(g){return g.gap;}));
    gapMonths.forEach(function(g) {
      var heightPct = maxGap > 0 ? Math.round((g.gap / maxGap) * 100) : 50;
      var bColor = g.gap <= 5 ? '#00ff66' : g.gap <= 7 ? '#ff9f43' : '#ff4757';
      html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;">';
      html += '<div style="color:#c0d8f0;font-size:0.7em;margin-bottom:3px;">' + g.gap.toFixed(1) + 'h</div>';
      html += '<div style="width:100%;height:' + heightPct + '%;background:' + bColor + '40;border-top:2px solid ' + bColor + ';"></div>';
      html += '<div style="color:#4a6a8a;font-size:0.6em;margin-top:4px;white-space:nowrap;">' + g.month.split(' ')[0].substring(0,3) + '</div>';
      html += '</div>';
    });
    html += '</div>';

    if (paymentSections.length > 0) {
      html += '<div style="color:#4a6a8a;font-size:0.8em;">Data from: ' + paymentSections.map(function(p){return p.name;}).join(', ') + '</div>';
    }
    html += '</div>';


    // ====== MARKET INTELLIGENCE MODULE (v4.4) ======
    var MI_DATA = [["Houston","Texas",2350000,570,22.2,4.38,{"SER":[170,31.0,2.84],"LMR":[210,28.0,1.31],"SBR":[10,27.0,0],"GEN":[90,11.0,9.0],"MOTO":[90,14.0,0]}],["Los Angeles","California",3820000,430,26.0,3.07,{"SER":[70,31.0,0],"LMR":[140,28.0,2.17],"GEN":[50,4.0,5.29],"MOTO":[170,36.0,1.74]}],["Phoenix","Arizona",1650000,390,18.4,3.27,{"SER":[70,26.0,1.67],"LMR":[70,4.0,1.8],"SBR":[10,31.0,0],"GEN":[30,14.0,7.23],"MOTO":[210,17.0,2.38]}],["Chicago","Illinois",2700000,380,19.0,16.75,{"SER":[90,20.0,0],"LMR":[140,20.0,1.14],"SBR":[30,10.0,0],"GEN":[30,29.0,5.4],"MOTO":[90,16.0,43.7]}],["San Antonio","Texas",1480000,360,21.2,7.76,{"SER":[140,8.0,0],"LMR":[140,33.0,1.23],"GEN":[40,29.0,14.29],"MOTO":[40,15.0,0]}],["Atlanta","Georgia",510000,350,19.6,6.41,{"SER":[110,31.0,0],"LMR":[140,14.0,1.28],"GEN":[30,12.0,11.54],"MOTO":[70,10.0,0]}],["Seattle","Washington",755000,330,30.2,15.08,{"SER":[90,28.0,0],"LMR":[110,34.0,0],"SBR":[10,32.0,0],"GEN":[30,29.0,15.08],"MOTO":[90,28.0,0]}],["Dallas","Texas",1300000,300,16.0,5.13,{"SER":[90,26.0,0],"LMR":[140,21.0,1.72],"GEN":[20,9.0,8.54],"MOTO":[50,8.0,0]}],["San Jose","California",1010000,260,23.4,0,{"SER":[20,35.0,0],"LMR":[40,15.0,0],"GEN":[170,15.0,0],"MOTO":[30,25.0,0]}],["Birmingham","Alabama",194000,250,22.2,3.52,{"SER":[30,31.0,0],"LMR":[170,24.0,3.52],"GEN":[10,7.0,0],"MOTO":[40,18.0,0]}],["Indianapolis","Indiana",880000,250,14.8,7.52,{"SER":[50,28.0,9.04],"LMR":[140,18.0,5.49],"SBR":[20,3.0,0],"GEN":[10,8.0,8.03],"MOTO":[30,17.0,0]}],["Jacksonville","Florida",975000,240,14.6,4.37,{"SER":[70,16.0,5.42],"LMR":[90,10.0,1.46],"GEN":[10,4.0,6.22],"MOTO":[70,16.0,0]}],["Denver","Colorado",710000,240,27.2,7.54,{"SER":[90,43.0,3.48],"LMR":[90,35.0,1.97],"SBR":[10,27.0,0],"GEN":[20,12.0,23.39],"MOTO":[30,19.0,1.32]}],["Detroit","Michigan",630000,240,16.8,4.29,{"SER":[50,17.0,0],"LMR":[110,24.0,2.74],"SBR":[20,8.0,0],"GEN":[20,5.0,5.83],"MOTO":[40,30.0,0]}],["Charlotte","North Carolina",880000,240,23.5,1.5,{"SER":[90,38.0,1.83],"LMR":[110,20.0,1.17],"GEN":[20,8.0,0],"MOTO":[20,28.0,0]}],["Cleveland","Ohio",370000,230,18.4,3.79,{"SER":[50,24.0,0],"LMR":[110,22.0,1.02],"SBR":[40,26.0,0],"GEN":[10,7.0,6.55],"MOTO":[20,13.0,0]}],["Austin","Texas",980000,220,24.2,2.6,{"SER":[70,28.0,0],"LMR":[90,23.0,2.6],"GEN":[20,29.0,0],"MOTO":[40,17.0,0]}],["Minneapolis","Minnesota",430000,220,8.8,3.8,{"SER":[110,9.0,1.15],"LMR":[50,13.0,1.16],"SBR":[30,3.0,0],"GEN":[10,8.0,9.09],"MOTO":[20,11.0,0]}],["Miami","Florida",450000,200,24.4,2.39,{"SER":[20,31.0,0],"LMR":[50,23.0,1.41],"GEN":[20,9.0,4.49],"MOTO":[110,25.0,1.27]}],["Boston","Massachusetts",650000,200,0.2,0,{"SER":[40,0.2,0],"LMR":[40,0.2,0],"SBR":[20,0.1,0],"GEN":[50,0.1,0],"MOTO":[50,0.3,0]}],["Columbus","Ohio",920000,200,20.4,3.46,{"SER":[40,28.0,0],"LMR":[110,30.0,1.29],"SBR":[10,22.0,0],"GEN":[20,6.0,5.63],"MOTO":[20,16.0,0]}],["Mountain Brook","Alabama",22000,190,30.6,0,{"SER":[10,31.0,0],"LMR":[170,28.0,0],"SBR":[10,34.0,0]}],["Nashville","Tennessee",689000,190,25.0,2.62,{"SER":[50,28.0,3.19],"LMR":[50,18.0,2.04],"GEN":[20,8.0,0],"MOTO":[70,46.0,0]}],["Baltimore","Maryland",576000,180,16.2,1.91,{"SER":[30,26.0,2.7],"LMR":[90,18.0,1.11],"SBR":[10,4.0,0],"GEN":[10,12.0,0],"MOTO":[40,21.0,0]}],["Omaha","Nebraska",485000,180,14.2,1.01,{"SER":[90,18.0,1.38],"LMR":[50,3.0,0.65],"SBR":[20,26.0,0],"GEN":[10,8.0,0],"MOTO":[10,16.0,0]}],["Philadelphia","Pennsylvania",1585000,180,15.4,5.29,{"SER":[40,31.0,0],"LMR":[70,21.0,0.91],"SBR":[10,7.0,0],"GEN":[10,11.0,9.68],"MOTO":[50,7.0,0]}],["San Diego","California",1420000,170,27.0,6.54,{"SER":[40,31.0,0],"LMR":[40,22.0,0],"GEN":[20,4.0,10.38],"MOTO":[70,41.0,2.7]}],["Orlando","Florida",320000,170,25.6,4.09,{"SER":[50,31.0,0],"LMR":[50,23.0,1.05],"GEN":[20,29.0,7.14],"MOTO":[50,14.0,0]}],["Fort Worth","Texas",960000,170,22.8,4.62,{"SER":[50,45.0,0],"LMR":[90,18.0,1.07],"GEN":[10,10.0,8.17],"MOTO":[20,18.0,0]}],["Memphis","Tennessee",628000,170,26.2,2.3,{"SER":[70,28.0,2.71],"LMR":[40,18.0,1.89],"GEN":[10,13.0,0],"MOTO":[50,46.0,0]}],["Louisville","Kentucky",620000,160,0.2,3.25,{"SER":[40,0.3,3.31],"LMR":[70,0.3,1.62],"GEN":[10,0.1,4.83],"MOTO":[40,0.2,0]}],["St. Louis","Missouri",293000,160,17.2,2.55,{"SER":[40,31.0,0],"LMR":[90,24.0,2.55],"SBR":[10,9.0,0],"GEN":[20,5.0,0]}],["Tampa","Florida",410000,150,19.6,4.3,{"SER":[50,37.0,0],"LMR":[50,23.0,1.66],"GEN":[10,6.0,9.99],"MOTO":[40,16.0,1.25]}],["Portland","Oregon",635000,150,15.0,1.67,{"SER":[40,7.0,2.12],"LMR":[70,9.0,1.78],"GEN":[10,29.0,0],"MOTO":[30,15.0,1.12]}],["Oklahoma City","Oklahoma",710000,150,18.2,14.82,{"SER":[40,28.0,0],"LMR":[90,23.0,3.83],"GEN":[10,10.0,25.82],"MOTO":[10,12.0,0]}],["Cincinnati","Ohio",308000,140,18.6,2.6,{"SER":[20,31.0,0],"LMR":[90,24.0,2.6],"SBR":[10,17.0,0],"GEN":[10,11.0,0],"MOTO":[10,10.0,0]}],["Sacramento","California",530000,130,23.6,1.57,{"SER":[30,26.0,0],"LMR":[70,28.0,1.57],"GEN":[10,12.0,0],"MOTO":[20,21.0,0]}],["Salt Lake City","Utah",203000,130,17.4,11.14,{"SER":[40,20.0,0],"LMR":[50,19.0,0],"SBR":[10,9.0,0],"GEN":[10,29.0,18.02],"MOTO":[20,10.0,4.26]}],["Pittsburgh","Pennsylvania",302000,130,16.2,0,{"SER":[30,30.0,0],"LMR":[40,24.0,0],"SBR":[10,4.0,0],"GEN":[10,4.0,0],"MOTO":[40,19.0,0]}],["Vancouver","Washington",195000,130,14.4,0,{"SER":[90,28.0,0],"LMR":[30,7.0,0],"MOTO":[10,8.0,0]}],["Tulsa","Oklahoma",410000,130,16.2,1.36,{"SER":[20,2.0,0],"LMR":[90,7.0,1.36],"GEN":[10,10.0,0],"MOTO":[10,46.0,0]}],["Raleigh","North Carolina",470000,130,21.8,3.25,{"SER":[50,38.0,1.54],"LMR":[50,18.0,1.62],"GEN":[10,7.0,6.59],"MOTO":[20,24.0,0]}],["Rancho Cucamonga","California",175000,120,26.8,0,{"SER":[90,31.0,0],"LMR":[10,28.0,0],"GEN":[10,16.0,0],"MOTO":[10,28.0,0]}],["Milwaukee","Wisconsin",565000,110,25.2,2.79,{"SER":[30,30.0,0],"LMR":[40,28.0,2.21],"SBR":[20,27.0,0],"GEN":[10,6.0,3.38],"MOTO":[10,35.0,0]}],["Colorado Springs","Colorado",490000,110,13.0,1.83,{"SER":[40,23.0,2.22],"LMR":[30,5.0,1.44],"SBR":[10,4.0,0],"GEN":[10,8.0,0],"MOTO":[20,25.0,0]}],["New Orleans","Louisiana",370000,110,18.8,23.28,{"SER":[30,30.0,0],"LMR":[40,24.0,0],"GEN":[30,5.0,23.28],"MOTO":[10,16.0,0]}],["Greenville","South Carolina",75000,110,0.2,2.02,{"SER":[70,0.2,0],"LMR":[40,0.3,2.02]}],["Mobile","Alabama",180000,100,26.2,1.54,{"SER":[20,28.0,1.54],"LMR":[30,28.0,0],"GEN":[10,6.0,0],"MOTO":[40,38.0,0]}],["Fremont","California",240000,100,23.4,0,{"SER":[10,31.0,0],"LMR":[10,17.0,0],"GEN":[70,6.0,0],"MOTO":[10,32.0,0]}],["Gresham","Oregon",115000,100,22.2,0,{"SER":[70,26.0,0],"SBR":[10,31.0,0],"GEN":[10,12.0,0],"MOTO":[10,20.0,0]}],["Las Vegas","Nevada",660000,100,21.8,4.0,{"SER":[20,31.0,4.19],"LMR":[20,24.0,0],"GEN":[10,8.0,3.81],"MOTO":[50,15.0,0]}],["Jackson","Mississippi",150000,100,17.5,0,{"SER":[40,30.0,0],"LMR":[30,24.0,0],"GEN":[10,6.0,0],"MOTO":[20,10.0,0]}],["Overland Park","Kansas",200000,100,0.2,0,{"SER":[30,0.1,0],"LMR":[40,0.2,0],"SBR":[10,0.0,0],"GEN":[10,0.1,0],"MOTO":[10,0.2,0]}],["Richmond","Virginia",232000,100,12.2,1.49,{"SER":[40,23.0,0],"LMR":[40,6.0,1.49],"GEN":[10,7.0,0],"MOTO":[10,13.0,0]}],["St. Petersburg","Florida",260000,91,21.8,0,{"SER":[41,31.0,0],"LMR":[20,28.0,0],"GEN":[10,11.0,0],"MOTO":[20,8.0,0]}],["Lincoln","Nebraska",292000,90,23.8,1.66,{"SER":[40,26.0,0.91],"LMR":[30,24.0,2.4],"SBR":[10,23.0,0],"MOTO":[10,36.0,0]}],["Virginia Beach","Virginia",460000,90,21.5,20.27,{"SER":[20,23.0,0],"LMR":[50,23.0,0],"GEN":[10,29.0,20.27],"MOTO":[10,11.0,0]}],["Albuquerque","New Mexico",560000,90,21.0,0,{"SER":[40,31.0,0],"LMR":[30,28.0,0],"GEN":[10,10.0,0],"MOTO":[10,15.0,0]}],["Plymouth","Massachusetts",61000,90,0.2,0,{"SER":[10,0.4,0],"SBR":[10,0.1,0],"GEN":[70,0.1,0]}],["Spokane","Washington",230000,90,26.4,0,{"SER":[30,31.0,0],"LMR":[30,27.0,0],"SBR":[10,31.0,0],"GEN":[10,5.0,0],"MOTO":[10,38.0,0]}],["Corpus Christi","Texas",320000,90,26.2,0,{"SER":[50,31.0,0],"LMR":[20,28.0,0],"GEN":[10,10.0,0],"MOTO":[10,36.0,0]}],["Lexington","Kentucky",320000,90,0.2,0,{"SER":[20,0.3,0],"LMR":[30,0.1,0],"GEN":[10,0.1,0],"MOTO":[30,0.3,0]}],["St. Charles","Missouri",71000,90,17.4,0,{"SER":[20,31.0,0],"LMR":[40,9.0,0],"SBR":[10,23.0,0],"GEN":[10,14.0,0],"MOTO":[10,10.0,0]}],["Fresno","California",550000,80,20.8,0,{"SER":[20,24.0,0],"LMR":[40,24.0,0],"GEN":[10,8.0,0],"MOTO":[10,17.0,0]}],["Riverside","California",320000,80,23.2,0,{"SER":[20,30.0,0],"LMR":[30,23.0,0],"SBR":[10,31.0,0],"GEN":[10,10.0,0],"MOTO":[10,22.0,0]}],["Boise","Idaho",240000,80,23.0,0,{"SER":[30,31.0,0],"LMR":[30,28.0,0],"GEN":[10,8.0,0],"MOTO":[10,17.0,0]}],["El Paso","Texas",680000,80,16.8,0,{"SER":[40,31.0,0],"LMR":[20,28.0,0],"GEN":[10,4.0,0],"MOTO":[10,4.0,0]}],["Columbia","South Carolina",137000,80,0.3,2.05,{"SER":[20,0.3,0],"LMR":[30,0.3,2.05],"GEN":[30,0.2,0]}],["Grand Rapids","Michigan",200000,80,25.0,0,{"SER":[30,31.0,0],"LMR":[20,24.0,0],"SBR":[10,17.0,0],"GEN":[10,7.0,0],"MOTO":[10,46.0,0]}],["Bethel","Alaska",6000,71,39.0,0,{"SER":[10,40.0,0],"LMR":[31,0,0],"SBR":[10,30.0,0],"GEN":[10,30.0,0],"MOTO":[10,56.0,0]}],["Huntsville","Alabama",231000,70,26.0,0,{"SER":[40,33.0,0],"LMR":[20,28.0,0],"MOTO":[10,25.0,0]}],["Scottsdale","Arizona",250000,70,26.8,0,{"SER":[20,31.0,0],"LMR":[10,24.0,0],"GEN":[10,12.0,0],"MOTO":[30,33.0,0]}],["Wilmington","Delaware",71000,70,24.6,0,{"SER":[10,34.0,0],"LMR":[20,23.0,0],"SBR":[10,23.0,0],"GEN":[30,17.0,0]}],["San Francisco","California",820000,70,22.2,3.58,{"SER":[20,31.0,0],"SBR":[10,32.0,0],"GEN":[10,2.0,3.58],"MOTO":[30,24.0,0]}],["Bakersfield","California",410000,70,22.8,0,{"SER":[10,31.0,0],"LMR":[40,24.0,0],"GEN":[10,7.0,0],"MOTO":[10,21.0,0]}],["Fontana","California",215000,70,25.8,0,{"SER":[10,31.0,0],"LMR":[20,31.0,0],"GEN":[10,9.0,0],"MOTO":[30,28.0,0]}],["Cape Coral","Florida",210000,70,20.6,18.13,{"SER":[20,28.0,0],"LMR":[20,28.0,0],"GEN":[10,7.0,18.13],"MOTO":[20,9.0,0]}],["Tallahassee","Florida",200000,70,20.2,0,{"SER":[20,28.0,0],"LMR":[20,8.0,0],"GEN":[10,4.0,0],"MOTO":[20,30.0,0]}],["Lakeland","Florida",115000,70,23.4,0,{"SER":[20,28.0,0],"LMR":[20,24.0,0],"SBR":[10,31.0,0],"GEN":[10,3.0,0],"MOTO":[10,31.0,0]}],["Savannah","Georgia",150000,70,21.4,0,{"SER":[20,24.0,0],"LMR":[20,18.0,0],"GEN":[10,7.0,0],"MOTO":[20,21.0,0]}],["Aurora","Colorado",405000,70,19.8,1.82,{"SER":[20,28.0,1.82],"LMR":[20,23.0,0],"SBR":[10,26.0,0],"GEN":[10,10.0,0],"MOTO":[10,12.0,0]}],["Medford","Oregon",87000,70,23.8,0,{"SER":[20,31.0,0],"LMR":[20,23.0,0],"SBR":[10,31.0,0],"GEN":[10,3.0,0],"MOTO":[10,31.0,0]}],["Baton Rouge","Louisiana",220000,70,16.8,11.88,{"SER":[20,26.0,0],"LMR":[30,24.0,0],"GEN":[10,7.0,11.88],"MOTO":[10,10.0,0]}],["Kansas City","Kansas",155000,70,0.2,0,{"SER":[20,0.2,0],"LMR":[30,0.2,0],"GEN":[10,0.1,0],"MOTO":[10,0.1,0]}],["Chesapeake","Virginia",250000,70,23.2,0,{"SER":[20,30.0,0],"LMR":[30,23.0,0],"GEN":[10,7.0,0],"MOTO":[10,33.0,0]}],["Tacoma","Washington",220000,70,23.8,0,{"SER":[20,26.0,0],"LMR":[30,24.0,0],"GEN":[10,6.0,0],"MOTO":[10,32.0,0]}],["Olympia","Washington",53000,70,20.8,0,{"SER":[20,31.0,0],"LMR":[20,24.0,0],"SBR":[10,31.0,0],"GEN":[10,9.0,0],"MOTO":[10,9.0,0]}],["Dayton","Ohio",135000,70,21.4,0,{"SER":[10,24.0,0],"LMR":[30,24.0,0],"SBR":[10,25.0,0],"GEN":[10,8.0,0],"MOTO":[10,26.0,0]}],["McKinney","Texas",210000,70,20.0,0,{"SER":[30,31.0,0],"LMR":[20,33.0,0],"GEN":[10,8.0,0],"MOTO":[10,8.0,0]}],["Charleston","South Carolina",156000,70,0.2,0.93,{"SER":[20,0.3,0.93],"LMR":[20,0.3,0],"GEN":[30,0.1,0]}],["Chattanooga","Tennessee",184000,70,24.8,0,{"SER":[20,28.0,0],"LMR":[30,24.0,0],"SBR":[10,13.0,0],"MOTO":[10,34.0,0]}],["Greensboro","North Carolina",300000,70,24.5,1.49,{"SER":[20,28.0,0],"LMR":[30,33.0,1.49],"GEN":[10,11.0,0],"MOTO":[10,26.0,0]}],["Kodiak","Alaska",6300,61,32.2,0,{"LMR":[31,0,0],"SBR":[10,30.0,0],"GEN":[10,20.0,0],"MOTO":[10,24.0,0]}],["Tempe","Arizona",190000,60,25.0,0,{"SER":[30,42.0,0],"LMR":[10,18.0,0],"GEN":[10,10.0,0],"MOTO":[10,25.0,0]}],["Anaheim","California",350000,60,21.0,0,{"SER":[10,31.0,0],"LMR":[20,9.0,0],"SBR":[10,34.0,0],"GEN":[10,13.0,0],"MOTO":[10,18.0,0]}],["Madison","Wisconsin",275000,60,13.2,1.95,{"SER":[20,23.0,0],"LMR":[10,8.0,1.95],"SBR":[10,8.0,0],"GEN":[10,9.0,0],"MOTO":[10,18.0,0]}],["Fort Lauderdale","Florida",185000,60,27.8,10.11,{"SER":[20,39.0,0],"LMR":[20,24.0,0],"GEN":[10,9.0,18.44],"MOTO":[10,36.0,1.78]}],["Largo","Florida",95000,60,21.4,0,{"SER":[20,31.0,0],"LMR":[10,28.0,0],"SBR":[10,34.0,0],"GEN":[10,5.0,0],"MOTO":[10,9.0,0]}],["Columbus","Georgia",207000,60,27.4,0,{"SER":[10,30.0,0],"LMR":[20,24.0,0],"GEN":[10,29.0,0],"MOTO":[20,23.0,0]}],["Sandy Springs","Georgia",110000,60,24.8,0,{"SER":[10,31.0,0],"LMR":[20,19.0,0],"SBR":[10,31.0,0],"GEN":[10,12.0,0],"MOTO":[10,31.0,0]}],["Alpharetta","Georgia",67000,60,13.8,2.35,{"SER":[10,16.0,0],"LMR":[20,8.0,2.35],"SBR":[10,31.0,0],"GEN":[10,8.0,0],"MOTO":[10,6.0,0]}],["Marietta","Georgia",61000,60,25.2,2.16,{"SER":[10,30.0,0],"LMR":[20,27.0,2.16],"SBR":[10,31.0,0],"GEN":[10,29.0,0],"MOTO":[10,9.0,0]}],["Lawrenceville","Georgia",29000,60,23.0,1.54,{"SER":[10,31.0,0],"LMR":[20,12.0,1.54],"SBR":[10,28.0,0],"GEN":[10,13.0,0],"MOTO":[10,31.0,0]}],["Lakewood","Colorado",160000,60,21.2,0,{"SER":[20,45.0,0],"LMR":[10,23.0,0],"SBR":[10,13.0,0],"GEN":[10,9.0,0],"MOTO":[10,16.0,0]}],["Fort Wayne","Indiana",265000,60,16.6,2.59,{"SER":[10,16.0,0],"LMR":[30,24.0,2.59],"SBR":[10,3.0,0],"GEN":[10,14.0,0]}],["Rockford","Illinois",145000,60,19.2,0,{"SER":[20,24.0,0],"LMR":[20,22.0,0],"SBR":[10,13.0,0],"GEN":[10,5.0,0]}],["Manchester","New Hampshire",116000,60,17.0,0,{"SER":[10,39.0,0],"LMR":[10,10.0,0],"SBR":[10,4.0,0],"GEN":[10,9.0,0],"MOTO":[20,23.0,0]}],["Ogden","Utah",87000,60,22.8,0,{"SER":[20,35.0,0],"LMR":[10,33.0,0],"SBR":[10,16.0,0],"GEN":[10,18.0,0],"MOTO":[10,12.0,0]}],["Newark","New Jersey",305000,60,0.2,0,{"SER":[10,0.3,0],"LMR":[10,0.2,0],"GEN":[10,0.1,0],"MOTO":[30,0.2,0]}],["Lenexa","Kansas",55000,60,0.2,0,{"SER":[20,0.1,0],"LMR":[20,0.2,0],"SBR":[10,0.0,0],"MOTO":[10,0.2,0]}],["Topeka","Kansas",126000,60,0.3,0,{"SER":[10,0.3,0],"LMR":[20,0.2,0],"SBR":[10,0.0,0],"GEN":[10,0.0,0],"MOTO":[10,0.3,0]}],["Norfolk","Virginia",238000,60,28.2,0,{"SER":[20,45.0,0],"LMR":[20,24.0,0],"GEN":[10,29.0,0],"MOTO":[10,15.0,0]}],["Erie","Pennsylvania",94000,60,26.4,0,{"SER":[10,31.0,0],"LMR":[20,24.0,0],"SBR":[10,23.0,0],"GEN":[10,17.0,0],"MOTO":[10,37.0,0]}],["Lancaster","Pennsylvania",58000,60,15.2,0,{"SER":[10,12.0,0],"LMR":[10,8.0,0],"GEN":[30,5.0,0],"MOTO":[10,36.0,0]}],["York","Pennsylvania",45000,60,7.5,0,{"SER":[10,3.0,0],"LMR":[10,4.0,0],"GEN":[30,4.0,0],"MOTO":[10,19.0,0]}],["Toledo","Ohio",268000,60,18.2,0,{"SER":[10,22.0,0],"LMR":[30,21.0,0],"GEN":[10,4.0,0],"MOTO":[10,26.0,0]}],["Akron","Ohio",190000,60,25.8,0,{"SER":[10,30.0,0],"LMR":[20,24.0,0],"SBR":[10,26.0,0],"GEN":[10,11.0,0],"MOTO":[10,38.0,0]}],["Portland","Maine",68000,60,25.8,0,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"SBR":[10,22.0,0],"GEN":[20,29.0,0],"MOTO":[10,25.0,0]}],["Arlington","Texas",400000,60,22.2,12.0,{"SER":[10,31.0,0],"LMR":[30,33.0,0],"GEN":[10,8.0,12.0],"MOTO":[10,17.0,0]}],["Lubbock","Texas",260000,60,26.8,0,{"SER":[10,55.0,0],"LMR":[30,3.0,0],"GEN":[10,3.0,0],"MOTO":[10,46.0,0]}],["Springfield","Missouri",170000,60,20.7,1.9,{"SER":[20,30.0,0],"LMR":[30,24.0,1.9],"GEN":[10,8.0,0]}],["Clarksville","Tennessee",166000,60,23.0,0,{"SER":[20,30.0,0],"LMR":[20,22.0,0],"SBR":[10,12.0,0],"MOTO":[10,28.0,0]}],["Winston-Salem","North Carolina",250000,60,22.2,0,{"SER":[20,23.0,0],"LMR":[20,23.0,0],"GEN":[10,8.0,0],"MOTO":[10,35.0,0]}],["Fayetteville","North Carolina",210000,60,24.5,1.98,{"SER":[20,31.0,1.98],"LMR":[20,24.0,0],"GEN":[10,13.0,0],"MOTO":[10,30.0,0]}],["Wilmington","North Carolina",120000,60,24.0,1.58,{"SER":[10,34.0,0],"LMR":[10,22.0,1.58],"GEN":[30,6.0,0],"MOTO":[10,34.0,0]}],["High Point","North Carolina",115000,60,21.8,0,{"SER":[10,24.0,0],"LMR":[20,18.0,0],"SBR":[10,31.0,0],"GEN":[10,10.0,0],"MOTO":[10,26.0,0]}],["Naperville","Illinois",150000,53,15.0,1.94,{"SER":[10,23.0,0],"LMR":[23,10.0,1.94],"SBR":[10,19.0,0],"GEN":[10,4.0,0]}],["Montgomery","Alabama",192000,50,28.4,0,{"SER":[10,28.0,0],"LMR":[20,28.0,0],"GEN":[10,29.0,0],"MOTO":[10,29.0,0]}],["Hoover","Alabama",92000,50,26.0,0,{"SER":[10,31.0,0],"LMR":[10,23.0,0],"SBR":[10,31.0,0],"GEN":[10,29.0,0],"MOTO":[10,16.0,0]}],["Dothan","Alabama",71000,50,24.4,0,{"SER":[10,28.0,0],"LMR":[10,23.0,0],"SBR":[10,31.0,0],"GEN":[10,11.0,0],"MOTO":[10,29.0,0]}],["Vestavia Hills","Alabama",36000,50,27.8,0,{"SER":[10,31.0,0],"LMR":[20,20.0,0],"SBR":[10,34.0,0],"GEN":[10,7.0,0]}],["Tucson","Arizona",550000,50,20.6,0,{"SER":[20,30.0,0],"LMR":[10,22.0,0],"GEN":[10,3.0,0],"MOTO":[10,17.0,0]}],["Peoria","Arizona",200000,50,22.8,0,{"SER":[20,31.0,0],"LMR":[10,24.0,0],"GEN":[10,19.0,0],"MOTO":[10,12.0,0]}],["Mesa","Arizona",520000,50,25.4,0,{"SER":[10,26.0,0],"LMR":[10,18.0,0],"GEN":[10,17.0,0],"MOTO":[20,28.0,0]}],["Gilbert","Arizona",270000,50,26.2,0,{"SER":[10,28.0,0],"LMR":[20,24.0,0],"GEN":[10,20.0,0],"MOTO":[10,28.0,0]}],["Glendale","Arizona",250000,50,22.2,3.03,{"SER":[10,26.0,0],"LMR":[20,22.0,3.18],"GEN":[10,15.0,0],"MOTO":[10,14.0,2.87]}],["Surprise","Arizona",150000,50,26.6,0,{"SER":[10,34.0,0],"LMR":[10,24.0,0],"SBR":[10,39.0,0],"GEN":[10,20.0,0],"MOTO":[10,16.0,0]}],["Goodyear","Arizona",115000,50,23.2,0,{"SER":[10,28.0,0],"LMR":[10,22.0,0],"SBR":[10,39.0,0],"GEN":[10,20.0,0],"MOTO":[10,7.0,0]}],["Buckeye","Arizona",110000,50,21.4,4.19,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"SBR":[10,34.0,0],"GEN":[10,10.0,4.19],"MOTO":[10,10.0,0]}],["Avondale","Arizona",95000,50,23.2,0,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"SBR":[10,34.0,0],"GEN":[10,15.0,0],"MOTO":[10,14.0,0]}],["Sahuarita","Arizona",34000,50,26.6,5.02,{"SER":[10,31.0,0],"LMR":[10,18.0,0],"SBR":[10,33.0,0],"GEN":[10,20.0,5.02],"MOTO":[10,31.0,0]}],["Anchorage","Alaska",288000,50,21.8,0,{"SER":[20,28.0,0],"LMR":[10,24.0,0],"SBR":[10,18.0,0],"GEN":[10,8.0,0]}],["Benton","Arkansas",37000,50,21.6,0,{"SER":[20,21.0,0],"LMR":[10,28.0,0],"SBR":[10,31.0,0],"GEN":[10,7.0,0]}],["Fayetteville","Arkansas",101000,50,20.6,0,{"SER":[10,32.0,0],"LMR":[10,9.0,0],"SBR":[10,21.0,0],"GEN":[10,9.0,0],"MOTO":[10,32.0,0]}],["Springdale","Arkansas",87000,50,22.6,0,{"SER":[10,31.0,0],"LMR":[10,10.0,0],"SBR":[10,31.0,0],"GEN":[10,10.0,0],"MOTO":[10,31.0,0]}],["Newark","Delaware",34000,50,25.6,0,{"SER":[10,31.0,0],"LMR":[10,18.0,0],"GEN":[30,14.0,0]}],["Long Beach","California",460000,50,22.2,0,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"GEN":[10,10.0,0],"MOTO":[20,21.0,0]}],["Oakland","California",430000,50,25.8,0,{"SER":[10,31.0,0],"LMR":[20,22.0,0],"GEN":[10,14.0,0],"MOTO":[10,31.0,0]}],["San Bernardino","California",220000,50,24.2,0,{"SER":[10,31.0,0],"LMR":[20,28.0,0],"GEN":[10,9.0,0],"MOTO":[10,22.0,0]}],["Modesto","California",220000,50,27.4,0,{"SER":[10,31.0,0],"LMR":[20,24.0,0],"GEN":[10,15.0,0],"MOTO":[10,32.0,0]}],["Clearwater","Florida",116000,50,21.6,0,{"SER":[20,31.0,0],"LMR":[10,28.0,0],"GEN":[10,4.0,0],"MOTO":[10,17.0,0]}],["Palm Bay","Florida",120000,50,23.6,0,{"SER":[20,37.0,0],"LMR":[10,28.0,0],"GEN":[10,8.0,0],"MOTO":[10,10.0,0]}],["Pompano Beach","Florida",112000,50,24.2,0,{"SER":[20,21.0,0],"LMR":[10,24.0,0],"GEN":[10,9.0,0],"MOTO":[10,36.0,0]}],["Fort Myers","Florida",79000,50,20.0,18.13,{"SER":[20,24.0,0],"LMR":[10,22.0,0],"GEN":[10,8.0,18.13],"MOTO":[10,15.0,0]}],["Port St. Lucie","Florida",220000,50,25.4,0,{"SER":[10,31.0,0],"LMR":[20,22.0,0],"GEN":[10,8.0,0],"MOTO":[10,31.0,0]}],["Hollywood","Florida",153000,50,21.4,0,{"SER":[10,36.0,0],"LMR":[20,23.0,0],"GEN":[10,9.0,0],"MOTO":[10,8.0,0]}],["Gainesville","Florida",145000,50,32.4,1.64,{"SER":[10,38.0,0],"LMR":[10,23.0,1.64],"SBR":[10,31.0,0],"GEN":[10,29.0,0],"MOTO":[10,41.0,0]}],["Miami Gardens","Florida",113000,50,26.6,0.77,{"SER":[10,40.0,0],"LMR":[10,23.0,0.77],"SBR":[10,34.0,0],"GEN":[10,6.0,0],"MOTO":[10,30.0,0]}],["West Palm Beach","Florida",117000,50,20.2,1.98,{"SER":[10,30.0,1.57],"LMR":[20,7.0,2.39],"GEN":[10,9.0,0],"MOTO":[10,27.0,0]}],["Davie","Florida",111000,50,20.4,0,{"SER":[10,20.0,0],"LMR":[10,23.0,0],"SBR":[10,16.0,0],"GEN":[10,13.0,0],"MOTO":[10,30.0,0]}],["Boca Raton","Florida",99000,50,21.2,4.66,{"SER":[10,11.0,4.66],"LMR":[10,5.0,0],"SBR":[10,31.0,0],"GEN":[10,9.0,0],"MOTO":[10,50.0,0]}],["Sunrise","Florida",97000,50,20.4,0,{"SER":[10,18.0,0],"LMR":[10,28.0,0],"SBR":[10,37.0,0],"GEN":[10,10.0,0],"MOTO":[10,9.0,0]}],["Plantation","Florida",96000,50,23.6,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"SBR":[10,34.0,0],"GEN":[10,7.0,0],"MOTO":[10,22.0,0]}],["Deltona","Florida",95000,50,21.6,1.0,{"SER":[10,31.0,0],"LMR":[10,24.0,1.0],"SBR":[10,31.0,0],"GEN":[10,6.0,0],"MOTO":[10,16.0,0]}],["Palm Coast","Florida",93000,50,25.2,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"SBR":[10,34.0,0],"GEN":[10,9.0,0],"MOTO":[10,28.0,0]}],["Deerfield Beach","Florida",87000,50,26.6,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"SBR":[10,30.0,0],"GEN":[10,18.0,0],"MOTO":[10,30.0,0]}],["Lauderhill","Florida",80000,50,25.4,1.12,{"SER":[10,24.0,0],"LMR":[10,24.0,1.12],"SBR":[10,34.0,0],"GEN":[10,6.0,0],"MOTO":[10,39.0,0]}],["Macon","Georgia",156000,50,25.8,0,{"SER":[20,28.0,0],"LMR":[10,22.0,0],"SBR":[10,27.0,0],"GEN":[10,31.0,0]}],["Athens","Georgia",130000,50,22.2,0,{"SER":[10,25.0,0],"LMR":[20,21.0,0],"GEN":[10,11.0,0],"MOTO":[10,23.0,0]}],["Johns Creek","Georgia",83000,50,22.2,3.15,{"SER":[10,51.0,0],"LMR":[10,6.0,3.15],"SBR":[10,23.0,0],"GEN":[10,7.0,0],"MOTO":[10,24.0,0]}],["Valdosta","Georgia",55000,50,30.0,0,{"SER":[10,31.0,0],"LMR":[10,28.0,0],"SBR":[10,34.0,0],"GEN":[10,29.0,0],"MOTO":[10,28.0,0]}],["New Haven","Connecticut",134000,50,16.0,0,{"SER":[10,62.0,0],"LMR":[10,3.0,0],"SBR":[10,3.0,0],"GEN":[10,4.0,0],"MOTO":[10,8.0,0]}],["Hartford","Connecticut",121000,50,13.2,1.57,{"SER":[10,39.0,0],"LMR":[10,7.0,1.57],"SBR":[10,9.0,0],"GEN":[10,3.0,0],"MOTO":[10,8.0,0]}],["Pueblo","Colorado",112000,50,18.8,0,{"SER":[20,28.0,0],"LMR":[10,24.0,0],"GEN":[10,8.0,0],"MOTO":[10,32.0,0]}],["Thornton","Colorado",145000,50,21.4,0,{"SER":[10,36.0,0],"LMR":[20,22.0,0],"GEN":[10,11.0,0],"MOTO":[10,19.0,0]}],["Westminster","Colorado",115000,50,26.8,16.53,{"SER":[10,63.0,0],"LMR":[20,22.0,0],"GEN":[10,11.0,16.53],"MOTO":[10,27.0,0]}],["Grand Junction","Colorado",72000,50,24.0,0,{"SER":[10,28.0,0],"LMR":[10,22.0,0],"SBR":[10,28.0,0],"GEN":[10,25.0,0],"MOTO":[10,17.0,0]}],["Nampa","Idaho",110000,50,24.4,0,{"SER":[10,24.0,0],"LMR":[20,28.0,0],"GEN":[10,8.0,0],"MOTO":[10,31.0,0]}],["Carmel","Indiana",103000,50,14.0,0,{"SER":[20,17.0,0],"LMR":[20,3.0,0],"SBR":[10,3.0,0]}],["Lafayette","Indiana",65000,50,20.4,0,{"SER":[10,39.0,0],"LMR":[20,22.0,0],"GEN":[10,17.0,0],"MOTO":[10,8.0,0]}],["Aurora","Illinois",180000,50,23.4,0,{"SER":[20,22.0,0],"LMR":[20,24.0,0],"SBR":[10,24.0,0]}],["Springfield","Illinois",115000,50,17.6,0,{"SER":[10,20.0,0],"LMR":[20,20.0,0],"SBR":[10,33.0,0],"MOTO":[10,7.0,0]}],["Salem","Oregon",180000,50,21.5,0,{"SER":[10,37.0,0],"LMR":[20,24.0,0],"GEN":[10,5.0,0],"MOTO":[10,20.0,0]}],["Eugene","Oregon",175000,50,9.0,0,{"SER":[10,14.0,0],"LMR":[20,7.0,0],"GEN":[10,5.0,0],"MOTO":[10,10.0,0]}],["Shreveport","Louisiana",185000,50,25.8,0,{"SER":[10,28.0,0],"LMR":[20,20.0,0],"GEN":[10,29.0,0],"MOTO":[10,26.0,0]}],["Reno","Nevada",270000,50,21.6,0,{"SER":[10,34.0,0],"LMR":[10,25.0,0],"SBR":[10,17.0,0],"GEN":[10,12.0,0],"MOTO":[10,20.0,0]}],["Whitney","Nevada",44000,50,21.6,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"SBR":[10,31.0,0],"GEN":[10,8.0,0],"MOTO":[10,14.0,0]}],["Winchester","Nevada",38000,50,21.4,0,{"SER":[10,31.0,0],"LMR":[10,18.0,0],"SBR":[10,33.0,0],"GEN":[10,10.0,0],"MOTO":[10,15.0,0]}],["Southaven","Mississippi",60000,50,31.0,0,{"SER":[10,31.0,0],"LMR":[10,18.0,0],"SBR":[10,31.0,0],"GEN":[10,29.0,0],"MOTO":[10,46.0,0]}],["Madison","Mississippi",25000,50,25.6,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"SBR":[10,35.0,0],"GEN":[10,8.0,0],"MOTO":[10,30.0,0]}],["Jersey City","New Jersey",286000,50,0.2,0,{"SER":[10,0.2,0],"LMR":[10,0.2,0],"GEN":[10,0.1,0],"MOTO":[20,0.1,0]}],["Paterson","New Jersey",160000,50,0.2,0,{"SER":[10,0.4,0],"LMR":[10,0.2,0],"SBR":[10,0.0,0],"GEN":[10,0.1,0],"MOTO":[10,0.3,0]}],["Buffalo","New York",276000,50,28.5,0,{"SER":[40,31.0,0],"MOTO":[10,26.0,0]}],["Olathe","Kansas",143000,50,0.2,0,{"SER":[20,0.2,0],"LMR":[20,0.2,0],"MOTO":[10,0.2,0]}],["Wichita","Kansas",400000,50,0.4,0,{"SER":[10,0.4,0],"LMR":[10,0.3,0],"SBR":[10,0.4,0],"GEN":[10,0.2,0],"MOTO":[10,0.5,0]}],["Newport News","Virginia",185000,50,25.2,0,{"SER":[10,29.0,0],"LMR":[20,23.0,0],"GEN":[10,8.0,0],"MOTO":[10,41.0,0]}],["Alexandria","Virginia",160000,50,9.8,0,{"SER":[10,9.0,0],"LMR":[10,18.0,0],"SBR":[10,2.0,0],"GEN":[10,6.0,0],"MOTO":[10,14.0,0]}],["Hampton","Virginia",137000,50,21.2,0,{"SER":[10,24.0,0],"LMR":[20,24.0,0],"GEN":[10,29.0,0],"MOTO":[10,8.0,0]}],["Harrisonburg","Virginia",52000,50,29.6,0,{"SER":[10,35.0,0],"LMR":[10,23.0,0],"SBR":[10,31.0,0],"GEN":[10,29.0,0],"MOTO":[10,30.0,0]}],["Bethlehem","Pennsylvania",76000,50,28.2,0,{"SER":[10,40.0,0],"LMR":[10,23.0,0],"SBR":[10,38.0,0],"GEN":[10,6.0,0],"MOTO":[10,34.0,0]}],["Harrisburg","Pennsylvania",51000,50,18.3,0,{"SER":[10,28.0,0],"LMR":[10,19.0,0],"GEN":[30,8.0,0]}],["Providence","Rhode Island",190000,50,30.4,0,{"SER":[10,35.0,0],"LMR":[10,29.0,0],"SBR":[10,31.0,0],"GEN":[10,29.0,0],"MOTO":[10,28.0,0]}],["Haverhill","Massachusetts",67000,50,0.2,0,{"SER":[20,0.3,0],"LMR":[10,0.2,0],"SBR":[10,0.1,0],"GEN":[10,0.1,0]}],["Springfield","Massachusetts",155000,50,0.2,0,{"SER":[10,0.3,0],"LMR":[10,0.3,0],"SBR":[10,0.2,0],"GEN":[10,0.1,0],"MOTO":[10,0.1,0]}],["New Bedford","Massachusetts",100000,50,0.2,0,{"SER":[10,0.3,0],"LMR":[10,0.2,0],"SBR":[10,0.1,0],"GEN":[10,0.1,0],"MOTO":[10,0.3,0]}],["Yakima","Washington",97000,50,22.2,0,{"SER":[20,28.0,0],"LMR":[10,24.0,0],"SBR":[10,28.0,0],"GEN":[10,5.0,0]}],["Renton","Washington",107000,50,28.2,0,{"SER":[10,38.0,0],"LMR":[10,20.0,0],"SBR":[10,37.0,0],"GEN":[10,29.0,0],"MOTO":[10,17.0,0]}],["Federal Way","Washington",101000,50,24.8,0,{"SER":[10,28.0,0],"LMR":[20,18.0,0],"SBR":[10,31.0,0],"GEN":[10,7.0,0]}],["Kirkland","Washington",94000,50,27.8,0,{"SER":[10,31.0,0],"LMR":[10,32.0,0],"SBR":[10,34.0,0],"GEN":[10,6.0,0],"MOTO":[10,36.0,0]}],["Auburn","Washington",87000,50,21.0,0,{"SER":[10,26.0,0],"LMR":[10,24.0,0],"SBR":[10,23.0,0],"GEN":[10,6.0,0],"MOTO":[10,26.0,0]}],["Redmond","Washington",67000,50,26.2,0,{"SER":[10,31.0,0],"LMR":[10,20.0,0],"SBR":[10,30.0,0],"GEN":[10,29.0,0],"MOTO":[10,21.0,0]}],["Burien","Washington",51000,50,25.4,0,{"SER":[10,28.0,0],"LMR":[10,30.0,0],"SBR":[10,28.0,0],"GEN":[10,9.0,0],"MOTO":[10,32.0,0]}],["Parma","Ohio",79000,50,22.4,0,{"SER":[10,17.0,0],"LMR":[10,24.0,0],"SBR":[10,22.0,0],"GEN":[10,9.0,0],"MOTO":[10,40.0,0]}],["Canton","Ohio",70000,50,17.8,0,{"SER":[10,28.0,0],"LMR":[20,24.0,0],"GEN":[10,11.0,0],"MOTO":[10,8.0,0]}],["Springfield","Ohio",58000,50,27.0,0,{"SER":[10,34.0,0],"LMR":[10,24.0,0],"SBR":[10,31.0,0],"GEN":[10,14.0,0],"MOTO":[10,32.0,0]}],["Beavercreek","Ohio",47000,50,26.8,0,{"SER":[10,38.0,0],"LMR":[20,28.0,0],"SBR":[10,31.0,0],"GEN":[10,10.0,0]}],["Fairfield","Ohio",42000,50,18.2,0,{"SER":[10,31.0,0],"LMR":[20,5.0,0],"SBR":[10,27.0,0],"MOTO":[10,10.0,0]}],["Plano","Texas",290000,50,16.8,0,{"SER":[10,24.0,0],"LMR":[20,26.0,0],"GEN":[10,9.0,0],"MOTO":[10,8.0,0]}],["Garland","Texas",240000,50,25.2,0,{"SER":[10,33.0,0],"LMR":[20,26.0,0],"GEN":[10,9.0,0],"MOTO":[10,33.0,0]}],["Bowling Green","Kentucky",75000,50,0.3,0,{"SER":[10,0.3,0],"LMR":[30,0.2,0],"SBR":[10,0.3,0]}],["Owensboro","Kentucky",60000,50,0.3,0,{"SER":[10,0.3,0],"LMR":[10,0.3,0],"SBR":[10,0.3,0],"GEN":[10,0.3,0],"MOTO":[10,0.5,0]}],["Broken Arrow","Oklahoma",115000,50,24.5,0,{"SER":[10,30.0,0],"LMR":[20,24.0,0],"SBR":[10,34.0,0],"MOTO":[10,10.0,0]}],["North Charleston","South Carolina",118000,50,0.2,1.36,{"SER":[20,0.3,1.36],"LMR":[10,0.2,0],"SBR":[10,0.4,0],"GEN":[10,0.1,0]}],["Warren","Michigan",138000,50,18.2,1.89,{"SER":[10,33.0,0],"LMR":[20,24.0,1.89],"SBR":[10,9.0,0],"GEN":[10,7.0,0]}],["Flint","Michigan",72000,50,19.4,0,{"SER":[10,31.0,0],"LMR":[10,9.0,0],"SBR":[10,31.0,0],"GEN":[10,4.0,0],"MOTO":[10,22.0,0]}],["Independence","Missouri",123000,50,20.6,0,{"SER":[20,28.0,0],"LMR":[10,24.0,0],"SBR":[10,23.0,0],"GEN":[10,14.0,0]}],["Murfreesboro","Tennessee",157000,50,29.2,0,{"SER":[20,28.0,0],"LMR":[10,28.0,0],"SBR":[10,15.0,0],"MOTO":[10,46.0,0]}],["Asheville","North Carolina",95000,50,27.0,0,{"SER":[20,31.0,0],"LMR":[10,23.0,0],"GEN":[10,8.0,0],"MOTO":[10,46.0,0]}],["Durham","North Carolina",285000,50,19.2,1.22,{"SER":[10,24.0,0],"LMR":[20,23.0,1.22],"GEN":[10,25.0,0],"MOTO":[10,5.0,0]}],["Concord","North Carolina",105000,50,26.0,0,{"SER":[10,38.0,0],"LMR":[10,24.0,0],"SBR":[10,31.0,0],"GEN":[10,9.0,0],"MOTO":[10,28.0,0]}],["Mooresville","North Carolina",40000,50,23.2,0,{"SER":[10,28.0,0],"LMR":[10,27.0,0],"SBR":[10,37.0,0],"GEN":[10,8.0,0],"MOTO":[10,16.0,0]}],["Tuscaloosa","Alabama",116000,40,27.2,0,{"SER":[10,31.0,0],"LMR":[10,32.0,0],"SBR":[10,36.0,0],"GEN":[10,5.0,0]}],["Auburn","Alabama",85000,40,25.4,0,{"SER":[10,30.0,0],"LMR":[10,31.0,0],"SBR":[10,31.0,0],"MOTO":[10,31.0,0]}],["Madison","Alabama",63000,40,30.0,0,{"SER":[10,48.0,0],"LMR":[10,24.0,0],"SBR":[10,37.0,0],"MOTO":[10,32.0,0]}],["Decatur","Alabama",58000,40,23.8,0,{"SER":[10,30.0,0],"LMR":[10,19.0,0],"SBR":[10,31.0,0],"GEN":[10,30.0,0]}],["Opelika","Alabama",32000,40,25.2,0,{"SER":[10,28.0,0],"LMR":[10,29.0,0],"SBR":[10,36.0,0],"MOTO":[10,28.0,0]}],["Bessemer","Alabama",26000,40,27.6,0,{"SER":[10,40.0,0],"LMR":[10,23.0,0],"SBR":[10,31.0,0],"GEN":[10,29.0,0]}],["Homewood","Alabama",26000,40,27.0,0,{"SER":[10,31.0,0],"LMR":[10,20.0,0],"SBR":[10,37.0,0],"MOTO":[10,18.0,0]}],["Athens","Alabama",23000,40,28.4,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"SBR":[10,28.0,0],"GEN":[10,29.0,0]}],["Millbrook","Alabama",16000,40,26.8,0,{"SER":[10,31.0,0],"LMR":[10,31.0,0],"SBR":[10,33.0,0],"GEN":[10,18.0,0]}],["Chandler","Arizona",280000,40,18.0,0,{"SER":[10,28.0,0],"LMR":[10,2.0,0],"GEN":[10,20.0,0],"MOTO":[10,12.0,0]}],["Flagstaff","Arizona",78000,40,25.4,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"GEN":[10,18.0,0],"MOTO":[10,26.0,0]}],["Queen Creek","Arizona",75000,40,26.2,0,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"SBR":[10,31.0,0],"MOTO":[10,29.0,0]}],["Lake Havasu City","Arizona",58000,40,25.8,0,{"SER":[10,31.0,0],"SBR":[10,31.0,0],"GEN":[10,29.0,0],"MOTO":[10,8.0,0]}],["Prescott Valley","Arizona",50000,40,26.8,0,{"SER":[10,31.0,0],"LMR":[10,31.0,0],"SBR":[10,31.0,0],"MOTO":[10,37.0,0]}],["Oro Valley","Arizona",48000,40,26.4,0,{"SER":[10,34.0,0],"LMR":[10,24.0,0],"SBR":[10,30.0,0],"GEN":[10,8.0,0]}],["Bentonville","Arkansas",58000,40,26.6,0,{"SER":[20,42.0,0],"LMR":[10,23.0,0],"GEN":[10,18.0,0]}],["Bryant","Arkansas",17000,40,31.2,0,{"SER":[20,30.0,0],"LMR":[10,23.0,0],"SBR":[10,37.0,0]}],["Little Rock","Arkansas",201000,40,22.2,0,{"SER":[10,32.0,0],"LMR":[10,10.0,0],"GEN":[10,10.0,0],"MOTO":[10,32.0,0]}],["Conway","Arkansas",66000,40,26.2,0,{"SER":[10,24.0,0],"LMR":[10,23.0,0],"SBR":[10,38.0,0],"MOTO":[10,39.0,0]}],["Hot Springs","Arkansas",37000,40,28.2,0,{"SER":[10,31.0,0],"LMR":[10,23.0,0],"SBR":[10,37.0,0],"MOTO":[10,31.0,0]}],["Bella Vista","Arkansas",28000,40,28.0,0,{"SER":[10,36.0,0],"LMR":[10,22.0,0],"SBR":[10,40.0,0],"GEN":[10,10.0,0]}],["Searcy","Arkansas",24000,40,22.2,0,{"SER":[10,30.0,0],"LMR":[10,24.0,0],"SBR":[10,37.0,0],"MOTO":[10,7.0,0]}],["Van Buren","Arkansas",23000,40,27.0,0,{"SER":[10,31.0,0],"LMR":[10,28.0,0],"SBR":[10,31.0,0],"GEN":[10,14.0,0]}],["Irvine","California",310000,40,23.2,0,{"SER":[10,31.0,0],"LMR":[10,20.0,0],"GEN":[10,11.0,0],"MOTO":[10,17.0,0]}],["Chula Vista","California",285000,40,22.8,0,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"GEN":[10,6.0,0],"MOTO":[10,19.0,0]}],["Oxnard","California",210000,40,27.2,0,{"SER":[10,31.0,0],"LMR":[10,27.0,0],"GEN":[10,14.0,0],"MOTO":[10,27.0,0]}],["Moreno Valley","California",210000,40,26.0,0,{"SER":[10,31.0,0],"LMR":[10,28.0,0],"GEN":[10,9.0,0],"MOTO":[10,31.0,0]}],["Huntington Beach","California",200000,40,22.2,0,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"GEN":[10,9.0,0],"MOTO":[10,18.0,0]}],["Glendale","California",200000,40,27.0,0,{"SER":[10,37.0,0],"LMR":[10,31.0,0],"GEN":[10,6.0,0],"MOTO":[10,27.0,0]}],["Santa Clarita","California",180000,40,23.6,0,{"SER":[10,31.0,0],"LMR":[10,28.0,0],"GEN":[10,13.0,0],"MOTO":[10,15.0,0]}],["Garden Grove","California",175000,40,20.2,0,{"SER":[10,31.0,0],"LMR":[10,7.0,0],"GEN":[10,13.0,0],"MOTO":[10,19.0,0]}],["Santa Rosa","California",175000,40,27.4,0,{"SER":[10,31.0,0],"LMR":[10,18.0,0],"GEN":[10,27.0,0],"MOTO":[10,27.0,0]}],["Oceanside","California",175000,40,28.0,0,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"GEN":[10,29.0,0],"MOTO":[10,23.0,0]}],["Ontario","California",170000,40,23.0,0,{"SER":[10,31.0,0],"LMR":[10,28.0,0],"GEN":[10,11.0,0],"MOTO":[10,14.0,0]}],["Elk Grove","California",170000,40,28.0,0,{"SER":[10,40.0,0],"LMR":[10,24.0,0],"GEN":[10,15.0,0],"MOTO":[10,27.0,0]}],["Corona","California",165000,40,22.2,0,{"SER":[10,31.0,0],"LMR":[10,25.0,0],"GEN":[10,10.0,0],"MOTO":[10,11.0,0]}],["Lancaster","California",160000,40,25.2,0,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"GEN":[10,10.0,0],"MOTO":[10,32.0,0]}],["Palmdale","California",160000,40,25.2,0,{"SER":[10,31.0,0],"LMR":[10,28.0,0],"GEN":[10,19.0,0],"MOTO":[10,17.0,0]}],["Pomona","California",150000,40,26.8,0,{"SER":[10,31.0,0],"LMR":[10,28.0,0],"GEN":[10,18.0,0],"MOTO":[10,22.0,0]}],["Hialeah","Florida",220000,40,23.8,0,{"SER":[10,31.0,0],"LMR":[10,28.0,0],"GEN":[10,7.0,0],"MOTO":[10,19.0,0]}],["Pembroke Pines","Florida",175000,40,26.8,1.57,{"SER":[10,42.0,0],"LMR":[10,28.0,1.57],"GEN":[10,9.0,0],"MOTO":[10,21.0,0]}],["Coral Springs","Florida",134000,40,17.8,0,{"SER":[10,16.0,0],"LMR":[10,23.0,0],"SBR":[10,23.0,0],"MOTO":[10,18.0,0]}],["Melbourne","Florida",87000,40,26.2,6.42,{"SER":[10,37.0,0],"SBR":[10,37.0,0],"GEN":[10,29.0,6.42],"MOTO":[10,4.0,0]}],["Boynton Beach","Florida",82000,40,22.0,22.13,{"SER":[10,24.0,0],"LMR":[10,8.0,0],"GEN":[10,9.0,22.13],"MOTO":[10,38.0,0]}],["Sanford","Florida",61000,40,25.6,0,{"SER":[10,31.0,0],"LMR":[10,31.0,0],"SBR":[10,24.0,0],"GEN":[10,11.0,0]}],["Augusta","Georgia",206000,40,23.0,0,{"SER":[10,31.0,0],"LMR":[20,24.0,0],"GEN":[10,14.0,0]}],["Roswell","Georgia",95000,40,17.8,0,{"SER":[10,25.0,0],"LMR":[10,14.0,0],"SBR":[10,31.0,0],"MOTO":[10,7.0,0]}],["Albany","Georgia",68000,40,29.2,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"SBR":[10,29.0,0],"MOTO":[10,36.0,0]}],["Smyrna","Georgia",56000,40,20.4,0,{"SER":[10,28.0,0],"LMR":[10,22.0,0],"SBR":[10,27.0,0],"MOTO":[10,14.0,0]}],["Hinesville","Georgia",34000,40,26.6,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"SBR":[10,31.0,0],"GEN":[10,22.0,0]}],["Kennesaw","Georgia",30000,40,22.2,0,{"SER":[10,28.0,0],"SBR":[10,22.0,0],"GEN":[10,13.0,0],"MOTO":[10,19.0,0]}],["Stockbridge","Georgia",29000,40,22.4,1.4,{"SER":[10,31.0,0],"LMR":[10,20.0,1.4],"SBR":[10,31.0,0],"GEN":[10,10.0,0]}],["McDonough","Georgia",28000,40,26.8,1.41,{"SER":[10,31.0,0],"LMR":[10,24.0,1.41],"SBR":[10,31.0,0],"GEN":[10,12.0,0]}],["Canton","Georgia",26000,40,22.2,0,{"SER":[10,31.0,0],"LMR":[20,23.0,0],"SBR":[10,37.0,0]}],["Bridgeport","Connecticut",150000,40,16.8,0,{"SER":[10,28.0,0],"LMR":[10,5.0,0],"GEN":[10,4.0,0],"MOTO":[10,20.0,0]}],["Hamden","Connecticut",61000,40,21.2,7.7,{"SER":[10,31.0,0],"LMR":[10,22.0,0],"SBR":[10,3.0,0],"GEN":[10,4.0,7.7]}],["Fort Collins","Colorado",175000,40,16.0,0,{"SER":[20,28.0,0],"LMR":[10,24.0,0],"MOTO":[10,15.0,0]}],["Centennial","Colorado",110000,40,29.0,0,{"SER":[10,44.0,0],"LMR":[10,35.0,0],"SBR":[10,27.0,0],"MOTO":[10,27.0,0]}],["Castle Rock","Colorado",75000,40,17.6,0,{"SER":[10,24.0,0],"LMR":[10,31.0,0],"SBR":[10,2.0,0],"MOTO":[10,22.0,0]}],["Hilo","Hawaii",44000,40,30.8,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"SBR":[10,39.0,0],"GEN":[10,29.0,0]}],["Caldwell","Idaho",63000,40,22.8,0,{"SER":[10,26.0,0],"LMR":[10,23.0,0],"SBR":[10,31.0,0],"MOTO":[10,26.0,0]}],["Shelley","Idaho",10000,40,30.2,0,{"SER":[10,31.0,0],"SBR":[10,35.0,0],"GEN":[10,32.0,0],"MOTO":[10,25.0,0]}],["Westfield","Indiana",48000,40,16.0,0,{"SER":[20,31.0,0],"LMR":[10,24.0,0],"SBR":[10,3.0,0]}],["Evansville","Indiana",117000,40,18.8,0,{"SER":[10,28.0,0],"LMR":[20,23.0,0],"SBR":[10,29.0,0]}],["Bloomington","Indiana",80000,40,20.2,0,{"SER":[10,31.0,0],"LMR":[10,24.0,0],"GEN":[10,12.0,0],"MOTO":[10,18.0,0]}],["Bloomington","Illinois",79000,40,22.4,0,{"SER":[20,28.0,0],"LMR":[10,23.0,0],"SBR":[10,23.0,0]}],["Joliet","Illinois",150000,40,21.6,0,{"SER":[10,31.0,0],"LMR":[10,28.0,0],"SBR":[10,2.0,0],"MOTO":[10,18.0,0]}],["Peoria","Illinois",110000,40,25.4,0,{"SER":[10,31.0,0],"LMR":[20,24.0,0],"GEN":[10,9.0,0]}],["Hoffman Estates","Illinois",50000,40,22.0,0,{"SER":[10,23.0,0],"LMR":[10,22.0,0],"SBR":[10,13.0,0],"GEN":[10,11.0,0]}]];
    var MI_RPV = 558.32;
    var MI_TICKET = 320.73;
    var callsByTab2 = bm.monthlyCallsByCity || {};
    var locTabs = Object.keys(callsByTab2);

    // Match CRM tabs to SEO cities
    var miMatches = {};
    locTabs.forEach(function(tab) {
      var tl = tab.toLowerCase().replace(/[^a-z ]/g, '');
      MI_DATA.forEach(function(mi) {
        var cl = mi[0].toLowerCase();
        if (tl.indexOf(cl) !== -1 || (cl.length > 4 && tl.indexOf(cl.substring(0,5)) !== -1)) {
          if (!miMatches[tab] || mi[3] > miMatches[tab][3]) miMatches[tab] = mi;
        }
      });
    });

    // Build per-location performance
    var mktPerf = [];
    var companyOrders = 0, companyRev = 0;
    locTabs.forEach(function(tab) {
      var td = callsByTab2[tab] || {};
      var tMonths = Object.keys(td).sort();
      var totalCalls = 0;
      tMonths.forEach(function(m) { totalCalls += td[m] || 0; });
      var moActive = Math.max(tMonths.length, 1);
      var avgMo = Math.round(totalCalls / moActive * 10) / 10;
      var lastMo = tMonths.length > 0 ? (td[tMonths[tMonths.length - 1]] || 0) : 0;
      var prevMo = tMonths.length > 1 ? (td[tMonths[tMonths.length - 2]] || 0) : 0;
      var growth = prevMo > 0 ? Math.round(((lastMo - prevMo) / prevMo) * 100) : 0;
      var estRev = Math.round(totalCalls * MI_TICKET);
      companyOrders += totalCalls;
      companyRev += estRev;

      var mi = miMatches[tab];
      var sVol = mi ? mi[3] : 0;
      var kd = mi ? mi[4] : 0;
      var cpc = mi ? mi[5] : 0;
      var pop = mi ? mi[2] : 0;
      var kwBreak = mi ? mi[6] : {};
      var potential = Math.round(sVol * MI_RPV);
      var share = 0;
      if (sVol > 0 && moActive > 0) {
        var annualizedCalls = totalCalls / (moActive / 12);
        var tamCalls = sVol * 12 * 2.5;
        share = Math.round(Math.min((annualizedCalls / tamCalls) * 100, 100) * 10) / 10;
      }
      var capture = potential > 0 ? Math.round(Math.min((estRev / potential) * 100, 100) * 10) / 10 : 0;

      // Revenue per call (actual performance)
      var revPerCall = totalCalls > 0 ? Math.round(estRev / totalCalls) : 0;

      // Cost efficiency: CPC vs Revenue per click
      var cpcROI = cpc > 0 ? Math.round((MI_TICKET / cpc) * 10) / 10 : 0;

      mktPerf.push({
        name: tab, calls: totalCalls, avg: avgMo, last: lastMo, prev: prevMo,
        growth: growth, rev: estRev, months: moActive,
        vol: sVol, kd: kd, cpc: cpc, pop: pop, kwBreak: kwBreak,
        share: share, potential: potential, capture: capture,
        matched: mi ? (mi[0] + ', ' + mi[1]) : '',
        revPerCall: revPerCall, cpcROI: cpcROI
      });
    });
    mktPerf.sort(function(a, b) { return b.rev - a.rev; });

    // ====== MARKET SHARE DASHBOARD ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ffd700;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ffd700;border-radius:50%;box-shadow:0 0 8px #ffd700;display:inline-block;"></span>Market Share & CPC Intelligence</div>';

    // KPI Row
    var matchedLocs = mktPerf.filter(function(l) { return l.vol > 0; });
    var avgShare = matchedLocs.length > 0 ? Math.round(matchedLocs.reduce(function(a,b){return a+b.share;},0)/matchedLocs.length*10)/10 : 0;
    var totalPot = mktPerf.reduce(function(a,b){return a+b.potential;},0);
    var capRate = totalPot > 0 ? Math.round((companyRev/totalPot)*1000)/10 : 0;
    var avgCPC = 0;
    var cpcLocs = mktPerf.filter(function(l){return l.cpc > 0;});
    if (cpcLocs.length > 0) avgCPC = Math.round(cpcLocs.reduce(function(a,b){return a+b.cpc;},0)/cpcLocs.length*100)/100;
    var avgKD = matchedLocs.length > 0 ? Math.round(matchedLocs.reduce(function(a,b){return a+b.kd;},0)/matchedLocs.length*10)/10 : 0;

    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px;margin-bottom:20px;">';

    html += '<div style="background:rgba(10,20,35,0.8);border:1px solid #ffd70015;padding:14px;"><div style="color:#4a6a8a;font-size:0.6em;font-family:Orbitron;letter-spacing:2px;">AVG MARKET SHARE</div><div style="color:#ffd700;font-size:1.6em;font-weight:900;">' + avgShare + '%</div><div style="color:#4a6a8a;font-size:0.7em;">' + matchedLocs.length + ' matched markets</div></div>';

    html += '<div style="background:rgba(10,20,35,0.8);border:1px solid #00ff6615;padding:14px;"><div style="color:#4a6a8a;font-size:0.6em;font-family:Orbitron;letter-spacing:2px;">EST. ALL-TIME REV</div><div style="color:#00ff66;font-size:1.6em;font-weight:900;">$' + companyRev.toLocaleString() + '</div><div style="color:#4a6a8a;font-size:0.7em;">' + companyOrders + ' orders @ $' + MI_TICKET + '</div></div>';

    html += '<div style="background:rgba(10,20,35,0.8);border:1px solid #ff9f4315;padding:14px;"><div style="color:#4a6a8a;font-size:0.6em;font-family:Orbitron;letter-spacing:2px;">REVENUE POTENTIAL</div><div style="color:#ff9f43;font-size:1.6em;font-weight:900;">$' + (totalPot > 999999 ? (totalPot/1000000).toFixed(1)+'M' : totalPot.toLocaleString()) + '/yr</div><div style="color:#4a6a8a;font-size:0.7em;">Your markets at full capture</div></div>';

    html += '<div style="background:rgba(10,20,35,0.8);border:1px solid #a855f715;padding:14px;"><div style="color:#4a6a8a;font-size:0.6em;font-family:Orbitron;letter-spacing:2px;">CAPTURE RATE</div><div style="color:' + (capRate > 10 ? '#00ff66' : capRate > 5 ? '#ffd700' : '#ff4757') + ';font-size:1.6em;font-weight:900;">' + capRate + '%</div><div style="color:#4a6a8a;font-size:0.7em;">Revenue vs potential</div></div>';

    html += '<div style="background:rgba(10,20,35,0.8);border:1px solid #00d4ff15;padding:14px;"><div style="color:#4a6a8a;font-size:0.6em;font-family:Orbitron;letter-spacing:2px;">AVG CPC</div><div style="color:#00d4ff;font-size:1.6em;font-weight:900;">$' + avgCPC.toFixed(2) + '</div><div style="color:#4a6a8a;font-size:0.7em;">' + cpcLocs.length + ' markets w/ data</div></div>';

    html += '<div style="background:rgba(10,20,35,0.8);border:1px solid #00ff6615;padding:14px;"><div style="color:#4a6a8a;font-size:0.6em;font-family:Orbitron;letter-spacing:2px;">AVG KEYWORD DIFF</div><div style="color:' + (avgKD < 25 ? '#00ff66' : avgKD < 35 ? '#ffd700' : '#ff4757') + ';font-size:1.6em;font-weight:900;">' + avgKD + '</div><div style="color:#4a6a8a;font-size:0.7em;">' + (avgKD < 25 ? 'Easy to rank' : avgKD < 35 ? 'Moderate' : 'Competitive') + '</div></div>';

    html += '</div>';

    // ====== LOCATION TABLE (filterable) ======
    // Embed data as JSON for client-side filtering
    var mktJSON = mktPerf.map(function(loc) {
      var state = '';
      if (loc.name.includes(',')) state = loc.name.split(',').pop().trim();
      else if (loc.matched && loc.matched.includes(',')) state = loc.matched.split(',').pop().trim();
      var act2 = '';
      if (loc.share < 3 && loc.vol > 50) act2 = 'SCALE ADS';
      else if (loc.share < 5 && loc.vol > 30) act2 = 'GROW SEO';
      else if (loc.share > 10) act2 = 'OPTIMIZE';
      else if (loc.vol === 0) act2 = 'UNMATCHED';
      else act2 = 'MAINTAIN';
      return { n: loc.name, c: loc.calls, a: loc.avg, g: loc.growth, r: loc.rev, s: loc.share, v: loc.vol, kd: loc.kd, cpc: loc.cpc, roi: loc.cpcROI, p: loc.potential, cap: loc.capture, m: loc.matched, st: state, act: act2 };
    });

    // Extract unique states
    var stateSet = {};
    mktJSON.forEach(function(l) { if (l.st && l.st.length === 2) stateSet[l.st] = true; });
    var stateList = Object.keys(stateSet).sort();

    html += '<div style="background:rgba(10,20,35,0.9);border:1px solid #1a2a3a;margin-bottom:20px;padding:12px;">';

    // Filter bar
    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center;">';
    html += '<input id="mkt-search" type="text" placeholder="Search city..." oninput="filterMkt()" style="font-family:Orbitron;font-size:0.5em;letter-spacing:1px;padding:7px 12px;background:#0a1520;color:#c0d8f0;border:1px solid #1a2a3a;outline:none;width:160px;">';
    html += '<select id="mkt-state" onchange="filterMkt()" style="font-family:Orbitron;font-size:0.5em;letter-spacing:1px;padding:7px 10px;background:#0a1520;color:#ffd700;border:1px solid #ffd70030;cursor:pointer;outline:none;">';
    html += '<option value="">ALL STATES</option>';
    stateList.forEach(function(s) { html += '<option value="' + s + '">' + s + '</option>'; });
    html += '</select>';
    html += '<select id="mkt-action" onchange="filterMkt()" style="font-family:Orbitron;font-size:0.5em;letter-spacing:1px;padding:7px 10px;background:#0a1520;color:#ff9f43;border:1px solid #ff9f4330;cursor:pointer;outline:none;">';
    html += '<option value="">ALL ACTIONS</option><option value="SCALE ADS">âš¡ SCALE ADS</option><option value="GROW SEO">ðŸ“ˆ GROW SEO</option><option value="OPTIMIZE">âœ… OPTIMIZE</option><option value="UNMATCHED">â“ UNMATCHED</option><option value="MAINTAIN">ðŸ”„ MAINTAIN</option>';
    html += '</select>';
    html += '<select id="mkt-sort" onchange="filterMkt()" style="font-family:Orbitron;font-size:0.5em;letter-spacing:1px;padding:7px 10px;background:#0a1520;color:#00d4ff;border:1px solid #00d4ff30;cursor:pointer;outline:none;">';
    html += '<option value="rev">SORT: REVENUE</option><option value="calls">CALLS</option><option value="growth">GROWTH</option><option value="share">MARKET SHARE</option><option value="vol">SEO VOLUME</option><option value="potential">POTENTIAL</option><option value="kd">KEYWORD DIFF</option><option value="cpc">CPC</option>';
    html += '</select>';
    html += '<select id="mkt-min" onchange="filterMkt()" style="font-family:Orbitron;font-size:0.5em;letter-spacing:1px;padding:7px 10px;background:#0a1520;color:#a855f7;border:1px solid #a855f730;cursor:pointer;outline:none;">';
    html += '<option value="0">MIN: ALL</option><option value="5" selected>5+ CALLS</option><option value="10">10+ CALLS</option><option value="25">25+ CALLS</option><option value="50">50+ CALLS</option><option value="100">100+ CALLS</option>';
    html += '</select>';
    html += '<select id="mkt-show" onchange="filterMkt()" style="font-family:Orbitron;font-size:0.5em;letter-spacing:1px;padding:7px 10px;background:#0a1520;color:#00ff66;border:1px solid #00ff6630;cursor:pointer;outline:none;">';
    html += '<option value="25" selected>SHOW 25</option><option value="50">SHOW 50</option><option value="100">SHOW 100</option><option value="9999">SHOW ALL</option>';
    html += '</select>';
    html += '<span id="mkt-count" style="color:#4a6a8a;font-size:0.75em;margin-left:auto;"></span>';
    html += '</div>';

    // Table container
    html += '<div style="overflow-x:auto;"><table id="mkt-table" style="width:100%;border-collapse:collapse;font-size:0.78em;">';
    html += '<thead><tr style="border-bottom:2px solid #ffd70020;">';
    ['Location','Calls','Mo Avg','Growth','Est Rev','Share','Vol/Mo','KD','CPC','CPC ROI','Potential','Capture','Action'].forEach(function(h){
      html += '<th style="padding:10px 7px;text-align:left;color:#ffd700;font-family:Orbitron;font-size:0.6em;letter-spacing:1px;white-space:nowrap;">' + h + '</th>';
    });
    html += '</tr></thead><tbody id="mkt-body"></tbody>';
    html += '</table></div></div>';

    // Client-side filter/sort logic
    html += '<script>';
    html += 'var mktData=' + JSON.stringify(mktJSON) + ';';
    html += 'function filterMkt(){';
    html += '  var q=(document.getElementById("mkt-search").value||"").toLowerCase();';
    html += '  var st=document.getElementById("mkt-state").value;';
    html += '  var act=document.getElementById("mkt-action").value;';
    html += '  var sort=document.getElementById("mkt-sort").value;';
    html += '  var min=parseInt(document.getElementById("mkt-min").value)||0;';
    html += '  var show=parseInt(document.getElementById("mkt-show").value)||25;';
    html += '  var filtered=mktData.filter(function(l){';
    html += '    if(q&&l.n.toLowerCase().indexOf(q)===-1&&(!l.m||l.m.toLowerCase().indexOf(q)===-1))return false;';
    html += '    if(st&&l.st!==st)return false;';
    html += '    if(act&&l.act!==act)return false;';
    html += '    if(l.c<min)return false;';
    html += '    return true;';
    html += '  });';
    html += '  var sk={rev:"r",calls:"c",growth:"g",share:"s",vol:"v",potential:"p",kd:"kd",cpc:"cpc"};';
    html += '  var sf=sk[sort]||"r";';
    html += '  filtered.sort(function(a,b){return(b[sf]||0)-(a[sf]||0);});';
    html += '  document.getElementById("mkt-count").textContent="Showing "+Math.min(show,filtered.length)+" of "+filtered.length+" markets";';
    html += '  var tb=document.getElementById("mkt-body");tb.innerHTML="";';
    html += '  filtered.slice(0,show).forEach(function(l,i){';
    html += '    var bg=i%2===0?"rgba(10,20,35,0.4)":"transparent";';
    html += '    var sc=l.s>10?"#00ff66":l.s>5?"#ffd700":l.s>0?"#ff9f43":"#ff4757";';
    html += '    var gc=l.g>0?"#00ff66":l.g<0?"#ff4757":"#4a6a8a";';
    html += '    var kc=l.kd>0?(l.kd<20?"#00ff66":l.kd<30?"#ffd700":"#ff9f43"):"#4a6a8a";';
    html += '    var ai={\"SCALE ADS\":\"\\u26a1 SCALE ADS\",\"GROW SEO\":\"\\ud83d\\udcc8 GROW SEO\",\"OPTIMIZE\":\"\\u2705 OPTIMIZE\",\"UNMATCHED\":\"\\u2753 UNMATCHED\",\"MAINTAIN\":\"\\ud83d\\udd04 MAINTAIN\"};';
    html += '    var tr=document.createElement("tr");tr.style.cssText="background:"+bg+";border-bottom:1px solid #1a2a3a10;";';
    html += '    var h="<td style=\\"padding:8px 7px;\\"><div style=\\"color:#c0d8f0;font-weight:600;white-space:nowrap;\\">"+l.n+"</div>";';
    html += '    if(l.m)h+="<div style=\\"color:#4a6a8a;font-size:0.8em;\\">"+l.m+"</div>";';
    html += '    h+="</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;color:#00d4ff;font-weight:700;\\">"+l.c+"</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;color:#c0d8f0;\\">"+l.a+"</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;color:"+gc+";font-weight:700;\\">"+(l.g>=0?"+":"")+l.g+"%</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;color:#00ff66;font-weight:700;\\">$"+l.r.toLocaleString()+"</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;\\"><div style=\\"display:flex;align-items:center;gap:5px;\\"><div style=\\"width:40px;height:5px;background:#1a2a3a;border-radius:3px;\\"><div style=\\"width:"+Math.min(l.s,100)+"%;height:100%;background:"+sc+";border-radius:3px;\\"></div></div><span style=\\"color:"+sc+";font-weight:700;font-size:0.9em;\\">"+l.s+"%</span></div></td>";';
    html += '    h+="<td style=\\"padding:8px 7px;color:"+(l.v>0?"#a855f7":"#4a6a8a")+"\\">"+(l.v>0?l.v:"\\u2014")+"</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;color:"+kc+"\\">"+(l.kd>0?l.kd:"\\u2014")+"</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;color:"+(l.cpc>0?"#00d4ff":"#4a6a8a")+";font-weight:700;\\">"+(l.cpc>0?"$"+l.cpc.toFixed(2):"\\u2014")+"</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;color:"+(l.roi>50?"#00ff66":l.roi>20?"#ffd700":l.roi>0?"#ff9f43":"#4a6a8a")+"\\">"+(l.roi>0?l.roi+"x":"\\u2014")+"</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;color:#ff9f43;\\">$"+(l.p>999?Math.round(l.p/1000)+"K":l.p)+"</td>";';
    html += '    h+="<td style=\\"padding:8px 7px;\\"><div style=\\"display:flex;align-items:center;gap:5px;\\"><div style=\\"width:35px;height:5px;background:#1a2a3a;border-radius:3px;\\"><div style=\\"width:"+Math.min(l.cap,100)+"%;height:100%;background:#a855f7;border-radius:3px;\\"></div></div><span style=\\"color:#a855f7;font-size:0.9em;\\">"+l.cap+"%</span></div></td>";';
    html += '    h+="<td style=\\"padding:8px 7px;font-size:0.85em;white-space:nowrap;\\">"+(ai[l.act]||l.act)+"</td>";';
    html += '    tr.innerHTML=h;tb.appendChild(tr);';
    html += '  });';
    html += '}';
    html += 'filterMkt();';
    html += '<\/script>';

    // ====== KEYWORD MIX BY LOCATION ======
    html += '<div style="margin-bottom:20px;">';
    html += '<div onclick="var el=document.getElementById(\'kw-mix\');el.style.display=el.style.display===\'none\'?\'block\':\'none\';this.querySelector(\'.ar\').textContent=el.style.display===\'none\'?\'\u25b6\':\'\u25bc\';" style="cursor:pointer;display:flex;align-items:center;gap:10px;padding:8px 0;">';
    html += '<span class="ar" style="font-family:Orbitron;font-size:0.8em;color:#a855f7;">\u25b6</span>';
    html += '<span style="font-family:Orbitron;font-size:0.65em;letter-spacing:3px;color:#a855f7;">KEYWORD MIX BY LOCATION</span></div>';
    html += '<div id="kw-mix" style="display:none;">';

    var kwColors2 = {SER:'#ff4757',LMR:'#00ff66',SBR:'#00d4ff',GEN:'#ffd700',MOTO:'#a855f7'};
    var kwLabels2 = {SER:'Sm Engine',LMR:'Lawn Mow',SBR:'Snow Blow',GEN:'Generator',MOTO:'Motorcycle'};

    // Legend
    html += '<div style="display:flex;gap:15px;margin-bottom:12px;flex-wrap:wrap;">';
    Object.keys(kwColors2).forEach(function(k) {
      html += '<div style="display:flex;align-items:center;gap:5px;"><div style="width:10px;height:10px;background:' + kwColors2[k] + ';border-radius:2px;"></div><span style="color:#4a6a8a;font-size:0.75em;">' + kwLabels2[k] + '</span></div>';
    });
    html += '</div>';

    mktPerf.filter(function(l){return Object.keys(l.kwBreak).length > 0;}).forEach(function(loc) {
      var kwKeys = Object.keys(loc.kwBreak);
      html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">';
      html += '<div style="width:140px;font-size:0.75em;color:#c0d8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + loc.name + '</div>';
      html += '<div style="flex:1;display:flex;height:14px;gap:1px;border-radius:3px;overflow:hidden;">';
      kwKeys.forEach(function(kn) {
        var v = loc.kwBreak[kn][0];
        var pct = loc.vol > 0 ? Math.max(2, Math.round((v/loc.vol)*100)) : 0;
        html += '<div style="flex:' + pct + ';background:' + (kwColors2[kn] || '#4a6a8a') + ';position:relative;" title="' + (kwLabels2[kn]||kn) + ': ' + v + '/mo (KD:' + loc.kwBreak[kn][1] + ', CPC:$' + loc.kwBreak[kn][2] + ')"></div>';
      });
      html += '</div>';
      html += '<div style="width:50px;text-align:right;font-size:0.7em;color:#4a6a8a;">' + loc.vol + '/mo</div>';
      html += '</div>';
    });
    html += '</div></div>';
    html += '</div>'; // end market share section

    // ====== NEXT MARKETS TO ATTACK ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#ff4757;text-transform:uppercase;margin-bottom:5px;display:flex;align-items:center;gap:10px;"><span style="width:8px;height:8px;background:#ff4757;border-radius:50%;box-shadow:0 0 8px #ff4757;display:inline-block;"></span>Next Markets to Attack</div>';
    html += '<div style="color:#4a6a8a;font-size:0.8em;margin-bottom:15px;">Ranked by Attack Score = Volume \u00d7 (100-KD)/100 \u00d7 Season. Higher = easier money.</div>';

    // Filter out existing cities
    var existCities = {};
    locTabs.forEach(function(t) { var mi = miMatches[t]; if (mi) existCities[mi[0].toLowerCase()+'|'+mi[1].toLowerCase()] = true; });

    var attackList = [];
    MI_DATA.forEach(function(mi) {
      var key = mi[0].toLowerCase()+'|'+mi[1].toLowerCase();
      if (existCities[key]) return;
      var vol = mi[3], kd = mi[4], cpc = mi[5];
      var has4Season = mi[6] && mi[6].SBR ? 1.15 : 1.0;
      var score = Math.round(vol * ((100-kd)/100) * has4Season);
      attackList.push({ city: mi[0], state: mi[1], pop: mi[2], vol: vol, kd: kd, cpc: cpc, score: score, rev: Math.round(vol*MI_RPV), orders: Math.round(vol*MI_RPV/MI_TICKET), season: has4Season > 1 ? '4-Season' : 'Mow', kw: mi[6] || {} });
    });
    attackList.sort(function(a,b){return b.score-a.score;});

    // Attack cards - top 20
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:10px;">';
    attackList.slice(0, 20).forEach(function(m, idx) {
      var tier = idx < 5 ? '#ff4757' : idx < 10 ? '#ffd700' : idx < 15 ? '#00d4ff' : '#4a6a8a';
      var kdC = m.kd < 20 ? '#00ff66' : m.kd < 30 ? '#ffd700' : '#ff9f43';
      html += '<div style="background:rgba(10,20,35,0.8);border:1px solid ' + tier + '20;padding:12px;">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
      html += '<div><span style="font-family:Orbitron;font-size:0.65em;color:' + tier + ';margin-right:6px;">#' + (idx+1) + '</span>';
      html += '<span style="color:#c0d8f0;font-weight:700;">' + m.city + '</span>';
      html += '<span style="color:#4a6a8a;font-size:0.85em;">, ' + m.state + '</span></div>';
      html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:' + tier + ';">SCORE: ' + m.score + '</div></div>';

      html += '<div style="display:flex;gap:6px;flex-wrap:wrap;">';
      html += '<div style="flex:1;background:rgba(5,10,20,0.5);padding:5px 7px;text-align:center;min-width:50px;"><div style="color:#4a6a8a;font-size:0.5em;">VOL/MO</div><div style="color:#a855f7;font-weight:700;font-size:0.95em;">' + m.vol + '</div></div>';
      html += '<div style="flex:1;background:rgba(5,10,20,0.5);padding:5px 7px;text-align:center;min-width:50px;"><div style="color:#4a6a8a;font-size:0.5em;">KD</div><div style="color:' + kdC + ';font-weight:700;font-size:0.95em;">' + m.kd + '</div></div>';
      html += '<div style="flex:1;background:rgba(5,10,20,0.5);padding:5px 7px;text-align:center;min-width:50px;"><div style="color:#4a6a8a;font-size:0.5em;">CPC</div><div style="color:#00d4ff;font-weight:700;font-size:0.95em;">' + (m.cpc > 0 ? '$'+m.cpc.toFixed(2) : '\u2014') + '</div></div>';
      html += '<div style="flex:1;background:rgba(5,10,20,0.5);padding:5px 7px;text-align:center;min-width:50px;"><div style="color:#4a6a8a;font-size:0.5em;">REV/YR</div><div style="color:#00ff66;font-weight:700;font-size:0.95em;">$' + (m.rev>999?Math.round(m.rev/1000)+'K':m.rev) + '</div></div>';
      html += '<div style="flex:1;background:rgba(5,10,20,0.5);padding:5px 7px;text-align:center;min-width:50px;"><div style="color:#4a6a8a;font-size:0.5em;">ORDERS</div><div style="color:#ff9f43;font-weight:700;font-size:0.95em;">' + m.orders + '/yr</div></div>';
      html += '<div style="flex:1;background:rgba(5,10,20,0.5);padding:5px 7px;text-align:center;min-width:50px;"><div style="color:#4a6a8a;font-size:0.5em;">POP</div><div style="color:#c0d8f0;font-weight:700;font-size:0.95em;">' + (m.pop > 999999 ? (m.pop/1000000).toFixed(1)+'M' : m.pop > 999 ? Math.round(m.pop/1000)+'K' : m.pop) + '</div></div>';
      html += '</div>';

      // Keyword breakdown bar
      var kwKeys = Object.keys(m.kw);
      if (kwKeys.length > 0) {
        html += '<div style="display:flex;gap:1px;margin-top:6px;height:3px;border-radius:2px;overflow:hidden;">';
        var kwC = {SER:'#ff4757',LMR:'#00ff66',SBR:'#00d4ff',GEN:'#ffd700',MOTO:'#a855f7'};
        kwKeys.forEach(function(kn) {
          var kv = m.kw[kn][0];
          var pct = m.vol > 0 ? Math.max(1,Math.round((kv/m.vol)*100)) : 0;
          html += '<div style="flex:' + pct + ';background:' + (kwC[kn]||'#4a6a8a') + ';" title="' + kn + ': ' + kv + '"></div>';
        });
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div>';

    // National opportunity banner
    var natVol = 0;
    MI_DATA.forEach(function(mi) { natVol += mi[3]; });
    var natRev = Math.round(natVol * MI_RPV);
    html += '<div style="margin-top:15px;padding:14px;background:rgba(255,215,0,0.04);border:1px solid #ffd70025;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">';
    html += '<div><div style="font-family:Orbitron;font-size:0.55em;letter-spacing:3px;color:#ffd700;">NATIONAL MARKET OPPORTUNITY</div>';
    html += '<div style="color:#c0d8f0;font-size:0.8em;margin-top:3px;">' + MI_DATA.length + ' cities \u00b7 50 states \u00b7 ' + natVol.toLocaleString() + ' searches/month</div></div>';
    html += '<div style="text-align:right;"><div style="color:#00ff66;font-size:1.8em;font-weight:900;font-family:Orbitron;">$' + (natRev/1000000).toFixed(1) + 'M</div>';
    html += '<div style="color:#4a6a8a;font-size:0.7em;">Annual revenue at KC rate ($' + MI_RPV + '/vol)</div></div>';
    html += '</div>';

    // ====== EASY WINS (Low KD, High Volume) ======
    var easyWins = attackList.filter(function(m) { return m.kd < 20 && m.vol >= 30; }).slice(0, 10);
    if (easyWins.length > 0) {
      html += '<div style="margin-top:15px;padding:14px;background:rgba(0,255,102,0.03);border:1px solid #00ff6620;">';
      html += '<div style="font-family:Orbitron;font-size:0.6em;letter-spacing:3px;color:#00ff66;margin-bottom:10px;">\ud83c\udfaf EASY WINS \u2014 Low KD (<20) + High Volume (30+)</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
      easyWins.forEach(function(m) {
        html += '<div style="background:rgba(0,255,102,0.05);border:1px solid #00ff6615;padding:8px 12px;display:flex;align-items:center;gap:8px;">';
        html += '<div><div style="color:#c0d8f0;font-weight:600;font-size:0.9em;">' + m.city + ', ' + m.state + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.75em;">' + m.vol + '/mo \u00b7 KD:' + m.kd + ' \u00b7 $' + (m.rev > 999 ? Math.round(m.rev/1000)+'K' : m.rev) + '/yr</div></div>';
        html += '</div>';
      });
      html += '</div></div>';
    }
    html += '</div>'; // end attack section


    // ====== DATA SOURCES HEALTH ======
    html += '<div style="max-width:1400px;margin:0 auto;padding:0 40px 30px;">';
    html += '<div style="font-family:Orbitron;font-size:0.9em;letter-spacing:5px;color:#4a6a8a;text-transform:uppercase;margin-bottom:15px;">DATA SOURCES</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:8px;">';
    var metaEntries = Object.entries(sheetMeta);
    if (metaEntries.length > 0) {
      metaEntries.forEach(function(m) {
        html += '<div style="background:rgba(10,20,35,0.6);border:1px solid #00ff6610;padding:10px;display:flex;align-items:center;gap:10px;">';
        html += '<div style="width:6px;height:6px;background:#00ff66;border-radius:50%;box-shadow:0 0 6px #00ff66;"></div>';
        html += '<div><div style="color:#c0d8f0;font-size:0.9em;">' + m[0] + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.7em;">' + (m[1].tabs || []).length + ' tabs</div></div></div>';
      });
    } else {
      html += '<div style="color:#ff4757;padding:15px;">No source sheets loaded. Verify service account has access to all 12 spreadsheets.</div>';
    }
    html += '</div></div>';

    // Tab Modal (reuse from main dashboard)
    html += '<div id="tab-modal">';
    html += '<div style="max-width:1200px;margin:30px auto;padding:20px;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">';
    html += '<div id="modal-title" style="font-family:Orbitron;font-size:1.2em;letter-spacing:3px;color:#a855f7;"></div>';
    html += '<div onclick="closeModal()" style="font-family:Orbitron;font-size:0.8em;letter-spacing:2px;color:#ff4757;cursor:pointer;padding:10px 20px;border:1px solid #ff475730;">CLOSE</div>';
    html += '</div>';
    html += '<div id="modal-loading" style="text-align:center;padding:60px;font-family:Orbitron;font-size:0.8em;letter-spacing:5px;color:#4a6a8a;">LOADING...</div>';
    html += '<div id="modal-content" style="overflow-x:auto;"></div>';
    html += '</div></div>';

    // JavaScript
    html += '<script>';
    html += 'function loadTab(name){';
    html += '  document.getElementById("tab-modal").style.display="block";';
    html += '  document.getElementById("modal-title").textContent=name;';
    html += '  document.getElementById("modal-loading").style.display="block";';
    html += '  document.getElementById("modal-content").innerHTML="";';
    html += '  fetch("/tab/"+encodeURIComponent(name))';
    html += '    .then(function(r){return r.json()})';
    html += '    .then(function(data){';
    html += '      document.getElementById("modal-loading").style.display="none";';
    html += '      if(!data.headers||data.headers.length===0){document.getElementById("modal-content").innerHTML="<div style=\\"color:#4a6a8a;text-align:center;padding:40px;\\">NO DATA</div>";return;}';
    html += '      var headers=data.headers;var rows=(data.rows||[]).slice(0,50);';
    html += '      var t="<div style=\\"font-family:Orbitron;font-size:0.65em;color:#4a6a8a;letter-spacing:2px;margin-bottom:10px;\\">"+(data.rowCount||0)+" ROWS</div>";';
    html += '      t+="<table style=\\"width:100%;border-collapse:collapse;font-size:0.85em;\\">";';
    html += '      t+="<thead><tr>";';
    html += '      for(var h=0;h<headers.length;h++){t+="<th style=\\"padding:8px 10px;text-align:left;border-bottom:1px solid #a855f720;font-family:Orbitron;font-size:0.65em;letter-spacing:2px;color:#a855f7;white-space:nowrap;\\">"+headers[h]+"</th>";}';
    html += '      t+="</tr></thead><tbody>";';
    html += '      for(var r=0;r<rows.length;r++){';
    html += '        t+="<tr style=\\"border-bottom:1px solid #0a1520;\\">";';
    html += '        for(var c=0;c<headers.length;c++){var val=rows[r][c]||"";t+="<td style=\\"padding:6px 10px;color:#7a9ab0;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\\">"+val+"</td>";}';
    html += '        t+="</tr>";';
    html += '      }';
    html += '      t+="</tbody></table>";';
    html += '      document.getElementById("modal-content").innerHTML=t;';
    html += '    }).catch(function(e){document.getElementById("modal-content").innerHTML="ERROR: "+e.message;});';
    html += '}';
    html += 'function closeModal(){document.getElementById("tab-modal").style.display="none";}';
    html += 'document.addEventListener("keydown",function(e){if(e.key==="Escape")closeModal();});';

    // Live clock
    html += 'function updateClock(){var d=new Date();var h=String(d.getHours()).padStart(2,"0");var m=String(d.getMinutes()).padStart(2,"0");var s=String(d.getSeconds()).padStart(2,"0");document.getElementById("clock").textContent=h+":"+m+":"+s;}setInterval(updateClock,1000);updateClock();';
    html += '<\/script>';

    // Clock
    html += '<div class="clock" id="clock"></div>';

    // Footer
    html += '<div class="footer">JARVIS â€¢ ATHENA â€¢ TOOKAN // Wildwood Small Engine Repair // v4.4</div>';

    // Mobile padding fix
    html += '<script>';
    html += 'if(window.innerWidth<=768){document.querySelectorAll("[style]").forEach(function(el){';
    html += '  var s=el.getAttribute("style")||"";';
    html += '  if(s.indexOf("0 40px")>-1||s.indexOf("0px 40px")>-1){el.style.paddingLeft="12px";el.style.paddingRight="12px";}';
    html += '  if(s.indexOf("repeat(3,")>-1||s.indexOf("repeat(3, ")>-1){el.style.gridTemplateColumns="1fr";}';
    html += '  if(s.indexOf("repeat(4,")>-1||s.indexOf("repeat(4, ")>-1){el.style.gridTemplateColumns="repeat(2,1fr)";}';
    html += '});}';
    html += '<\/script>';

    html += '</div></body></html>';
    res.send(html);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


app.post('/chat', async function(req, res) {
  var sessionId = req.body.sessionId || 'default';
  var userMessage = req.body.message || '';
  var lowerMsg = userMessage.toLowerCase().trim();
  var from = 'whatsapp:+18167392734'; // for reminders/events that need the number

  try {
    // ====== VOICE COMMANDS ======

    // Win logging
    if (lowerMsg.startsWith('win') && (lowerMsg.includes(':') || lowerMsg.length > 5)) {
      var winText = userMessage.replace(/^win[:\s]*/i, '').trim();
      try {
        var today = new Date().toISOString().split('T')[0];
        var area = await askClaude(
          "Categorize this win into exactly one of: Work, Health, Social, Financial, Personal Growth, Dating. Respond with ONLY the category name.",
          [{ role: 'user', content: winText }]
        );
        await sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: "'Wins'!A:D",
          valueInputOption: 'USER_ENTERED',
          requestBody: { values: [[today, winText, area.trim(), 'Logged via voice']] },
        });
      } catch (e) {}
      return res.json({ response: "Win logged. Keep stacking, Trace." });
    }

    // Gym logging
    if (lowerMsg.startsWith('gym') && (lowerMsg.includes(':') || lowerMsg.length > 5)) {
      var gymText = userMessage.replace(/^gym[:\s]*/i, '').trim();
      try {
        var today = new Date().toISOString().split('T')[0];
        var day = new Date().toLocaleDateString('en-US', { weekday: 'long' });
        await sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: "'Gym_Log'!A:E",
          valueInputOption: 'USER_ENTERED',
          requestBody: { values: [[today, day, gymText, '', 'Via voice']] },
        });
        await sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: "'Wins'!A:D",
          valueInputOption: 'USER_ENTERED',
          requestBody: { values: [[today, 'Gym: ' + gymText, 'Health', 'Via voice']] },
        });
      } catch (e) {}
      return res.json({ response: "Gym logged. " + gymText + ". The discipline is building, Trace." });
    }

    // Calendar
    if (lowerMsg === 'calendar' || lowerMsg === 'schedule' || lowerMsg === 'events' || lowerMsg.includes('what do i have') || lowerMsg.includes("what's today") || lowerMsg.includes('whats today') || lowerMsg.includes('my schedule')) {
      try {
        var accounts = Object.keys(gmailTokens);
        var allEvents = [];
        for (var ca = 0; ca < accounts.length; ca++) {
          var events = await getCalendarEvents(accounts[ca], 1);
          allEvents = allEvents.concat(events);
        }
        if (allEvents.length === 0) {
          return res.json({ response: "Nothing on your calendar today. It's an open day. Use it wisely." });
        }
        var eventList = allEvents.map(function(e, i) { return e.time + ", " + e.summary + (e.location ? " at " + e.location : ""); }).join(". ");
        return res.json({ response: "Today you have: " + eventList });
      } catch (e) {
        return res.json({ response: "Couldn't access your calendar. You may need to reconnect." });
      }
    }

    // This week
    if (lowerMsg === 'week' || lowerMsg === 'this week' || lowerMsg.includes('weekly schedule')) {
      try {
        var accounts = Object.keys(gmailTokens);
        var allEvents = [];
        for (var ca = 0; ca < accounts.length; ca++) {
          var events = await getCalendarEvents(accounts[ca], 7);
          allEvents = allEvents.concat(events);
        }
        if (allEvents.length === 0) {
          return res.json({ response: "Nothing on your calendar this week." });
        }
        var eventList = allEvents.map(function(e) { return e.date + " " + e.time + ", " + e.summary; }).join(". ");
        return res.json({ response: "This week: " + eventList });
      } catch (e) {
        return res.json({ response: "Couldn't access your calendar." });
      }
    }

    // Reminders
    if (lowerMsg.startsWith('remind') || lowerMsg.startsWith('todo') || lowerMsg.startsWith('i need to') || lowerMsg.startsWith('i gotta') || lowerMsg.startsWith('need to')) {
      var reminderText = userMessage.replace(/^(remind[:\s]*|todo[:\s]*|i need to\s*|i gotta\s*|need to\s*)/i, '').trim();
      var reminderId = 'r' + Date.now();
      global.activeReminders = global.activeReminders || {};
      global.activeReminders[reminderId] = { text: reminderText, created: Date.now(), done: false, nudges: 0 };

      // Log to sheet
      try {
        await sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: "'Reminders'!A:F",
          valueInputOption: 'USER_ENTERED',
          requestBody: { values: [[new Date().toISOString().split('T')[0], new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), reminderText, 'PENDING', '', '']] },
        });
      } catch (e) {}

      // Set up nudges
      var fiveHours = 5 * 60 * 60 * 1000;
      var tenHours = 10 * 60 * 60 * 1000;
      setTimeout(async function() {
        if (global.activeReminders[reminderId] && !global.activeReminders[reminderId].done) {
          var hour = new Date().getHours();
          if (hour >= 7 && hour < 23) {
            try { await twilioClient.messages.create({ body: "Reminder: \"" + reminderText + "\" â€” still pending.", from: 'whatsapp:+14155238886', to: '+18167392734' }); } catch (e) {}
          }
        }
      }, fiveHours);
      setTimeout(async function() {
        if (global.activeReminders[reminderId] && !global.activeReminders[reminderId].done) {
          var hour = new Date().getHours();
          if (hour >= 7 && hour < 23) {
            try {
              await twilioClient.messages.create({ body: "\"" + reminderText + "\" still not done. Calling you.", from: 'whatsapp:+14155238886', to: '+18167392734' });
              setTimeout(async function() {
                if (global.activeReminders[reminderId] && !global.activeReminders[reminderId].done) {
                  try { await twilioClient.calls.create({ to: MY_NUMBER, from: TWILIO_NUMBER, twiml: '<Response><Say voice="Polly.Matthew">Trace. You told me to remind you about: ' + reminderText.replace(/[<>&"']/g, '') + '. Handle it now.</Say></Response>' }); } catch (e) {}
                }
              }, 60000);
            } catch (e) {}
          }
        }
      }, tenHours);

      return res.json({ response: "Got it. I'll remind you about " + reminderText + ". First nudge in 5 hours. If it's not done in 10, I'm calling you." });
    }

    // Mark done
    if (lowerMsg.startsWith('done') || lowerMsg.startsWith('finished')) {
      var doneText = userMessage.replace(/^(done[:\s]*|finished[:\s]*)/i, '').trim().toLowerCase();
      global.activeReminders = global.activeReminders || {};
      var cleared = 0;
      var rKeys = Object.keys(global.activeReminders);
      for (var rk = 0; rk < rKeys.length; rk++) {
        if (!global.activeReminders[rKeys[rk]].done && global.activeReminders[rKeys[rk]].text.toLowerCase().includes(doneText)) {
          global.activeReminders[rKeys[rk]].done = true;
          cleared++;
        }
      }
      if (cleared > 0) {
        try {
          await sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: "'Wins'!A:D",
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: [[new Date().toISOString().split('T')[0], 'Completed: ' + doneText, 'Personal Growth', 'Via voice']] },
          });
        } catch (e) {}
        return res.json({ response: "Cleared. That's execution. Logged as a win too." });
      }
      return res.json({ response: "No active reminders matching that." });
    }

    // Reminders list
    if (lowerMsg === 'reminders' || lowerMsg === 'what do i need to do') {
      global.activeReminders = global.activeReminders || {};
      var pending = [];
      var rKeys2 = Object.keys(global.activeReminders);
      for (var rk2 = 0; rk2 < rKeys2.length; rk2++) {
        if (!global.activeReminders[rKeys2[rk2]].done) {
          pending.push(global.activeReminders[rKeys2[rk2]].text);
        }
      }
      if (pending.length > 0) {
        return res.json({ response: "You have " + pending.length + " pending: " + pending.join(", ") });
      }
      return res.json({ response: "No pending reminders. You're clear." });
    }

    // Briefing
    if (lowerMsg === 'briefing' || lowerMsg === 'brief' || lowerMsg === 'status') {
      var context = await buildLifeOSContext();
      var emailContext = await buildEmailContext();
      var briefing = await askClaude(
        "You are Jarvis, Trace's personal AI counselor. Give a spoken briefing. Be concise, 3-5 sentences. No markdown. Talk like a mentor.\n\nLIFE OS DATA:\n" + context + emailContext,
        [{ role: 'user', content: 'Give me my briefing.' }]
      );
      return res.json({ response: briefing });
    }

    // Business briefing
    if (lowerMsg === 'business' || lowerMsg === 'crm' || lowerMsg === 'customers' || lowerMsg === 'bookings' || lowerMsg.includes('how many bookings') || lowerMsg.includes('how many customers') || lowerMsg.includes('business update') || lowerMsg.includes('crm update')) {
      var bizContext = await buildBusinessContext();
      var bizBriefing = await askClaude(
        "You are Jarvis, Trace's business AI assistant for Wildwood Small Engine Repair. Give a spoken business update. Be concise, 3-5 sentences. No markdown. Mention key numbers: bookings, cancellations, anything that needs attention like rescheduling. Talk like a sharp operations manager.\n\nCRM DATA:\n" + bizContext,
        [{ role: 'user', content: 'Give me my business update.' }]
      );
      return res.json({ response: bizBriefing });
    }

    // Emails
    if (lowerMsg === 'email' || lowerMsg === 'emails' || lowerMsg === 'inbox') {
      var emailContext = await buildEmailContext();
      if (!emailContext) return res.json({ response: "No email accounts connected." });
      var summary = await askClaude(
        "You are Jarvis. Summarize these emails in 2-3 spoken sentences. What's urgent, what can wait. No markdown.\n\n" + emailContext,
        [{ role: 'user', content: 'Summarize my inbox.' }]
      );
      return res.json({ response: summary });
    }

    // ====== DEFAULT: Regular conversation ======
    var history = webChatHistory[sessionId];
    if (!history) {
      var context = await buildLifeOSContext();
      var bizContext = '';
      try { bizContext = await buildBusinessContext(); } catch (e) {}
      history = {
        systemPrompt: "You are Jarvis, Trace's personal AI counselor, mentor, and business operations assistant. You are speaking through a browser voice interface.\n\nRULES:\n- Talk like a wise friend, life coach, and sharp business partner.\n- NEVER mention tab names, sheet names, row counts, or entry counts.\n- NEVER recite statistics unless Trace specifically asks for numbers.\n- Use the data to UNDERSTAND his life and business, then give human advice.\n- If he asks about business/customers/bookings, use the CRM data.\n- If he asks personal questions, use the Life OS data.\n- Ask thoughtful questions. Push him to grow.\n- Keep responses to 1-3 sentences MAX. You are being read aloud.\n- Never use markdown, bullet points, or formatting.\n- Sound like a real person, not a robot or a database.\n\nLIFE OS DATA (personal):\n" + context + "\n\nBUSINESS CRM DATA (Wildwood Small Engine Repair):\n" + bizContext,
        messages: [],
      };
    }

    history.messages.push({ role: 'user', content: userMessage });
    var response = await askClaude(history.systemPrompt, history.messages);
    history.messages.push({ role: 'assistant', content: response });
    if (history.messages.length > 12) history.messages = history.messages.slice(-6);
    webChatHistory[sessionId] = history;

    res.json({ response: response });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

/* ===========================
   POST /chat/athena â€” Athena Voice Chat
=========================== */

var athenaChatHistory = {};

app.post('/chat/athena', async function(req, res) {
  var sessionId = req.body.sessionId || 'default';
  var userMessage = req.body.message || '';

  try {
    var history = athenaChatHistory[sessionId];
    if (!history) {
      var bizContext = '';
      try { bizContext = await buildBusinessContext(); } catch (e) {}

      // Build comprehensive Athena context with all analytics
      var athenaContext = bizContext;

      // Add Google Ads data if available
      if (global.adsData) {
        athenaContext += '\n\nGOOGLE ADS DATA:\n' + JSON.stringify(global.adsData).substring(0, 5000);
      }

      // Add SEO Audit data summary
      var seoNatSummary = getSeoNationalTotals();
      athenaContext += '\n\nSEO AUDIT DATA (50 states, ' + seoNatSummary.totalCities + ' cities):\n';
      var seoSvcNames = { small_engine_repair: 'Small Engine Repair', lawn_mower_repair: 'Lawn Mower Repair', snow_blower_repair: 'Snow Blower Repair', generator_repair: 'Generator Repair', motorcycle_repair: 'Motorcycle Repair' };
      Object.keys(seoSvcNames).forEach(function(sk) {
        var t = seoNatSummary.totals[sk];
        athenaContext += seoSvcNames[sk] + ': ' + t.totalVol + '/mo total search volume across ' + t.cities + ' cities, avg keyword difficulty ' + Math.round(t.avgKd * 100) + '%\n';
      });
      // Kansas detail
      var ksCtx = getSeoStateData('Kansas');
      if (ksCtx) {
        athenaContext += '\nKANSAS SEO (Home Market):\n';
        ksCtx[0].forEach(function(cp) {
          var ms = getSeoMarketScore(cp[0], 'Kansas');
          if (ms && ms.totalVol > 0) {
            var svcDetail = [];
            Object.keys(ms.services).forEach(function(sk) { svcDetail.push(seoSvcNames[sk] + ' ' + ms.services[sk].vol + '/mo KD:' + Math.round(ms.services[sk].kd * 100) + '%'); });
            athenaContext += cp[0] + ' (pop ' + cp[1] + '): ' + svcDetail.join(', ') + '\n';
          }
        });
      }
      // Top 10 national opportunities
      var topOpp = [];
      Object.keys(SEO_AUDIT_DATA).forEach(function(st) {
        SEO_AUDIT_DATA[st][0].forEach(function(cp) {
          var ms = getSeoMarketScore(cp[0], st);
          if (ms && ms.totalVol > 0) topOpp.push(ms);
        });
      });
      topOpp.sort(function(a,b) { return b.score - a.score; });
      athenaContext += '\nTOP 10 EXPANSION MARKETS (by opportunity score):\n';
      topOpp.slice(0, 10).forEach(function(m, i) {
        athenaContext += (i+1) + '. ' + m.city + ', ' + m.state + ' â€” Score ' + m.score + ', Vol ' + m.totalVol + '/mo, KD ' + Math.round(m.avgKd * 100) + '%, Pop ' + m.pop + '\n';
      });

      // Add Profit & Financial data
      if (global.profitMetrics) {
        var pm = global.profitMetrics;
        athenaContext += '\n\nFINANCIAL DATA (Current Month: ' + (pm.currentMonth || '') + '):\n';
        athenaContext += 'Revenue: $' + (pm.revenue || 0).toLocaleString() + '\n';
        athenaContext += 'Expenses: $' + (pm.expenses || 0).toLocaleString() + '\n';
        athenaContext += 'Profit: $' + (pm.profit || 0).toLocaleString() + '\n';
        athenaContext += 'Margin: ' + (pm.margin || 0) + '%\n';
        athenaContext += 'Avg Daily Revenue: $' + (pm.avgDailyRev || 0) + '\n';
        athenaContext += 'Avg Daily Ad Spend: $' + (pm.avgDailyAds || 0) + '\n';
        if (pm.expenseBreakdown) {
          athenaContext += 'Expense Breakdown: ';
          Object.keys(pm.expenseBreakdown).forEach(function(cat) {
            athenaContext += cat + ': $' + pm.expenseBreakdown[cat] + ', ';
          });
          athenaContext += '\n';
        }
        if (pm.techPayouts) {
          athenaContext += 'Tech Payouts This Month: ';
          Object.keys(pm.techPayouts).forEach(function(t) {
            athenaContext += t + ': $' + pm.techPayouts[t] + ', ';
          });
          athenaContext += '\n';
        }
      }

      // Add detailed CRM metrics
      if (global.bizMetrics) {
        var bm = global.bizMetrics;
        athenaContext += '\n\nDETAILED CRM METRICS:\n';
        athenaContext += 'Total Leads: ' + bm.totalLeads + ', Booked: ' + bm.totalBooked + ', Completed: ' + bm.totalCompleted + ', Cancelled: ' + bm.totalCancelled + '\n';
        athenaContext += 'Conversion Rate: ' + bm.conversionRate + '%, Avg Days to Service: ' + bm.avgBookingDays + '\n';
        athenaContext += 'This Month Calls: ' + bm.thisMonthCalls + ', Last Month: ' + bm.lastMonthCalls + ', Growth: ' + bm.monthGrowth + '%\n';
        athenaContext += 'This Week: ' + bm.weeklyCalls + ' bookings, Return Customers: ' + bm.totalReturn + ', Promo Replies: ' + bm.promoReplies + '\n';
        athenaContext += 'New Markets This Month: ' + bm.newLocationsThisMonth + '\n';

        // Equipment breakdown
        if (bm.equipStats) {
          var eqSorted = Object.entries(bm.equipStats).sort(function(a,b){return b[1]-a[1];}).slice(0, 10);
          athenaContext += '\nTOP EQUIPMENT TYPES: ';
          eqSorted.forEach(function(e) { athenaContext += e[0] + ': ' + e[1] + ', '; });
          athenaContext += '\n';
        }

        // Brand breakdown
        if (bm.brandStats) {
          var brSorted = Object.entries(bm.brandStats).sort(function(a,b){return b[1]-a[1];}).slice(0, 10);
          athenaContext += 'TOP BRANDS: ';
          brSorted.forEach(function(b) { athenaContext += b[0] + ': ' + b[1] + ', '; });
          athenaContext += '\n';
        }

        // Technician stats
        if (bm.techStats) {
          athenaContext += '\nTECHNICIAN PERFORMANCE:\n';
          Object.keys(bm.techStats).forEach(function(t) {
            var ts = bm.techStats[t];
            athenaContext += t + ': ' + (ts.completed || 0) + ' completed, ' + (ts.total || 0) + ' total, ' + (ts.cancelled || 0) + ' cancelled';
            if (ts.equipment) {
              var topEq = Object.entries(ts.equipment).sort(function(a,b){return b[1]-a[1];}).slice(0,3);
              athenaContext += ', specialties: ' + topEq.map(function(e){return e[0];}).join('/');
            }
            athenaContext += '\n';
          });
        }

        // Location stats (top 15)
        if (bm.locationStats) {
          var locSorted = Object.entries(bm.locationStats).sort(function(a,b){return (b[1].total||0)-(a[1].total||0);}).slice(0, 15);
          athenaContext += '\nTOP LOCATIONS:\n';
          locSorted.forEach(function(l) {
            athenaContext += l[0] + ': ' + l[1].total + ' leads, ' + (l[1].booked||0) + ' booked, ' + (l[1].cancelled||0) + ' cancelled\n';
          });
        }

        // Call volume patterns (monthly)
        if (bm.monthlyCalls) {
          athenaContext += '\nMONTHLY CALL VOLUME TREND:\n';
          Object.keys(bm.monthlyCalls).sort().slice(-6).forEach(function(m) {
            athenaContext += m + ': ' + bm.monthlyCalls[m] + ' calls, ';
          });
          athenaContext += '\n';
        }

        // Seasonal data
        if (bm.seasonalData) {
          athenaContext += '\nSEASONAL PATTERNS: ';
          Object.keys(bm.seasonalData).forEach(function(m) {
            athenaContext += m + ': ' + bm.seasonalData[m] + ', ';
          });
          athenaContext += '\n';
        }
      }

      // Add Reviews/Ops data (includes SOPs)
      if (global.bizOpsData) {
        var ops = global.bizOpsData;
        var opsKeys = Object.keys(ops);
        if (opsKeys.length > 0) {
          athenaContext += '\n\nOPERATIONAL DATA & SOPs:\n';
          opsKeys.forEach(function(key) {
            var section = ops[key];
            var rows = section.rows || section;
            var isSOP = key.toLowerCase().includes('sop') || key.toLowerCase().includes('contract') || key.toLowerCase().includes('procedure') || key.toLowerCase().includes('checklist');
            if (isSOP && rows && rows.length > 0) {
              // Give SOPs full depth
              athenaContext += '\n=== SOP: ' + key + ' ===\n';
              rows.forEach(function(r) {
                athenaContext += r + '\n';
              });
            } else if (rows && rows.length > 0 && rows.length < 50) {
              athenaContext += key + ': ' + rows.length + ' rows. ';
              (Array.isArray(rows) ? rows : []).slice(0, 5).forEach(function(r) {
                athenaContext += (typeof r === 'string' ? r : JSON.stringify(r)).substring(0, 200) + ' | ';
              });
              athenaContext += '\n';
            } else if (rows) {
              athenaContext += key + ': ' + (rows.length || 0) + ' rows\n';
            }
          });
        }
      }

      // Add team roles from profit sheet
      if (global.profitMetrics) {
        var pm2 = global.profitMetrics;
        athenaContext += '\n\nTEAM ROLES:\n';
        if (pm2.techPayouts) {
          athenaContext += 'TECHNICIANS (field work): ' + Object.keys(pm2.techPayouts).join(', ') + '\n';
        }
        if (pm2.receptionistPayouts) {
          athenaContext += 'RECEPTIONISTS (phones/scheduling): ' + Object.keys(pm2.receptionistPayouts).join(', ') + '\n';
        }
        if (pm2.adminPayouts) {
          athenaContext += 'ADMIN/MANAGEMENT: ' + Object.keys(pm2.adminPayouts).join(', ') + '\n';
        }
      }

      // Add smart task assignments context
      if (global.bizMetrics) {
        var bm2 = global.bizMetrics;
        if (bm2.todayBookings && bm2.todayBookings.length > 0) {
          athenaContext += '\n\nTODAY\'S JOBS:\n';
          bm2.todayBookings.forEach(function(j) {
            athenaContext += j.name + ' â€” ' + (j.equip || 'unknown') + ' in ' + (j.location || 'unknown') + ' â€” Tech: ' + (j.tech || 'UNASSIGNED') + ' â€” Status: ' + (j.status || '') + '\n';
          });
        }
        if (bm2.needsReschedule && bm2.needsReschedule.length > 0) {
          athenaContext += '\nNEEDS RESCHEDULE:\n';
          bm2.needsReschedule.forEach(function(j) {
            athenaContext += j.name + ' â€” ' + (j.equip || '') + ' in ' + (j.location || '') + '\n';
          });
        }
      }

      // Add follow-up metrics
      if (global.followUpMetrics) {
        var fm = global.followUpMetrics;
        athenaContext += '\n\nFOLLOW-UP PORTAL DATA:\n';
        athenaContext += 'Employees: ' + fm.employeeCount + '\n';
        athenaContext += 'Submitted this week: ' + fm.submittedThisWeek + '/' + fm.employeeCount + '\n';
        if (fm.pendingThisWeek && fm.pendingThisWeek.length) athenaContext += 'Pending: ' + fm.pendingThisWeek.join(', ') + '\n';
        Object.keys(fm.stats || {}).forEach(function(name) {
          var s = fm.stats[name];
          athenaContext += name + ': ' + s.totalSubmissions + ' total, ' + s.onTime + ' on-time, ' + s.late + ' late';
          if (s.lateStreak > 0) athenaContext += ', late streak: ' + s.lateStreak;
          if (s.auditScores.length > 0) {
            var avg = Math.round(s.auditScores.reduce(function(a,b){return a+b;},0) / s.auditScores.length);
            athenaContext += ', avg audit: ' + avg + 'h/40h';
          }
          athenaContext += '\n';
        });
      }

      // Add Tookan live data
      if (global.tookanData) {
        var tk = global.tookanData;
        athenaContext += '\n\nTOOKAN DISPATCH DATA:\n';
        athenaContext += 'Active tasks: ' + (tk.activeTasks || 0) + '\n';
        athenaContext += 'Completed today: ' + (tk.completedToday || 0) + '\n';
        if (tk.tasksByTech) {
          Object.keys(tk.tasksByTech).forEach(function(tech) {
            athenaContext += tech + ': ' + tk.tasksByTech[tech] + ' tasks\n';
          });
        }
      }

      // Add Discord data
      if (DISCORD_BOT_TOKEN) {
        try {
          var discordMsgs = await discordGetAllRecent(20);
          if (discordMsgs.length > 0) {
            athenaContext += '\n\nDISCORD TEAM MESSAGES (recent):\n';
            discordMsgs.slice(0, 30).forEach(function(m) {
              athenaContext += '#' + m.channel + ' | ' + m.author + ': ' + (m.content || '').substring(0, 200) + '\n';
            });
            var dAuthors = {};
            discordMsgs.forEach(function(m) { dAuthors[m.author] = (dAuthors[m.author] || 0) + 1; });
            athenaContext += 'Discord activity: ' + Object.entries(dAuthors).map(function(a) { return a[0] + ': ' + a[1] + ' msgs'; }).join(', ') + '\n';
          }
        } catch (de) {}
      }

      // Add Square payment data (with full historical analytics)
      if (SQUARE_ACCESS_TOKEN) {
        try {
          var sq = await squareFullSnapshot();
          var sqA = squareAnalyze(sq);
          athenaContext += '\n\nSQUARE DATA (historical since 2022):\n';
          athenaContext += 'Today: $' + sqA.revenue.today.toFixed(2) + ', This Week: $' + sqA.revenue.week.toFixed(2) + ', Week Growth: ' + sqA.revenue.weekGrowth + '%\n';
          athenaContext += 'All-Time Gross: $' + sqA.revenue.allTimeTotal.toFixed(2) + ', Avg Ticket: $' + sqA.revenue.avgTicket.toFixed(2) + '\n';
          // Yearly
          athenaContext += 'YEARLY: ' + Object.keys(sqA.trends.yearlyRevenue).sort().map(function(y){return y+': $'+sqA.trends.yearlyRevenue[y].toFixed(0)+' ('+sqA.trends.yearlyPayments[y]+' payments)';}).join(', ') + '\n';
          // Recent months
          var recentMonths = Object.keys(sqA.trends.monthlyRevenue).sort().slice(-6);
          athenaContext += 'RECENT MONTHS: ' + recentMonths.map(function(m){return m+': $'+sqA.trends.monthlyRevenue[m].toFixed(0);}).join(', ') + '\n';
          if (sqA.trends.bestMonth) athenaContext += 'Best Month: ' + sqA.trends.bestMonth[0] + ' ($' + sqA.trends.bestMonth[1].toFixed(0) + '), Worst: ' + sqA.trends.worstMonth[0] + ' ($' + sqA.trends.worstMonth[1].toFixed(0) + ')\n';
          athenaContext += 'Customers: ' + sqA.customers.total + ', Repeat Rate: ' + sqA.customerInsights.repeatRate + '%, Avg LTV: $' + sqA.customerInsights.avgLTV.toFixed(2) + '\n';
          athenaContext += 'Refunds: ' + sqA.refunds.count + ' ($' + sqA.refunds.total.toFixed(2) + ', ' + sqA.refunds.rate + '% rate), Disputes Open: ' + sqA.disputes.open + '\n';
          athenaContext += 'Top Items: ' + sqA.orders.topItemsByRevenue.slice(0,5).map(function(e){return e[0]+': $'+e[1].revenue.toFixed(0);}).join(', ') + '\n';
          athenaContext += 'Peak: ' + sqA.payments.peakDay + ' at ' + sqA.payments.peakHour + '\n';
        } catch (sqe) {}
      }

      history = {
        systemPrompt: "You are ATHENA, the AI business operations engine for Wildwood Small Engine Repair. You are speaking through a voice interface to Trace, the owner.\n\nRULES:\n- You are ATHENA, not Jarvis. You are the business intelligence brain.\n- You know EVERYTHING about the business across every dashboard:\n  * CRM: bookings, conversion rates, cancellations, growth trends, monthly/weekly volume\n  * FINANCIAL: revenue, expenses, profit, margins, tech payouts, daily averages, ad spend\n  * GOOGLE ADS: spend, clicks, conversions, ROAS, cost per lead, campaign performance\n  * TECHNICIANS: job counts, completion rates, equipment specialties, workload balance\n  * EMPLOYEES: follow-up submissions, on-time rates, late streaks, AI audit scores\n  * DISPATCH: active Tookan tasks, completed today, tech assignments\n  * EQUIPMENT & BRANDS: what you fix most, brand trends\n  * LOCATIONS: top markets, calls by city, new expansion areas\n  * CALL PATTERNS: monthly trends, seasonal patterns, busiest periods\n  * REVIEWS & OPS: customer feedback, operational data\n  * SOPs: Standard Operating Procedures, contracts, checklists for each role\n  * TEAM ROLES: who is a tech, receptionist, or admin and their current performance\n  * DISCORD: team communication messages, who's active, response quality\n  * SQUARE: COMPLETE historical data since 2022 â€” payments, revenue by year/month/quarter, customers, invoices, refunds, disputes, catalog items, team members, payment methods, customer lifetime value, repeat rates, seasonal patterns, yearly comparisons, best/worst months\n- You can recommend WHAT NEEDS FOCUS based on the data.\n- You can recommend WHO SHOULD DO IT by matching the task to the right team member.\n- When asked about Discord or team communication, analyze message quality, response times, who's active vs quiet, and suggest improvements.\n- Give specific numbers when asked. Be precise.\n- Keep responses to 2-5 sentences MAX. You are being read aloud.\n- Never use markdown, bullet points, or formatting.\n- Sound confident, analytical, and sharp.\n\nBUSINESS DATA:\n" + athenaContext,
        messages: [],
      };
    }

    history.messages.push({ role: 'user', content: userMessage });
    var response = await askClaude(history.systemPrompt, history.messages);
    history.messages.push({ role: 'assistant', content: response });
    if (history.messages.length > 12) history.messages = history.messages.slice(-6);
    athenaChatHistory[sessionId] = history;

    res.json({ response: response });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

/* ===========================
   POST /tts â€” ElevenLabs Text to Speech
=========================== */

app.post('/tts', async function(req, res) {
  var text = req.body.text || '';
  var apiKey = process.env.ELEVENLABS_API_KEY;
  if (!apiKey) return res.status(500).json({ error: 'No ElevenLabs API key' });

  try {
    // Selected voice from ElevenLabs library
    // Default: Jarvis male voice; 'athena' = female voice
    var voiceParam = req.body.voice || 'jarvis';
    var voiceId = voiceParam === 'athena' ? '21m00Tcm4TlvDq8ikWAM' : 'jP5jSWhfXz3nfQENMtf4';
    var url = 'https://api.elevenlabs.io/v1/text-to-speech/' + voiceId;

    var https = require('https');
    var postData = JSON.stringify({
      text: text,
      model_id: 'eleven_turbo_v2',
      voice_settings: { stability: 0.5, similarity_boost: 0.75, style: 0.3 }
    });

    var options = {
      method: 'POST',
      headers: {
        'xi-api-key': apiKey,
        'Content-Type': 'application/json',
        'Accept': 'audio/mpeg',
      },
    };

    var proxyReq = https.request(url, options, function(proxyRes) {
      var chunks = [];
      proxyRes.on('data', function(chunk) { chunks.push(chunk); });
      proxyRes.on('end', function() {
        var buffer = Buffer.concat(chunks);
        if (proxyRes.statusCode === 200) {
          res.set('Content-Type', 'audio/mpeg');
          res.send(buffer);
        } else {
          res.status(500).json({ error: 'ElevenLabs error: ' + buffer.toString() });
        }
      });
    });
    proxyReq.on('error', function(e) { res.status(500).json({ error: e.message }); });
    proxyReq.write(postData);
    proxyReq.end();
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

/* ===========================
   GET /daily-questions â€” Auto trigger daily questions via cron
=========================== */

app.get('/daily-questions', async function(req, res) {
  var secret = process.env.CALL_SECRET;
  if (secret && req.query.key !== secret) return res.status(403).json({ error: 'Unauthorized' });

  try {
    var qContext = await buildLifeOSContext();
    var questionsRaw = await askClaude(
      "You generate 10 deep, personal challenge questions for Trace. These questions should challenge his beliefs, make him uncomfortable, and force growth.\n\nCover ALL these areas across the 10 questions: dating and relationships, money mindset, self-worth, business ambition, daily habits, health, purpose, fears, accountability, and personal identity.\n\nRULES:\n- Make each question personal based on his Life OS data\n- Questions should be uncomfortable but constructive\n- Never mention tab names, sheet names, or entry counts\n- Use what you know about his life to make questions HIT\n- Format: one question per line, numbered 1-10, nothing else\n- No fluff, no explanations, just the questions\n\nLIFE OS DATA:\n" + qContext,
      [{ role: 'user', content: 'Generate 10 deep personal challenge questions for today.' }]
    );

    var questions = questionsRaw.split('\n').filter(function(q) { return q.trim().match(/^\d/); });
    if (questions.length < 10) questions = questionsRaw.split('\n').filter(function(q) { return q.trim().length > 10; });

    var from = 'whatsapp:+18167392734';
    whatsappHistory[from] = whatsappHistory[from] || {};
    whatsappHistory[from].dailyQuestions = {
      questions: questions,
      answers: [],
      currentIndex: 0,
      date: new Date().toISOString().split('T')[0],
      active: true,
    };

    await twilioClient.messages.create({
      body: "Good morning Trace. Time to check in with yourself. 10 questions about your life, your beliefs, and where you're headed. Answer honestly â€” I'll tell you which beliefs need fixing and what to do about it.\n\n" + questions[0],
      from: 'whatsapp:+14155238886',
      to: '+18167392734',
    });

    res.json({ success: true, questionsGenerated: questions.length });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

/* ===========================
   POST /email/delete â€” Delete email from dashboard
=========================== */
app.post('/email/delete', async function(req, res) {
  try {
    var gmailClient = await getGmailClient(req.body.account);
    if (!gmailClient) return res.status(400).json({ error: 'Not connected' });
    await gmailClient.users.messages.trash({ userId: 'me', id: req.body.id });
    res.json({ success: true });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   POST /email/archive â€” Archive email from dashboard
=========================== */
app.post('/email/archive', async function(req, res) {
  try {
    var gmailClient = await getGmailClient(req.body.account);
    if (!gmailClient) return res.status(400).json({ error: 'Not connected' });
    await gmailClient.users.messages.modify({ userId: 'me', id: req.body.id, requestBody: { removeLabelIds: ['INBOX'] } });
    res.json({ success: true });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   POST /email/ai-reply â€” Generate AI reply
=========================== */
app.post('/email/ai-reply', async function(req, res) {
  try {
    var gmailClient = await getGmailClient(req.body.account);
    if (!gmailClient) return res.status(400).json({ error: 'Not connected' });
    var msgData = await gmailClient.users.messages.get({ userId: 'me', id: req.body.id, format: 'full' });
    var body = '';
    if (msgData.data.payload.body && msgData.data.payload.body.data) {
      body = Buffer.from(msgData.data.payload.body.data, 'base64').toString();
    } else if (msgData.data.payload.parts) {
      for (var p = 0; p < msgData.data.payload.parts.length; p++) {
        if (msgData.data.payload.parts[p].mimeType === 'text/plain' && msgData.data.payload.parts[p].body.data) {
          body = Buffer.from(msgData.data.payload.parts[p].body.data, 'base64').toString();
          break;
        }
      }
    }
    var headers = msgData.data.payload.headers;
    var fromH = headers.find(function(h) { return h.name === 'From'; });
    var subjH = headers.find(function(h) { return h.name === 'Subject'; });

    var reply = await askClaude(
      "You are Trace's AI assistant. Write a professional, friendly email reply. Keep it concise (2-4 sentences). No subject line, just the body. Sign off as Trace.",
      [{ role: 'user', content: 'Reply to this email:\nFrom: ' + (fromH ? fromH.value : '') + '\nSubject: ' + (subjH ? subjH.value : '') + '\nBody: ' + body.substring(0, 1000) }]
    );
    res.json({ reply: reply });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   POST /email/send-reply â€” Send the AI-generated reply
=========================== */
app.post('/email/send-reply', async function(req, res) {
  try {
    var result = await replyToEmail(req.body.account, req.body.id, req.body.reply);
    res.json(result);
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   GET /nightly-checkin â€” Auto trigger daily check-in via cron
=========================== */

/* ===========================
   GET /business/tabs â€” Browse all source tabs
=========================== */
app.get('/business/tabs', requireAuth('owner'), async function(req, res) {
  try {
    // Lazy load source tabs with separate cache
    if (!global.allSourceTabs || !global.sourceTabsTime || (Date.now() - global.sourceTabsTime) > 1800000) {
      // Load all 12 source spreadsheets (cached for 30 min)
      var sourceSheetIds = [
        "1kl72v4yIJrpD3U5pCYwtCiDhtdFZ_n4wUvZDxhPeIQk",
        "1LlfhcfiQdXStpV1vRrZzSmaEjyTvd1nrk5sqnhxsRYU",
        "1SDOqTxEMG8f81DtLwIu9ovz9mnxP_9Lpn6PH7OFBfBs",
        "1fj6SZZx5YtLMU8ldsAEZ1yffK0rHhFQoFir0GAOCFNU",
        "1ZITxT57ue2qSAbTUFRE_k1fJzKicPAO-BZMDSJOhJ7A",
        "1CJ9nn7l_PAwXPVSXmUogXejt46bsimrJi5iLQFQuo3o",
        "1KIulnemtmR6QpRbzEflNjvVOElNszuL9zClKhcbmOow",
        "19ndlgop-P0KLwv6PiG8sPdtj83jKH3vlDHf5AgjgmC8",
        "1A8oUmigHV6DsYcWF4hlDBC5KQDIHWMOh1Is6poCacx4",
        "1vnNEZjdhhkFNpNkDXRINpS55Zfysb_MzuFLhjVw6A2g",
        "1ZshCanMloF8uUlH39s2ZxvpCuvxjJQAONaSnN7590WA",
        "1IK-T9O_-ozg7n-Fecn1DodEMuznbvVW-i0ClzCPfuOI"
      ];
      
      var allTabData = [];
      for (var si = 0; si < sourceSheetIds.length; si++) {
        try {
          var meta = await sheets.spreadsheets.get({ spreadsheetId: sourceSheetIds[si], fields: 'properties.title,sheets.properties.title' });
          var ssTitle = meta.data.properties.title;
          var tabList = meta.data.sheets || [];
          for (var ti = 0; ti < tabList.length; ti++) {
            allTabData.push({ ssId: sourceSheetIds[si], ssTitle: ssTitle, tabTitle: tabList[ti].properties.title, headers: [], rows: [], rowCount: 0, loaded: false });
          }
          // Small delay to avoid quota
          await new Promise(function(r) { setTimeout(r, 500); });
        } catch(e) { console.log("Tab list error: " + e.message); }
      }
      global.allSourceTabs = allTabData;
      global.sourceTabsTime = Date.now();
    }

    var tabs = global.allSourceTabs || [];
    var tabName = req.query.tab || '';
    
    if (!tabName) {
      // Return list of all tabs
      var tabList = tabs.map(function(t) {
        return { source: t.ssTitle, tab: t.tabTitle, rows: t.rowCount, headers: t.headers };
      });
      var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>ATHENA â€” All Tabs</title>';
      html += '<style>';
      html += '@import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap");';
      html += 'body{background:#020810;color:#c0d8f0;font-family:Rajdhani,sans-serif;padding:20px;}';
      html += 'h1{font-family:Orbitron;color:#a855f7;text-align:center;letter-spacing:5px;}';
      html += '.source{margin:20px 0;border:1px solid #a855f720;padding:15px;}';
      html += '.source-title{font-family:Orbitron;color:#ffd700;font-size:1.1em;letter-spacing:3px;margin-bottom:10px;}';
      html += '.tab-link{display:inline-block;margin:4px;padding:8px 16px;border:1px solid #a855f730;color:#c0d8f0;text-decoration:none;cursor:pointer;transition:all 0.3s;}';
      html += '.tab-link:hover{background:#a855f720;border-color:#a855f7;}';
      html += '.row-count{color:#4a6a8a;font-size:0.8em;margin-left:5px;}';
      html += 'a{color:#00d4ff;text-decoration:none;}';
      html += '</style></head><body>';
      html += '<h1>ALL SOURCE DATA</h1>';
      html += '<div style="text-align:center;margin-bottom:20px;"><a href="/business">â† Back to Dashboard</a></div>';
      html += '<div style="text-align:center;color:#4a6a8a;margin-bottom:20px;">' + tabList.length + ' tabs across ' + new Set(tabList.map(function(t){return t.source;})).size + ' spreadsheets</div>';
      
      // Group by source
      var sources = {};
      tabList.forEach(function(t) {
        if (!sources[t.source]) sources[t.source] = [];
        sources[t.source].push(t);
      });
      
      Object.entries(sources).forEach(function(s) {
        html += '<div class="source">';
        html += '<div class="source-title">' + s[0] + '</div>';
        s[1].forEach(function(t) {
          html += '<a class="tab-link" href="/business/tabs?tab=' + encodeURIComponent(s[0] + ' | ' + t.tab) + '">' + t.tab + '<span class="row-count">(' + t.rows + ')</span></a>';
        });
        html += '</div>';
      });
      
      html += '</body></html>';
      return res.send(html);
    }
    
    // Show specific tab data
    var parts = tabName.split(' | ');
    var ssName = parts[0] || '';
    var tName = parts[1] || '';
    var found = tabs.find(function(t) { return t.ssTitle === ssName && t.tabTitle === tName; });
    
    if (!found) return res.status(404).json({ error: 'Tab not found' });
    
    // Load data on demand if not yet loaded
    if (!found.loaded) {
      try {
        var tabRes = await sheets.spreadsheets.values.get({
          spreadsheetId: found.ssId,
          range: "'" + found.tabTitle + "'!A1:ZZ",
        });
        var tabRows = tabRes.data.values || [];
        found.headers = tabRows[0] || [];
        found.rows = tabRows.slice(1);
        found.rowCount = found.rows.length;
        found.loaded = true;
      } catch(e) {
        return res.status(500).json({ error: 'Failed to load tab: ' + e.message });
      }
    }
    
    var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>' + tName + ' â€” ATHENA</title>';
    html += '<style>';
    html += '@import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap");';
    html += 'body{background:#020810;color:#c0d8f0;font-family:Rajdhani,sans-serif;padding:20px;}';
    html += 'h1{font-family:Orbitron;color:#a855f7;letter-spacing:3px;font-size:1.3em;}';
    html += 'h2{color:#ffd700;font-family:Orbitron;font-size:0.8em;letter-spacing:2px;}';
    html += 'table{border-collapse:collapse;width:100%;margin-top:15px;}';
    html += 'th{background:#0d1117;color:#a855f7;padding:8px 10px;text-align:left;font-family:Orbitron;font-size:0.65em;letter-spacing:1px;border:1px solid #a855f720;white-space:nowrap;}';
    html += 'td{padding:6px 10px;border:1px solid #1a2a3a;font-size:0.9em;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}';
    html += 'tr:nth-child(even){background:rgba(168,85,247,0.03);}';
    html += 'tr:hover{background:rgba(168,85,247,0.08);}';
    html += 'a{color:#00d4ff;text-decoration:none;}';
    html += '</style></head><body>';
    html += '<div style="margin-bottom:15px;"><a href="/business/tabs">â† All Tabs</a> &nbsp;|&nbsp; <a href="/business">â† Dashboard</a></div>';
    html += '<h1>' + tName + '</h1>';
    html += '<h2>Source: ' + ssName + ' â€” ' + found.rowCount + ' rows</h2>';
    
    html += '<table><thead><tr>';
    found.headers.forEach(function(h) { html += '<th>' + (h || '').toString() + '</th>'; });
    html += '</tr></thead><tbody>';
    
    var maxShow = Math.min(found.rows.length, 500);
    for (var rr = 0; rr < maxShow; rr++) {
      html += '<tr>';
      for (var cc = 0; cc < found.headers.length; cc++) {
        html += '<td>' + ((found.rows[rr][cc] || '').toString()) + '</td>';
      }
      html += '</tr>';
    }
    html += '</tbody></table>';
    if (found.rows.length > 500) html += '<div style="color:#4a6a8a;margin-top:10px;">Showing 500 of ' + found.rows.length + ' rows</div>';
    html += '</body></html>';
    res.send(html);
    
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

/* ===========================
   GET /business/search â€” Customer Lookup
=========================== */
app.get('/business/search', async function(req, res) {
  try {
    var q = (req.query.q || '').toLowerCase().trim();
    if (!q || q.length < 2) return res.json({ results: [] });
    await buildBusinessContext(); // ensure data loaded
    var allJobRows = (global.allSourceTabs || []).reduce(function(acc, tab) { return acc; }, []);
    // Use bizMetrics recentBookings for search
    var bm = global.bizMetrics || {};
    var recent = bm.recentBookings || [];
    var results = [];
    for (var i = 1; i < rows.length && results.length < 20; i++) {
      var row = rows[i];
      var name = ((row[1] || '') + ' ' + (row[2] || '')).toLowerCase();
      var phone = (row[6] || '').toString().toLowerCase();
      var email = (row[7] || '').toString().toLowerCase();
      var city = (row[9] || '').toString().toLowerCase();
      if (name.includes(q) || phone.includes(q) || email.includes(q) || city.includes(q)) {
        results.push({
          name: ((row[1] || '') + ' ' + (row[2] || '')).trim(),
          phone: row[6] || '', email: row[7] || '',
          city: (row[9] || '') + ', ' + (row[10] || ''),
          address: row[8] || '', equip: row[12] || '',
          brand: row[13] || '', issue: (row[14] || '').substring(0, 80),
          tech: row[15] || '', status: row[17] || '',
          date: row[0] || ''
        });
      }
    }
    res.json({ results: results });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   POST /business/confirm-text â€” Send booking confirmation
=========================== */
app.post('/business/confirm-text', async function(req, res) {
  try {
    var phone = req.body.phone;
    var name = req.body.name;
    var date = req.body.date || 'your scheduled date';
    if (!phone) return res.status(400).json({ error: 'Phone required' });
    var cleanPhone = phone.replace(/[^\d+]/g, '');
    if (!cleanPhone.startsWith('+')) cleanPhone = '+1' + cleanPhone.replace(/^1/, '');
    var msg = 'Hi ' + name + '! This is Wildwood Small Engine Repair confirming your appointment for ' + date + '. Our technician will arrive during the scheduled window. Reply CONFIRM to confirm or call us to reschedule. Thank you!';
    await twilioClient.messages.create({ body: msg, from: TWILIO_NUMBER, to: cleanPhone });
    res.json({ success: true });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   POST /business/followup-text â€” Send 3-day follow-up
=========================== */
app.post('/business/followup-text', async function(req, res) {
  try {
    var phone = req.body.phone;
    var name = req.body.name;
    if (!phone) return res.status(400).json({ error: 'Phone required' });
    var cleanPhone = phone.replace(/[^\d+]/g, '');
    if (!cleanPhone.startsWith('+')) cleanPhone = '+1' + cleanPhone.replace(/^1/, '');
    var msg = 'Hi ' + name + '! This is Wildwood Small Engine Repair. We hope your equipment is running great! If you have any questions or need anything else, don\'t hesitate to reach out. We appreciate your business!';
    await twilioClient.messages.create({ body: msg, from: TWILIO_NUMBER, to: cleanPhone });
    res.json({ success: true });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   POST /business/log-timer â€” Log job timer
=========================== */
app.post('/business/log-timer', async function(req, res) {
  try {
    var d = new Date();
    await sheets.spreadsheets.values.append({
      spreadsheetId: BUSINESS_SPREADSHEET_ID,
      range: "'Job_Timers'!A:E",
      valueInputOption: 'USER_ENTERED',
      requestBody: { values: [[d.toISOString().split('T')[0], req.body.jobName, req.body.duration, req.body.minutes, d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Chicago' })]] },
    });
    res.json({ success: true });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   GET /business/insights â€” AI Weekly Business Report
=========================== */
app.get('/business/insights', async function(req, res) {
  try {
    var bizContext = await buildBusinessContext();
    var insights = await askClaude(
      "You are ATHENA, the AI business operations engine for Wildwood Small Engine Repair. Analyze the CRM data and generate a sharp weekly business report. Be specific with numbers. Cover: 1) What's working (top performing locations, best techs, growing markets), 2) What needs attention (high cancel rates, understaffed areas, slow response times), 3) Growth opportunities (new markets to target, seasonal prep, upsell opportunities), 4) Action items for this week (specific, numbered, actionable). Keep it under 500 words. No markdown formatting, use plain text with line breaks.",
      [{ role: 'user', content: 'Generate my weekly business insights report.\n\nCRM DATA:\n' + bizContext }]
    );
    res.json({ insights: insights });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

app.get('/nightly-checkin', async function(req, res) {
  var secret = process.env.CALL_SECRET;
  if (secret && req.query.key !== secret) return res.status(403).json({ error: 'Unauthorized' });

  try {
    var from = 'whatsapp:+18167392734';
    whatsappHistory[from] = whatsappHistory[from] || {};
    whatsappHistory[from].dailyCheckin = {
      step: 0,
      data: { date: new Date().toISOString().split('T')[0] },
      active: true,
    };

    await twilioClient.messages.create({
      body: "End of day check-in. Quick answers, no overthinking.\n\nHow many hours did you sleep last night?",
      from: 'whatsapp:+14155238886',
      to: '+18167392734',
    });

    res.json({ success: true });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

/* ===========================
   GET /team â€” Full Team Overview
=========================== */
app.get('/team', async function(req, res) {
  try {
    await buildBusinessContext();
    var bm = global.bizMetrics || {};
    var ts = bm.techStats || {};
    var techList = bm.techList || [];

    var profiles = Object.entries(ts).sort(function(a,b){return b[1].total-a[1].total;}).map(function(t) {
      var s = t[1];
      var rate = s.total > 0 ? Math.round((s.completed / s.total) * 100) : 0;
      var avgResp = s.avgResponseDays.length > 0 ? Math.round(s.avgResponseDays.reduce(function(a,b){return a+b;},0) / s.avgResponseDays.length) : 0;
      var topEquip = Object.entries(s.equipment || {}).sort(function(a,b){return b[1]-a[1];}).slice(0,3);
      var topLocs = Object.entries(s.locations || {}).sort(function(a,b){return b[1]-a[1];}).slice(0,5);
      var topBrands = Object.entries(s.brands || {}).sort(function(a,b){return b[1]-a[1];}).slice(0,3);
      var phone = '';
      techList.forEach(function(tl) { if (tl.name && tl.name.toLowerCase().includes(t[0].toLowerCase())) phone = tl.phone; });

      // Performance grade
      var grade = 'C';
      if (rate >= 85 && s.total >= 10) grade = 'A+';
      else if (rate >= 75 && s.total >= 8) grade = 'A';
      else if (rate >= 65 && s.total >= 5) grade = 'B';
      else if (rate >= 50) grade = 'C';
      else grade = 'D';

      return {
        name: t[0], total: s.total, completed: s.completed, cancelled: s.cancelled,
        rate: rate, avgResponseDays: avgResp, phone: phone, grade: grade,
        thisWeek: s.thisWeekJobs, thisMonth: s.thisMonthJobs,
        todayJobs: s.todayJobs || [], recentJobs: s.recentJobs || [],
        topEquipment: topEquip, topLocations: topLocs, topBrands: topBrands,
        returnCustomers: s.returnCustomers || 0,
        firstSeen: s.firstSeen ? s.firstSeen.toISOString().split('T')[0] : null,
        lastSeen: s.lastSeen ? s.lastSeen.toISOString().split('T')[0] : null,
      };
    });

    res.json({ teamSize: profiles.length, profiles: profiles });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   GET /team/:name â€” Individual Tech Profile
=========================== */
app.get('/team/:name', async function(req, res) {
  try {
    await buildBusinessContext();
    var ts = (global.bizMetrics || {}).techStats || {};
    var name = req.params.name;
    var found = null;
    Object.keys(ts).forEach(function(k) {
      if (k.toLowerCase() === name.toLowerCase() || k.toLowerCase().includes(name.toLowerCase())) found = { key: k, data: ts[k] };
    });
    if (!found) return res.status(404).json({ error: 'Tech not found' });
    var s = found.data;
    var rate = s.total > 0 ? Math.round((s.completed / s.total) * 100) : 0;
    var avgResp = s.avgResponseDays.length > 0 ? Math.round(s.avgResponseDays.reduce(function(a,b){return a+b;},0) / s.avgResponseDays.length) : 0;
    res.json({
      name: found.key, total: s.total, completed: s.completed, cancelled: s.cancelled,
      rate: rate, avgResponseDays: avgResp, thisWeek: s.thisWeekJobs, thisMonth: s.thisMonthJobs,
      todayJobs: s.todayJobs, recentJobs: s.recentJobs,
      equipment: Object.entries(s.equipment).sort(function(a,b){return b[1]-a[1];}),
      locations: Object.entries(s.locations).sort(function(a,b){return b[1]-a[1];}),
      brands: Object.entries(s.brands).sort(function(a,b){return b[1]-a[1];}),
    });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   GET /team/assign â€” Smart Auto-Assignment
=========================== */
app.get('/team/assign', async function(req, res) {
  try {
    await buildBusinessContext();
    var bm = global.bizMetrics || {};
    var ts = bm.techStats || {};
    var todayJobs = bm.todayBookings || [];
    var needsResched = bm.needsReschedule || [];

    var allJobs = todayJobs.concat(needsResched.map(function(n){return { name: n.name, location: n.location, equip: '', issue: 'Rescheduling needed', tech: '' };}));
    var unassigned = allJobs.filter(function(j){return !j.tech || j.tech === '';});
    var techEntries = Object.entries(ts).sort(function(a,b){return b[1].completed - a[1].completed;});

    var assignments = unassigned.map(function(job) {
      var bestTech = null, bestScore = -1, reasoning = '';
      techEntries.forEach(function(t) {
        var s = t[1], score = 0, reasons = [];
        var completionRate = s.total > 0 ? s.completed / s.total : 0;
        score += completionRate * 40; reasons.push(Math.round(completionRate*100) + '% completion');
        if (job.equip && s.equipment) {
          Object.keys(s.equipment).forEach(function(e) {
            if (e.toLowerCase().includes(job.equip.toLowerCase()) || job.equip.toLowerCase().includes(e.toLowerCase())) {
              score += 25; reasons.push('specializes in ' + e);
            }
          });
        }
        if (job.location && s.locations && s.locations[job.location]) {
          score += 20; reasons.push('works in ' + job.location);
        }
        score -= (s.todayJobs || []).length * 15;
        if ((s.todayJobs || []).length === 0) { score += 10; reasons.push('free today'); }
        if (score > bestScore) { bestScore = score; bestTech = t[0]; reasoning = reasons.join(', '); }
      });
      return { job: job.name, location: job.location, equipment: job.equip, recommendedTech: bestTech, score: Math.round(bestScore), reasoning: reasoning };
    });

    res.json({ unassignedCount: unassigned.length, totalToday: allJobs.length, assignments: assignments });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   GET /team/daily-tasks â€” Auto-Generated Daily Task Lists Per Tech
=========================== */
app.get('/team/daily-tasks', async function(req, res) {
  try {
    await buildBusinessContext();
    var bm = global.bizMetrics || {};
    var ts = bm.techStats || {};
    var techEntries = Object.entries(ts).sort(function(a,b){return b[1].total-a[1].total;});

    var taskLists = techEntries.map(function(t) {
      var s = t[1];
      var tasks = [];

      // Today's assigned jobs
      (s.todayJobs || []).forEach(function(j) {
        tasks.push({ priority: 'HIGH', type: 'Job', task: j.name + ' â€” ' + j.equip + ' (' + j.location + ')', detail: j.issue });
      });

      // Follow up on recent incomplete
      (s.recentJobs || []).forEach(function(j) {
        if (j.status && (j.status.includes('pending') || j.status.includes('schedul'))) {
          tasks.push({ priority: 'MEDIUM', type: 'Follow-up', task: 'Follow up: ' + j.name + ' (' + j.location + ')', detail: 'Status: ' + j.status });
        }
      });

      // Coaching note based on stats
      var rate = s.total > 0 ? Math.round((s.completed / s.total) * 100) : 0;
      var coaching = '';
      if (rate < 60 && s.total >= 5) coaching = 'Cancel rate is high (' + (100-rate) + '%). Focus on confirming appointments before going out.';
      else if (s.thisWeekJobs === 0 && s.total > 0) coaching = 'No jobs this week. Check scheduling or availability.';
      else if (rate >= 85) coaching = 'Excellent performance. Consider for team lead responsibilities.';

      return { tech: t[0], taskCount: tasks.length, tasks: tasks, coaching: coaching, todayLoad: (s.todayJobs || []).length, weekLoad: s.thisWeekJobs };
    });

    res.json({ taskLists: taskLists });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   GET /team/coaching â€” AI Coaching Report Per Tech
=========================== */
app.get('/team/coaching', async function(req, res) {
  try {
    var bizContext = await buildBusinessContext();
    var coaching = await askClaude(
      "You are ATHENA, business operations AI for Wildwood Small Engine Repair. Generate individual coaching reports for each technician. For EACH tech: 1) Strengths (what they do well, backed by data), 2) Areas to improve (specific, actionable), 3) This week's focus (one priority), 4) Equipment they should study (based on gaps). Be specific with numbers. Keep each tech's section to 3-4 sentences. No markdown.",
      [{ role: 'user', content: 'Generate coaching reports for my team:\n\n' + bizContext }]
    );
    res.json({ coaching: coaching });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   GET /team/workload â€” Workload Balance Analysis
=========================== */
app.get('/team/workload', async function(req, res) {
  try {
    await buildBusinessContext();
    var ts = (global.bizMetrics || {}).techStats || {};
    var entries = Object.entries(ts).sort(function(a,b){return b[1].total-a[1].total;});
    var totalJobs = entries.reduce(function(sum,t){return sum + t[1].total;},0);
    var avgPerTech = entries.length > 0 ? Math.round(totalJobs / entries.length) : 0;

    var analysis = entries.map(function(t) {
      var s = t[1];
      var deviation = s.total - avgPerTech;
      var status = 'balanced';
      if (deviation > avgPerTech * 0.5) status = 'overloaded';
      else if (deviation < -avgPerTech * 0.3) status = 'underutilized';
      return {
        tech: t[0], total: s.total, thisWeek: s.thisWeekJobs, thisMonth: s.thisMonthJobs,
        todayCount: (s.todayJobs || []).length, deviation: deviation, status: status,
        topLocation: Object.entries(s.locations || {}).sort(function(a,b){return b[1]-a[1];})[0],
        topEquip: Object.entries(s.equipment || {}).sort(function(a,b){return b[1]-a[1];})[0],
      };
    });

    res.json({ teamSize: entries.length, totalJobs: totalJobs, avgPerTech: avgPerTech, analysis: analysis });
  } catch (err) { res.status(500).json({ error: err.message }); }
});

/* ===========================
   START SERVER
=========================== */

/* ===========================
   DEBUG: Sheet Diagnostics
=========================== */
app.get('/debug-sheets', async function(req, res) {
  if (req.query.key !== 'jarvis-wake-up-2026') return res.status(403).send('Forbidden');
  var results = {};
  results.SPREADSHEET_ID = SPREADSHEET_ID ? SPREADSHEET_ID.substring(0, 10) + '...' : 'NOT SET';
  results.BUSINESS_SPREADSHEET_ID = BUSINESS_SPREADSHEET_ID ? BUSINESS_SPREADSHEET_ID.substring(0, 10) + '...' : 'NOT SET';
  results.same_sheet = SPREADSHEET_ID === BUSINESS_SPREADSHEET_ID;

  // Try to list all tabs on the business sheet
  try {
    var meta = await sheets.spreadsheets.get({ spreadsheetId: BUSINESS_SPREADSHEET_ID, fields: 'sheets.properties.title' });
    results.business_tabs = meta.data.sheets.map(function(s) { return s.properties.title; });
  } catch (e) {
    results.business_tabs_error = e.message;
  }

  // Try reading Combined tab
  try {
    var combinedRes = await sheets.spreadsheets.values.get({ spreadsheetId: BUSINESS_SPREADSHEET_ID, range: "'Combined'!A1:Z5" });
    var rows = combinedRes.data.values || [];
    results.combined_headers = rows[0] || 'NO HEADERS';
    results.combined_row_count = rows.length;
    results.combined_sample = rows[1] || 'NO DATA';
  } catch (e) {
    results.combined_error = e.message;
  }

  // Also try personal sheet tabs
  try {
    var meta2 = await sheets.spreadsheets.get({ spreadsheetId: SPREADSHEET_ID, fields: 'sheets.properties.title' });
    results.personal_tabs = meta2.data.sheets.map(function(s) { return s.properties.title; });
  } catch (e) {
    results.personal_tabs_error = e.message;
  }

  // Try profit sheet
  var PROFIT_SHEET_ID = '1TXwXvcjt1M9bl38_0GhjK6izRGjTTuaGTN8RAmEiFwc';
  try {
    var profitMeta = await sheets.spreadsheets.get({ spreadsheetId: PROFIT_SHEET_ID, fields: 'sheets.properties.title' });
    results.profit_tabs = profitMeta.data.sheets.map(function(s) { return s.properties.title; });
  } catch (e) {
    results.profit_tabs_error = e.message;
  }

  // Read first tab of profit sheet
  try {
    var profitMeta2 = await sheets.spreadsheets.get({ spreadsheetId: PROFIT_SHEET_ID, fields: 'sheets.properties.title' });
    var firstTab = profitMeta2.data.sheets[0].properties.title;
    var profitRes = await sheets.spreadsheets.values.get({ spreadsheetId: PROFIT_SHEET_ID, range: "'" + firstTab + "'!A1:Z5" });
    var profitRows = profitRes.data.values || [];
    results.profit_headers = profitRows[0] || 'NO HEADERS';
    results.profit_row_count = profitRows.length;
    results.profit_sample = profitRows[1] || 'NO DATA';
    if (profitRows[2]) results.profit_sample2 = profitRows[2];
  } catch (e) {
    results.profit_read_error = e.message;
  }

  res.json(results);
});

/* ===========================
   TOOKAN LIVE DASHBOARD
=========================== */

app.get('/tookan', requireAuth('owner'), async function(req, res) {
  try {
    var tk = await buildTookanContext();
    var todayStr = new Date().toISOString().split('T')[0];
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>ATHENA â€” Tookan Live</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">';
    html += '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />';
    html += '<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"><\/script>';
    html += '<style>';
    html += 'body{margin:0;background:#050d18;color:#c0d8f0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;}';
    html += '.wrap{max-width:1400px;margin:0 auto;padding:30px 40px;}';
    html += '.title{font-family:Orbitron;font-size:1.4em;letter-spacing:8px;color:#00d4ff;margin-bottom:5px;}';
    html += '.sub{font-family:Orbitron;font-size:0.6em;letter-spacing:3px;color:#4a6a8a;margin-bottom:30px;}';
    html += '.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:30px;}';
    html += '.card{background:rgba(10,20,35,0.8);border:1px solid rgba(255,255,255,0.05);padding:20px;text-align:center;}';
    html += '.card .label{font-family:Orbitron;font-size:0.5em;letter-spacing:3px;color:#4a6a8a;margin-bottom:8px;}';
    html += '.card .val{font-family:Orbitron;font-size:2.2em;font-weight:900;}';
    html += '.card .sub2{color:#4a6a8a;font-size:0.8em;margin-top:4px;}';
    html += '.section{margin-bottom:30px;}';
    html += '.section-title{font-family:Orbitron;font-size:0.8em;letter-spacing:5px;text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:10px;}';
    html += '.dot{width:8px;height:8px;border-radius:50%;display:inline-block;}';
    html += '.row{background:rgba(10,20,35,0.6);border:1px solid rgba(255,255,255,0.03);padding:12px 16px;margin-bottom:4px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}';
    html += '.badge{font-family:Orbitron;font-size:0.5em;letter-spacing:2px;padding:3px 10px;border:1px solid;}';
    html += '.b-completed{color:#00ff66;border-color:#00ff6640;}';
    html += '.b-assigned{color:#00d4ff;border-color:#00d4ff40;}';
    html += '.b-acknowledged{color:#a855f7;border-color:#a855f740;}';
    html += '.b-started{color:#ff9f43;border-color:#ff9f4340;}';
    html += '.b-failed{color:#ff4757;border-color:#ff475740;}';
    html += '.b-unassigned{color:#c0c0c0;border-color:#c0c0c040;}';
    html += '.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:20px;}';
    html += '.holo-btn{font-family:Orbitron;font-size:0.6em;letter-spacing:3px;padding:10px 20px;color:#00d4ff;border:1px solid #00d4ff30;background:transparent;text-decoration:none;transition:all 0.3s;}';
    html += '.holo-btn:hover{background:rgba(0,212,255,0.1);}';
    // Mobile responsive
    html += '@media(max-width:768px){';
    html += '.wrap{padding:10px 12px!important;}';
    html += '.grid{grid-template-columns:repeat(2,1fr)!important;gap:8px!important;}';
    html += '.kpi-grid{grid-template-columns:repeat(2,1fr)!important;}';
    html += '.analytics-grid{grid-template-columns:1fr!important;}';
    html += '.title{font-size:1em!important;letter-spacing:3px!important;}';
    html += '.card,.val{font-size:0.9em!important;}';
    html += 'table{font-size:0.65em!important;} th,td{padding:4px 3px!important;}';
    html += '[style*="overflow-x"]{overflow-x:auto!important;-webkit-overflow-scrolling:touch;}';
    html += '#map{height:250px!important;}';
    html += '[style*="display:flex"][style*="gap:0"]{flex-wrap:wrap!important;}';
    html += '}';
    html += '@media(max-width:480px){.grid{grid-template-columns:1fr!important;}}';
    html += '</style></head><body><div class="wrap">';

    html += '<div class="title">TOOKAN DISPATCH CENTER</div>';
    html += '<div class="sub">REAL-TIME JOB TRACKING â€¢ ' + tk.totalTasks + ' TASKS (90 DAYS) â€¢ ' + tk.agents.length + ' AGENTS</div>';

    // === TAB NAVIGATION ===
    html += '<div style="display:flex;gap:0;margin-bottom:25px;">';
    html += '<a href="/dashboard" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">JARVIS</a>';
    html += '<a href="/business" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">ATHENA</a>';
    html += '<a href="/tookan" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#00d4ff;border:1px solid #00d4ff40;text-decoration:none;background:rgba(0,212,255,0.1);box-shadow:0 0 15px rgba(0,212,255,0.1);">TOOKAN</a>';
    html += '<a href="/business/chart" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">CHARTS</a>';
    html += '<a href="/analytics" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">ANALYTICS</a>';
    html += '<a href="/ads" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">GOOGLE ADS</a>';
    html += '<a href="/square" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">SQUARE</a><a href="/discord" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">DISCORD</a><a href="/followup" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">FOLLOW UP</a><a href="/ai" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AI</a><a href="/forecast" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">FORECAST</a><a href="/seo" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">SEO</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AUDIT</a><a href="/auth/logout" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#ef4444;border:1px solid #ef444440;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">LOGOUT</a>';
    html += '</div>';

    // Status overview cards
    html += '<div class="grid">';
    html += '<div class="card"><div class="label">TOTAL TASKS</div><div class="val" style="color:#00d4ff;">' + tk.totalTasks + '</div><div class="sub2">Last 90 days</div></div>';
    html += '<div class="card"><div class="label">COMPLETED</div><div class="val" style="color:#00ff66;">' + tk.completed + '</div><div class="sub2">' + (tk.totalTasks > 0 ? Math.round(tk.completed / tk.totalTasks * 100) : 0) + '% completion rate</div></div>';
    html += '<div class="card"><div class="label">ASSIGNED</div><div class="val" style="color:#00d4ff;">' + tk.assigned + '</div><div class="sub2">Waiting for tech</div></div>';
    html += '<div class="card"><div class="label">ACKNOWLEDGED</div><div class="val" style="color:#a855f7;">' + tk.acknowledged + '</div><div class="sub2">Tech confirmed</div></div>';
    html += '<div class="card"><div class="label">IN PROGRESS</div><div class="val" style="color:#ff9f43;">' + tk.started + '</div><div class="sub2">Started / Arrived</div></div>';
    html += '<div class="card"><div class="label">UNASSIGNED</div><div class="val" style="color:#c0c0c0;">' + tk.unassigned + '</div><div class="sub2">Needs dispatch</div></div>';
    html += '<div class="card"><div class="label">FAILED/CANCELLED</div><div class="val" style="color:#ff4757;">' + tk.cancelled + '</div><div class="sub2">' + (tk.totalTasks > 0 ? Math.round(tk.cancelled / tk.totalTasks * 100) : 0) + '% fail rate</div></div>';
    html += '</div>';

    // ====== ANALYTICS â€” DONUT CHARTS + KPI CARDS ======
    // SVG donut chart helper
    html += '<style>';
    html += '.analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;}';
    html += '.chart-card{background:rgba(10,20,35,0.8);border:1px solid rgba(255,255,255,0.05);padding:20px;text-align:center;}';
    html += '.chart-title{font-family:Orbitron;font-size:0.55em;letter-spacing:3px;color:#00d4ff;padding:4px 12px;background:rgba(0,212,255,0.1);display:inline-block;margin-bottom:15px;}';
    html += '.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:30px;}';
    html += '.kpi{background:rgba(10,20,35,0.8);border:1px solid rgba(255,255,255,0.05);padding:20px;text-align:center;position:relative;}';
    html += '.kpi .kpi-label{font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:#00d4ff;padding:3px 10px;background:rgba(0,212,255,0.1);display:inline-block;margin-bottom:12px;}';
    html += '.kpi .kpi-val{font-family:Orbitron;font-size:2em;font-weight:900;color:#c0d8f0;}';
    html += '.kpi .kpi-change{font-size:0.85em;margin-top:6px;}';
    html += '.kpi .kpi-sub{color:#4a6a8a;font-size:0.8em;margin-top:2px;}';
    html += '.week-chart{display:flex;align-items:flex-end;gap:6px;height:80px;margin-top:15px;padding:0 10px;}';
    html += '.week-bar{flex:1;display:flex;flex-direction:column;align-items:center;}';
    html += '.week-bar-inner{width:100%;background:linear-gradient(180deg,#00d4ff,#00d4ff40);border-radius:2px 2px 0 0;transition:height 0.3s;}';
    html += '.week-bar-label{color:#4a6a8a;font-size:0.65em;margin-top:4px;}';
    html += '.week-bar-count{color:#c0d8f0;font-size:0.7em;margin-bottom:2px;}';
    html += '@media(max-width:768px){.analytics-grid{grid-template-columns:1fr;}.kpi-grid{grid-template-columns:repeat(2,1fr);}}';
    html += '</style>';

    // Task Status donut & Agent Status donut
    var taskAccepted = tk.acknowledged + tk.started;
    var taskAssignedOnly = tk.assigned + tk.unassigned;
    var taskTotal = taskAccepted + taskAssignedOnly + tk.completed;

    html += '<div class="analytics-grid">';

    // Task Status Donut
    html += '<div class="chart-card">';
    html += '<div class="chart-title">Task Status â–¾</div>';
    html += '<svg viewBox="0 0 200 200" width="220" height="220" style="display:block;margin:0 auto;">';
    // Build donut segments
    var donutData = [
      { val: taskAccepted, color: '#1a73e8', label: 'Accepted' },
      { val: taskAssignedOnly, color: '#64b5f6', label: 'Assigned' },
      { val: tk.completed, color: '#00ff66', label: 'Completed' },
    ].filter(function(d) { return d.val > 0; });
    var donutTotal = donutData.reduce(function(a, b) { return a + b.val; }, 0) || 1;
    var startAngle = 0;
    var cx = 100, cy = 100, r = 70, strokeW = 30;
    var circumference = 2 * Math.PI * r;
    donutData.forEach(function(seg) {
      var pct = seg.val / donutTotal;
      var dashLen = circumference * pct;
      var dashGap = circumference - dashLen;
      var rotation = startAngle * 360 - 90;
      html += '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="' + seg.color + '" stroke-width="' + strokeW + '" stroke-dasharray="' + dashLen + ' ' + dashGap + '" transform="rotate(' + rotation + ' ' + cx + ' ' + cy + ')" />';
      // Label
      var midAngle = (startAngle + pct / 2) * 2 * Math.PI - Math.PI / 2;
      var lx = cx + (r) * Math.cos(midAngle);
      var ly = cy + (r) * Math.sin(midAngle);
      html += '<text x="' + lx + '" y="' + ly + '" fill="white" font-size="14" font-weight="bold" text-anchor="middle" dominant-baseline="central">' + seg.val + '</text>';
      startAngle += pct;
    });
    html += '</svg>';
    // Legend
    html += '<div style="display:flex;justify-content:center;gap:20px;margin-top:10px;">';
    donutData.forEach(function(seg) {
      html += '<div style="display:flex;align-items:center;gap:5px;"><span style="width:10px;height:10px;border-radius:50%;background:' + seg.color + ';display:inline-block;"></span><span style="color:#c0d8f0;font-size:0.85em;">' + seg.label + '</span></div>';
    });
    html += '</div></div>';

    // Agent Status Donut
    html += '<div class="chart-card">';
    html += '<div class="chart-title">Agent Status â–¾</div>';
    html += '<svg viewBox="0 0 200 200" width="220" height="220" style="display:block;margin:0 auto;">';
    var agentData = [
      { val: tk.agentsBusy, color: '#64b5f6', label: 'Busy' },
      { val: tk.agentsFree, color: '#00c853', label: 'Free' },
      { val: tk.agentsInactive, color: '#9e9e9e', label: 'Inactive' },
    ].filter(function(d) { return d.val > 0; });
    var agentTotal2 = agentData.reduce(function(a, b) { return a + b.val; }, 0) || 1;
    startAngle = 0;
    agentData.forEach(function(seg) {
      var pct = seg.val / agentTotal2;
      var dashLen = circumference * pct;
      var dashGap = circumference - dashLen;
      var rotation = startAngle * 360 - 90;
      html += '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="' + seg.color + '" stroke-width="' + strokeW + '" stroke-dasharray="' + dashLen + ' ' + dashGap + '" transform="rotate(' + rotation + ' ' + cx + ' ' + cy + ')" />';
      var midAngle = (startAngle + pct / 2) * 2 * Math.PI - Math.PI / 2;
      var lx = cx + (r) * Math.cos(midAngle);
      var ly = cy + (r) * Math.sin(midAngle);
      html += '<text x="' + lx + '" y="' + ly + '" fill="white" font-size="14" font-weight="bold" text-anchor="middle" dominant-baseline="central">' + seg.val + '</text>';
      startAngle += pct;
    });
    html += '</svg>';
    html += '<div style="display:flex;justify-content:center;gap:20px;margin-top:10px;">';
    agentData.forEach(function(seg) {
      html += '<div style="display:flex;align-items:center;gap:5px;"><span style="width:10px;height:10px;border-radius:50%;background:' + seg.color + ';display:inline-block;"></span><span style="color:#c0d8f0;font-size:0.85em;">' + seg.label + '</span></div>';
    });
    html += '</div></div>';
    html += '</div>';

    // KPI Cards row
    var changeColor = tk.taskChangeVsYesterday >= 0 ? '#ff4757' : '#00ff66';
    var changeSign = tk.taskChangeVsYesterday >= 0 ? '' : '';
    html += '<div class="kpi-grid">';

    // Total Tasks
    html += '<div class="kpi">';
    html += '<div class="kpi-label">Total Tasks â–¾</div>';
    html += '<div class="kpi-val">' + tk.todayTotal + '</div>';
    html += '<div class="kpi-change" style="color:' + changeColor + ';">' + changeSign + tk.taskChangeVsYesterday + '%</div>';
    html += '<div class="kpi-sub">vs yesterday (' + tk.yesterdayTotal + ')</div>';
    html += '</div>';

    // Task Efficiency
    html += '<div class="kpi">';
    html += '<div class="kpi-label">Task Efficiency â–¾</div>';
    html += '<div class="kpi-val">' + tk.taskEfficiency + '%</div>';
    html += '<div class="kpi-sub">completed / total dispatched</div>';
    html += '</div>';

    // Avg Completion Time
    var avgHrs = Math.floor(tk.avgCompletionMinutes / 60);
    var avgMins = tk.avgCompletionMinutes % 60;
    html += '<div class="kpi">';
    html += '<div class="kpi-label">Avg Completion Time â–¾</div>';
    html += '<div class="kpi-val">' + (avgHrs > 0 ? avgHrs + 'h ' : '') + avgMins + 'm</div>';
    html += '<div class="kpi-sub">pickup to completed</div>';
    html += '</div>';

    // Completion Rate
    var completionRate = tk.totalTasks > 0 ? Math.round((tk.completed / tk.totalTasks) * 10000) / 100 : 0;
    html += '<div class="kpi">';
    html += '<div class="kpi-label">Completion Rate â–¾</div>';
    html += '<div class="kpi-val" style="color:' + (completionRate >= 70 ? '#00ff66' : completionRate >= 40 ? '#ff9f43' : '#ff4757') + ';">' + completionRate + '%</div>';
    html += '<div class="kpi-sub">of all ' + tk.totalTasks + ' tasks (90d)</div>';
    html += '</div>';
    html += '</div>';

    // Weekly trend bar chart
    var weekData = tk.weeklyTasks || [];
    if (weekData.length > 0) {
      var maxDay = Math.max.apply(null, weekData.map(function(d) { return d.count; })) || 1;
      html += '<div class="section">';
      html += '<div class="section-title" style="color:#00d4ff;"><span class="dot" style="background:#00d4ff;box-shadow:0 0 8px #00d4ff;"></span>7-DAY TASK TREND</div>';
      html += '<div class="week-chart">';
      weekData.forEach(function(d) {
        var barH = Math.max(4, Math.round((d.count / maxDay) * 100));
        var isToday = d.date === todayStr;
        var barCol = isToday ? '#ffd700' : '#00d4ff';
        html += '<div class="week-bar">';
        html += '<div class="week-bar-count">' + d.count + '</div>';
        html += '<div class="week-bar-inner" style="height:' + barH + '%;background:' + barCol + (isToday ? '' : '60') + ';"></div>';
        html += '<div class="week-bar-label" style="' + (isToday ? 'color:#ffd700;font-weight:700;' : '') + '">' + d.day + '</div>';
        html += '</div>';
      });
      html += '</div></div>';
    }

    // ====== LIVE MAP ======
    html += '<div class="section">';
    html += '<div class="section-title" style="color:#00d4ff;"><span class="dot" style="background:#00d4ff;box-shadow:0 0 8px #00d4ff;"></span>DISPATCH MAP</div>';
    html += '<div id="dispatch-map" style="height:500px;border:1px solid rgba(0,212,255,0.15);margin-bottom:20px;background:#0a1520;"></div>';
    html += '</div>';

    // Map initialization script (runs after page load)
    var mapTasks = tk.mapTasks || [];
    var todayMapTasks = (tk.todayTasks || []).filter(function(t) { return t.lat && t.lng && t.lat !== 0; });
    var upcomingMapTasks = (tk.upcomingTasks || []).filter(function(t) { return t.lat && t.lng && t.lat !== 0; });
    html += '<script>';
    html += 'document.addEventListener("DOMContentLoaded", function() {';
    html += '  var map = L.map("dispatch-map", { zoomControl: true }).setView([37.5, -96], 4);';
    // Dark map tiles
    html += '  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {';
    html += '    attribution: "CartoDB", subdomains: "abcd", maxZoom: 19';
    html += '  }).addTo(map);';
    // Status color function
    html += '  function statusColor(s) {';
    html += '    s = s.toLowerCase();';
    html += '    if (s.includes("completed")) return "#00ff66";';
    html += '    if (s.includes("acknowledged")) return "#a855f7";';
    html += '    if (s.includes("assigned")) return "#00d4ff";';
    html += '    if (s.includes("started") || s.includes("arrived")) return "#ff9f43";';
    html += '    if (s.includes("failed") || s.includes("cancel")) return "#ff4757";';
    html += '    return "#c0c0c0";';
    html += '  }';
    // Custom circle marker function
    html += '  function addPin(lat, lng, data, isToday) {';
    html += '    var color = statusColor(data.status);';
    html += '    var radius = isToday ? 10 : 6;';
    html += '    var marker = L.circleMarker([lat, lng], {';
    html += '      radius: radius, fillColor: color, color: "#fff", weight: isToday ? 2 : 1,';
    html += '      opacity: isToday ? 1 : 0.6, fillOpacity: isToday ? 0.9 : 0.5';
    html += '    }).addTo(map);';
    html += '    marker.bindPopup(';
    html += '      "<div style=\\"font-family:sans-serif;font-size:13px;\\">" +';
    html += '      "<b style=\\"color:" + color + "\\">" + data.status + "</b><br>" +';
    html += '      "<b>" + data.customer + "</b><br>" +';
    html += '      (data.tech ? "Tech: " + data.tech + "<br>" : "") +';
    html += '      (data.address ? data.address + "<br>" : "") +';
    html += '      "Job #" + data.jobId +';
    html += '      "</div>"';
    html += '    );';
    html += '  }';

    // Plot all historical tasks (smaller dots)
    html += '  var allTasks = ' + JSON.stringify(mapTasks) + ';';
    html += '  allTasks.forEach(function(t) { if (t.lat && t.lng) addPin(t.lat, t.lng, t, false); });';

    // Plot today's tasks (bigger, brighter)
    html += '  var todayTasks = ' + JSON.stringify(todayMapTasks) + ';';
    html += '  todayTasks.forEach(function(t) { if (t.lat && t.lng) addPin(t.lat, t.lng, t, true); });';

    // Plot upcoming tasks (purple dashed outline)
    html += '  var upcomingTasks = ' + JSON.stringify(upcomingMapTasks) + ';';
    html += '  upcomingTasks.forEach(function(t) {';
    html += '    if (t.lat && t.lng) {';
    html += '      var m = L.circleMarker([t.lat, t.lng], {';
    html += '        radius: 8, fillColor: "#a855f7", color: "#a855f7", weight: 2,';
    html += '        opacity: 0.8, fillOpacity: 0.3, dashArray: "4 4"';
    html += '      }).addTo(map);';
    html += '      m.bindPopup("<div style=\\"font-family:sans-serif;font-size:13px;\\"><b style=\\"color:#a855f7\\">UPCOMING " + t.date + "</b><br><b>" + t.customer + "</b><br>" + (t.tech ? "Tech: " + t.tech + "<br>" : "") + t.address + "</div>");';
    html += '    }';
    html += '  });';

    // Auto-fit bounds if we have markers
    html += '  var allPts = todayTasks.concat(allTasks).concat(upcomingTasks).filter(function(t) { return t.lat && t.lng; });';
    html += '  if (allPts.length > 0) {';
    html += '    var bounds = L.latLngBounds(allPts.map(function(t) { return [t.lat, t.lng]; }));';
    html += '    map.fitBounds(bounds, { padding: [40, 40], maxZoom: 12 });';
    html += '  }';

    // Legend
    html += '  var legend = L.control({ position: "bottomright" });';
    html += '  legend.onAdd = function() {';
    html += '    var div = L.DomUtil.create("div", "");';
    html += '    div.style.cssText = "background:rgba(5,13,24,0.9);padding:10px 14px;border:1px solid #00d4ff30;font-size:12px;line-height:1.8;";';
    html += '    div.innerHTML = "<div style=\\"font-family:Orbitron;font-size:9px;letter-spacing:2px;color:#4a6a8a;margin-bottom:4px;\\">STATUS</div>"';
    html += '      + "<div><span style=\\"display:inline-block;width:10px;height:10px;border-radius:50%;background:#00d4ff;margin-right:6px;\\"></span><span style=\\"color:#c0d8f0;\\">Assigned</span></div>"';
    html += '      + "<div><span style=\\"display:inline-block;width:10px;height:10px;border-radius:50%;background:#a855f7;margin-right:6px;\\"></span><span style=\\"color:#c0d8f0;\\">Acknowledged</span></div>"';
    html += '      + "<div><span style=\\"display:inline-block;width:10px;height:10px;border-radius:50%;background:#ff9f43;margin-right:6px;\\"></span><span style=\\"color:#c0d8f0;\\">In Progress</span></div>"';
    html += '      + "<div><span style=\\"display:inline-block;width:10px;height:10px;border-radius:50%;background:#00ff66;margin-right:6px;\\"></span><span style=\\"color:#c0d8f0;\\">Completed</span></div>"';
    html += '      + "<div><span style=\\"display:inline-block;width:10px;height:10px;border-radius:50%;background:#ff4757;margin-right:6px;\\"></span><span style=\\"color:#c0d8f0;\\">Failed</span></div>"';
    html += '      + "<div><span style=\\"display:inline-block;width:10px;height:10px;border-radius:50%;border:2px dashed #a855f7;margin-right:6px;\\"></span><span style=\\"color:#c0d8f0;\\">Upcoming</span></div>";';
    html += '    return div;';
    html += '  };';
    html += '  legend.addTo(map);';
    html += '});';
    html += '<\/script>';

    // Today's jobs
    html += '<div class="section">';
    html += '<div class="section-title" style="color:#ffd700;"><span class="dot" style="background:#ffd700;box-shadow:0 0 8px #ffd700;"></span>TODAY\'S JOBS (' + tk.todayTasks.length + ')</div>';
    if (tk.todayTasks.length > 0) {
      tk.todayTasks.forEach(function(t) {
        var badgeClass = t.status.toLowerCase().includes('completed') ? 'b-completed' : t.status.toLowerCase().includes('assigned') ? 'b-assigned' : t.status.toLowerCase().includes('acknowledged') ? 'b-acknowledged' : t.status.toLowerCase().includes('started') ? 'b-started' : 'b-unassigned';
        html += '<div class="row">';
        html += '<div style="min-width:60px;font-family:Orbitron;font-size:0.7em;color:#4a6a8a;">#' + t.jobId + '</div>';
        html += '<div style="flex:1;color:#c0d8f0;font-weight:600;">' + t.customer + '</div>';
        html += '<div style="flex:1;color:#4a6a8a;font-size:0.85em;">' + t.address + '</div>';
        html += '<div style="min-width:100px;color:#a855f7;">' + (t.tech || 'Unassigned') + '</div>';
        html += '<div class="badge ' + badgeClass + '">' + t.status.toUpperCase() + '</div>';
        html += '</div>';
      });
    } else {
      html += '<div style="color:#4a6a8a;padding:20px;text-align:center;">No tasks scheduled for today</div>';
    }
    html += '</div>';

    // Upcoming jobs (future dates)
    if (tk.upcomingTasks && tk.upcomingTasks.length > 0) {
      // Sort by date
      var upcoming = tk.upcomingTasks.slice().sort(function(a, b) { return a.date < b.date ? -1 : 1; });
      html += '<div class="section">';
      html += '<div class="section-title" style="color:#a855f7;"><span class="dot" style="background:#a855f7;box-shadow:0 0 8px #a855f7;"></span>UPCOMING JOBS (' + upcoming.length + ')</div>';
      // Group by date
      var byDate = {};
      upcoming.forEach(function(t) {
        if (!byDate[t.date]) byDate[t.date] = [];
        byDate[t.date].push(t);
      });
      Object.keys(byDate).sort().forEach(function(dt) {
        var d = new Date(dt + 'T12:00:00');
        var dayLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:3px;color:#a855f7;margin:10px 0 5px;padding:4px 10px;border-left:3px solid #a855f740;">' + dayLabel + ' â€” ' + byDate[dt].length + ' jobs</div>';
        byDate[dt].forEach(function(t) {
          var sColor = t.status.toLowerCase().includes('assigned') ? '#00d4ff' : t.status.toLowerCase().includes('acknowledged') ? '#a855f7' : '#c0c0c0';
          html += '<div class="row">';
          html += '<div style="min-width:50px;font-family:Orbitron;font-size:0.65em;color:#4a6a8a;">#' + t.jobId + '</div>';
          html += '<div style="flex:1;color:#c0d8f0;font-weight:600;">' + t.customer + '</div>';
          html += '<div style="flex:1;color:#4a6a8a;font-size:0.85em;">' + t.address + '</div>';
          html += '<div style="min-width:100px;color:#a855f7;">' + (t.tech || 'Unassigned') + '</div>';
          html += '<div class="badge" style="color:' + sColor + ';border-color:' + sColor + '40;">' + t.status.toUpperCase() + '</div>';
          html += '</div>';
        });
      });
      html += '</div>';
    }

    // Tech performance
    var techEntries = Object.entries(tk.tasksByTech).sort(function(a, b) { return b[1].completed - a[1].completed; });
    html += '<div class="section">';
    html += '<div class="section-title" style="color:#00ff66;"><span class="dot" style="background:#00ff66;box-shadow:0 0 8px #00ff66;"></span>TECH PERFORMANCE (90 DAYS)</div>';
    if (techEntries.length > 0) {
      var maxComp = techEntries[0][1].completed;
      techEntries.forEach(function(t, idx) {
        var barPct = maxComp > 0 ? Math.round(t[1].completed / maxComp * 100) : 0;
        var compRate = t[1].total > 0 ? Math.round(t[1].completed / t[1].total * 100) : 0;
        html += '<div class="row">';
        html += '<div style="min-width:30px;font-family:Orbitron;font-size:0.9em;color:' + (idx === 0 ? '#ffd700' : idx === 1 ? '#c0c0c0' : idx === 2 ? '#cd7f32' : '#4a6a8a') + ';">#' + (idx + 1) + '</div>';
        html += '<div style="min-width:180px;color:#c0d8f0;font-weight:700;">' + t[0] + '</div>';
        html += '<div style="flex:1;height:20px;background:#0a1520;position:relative;min-width:200px;">';
        html += '<div style="height:100%;width:' + barPct + '%;background:linear-gradient(90deg,#00ff66,#55f7d8);"></div>';
        html += '<div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:0.75em;color:#c0d8f0;">' + t[1].completed + ' done / ' + t[1].total + ' total</div>';
        html += '</div>';
        html += '<div style="min-width:60px;text-align:center;font-family:Orbitron;font-size:0.7em;color:' + (compRate >= 70 ? '#00ff66' : compRate >= 40 ? '#ff9f43' : '#ff4757') + ';">' + compRate + '%</div>';
        html += '</div>';
      });
    }
    html += '</div>';

    // Active agents
    if (tk.agents.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-title" style="color:#a855f7;"><span class="dot" style="background:#a855f7;box-shadow:0 0 8px #a855f7;"></span>FIELD AGENTS (' + tk.agents.length + ')</div>';
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:8px;">';
      tk.agents.forEach(function(a) {
        var statusColor = a.status === 'Available' ? '#00ff66' : '#ff4757';
        html += '<div class="row" style="justify-content:space-between;">';
        html += '<div><div style="color:#c0d8f0;font-weight:600;">' + a.name + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.8em;">' + (a.phone || 'No phone') + '</div></div>';
        html += '<div style="display:flex;align-items:center;gap:6px;"><span class="dot" style="background:' + statusColor + ';box-shadow:0 0 6px ' + statusColor + ';"></span><span style="font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:' + statusColor + ';">' + a.status.toUpperCase() + '</span></div>';
        html += '</div>';
      });
      html += '</div></div>';
    }

    // Recent completed
    if (tk.recentCompleted.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-title" style="color:#55f7d8;"><span class="dot" style="background:#55f7d8;box-shadow:0 0 8px #55f7d8;"></span>RECENTLY COMPLETED</div>';
      tk.recentCompleted.slice(0, 10).forEach(function(c) {
        html += '<div class="row">';
        html += '<div style="min-width:60px;font-family:Orbitron;font-size:0.7em;color:#4a6a8a;">#' + c.jobId + '</div>';
        html += '<div style="flex:1;color:#c0d8f0;">' + c.customer + '</div>';
        html += '<div style="color:#a855f7;">' + c.tech + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.8em;">' + c.address + '</div>';
        html += '<div class="badge b-completed">DONE</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Status breakdown
    var statusEntries = Object.entries(tk.tasksByStatus).sort(function(a, b) { return b[1] - a[1]; });
    if (statusEntries.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-title" style="color:#00d4ff;"><span class="dot" style="background:#00d4ff;box-shadow:0 0 8px #00d4ff;"></span>STATUS BREAKDOWN</div>';
      var maxSt = statusEntries[0][1];
      statusEntries.forEach(function(s) {
        var pct = maxSt > 0 ? Math.round(s[1] / maxSt * 100) : 0;
        html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:3px;">';
        html += '<div style="min-width:150px;color:#7a9ab0;font-size:0.85em;">' + s[0] + '</div>';
        html += '<div style="flex:1;height:18px;background:#0a1520;position:relative;">';
        html += '<div style="height:100%;width:' + pct + '%;background:#00d4ff40;border-left:3px solid #00d4ff;"></div>';
        html += '<div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);color:#c0d8f0;font-size:0.7em;font-weight:700;">' + s[1] + '</div>';
        html += '</div></div>';
      });
      html += '</div>';
    }

    html += '<div class="actions">';
    html += '<a class="holo-btn" href="/tookan/json" target="_blank">Raw JSON</a>';
    html += '<a class="holo-btn" href="/tookan/refresh">Force Refresh</a>';
    html += '</div>';

    html += '</div></body></html>';
    res.send(html);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Raw JSON endpoint for Tookan data
/* ===========================
   INTERACTIVE CHARTING â€” Technical Analysis for Call Volume
   /business/chart â€” Full TA charting with Bollinger Bands, MACD, RSI, drawing tools
=========================== */

app.get('/business/chart', requireAuth('owner'), async function(req, res) {
  try {
    await buildBusinessContext();
    var bm = global.bizMetrics || {};
    var monthlyCalls2 = bm.monthlyCalls || {};

    // Build data series for all locations + aggregate
    var allSeries = {};
    allSeries['ALL LOCATIONS'] = monthlyCalls2;
    var callsByCity = bm.monthlyCallsByCity || {};
    Object.keys(callsByCity).sort().forEach(function(city) {
      // Only include cities with at least 3 months of data and real names
      if (Object.keys(callsByCity[city]).length >= 3 && city.length > 2) {
        allSeries[city] = callsByCity[city];
      }
    });

    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>ATHENA â€” Call Volume Technical Analysis</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">';
    html += '<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"><\/script>';
    html += '<style>';
    html += 'body{margin:0;background:#050d18;color:#c0d8f0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;}';
    html += '.wrap{max-width:1500px;margin:0 auto;padding:20px 30px;}';
    html += '.toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:15px;padding:10px;background:rgba(10,20,35,0.8);border:1px solid #1a2a3a;}';
    html += '.toolbar select,.toolbar button{font-family:Orbitron;font-size:0.55em;letter-spacing:2px;padding:8px 14px;background:#0a1520;color:#c0d8f0;border:1px solid #1a2a3a;cursor:pointer;outline:none;}';
    html += '.toolbar select:hover,.toolbar button:hover{border-color:#00d4ff40;}';
    html += '.toolbar button.active{background:rgba(0,212,255,0.15);border-color:#00d4ff;color:#00d4ff;}';
    html += '.toolbar .sep{width:1px;height:20px;background:#1a2a3a;}';
    html += '.toolbar label{font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:#4a6a8a;}';
    html += '#main-chart{border:1px solid #1a2a3a;margin-bottom:5px;}';
    html += '#rsi-chart{border:1px solid #1a2a3a;margin-bottom:5px;}';
    html += '#macd-chart{border:1px solid #1a2a3a;margin-bottom:10px;}';
    html += '.indicator-label{font-family:Orbitron;font-size:0.45em;letter-spacing:2px;color:#4a6a8a;padding:4px 10px;background:rgba(10,20,35,0.8);display:inline-block;margin-bottom:2px;}';
    html += '.tab-nav{display:flex;gap:0;margin-bottom:15px;}';
    html += '.tab-nav a{font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);}';
    html += '.tab-nav a.active{color:#a855f7;border-color:#a855f740;background:rgba(168,85,247,0.1);}';
    html += '.legend{display:flex;gap:15px;flex-wrap:wrap;padding:8px 10px;font-size:0.75em;}';
    html += '.legend-item{display:flex;align-items:center;gap:5px;color:#4a6a8a;}';
    html += '.legend-dot{width:10px;height:3px;display:inline-block;}';
    // Mobile responsive
    html += '@media(max-width:768px){';
    html += '.wrap{padding:10px 12px!important;}';
    html += '.toolbar{flex-wrap:wrap!important;gap:6px!important;padding:8px!important;}';
    html += '.toolbar select,.toolbar button{font-size:0.5em!important;padding:6px 8px!important;}';
    html += '.tab-nav{flex-wrap:wrap!important;}';
    html += '.tab-nav a{padding:8px 15px!important;font-size:0.55em!important;}';
    html += '#main-chart{height:300px!important;}';
    html += '#rsi-chart{height:80px!important;}';
    html += '#macd-chart{height:80px!important;}';
    html += '}';
    html += '</style></head><body><div class="wrap">';

    // Tab nav
    html += '<div class="tab-nav">';
    html += '<a href="/dashboard">JARVIS</a>';
    html += '<a href="/business">ATHENA</a>';
    html += '<a href="/tookan">TOOKAN</a>';
    html += '<a href="/business/chart" class="active">CHARTS</a>';
    html += '<a href="/analytics" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">ANALYTICS</a>';
    html += '<a href="/ads" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">GOOGLE ADS</a>';
    html += '<a href="/square" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">SQUARE</a><a href="/discord" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">DISCORD</a><a href="/followup" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">FOLLOW UP</a><a href="/ai" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AI</a><a href="/forecast" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">FORECAST</a><a href="/seo" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">SEO</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AUDIT</a><a href="/auth/logout" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#ef4444;border:1px solid #ef444440;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">LOGOUT</a>';
    html += '</div>';

    html += '<div style="font-family:Orbitron;font-size:1.1em;letter-spacing:6px;color:#00d4ff;margin-bottom:5px;">CALL VOLUME â€” TECHNICAL ANALYSIS</div>';
    html += '<div style="font-family:Orbitron;font-size:0.5em;letter-spacing:3px;color:#4a6a8a;margin-bottom:15px;">FIBONACCI â€¢ BOLLINGER BANDS â€¢ MACD â€¢ RSI â€¢ DRAWING TOOLS</div>';

    // Toolbar
    html += '<div class="toolbar">';
    html += '<label>MARKET</label>';
    html += '<select id="market-select" onchange="updateAll()">';
    var sortedMarkets = Object.keys(allSeries).sort(function(a, b) {
      if (a === 'ALL LOCATIONS') return -1;
      if (b === 'ALL LOCATIONS') return 1;
      if (a === 'SQUARE REVENUE ($)') return -1;
      if (b === 'SQUARE REVENUE ($)') return 1;
      return a.localeCompare(b);
    });
    sortedMarkets.forEach(function(name) {
      var dataCount = Object.keys(allSeries[name]).length;
      if (dataCount < 2) return; // skip markets with too little data
      html += '<option value="' + name.replace(/"/g, '&quot;') + '"' + (name === 'ALL LOCATIONS' ? ' selected' : '') + '>' + name + ' (' + dataCount + 'mo)</option>';
    });
    html += '</select>';
    html += '<div class="sep"></div>';
    html += '<label>OVERLAYS</label>';
    html += '<button id="btn-bb" onclick="toggleBB()" title="Bollinger Bands">BB</button>';
    html += '<button id="btn-sma20" onclick="toggleSMA(20)" title="20-period SMA">SMA20</button>';
    html += '<button id="btn-sma50" onclick="toggleSMA(50)" title="50-period SMA">SMA50</button>';
    html += '<button id="btn-ema12" onclick="toggleEMA()" title="12-period EMA">EMA12</button>';
    html += '<button id="btn-fib" onclick="toggleFib()" title="Fibonacci Levels">FIB</button>';
    html += '<div class="sep"></div>';
    html += '<label>DRAW</label>';
    html += '<button id="btn-trendline" onclick="setDrawMode(\'trendline\')">TRENDLINE</button>';
    html += '<button id="btn-hline" onclick="setDrawMode(\'hline\')">H-LINE</button>';
    html += '<button id="btn-clear" onclick="clearDrawings()">CLEAR</button>';
    html += '<div class="sep"></div>';
    html += '<label>BB PERIOD</label>';
    html += '<select id="bb-period" onchange="updateAll()"><option value="10">10</option><option value="15">15</option><option value="20" selected>20</option></select>';
    html += '<label>BB STD</label>';
    html += '<select id="bb-std" onchange="updateAll()"><option value="1.5">1.5</option><option value="2" selected>2.0</option><option value="2.5">2.5</option></select>';
    html += '</div>';

    // Chart containers
    html += '<div id="main-chart" style="width:100%;height:400px;"></div>';
    html += '<div class="legend" id="main-legend"></div>';
    html += '<div class="indicator-label">RSI (14) <span style="font-size:0.8em;color:#4a6a8a;font-family:Rajdhani,sans-serif;letter-spacing:0;">â€” Above 70 = overbought (unusually high call volume, expect slowdown). Below 30 = oversold (unusually low, expect rebound). 40-60 = neutral.</span></div>';
    html += '<div id="rsi-chart" style="width:100%;height:120px;"></div>';
    html += '<div class="indicator-label">MACD (12, 26, 9) <span style="font-size:0.8em;color:#4a6a8a;font-family:Rajdhani,sans-serif;letter-spacing:0;">â€” MACD crossing above Signal = momentum turning positive (growth accelerating). Below = slowing. Green histogram = bullish momentum. Red = bearish.</span></div>';
    html += '<div id="macd-chart" style="width:100%;height:120px;"></div>';
    html += '<div class="indicator-label">BOLLINGER BAND WIDTH (Squeeze Detector) <span style="font-size:0.8em;color:#4a6a8a;font-family:Rajdhani,sans-serif;letter-spacing:0;">â€” Low width = call volume stabilizing (squeeze). Width expanding = breakout incoming â€” big move up or down likely.</span></div>';
    html += '<div id="bbw-chart" style="width:100%;height:100px;"></div>';

    // Add Square revenue data to chart series
    try {
      var sqSnap = await squareFullSnapshot(false);
      var sqA = squareAnalyze(sqSnap);
      if (sqA && sqA.trends && sqA.trends.monthlyRevenue) {
        allSeries['SQUARE REVENUE ($)'] = sqA.trends.monthlyRevenue;
        // Per-location revenue
        var locRevenue = {};
        (sqSnap.orders || []).forEach(function(o) {
          if (o.state !== 'COMPLETED') return;
          var locId = o.location_id || 'unknown';
          var month = (o.created_at || '').substring(0, 7);
          if (!month) return;
          var amt = o.total_money && o.total_money.amount ? o.total_money.amount / 100 : 0;
          if (amt <= 0) return;
          if (!locRevenue[locId]) locRevenue[locId] = {};
          locRevenue[locId][month] = (locRevenue[locId][month] || 0) + amt;
        });
        var locMap = {};
        (sqSnap.locations || []).forEach(function(l) { locMap[l.id] = l.address && l.address.locality ? l.address.locality + ' ' + (l.address.administrative_district_level_1 || '') : l.name || l.id; });
        Object.keys(locRevenue).forEach(function(lid) {
          if (Object.keys(locRevenue[lid]).length >= 3) {
            allSeries['SQ: ' + (locMap[lid] || lid)] = locRevenue[lid];
          }
        });
      }
    } catch(e) { console.log('Charts Square data error:', e.message); }

    // Inject data & charting logic
    html += '<script>';
    html += 'var allData = ' + JSON.stringify(allSeries) + ';';

    // TA calculation functions
    html += 'function sma(data, period) {';
    html += '  var result = [];';
    html += '  for (var i = 0; i < data.length; i++) {';
    html += '    if (i < period - 1) { result.push(null); continue; }';
    html += '    var sum = 0; for (var j = 0; j < period; j++) sum += data[i - j].value;';
    html += '    result.push({ time: data[i].time, value: Math.round(sum / period * 100) / 100 });';
    html += '  } return result.filter(function(d) { return d !== null; });';
    html += '}';

    html += 'function ema(data, period) {';
    html += '  var result = []; var k = 2 / (period + 1); var prev = data[0].value;';
    html += '  result.push({ time: data[0].time, value: prev });';
    html += '  for (var i = 1; i < data.length; i++) {';
    html += '    prev = data[i].value * k + prev * (1 - k);';
    html += '    result.push({ time: data[i].time, value: Math.round(prev * 100) / 100 });';
    html += '  } return result;';
    html += '}';

    html += 'function bollingerBands(data, period, stdDev) {';
    html += '  var upper = [], lower = [], middle = [], width = [];';
    html += '  for (var i = 0; i < data.length; i++) {';
    html += '    if (i < period - 1) continue;';
    html += '    var sum = 0; for (var j = 0; j < period; j++) sum += data[i - j].value;';
    html += '    var avg = sum / period;';
    html += '    var sqSum = 0; for (var j = 0; j < period; j++) sqSum += Math.pow(data[i - j].value - avg, 2);';
    html += '    var std = Math.sqrt(sqSum / period);';
    html += '    var u = avg + stdDev * std, l = avg - stdDev * std;';
    html += '    upper.push({ time: data[i].time, value: Math.round(u * 100) / 100 });';
    html += '    lower.push({ time: data[i].time, value: Math.round(Math.max(l, 0) * 100) / 100 });';
    html += '    middle.push({ time: data[i].time, value: Math.round(avg * 100) / 100 });';
    html += '    width.push({ time: data[i].time, value: avg > 0 ? Math.round((u - l) / avg * 10000) / 100 : 0 });';
    html += '  } return { upper: upper, lower: lower, middle: middle, width: width };';
    html += '}';

    html += 'function calcRSI(data, period) {';
    html += '  var result = []; var gains = 0, losses = 0;';
    html += '  for (var i = 1; i < data.length; i++) {';
    html += '    var diff = data[i].value - data[i-1].value;';
    html += '    if (i <= period) { if (diff > 0) gains += diff; else losses -= diff; }';
    html += '    if (i === period) { gains /= period; losses /= period; }';
    html += '    if (i > period) {';
    html += '      if (diff > 0) { gains = (gains * (period-1) + diff) / period; losses = (losses * (period-1)) / period; }';
    html += '      else { gains = (gains * (period-1)) / period; losses = (losses * (period-1) - diff) / period; }';
    html += '    }';
    html += '    if (i >= period) {';
    html += '      var rs = losses === 0 ? 100 : gains / losses;';
    html += '      result.push({ time: data[i].time, value: Math.round((100 - 100 / (1 + rs)) * 100) / 100 });';
    html += '    }';
    html += '  } return result;';
    html += '}';

    html += 'function calcMACD(data) {';
    html += '  var ema12 = ema(data, 12), ema26 = ema(data, 26);';
    html += '  var macdLine = [], signal = [], histogram = [];';
    html += '  for (var i = 0; i < ema26.length; i++) {';
    html += '    var e12 = ema12.find(function(d) { return d.time === ema26[i].time; });';
    html += '    if (e12) macdLine.push({ time: ema26[i].time, value: Math.round((e12.value - ema26[i].value) * 100) / 100 });';
    html += '  }';
    html += '  if (macdLine.length > 0) { signal = ema(macdLine, 9); }';
    html += '  for (var i = 0; i < signal.length; i++) {';
    html += '    var ml = macdLine.find(function(d) { return d.time === signal[i].time; });';
    html += '    if (ml) histogram.push({ time: signal[i].time, value: Math.round((ml.value - signal[i].value) * 100) / 100, color: ml.value >= signal[i].value ? "#26a69a" : "#ef5350" });';
    html += '  }';
    html += '  return { macdLine: macdLine, signal: signal, histogram: histogram };';
    html += '}';

    // Chart setup
    html += 'var mainChart, rsiChart, macdChart, bbwChart;';
    html += 'var mainSeries, bbUpperSeries, bbLowerSeries, bbMiddleSeries;';
    html += 'var sma20Series, sma50Series, ema12Series;';
    html += 'var rsiSeries, macdLineSeries, macdSignalSeries, macdHistSeries, bbwSeries;';
    html += 'var fibLines = [];';
    html += 'var showBB = false, showSMA20 = false, showSMA50 = false, showEMA12 = false, showFib = false;';
    html += 'var drawMode = null, drawStart = null, drawings = [];';

    html += 'function createCharts() {';
    html += '  var w = document.getElementById("main-chart").offsetWidth;';
    html += '  var opts = { width: w, layout: { background: { color: "#050d18" }, textColor: "#4a6a8a", fontSize: 11 }, grid: { vertLines: { color: "#0a1520" }, horzLines: { color: "#0a1520" } }, crosshair: { mode: 0 }, timeScale: { borderColor: "#1a2a3a", timeVisible: false } };';

    html += '  mainChart = LightweightCharts.createChart(document.getElementById("main-chart"), Object.assign({}, opts, { height: 400 }));';
    html += '  mainSeries = mainChart.addLineSeries({ color: "#00d4ff", lineWidth: 2, title: "Calls" });';
    html += '  bbUpperSeries = mainChart.addLineSeries({ color: "#ff9f4380", lineWidth: 1, lineStyle: 2, title: "BB Upper" });';
    html += '  bbLowerSeries = mainChart.addLineSeries({ color: "#ff9f4380", lineWidth: 1, lineStyle: 2, title: "BB Lower" });';
    html += '  bbMiddleSeries = mainChart.addLineSeries({ color: "#ff9f4340", lineWidth: 1, lineStyle: 1, title: "BB Mid" });';
    html += '  sma20Series = mainChart.addLineSeries({ color: "#a855f7", lineWidth: 1, title: "SMA 20" });';
    html += '  sma50Series = mainChart.addLineSeries({ color: "#00ff66", lineWidth: 1, title: "SMA 50" });';
    html += '  ema12Series = mainChart.addLineSeries({ color: "#ffd700", lineWidth: 1, title: "EMA 12" });';

    html += '  rsiChart = LightweightCharts.createChart(document.getElementById("rsi-chart"), Object.assign({}, opts, { height: 120 }));';
    html += '  rsiSeries = rsiChart.addLineSeries({ color: "#a855f7", lineWidth: 1.5, title: "RSI" });';

    html += '  macdChart = LightweightCharts.createChart(document.getElementById("macd-chart"), Object.assign({}, opts, { height: 120 }));';
    html += '  macdLineSeries = macdChart.addLineSeries({ color: "#00d4ff", lineWidth: 1.5, title: "MACD" });';
    html += '  macdSignalSeries = macdChart.addLineSeries({ color: "#ff9f43", lineWidth: 1, title: "Signal" });';
    html += '  macdHistSeries = macdChart.addHistogramSeries({ title: "Histogram" });';

    html += '  bbwChart = LightweightCharts.createChart(document.getElementById("bbw-chart"), Object.assign({}, opts, { height: 100 }));';
    html += '  bbwSeries = bbwChart.addHistogramSeries({ color: "#00d4ff40", title: "BB Width" });';

    // Sync crosshairs
    html += '  function syncCrosshair(src, targets) {';
    html += '    src.subscribeCrosshairMove(function(param) {';
    html += '      targets.forEach(function(t) { if (param.time) t.timeScale().scrollToPosition(src.timeScale().scrollPosition(), false); });';
    html += '    });';
    html += '  }';
    html += '  syncCrosshair(mainChart, [rsiChart, macdChart, bbwChart]);';

    // Drawing on main chart
    html += '  mainChart.subscribeClick(function(param) {';
    html += '    if (!drawMode || !param.time) return;';
    html += '    var price = mainSeries.coordinateToPrice(param.point.y);';
    html += '    if (drawMode === "hline") {';
    html += '      var line = mainSeries.createPriceLine({ price: price, color: "#ffd700", lineWidth: 1, lineStyle: 2, axisLabelVisible: true, title: Math.round(price) + "" });';
    html += '      drawings.push(line);';
    html += '      setDrawMode(null);';
    html += '    } else if (drawMode === "trendline") {';
    html += '      if (!drawStart) { drawStart = { time: param.time, price: price }; }';
    html += '      else {';
    html += '        var markers = [{ time: drawStart.time, position: "belowBar", color: "#ffd700", shape: "circle" }, { time: param.time, position: "belowBar", color: "#ffd700", shape: "circle" }];';
    html += '        mainSeries.setMarkers(markers);';
    html += '        drawStart = null; setDrawMode(null);';
    html += '      }';
    html += '    }';
    html += '  });';
    html += '}';

    // Update all indicators
    html += 'function updateAll() { try {';
    html += '  var market = document.getElementById("market-select").value;';
    html += '  var raw = allData[market] || {};';
    html += '  var months = Object.keys(raw).sort();';
    html += '  var data = months.map(function(k) { return { time: k + "-01", value: raw[k] }; });';
    html += '  if (data.length < 2) { document.getElementById("main-legend").innerHTML="<span style=\\"color:#f59e0b;\\">Not enough data for "+market+" ("+data.length+" months). Select a different market.</span>"; return; }';

    html += '  mainSeries.setData(data);';

    // Bollinger Bands
    html += '  var bbP = parseInt(document.getElementById("bb-period").value);';
    html += '  var bbS = parseFloat(document.getElementById("bb-std").value);';
    html += '  var bb = bollingerBands(data, bbP, bbS);';
    html += '  if (showBB) { bbUpperSeries.setData(bb.upper); bbLowerSeries.setData(bb.lower); bbMiddleSeries.setData(bb.middle); }';
    html += '  else { bbUpperSeries.setData([]); bbLowerSeries.setData([]); bbMiddleSeries.setData([]); }';

    // SMAs
    html += '  sma20Series.setData(showSMA20 ? sma(data, 20) : []);';
    html += '  sma50Series.setData(showSMA50 ? sma(data, 50) : []);';
    html += '  ema12Series.setData(showEMA12 ? ema(data, 12) : []);';

    // RSI
    html += '  rsiSeries.setData(calcRSI(data, 14));';

    // MACD
    html += '  var m = calcMACD(data);';
    html += '  macdLineSeries.setData(m.macdLine);';
    html += '  macdSignalSeries.setData(m.signal);';
    html += '  macdHistSeries.setData(m.histogram);';

    // BB Width (squeeze detector)
    html += '  var bbw = bb.width.map(function(d) {';
    html += '    var isSqueeze = d.value < 15;';
    html += '    return { time: d.time, value: d.value, color: isSqueeze ? "#ff475780" : "#00d4ff40" };';
    html += '  });';
    html += '  bbwSeries.setData(bbw);';

    // Fibonacci lines
    html += '  fibLines.forEach(function(l) { try { mainChart.removePriceLine ? mainSeries.removePriceLine(l) : null; } catch(e) {} });';
    html += '  fibLines = [];';
    html += '  if (showFib && data.length >= 3) {';
    html += '    var vals = data.map(function(d) { return d.value; });';
    html += '    var hi = Math.max.apply(null, vals.slice(-6));';
    html += '    var lo = Math.min.apply(null, vals.slice(-6));';
    html += '    var range = hi - lo;';
    html += '    [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0].forEach(function(lvl) {';
    html += '      var price = lo + range * lvl;';
    html += '      var line = mainSeries.createPriceLine({ price: price, color: "#00ff6640", lineWidth: 1, lineStyle: 2, axisLabelVisible: true, title: (lvl * 100).toFixed(1) + "%" });';
    html += '      fibLines.push(line);';
    html += '    });';
    html += '  }';

    // Legend
    html += '  var leg = "";';
    html += '  if (showBB) leg += "<div class=\\"legend-item\\"><span class=\\"legend-dot\\" style=\\"background:#ff9f43;\\"></span>Bollinger Bands</div>";';
    html += '  if (showSMA20) leg += "<div class=\\"legend-item\\"><span class=\\"legend-dot\\" style=\\"background:#a855f7;\\"></span>SMA 20</div>";';
    html += '  if (showSMA50) leg += "<div class=\\"legend-item\\"><span class=\\"legend-dot\\" style=\\"background:#00ff66;\\"></span>SMA 50</div>";';
    html += '  if (showEMA12) leg += "<div class=\\"legend-item\\"><span class=\\"legend-dot\\" style=\\"background:#ffd700;\\"></span>EMA 12</div>";';
    html += '  if (showFib) leg += "<div class=\\"legend-item\\"><span class=\\"legend-dot\\" style=\\"background:#00ff66;\\"></span>Fibonacci</div>";';
    html += '  document.getElementById("main-legend").innerHTML = leg;';

    html += '  mainChart.timeScale().fitContent();';
    html += '  rsiChart.timeScale().fitContent();';
    html += '  macdChart.timeScale().fitContent();';
    html += '  bbwChart.timeScale().fitContent();';
    html += '} catch(e) { console.error("updateAll error:", e); } }';

    // Toggle functions
    html += 'function toggleBB() { showBB = !showBB; document.getElementById("btn-bb").classList.toggle("active"); updateAll(); }';
    html += 'function toggleSMA(p) { if (p===20) { showSMA20=!showSMA20; document.getElementById("btn-sma20").classList.toggle("active"); } else { showSMA50=!showSMA50; document.getElementById("btn-sma50").classList.toggle("active"); } updateAll(); }';
    html += 'function toggleEMA() { showEMA12=!showEMA12; document.getElementById("btn-ema12").classList.toggle("active"); updateAll(); }';
    html += 'function toggleFib() { showFib=!showFib; document.getElementById("btn-fib").classList.toggle("active"); updateAll(); }';
    html += 'function setDrawMode(mode) { drawMode = mode; drawStart = null; document.getElementById("btn-trendline").classList.toggle("active", mode==="trendline"); document.getElementById("btn-hline").classList.toggle("active", mode==="hline"); document.body.style.cursor = mode ? "crosshair" : "default"; }';
    html += 'function clearDrawings() { drawings.forEach(function(d) { try { mainSeries.removePriceLine(d); } catch(e) {} }); drawings = []; mainSeries.setMarkers([]); }';

    // Market change
    // Market change handled by onchange attr on select

    // Init
    html += 'try { createCharts(); updateAll(); } catch(e) { console.error("Chart init error:", e); document.getElementById("main-chart").innerHTML="<div style=\\"color:#ef4444;padding:20px;\\">Chart Error: "+e.message+"</div>"; }';

    // Resize
    html += 'window.addEventListener("resize", function() {';
    html += '  var w = document.getElementById("main-chart").parentElement.offsetWidth - 60;';
    html += '  mainChart.applyOptions({ width: w }); rsiChart.applyOptions({ width: w }); macdChart.applyOptions({ width: w }); bbwChart.applyOptions({ width: w });';
    html += '});';

    html += '<\/script>';
    html += '</div></body></html>';
    res.send(html);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


// ===========================
// PREDICTIVE ANALYTICS ENGINE v2.0 â€” /analytics
// Revenue forecasting, equipment Fibonacci, seasonal demand prediction,
// growth trajectories, city-level forecasting, tech productivity,
// cancellation analysis, market penetration, profitability projections,
// interactive LightweightCharts, correlation analysis, AI strategy engine
// ===========================

app.get('/analytics', requireAuth('owner'), async function(req, res) {
  try {
    await buildBusinessContext();
    var bm = global.bizMetrics || {};
    var pm = global.profitMetrics || {};
    var fh = (pm || {}).financialHistory || {};
    var monthlyCalls = bm.monthlyCalls || {};
    var callsByCity = bm.monthlyCallsByCity || {};
    var callsByTab = bm.monthlyCallsByTab || {};
    var seasonalData = bm.seasonalData || {};
    var locationStats = bm.locationStats || {};
    var equipStats = bm.equipStats || {};
    var brandStats = bm.brandStats || {};
    var techStats = bm.techStats || {};
    var dailyRevenue = pm.dailyRevenue || [];
    var dailyProfit = pm.dailyProfit || [];
    var dailyAds = pm.dailyAds || [];

    // Fetch Square data for accurate revenue
    var sqSnap, sqAnalysis;
    try { sqSnap = await squareFullSnapshot(false); sqAnalysis = squareAnalyze(sqSnap); } catch(e) { sqSnap = {}; sqAnalysis = null; }
    var sqMonthlyRev = sqAnalysis ? sqAnalysis.trends.monthlyRevenue : {};

    // ========== ANALYTICS ENGINE: Compute all predictions ==========
    var monthKeys = Object.keys(monthlyCalls).sort();
    var monthVals = monthKeys.map(function(k) { return monthlyCalls[k] || 0; });
    var today = new Date();
    var curMonth = today.getMonth();
    var curYear = today.getFullYear();
    var monthLabels3 = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    // --- Helper: Linear Regression ---
    function linearRegression(values) {
      var n = values.length;
      if (n < 2) return { slope: 0, intercept: values[0] || 0, r2: 0 };
      var sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
      for (var i = 0; i < n; i++) { sumX += i; sumY += values[i]; sumXY += i * values[i]; sumXX += i * i; }
      var denom = (n * sumXX - sumX * sumX);
      var slope = denom !== 0 ? (n * sumXY - sumX * sumY) / denom : 0;
      var intercept = (sumY - slope * sumX) / n;
      var ssRes = 0, ssTot = 0, mean = sumY / n;
      for (var j = 0; j < n; j++) { var pred = intercept + slope * j; ssRes += (values[j] - pred) * (values[j] - pred); ssTot += (values[j] - mean) * (values[j] - mean); }
      var r2 = ssTot > 0 ? Math.round((1 - ssRes / ssTot) * 1000) / 1000 : 0;
      return { slope: Math.round(slope * 100) / 100, intercept: Math.round(intercept * 100) / 100, r2: r2 };
    }

    // --- Helper: Exponential Moving Average ---
    function emaCalc(values, period) {
      if (values.length === 0) return [];
      var k = 2 / (period + 1); var result = [values[0]];
      for (var i = 1; i < values.length; i++) { result.push(values[i] * k + result[i - 1] * (1 - k)); }
      return result;
    }

    // --- Helper: Fibonacci levels ---
    function calcFib(values) {
      var recent = values.slice(-12);
      var high = Math.max.apply(null, recent.length > 0 ? recent : [0]);
      var low = Math.min.apply(null, recent.length > 0 ? recent : [0]);
      var range = high - low;
      return {
        high: high, low: low, range: range,
        '23.6': Math.round(low + range * 0.236), '38.2': Math.round(low + range * 0.382),
        '50.0': Math.round(low + range * 0.5), '61.8': Math.round(low + range * 0.618),
        '78.6': Math.round(low + range * 0.786), current: recent.length > 0 ? recent[recent.length - 1] : 0,
      };
    }

    // --- Helper: Fibonacci with extensions ---
    function calcFibExtended(values) {
      var fib = calcFib(values);
      fib['127.2'] = Math.round(fib.low + fib.range * 1.272);
      fib['161.8'] = Math.round(fib.low + fib.range * 1.618);
      fib['200.0'] = Math.round(fib.low + fib.range * 2.0);
      fib['261.8'] = Math.round(fib.low + fib.range * 2.618);
      return fib;
    }

    // --- Helper: Growth metrics ---
    function growthMetrics(values) {
      if (values.length < 2) return { mom: 0, qoq: 0, yoy: 0, cagr: 0, trend: 'flat', last: 0, prev: 0 };
      var last = values[values.length - 1], prev = values[values.length - 2];
      var mom = prev > 0 ? Math.round(((last - prev) / prev) * 1000) / 10 : 0;
      var q1 = 0, q2 = 0;
      if (values.length >= 6) { for (var i = values.length - 3; i < values.length; i++) q1 += values[i]; for (var j = values.length - 6; j < values.length - 3; j++) q2 += values[j]; }
      var qoq = q2 > 0 ? Math.round(((q1 - q2) / q2) * 1000) / 10 : 0;
      var yoy = 0;
      if (values.length >= 12) { var thisY = values.slice(-6).reduce(function(a,b){return a+b;},0); var lastY = values.slice(-12,-6).reduce(function(a,b){return a+b;},0); yoy = lastY > 0 ? Math.round(((thisY-lastY)/lastY)*1000)/10 : 0; }
      var first = values[0] > 0 ? values[0] : 1; var periods = values.length - 1;
      var cagr = periods > 0 ? Math.round((Math.pow(last / first, 1 / periods) - 1) * 1000) / 10 : 0;
      var trend = mom > 5 ? 'growing' : mom < -5 ? 'declining' : 'stable';
      return { mom: mom, qoq: qoq, yoy: yoy, cagr: cagr, trend: trend, last: last, prev: prev };
    }

    // --- Helper: Forecast ---
    function forecast(values, months) {
      var lr = linearRegression(values); var n = values.length;
      var emaVals = emaCalc(values, 6); var lastEma = emaVals.length > 0 ? emaVals[emaVals.length - 1] : 0;
      var preds = [];
      for (var i = 0; i < months; i++) {
        var lrPred = Math.round(lr.intercept + lr.slope * (n + i));
        var emaPred = Math.round(lastEma + lr.slope * (i + 1));
        var avg = Math.round((lrPred + emaPred) / 2);
        var confidence = Math.max(0.3, 1 - (i * 0.1));
        var stdDev = values.length > 3 ? Math.sqrt(values.slice(-6).reduce(function(s, v) { var m = lastEma; return s + (v-m)*(v-m); }, 0) / Math.min(6, values.length)) : avg * 0.15;
        preds.push({ month: i + 1, linear: Math.max(0, lrPred), ema: Math.max(0, emaPred), blended: Math.max(0, avg), confidence: confidence, upper: Math.max(0, Math.round(avg + stdDev * 1.5)), lower: Math.max(0, Math.round(avg - stdDev * 1.5)) });
      }
      return preds;
    }

    // --- Helper: Bollinger Bands ---
    function bollingerBands(values, period, stdMult) {
      var upper = [], lower = [], middle = [], width = [];
      for (var i = 0; i < values.length; i++) {
        if (i < period - 1) continue;
        var sum = 0; for (var j = 0; j < period; j++) sum += values[i - j];
        var avg = sum / period;
        var sqSum = 0; for (var j2 = 0; j2 < period; j2++) sqSum += Math.pow(values[i - j2] - avg, 2);
        var std = Math.sqrt(sqSum / period);
        upper.push(Math.round(avg + stdMult * std));
        lower.push(Math.round(Math.max(0, avg - stdMult * std)));
        middle.push(Math.round(avg));
        width.push(avg > 0 ? Math.round((2 * stdMult * std) / avg * 10000) / 100 : 0);
      }
      return { upper: upper, lower: lower, middle: middle, width: width };
    }

    // --- Helper: RSI ---
    function calcRSI(values, period) {
      var result = []; var gains = 0, losses = 0;
      for (var i = 1; i < values.length; i++) {
        var diff = values[i] - values[i-1];
        if (i <= period) { if (diff > 0) gains += diff; else losses -= diff; }
        if (i === period) { gains /= period; losses /= period; }
        if (i > period) { if (diff > 0) { gains = (gains*(period-1)+diff)/period; losses = (losses*(period-1))/period; } else { gains = (gains*(period-1))/period; losses = (losses*(period-1)-diff)/period; } }
        if (i >= period) { var rs = losses === 0 ? 100 : gains / losses; result.push(Math.round((100 - 100/(1+rs))*100)/100); }
      }
      return result;
    }

    // --- Helper: MACD ---
    function calcMACD(values) {
      var ema12 = emaCalc(values, 12), ema26 = emaCalc(values, 26);
      var macdLine = []; for (var i = 0; i < ema26.length; i++) macdLine.push(Math.round((ema12[i] - ema26[i])*100)/100);
      var signal = emaCalc(macdLine, 9);
      var histogram = signal.map(function(s, i) { return Math.round((macdLine[i] - s)*100)/100; });
      return { macdLine: macdLine, signal: signal, histogram: histogram };
    }

    // --- Helper: Volatility ---
    function calcVolatility(values) {
      if (values.length < 3) return 0;
      var returns = [];
      for (var i = 1; i < values.length; i++) { if (values[i-1] > 0) returns.push((values[i] - values[i-1]) / values[i-1]); }
      if (returns.length === 0) return 0;
      var mean = returns.reduce(function(a,b){return a+b;},0) / returns.length;
      var variance = returns.reduce(function(s,r) { return s + (r-mean)*(r-mean); }, 0) / returns.length;
      return Math.round(Math.sqrt(variance) * 10000) / 100;
    }

    // --- Helper: Trend Strength (ADX-like) ---
    function trendStrength(values) {
      if (values.length < 5) return { strength: 0, direction: 'flat' };
      var ups = 0, downs = 0;
      for (var i = 1; i < values.length; i++) { if (values[i] > values[i-1]) ups++; else if (values[i] < values[i-1]) downs++; }
      var total = values.length - 1;
      var dirStrength = Math.abs(ups - downs) / total;
      var lr = linearRegression(values);
      var combined = Math.round((dirStrength * 50 + Math.min(lr.r2, 1) * 50) * 10) / 10;
      var direction = lr.slope > 0 ? 'bullish' : lr.slope < 0 ? 'bearish' : 'flat';
      return { strength: combined, direction: direction, consistency: Math.round(Math.max(ups, downs) / total * 100) };
    }

    // ========== COMPUTE ALL ANALYTICS ==========

    // 1. Call Volume
    var callFib = calcFibExtended(monthVals);
    var callGrowth = growthMetrics(monthVals);
    var callLR = linearRegression(monthVals);
    var callForecast = forecast(monthVals, 6);
    var callBB = bollingerBands(monthVals, Math.min(6, monthVals.length), 2);
    var callRSI = calcRSI(monthVals, Math.min(6, monthVals.length));
    var callMACD = calcMACD(monthVals);
    var callVol = calcVolatility(monthVals);
    var callTrend = trendStrength(monthVals);

    var daysInMonth = new Date(curYear, curMonth + 1, 0).getDate();
    var dayOfMonth = today.getDate();
    var curMonthKey = curYear + '-' + String(curMonth + 1).padStart(2, '0');
    var curMonthCalls = monthlyCalls[curMonthKey] || 0;
    var runRate = dayOfMonth > 0 ? Math.round(curMonthCalls / dayOfMonth * daysInMonth) : 0;
    var annualRunRate = runRate * 12;

    // 2. Revenue/Profit â€” sort chronologically (keys are "Jan 2024", "Feb 2024" etc.)
    var monthOrder = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
    var revMonths = Object.keys(fh.months || {}).sort(function(a, b) {
      var pa = a.split(' '), pb = b.split(' ');
      var ya = parseInt(pa[1]) || 0, yb = parseInt(pb[1]) || 0;
      if (ya !== yb) return ya - yb;
      return (monthOrder[pa[0]] || 0) - (monthOrder[pb[0]] || 0);
    });
    var revVals, profVals, expVals, adsVals, marginVals;
    // Prefer Square monthly revenue (most accurate), fall back to profit sheet, then estimate from calls
    var sqRevKeys = Object.keys(sqMonthlyRev).sort();
    var sqTotalRev = sqRevKeys.reduce(function(s, k) { return s + (sqMonthlyRev[k] || 0); }, 0);
    var fhTotalRev = Object.values(fh.months || {}).reduce(function(s, m) { return s + (m.revenue || 0); }, 0);
    
    if (sqTotalRev > fhTotalRev && sqRevKeys.length > 0) {
      // Use Square revenue â€” convert YYYY-MM keys to "Mon YYYY" format for chart labels
      var sqMonthNames = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      revMonths = sqRevKeys.map(function(k) { var parts = k.split('-'); return sqMonthNames[parseInt(parts[1])] + ' ' + parts[0]; });
      revVals = sqRevKeys.map(function(k) { return sqMonthlyRev[k] || 0; });
      // Estimate profit/expenses from Square revenue
      var estMargin = (pm.margin || 25) / 100;
      profVals = revVals.map(function(v) { return Math.round(v * estMargin); });
      expVals = revVals.map(function(v, i) { return v - profVals[i]; });
      adsVals = revVals.map(function(v) { return Math.round(v * 0.08); });
      marginVals = revVals.map(function() { return Math.round(estMargin * 100); });
    } else if (revMonths.length > 0) {
      revVals = revMonths.map(function(m) { return (fh.months[m] || {}).revenue || 0; });
      profVals = revMonths.map(function(m) { return (fh.months[m] || {}).profit || 0; });
      expVals = revMonths.map(function(m) { return (fh.months[m] || {}).expenses || 0; });
      adsVals = revMonths.map(function(m) { return (fh.months[m] || {}).ads || 0; });
      marginVals = revMonths.map(function(m) { return (fh.months[m] || {}).margin || 0; });
    } else {
      // Fallback: estimate revenue from call volume data * avg ticket
      var estTicket = (pm.revenue && bm.thisMonthCalls) ? Math.round(pm.revenue / Math.max(1, bm.thisMonthCalls)) : 321;
      revMonths = monthKeys.slice();
      revVals = monthVals.map(function(v) { return v * estTicket; });
      profVals = revVals.map(function(v) { return Math.round(v * 0.25); }); // est 25% margin
      expVals = revVals.map(function(v, i) { return v - profVals[i]; });
      adsVals = revVals.map(function(v) { return Math.round(v * 0.08); }); // est 8% ad spend
      marginVals = revVals.map(function(v) { return v > 0 ? 25 : 0; });
    }
    var revFib = calcFibExtended(revVals);
    var revGrowth = growthMetrics(revVals);
    var revForecast = forecast(revVals, 6);
    var profFib = calcFibExtended(profVals);
    var profGrowth = growthMetrics(profVals);
    var profForecast = forecast(profVals, 6);
    var expFib = calcFibExtended(expVals);
    var adsFib = calcFibExtended(adsVals);
    var marginFib = calcFib(marginVals);
    var revBB = bollingerBands(revVals, Math.min(6, revVals.length), 2);
    var revRSI = calcRSI(revVals, Math.min(6, revVals.length));
    var revMACD = calcMACD(revVals);
    var revVol = calcVolatility(revVals);
    var revTrend = trendStrength(revVals);

    var revenuePerCall = 321;
    if (bm.totalLeads > 0) {
      var bestRevTotal = sqTotalRev > fhTotalRev ? sqTotalRev : ((fh.allTime || {}).revenue || 0);
      if (bestRevTotal > 0) revenuePerCall = Math.round(bestRevTotal / bm.totalLeads);
    }

    // 3. Seasonal Demand
    var seasonKeys = Object.keys(seasonalData).sort();
    var seasonByMonth = {};
    seasonKeys.forEach(function(k) {
      var mo = parseInt(k.split('-')[1]);
      if (!seasonByMonth[mo]) seasonByMonth[mo] = { snow: 0, mower: 0, generator: 0, other: 0, count: 0 };
      seasonByMonth[mo].snow += seasonalData[k].snow; seasonByMonth[mo].mower += seasonalData[k].mower;
      seasonByMonth[mo].generator += seasonalData[k].generator; seasonByMonth[mo].other += seasonalData[k].other; seasonByMonth[mo].count++;
    });
    var seasonAvg = {};
    for (var m = 1; m <= 12; m++) {
      var sd = seasonByMonth[m] || { snow: 0, mower: 0, generator: 0, other: 0, count: 0 };
      var c = Math.max(sd.count, 1);
      seasonAvg[m] = { snow: Math.round(sd.snow / c), mower: Math.round(sd.mower / c), generator: Math.round(sd.generator / c), other: Math.round(sd.other / c) };
    }
    // Interpolate months with 0 data from adjacent months and overall monthly calls
    var totalMonthlyCalls = bm.monthlyCalls || {};
    for (var im = 1; im <= 12; im++) {
      var iTotal = (seasonAvg[im].mower||0)+(seasonAvg[im].snow||0)+(seasonAvg[im].generator||0)+(seasonAvg[im].other||0);
      if (iTotal === 0) {
        // Use monthly call average for this calendar month from monthlyCalls
        var histCalls = [];
        Object.keys(totalMonthlyCalls).forEach(function(mk) {
          var mo = parseInt(mk.split('-')[1]);
          if (mo === im && totalMonthlyCalls[mk] > 0) histCalls.push(totalMonthlyCalls[mk]);
        });
        if (histCalls.length > 0) {
          var avgC = Math.round(histCalls.reduce(function(a,b){return a+b;},0) / histCalls.length);
          // Estimate equipment split from overall ratios
          var totalEquip = Object.keys(bm.equipStats || {}).reduce(function(s,k){return s+(bm.equipStats[k]||0);},0) || 1;
          var mowerPct = ((bm.equipStats||{})['Mower']||0) / totalEquip;
          var snowPct = ((bm.equipStats||{})['Snow Blower']||0) / totalEquip;
          var genPct = ((bm.equipStats||{})['Generator']||0) / totalEquip;
          seasonAvg[im] = { mower: Math.round(avgC*mowerPct), snow: Math.round(avgC*snowPct), generator: Math.round(avgC*genPct), other: Math.round(avgC*(1-mowerPct-snowPct-genPct)) };
        } else {
          // Interpolate from nearest months with data
          var prev = im - 1 < 1 ? 12 : im - 1;
          var next = im + 1 > 12 ? 1 : im + 1;
          var pTotal = (seasonAvg[prev].mower||0)+(seasonAvg[prev].snow||0)+(seasonAvg[prev].generator||0)+(seasonAvg[prev].other||0);
          var nTotal = (seasonAvg[next].mower||0)+(seasonAvg[next].snow||0)+(seasonAvg[next].generator||0)+(seasonAvg[next].other||0);
          if (pTotal > 0 || nTotal > 0) {
            seasonAvg[im] = {
              mower: Math.round(((seasonAvg[prev].mower||0)+(seasonAvg[next].mower||0))/2),
              snow: Math.round(((seasonAvg[prev].snow||0)+(seasonAvg[next].snow||0))/2),
              generator: Math.round(((seasonAvg[prev].generator||0)+(seasonAvg[next].generator||0))/2),
              other: Math.round(((seasonAvg[prev].other||0)+(seasonAvg[next].other||0))/2),
            };
          }
        }
      }
    }

    // Equipment Fibonacci
    var equipMonthly = { mower: [], snow: [], generator: [], other: [] };
    seasonKeys.forEach(function(k) { var sd2 = seasonalData[k]; equipMonthly.mower.push(sd2.mower); equipMonthly.snow.push(sd2.snow); equipMonthly.generator.push(sd2.generator); equipMonthly.other.push(sd2.other); });
    var mowerFib = calcFibExtended(equipMonthly.mower); var snowFib = calcFibExtended(equipMonthly.snow); var genFib = calcFibExtended(equipMonthly.generator);
    var mowerGrowth = growthMetrics(equipMonthly.mower); var snowGrowth = growthMetrics(equipMonthly.snow); var genGrowth = growthMetrics(equipMonthly.generator);

    // 4. City Forecasting (enhanced)
    var cityForecasts = [];
    Object.keys(callsByCity).forEach(function(city) {
      var cm = callsByCity[city]; var ck = Object.keys(cm).sort();
      if (ck.length < 3) return;
      var cv = ck.map(function(k) { return cm[k] || 0; });
      var cFib = calcFibExtended(cv); var cGrowth = growthMetrics(cv); var cLR = linearRegression(cv);
      var total = cv.reduce(function(a,b){return a+b;},0);
      var cForecast = forecast(cv, 3);
      var cBB = bollingerBands(cv, Math.min(4, cv.length), 2);
      var cRSI = calcRSI(cv, Math.min(4, cv.length));
      var cVol = calcVolatility(cv);
      var cTrend = trendStrength(cv);
      cityForecasts.push({
        city: city, total: total, months: ck.length, current: cv[cv.length - 1],
        predicted: Math.max(0, cForecast.length > 0 ? cForecast[0].blended : 0),
        growth: cGrowth, fib: cFib, r2: cLR.r2, slope: cLR.slope, forecast: cForecast,
        bb: cBB, rsi: cRSI.length > 0 ? cRSI[cRSI.length - 1] : 50,
        volatility: cVol, trend: cTrend,
        labels: ck.slice(-12).map(function(k2) { var p = k2.split('-'); return monthLabels3[parseInt(p[1])] + "'" + p[0].substring(2); }),
        values: cv.slice(-12), allValues: cv,
      });
    });
    cityForecasts.sort(function(a, b) { return b.total - a.total; });

    // 5. Tech Productivity (enhanced)
    var techProd = [];
    Object.entries(techStats).forEach(function(t) {
      var ts = t[1]; if (ts.total < 3) return;
      var completionRate = ts.total > 0 ? Math.round(ts.completed / ts.total * 1000) / 10 : 0;
      var estRevenue = ts.total * revenuePerCall;
      var daysSeen = 1;
      if (ts.firstSeen && ts.lastSeen) daysSeen = Math.max(1, Math.round((ts.lastSeen - ts.firstSeen) / 86400000));
      var jobsPerDay = Math.round(ts.total / daysSeen * 100) / 100;
      techProd.push({
        name: t[0], total: ts.total, completed: ts.completed, rate: completionRate,
        revenue: estRevenue, jobsPerDay: jobsPerDay, locations: Object.keys(ts.locations || {}).length,
        cancelRate: ts.total > 0 ? Math.round(ts.cancelled / ts.total * 1000) / 10 : 0,
        returnRate: ts.total > 0 ? Math.round(ts.returnCustomers / ts.total * 1000) / 10 : 0,
        efficiency: completionRate * jobsPerDay,
      });
    });
    // Fallback: if techStats empty but we have tech payouts from profit sheet
    if (techProd.length === 0 && pm.techPayouts && Object.keys(pm.techPayouts).length > 0) {
      Object.entries(pm.techPayouts).forEach(function(tp) {
        if (tp[1] > 0) {
          techProd.push({
            name: tp[0], total: 0, completed: 0, rate: 0,
            revenue: tp[1], jobsPerDay: 0, locations: 0,
            cancelRate: 0, returnRate: 0, efficiency: 0,
            payoutOnly: true,
          });
        }
      });
    }
    // Also try yearlyTechPayouts as fallback
    if (techProd.length === 0 && pm.yearlyTechPayouts && Object.keys(pm.yearlyTechPayouts).length > 0) {
      Object.entries(pm.yearlyTechPayouts).forEach(function(tp) {
        if (tp[1] > 0) {
          techProd.push({
            name: tp[0], total: 0, completed: 0, rate: 0,
            revenue: tp[1], jobsPerDay: 0, locations: 0,
            cancelRate: 0, returnRate: 0, efficiency: 0,
            payoutOnly: true,
          });
        }
      });
    }
    techProd.sort(function(a, b) { return b.revenue - a.revenue; });

    // 6. Ad Spend Efficiency
    var adROI = [];
    for (var ai = 0; ai < revVals.length; ai++) {
      if (adsVals[ai] > 0) adROI.push(Math.round(revVals[ai] / adsVals[ai] * 100) / 100);
      else adROI.push(0);
    }
    var adROIFib = calcFib(adROI.filter(function(v){return v > 0;}));
    var costPerLead = [];
    for (var ci = 0; ci < monthKeys.length; ci++) {
      var callCount = monthVals[ci];
      var adSpend = ci < adsVals.length ? adsVals[ci] : 0;
      if (callCount > 0 && adSpend > 0) costPerLead.push(Math.round(adSpend / callCount * 100) / 100);
      else costPerLead.push(0);
    }
    var cplFib = calcFib(costPerLead.filter(function(v){return v > 0;}));

    // 7. Correlation: calls vs revenue
    var callRevCorrelation = 0;
    if (revVals.length >= 3 && monthVals.length >= 3) {
      var minLen = Math.min(revVals.length, monthVals.length);
      var callsSub = monthVals.slice(-minLen), revSub = revVals.slice(-minLen);
      var avgC = callsSub.reduce(function(a,b){return a+b;},0)/minLen;
      var avgR = revSub.reduce(function(a,b){return a+b;},0)/minLen;
      var cov = 0, stdC = 0, stdR = 0;
      for (var ci2 = 0; ci2 < minLen; ci2++) {
        cov += (callsSub[ci2]-avgC)*(revSub[ci2]-avgR);
        stdC += (callsSub[ci2]-avgC)*(callsSub[ci2]-avgC);
        stdR += (revSub[ci2]-avgR)*(revSub[ci2]-avgR);
      }
      callRevCorrelation = (stdC > 0 && stdR > 0) ? Math.round(cov / (Math.sqrt(stdC) * Math.sqrt(stdR)) * 1000) / 1000 : 0;
    }

    // 8. Day-of-week patterns from recent bookings
    var dowCounts = [0,0,0,0,0,0,0]; var dowLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    var recentBk = bm.recentBookings || [];
    recentBk.forEach(function(b) { if (b.date) { var d = new Date(b.date); if (!isNaN(d)) dowCounts[d.getDay()]++; } });
    var dowTotal = dowCounts.reduce(function(a,b){return a+b;},0);

    // 9. Cancellation analysis
    var cancelByCity = {}; var overallCancelRate = bm.totalLeads > 0 ? Math.round(bm.totalCancelled / bm.totalLeads * 1000) / 10 : 0;
    Object.entries(locationStats).forEach(function(l) { if (l[1].total >= 5) cancelByCity[l[0]] = { total: l[1].total, cancelled: l[1].cancelled, rate: l[1].total > 0 ? Math.round(l[1].cancelled / l[1].total * 1000) / 10 : 0 }; });
    var cancelByCitySorted = Object.entries(cancelByCity).sort(function(a,b) { return b[1].rate - a[1].rate; });

    // 10. Brand analysis
    var brandSorted = Object.entries(brandStats).sort(function(a,b) { return b[1] - a[1]; });
    var brandTotal = brandSorted.reduce(function(s, b) { return s + b[1]; }, 0);

    // ========== BUILD HTML ==========
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>WILDWOOD â€” Predictive Analytics Engine</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">';
    html += '<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"><\/script>';
    html += '<style>';
    html += '*{margin:0;padding:0;box-sizing:border-box;}';
    html += 'body{background:#050d18;color:#c0d8f0;font-family:Rajdhani,sans-serif;overflow-x:hidden;}';
    html += '.wrap{max-width:1500px;margin:0 auto;padding:20px 30px;}';
    html += '.nav{display:flex;gap:0;margin-bottom:20px;flex-wrap:wrap;}';
    html += '.nav a{font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);transition:all 0.3s;}';
    html += '.nav a.active{color:#ff9f43;border-color:#ff9f4340;background:rgba(255,159,67,0.1);}';
    html += '.nav a:hover{border-color:#ff9f4340;}';
    html += '.title{font-family:Orbitron;font-size:1.4em;letter-spacing:8px;color:#ff9f43;margin-bottom:5px;}';
    html += '.sub{font-family:Orbitron;font-size:0.5em;letter-spacing:3px;color:#4a6a8a;margin-bottom:25px;}';
    html += '.section{margin-bottom:35px;}';
    html += '.section-head{font-family:Orbitron;font-size:0.85em;letter-spacing:5px;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;cursor:pointer;}';
    html += '.section-head .dot{width:10px;height:10px;border-radius:50%;display:inline-block;animation:glow 2s ease-in-out infinite alternate;}';
    html += '@keyframes glow{0%{box-shadow:0 0 5px var(--gc,#ff9f43);}100%{box-shadow:0 0 20px var(--gc,#ff9f43);}}';
    html += '.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:15px;}';
    html += '.kpi{background:rgba(10,20,35,0.8);border:1px solid rgba(255,255,255,0.05);padding:16px;position:relative;overflow:hidden;transition:all 0.3s;}';
    html += '.kpi:hover{border-color:var(--c,#ff9f43);transform:translateY(-2px);}';
    html += '.kpi::before{content:"";position:absolute;top:0;left:0;width:100%;height:2px;background:var(--c,#ff9f43);opacity:0.4;}';
    html += '.kpi-label{color:#4a6a8a;font-family:Orbitron;font-size:0.5em;letter-spacing:2px;margin-bottom:4px;}';
    html += '.kpi-val{font-family:Orbitron;font-size:1.5em;font-weight:900;color:var(--c,#ff9f43);}';
    html += '.kpi-sub{color:#4a6a8a;font-size:0.8em;margin-top:2px;}';
    html += '.fib-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:15px;margin-bottom:15px;}';
    html += '.fib-card{background:rgba(10,20,35,0.8);border:1px solid #1a2a3a;padding:18px;transition:border-color 0.3s;}';
    html += '.fib-card:hover{border-color:#ffffff10;}';
    html += '.fib-title{font-family:Orbitron;font-size:0.65em;letter-spacing:3px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}';
    html += '.fib-level{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid #0a1520;}';
    html += '.fib-level .pct{font-family:Orbitron;font-size:0.55em;color:#4a6a8a;width:55px;}';
    html += '.fib-level .bar{flex:1;height:6px;background:#0a1520;margin:0 8px;position:relative;}';
    html += '.fib-level .fill{height:100%;position:absolute;top:0;left:0;transition:width 0.5s;}';
    html += '.fib-level .val{font-family:Orbitron;font-size:0.7em;width:60px;text-align:right;}';
    html += '.pill{display:inline-block;font-family:Orbitron;font-size:0.5em;letter-spacing:1px;padding:3px 10px;border-radius:2px;}';
    html += '.pill-green{background:rgba(0,255,102,0.1);color:#00ff66;border:1px solid #00ff6630;}';
    html += '.pill-red{background:rgba(255,71,87,0.1);color:#ff4757;border:1px solid #ff475730;}';
    html += '.pill-orange{background:rgba(255,159,67,0.1);color:#ff9f43;border:1px solid #ff9f4330;}';
    html += '.pill-blue{background:rgba(0,212,255,0.1);color:#00d4ff;border:1px solid #00d4ff30;}';
    html += '.pill-purple{background:rgba(168,85,247,0.1);color:#a855f7;border:1px solid #a855f730;}';
    html += '.data-table{width:100%;border-collapse:collapse;font-size:0.8em;}';
    html += '.data-table th{padding:8px;text-align:left;color:#ff9f43;font-family:Orbitron;font-size:0.55em;letter-spacing:1px;border-bottom:2px solid #ff9f4315;}';
    html += '.data-table td{padding:6px 8px;border-bottom:1px solid #0a1520;}';
    html += '.data-table tr:nth-child(even){background:rgba(10,20,35,0.3);}';
    html += '.data-table tr:hover{background:rgba(0,212,255,0.03);}';
    html += '.chart-box{background:rgba(10,20,35,0.8);border:1px solid #1a2a3a;padding:18px;margin-bottom:15px;}';
    html += '.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}';
    html += '.chart-title{font-family:Orbitron;font-size:0.65em;letter-spacing:3px;}';
    html += '.metric-badge{font-family:Orbitron;font-size:0.55em;letter-spacing:1px;padding:4px 12px;border:1px solid;margin-left:6px;}';
    html += '.signal-box{padding:14px;border:1px solid;margin-top:12px;font-size:0.85em;line-height:1.5;}';
    html += '.sparkline{display:inline-flex;align-items:flex-end;gap:1px;height:20px;vertical-align:middle;}';
    html += '.sparkline .sp{width:3px;min-height:1px;display:inline-block;}';

    // Mobile responsive
    html += '@media(max-width:768px){';
    html += '.wrap{padding:10px 12px;} .title{font-size:1em;letter-spacing:3px;}';
    html += '.kpi-row{grid-template-columns:repeat(2,1fr);gap:8px;}';
    html += '.fib-grid{grid-template-columns:1fr;}';
    html += '.nav a{padding:8px 12px;font-size:0.5em;letter-spacing:2px;}';
    html += '.kpi-val{font-size:1.1em;} .kpi{padding:10px;}';
    html += 'table{font-size:0.65em;} th,td{padding:4px 3px;}';
    html += '.chart-box{padding:10px;} [style*="overflow-x"]{overflow-x:auto;-webkit-overflow-scrolling:touch;}';
    html += '.sub{font-size:0.4em;letter-spacing:1px;}';
    html += '}';
    html += '@media(max-width:480px){.kpi-row{grid-template-columns:1fr;}}';
    html += '</style></head><body><div class="wrap">';

    // Nav
    html += '<div class="nav">';
    html += '<a href="/dashboard">JARVIS</a>';
    html += '<a href="/business">ATHENA</a>';
    html += '<a href="/tookan">TOOKAN</a>';
    html += '<a href="/business/chart">CHARTS</a>';
    html += '<a href="/analytics" class="active">ANALYTICS</a>';
    html += '<a href="/ads">GOOGLE ADS</a>';
    html += '<a href="/followup">FOLLOW UP</a><a href="/ai" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">AI</a><a href="/forecast" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">FORECAST</a><a href="/seo" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">SEO</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AUDIT</a><a href="/auth/logout" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#ef4444;border:1px solid #ef444440;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">LOGOUT</a>';
    html += '</div>';

    html += '<div class="title">PREDICTIVE ANALYTICS ENGINE</div>';
    html += '<div class="sub">FIBONACCI RETRACEMENT &bull; EXTENSIONS &bull; BOLLINGER BANDS &bull; RSI &bull; MACD &bull; REVENUE FORECASTING &bull; SEASONAL AI &bull; ' + monthKeys.length + ' MONTHS DATA</div>';

    // ====================================================================
    // SECTION 1: BUSINESS PULSE â€” MASTER DASHBOARD
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#ff9f43;--gc:#ff9f43;"><span class="dot" style="background:#ff9f43;"></span>BUSINESS PULSE â€” MASTER INDICATORS</div>';
    html += '<div class="kpi-row">';

    var pulseKPIs = [
      { label: 'MONTHLY RUN RATE', val: runRate.toLocaleString() + ' calls', sub: dayOfMonth + '/' + daysInMonth + ' days (' + curMonthCalls + ' actual)', c: '#00d4ff' },
      { label: 'ANNUAL RUN RATE', val: '$' + (annualRunRate * revenuePerCall).toLocaleString(), sub: annualRunRate.toLocaleString() + ' calls projected', c: '#00ff66' },
      { label: 'MoM MOMENTUM', val: (callGrowth.mom >= 0 ? '+' : '') + callGrowth.mom + '%', sub: callGrowth.prev + ' â†’ ' + callGrowth.last, c: callGrowth.mom >= 0 ? '#00ff66' : '#ff4757' },
      { label: 'QoQ GROWTH', val: (callGrowth.qoq >= 0 ? '+' : '') + callGrowth.qoq + '%', sub: 'Quarter over quarter', c: callGrowth.qoq >= 0 ? '#00ff66' : '#ff4757' },
      { label: 'TREND STRENGTH', val: callTrend.strength + '%', sub: callTrend.direction.toUpperCase() + ' (' + callTrend.consistency + '% consistent)', c: callTrend.direction === 'bullish' ? '#00ff66' : callTrend.direction === 'bearish' ? '#ff4757' : '#ff9f43' },
      { label: 'VOLATILITY', val: callVol + '%', sub: callVol > 30 ? 'HIGH â€” unstable' : callVol > 15 ? 'MODERATE' : 'LOW â€” stable', c: callVol > 30 ? '#ff4757' : callVol > 15 ? '#ff9f43' : '#00ff66' },
      { label: 'RSI (6)', val: callRSI.length > 0 ? callRSI[callRSI.length-1] : 'N/A', sub: (callRSI.length > 0 && callRSI[callRSI.length-1] > 70) ? 'OVERBOUGHT' : (callRSI.length > 0 && callRSI[callRSI.length-1] < 30) ? 'OVERSOLD' : 'NEUTRAL', c: '#a855f7' },
      { label: 'CALLâ†”REVENUE R', val: callRevCorrelation, sub: callRevCorrelation > 0.7 ? 'Strong link' : callRevCorrelation > 0.4 ? 'Moderate link' : 'Weak link', c: '#ffd700' },
    ];
    pulseKPIs.forEach(function(k) {
      html += '<div class="kpi" style="--c:' + k.c + ';"><div class="kpi-label">' + k.label + '</div><div class="kpi-val">' + k.val + '</div><div class="kpi-sub">' + k.sub + '</div></div>';
    });
    html += '</div>';

    // Strategy signal box
    var masterSignal = '', sigColor = '#00d4ff';
    if (callGrowth.mom > 15 && callTrend.direction === 'bullish') { masterSignal = 'ðŸš€ STRONG GROWTH â€” All indicators bullish. Scale aggressively: hire techs, increase ad spend, expand to new cities. Next month forecast: ~' + callForecast[0].blended + ' calls ($' + (callForecast[0].blended * revenuePerCall).toLocaleString() + ' revenue).'; sigColor = '#00ff66'; }
    else if (callGrowth.mom > 0) { masterSignal = 'ðŸ“ˆ MODERATE GROWTH â€” Positive momentum. Maintain current strategy, consider incremental ad increases. Watch for Fib resistance at ' + callFib['61.8'] + ' calls. Forecast: ~' + callForecast[0].blended + ' calls.'; sigColor = '#00ff66'; }
    else if (callGrowth.mom > -10) { masterSignal = 'âš¡ CONSOLIDATION â€” Volume stabilizing. Focus on conversion optimization and customer retention. Fib support at ' + callFib['38.2'] + '. Reduce discretionary spending until breakout confirmed.'; sigColor = '#ff9f43'; }
    else { masterSignal = 'âš ï¸ PULLBACK â€” Volume declining ' + callGrowth.mom + '%. Defend Fib support at ' + callFib['38.2'] + '. Cut ad waste, rebook cancellations, activate retention campaigns. Next support: ' + callFib['23.6'] + '.'; sigColor = '#ff4757'; }
    if (callRSI.length > 0 && callRSI[callRSI.length-1] > 70) masterSignal += ' âš¡ RSI OVERBOUGHT â€” Potential pullback incoming.';
    if (callRSI.length > 0 && callRSI[callRSI.length-1] < 30) masterSignal += ' ðŸ’Ž RSI OVERSOLD â€” Potential bounce opportunity.';
    if (callBB.width.length > 0 && callBB.width[callBB.width.length-1] < 15) masterSignal += ' ðŸ”¥ BB SQUEEZE â€” Breakout imminent!';

    html += '<div class="signal-box" style="border-color:' + sigColor + '30;background:' + sigColor + '05;color:' + sigColor + ';">' + masterSignal + '</div>';
    html += '</div>';

    // ====================================================================
    // SECTION 2: INTERACTIVE CALL VOLUME CHART (LightweightCharts)
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#00d4ff;--gc:#00d4ff;"><span class="dot" style="background:#00d4ff;"></span>CALL VOLUME â€” INTERACTIVE TECHNICAL ANALYSIS</div>';

    // Build chart data for LightweightCharts
    var lcCallData = monthKeys.map(function(k) { return { time: k + '-01', value: monthlyCalls[k] || 0 }; });
    var lcForecastData = [];
    for (var fi = 0; fi < 6; fi++) {
      var fMonth = (curMonth + fi + 1) % 12 + 1;
      var fYear = curYear + Math.floor((curMonth + fi + 1) / 12);
      lcForecastData.push({ time: fYear + '-' + String(fMonth).padStart(2, '0') + '-01', value: callForecast[fi].blended, upper: callForecast[fi].upper, lower: callForecast[fi].lower });
    }

    html += '<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;">';
    html += '<button onclick="toggleOverlay(\'bb\')" id="btn-bb2" style="font-family:Orbitron;font-size:0.55em;letter-spacing:1px;padding:6px 14px;background:#0a1520;color:#4a6a8a;border:1px solid #1a2a3a;cursor:pointer;">BB</button>';
    html += '<button onclick="toggleOverlay(\'sma\')" id="btn-sma2" style="font-family:Orbitron;font-size:0.55em;letter-spacing:1px;padding:6px 14px;background:#0a1520;color:#4a6a8a;border:1px solid #1a2a3a;cursor:pointer;">SMA</button>';
    html += '<button onclick="toggleOverlay(\'ema\')" id="btn-ema2" style="font-family:Orbitron;font-size:0.55em;letter-spacing:1px;padding:6px 14px;background:#0a1520;color:#4a6a8a;border:1px solid #1a2a3a;cursor:pointer;">EMA</button>';
    html += '<button onclick="toggleOverlay(\'fib\')" id="btn-fib2" style="font-family:Orbitron;font-size:0.55em;letter-spacing:1px;padding:6px 14px;background:rgba(0,255,102,0.1);color:#00ff66;border:1px solid #00ff6640;cursor:pointer;">FIB</button>';
    html += '<button onclick="toggleOverlay(\'ext\')" id="btn-ext2" style="font-family:Orbitron;font-size:0.55em;letter-spacing:1px;padding:6px 14px;background:#0a1520;color:#4a6a8a;border:1px solid #1a2a3a;cursor:pointer;">FIB EXT</button>';
    html += '<button onclick="toggleOverlay(\'forecast\')" id="btn-fore2" style="font-family:Orbitron;font-size:0.55em;letter-spacing:1px;padding:6px 14px;background:rgba(255,159,67,0.1);color:#ff9f43;border:1px solid #ff9f4340;cursor:pointer;">FORECAST</button>';
    html += '</div>';

    html += '<div id="call-chart" style="border:1px solid #1a2a3a;min-height:350px;width:100%;"></div>';
    html += '<div style="font-family:Orbitron;font-size:0.45em;color:#4a6a8a;padding:4px 0;">RSI (6)</div>';
    html += '<div id="call-rsi" style="border:1px solid #1a2a3a;min-height:100px;width:100%;"></div>';
    html += '<div style="font-family:Orbitron;font-size:0.45em;color:#4a6a8a;padding:4px 0;">MACD (12, 26, 9)</div>';
    html += '<div id="call-macd" style="border:1px solid #1a2a3a;min-height:100px;width:100%;"></div>';

    // Fib level summary strip
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:6px;margin-top:12px;">';
    [
      { label: '261.8% EXT', val: callFib['261.8'], c: '#a855f7' },
      { label: '161.8% EXT', val: callFib['161.8'], c: '#a855f7' },
      { label: '127.2% EXT', val: callFib['127.2'], c: '#00d4ff' },
      { label: '100% HIGH', val: callFib.high, c: '#00ff66' },
      { label: '78.6%', val: callFib['78.6'], c: '#00ff66' },
      { label: '61.8% RESIST', val: callFib['61.8'], c: '#00ff66' },
      { label: '50% MID', val: callFib['50.0'], c: '#ffd700' },
      { label: '38.2% SUPPORT', val: callFib['38.2'], c: '#ff4757' },
      { label: '23.6%', val: callFib['23.6'], c: '#ff4757' },
      { label: '0% LOW', val: callFib.low, c: '#ff4757' },
      { label: 'CURRENT', val: callFib.current, c: '#00d4ff' },
    ].forEach(function(f) {
      html += '<div style="background:rgba(10,20,35,0.6);padding:6px;text-align:center;border:1px solid ' + f.c + '15;">';
      html += '<div style="color:#4a6a8a;font-family:Orbitron;font-size:0.4em;">' + f.label + '</div>';
      html += '<div style="color:' + f.c + ';font-family:Orbitron;font-size:0.85em;font-weight:900;">' + f.val + '</div>';
      html += '</div>';
    });
    html += '</div></div>';

    // ====================================================================
    // SECTION 3: REVENUE & PROFIT FIBONACCI â€” INTERACTIVE CHARTS
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#00ff66;--gc:#00ff66;"><span class="dot" style="background:#00ff66;"></span>REVENUE & PROFIT â€” FIBONACCI + FORECASTING</div>';

    // Revenue chart
    var monthAbbrevToNum = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
    var lcRevData = revMonths.map(function(m, i) {
      var timeStr;
      if (m.indexOf('-') > 0 && m.length <= 7) { timeStr = m + '-01'; } // "2024-01" format
      else { var parts = m.split(' '); var mi = monthAbbrevToNum[parts[0]] || 1; timeStr = (parts[1] || '2024') + '-' + String(mi).padStart(2,'0') + '-01'; }
      return { time: timeStr, value: revVals[i] || 0 };
    });
    var lcProfData = revMonths.map(function(m, i) { return { time: lcRevData[i] ? lcRevData[i].time : '2024-01-01', value: profVals[i] || 0 }; });

    html += '<div id="rev-chart" style="border:1px solid #1a2a3a;margin-bottom:5px;min-height:300px;width:100%;"></div>';
    html += '<div style="display:flex;gap:15px;padding:6px;font-size:0.75em;">';
    html += '<span style="color:#00ff66;">â— Revenue</span>';
    html += '<span style="color:#ffd700;">â— Profit</span>';
    html += '<span style="color:#ff9f4380;">â–ª Forecast</span>';
    html += '</div>';

    // Revenue & Profit Fib cards side by side
    html += '<div class="fib-grid">';

    var revProfFibs = [
      { name: 'REVENUE', fib: revFib, growth: revGrowth, forecast: revForecast, color: '#00ff66', prefix: '$', trend: revTrend },
      { name: 'PROFIT', fib: profFib, growth: profGrowth, forecast: profForecast, color: '#ffd700', prefix: '$', trend: trendStrength(profVals) },
      { name: 'EXPENSES', fib: expFib, growth: growthMetrics(expVals), forecast: forecast(expVals, 6), color: '#ff4757', prefix: '$', trend: trendStrength(expVals) },
      { name: 'AD SPEND', fib: adsFib, growth: growthMetrics(adsVals), forecast: forecast(adsVals, 6), color: '#a855f7', prefix: '$', trend: trendStrength(adsVals) },
    ];

    revProfFibs.forEach(function(rpf) {
      html += '<div class="fib-card">';
      html += '<div class="fib-title"><span style="color:' + rpf.color + ';">' + rpf.name + ' FIBONACCI</span>';
      var rpfTrend = rpf.growth.mom > 5 ? 'â–²' : rpf.growth.mom < -5 ? 'â–¼' : 'â–º';
      html += '<span style="color:' + (rpf.growth.mom > 0 ? '#00ff66' : '#ff4757') + ';">' + rpfTrend + ' ' + (rpf.growth.mom >= 0 ? '+' : '') + rpf.growth.mom + '%</span></div>';

      [
        { label: '161.8% EXT', val: rpf.fib['161.8'], c: '#a855f7' },
        { label: '127.2% EXT', val: rpf.fib['127.2'], c: '#00d4ff' },
        { label: '100% HIGH', val: rpf.fib.high, c: '#00ff66' },
        { label: '61.8% RESIST', val: rpf.fib['61.8'], c: '#00ff66' },
        { label: '50% MID', val: rpf.fib['50.0'], c: '#ffd700' },
        { label: '38.2% SUPPORT', val: rpf.fib['38.2'], c: '#ff4757' },
        { label: '0% LOW', val: rpf.fib.low, c: '#ff4757' },
      ].forEach(function(lv) {
        var pct2 = rpf.fib.high > 0 ? Math.round(lv.val / rpf.fib.high * 100) : 0;
        html += '<div class="fib-level"><span class="pct">' + lv.label.split(' ')[0] + '</span>';
        html += '<div class="bar"><div class="fill" style="width:' + Math.min(100, pct2) + '%;background:' + lv.c + '40;"></div></div>';
        html += '<span class="val" style="color:' + lv.c + ';">' + rpf.prefix + Math.round(lv.val).toLocaleString() + '</span></div>';
      });

      html += '<div style="margin-top:10px;">';
      html += '<div style="font-family:Orbitron;font-size:0.5em;color:#4a6a8a;margin-bottom:4px;">6-MONTH FORECAST (confidence band)</div>';
      html += '<div style="display:flex;gap:4px;">';
      rpf.forecast.forEach(function(f) {
        html += '<div style="flex:1;text-align:center;background:rgba(10,20,35,0.5);padding:4px;border:1px dashed ' + rpf.color + '30;">';
        html += '<div style="color:' + rpf.color + ';font-family:Orbitron;font-size:0.6em;">' + rpf.prefix + Math.round(f.blended).toLocaleString() + '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.55em;">' + rpf.prefix + f.lower.toLocaleString() + 'â€“' + rpf.prefix + f.upper.toLocaleString() + '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '<div style="display:flex;justify-content:space-between;margin-top:6px;">';
      html += '<span style="font-size:0.7em;color:#4a6a8a;">Trend: <strong style="color:' + (rpf.trend.direction === 'bullish' ? '#00ff66' : rpf.trend.direction === 'bearish' ? '#ff4757' : '#ff9f43') + ';">' + rpf.trend.direction.toUpperCase() + '</strong> (' + rpf.trend.strength + '%)</span>';
      html += '<span style="font-size:0.7em;color:#4a6a8a;">RÂ²: ' + linearRegression(rpf.name === 'REVENUE' ? revVals : rpf.name === 'PROFIT' ? profVals : rpf.name === 'EXPENSES' ? expVals : adsVals).r2 + '</span>';
      html += '</div></div></div>';
    });
    html += '</div>';

    // Margin Fibonacci
    html += '<div class="chart-box">';
    html += '<div class="chart-header"><div class="chart-title" style="color:#55f7d8;">PROFIT MARGIN FIBONACCI</div>';
    html += '<span class="metric-badge" style="border-color:' + (marginFib.current > marginFib['61.8'] ? '#00ff6640' : marginFib.current > marginFib['38.2'] ? '#ffd70040' : '#ff475740') + ';color:' + (marginFib.current > marginFib['61.8'] ? '#00ff66' : marginFib.current > marginFib['38.2'] ? '#ffd700' : '#ff4757') + ';">CURRENT: ' + marginFib.current + '%</span></div>';
    html += '<div style="position:relative;height:30px;background:#0a1520;margin-bottom:8px;">';
    var markerPos = marginFib.high > 0 ? Math.min(100, Math.round((marginFib.current - marginFib.low) / (marginFib.high - marginFib.low || 1) * 100)) : 50;
    html += '<div style="position:absolute;top:0;bottom:0;left:' + markerPos + '%;width:3px;background:#55f7d8;box-shadow:0 0 10px #55f7d8;z-index:2;"></div>';
    [0, 23.6, 38.2, 50, 61.8, 78.6, 100].forEach(function(pct) {
      html += '<div style="position:absolute;top:0;bottom:0;left:' + pct + '%;width:1px;background:#ffffff10;"></div>';
    });
    html += '</div>';
    html += '<div style="display:flex;justify-content:space-between;font-family:Orbitron;font-size:0.45em;color:#4a6a8a;">';
    html += '<span>Low: ' + marginFib.low + '%</span><span>38.2%: ' + marginFib['38.2'] + '%</span><span>50%: ' + marginFib['50.0'] + '%</span><span>61.8%: ' + marginFib['61.8'] + '%</span><span>High: ' + marginFib.high + '%</span>';
    html += '</div></div>';
    html += '</div>';

    // ====================================================================
    // SECTION 4: AD SPEND ROI FIBONACCI
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#a855f7;--gc:#a855f7;"><span class="dot" style="background:#a855f7;"></span>AD SPEND EFFICIENCY â€” ROI FIBONACCI</div>';

    html += '<div class="kpi-row">';
    var adKPIs = [
      { label: 'CURRENT ROAS', val: adROI.length > 0 ? adROI[adROI.length-1] + 'x' : 'N/A', sub: 'Revenue per $1 ad spend', c: adROI.length > 0 && adROI[adROI.length-1] > 5 ? '#00ff66' : '#ff9f43' },
      { label: 'ROAS HIGH (Fib)', val: adROIFib.high + 'x', sub: '100% retracement level', c: '#00ff66' },
      { label: 'ROAS SUPPORT', val: adROIFib['38.2'] + 'x', sub: '38.2% Fibonacci', c: '#ff4757' },
      { label: 'COST PER LEAD', val: '$' + (costPerLead.length > 0 ? costPerLead[costPerLead.length-1] : 0), sub: 'Current month CPL', c: '#a855f7' },
      { label: 'CPL LOW (Fib)', val: '$' + cplFib.low, sub: 'Best efficiency', c: '#00ff66' },
      { label: 'CPL RESIST', val: '$' + cplFib['61.8'], sub: '61.8% â€” expensive zone', c: '#ff4757' },
    ];
    adKPIs.forEach(function(k) {
      html += '<div class="kpi" style="--c:' + k.c + ';"><div class="kpi-label">' + k.label + '</div><div class="kpi-val">' + k.val + '</div><div class="kpi-sub">' + k.sub + '</div></div>';
    });
    html += '</div>';

    // ROAS trend mini chart
    if (adROI.length > 3) {
      var maxROI = Math.max.apply(null, adROI);
      html += '<div class="chart-box"><div class="chart-title" style="color:#a855f7;margin-bottom:10px;">ROAS TREND â€” Return On Ad Spend</div>';
      html += '<div style="display:flex;align-items:flex-end;gap:4px;height:100px;">';
      adROI.slice(-12).forEach(function(v, i) {
        var h = maxROI > 0 ? Math.max(2, Math.round(v / maxROI * 100)) : 2;
        var col = v >= adROIFib['61.8'] ? '#00ff66' : v >= adROIFib['38.2'] ? '#ff9f43' : '#ff4757';
        html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;">';
        html += '<div style="color:#4a6a8a;font-size:0.5em;margin-bottom:2px;">' + v + 'x</div>';
        html += '<div style="width:80%;height:' + h + '%;background:' + col + '40;border-top:2px solid ' + col + ';"></div>';
        html += '</div>';
      });
      html += '</div></div>';
    }

    // Ad strategy signal
    var adSignal = '';
    if (adROI.length > 0) {
      var lastROAS = adROI[adROI.length-1];
      if (lastROAS >= adROIFib['61.8']) adSignal = 'ðŸŸ¢ EFFICIENT â€” ROAS above 61.8% Fib. Ads are performing well. Consider increasing budget by 10-20% to scale.';
      else if (lastROAS >= adROIFib['38.2']) adSignal = 'ðŸŸ¡ NORMAL â€” ROAS in middle band. Monitor closely. Optimize targeting and creative to push above resistance.';
      else adSignal = 'ðŸ”´ INEFFICIENT â€” ROAS below 38.2% support. Reduce ad spend, audit campaigns, check landing page conversion.';
    }
    if (adSignal) html += '<div class="signal-box" style="border-color:#a855f730;background:rgba(168,85,247,0.03);color:#a855f7;">' + adSignal + '</div>';
    html += '</div>';

    // ====================================================================
    // SECTION 5: EQUIPMENT FIBONACCI â€” DEMAND RETRACEMENT
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#00ff66;--gc:#00ff66;"><span class="dot" style="background:#00ff66;"></span>EQUIPMENT FIBONACCI â€” DEMAND RETRACEMENT</div>';
    html += '<div class="fib-grid">';

    var equipFibs = [
      { name: 'MOWERS / ZERO TURN', fib: mowerFib, growth: mowerGrowth, color: '#00ff66', vals: equipMonthly.mower, icon: 'ðŸ”§' },
      { name: 'SNOW BLOWERS', fib: snowFib, growth: snowGrowth, color: '#00d4ff', vals: equipMonthly.snow, icon: 'â„ï¸' },
      { name: 'GENERATORS', fib: genFib, growth: genGrowth, color: '#ff9f43', vals: equipMonthly.generator, icon: 'âš¡' },
    ];

    equipFibs.forEach(function(eq) {
      var eqBB = bollingerBands(eq.vals, Math.min(4, eq.vals.length), 2);
      var eqRSI = calcRSI(eq.vals, Math.min(4, eq.vals.length));
      var eqForecast = forecast(eq.vals, 3);
      var eqTrend = trendStrength(eq.vals);

      html += '<div class="fib-card">';
      html += '<div class="fib-title"><span style="color:' + eq.color + ';">' + eq.icon + ' ' + eq.name + '</span>';
      var trendClass = eq.growth.mom > 5 ? 'trend-up' : eq.growth.mom < -5 ? 'trend-down' : 'trend-flat';
      var trendIcon = eq.growth.mom > 5 ? 'â–²' : eq.growth.mom < -5 ? 'â–¼' : 'â–º';
      html += '<span class="' + trendClass + '" style="color:' + (eq.growth.mom > 5 ? '#00ff66' : eq.growth.mom < -5 ? '#ff4757' : '#ff9f43') + ';">' + trendIcon + ' ' + (eq.growth.mom >= 0 ? '+' : '') + eq.growth.mom + '%</span></div>';

      // Mini sparkline
      var eqLast = eq.vals.slice(-12);
      var eqMax = Math.max.apply(null, eqLast.length > 0 ? eqLast : [1]);
      html += '<div style="display:flex;align-items:flex-end;gap:2px;height:60px;margin-bottom:10px;">';
      eqLast.forEach(function(v, i) {
        var h = eqMax > 0 ? Math.max(2, Math.round(v / eqMax * 100)) : 2;
        html += '<div style="flex:1;height:' + h + '%;background:' + (i >= eqLast.length - 3 ? eq.color + '80' : eq.color + '25') + ';min-height:2px;transition:height 0.3s;"></div>';
      });
      // Forecast bars
      eqForecast.forEach(function(f) {
        var h2 = eqMax > 0 ? Math.max(2, Math.round(f.blended / eqMax * 100)) : 2;
        html += '<div style="flex:1;height:' + h2 + '%;background:repeating-linear-gradient(180deg,' + eq.color + '30 0px,' + eq.color + '30 3px,transparent 3px,transparent 6px);min-height:2px;border-top:1px dashed ' + eq.color + '60;"></div>';
      });
      html += '</div>';

      // Fib levels with extensions
      [
        { label: '161.8% EXT', val: eq.fib['161.8'], c: '#a855f7' },
        { label: '100% HIGH', val: eq.fib.high, c: '#00ff66' },
        { label: '61.8% RESIST', val: eq.fib['61.8'], c: '#00ff66' },
        { label: '50% MID', val: eq.fib['50.0'], c: '#ffd700' },
        { label: '38.2% SUPPORT', val: eq.fib['38.2'], c: '#ff4757' },
        { label: '0% LOW', val: eq.fib.low, c: '#ff4757' },
      ].forEach(function(fl3) {
        var pct = eq.fib.high > 0 ? Math.min(100, Math.round(fl3.val / eq.fib.high * 100)) : 0;
        html += '<div class="fib-level"><span class="pct">' + fl3.label.split(' ')[0] + '</span>';
        html += '<div class="bar"><div class="fill" style="width:' + pct + '%;background:' + fl3.c + '40;"></div></div>';
        html += '<span class="val" style="color:' + fl3.c + ';">' + fl3.val + '</span></div>';
      });

      // Indicators row
      html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:10px;">';
      var curPos = eq.fib.range > 0 ? Math.round((eq.fib.current - eq.fib.low) / eq.fib.range * 100) : 50;
      var lastRSI = eqRSI.length > 0 ? Math.round(eqRSI[eqRSI.length-1]) : 50;
      html += '<div style="background:#0a1520;padding:5px;text-align:center;"><div style="color:#4a6a8a;font-size:0.5em;">CURRENT</div><div style="color:' + eq.color + ';font-family:Orbitron;font-size:0.75em;">' + eq.fib.current + '</div></div>';
      html += '<div style="background:#0a1520;padding:5px;text-align:center;"><div style="color:#4a6a8a;font-size:0.5em;">RETRACEMENT</div><div style="color:' + (curPos > 61.8 ? '#00ff66' : curPos > 38.2 ? '#ffd700' : '#ff4757') + ';font-family:Orbitron;font-size:0.75em;">' + curPos + '%</div></div>';
      html += '<div style="background:#0a1520;padding:5px;text-align:center;"><div style="color:#4a6a8a;font-size:0.5em;">RSI</div><div style="color:' + (lastRSI > 70 ? '#ff4757' : lastRSI < 30 ? '#00ff66' : '#ff9f43') + ';font-family:Orbitron;font-size:0.75em;">' + lastRSI + '</div></div>';
      html += '<div style="background:#0a1520;padding:5px;text-align:center;"><div style="color:#4a6a8a;font-size:0.5em;">FORECAST</div><div style="color:#ff9f43;font-family:Orbitron;font-size:0.75em;">~' + (eqForecast.length > 0 ? eqForecast[0].blended : '?') + '</div></div>';
      html += '</div></div>';
    });
    html += '</div></div>';

    // ====================================================================
    // SECTION 6: SEASONAL DEMAND PREDICTION
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#55f7d8;--gc:#55f7d8;"><span class="dot" style="background:#55f7d8;"></span>SEASONAL DEMAND PREDICTION ENGINE</div>';

    html += '<div class="chart-box">';
    html += '<div class="chart-title" style="color:#55f7d8;margin-bottom:12px;">PREDICTED MONTHLY DEMAND BY EQUIPMENT TYPE (Historical Avg)</div>';
    var seasonMax = 0;
    for (var sm = 1; sm <= 12; sm++) { var sa = seasonAvg[sm] || {}; var stotal = (sa.mower||0)+(sa.snow||0)+(sa.generator||0)+(sa.other||0); if (stotal > seasonMax) seasonMax = stotal; }
    html += '<div style="display:flex;align-items:flex-end;gap:6px;height:200px;margin-bottom:8px;">';
    for (var sm2 = 1; sm2 <= 12; sm2++) {
      var sa2 = seasonAvg[sm2] || {}; var stot = (sa2.mower||0)+(sa2.snow||0)+(sa2.generator||0)+(sa2.other||0);
      var mH = seasonMax > 0 ? Math.round((sa2.mower||0) / seasonMax * 100) : 0;
      var sH = seasonMax > 0 ? Math.round((sa2.snow||0) / seasonMax * 100) : 0;
      var gH = seasonMax > 0 ? Math.round((sa2.generator||0) / seasonMax * 100) : 0;
      var oH = seasonMax > 0 ? Math.round((sa2.other||0) / seasonMax * 100) : 0;
      var isNow = sm2 === curMonth + 1;
      html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;' + (isNow ? 'background:rgba(85,247,216,0.08);border:1px solid #55f7d820;' : '') + '">';
      html += '<div style="color:#c0d8f0;font-size:0.5em;margin-bottom:2px;">' + stot + '</div>';
      html += '<div style="width:70%;display:flex;flex-direction:column;">';
      if (oH > 0) html += '<div style="height:' + oH + 'px;background:#4a6a8a40;min-height:1px;"></div>';
      if (gH > 0) html += '<div style="height:' + gH + 'px;background:#ff9f4380;min-height:1px;"></div>';
      if (sH > 0) html += '<div style="height:' + sH + 'px;background:#00d4ff80;min-height:1px;"></div>';
      if (mH > 0) html += '<div style="height:' + mH + 'px;background:#00ff6680;min-height:1px;"></div>';
      html += '</div>';
      html += '<div style="font-family:Orbitron;font-size:0.4em;color:' + (isNow ? '#55f7d8' : '#4a6a8a') + ';margin-top:4px;' + (isNow ? 'font-weight:900;' : '') + '">' + monthLabels3[sm2] + '</div></div>';
    }
    html += '</div>';
    html += '<div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">';
    html += '<span style="color:#00ff66;font-size:0.75em;">â— Mowers</span><span style="color:#00d4ff;font-size:0.75em;">â— Snow Blowers</span><span style="color:#ff9f43;font-size:0.75em;">â— Generators</span><span style="color:#4a6a8a;font-size:0.75em;">â— Other</span>';
    html += '</div>';

    // Next 3 month prediction cards
    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;">';
    for (var nm = 1; nm <= 3; nm++) {
      var nextMo = (curMonth + nm) % 12 + 1;
      var nsa = seasonAvg[nextMo] || {};
      var nTotal = (nsa.mower||0)+(nsa.snow||0)+(nsa.generator||0)+(nsa.other||0);
      var dColor = nm === 1 ? '#55f7d8' : nm === 2 ? '#00d4ff' : '#a855f7';
      html += '<div style="background:' + dColor + '05;border:1px solid ' + dColor + '20;padding:14px;text-align:center;">';
      html += '<div style="font-family:Orbitron;font-size:0.55em;color:' + dColor + ';letter-spacing:2px;">' + monthLabels3[nextMo].toUpperCase() + ' PREDICTION</div>';
      html += '<div style="font-family:Orbitron;font-size:1.6em;color:' + dColor + ';font-weight:900;margin:5px 0;">~' + nTotal + '</div>';
      html += '<div style="font-size:0.75em;color:#4a6a8a;">ðŸ”§ ' + (nsa.mower||0) + ' &bull; â„ï¸ ' + (nsa.snow||0) + ' &bull; âš¡ ' + (nsa.generator||0) + '</div>';
      html += '</div>';
    }
    html += '</div></div>';

    // Day of Week pattern
    html += '<div class="chart-box">';
    html += '<div class="chart-title" style="color:#55f7d8;margin-bottom:10px;">DEMAND BY DAY OF WEEK (from recent bookings)</div>';
    var dowMax = Math.max.apply(null, dowCounts);
    html += '<div style="display:flex;align-items:flex-end;gap:8px;height:80px;">';
    dowCounts.forEach(function(v, i) {
      var h = dowMax > 0 ? Math.max(3, Math.round(v / dowMax * 100)) : 3;
      var pct = dowTotal > 0 ? Math.round(v / dowTotal * 100) : 0;
      html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;">';
      html += '<div style="color:#c0d8f0;font-size:0.6em;">' + v + ' (' + pct + '%)</div>';
      html += '<div style="width:80%;height:' + h + '%;background:#55f7d840;border-top:2px solid #55f7d8;"></div>';
      html += '<div style="font-family:Orbitron;font-size:0.45em;color:#4a6a8a;margin-top:4px;">' + dowLabels[i] + '</div></div>';
    });
    html += '</div></div></div>';

    // ====================================================================
    // SECTION 7: CITY GROWTH FORECASTING â€” MINI FIBONACCI CHARTS
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#a855f7;--gc:#a855f7;"><span class="dot" style="background:#a855f7;"></span>CITY GROWTH FORECASTING â€” ' + cityForecasts.length + ' MARKETS</div>';

    // Top city mini-fib cards (show top 12)
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:12px;margin-bottom:15px;">';
    cityForecasts.slice(0, 12).forEach(function(cf) {
      var cfColor = cf.growth.mom > 10 ? '#00ff66' : cf.growth.mom > 0 ? '#00d4ff' : cf.growth.mom > -10 ? '#ff9f43' : '#ff4757';
      html += '<div class="fib-card" style="padding:14px;">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
      html += '<div><span style="color:#c0d8f0;font-weight:700;font-size:0.95em;">' + cf.city + '</span>';
      html += '<span style="color:#4a6a8a;font-size:0.75em;margin-left:8px;">' + cf.total + ' total</span></div>';
      html += '<span style="color:' + cfColor + ';font-family:Orbitron;font-size:0.65em;">' + (cf.growth.mom >= 0 ? '+' : '') + cf.growth.mom + '%</span></div>';

      // Mini sparkline with forecast
      var cfMax = Math.max.apply(null, cf.values.length > 0 ? cf.values : [1]);
      if (cf.forecast.length > 0) cfMax = Math.max(cfMax, cf.forecast[0].upper || cf.forecast[0].blended);
      html += '<div style="display:flex;align-items:flex-end;gap:1px;height:40px;margin-bottom:6px;">';
      cf.values.forEach(function(v) {
        var h = cfMax > 0 ? Math.max(1, Math.round(v / cfMax * 100)) : 1;
        html += '<div style="flex:1;height:' + h + '%;background:' + cfColor + '50;min-height:1px;"></div>';
      });
      cf.forecast.slice(0, 3).forEach(function(f) {
        var h2 = cfMax > 0 ? Math.max(1, Math.round(f.blended / cfMax * 100)) : 1;
        html += '<div style="flex:1;height:' + h2 + '%;border-top:1px dashed #ff9f4380;min-height:1px;"></div>';
      });
      html += '</div>';

      // Fib meter
      var cfPos = cf.fib.range > 0 ? Math.min(100, Math.round((cf.current - cf.fib.low) / cf.fib.range * 100)) : 50;
      html += '<div style="height:4px;background:#0a1520;position:relative;margin-bottom:6px;">';
      html += '<div style="height:100%;width:' + cfPos + '%;background:linear-gradient(90deg,' + cfColor + '80,' + cfColor + ');"></div>';
      html += '</div>';

      // Stats row
      html += '<div style="display:flex;justify-content:space-between;font-size:0.7em;">';
      html += '<span style="color:#4a6a8a;">Now: <strong style="color:#c0d8f0;">' + cf.current + '</strong></span>';
      html += '<span style="color:#4a6a8a;">Pred: <strong style="color:#ff9f43;">~' + cf.predicted + '</strong></span>';
      html += '<span style="color:#4a6a8a;">RSI: <strong style="color:' + (cf.rsi > 70 ? '#ff4757' : cf.rsi < 30 ? '#00ff66' : '#ff9f43') + ';">' + Math.round(cf.rsi) + '</strong></span>';
      html += '<span style="color:#4a6a8a;">Fib: <strong style="color:' + (cfPos > 61.8 ? '#00ff66' : cfPos > 38.2 ? '#ffd700' : '#ff4757') + ';">' + cfPos + '%</strong></span>';
      html += '</div>';

      // Signal
      var cSignal = '';
      if (cf.growth.mom > 20 && cf.rsi < 70) cSignal = '<span class="pill pill-green">ðŸš€ BREAKOUT</span>';
      else if (cf.growth.mom > 5) cSignal = '<span class="pill pill-green">â–² GROW</span>';
      else if (cf.growth.mom > -5) cSignal = '<span class="pill pill-orange">â–º STABLE</span>';
      else if (cf.rsi < 30) cSignal = '<span class="pill pill-blue">ðŸ’Ž OVERSOLD</span>';
      else cSignal = '<span class="pill pill-red">â–¼ DECLINE</span>';
      if (cf.volatility > 40) cSignal += ' <span class="pill pill-purple">âš¡ VOLATILE</span>';
      html += '<div style="margin-top:4px;">' + cSignal + '</div>';
      html += '</div>';
    });
    html += '</div>';

    // Full data table
    html += '<div style="overflow-x:auto;"><table class="data-table">';
    html += '<thead><tr><th>City</th><th>Total</th><th>Current</th><th>Predicted</th><th>MoM</th><th>RSI</th><th>Volatility</th><th>Fib Pos</th><th>RÂ²</th><th>Signal</th></tr></thead><tbody>';
    cityForecasts.slice(0, 30).forEach(function(cf2) {
      var cfPos2 = cf2.fib.range > 0 ? Math.round((cf2.current - cf2.fib.low) / cf2.fib.range * 100) : 50;
      var signal2 = cf2.growth.mom > 20 ? '<span class="pill pill-green">ðŸš€ BREAKOUT</span>' : cf2.growth.mom > 5 ? '<span class="pill pill-green">â–² GROW</span>' : cf2.growth.mom > -5 ? '<span class="pill pill-orange">â–º STABLE</span>' : '<span class="pill pill-red">â–¼ DECLINE</span>';
      html += '<tr><td style="color:#c0d8f0;font-weight:700;white-space:nowrap;">' + cf2.city + '</td><td style="color:#00d4ff;">' + cf2.total + '</td><td>' + cf2.current + '</td><td style="color:#ff9f43;font-weight:700;">~' + cf2.predicted + '</td><td style="color:' + (cf2.growth.mom >= 0 ? '#00ff66' : '#ff4757') + ';">' + (cf2.growth.mom >= 0 ? '+' : '') + cf2.growth.mom + '%</td><td style="color:' + (cf2.rsi > 70 ? '#ff4757' : cf2.rsi < 30 ? '#00ff66' : '#4a6a8a') + ';">' + Math.round(cf2.rsi) + '</td><td>' + cf2.volatility + '%</td><td style="color:' + (cfPos2 > 61.8 ? '#00ff66' : cfPos2 > 38.2 ? '#ffd700' : '#ff4757') + ';">' + cfPos2 + '%</td><td style="color:' + (cf2.r2 > 0.5 ? '#00ff66' : '#4a6a8a') + ';">' + cf2.r2 + '</td><td>' + signal2 + '</td></tr>';
    });
    html += '</tbody></table></div></div>';

    // ====================================================================
    // SECTION 8: TECH PRODUCTIVITY + WORKFORCE FIBONACCI
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#00d4ff;--gc:#00d4ff;"><span class="dot" style="background:#00d4ff;"></span>TECH PRODUCTIVITY & WORKFORCE FIBONACCI</div>';

    // Workforce KPIs
    var totalTechJobs = techProd.reduce(function(s, t) { return s + t.total; }, 0);
    var totalTechRev = techProd.reduce(function(s, t) { return s + t.revenue; }, 0);
    var avgJobsPerTech = techProd.length > 0 ? Math.round(totalTechJobs / techProd.length) : 0;
    var hasJobData = techProd.length > 0 && techProd[0].total > 0;
    var avgCompletion = hasJobData ? Math.round(techProd.reduce(function(s,t){return s+t.rate;},0) / techProd.length * 10) / 10 : 0;
    var techRevVals = techProd.map(function(t){return t.revenue;});
    var techRevFib = calcFib(techRevVals);
    var revenuePerTech = techProd.length > 0 ? Math.round(totalTechRev / techProd.length) : 0;

    html += '<div class="kpi-row">';
    html += '<div class="kpi" style="--c:#00d4ff;"><div class="kpi-label">ACTIVE TECHS</div><div class="kpi-val">' + techProd.length + '</div><div class="kpi-sub">' + (hasJobData ? totalTechJobs + ' total jobs' : '$' + totalTechRev.toLocaleString() + ' total payouts') + '</div></div>';
    html += '<div class="kpi" style="--c:#00ff66;"><div class="kpi-label">' + (hasJobData ? 'AVG JOBS/TECH' : 'HIGHEST PAYOUT') + '</div><div class="kpi-val">' + (hasJobData ? avgJobsPerTech : '$' + (techProd.length > 0 ? techProd[0].revenue.toLocaleString() : '0')) + '</div><div class="kpi-sub">Fib high: $' + techRevFib.high.toLocaleString() + '</div></div>';
    html += '<div class="kpi" style="--c:#ffd700;"><div class="kpi-label">' + (hasJobData ? 'AVG COMPLETION' : 'FIB SUPPORT') + '</div><div class="kpi-val">' + (hasJobData ? avgCompletion + '%' : '$' + techRevFib['38.2'].toLocaleString()) + '</div><div class="kpi-sub">Fib 38.2%-61.8%: $' + techRevFib['38.2'].toLocaleString() + '-$' + techRevFib['61.8'].toLocaleString() + '</div></div>';
    html += '<div class="kpi" style="--c:#a855f7;"><div class="kpi-label">AVG REV / TECH</div><div class="kpi-val">$' + revenuePerTech.toLocaleString() + '</div><div class="kpi-sub">' + (hasJobData ? 'Estimated from jobs' : 'From payout data') + '</div></div>';
    html += '</div>';

    if (techProd.length > 0) {
      html += '<div style="overflow-x:auto;"><table class="data-table">';
      if (hasJobData) {
        html += '<thead><tr><th>Tech</th><th>Total</th><th>Done</th><th>Rate</th><th>Cancel%</th><th>Return%</th><th>Jobs/Day</th><th>Est Rev</th><th>Markets</th><th>Efficiency</th></tr></thead><tbody>';
        techProd.forEach(function(tp) {
          var rateColor = tp.rate > 50 ? '#00ff66' : tp.rate > 20 ? '#ff9f43' : '#ff4757';
          var effScore = Math.round(tp.efficiency * 10) / 10;
          var effColor = effScore > techProd[0].efficiency * 0.7 ? '#00ff66' : effScore > techProd[0].efficiency * 0.3 ? '#ff9f43' : '#ff4757';
          html += '<tr><td style="color:#c0d8f0;font-weight:700;">' + tp.name + '</td><td style="color:#00d4ff;">' + tp.total + '</td><td>' + tp.completed + '</td><td style="color:' + rateColor + ';font-weight:700;">' + tp.rate + '%</td><td style="color:' + (tp.cancelRate > 20 ? '#ff4757' : '#4a6a8a') + ';">' + tp.cancelRate + '%</td><td style="color:' + (tp.returnRate > 5 ? '#00ff66' : '#4a6a8a') + ';">' + tp.returnRate + '%</td><td>' + tp.jobsPerDay + '</td><td style="color:#00ff66;">$' + tp.revenue.toLocaleString() + '</td><td>' + tp.locations + '</td><td style="color:' + effColor + ';">' + effScore + '</td></tr>';
        });
      } else {
        // Payout-only view
        html += '<thead><tr><th>Tech</th><th>Payout</th><th>% of Total</th><th>Fib Position</th><th>Status</th></tr></thead><tbody>';
        techProd.forEach(function(tp) {
          var pctOfTotal = totalTechRev > 0 ? Math.round(tp.revenue / totalTechRev * 1000) / 10 : 0;
          var fibPos = techRevFib.range > 0 ? Math.round((tp.revenue - techRevFib.low) / techRevFib.range * 100) : 50;
          var signal = fibPos > 61.8 ? '<span class="pill pill-green">TOP EARNER</span>' : fibPos > 38.2 ? '<span class="pill pill-orange">MID RANGE</span>' : '<span class="pill pill-red">LOW</span>';
          html += '<tr><td style="color:#c0d8f0;font-weight:700;">' + tp.name + '</td><td style="color:#00ff66;font-weight:700;">$' + tp.revenue.toLocaleString() + '</td><td>' + pctOfTotal + '%</td><td style="color:' + (fibPos > 61.8 ? '#00ff66' : fibPos > 38.2 ? '#ffd700' : '#ff4757') + ';">' + fibPos + '%</td><td>' + signal + '</td></tr>';
        });
      }
      html += '</tbody></table></div>';
    }
    html += '</div>';

    // ====================================================================
    // SECTION 9: CANCELLATION & CHURN FIBONACCI
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#ff4757;--gc:#ff4757;"><span class="dot" style="background:#ff4757;"></span>CANCELLATION RISK & CHURN FIBONACCI</div>';

    html += '<div class="kpi-row">';
    html += '<div class="kpi" style="--c:#ff4757;"><div class="kpi-label">OVERALL CANCEL RATE</div><div class="kpi-val">' + overallCancelRate + '%</div><div class="kpi-sub">' + (bm.totalCancelled || 0) + ' of ' + (bm.totalLeads || 0) + '</div></div>';
    html += '<div class="kpi" style="--c:#ff9f43;"><div class="kpi-label">REVENUE AT RISK</div><div class="kpi-val">$' + ((bm.totalCancelled || 0) * revenuePerCall).toLocaleString() + '</div><div class="kpi-sub">Lost from cancellations</div></div>';
    html += '<div class="kpi" style="--c:#00ff66;"><div class="kpi-label">RECOVERY TARGET</div><div class="kpi-val">$' + Math.round((bm.totalCancelled || 0) * revenuePerCall * 0.15).toLocaleString() + '</div><div class="kpi-sub">15% rebook potential</div></div>';
    html += '<div class="kpi" style="--c:#00d4ff;"><div class="kpi-label">CONVERSION RATE</div><div class="kpi-val">' + (bm.conversionRate || 0) + '%</div><div class="kpi-sub">Lead â†’ Completed</div></div>';
    html += '</div>';

    if (cancelByCitySorted.length > 0) {
      html += '<div style="font-family:Orbitron;font-size:0.55em;color:#4a6a8a;letter-spacing:3px;margin-bottom:8px;">HIGHEST CANCEL RATES BY CITY (min 5 jobs)</div>';
      html += '<div style="overflow-x:auto;"><table class="data-table">';
      html += '<thead><tr><th>City</th><th>Total</th><th>Cancelled</th><th>Rate</th><th>Risk</th><th>$ Lost</th></tr></thead><tbody>';
      cancelByCitySorted.slice(0, 15).forEach(function(cc) {
        var risk = cc[1].rate > 30 ? '<span class="pill pill-red">HIGH</span>' : cc[1].rate > 15 ? '<span class="pill pill-orange">MED</span>' : '<span class="pill pill-green">LOW</span>';
        html += '<tr><td style="color:#c0d8f0;font-weight:700;">' + cc[0] + '</td><td>' + cc[1].total + '</td><td style="color:#ff4757;">' + cc[1].cancelled + '</td><td style="color:' + (cc[1].rate > 25 ? '#ff4757' : '#ff9f43') + ';font-weight:700;">' + cc[1].rate + '%</td><td>' + risk + '</td><td style="color:#ff4757;">$' + (cc[1].cancelled * revenuePerCall).toLocaleString() + '</td></tr>';
      });
      html += '</tbody></table></div>';
    }
    html += '</div>';

    // ====================================================================
    // SECTION 10: EQUIPMENT & BRAND INTELLIGENCE
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#ffd700;--gc:#ffd700;"><span class="dot" style="background:#ffd700;"></span>EQUIPMENT & BRAND FIBONACCI</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px;">';

    // Equipment mix
    html += '<div class="chart-box">';
    html += '<div class="chart-title" style="color:#ffd700;">EQUIPMENT MIX</div>';
    var eqSorted2 = Object.entries(equipStats).sort(function(a,b) { return b[1] - a[1]; });
    var eqTotal2 = eqSorted2.reduce(function(s,e) { return s + e[1]; }, 0);
    eqSorted2.slice(0, 10).forEach(function(eq2) {
      var pct3 = eqTotal2 > 0 ? Math.round(eq2[1] / eqTotal2 * 1000) / 10 : 0;
      html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">';
      html += '<div style="width:110px;text-align:right;color:#c0d8f0;font-size:0.8em;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + eq2[0] + '</div>';
      html += '<div style="flex:1;height:16px;background:#0a1520;"><div style="height:100%;width:' + pct3 + '%;background:linear-gradient(90deg,#ffd70040,#ffd70020);border-left:3px solid #ffd700;"></div></div>';
      html += '<div style="width:70px;text-align:right;color:#ffd700;font-size:0.75em;">' + eq2[1] + ' (' + pct3 + '%)</div></div>';
    });
    html += '</div>';

    // Brand mix
    html += '<div class="chart-box">';
    html += '<div class="chart-title" style="color:#a855f7;">BRAND MIX</div>';
    brandSorted.slice(0, 10).forEach(function(br) {
      var pct4 = brandTotal > 0 ? Math.round(br[1] / brandTotal * 1000) / 10 : 0;
      html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">';
      html += '<div style="width:110px;text-align:right;color:#c0d8f0;font-size:0.8em;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + br[0] + '</div>';
      html += '<div style="flex:1;height:16px;background:#0a1520;"><div style="height:100%;width:' + pct4 + '%;background:linear-gradient(90deg,#a855f740,#a855f720);border-left:3px solid #a855f7;"></div></div>';
      html += '<div style="width:70px;text-align:right;color:#a855f7;font-size:0.75em;">' + br[1] + ' (' + pct4 + '%)</div></div>';
    });
    html += '</div></div></div>';

    // ====================================================================
    // SECTION 11: GROWTH MILESTONES & PROJECTIONS
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#55f7d8;--gc:#55f7d8;"><span class="dot" style="background:#55f7d8;"></span>GROWTH MILESTONES & PROJECTIONS</div>';

    var totalCallsEver = monthVals.reduce(function(a,b){return a+b;}, 0);
    var avgMonthCalls = monthKeys.length > 0 ? Math.round(totalCallsEver / monthKeys.length) : 0;
    var recentAvg = monthVals.length >= 3 ? Math.round(monthVals.slice(-3).reduce(function(a,b){return a+b;},0) / 3) : avgMonthCalls;
    var milestones = [5000, 10000, 15000, 20000, 25000, 50000, 75000, 100000];
    html += '<div class="kpi-row">';
    milestones.forEach(function(ms) {
      if (ms <= totalCallsEver) {
        html += '<div class="kpi" style="--c:#00ff66;"><div class="kpi-label">' + ms.toLocaleString() + ' CALLS</div><div class="kpi-val">âœ…</div><div class="kpi-sub">Achieved</div></div>';
      } else {
        var remaining = ms - totalCallsEver;
        var monthsToGo = recentAvg > 0 ? Math.ceil(remaining / recentAvg) : 99;
        var estDate = new Date(curYear, curMonth + monthsToGo, 1);
        var estStr = monthLabels3[estDate.getMonth() + 1] + ' ' + estDate.getFullYear();
        html += '<div class="kpi" style="--c:#4a6a8a;"><div class="kpi-label">' + ms.toLocaleString() + ' CALLS</div><div class="kpi-val">~' + monthsToGo + 'mo</div><div class="kpi-sub">Est. ' + estStr + '</div></div>';
      }
    });
    html += '</div>';

    // Revenue milestones
    var totalRevEver = (fh.allTime || {}).revenue || 0;
    // Use Square total if higher (more accurate)
    var sqRevTotal = revVals.length > 0 ? revVals.reduce(function(a,b){return a+b;},0) : 0;
    if (sqRevTotal > totalRevEver) totalRevEver = sqRevTotal;
    if (totalRevEver === 0) totalRevEver = (bm.totalLeads || 0) * revenuePerCall;
    var avgMonthRev = revVals.length > 0 ? revVals.reduce(function(a,b){return a+b;},0) / revVals.length : 0;
    var recentRevAvg = revVals.length >= 3 ? revVals.slice(-3).reduce(function(a,b){return a+b;},0) / 3 : avgMonthRev;
    var revMilestones = [250000, 500000, 1000000, 2000000, 5000000, 10000000];
    html += '<div style="font-family:Orbitron;font-size:0.6em;color:#00ff66;letter-spacing:3px;margin:15px 0 8px;">REVENUE MILESTONES</div>';
    html += '<div class="kpi-row">';
    revMilestones.forEach(function(rm) {
      if (rm <= totalRevEver) {
        html += '<div class="kpi" style="--c:#00ff66;"><div class="kpi-label">$' + (rm >= 1000000 ? (rm/1000000) + 'M' : (rm/1000) + 'K') + '</div><div class="kpi-val">âœ…</div><div class="kpi-sub">Achieved</div></div>';
      } else {
        var revRemaining = rm - totalRevEver;
        var mToGo = recentRevAvg > 0 ? Math.ceil(revRemaining / recentRevAvg) : 99;
        html += '<div class="kpi" style="--c:#4a6a8a;"><div class="kpi-label">$' + (rm >= 1000000 ? (rm/1000000) + 'M' : (rm/1000) + 'K') + '</div><div class="kpi-val">~' + mToGo + 'mo</div><div class="kpi-sub">Need $' + Math.round(revRemaining / 1000).toLocaleString() + 'K more</div></div>';
      }
    });
    html += '</div></div>';

    // ====================================================================
    // SECTION 11b: GOOGLE ADS SEARCH INTELLIGENCE
    var adsD = global.adsData || {};
    var searchTerms = adsD.searchTerms || [];
    if (searchTerms.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-head" style="color:#4285f4;--gc:#4285f4;"><span class="dot" style="background:#4285f4;"></span>GOOGLE ADS SEARCH INTELLIGENCE</div>';
      html += '<div class="chart-box">';
      html += '<div class="chart-title" style="color:#4285f4;margin-bottom:10px;">TOP SEARCH TERMS DRIVING LEADS (All Time)</div>';
      
      // Sort by conversions then clicks
      var topTerms = searchTerms.sort(function(a,b) { return (b.conversions||0) - (a.conversions||0) || (b.clicks||0) - (a.clicks||0); }).slice(0, 20);
      var maxClicks = Math.max.apply(null, topTerms.map(function(t){return t.clicks||0;})) || 1;
      
      html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.82em;">';
      html += '<tr style="border-bottom:1px solid #1a2a3a;"><th style="text-align:left;padding:6px;color:#4285f4;font-family:Orbitron;font-size:0.8em;">Search Term</th><th style="text-align:right;padding:6px;color:#4285f4;font-family:Orbitron;font-size:0.8em;">Clicks</th><th style="text-align:right;padding:6px;color:#4285f4;font-family:Orbitron;font-size:0.8em;">Impr</th><th style="text-align:right;padding:6px;color:#4285f4;font-family:Orbitron;font-size:0.8em;">Conv</th><th style="text-align:right;padding:6px;color:#4285f4;font-family:Orbitron;font-size:0.8em;">Cost</th><th style="text-align:right;padding:6px;color:#4285f4;font-family:Orbitron;font-size:0.8em;">CTR</th><th style="padding:6px;width:25%;">Volume</th></tr>';
      
      topTerms.forEach(function(t) {
        var ctr = (t.impressions||0) > 0 ? ((t.clicks||0)/(t.impressions||1)*100).toFixed(1) : '0';
        var barW = Math.max(3, Math.round((t.clicks||0)/maxClicks*100));
        var barColor = (t.conversions||0) > 0 ? '#10b981' : '#4285f4';
        html += '<tr style="border-bottom:1px solid #0a1520;">';
        html += '<td style="padding:6px;color:#c0d8f0;">' + (t.term || '').substring(0,40) + '</td>';
        html += '<td style="text-align:right;padding:6px;color:#4285f4;">' + (t.clicks||0) + '</td>';
        html += '<td style="text-align:right;padding:6px;color:#4a6a8a;">' + (t.impressions||0) + '</td>';
        html += '<td style="text-align:right;padding:6px;color:' + ((t.conversions||0) > 0 ? '#10b981' : '#4a6a8a') + ';">' + Math.round((t.conversions||0)*10)/10 + '</td>';
        html += '<td style="text-align:right;padding:6px;color:#ff4757;">$' + ((t.cost||0)).toFixed(0) + '</td>';
        html += '<td style="text-align:right;padding:6px;color:#f59e0b;">' + ctr + '%</td>';
        html += '<td style="padding:6px;"><div style="height:14px;background:#0a1520;border-radius:3px;overflow:hidden;"><div style="width:' + barW + '%;height:100%;background:' + barColor + '60;border-radius:3px;"></div></div></td>';
        html += '</tr>';
      });
      html += '</table></div>';
      
      // Demand signals from search terms
      html += '<div style="margin-top:15px;padding-top:10px;border-top:1px solid #1a2a3a;">';
      html += '<div class="chart-title" style="color:#4285f4;margin-bottom:8px;">ðŸ” DEMAND SIGNALS FROM SEARCH DATA</div>';
      
      // Categorize search terms
      var mowerTerms = 0, snowTerms = 0, genTerms = 0, repairTerms = 0;
      searchTerms.forEach(function(t) {
        var term = (t.term || '').toLowerCase();
        if (term.includes('mower') || term.includes('lawn') || term.includes('zero turn')) mowerTerms += (t.clicks||0);
        if (term.includes('snow') || term.includes('blower')) snowTerms += (t.clicks||0);
        if (term.includes('generator')) genTerms += (t.clicks||0);
        if (term.includes('repair') || term.includes('fix') || term.includes('service')) repairTerms += (t.clicks||0);
      });
      var totalSearchClicks = mowerTerms + snowTerms + genTerms + repairTerms || 1;
      
      html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">';
      html += '<div style="background:#00ff6610;border:1px solid #00ff6620;padding:10px;text-align:center;"><div style="font-family:Orbitron;font-size:0.5em;color:#4a6a8a;">MOWER DEMAND</div><div style="font-family:Orbitron;font-size:1.2em;color:#00ff66;">' + Math.round(mowerTerms/totalSearchClicks*100) + '%</div><div style="font-size:0.75em;color:#4a6a8a;">' + mowerTerms + ' clicks</div></div>';
      html += '<div style="background:#00d4ff10;border:1px solid #00d4ff20;padding:10px;text-align:center;"><div style="font-family:Orbitron;font-size:0.5em;color:#4a6a8a;">SNOW DEMAND</div><div style="font-family:Orbitron;font-size:1.2em;color:#00d4ff;">' + Math.round(snowTerms/totalSearchClicks*100) + '%</div><div style="font-size:0.75em;color:#4a6a8a;">' + snowTerms + ' clicks</div></div>';
      html += '<div style="background:#ff9f4310;border:1px solid #ff9f4320;padding:10px;text-align:center;"><div style="font-family:Orbitron;font-size:0.5em;color:#4a6a8a;">GENERATOR DEMAND</div><div style="font-family:Orbitron;font-size:1.2em;color:#ff9f43;">' + Math.round(genTerms/totalSearchClicks*100) + '%</div><div style="font-size:0.75em;color:#4a6a8a;">' + genTerms + ' clicks</div></div>';
      html += '<div style="background:#a855f710;border:1px solid #a855f720;padding:10px;text-align:center;"><div style="font-family:Orbitron;font-size:0.5em;color:#4a6a8a;">REPAIR INTENT</div><div style="font-family:Orbitron;font-size:1.2em;color:#a855f7;">' + Math.round(repairTerms/totalSearchClicks*100) + '%</div><div style="font-size:0.75em;color:#4a6a8a;">' + repairTerms + ' clicks</div></div>';
      html += '</div></div>';
      
      html += '</div></div>';
    }

    // SECTION 12: WHAT-IF SCENARIO CALCULATOR
    // ====================================================================
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#ffd700;--gc:#ffd700;"><span class="dot" style="background:#ffd700;"></span>WHAT-IF SCENARIO CALCULATOR</div>';
    html += '<div class="chart-box">';
    html += '<div class="chart-title" style="color:#ffd700;margin-bottom:12px;">GROWTH SCENARIO MODELING</div>';

    var baseRev = recentRevAvg || avgMonthRev || 50000;
    var baseCalls = recentAvg || avgMonthCalls || 300;
    html += '<div style="color:#4a6a8a;font-size:0.8em;margin-bottom:10px;">Base: <span style="color:#ffd700;font-weight:700;">$' + Math.round(baseRev).toLocaleString() + '/mo</span> revenue Â· <span style="color:#ffd700;font-weight:700;">' + Math.round(baseCalls) + '/mo</span> calls (from ' + (sqTotalRev > fhTotalRev ? 'Square' : revMonths.length > 0 ? 'Profit Sheet' : 'estimated') + ' last 3 months avg)</div>';
    var scenarios = [
      { name: 'CONSERVATIVE', callGrowth: 3, revGrowth: 3, color: '#4a6a8a', icon: 'ðŸ¢' },
      { name: 'MODERATE', callGrowth: 8, revGrowth: 8, color: '#ff9f43', icon: 'ðŸ“Š' },
      { name: 'AGGRESSIVE', callGrowth: 15, revGrowth: 15, color: '#00ff66', icon: 'ðŸš€' },
      { name: 'HYPERGROWTH', callGrowth: 25, revGrowth: 25, color: '#a855f7', icon: 'âš¡' },
    ];

    html += '<div style="overflow-x:auto;"><table class="data-table">';
    html += '<thead><tr><th>Scenario</th><th>Mo Growth</th><th>6-Mo Rev</th><th>12-Mo Rev</th><th>12-Mo Calls</th><th>Annual Rev</th></tr></thead><tbody>';
    scenarios.forEach(function(sc) {
      var sixMoRev = 0, twelveMoRev = 0, twelveMoCalls = 0;
      for (var si = 1; si <= 12; si++) {
        var mRev = Math.round(baseRev * Math.pow(1 + sc.revGrowth / 100, si));
        var mCalls = Math.round(baseCalls * Math.pow(1 + sc.callGrowth / 100, si));
        if (si <= 6) sixMoRev += mRev;
        twelveMoRev += mRev;
        if (si === 12) twelveMoCalls = mCalls;
      }
      html += '<tr><td style="color:' + sc.color + ';font-weight:700;">' + sc.icon + ' ' + sc.name + '</td>';
      html += '<td style="color:' + sc.color + ';">+' + sc.callGrowth + '%</td>';
      html += '<td>$' + Math.round(sixMoRev / 1000).toLocaleString() + 'K</td>';
      html += '<td style="color:' + sc.color + ';font-weight:700;">$' + Math.round(twelveMoRev / 1000).toLocaleString() + 'K</td>';
      html += '<td>' + twelveMoCalls.toLocaleString() + '/mo</td>';
      html += '<td style="font-weight:700;">$' + Math.round(twelveMoRev / 1000).toLocaleString() + 'K</td></tr>';
    });
    html += '</tbody></table></div></div></div>';

    // Footer
    html += '<div style="text-align:center;padding:30px;font-family:Orbitron;font-size:0.55em;letter-spacing:3px;color:#1a2a3a;border-top:1px solid #0a1520;">WILDWOOD ANALYTICS ENGINE v2.0 // ' + monthKeys.length + ' months &bull; ' + (bm.totalLeads || 0) + ' records &bull; ' + Object.keys(locationStats).length + ' markets &bull; ' + cityForecasts.length + ' forecasts</div>';

    // ====================================================================
    // LIGHTWEIGHT CHARTS JAVASCRIPT
    // ====================================================================
    html += '<script>';

    // Data injection
    html += 'var callData=' + JSON.stringify(lcCallData) + ';';
    html += 'var forecastData=' + JSON.stringify(lcForecastData) + ';';
    html += 'var revChartData=' + JSON.stringify(lcRevData) + ';';
    html += 'var profChartData=' + JSON.stringify(lcProfData) + ';';
    html += 'var callFib=' + JSON.stringify(callFib) + ';';
    html += 'var revFib=' + JSON.stringify(revFib) + ';';

    // Chart creation - wrapped in load handler
    html += 'window.addEventListener("load",function(){';
    html += 'var chartOpts={layout:{background:{color:"#050d18"},textColor:"#4a6a8a",fontSize:11},grid:{vertLines:{color:"#0a1520"},horzLines:{color:"#0a1520"}},crosshair:{mode:0},timeScale:{borderColor:"#1a2a3a",timeVisible:false},rightPriceScale:{borderColor:"#1a2a3a"}};';

    // Call Volume Interactive Chart
    html += 'var cEl=document.getElementById("call-chart");';
    html += 'var cW=cEl.offsetWidth;';
    html += 'var mainC=LightweightCharts.createChart(cEl,Object.assign({},chartOpts,{width:cW,height:350}));';
    html += 'var mainS=mainC.addLineSeries({color:"#00d4ff",lineWidth:2,title:"Calls"});';
    html += 'mainS.setData(callData);';

    // Forecast line
    html += 'var foreS=mainC.addLineSeries({color:"#ff9f43",lineWidth:2,lineStyle:2,title:"Forecast"});';
    html += 'var foreUpperS=mainC.addLineSeries({color:"#ff9f4320",lineWidth:1,lineStyle:1});';
    html += 'var foreLowerS=mainC.addLineSeries({color:"#ff9f4320",lineWidth:1,lineStyle:1});';
    html += 'if(callData.length>0){var lastPt=callData[callData.length-1];';
    html += 'var fd=[{time:lastPt.time,value:lastPt.value}].concat(forecastData.map(function(d){return{time:d.time,value:d.value};}));';
    html += 'var fu=[{time:lastPt.time,value:lastPt.value}].concat(forecastData.map(function(d){return{time:d.time,value:d.upper};}));';
    html += 'var fl=[{time:lastPt.time,value:lastPt.value}].concat(forecastData.map(function(d){return{time:d.time,value:d.lower};}));';
    html += 'foreS.setData(fd);foreUpperS.setData(fu);foreLowerS.setData(fl);}';

    // BB overlays (hidden by default)
    html += 'var bbUp=mainC.addLineSeries({color:"#ff9f4360",lineWidth:1,lineStyle:2,visible:false});';
    html += 'var bbLo=mainC.addLineSeries({color:"#ff9f4360",lineWidth:1,lineStyle:2,visible:false});';
    html += 'var bbMd=mainC.addLineSeries({color:"#ff9f4330",lineWidth:1,lineStyle:1,visible:false});';
    html += 'var smaS=mainC.addLineSeries({color:"#a855f7",lineWidth:1,visible:false});';
    html += 'var emaS=mainC.addLineSeries({color:"#ffd700",lineWidth:1,visible:false});';

    // Compute BB/SMA/EMA from callData
    html += 'function computeSMA(data,p){var r=[];for(var i=0;i<data.length;i++){if(i<p-1)continue;var s=0;for(var j=0;j<p;j++)s+=data[i-j].value;r.push({time:data[i].time,value:Math.round(s/p*100)/100});}return r;}';
    html += 'function computeEMA(data,p){if(data.length===0)return[];var k=2/(p+1);var r=[{time:data[0].time,value:data[0].value}];for(var i=1;i<data.length;i++){r.push({time:data[i].time,value:Math.round((data[i].value*k+r[i-1].value*(1-k))*100)/100});}return r;}';
    html += 'function computeBB(data,p,std){var u=[],l=[],m=[];for(var i=0;i<data.length;i++){if(i<p-1)continue;var s=0;for(var j=0;j<p;j++)s+=data[i-j].value;var avg=s/p;var sq=0;for(var j2=0;j2<p;j2++)sq+=(data[i-j2].value-avg)*(data[i-j2].value-avg);var sd=Math.sqrt(sq/p);u.push({time:data[i].time,value:Math.round((avg+std*sd)*100)/100});l.push({time:data[i].time,value:Math.round(Math.max(0,avg-std*sd)*100)/100});m.push({time:data[i].time,value:Math.round(avg*100)/100});}return{upper:u,lower:l,middle:m};}';

    html += 'var bbData=computeBB(callData,Math.min(6,callData.length),2);';
    html += 'bbUp.setData(bbData.upper);bbLo.setData(bbData.lower);bbMd.setData(bbData.middle);';
    html += 'smaS.setData(computeSMA(callData,Math.min(6,callData.length)));';
    html += 'emaS.setData(computeEMA(callData,Math.min(6,callData.length)));';

    // Fibonacci lines
    html += 'var fibLines=[];var showFib2=true;';
    html += 'function drawFibLines(){fibLines.forEach(function(fl){try{mainS.removePriceLine(fl);}catch(e){}});fibLines=[];if(!showFib2)return;';
    html += 'var levels={"0%":callFib.low,"23.6%":callFib["23.6"],"38.2%":callFib["38.2"],"50%":callFib["50.0"],"61.8%":callFib["61.8"],"78.6%":callFib["78.6"],"100%":callFib.high};';
    html += 'var colors={"0%":"#ff4757","23.6%":"#ff4757","38.2%":"#ff9f43","50%":"#ffd700","61.8%":"#00ff66","78.6%":"#00ff66","100%":"#00ff66"};';
    html += 'Object.keys(levels).forEach(function(k){var line=mainS.createPriceLine({price:levels[k],color:colors[k]+"60",lineWidth:1,lineStyle:2,axisLabelVisible:true,title:"Fib "+k});fibLines.push(line);});';
    html += '}drawFibLines();';

    // Extension lines (hidden by default)
    html += 'var extLines=[];var showExt=false;';
    html += 'function drawExtLines(){extLines.forEach(function(el){try{mainS.removePriceLine(el);}catch(e){}});extLines=[];if(!showExt)return;';
    html += '["127.2","161.8","200.0","261.8"].forEach(function(k){if(callFib[k]){var l=mainS.createPriceLine({price:callFib[k],color:"#a855f760",lineWidth:1,lineStyle:1,axisLabelVisible:true,title:"Ext "+k+"%"});extLines.push(l);}});';
    html += '}';

    // Toggle functions
    html += 'var overlays={bb:false,sma:false,ema:false,fib:true,ext:false,forecast:true};';
    html += 'window.toggleOverlay=function(id){overlays[id]=!overlays[id];';
    html += 'var el=document.getElementById("btn-"+id+"2");';
    html += 'if(overlays[id]){el.style.background="rgba(0,212,255,0.15)";el.style.color="#00d4ff";el.style.borderColor="#00d4ff40";}';
    html += 'else{el.style.background="#0a1520";el.style.color="#4a6a8a";el.style.borderColor="#1a2a3a";}';
    html += 'bbUp.applyOptions({visible:overlays.bb});bbLo.applyOptions({visible:overlays.bb});bbMd.applyOptions({visible:overlays.bb});';
    html += 'smaS.applyOptions({visible:overlays.sma});emaS.applyOptions({visible:overlays.ema});';
    html += 'showFib2=overlays.fib;drawFibLines();';
    html += 'showExt=overlays.ext;drawExtLines();';
    html += 'foreS.applyOptions({visible:overlays.forecast});foreUpperS.applyOptions({visible:overlays.forecast});foreLowerS.applyOptions({visible:overlays.forecast});';
    html += '}';

    // RSI chart
    html += 'var rsiEl=document.getElementById("call-rsi");';
    html += 'var rsiC=LightweightCharts.createChart(rsiEl,Object.assign({},chartOpts,{width:cW,height:100}));';
    html += 'var rsiS=rsiC.addLineSeries({color:"#a855f7",lineWidth:1.5});';
    html += 'var rsiData=callData.slice(' + Math.min(6, monthVals.length) + ').map(function(d,i){return{time:d.time,value:' + JSON.stringify(callRSI) + '[i]||50};});';
    html += 'rsiS.setData(rsiData);';
    // RSI levels
    html += 'rsiS.createPriceLine({price:70,color:"#ff475740",lineWidth:1,lineStyle:2,title:"Overbought"});';
    html += 'rsiS.createPriceLine({price:30,color:"#00ff6640",lineWidth:1,lineStyle:2,title:"Oversold"});';
    html += 'rsiS.createPriceLine({price:50,color:"#ffd70020",lineWidth:1,lineStyle:1,title:""});';

    // MACD chart
    html += 'var macdEl=document.getElementById("call-macd");';
    html += 'var macdC=LightweightCharts.createChart(macdEl,Object.assign({},chartOpts,{width:cW,height:100}));';
    html += 'var macdLS=macdC.addLineSeries({color:"#00d4ff",lineWidth:1.5,title:"MACD"});';
    html += 'var macdSS=macdC.addLineSeries({color:"#ff9f43",lineWidth:1,title:"Signal"});';
    html += 'var macdHS=macdC.addHistogramSeries({title:"Hist"});';
    html += 'var macdLine2=' + JSON.stringify(callMACD.macdLine) + ';';
    html += 'var macdSig2=' + JSON.stringify(callMACD.signal) + ';';
    html += 'var macdHist2=' + JSON.stringify(callMACD.histogram) + ';';
    html += 'var macdD=callData.map(function(d,i){return{time:d.time,value:macdLine2[i]||0};});';
    html += 'var sigD=callData.map(function(d,i){return{time:d.time,value:macdSig2[i]||0};});';
    html += 'var histD=callData.map(function(d,i){return{time:d.time,value:macdHist2[i]||0,color:(macdHist2[i]||0)>=0?"#26a69a80":"#ef535080"};});';
    html += 'macdLS.setData(macdD);macdSS.setData(sigD);macdHS.setData(histD);';

    // Revenue chart
    html += 'if(revChartData.length>1){';
    html += 'var rEl=document.getElementById("rev-chart");';
    html += 'var revC=LightweightCharts.createChart(rEl,Object.assign({},chartOpts,{width:rEl.offsetWidth,height:300}));';
    html += 'var revS=revC.addLineSeries({color:"#00ff66",lineWidth:2,title:"Revenue"});';
    html += 'var profS=revC.addLineSeries({color:"#ffd700",lineWidth:2,title:"Profit"});';
    html += 'revS.setData(revChartData);profS.setData(profChartData);';
    // Rev fib lines
    html += '["38.2","50.0","61.8"].forEach(function(k){if(revFib[k]){revS.createPriceLine({price:revFib[k],color:k==="38.2"?"#ff475730":k==="50.0"?"#ffd70030":"#00ff6630",lineWidth:1,lineStyle:2,axisLabelVisible:true,title:"Fib "+k+"%"});}});';
    html += 'revC.timeScale().fitContent();}';

    // Sync crosshairs
    html += 'mainC.timeScale().fitContent();rsiC.timeScale().fitContent();macdC.timeScale().fitContent();';

    // Resize handler
    html += 'window.addEventListener("resize",function(){';
    html += 'var w=document.getElementById("call-chart").offsetWidth;';
    html += 'mainC.applyOptions({width:w});rsiC.applyOptions({width:w});macdC.applyOptions({width:w});';
    html += 'if(typeof revC!=="undefined"){revC.applyOptions({width:document.getElementById("rev-chart").offsetWidth});}';
    html += '});'; // close resize handler
    html += '});'; // close window load handler

    html += '<\/script>';
    html += '</div></body></html>';
    res.send(html);
  } catch (err) {
    console.error("Analytics error:", err.stack || err.message);
    res.status(500).json({ error: err.message });
  }
});



/* ===========================
   GOOGLE ADS API INTEGRATION
   OAuth2, Data Fetching, Analytics, Fibonacci, Forecasting
=========================== */

// Google Ads config
var GOOGLE_ADS_DEVELOPER_TOKEN = process.env.GOOGLE_ADS_DEVELOPER_TOKEN || '';
var GOOGLE_ADS_CUSTOMER_ID = (process.env.GOOGLE_ADS_CUSTOMER_ID || '').replace(/-/g, '');
var GOOGLE_ADS_MANAGER_ID = (process.env.GOOGLE_ADS_MANAGER_ID || '').replace(/-/g, '');
var GOOGLE_ADS_CLIENT_ID = process.env.GOOGLE_ADS_CLIENT_ID || '';
var GOOGLE_ADS_CLIENT_SECRET = process.env.GOOGLE_ADS_CLIENT_SECRET || '';
var GOOGLE_ADS_REFRESH_TOKEN = process.env.GOOGLE_ADS_REFRESH_TOKEN || '';

// In-memory token storage
var adsTokenStore = {
  accessToken: null,
  refreshToken: GOOGLE_ADS_REFRESH_TOKEN,
  expiresAt: 0,
};

// Ads data cache (5 min)
var adsCache = { data: null, time: 0 };
var ADS_CACHE_TTL = 300000;

console.log("Google Ads Config: " + (GOOGLE_ADS_DEVELOPER_TOKEN ? "Token âœ“" : "Token âœ—") + " | " + (GOOGLE_ADS_CUSTOMER_ID ? "CID: " + GOOGLE_ADS_CUSTOMER_ID : "CID âœ—") + " | " + (GOOGLE_ADS_MANAGER_ID ? "MCC: " + GOOGLE_ADS_MANAGER_ID : "MCC âœ—"));

/* ===========================
   GOOGLE ADS â€” OAuth2 Flow
   User must create OAuth2 Web credentials in Cloud Console
   and set GOOGLE_ADS_CLIENT_ID + GOOGLE_ADS_CLIENT_SECRET
=========================== */

// Step 1: Redirect to Google consent
app.get('/ads/auth', function(req, res) {
  if (!GOOGLE_ADS_CLIENT_ID) {
    return res.send('<html><body style="background:#050d18;color:#ff4757;font-family:monospace;padding:40px;"><h2>Missing GOOGLE_ADS_CLIENT_ID</h2><p>Go to console.cloud.google.com â†’ APIs & Credentials â†’ Create OAuth 2.0 Client ID (Web Application)</p><p>Add redirect URI: <code>' + 'https://' + req.get('host') + '/ads/callback</code></p><p>Then add to Render env vars:<br>GOOGLE_ADS_CLIENT_ID=your_client_id<br>GOOGLE_ADS_CLIENT_SECRET=your_client_secret</p></body></html>');
  }
  var redirectUri = 'https://' + req.get('host') + '/ads/callback';
  var authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
    'client_id=' + encodeURIComponent(GOOGLE_ADS_CLIENT_ID) +
    '&redirect_uri=' + encodeURIComponent(redirectUri) +
    '&response_type=code' +
    '&scope=' + encodeURIComponent('https://www.googleapis.com/auth/adwords') +
    '&access_type=offline' +
    '&prompt=consent';
  res.redirect(authUrl);
});

// Step 2: Exchange code for tokens
app.get('/ads/callback', async function(req, res) {
  var code = req.query.code;
  if (!code) return res.send('Missing code parameter');
  try {
    var redirectUri = 'https://' + req.get('host') + '/ads/callback';
    var tokenRes = await fetch('https://oauth2.googleapis.com/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'client_id=' + encodeURIComponent(GOOGLE_ADS_CLIENT_ID) +
        '&client_secret=' + encodeURIComponent(GOOGLE_ADS_CLIENT_SECRET) +
        '&code=' + encodeURIComponent(code) +
        '&grant_type=authorization_code' +
        '&redirect_uri=' + encodeURIComponent(redirectUri),
    });
    var tokenData = await tokenRes.json();
    if (tokenData.error) {
      return res.send('<pre>Error: ' + JSON.stringify(tokenData) + '</pre>');
    }
    adsTokenStore.accessToken = tokenData.access_token;
    adsTokenStore.refreshToken = tokenData.refresh_token || adsTokenStore.refreshToken;
    adsTokenStore.expiresAt = Date.now() + (tokenData.expires_in * 1000);
    
    var html = '<html><body style="background:#050d18;color:#00ff66;font-family:monospace;padding:40px;">';
    html += '<h2>âœ… Google Ads Connected!</h2>';
    html += '<p>Access Token: âœ“</p>';
    html += '<p>Refresh Token: ' + (adsTokenStore.refreshToken ? 'âœ“ (save this to Render!)' : 'âœ—') + '</p>';
    if (adsTokenStore.refreshToken) {
      html += '<p style="background:#0a1520;padding:15px;border:1px solid #00ff6640;word-break:break-all;"><strong>GOOGLE_ADS_REFRESH_TOKEN=</strong>' + adsTokenStore.refreshToken + '</p>';
      html += '<p style="color:#ff9f43;">âš ï¸ Copy this refresh token and add it to your Render environment variables so it persists across restarts.</p>';
    }
    html += '<p><a href="/ads" style="color:#00d4ff;">â†’ Go to Ads Dashboard</a></p>';
    html += '</body></html>';
    res.send(html);
  } catch (err) {
    res.send('<pre>OAuth Error: ' + err.message + '</pre>');
  }
});

// Helper: Get valid access token (refresh if expired)
async function getAdsAccessToken() {
  if (adsTokenStore.accessToken && Date.now() < adsTokenStore.expiresAt - 60000) {
    return adsTokenStore.accessToken;
  }
  if (!adsTokenStore.refreshToken) return null;
  if (!GOOGLE_ADS_CLIENT_ID || !GOOGLE_ADS_CLIENT_SECRET) return null;
  
  try {
    var res = await fetch('https://oauth2.googleapis.com/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'client_id=' + encodeURIComponent(GOOGLE_ADS_CLIENT_ID) +
        '&client_secret=' + encodeURIComponent(GOOGLE_ADS_CLIENT_SECRET) +
        '&refresh_token=' + encodeURIComponent(adsTokenStore.refreshToken) +
        '&grant_type=refresh_token',
    });
    var data = await res.json();
    if (data.access_token) {
      adsTokenStore.accessToken = data.access_token;
      adsTokenStore.expiresAt = Date.now() + (data.expires_in * 1000);
      return data.access_token;
    }
    console.log("Ads token refresh failed:", data);
    return null;
  } catch (err) {
    console.log("Ads token refresh error:", err.message);
    return null;
  }
}

// Helper: Execute Google Ads Query Language (GAQL) query
async function executeGAQL(query, customerId) {
  var token = await getAdsAccessToken();
  if (!token) return null;
  var cid = customerId || GOOGLE_ADS_CUSTOMER_ID;
  if (!cid) return null;
  
  try {
    var headers = {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token,
      'developer-token': GOOGLE_ADS_DEVELOPER_TOKEN,
    };
    if (GOOGLE_ADS_MANAGER_ID) {
      headers['login-customer-id'] = GOOGLE_ADS_MANAGER_ID;
    }
    
    var res = await fetch('https://googleads.googleapis.com/v23/customers/' + cid + '/googleAds:search', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({ query: query }),
    });
    var rawText = await res.text();
    var data;
    try { data = JSON.parse(rawText); } catch(pe) {
      console.log("GAQL Parse Error:", rawText.substring(0, 300));
      return null;
    }
    if (data.error) {
      console.log("GAQL Error [" + res.status + "]:", JSON.stringify(data.error).substring(0, 500));
      return null;
    }
    // search returns {results:[...]} or array of batches
    var results = [];
    if (Array.isArray(data)) {
      data.forEach(function(batch) {
        if (batch.results) results = results.concat(batch.results);
      });
    } else if (data.results) {
      results = data.results;
    }
    console.log("GAQL returned " + results.length + " results for: " + query.substring(0, 60) + "...");
    return results;
  } catch (err) {
    console.log("GAQL fetch error:", err.message);
    return null;
  }
}

/* ===========================
   BUILD ADS CONTEXT â€” Pull All Data
=========================== */

async function buildAdsContext() {
  // Check cache
  if (adsCache.data && (Date.now() - adsCache.time) < ADS_CACHE_TTL) return adsCache.data;
  
  var result = {
    connected: false,
    needsAuth: false,
    campaigns: [],
    adGroups: [],
    keywords: [],
    searchTerms: [],
    geoPerformance: [],
    devicePerformance: [],
    hourlyPerformance: [],
    dayOfWeekPerformance: [],
    monthlyPerformance: [],
    weeklyPerformance: [],
    dailyPerformance: [],
    conversionActions: [],
    accountSummary: {},
    errors: [],
  };
  
  // Check if configured
  if (!GOOGLE_ADS_DEVELOPER_TOKEN || !GOOGLE_ADS_CUSTOMER_ID) {
    result.errors.push("Missing GOOGLE_ADS_DEVELOPER_TOKEN or GOOGLE_ADS_CUSTOMER_ID");
    return result;
  }
  
  var token = await getAdsAccessToken();
  if (!token) {
    result.needsAuth = true;
    result.errors.push("No valid access token. Visit /ads/auth to connect.");
    adsCache.data = result;
    adsCache.time = Date.now();
    return result;
  }
  
  result.connected = true;
  
  // ====== 1. CAMPAIGN PERFORMANCE (last 365 days) ======
  try {
    var campaignData = await executeGAQL(
      "SELECT campaign.id, campaign.name, campaign.status, campaign.advertising_channel_type, " +
      "campaign.bidding_strategy_type, " +
      "metrics.impressions, metrics.clicks, metrics.cost_micros, metrics.conversions, " +
      "metrics.conversions_value, metrics.ctr, metrics.average_cpc, metrics.average_cpm, " +
      "metrics.search_impression_share, metrics.cost_per_conversion, " +
      "metrics.all_conversions, metrics.interactions, metrics.interaction_rate " +
      "FROM campaign WHERE segments.date BETWEEN '" + "2020-01-01" + "' AND '" + new Date().toISOString().substring(0,10) + "' AND campaign.status != 'REMOVED' " +
      "ORDER BY metrics.cost_micros DESC"
    );
    if (campaignData) {
      result.campaigns = campaignData.map(function(r) {
        var c = r.campaign || {}, m = r.metrics || {};
        return {
          id: c.id, name: c.name || 'Unknown', status: c.status || 'UNKNOWN',
          type: c.advertisingChannelType || '', bidStrategy: c.biddingStrategyType || '',
          budget: 0,
          impressions: parseInt(m.impressions || 0), clicks: parseInt(m.clicks || 0),
          cost: (parseInt(m.costMicros || 0)) / 1000000,
          conversions: parseFloat(m.conversions || 0), convValue: parseFloat(m.conversionsValue || 0),
          ctr: parseFloat(m.ctr || 0), avgCPC: (parseInt(m.averageCpc || 0)) / 1000000,
          avgCPM: (parseInt(m.averageCpm || 0)) / 1000000,
          impressionShare: parseFloat(m.searchImpressionShare || 0),
          costPerConv: (parseInt(m.costPerConversion || 0)) / 1000000,
          allConversions: parseFloat(m.allConversions || 0),
          interactions: parseInt(m.interactions || 0), interactionRate: parseFloat(m.interactionRate || 0),
        };
      });
    }
  } catch(e) { result.errors.push("Campaign fetch: " + e.message); }
  if (result.campaigns.length === 0 && result.errors.length === 0) {
    result.errors.push("Campaign query returned empty. Check Render logs for GAQL errors. Test token may need Basic Access approval at ads.google.com/aw/apicenter");
  }

  // ====== 2. AD GROUP PERFORMANCE ======
  try {
    var adGroupData = await executeGAQL(
      "SELECT ad_group.id, ad_group.name, ad_group.status, campaign.name, " +
      "metrics.impressions, metrics.clicks, metrics.cost_micros, metrics.conversions, " +
      "metrics.ctr, metrics.average_cpc, metrics.cost_per_conversion " +
      "FROM ad_group WHERE segments.date BETWEEN '" + "2020-01-01" + "' AND '" + new Date().toISOString().substring(0,10) + "' AND ad_group.status != 'REMOVED' " +
      "ORDER BY metrics.cost_micros DESC LIMIT 100"
    );
    if (adGroupData) {
      result.adGroups = adGroupData.map(function(r) {
        var ag = r.adGroup || {}, m = r.metrics || {}, c = r.campaign || {};
        return {
          id: ag.id, name: ag.name || 'Unknown', status: ag.status || '',
          campaign: c.name || '', impressions: parseInt(m.impressions || 0),
          clicks: parseInt(m.clicks || 0), cost: parseInt(m.costMicros || 0) / 1000000,
          conversions: parseFloat(m.conversions || 0), ctr: parseFloat(m.ctr || 0),
          avgCPC: parseInt(m.averageCpc || 0) / 1000000,
          costPerConv: parseInt(m.costPerConversion || 0) / 1000000,
        };
      });
    }
  } catch(e) { result.errors.push("Ad Group fetch: " + e.message); }

  // ====== 3. KEYWORD PERFORMANCE ======
  try {
    var kwData = await executeGAQL(
      "SELECT ad_group_criterion.keyword.text, ad_group_criterion.keyword.match_type, " +
      "ad_group_criterion.quality_info.quality_score, ad_group_criterion.status, " +
      "campaign.name, metrics.impressions, metrics.clicks, metrics.cost_micros, " +
      "metrics.conversions, metrics.ctr, metrics.average_cpc, metrics.cost_per_conversion, " +
      "metrics.search_impression_share " +
      "FROM keyword_view WHERE segments.date BETWEEN '" + "2020-01-01" + "' AND '" + new Date().toISOString().substring(0,10) + "' " +
      "ORDER BY metrics.cost_micros DESC LIMIT 200"
    );
    if (kwData) {
      result.keywords = kwData.map(function(r) {
        var kw = (r.adGroupCriterion || {}).keyword || {};
        var qi = (r.adGroupCriterion || {}).qualityInfo || {};
        var m = r.metrics || {}, c = r.campaign || {};
        return {
          text: kw.text || '', matchType: kw.matchType || '',
          qualityScore: parseInt(qi.qualityScore || 0), status: (r.adGroupCriterion || {}).status || '',
          campaign: c.name || '', impressions: parseInt(m.impressions || 0),
          clicks: parseInt(m.clicks || 0), cost: parseInt(m.costMicros || 0) / 1000000,
          conversions: parseFloat(m.conversions || 0), ctr: parseFloat(m.ctr || 0),
          avgCPC: parseInt(m.averageCpc || 0) / 1000000,
          costPerConv: parseInt(m.costPerConversion || 0) / 1000000,
          impressionShare: parseFloat(m.searchImpressionShare || 0),
        };
      });
    }
  } catch(e) { result.errors.push("Keyword fetch: " + e.message); }

  // ====== 4. SEARCH TERMS (what people actually searched) ======
  try {
    var stData = await executeGAQL(
      "SELECT search_term_view.search_term, search_term_view.status, campaign.name, " +
      "metrics.impressions, metrics.clicks, metrics.cost_micros, metrics.conversions, " +
      "metrics.ctr, metrics.average_cpc " +
      "FROM search_term_view WHERE segments.date BETWEEN '2020-01-01' AND '" + new Date().toISOString().substring(0,10) + "' " +
      "ORDER BY metrics.impressions DESC LIMIT 200"
    );
    if (stData) {
      result.searchTerms = stData.map(function(r) {
        var st = r.searchTermView || {}, m = r.metrics || {}, c = r.campaign || {};
        return {
          term: st.searchTerm || '', status: st.status || '',
          campaign: c.name || '', impressions: parseInt(m.impressions || 0),
          clicks: parseInt(m.clicks || 0), cost: parseInt(m.costMicros || 0) / 1000000,
          conversions: parseFloat(m.conversions || 0), ctr: parseFloat(m.ctr || 0),
          avgCPC: parseInt(m.averageCpc || 0) / 1000000,
        };
      });
    }
  } catch(e) { result.errors.push("Search terms: " + e.message); }

  // ====== 5. GEO PERFORMANCE (by city/region) ======
  try {
    var geoData = await executeGAQL(
      "SELECT geographic_view.country_criterion_id, geographic_view.location_type, " +
      "metrics.impressions, metrics.clicks, metrics.cost_micros, metrics.conversions, " +
      "metrics.ctr, metrics.average_cpc, metrics.cost_per_conversion " +
      "FROM geographic_view WHERE segments.date BETWEEN '" + "2020-01-01" + "' AND '" + new Date().toISOString().substring(0,10) + "' " +
      "ORDER BY metrics.impressions DESC LIMIT 100"
    );
    if (geoData) {
      result.geoPerformance = geoData.map(function(r) {
        var gv = r.geographicView || {}, m = r.metrics || {};
        return {
          locationType: gv.locationType || '',
          impressions: parseInt(m.impressions || 0), clicks: parseInt(m.clicks || 0),
          cost: parseInt(m.costMicros || 0) / 1000000,
          conversions: parseFloat(m.conversions || 0), ctr: parseFloat(m.ctr || 0),
          avgCPC: parseInt(m.averageCpc || 0) / 1000000,
          costPerConv: parseInt(m.costPerConversion || 0) / 1000000,
        };
      });
    }
  } catch(e) { result.errors.push("Geo: " + e.message); }

  // ====== 6. DEVICE PERFORMANCE ======
  try {
    var deviceData = await executeGAQL(
      "SELECT segments.device, metrics.impressions, metrics.clicks, metrics.cost_micros, " +
      "metrics.conversions, metrics.ctr, metrics.average_cpc, metrics.cost_per_conversion " +
      "FROM campaign WHERE segments.date BETWEEN '" + "2020-01-01" + "' AND '" + new Date().toISOString().substring(0,10) + "'"
    );
    if (deviceData) {
      var deviceMap = {};
      deviceData.forEach(function(r) {
        var dev = (r.segments || {}).device || 'UNKNOWN';
        if (!deviceMap[dev]) deviceMap[dev] = { impressions: 0, clicks: 0, cost: 0, conversions: 0 };
        var m = r.metrics || {};
        deviceMap[dev].impressions += parseInt(m.impressions || 0);
        deviceMap[dev].clicks += parseInt(m.clicks || 0);
        deviceMap[dev].cost += parseInt(m.costMicros || 0) / 1000000;
        deviceMap[dev].conversions += parseFloat(m.conversions || 0);
      });
      result.devicePerformance = Object.entries(deviceMap).map(function(d) {
        var v = d[1];
        return {
          device: d[0], impressions: v.impressions, clicks: v.clicks, cost: Math.round(v.cost * 100) / 100,
          conversions: Math.round(v.conversions * 10) / 10,
          ctr: v.impressions > 0 ? Math.round(v.clicks / v.impressions * 10000) / 100 : 0,
          avgCPC: v.clicks > 0 ? Math.round(v.cost / v.clicks * 100) / 100 : 0,
          costPerConv: v.conversions > 0 ? Math.round(v.cost / v.conversions * 100) / 100 : 0,
        };
      });
    }
  } catch(e) { result.errors.push("Device: " + e.message); }

  // ====== 7. HOURLY PERFORMANCE ======
  try {
    var hourData = await executeGAQL(
      "SELECT segments.hour, metrics.impressions, metrics.clicks, metrics.cost_micros, " +
      "metrics.conversions, metrics.ctr " +
      "FROM campaign WHERE segments.date BETWEEN '2020-01-01' AND '" + new Date().toISOString().substring(0,10) + "'"
    );
    if (hourData) {
      var hourMap = {};
      hourData.forEach(function(r) {
        var hr = (r.segments || {}).hour || 0;
        if (!hourMap[hr]) hourMap[hr] = { impressions: 0, clicks: 0, cost: 0, conversions: 0 };
        var m = r.metrics || {};
        hourMap[hr].impressions += parseInt(m.impressions || 0);
        hourMap[hr].clicks += parseInt(m.clicks || 0);
        hourMap[hr].cost += parseInt(m.costMicros || 0) / 1000000;
        hourMap[hr].conversions += parseFloat(m.conversions || 0);
      });
      for (var h = 0; h < 24; h++) {
        var hd = hourMap[h] || { impressions: 0, clicks: 0, cost: 0, conversions: 0 };
        result.hourlyPerformance.push({
          hour: h, impressions: hd.impressions, clicks: hd.clicks,
          cost: Math.round(hd.cost * 100) / 100, conversions: Math.round(hd.conversions * 10) / 10,
          ctr: hd.impressions > 0 ? Math.round(hd.clicks / hd.impressions * 10000) / 100 : 0,
        });
      }
    }
  } catch(e) { result.errors.push("Hourly: " + e.message); }

  // ====== 8. DAY OF WEEK PERFORMANCE ======
  try {
    var dowData = await executeGAQL(
      "SELECT segments.day_of_week, metrics.impressions, metrics.clicks, metrics.cost_micros, " +
      "metrics.conversions, metrics.ctr " +
      "FROM campaign WHERE segments.date BETWEEN '" + "2020-01-01" + "' AND '" + new Date().toISOString().substring(0,10) + "'"
    );
    if (dowData) {
      var dowMap = {};
      dowData.forEach(function(r) {
        var day = (r.segments || {}).dayOfWeek || 'UNKNOWN';
        if (!dowMap[day]) dowMap[day] = { impressions: 0, clicks: 0, cost: 0, conversions: 0 };
        var m = r.metrics || {};
        dowMap[day].impressions += parseInt(m.impressions || 0);
        dowMap[day].clicks += parseInt(m.clicks || 0);
        dowMap[day].cost += parseInt(m.costMicros || 0) / 1000000;
        dowMap[day].conversions += parseFloat(m.conversions || 0);
      });
      ['MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY','SUNDAY'].forEach(function(d) {
        var dd = dowMap[d] || { impressions: 0, clicks: 0, cost: 0, conversions: 0 };
        result.dayOfWeekPerformance.push({
          day: d, impressions: dd.impressions, clicks: dd.clicks,
          cost: Math.round(dd.cost * 100) / 100, conversions: Math.round(dd.conversions * 10) / 10,
          ctr: dd.impressions > 0 ? Math.round(dd.clicks / dd.impressions * 10000) / 100 : 0,
          costPerConv: dd.conversions > 0 ? Math.round(dd.cost / dd.conversions * 100) / 100 : 0,
        });
      });
    }
  } catch(e) { result.errors.push("DOW: " + e.message); }

  // ====== 9. MONTHLY PERFORMANCE (for Fibonacci) ======
  try {
    var monthData = await executeGAQL(
      "SELECT segments.month, metrics.impressions, metrics.clicks, metrics.cost_micros, " +
      "metrics.conversions, metrics.conversions_value, metrics.ctr, metrics.average_cpc " +
      "FROM campaign WHERE segments.date BETWEEN '" + "2020-01-01" + "' AND '" + new Date().toISOString().substring(0,10) + "'"
    );
    if (monthData) {
      var monthMap = {};
      monthData.forEach(function(r) {
        var mo = (r.segments || {}).month || '';
        if (!monthMap[mo]) monthMap[mo] = { impressions: 0, clicks: 0, cost: 0, conversions: 0, convValue: 0 };
        var m = r.metrics || {};
        monthMap[mo].impressions += parseInt(m.impressions || 0);
        monthMap[mo].clicks += parseInt(m.clicks || 0);
        monthMap[mo].cost += parseInt(m.costMicros || 0) / 1000000;
        monthMap[mo].conversions += parseFloat(m.conversions || 0);
        monthMap[mo].convValue += parseFloat(m.conversionsValue || 0);
      });
      result.monthlyPerformance = Object.keys(monthMap).sort().map(function(mo) {
        var md = monthMap[mo];
        return {
          month: mo, impressions: md.impressions, clicks: md.clicks,
          cost: Math.round(md.cost * 100) / 100, conversions: Math.round(md.conversions * 10) / 10,
          convValue: Math.round(md.convValue * 100) / 100,
          ctr: md.impressions > 0 ? Math.round(md.clicks / md.impressions * 10000) / 100 : 0,
          avgCPC: md.clicks > 0 ? Math.round(md.cost / md.clicks * 100) / 100 : 0,
          roas: md.cost > 0 ? Math.round(md.convValue / md.cost * 100) / 100 : 0,
          costPerConv: md.conversions > 0 ? Math.round(md.cost / md.conversions * 100) / 100 : 0,
        };
      });
    }
  } catch(e) { result.errors.push("Monthly: " + e.message); }

  // ====== 10. DAILY PERFORMANCE (last 90 days for granular charts) ======
  try {
    var dayData = await executeGAQL(
      "SELECT segments.date, metrics.impressions, metrics.clicks, metrics.cost_micros, " +
      "metrics.conversions, metrics.conversions_value, metrics.ctr, metrics.average_cpc " +
      "FROM campaign WHERE segments.date BETWEEN '" + "2020-01-01" + "' AND '" + new Date().toISOString().substring(0,10) + "' ORDER BY segments.date"
    );
    if (dayData) {
      var dayMap = {};
      dayData.forEach(function(r) {
        var dt = (r.segments || {}).date || '';
        if (!dayMap[dt]) dayMap[dt] = { impressions: 0, clicks: 0, cost: 0, conversions: 0, convValue: 0 };
        var m = r.metrics || {};
        dayMap[dt].impressions += parseInt(m.impressions || 0);
        dayMap[dt].clicks += parseInt(m.clicks || 0);
        dayMap[dt].cost += parseInt(m.costMicros || 0) / 1000000;
        dayMap[dt].conversions += parseFloat(m.conversions || 0);
        dayMap[dt].convValue += parseFloat(m.conversionsValue || 0);
      });
      result.dailyPerformance = Object.keys(dayMap).sort().map(function(dt) {
        var dd = dayMap[dt];
        return {
          date: dt, impressions: dd.impressions, clicks: dd.clicks,
          cost: Math.round(dd.cost * 100) / 100, conversions: Math.round(dd.conversions * 10) / 10,
          convValue: Math.round(dd.convValue * 100) / 100,
          ctr: dd.impressions > 0 ? Math.round(dd.clicks / dd.impressions * 10000) / 100 : 0,
          avgCPC: dd.clicks > 0 ? Math.round(dd.cost / dd.clicks * 100) / 100 : 0,
          roas: dd.cost > 0 ? Math.round(dd.convValue / dd.cost * 100) / 100 : 0,
        };
      });
    }
  } catch(e) { result.errors.push("Daily: " + e.message); }

  // ====== 11. WEEKLY PERFORMANCE ======
  if (result.dailyPerformance.length > 0) {
    var weekMap = {};
    result.dailyPerformance.forEach(function(d) {
      var dt = new Date(d.date);
      var weekStart = new Date(dt); weekStart.setDate(dt.getDate() - dt.getDay());
      var wk = weekStart.toISOString().split('T')[0];
      if (!weekMap[wk]) weekMap[wk] = { impressions: 0, clicks: 0, cost: 0, conversions: 0, convValue: 0, days: 0 };
      weekMap[wk].impressions += d.impressions; weekMap[wk].clicks += d.clicks;
      weekMap[wk].cost += d.cost; weekMap[wk].conversions += d.conversions;
      weekMap[wk].convValue += d.convValue; weekMap[wk].days++;
    });
    result.weeklyPerformance = Object.keys(weekMap).sort().map(function(wk) {
      var wd = weekMap[wk];
      return {
        week: wk, impressions: wd.impressions, clicks: wd.clicks,
        cost: Math.round(wd.cost * 100) / 100, conversions: Math.round(wd.conversions * 10) / 10,
        convValue: Math.round(wd.convValue * 100) / 100,
        ctr: wd.impressions > 0 ? Math.round(wd.clicks / wd.impressions * 10000) / 100 : 0,
        avgCPC: wd.clicks > 0 ? Math.round(wd.cost / wd.clicks * 100) / 100 : 0,
        roas: wd.cost > 0 ? Math.round(wd.convValue / wd.cost * 100) / 100 : 0,
      };
    });
  }

  // ====== ACCOUNT SUMMARY ======
  var totalSpend = 0, totalClicks = 0, totalImpressions = 0, totalConversions = 0, totalConvValue = 0;
  result.campaigns.forEach(function(c) {
    totalSpend += c.cost; totalClicks += c.clicks; totalImpressions += c.impressions;
    totalConversions += c.conversions; totalConvValue += c.convValue;
  });
  result.accountSummary = {
    totalSpend: Math.round(totalSpend * 100) / 100,
    totalClicks: totalClicks, totalImpressions: totalImpressions,
    totalConversions: Math.round(totalConversions * 10) / 10,
    totalConvValue: Math.round(totalConvValue * 100) / 100,
    avgCPC: totalClicks > 0 ? Math.round(totalSpend / totalClicks * 100) / 100 : 0,
    avgCTR: totalImpressions > 0 ? Math.round(totalClicks / totalImpressions * 10000) / 100 : 0,
    avgCostPerConv: totalConversions > 0 ? Math.round(totalSpend / totalConversions * 100) / 100 : 0,
    roas: totalSpend > 0 ? Math.round(totalConvValue / totalSpend * 100) / 100 : 0,
    activeCampaigns: result.campaigns.filter(function(c) { return c.status === 'ENABLED'; }).length,
    totalCampaigns: result.campaigns.length,
  };

  console.log("Ads context built: " + result.campaigns.length + " campaigns, " + result.keywords.length + " keywords, " + result.dailyPerformance.length + " daily records");
  
  adsCache.data = result;
  adsCache.time = Date.now();
  global.adsData = result;
  return result;
}

// JSON endpoint for ads data
app.get('/ads/json', async function(req, res) {
  try {
    var data = await buildAdsContext();
    res.json(data);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Refresh ads cache
app.get('/ads/refresh', async function(req, res) {
  adsCache = { data: null, time: 0 };
  try {
    var data = await buildAdsContext();
    res.json({ status: 'refreshed', campaigns: data.campaigns.length, keywords: data.keywords.length });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Debug endpoint â€” raw API test
app.get('/ads/debug', async function(req, res) {
  try {
    var token = await getAdsAccessToken();
    if (!token) return res.json({ error: 'No access token. Visit /ads/auth', hasRefresh: !!adsTokenStore.refreshToken, hasClientId: !!GOOGLE_ADS_CLIENT_ID });
    
    var cid = GOOGLE_ADS_CUSTOMER_ID;
    var headers = {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token,
      'developer-token': GOOGLE_ADS_DEVELOPER_TOKEN,
    };
    if (GOOGLE_ADS_MANAGER_ID) headers['login-customer-id'] = GOOGLE_ADS_MANAGER_ID;
    
    // Simple query to test
    var query = "SELECT campaign.id, campaign.name, campaign.status FROM campaign LIMIT 10";
    
    var apiRes = await fetch('https://googleads.googleapis.com/v23/customers/' + cid + '/googleAds:search', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({ query: query }),
    });
    var rawText = await apiRes.text();
    
    res.json({
      config: {
        customerID: cid,
        managerID: GOOGLE_ADS_MANAGER_ID || 'NOT SET',
        devToken: GOOGLE_ADS_DEVELOPER_TOKEN ? GOOGLE_ADS_DEVELOPER_TOKEN.substring(0, 6) + '...' : 'NOT SET',
        hasAccessToken: !!token,
      },
      httpStatus: apiRes.status,
      rawResponse: rawText.substring(0, 2000),
    });
  } catch (err) {
    res.json({ error: err.message, stack: err.stack.substring(0, 500) });
  }
});

/* ===========================
   /ads â€” GOOGLE ADS DASHBOARD
   Full interactive dashboard with Fibonacci, forecasting, every metric
=========================== */

app.get('/ads', requireAuth('owner'), async function(req, res) {
  try {
    await buildBusinessContext();
    var ads;
    try { ads = await buildAdsContext(); } catch(ae) { ads = null; console.log("Ads load error:", ae.message); }
    if (!ads) ads = { connected: false, needsAuth: true, campaigns: [], adGroups: [], keywords: [], searchTerms: [], geoPerformance: [], devicePerformance: [], hourlyPerformance: [], dayOfWeekPerformance: [], monthlyPerformance: [], weeklyPerformance: [], dailyPerformance: [], conversionActions: [], accountSummary: {}, errors: ['Failed to load ads data'] };
    var bm = global.bizMetrics || {};
    var pm = global.profitMetrics || {};

    // Analytics helpers (same as /analytics)
    function linearRegression(values) {
      var n = values.length;
      if (n < 2) return { slope: 0, intercept: values[0] || 0, r2: 0 };
      var sumX=0,sumY=0,sumXY=0,sumXX=0;
      for (var i=0;i<n;i++){sumX+=i;sumY+=values[i];sumXY+=i*values[i];sumXX+=i*i;}
      var d=(n*sumXX-sumX*sumX);var slope=d!==0?(n*sumXY-sumX*sumY)/d:0;var intercept=(sumY-slope*sumX)/n;
      var ssRes=0,ssTot=0,mean=sumY/n;
      for(var j=0;j<n;j++){var p=intercept+slope*j;ssRes+=(values[j]-p)*(values[j]-p);ssTot+=(values[j]-mean)*(values[j]-mean);}
      return{slope:Math.round(slope*100)/100,intercept:Math.round(intercept*100)/100,r2:ssTot>0?Math.round((1-ssRes/ssTot)*1000)/1000:0};
    }
    function calcFibExt(values) {
      var recent=values.slice(-12);var high=Math.max.apply(null,recent.length>0?recent:[0]);
      var low=Math.min.apply(null,recent.length>0?recent:[0]);var range=high-low;
      return{high:high,low:low,range:range,'23.6':Math.round(low+range*0.236),'38.2':Math.round(low+range*0.382),
        '50.0':Math.round(low+range*0.5),'61.8':Math.round(low+range*0.618),'78.6':Math.round(low+range*0.786),
        '127.2':Math.round(low+range*1.272),'161.8':Math.round(low+range*1.618),
        current:recent.length>0?recent[recent.length-1]:0};
    }
    function growthMetrics(values) {
      if(values.length<2)return{mom:0,last:0,prev:0};
      var last=values[values.length-1],prev=values[values.length-2];
      var mom=prev>0?Math.round(((last-prev)/prev)*1000)/10:0;
      return{mom:mom,last:last,prev:prev};
    }
    function forecast(values,months) {
      var lr=linearRegression(values);var n=values.length;var preds=[];
      for(var i=0;i<months;i++){preds.push(Math.max(0,Math.round(lr.intercept+lr.slope*(n+i))));}
      return preds;
    }

    // Compute monthly Fibonacci data for ads
    var monthlyCosts = ads.monthlyPerformance.map(function(m){return m.cost;});
    var monthlyClicks = ads.monthlyPerformance.map(function(m){return m.clicks;});
    var monthlyConv = ads.monthlyPerformance.map(function(m){return m.conversions;});
    var monthlyImpr = ads.monthlyPerformance.map(function(m){return m.impressions;});
    var monthlyCPC = ads.monthlyPerformance.map(function(m){return m.avgCPC;});
    var monthlyROAS = ads.monthlyPerformance.map(function(m){return m.roas;});
    var monthlyCPConv = ads.monthlyPerformance.map(function(m){return m.costPerConv;});
    var monthlyCTR = ads.monthlyPerformance.map(function(m){return m.ctr;});

    var costFib = calcFibExt(monthlyCosts);
    var clickFib = calcFibExt(monthlyClicks);
    var convFib = calcFibExt(monthlyConv);
    var cpcFib = calcFibExt(monthlyCPC);
    var roasFib = calcFibExt(monthlyROAS);
    var cpConvFib = calcFibExt(monthlyCPConv);
    var ctrFib = calcFibExt(monthlyCTR);

    var costGrowth = growthMetrics(monthlyCosts);
    var clickGrowth = growthMetrics(monthlyClicks);
    var convGrowth = growthMetrics(monthlyConv);
    var cpcGrowth = growthMetrics(monthlyCPC);
    var roasGrowth = growthMetrics(monthlyROAS);

    var costForecast = forecast(monthlyCosts, 3);
    var clickForecast = forecast(monthlyClicks, 3);
    var convForecast = forecast(monthlyConv, 3);

    // Compute daily Fibonacci for LightweightCharts
    var dailyCosts = ads.dailyPerformance.map(function(d){return d.cost;});
    var dailyClicks = ads.dailyPerformance.map(function(d){return d.clicks;});
    var dailyCostFib = calcFibExt(dailyCosts);
    var dailyClickFib = calcFibExt(dailyClicks);

    var as = ads.accountSummary || {};
    as.totalSpend = as.totalSpend || 0;
    as.totalClicks = as.totalClicks || 0;
    as.totalImpressions = as.totalImpressions || 0;
    as.totalConversions = as.totalConversions || 0;
    as.totalConvValue = as.totalConvValue || 0;
    as.avgCPC = as.avgCPC || 0;
    as.avgCTR = as.avgCTR || 0;
    as.avgCostPerConv = as.avgCostPerConv || 0;
    as.roas = as.roas || 0;
    as.activeCampaigns = as.activeCampaigns || 0;
    as.totalCampaigns = as.totalCampaigns || 0;

    // ========== BUILD HTML ==========
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>WILDWOOD â€” Google Ads Intelligence</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">';
    html += '<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"><\/script>';
    html += '<style>';
    html += '*{margin:0;padding:0;box-sizing:border-box;}';
    html += 'body{background:#050d18;color:#c0d8f0;font-family:Rajdhani,sans-serif;overflow-x:hidden;}';
    html += '.wrap{max-width:1500px;margin:0 auto;padding:20px 30px;}';
    html += '.nav{display:flex;gap:0;margin-bottom:20px;flex-wrap:wrap;}';
    html += '.nav a{font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);transition:all 0.3s;}';
    html += '.nav a.active{color:#4285f4;border-color:#4285f440;background:rgba(66,133,244,0.1);}';
    html += '.nav a:hover{border-color:#4285f440;}';
    html += '.section{margin-bottom:30px;} .section-head{font-family:Orbitron;font-size:0.85em;letter-spacing:5px;text-transform:uppercase;margin-bottom:15px;display:flex;align-items:center;gap:10px;}';
    html += '.section-head .dot{width:10px;height:10px;border-radius:50%;display:inline-block;animation:glow 2s ease-in-out infinite alternate;}';
    html += '@keyframes glow{0%{box-shadow:0 0 5px var(--gc,#4285f4);}100%{box-shadow:0 0 20px var(--gc,#4285f4);}}';
    html += '.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px;margin-bottom:15px;}';
    html += '.kpi{background:rgba(10,20,35,0.8);border:1px solid rgba(255,255,255,0.05);padding:14px;position:relative;overflow:hidden;transition:all 0.3s;}';
    html += '.kpi:hover{border-color:var(--c,#4285f4);transform:translateY(-2px);}';
    html += '.kpi::before{content:"";position:absolute;top:0;left:0;width:100%;height:2px;background:var(--c,#4285f4);opacity:0.4;}';
    html += '.kpi-label{color:#4a6a8a;font-family:Orbitron;font-size:0.45em;letter-spacing:2px;margin-bottom:4px;}';
    html += '.kpi-val{font-family:Orbitron;font-size:1.3em;font-weight:900;color:var(--c,#4285f4);}';
    html += '.kpi-sub{color:#4a6a8a;font-size:0.75em;margin-top:2px;}';
    html += '.fib-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;margin-bottom:15px;}';
    html += '.fib-card{background:rgba(10,20,35,0.8);border:1px solid #1a2a3a;padding:16px;}';
    html += '.fib-title{font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}';
    html += '.fib-level{display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid #0a1520;}';
    html += '.fib-level .pct{font-family:Orbitron;font-size:0.5em;color:#4a6a8a;width:50px;}';
    html += '.fib-level .bar{flex:1;height:5px;background:#0a1520;margin:0 6px;position:relative;}';
    html += '.fib-level .fill{height:100%;position:absolute;top:0;left:0;}';
    html += '.fib-level .val{font-family:Orbitron;font-size:0.65em;width:65px;text-align:right;}';
    html += '.data-table{width:100%;border-collapse:collapse;font-size:0.8em;}';
    html += '.data-table th{padding:8px;text-align:left;color:#4285f4;font-family:Orbitron;font-size:0.5em;letter-spacing:1px;border-bottom:2px solid #4285f415;}';
    html += '.data-table td{padding:5px 8px;border-bottom:1px solid #0a1520;}';
    html += '.data-table tr:nth-child(even){background:rgba(10,20,35,0.3);}';
    html += '.data-table tr:hover{background:rgba(66,133,244,0.03);}';
    html += '.pill{display:inline-block;font-family:Orbitron;font-size:0.45em;letter-spacing:1px;padding:2px 8px;border-radius:2px;}';
    html += '.pill-green{background:rgba(0,255,102,0.1);color:#00ff66;border:1px solid #00ff6630;}';
    html += '.pill-red{background:rgba(255,71,87,0.1);color:#ff4757;border:1px solid #ff475730;}';
    html += '.pill-blue{background:rgba(66,133,244,0.1);color:#4285f4;border:1px solid #4285f430;}';
    html += '.pill-orange{background:rgba(255,159,67,0.1);color:#ff9f43;border:1px solid #ff9f4330;}';
    html += '.signal-box{padding:12px;border:1px solid;margin-top:10px;font-size:0.85em;line-height:1.5;}';
    html += '.chart-box{background:rgba(10,20,35,0.8);border:1px solid #1a2a3a;padding:16px;margin-bottom:12px;}';
    html += '.chart-title{font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:10px;}';
    html += '@media(max-width:768px){.wrap{padding:10px 12px;} .kpi-row{grid-template-columns:repeat(2,1fr);} .fib-grid{grid-template-columns:1fr;} .nav a{padding:8px 12px;font-size:0.5em;} .kpi-val{font-size:1em;} table{font-size:0.65em;}}';
    html += '@media(max-width:480px){.kpi-row{grid-template-columns:1fr;}}';
    html += '</style></head><body><div class="wrap">';

    // Nav
    html += '<div class="nav">';
    html += '<a href="/dashboard">JARVIS</a>';
    html += '<a href="/business">ATHENA</a>';
    html += '<a href="/tookan">TOOKAN</a>';
    html += '<a href="/business/chart">CHARTS</a>';
    html += '<a href="/analytics">ANALYTICS</a>';
    html += '<a href="/ads" class="active">GOOGLE ADS</a>';
    html += '<a href="/square">SQUARE</a>';
    html += '<a href="/discord">DISCORD</a>';
    html += '<a href="/followup">FOLLOW UP</a>';
    html += '<a href="/ai">AI</a>';
    html += '<a href="/audit">AUDIT</a>';
    html += '<a href="/auth/logout" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#ef4444;border:1px solid #ef444440;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">LOGOUT</a>';
    html += '</div>';

    html += '<div style="font-family:Orbitron;font-size:1.4em;letter-spacing:8px;color:#4285f4;margin-bottom:5px;">GOOGLE ADS INTELLIGENCE</div>';
    html += '<div style="font-family:Orbitron;font-size:0.5em;letter-spacing:3px;color:#4a6a8a;margin-bottom:20px;">CAMPAIGN FIBONACCI &bull; CPC ANALYSIS &bull; CONVERSION TRACKING &bull; SEARCH TERMS &bull; BUDGET OPTIMIZATION</div>';

    // Connection status
    if (!ads.connected) {
      html += '<div style="padding:30px;border:2px solid #ff9f4340;background:rgba(255,159,67,0.05);text-align:center;margin-bottom:20px;">';
      html += '<div style="font-family:Orbitron;font-size:1.2em;color:#ff9f43;margin-bottom:10px;">âš¡ CONNECT GOOGLE ADS</div>';
      if (!GOOGLE_ADS_CLIENT_ID) {
        html += '<div style="color:#c0d8f0;margin-bottom:10px;">Step 1: Create OAuth2 credentials in Google Cloud Console</div>';
        html += '<div style="color:#4a6a8a;font-size:0.85em;margin-bottom:6px;">Go to console.cloud.google.com â†’ APIs & Credentials â†’ Create OAuth 2.0 Client ID (Web Application)</div>';
        html += '<div style="color:#4a6a8a;font-size:0.85em;margin-bottom:6px;">Add redirect URI: <code style="color:#00d4ff;">' + 'https://' + req.get('host') + '/ads/callback</code></div>';
        html += '<div style="color:#4a6a8a;font-size:0.85em;">Add to Render: GOOGLE_ADS_CLIENT_ID and GOOGLE_ADS_CLIENT_SECRET</div>';
      } else {
        html += '<a href="/ads/auth" style="display:inline-block;font-family:Orbitron;font-size:0.8em;letter-spacing:3px;padding:12px 40px;background:rgba(66,133,244,0.2);border:1px solid #4285f4;color:#4285f4;text-decoration:none;">AUTHORIZE GOOGLE ADS â†’</a>';
      }
      if (ads.errors.length > 0) {
        html += '<div style="margin-top:10px;color:#ff4757;font-size:0.8em;">' + ads.errors.join('<br>') + '</div>';
      }
      html += '</div>';
    }

    // ====== SECTION 1: ACCOUNT OVERVIEW ======
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#4285f4;--gc:#4285f4;display:flex;align-items:center;gap:15px;"><span class="dot" style="background:#4285f4;"></span>ACCOUNT OVERVIEW <select id="adsRange" onchange="filterByRange()" style="background:#0a1520;color:#4285f4;border:1px solid #4285f440;font-family:Orbitron;font-size:0.65em;padding:4px 10px;letter-spacing:2px;cursor:pointer;"><option value="1">TODAY</option><option value="7">7 DAYS</option><option value="14">14 DAYS</option><option value="30">30 DAYS</option><option value="thismonth">THIS MONTH</option><option value="60">60 DAYS</option><option value="90">90 DAYS</option><option value="180">6 MONTHS</option><option value="thisyear">THIS YEAR</option><option value="365">1 YEAR</option><option value="0" selected>ALL TIME</option></select></div>';
    html += '<div id="kpi-row" class="kpi-row">';
    var acctKPIs = [
      { label: 'TOTAL SPEND', val: '$' + as.totalSpend.toLocaleString(), sub: as.activeCampaigns + ' active campaigns', c: '#ff4757' },
      { label: 'TOTAL CLICKS', val: as.totalClicks.toLocaleString(), sub: as.avgCTR + '% CTR', c: '#4285f4' },
      { label: 'IMPRESSIONS', val: as.totalImpressions.toLocaleString(), sub: 'Across all campaigns', c: '#00d4ff' },
      { label: 'CONVERSIONS', val: as.totalConversions, sub: '$' + as.avgCostPerConv + ' per conversion', c: '#00ff66' },
      { label: 'CONV. VALUE', val: '$' + as.totalConvValue.toLocaleString(), sub: as.roas + 'x ROAS', c: '#ffd700' },
      { label: 'AVG CPC', val: '$' + as.avgCPC, sub: 'Cost per click', c: '#a855f7' },
      { label: 'AVG CTR', val: as.avgCTR + '%', sub: 'Click-through rate', c: '#55f7d8' },
      { label: 'COST/CONVERSION', val: '$' + as.avgCostPerConv, sub: 'Avg acquisition cost', c: '#ff9f43' },
    ];
    acctKPIs.forEach(function(k) {
      html += '<div class="kpi" style="--c:' + k.c + ';"><div class="kpi-label">' + k.label + '</div><div class="kpi-val">' + k.val + '</div><div class="kpi-sub">' + k.sub + '</div></div>';
    });
    html += '</div></div>';

    // ====== SECTION 2: INTERACTIVE DAILY CHART ======
    if (ads.dailyPerformance.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-head" style="color:#00d4ff;--gc:#00d4ff;"><span class="dot" style="background:#00d4ff;"></span>DAILY PERFORMANCE â€” INTERACTIVE CHART</div>';
      html += '<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;">';
      html += '<button onclick="switchMetric(\'cost\')" id="btn-m-cost" class="mbtn active" style="font-family:Orbitron;font-size:0.5em;padding:6px 12px;background:rgba(66,133,244,0.15);color:#4285f4;border:1px solid #4285f440;cursor:pointer;">SPEND</button>';
      html += '<button onclick="switchMetric(\'clicks\')" id="btn-m-clicks" class="mbtn" style="font-family:Orbitron;font-size:0.5em;padding:6px 12px;background:#0a1520;color:#4a6a8a;border:1px solid #1a2a3a;cursor:pointer;">CLICKS</button>';
      html += '<button onclick="switchMetric(\'conversions\')" id="btn-m-conv" class="mbtn" style="font-family:Orbitron;font-size:0.5em;padding:6px 12px;background:#0a1520;color:#4a6a8a;border:1px solid #1a2a3a;cursor:pointer;">CONVERSIONS</button>';
      html += '<button onclick="switchMetric(\'ctr\')" id="btn-m-ctr" class="mbtn" style="font-family:Orbitron;font-size:0.5em;padding:6px 12px;background:#0a1520;color:#4a6a8a;border:1px solid #1a2a3a;cursor:pointer;">CTR</button>';
      html += '<button onclick="switchMetric(\'avgCPC\')" id="btn-m-cpc" class="mbtn" style="font-family:Orbitron;font-size:0.5em;padding:6px 12px;background:#0a1520;color:#4a6a8a;border:1px solid #1a2a3a;cursor:pointer;">CPC</button>';
      html += '<button onclick="switchMetric(\'roas\')" id="btn-m-roas" class="mbtn" style="font-family:Orbitron;font-size:0.5em;padding:6px 12px;background:#0a1520;color:#4a6a8a;border:1px solid #1a2a3a;cursor:pointer;">ROAS</button>';
      html += '</div>';
      html += '<div id="ads-daily-chart" style="border:1px solid #1a2a3a;min-height:350px;width:100%;"></div>';
      html += '</div>';
    }

    // ====== SECTION 3: MONTHLY FIBONACCI CARDS ======
    if (ads.monthlyPerformance.length >= 3) {
      html += '<div class="section">';
      html += '<div class="section-head" style="color:#ffd700;--gc:#ffd700;"><span class="dot" style="background:#ffd700;"></span>MONTHLY METRICS â€” FIBONACCI RETRACEMENT</div>';
      html += '<div class="fib-grid">';

      var adsFibs = [
        { name: 'AD SPEND', fib: costFib, growth: costGrowth, color: '#ff4757', prefix: '$', inv: true },
        { name: 'CLICKS', fib: clickFib, growth: clickGrowth, color: '#4285f4', prefix: '' },
        { name: 'CONVERSIONS', fib: convFib, growth: convGrowth, color: '#00ff66', prefix: '' },
        { name: 'AVG CPC', fib: cpcFib, growth: cpcGrowth, color: '#a855f7', prefix: '$', inv: true },
        { name: 'ROAS', fib: roasFib, growth: roasGrowth, color: '#ffd700', prefix: '', suffix: 'x' },
        { name: 'CTR', fib: ctrFib, growth: growthMetrics(monthlyCTR), color: '#55f7d8', prefix: '', suffix: '%' },
      ];

      adsFibs.forEach(function(af) {
        html += '<div class="fib-card">';
        html += '<div class="fib-title"><span style="color:' + af.color + ';">' + af.name + '</span>';
        var tIcon = af.growth.mom > 0 ? 'â–²' : af.growth.mom < 0 ? 'â–¼' : 'â–º';
        var tColor = af.inv ? (af.growth.mom > 0 ? '#ff4757' : '#00ff66') : (af.growth.mom > 0 ? '#00ff66' : '#ff4757');
        html += '<span style="color:' + tColor + ';">' + tIcon + ' ' + (af.growth.mom >= 0 ? '+' : '') + af.growth.mom + '%</span></div>';

        var fibArr = [
          { label: '161.8% EXT', val: af.fib['161.8'], c: '#a855f7' },
          { label: '100% HIGH', val: af.fib.high, c: '#00ff66' },
          { label: '61.8%', val: af.fib['61.8'], c: '#00ff66' },
          { label: '50%', val: af.fib['50.0'], c: '#ffd700' },
          { label: '38.2%', val: af.fib['38.2'], c: '#ff4757' },
          { label: '0% LOW', val: af.fib.low, c: '#ff4757' },
        ];
        fibArr.forEach(function(fl) {
          var pct = af.fib.high > 0 ? Math.min(100, Math.round(fl.val / af.fib.high * 100)) : 0;
          html += '<div class="fib-level"><span class="pct">' + fl.label.split(' ')[0] + '</span>';
          html += '<div class="bar"><div class="fill" style="width:' + pct + '%;background:' + fl.c + '40;"></div></div>';
          html += '<span class="val" style="color:' + fl.c + ';">' + af.prefix + (typeof fl.val === 'number' ? (fl.val >= 1000 ? Math.round(fl.val).toLocaleString() : fl.val) : fl.val) + (af.suffix || '') + '</span></div>';
        });

        // Current position
        var curPos = af.fib.range > 0 ? Math.round((af.fib.current - af.fib.low) / af.fib.range * 100) : 50;
        html += '<div style="margin-top:8px;display:flex;justify-content:space-between;font-size:0.75em;">';
        html += '<span style="color:#4a6a8a;">Now: <strong style="color:' + af.color + ';">' + af.prefix + (typeof af.fib.current === 'number' ? af.fib.current : 0) + (af.suffix || '') + '</strong></span>';
        html += '<span style="color:' + (curPos > 61.8 ? '#00ff66' : curPos > 38.2 ? '#ffd700' : '#ff4757') + ';font-family:Orbitron;font-size:0.7em;">' + curPos + '% RET</span>';
        html += '</div></div>';
      });
      html += '</div></div>';
    }

    // ====== SECTION 4: CAMPAIGN TABLE ======
    if (ads.campaigns.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-head" style="color:#4285f4;--gc:#4285f4;"><span class="dot" style="background:#4285f4;"></span>CAMPAIGN PERFORMANCE</div>';
      html += '<div style="overflow-x:auto;"><table class="data-table">';
      html += '<thead><tr><th>Campaign</th><th>Status</th><th>Spend</th><th>Clicks</th><th>CTR</th><th>CPC</th><th>Conv</th><th>Cost/Conv</th><th>ROAS</th><th>Impr Share</th></tr></thead><tbody>';
      ads.campaigns.forEach(function(c) {
        var statusPill = c.status === 'ENABLED' ? '<span class="pill pill-green">ACTIVE</span>' : c.status === 'PAUSED' ? '<span class="pill pill-orange">PAUSED</span>' : '<span class="pill pill-red">' + c.status + '</span>';
        html += '<tr><td style="color:#c0d8f0;font-weight:700;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + c.name + '</td>';
        html += '<td>' + statusPill + '</td>';
        html += '<td style="color:#ff4757;">$' + c.cost.toLocaleString() + '</td>';
        html += '<td style="color:#4285f4;">' + c.clicks.toLocaleString() + '</td>';
        html += '<td>' + (c.ctr * 100).toFixed(2) + '%</td>';
        html += '<td style="color:#a855f7;">$' + c.avgCPC.toFixed(2) + '</td>';
        html += '<td style="color:#00ff66;">' + c.conversions + '</td>';
        html += '<td style="color:#ff9f43;">$' + c.costPerConv.toFixed(2) + '</td>';
        var roas = c.cost > 0 ? (c.convValue / c.cost).toFixed(2) : '0';
        html += '<td style="color:#ffd700;">' + roas + 'x</td>';
        html += '<td>' + (c.impressionShare * 100).toFixed(1) + '%</td></tr>';
      });
      html += '</tbody></table></div></div>';
    }

    // ====== SECTION 5: TOP KEYWORDS ======
    if (ads.keywords.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-head" style="color:#a855f7;--gc:#a855f7;"><span class="dot" style="background:#a855f7;"></span>TOP KEYWORDS â€” ' + ads.keywords.length + ' TRACKED</div>';
      html += '<div style="overflow-x:auto;"><table class="data-table">';
      html += '<thead><tr><th>Keyword</th><th>Match</th><th>QS</th><th>Clicks</th><th>Cost</th><th>CTR</th><th>CPC</th><th>Conv</th><th>Cost/Conv</th></tr></thead><tbody>';
      ads.keywords.slice(0, 50).forEach(function(kw) {
        var qsColor = kw.qualityScore >= 7 ? '#00ff66' : kw.qualityScore >= 5 ? '#ff9f43' : '#ff4757';
        html += '<tr><td style="color:#c0d8f0;font-weight:600;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + kw.text + '</td>';
        html += '<td style="color:#4a6a8a;font-size:0.8em;">' + (kw.matchType || '').replace('_', ' ') + '</td>';
        html += '<td style="color:' + qsColor + ';font-weight:700;">' + (kw.qualityScore || '-') + '</td>';
        html += '<td style="color:#4285f4;">' + kw.clicks.toLocaleString() + '</td>';
        html += '<td style="color:#ff4757;">$' + kw.cost.toFixed(2) + '</td>';
        html += '<td>' + (kw.ctr * 100).toFixed(2) + '%</td>';
        html += '<td style="color:#a855f7;">$' + kw.avgCPC.toFixed(2) + '</td>';
        html += '<td style="color:#00ff66;">' + kw.conversions + '</td>';
        html += '<td style="color:#ff9f43;">' + (kw.costPerConv > 0 ? '$' + kw.costPerConv.toFixed(2) : '-') + '</td></tr>';
      });
      html += '</tbody></table></div></div>';
    }

    // ====== SECTION 6: SEARCH TERMS ======
    if (ads.searchTerms.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-head" style="color:#55f7d8;--gc:#55f7d8;"><span class="dot" style="background:#55f7d8;"></span>SEARCH TERMS â€” WHAT PEOPLE ACTUALLY SEARCHED</div>';
      html += '<div style="overflow-x:auto;"><table class="data-table">';
      html += '<thead><tr><th>Search Term</th><th>Impressions</th><th>Clicks</th><th>CTR</th><th>Cost</th><th>CPC</th><th>Conv</th></tr></thead><tbody>';
      ads.searchTerms.slice(0, 50).forEach(function(st) {
        html += '<tr><td style="color:#c0d8f0;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + st.term + '</td>';
        html += '<td>' + st.impressions.toLocaleString() + '</td>';
        html += '<td style="color:#4285f4;">' + st.clicks.toLocaleString() + '</td>';
        html += '<td>' + (st.ctr * 100).toFixed(2) + '%</td>';
        html += '<td style="color:#ff4757;">$' + st.cost.toFixed(2) + '</td>';
        html += '<td style="color:#a855f7;">$' + st.avgCPC.toFixed(2) + '</td>';
        html += '<td style="color:#00ff66;">' + st.conversions + '</td></tr>';
      });
      html += '</tbody></table></div></div>';
    }

    // ====== SECTION 7: DEVICE PERFORMANCE ======
    if (ads.devicePerformance.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-head" style="color:#ff9f43;--gc:#ff9f43;"><span class="dot" style="background:#ff9f43;"></span>DEVICE BREAKDOWN</div>';
      html += '<div class="kpi-row">';
      ads.devicePerformance.forEach(function(d) {
        var icon = d.device === 'MOBILE' ? 'ðŸ“±' : d.device === 'DESKTOP' ? 'ðŸ–¥ï¸' : d.device === 'TABLET' ? 'ðŸ“‹' : 'ðŸ“º';
        html += '<div class="kpi" style="--c:#ff9f43;"><div class="kpi-label">' + icon + ' ' + d.device + '</div><div class="kpi-val">' + d.clicks.toLocaleString() + '</div><div class="kpi-sub">$' + d.cost.toLocaleString() + ' spent &bull; ' + d.ctr + '% CTR &bull; $' + d.avgCPC + ' CPC</div></div>';
      });
      html += '</div></div>';
    }

    // ====== SECTION 8: HOURLY + DOW HEATMAP ======
    if (ads.hourlyPerformance.length > 0) {
      html += '<div class="section">';
      html += '<div class="section-head" style="color:#00d4ff;--gc:#00d4ff;"><span class="dot" style="background:#00d4ff;"></span>TIME-BASED PERFORMANCE</div>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">';

      // Hourly chart
      html += '<div class="chart-box"><div class="chart-title" style="color:#00d4ff;">CLICKS BY HOUR</div>';
      var maxHrClicks = Math.max.apply(null, ads.hourlyPerformance.map(function(h){return h.clicks;}));
      html += '<div style="display:flex;align-items:flex-end;gap:2px;height:100px;">';
      ads.hourlyPerformance.forEach(function(h) {
        var ht = maxHrClicks > 0 ? Math.max(1, Math.round(h.clicks / maxHrClicks * 100)) : 1;
        html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;">';
        html += '<div style="width:90%;height:' + ht + '%;background:#00d4ff40;border-top:1px solid #00d4ff;"></div>';
        html += '<div style="font-size:0.35em;color:#4a6a8a;margin-top:2px;">' + h.hour + '</div></div>';
      });
      html += '</div></div>';

      // DOW chart
      html += '<div class="chart-box"><div class="chart-title" style="color:#ff9f43;">CLICKS BY DAY OF WEEK</div>';
      var maxDowClicks = Math.max.apply(null, ads.dayOfWeekPerformance.map(function(d){return d.clicks;}));
      html += '<div style="display:flex;align-items:flex-end;gap:6px;height:100px;">';
      ads.dayOfWeekPerformance.forEach(function(d) {
        var dt2 = maxDowClicks > 0 ? Math.max(3, Math.round(d.clicks / maxDowClicks * 100)) : 3;
        html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;">';
        html += '<div style="color:#c0d8f0;font-size:0.55em;">' + d.clicks.toLocaleString() + '</div>';
        html += '<div style="width:80%;height:' + dt2 + '%;background:#ff9f4340;border-top:2px solid #ff9f43;"></div>';
        html += '<div style="font-family:Orbitron;font-size:0.4em;color:#4a6a8a;margin-top:4px;">' + d.day.substring(0, 3) + '</div></div>';
      });
      html += '</div></div></div></div>';
    }

    // ====== SECTION 9: AI STRATEGY SIGNAL ======
    html += '<div class="section">';
    html += '<div class="section-head" style="color:#ffd700;--gc:#ffd700;"><span class="dot" style="background:#ffd700;"></span>AI STRATEGY SIGNALS</div>';
    var signals = [];
    if (as.avgCPC > cpcFib['61.8'] && cpcFib['61.8'] > 0) signals.push('âš ï¸ CPC above 61.8% Fibonacci resistance ($' + cpcFib['61.8'] + '). Review bids and quality scores.');
    if (as.avgCPC < cpcFib['38.2'] && cpcFib['38.2'] > 0) signals.push('âœ… CPC below 38.2% support ($' + cpcFib['38.2'] + '). Efficiency is strong.');
    if (convGrowth.mom > 10) signals.push('ðŸš€ Conversions up ' + convGrowth.mom + '% MoM â€” scale budget!');
    if (convGrowth.mom < -10) signals.push('âš ï¸ Conversions down ' + convGrowth.mom + '% MoM â€” check landing pages and ad copy.');
    if (costGrowth.mom > 20 && convGrowth.mom < 5) signals.push('ðŸ”´ Spend growing (' + costGrowth.mom + '%) faster than conversions (' + convGrowth.mom + '%). Reduce waste.');
    if (as.roas > 5) signals.push('ðŸ’° ROAS is ' + as.roas + 'x â€” ads are highly profitable. Consider scaling budget.');
    if (as.roas > 0 && as.roas < 2) signals.push('âš¡ ROAS is ' + as.roas + 'x â€” below break-even zone. Optimize or pause underperformers.');
    if (ads.keywords.filter(function(k){return k.qualityScore > 0 && k.qualityScore < 5;}).length > 5) signals.push('ðŸ“ ' + ads.keywords.filter(function(k){return k.qualityScore > 0 && k.qualityScore < 5;}).length + ' keywords with Quality Score < 5. Improve ad relevance and landing pages.');
    if (signals.length === 0) signals.push('ðŸ“Š Connect Google Ads and allow data to accumulate for AI strategy recommendations.');

    signals.forEach(function(s) {
      var sColor = s.startsWith('âœ…') || s.startsWith('ðŸ’°') || s.startsWith('ðŸš€') ? '#00ff66' : s.startsWith('âš ï¸') || s.startsWith('ðŸ”´') ? '#ff4757' : '#ff9f43';
      html += '<div class="signal-box" style="border-color:' + sColor + '30;background:' + sColor + '05;color:' + sColor + ';margin-bottom:6px;">' + s + '</div>';
    });
    html += '</div>';

    // ====== SECTIONS 10-16: EXPANDED ANALYTICS ======

    html += '<div style="text-align:center;padding:30px;font-family:Orbitron;font-size:0.5em;letter-spacing:3px;color:#1a2a3a;border-top:1px solid #0a1520;">WILDWOOD ADS INTELLIGENCE v1.0 // ' + ads.campaigns.length + ' campaigns &bull; ' + ads.keywords.length + ' keywords &bull; ' + ads.dailyPerformance.length + ' daily records</div>';

    // ====== JAVASCRIPT â€” Interactive Charts ======
    html += '<script>';
    html += 'var dailyData=' + JSON.stringify(ads.dailyPerformance) + ';';
    html += 'var allCampaigns=' + JSON.stringify(ads.campaigns.map(function(c){return{name:c.name,status:c.status};})) + ';';

    // Client-side range filter
    html += 'var currentMetric="cost";';
    html += 'function filterByRange(){';
    html += '  var rangeVal=document.getElementById("adsRange").value;';
    html += '  var cutoff="0000";';
    html += '  if(rangeVal==="thismonth"){var d=new Date();cutoff=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-01";}';
    html += '  else if(rangeVal==="thisyear"){cutoff=new Date().getFullYear()+"-01-01";}';
    html += '  else{var range=parseInt(rangeVal)||0;if(range>0)cutoff=new Date(Date.now()-range*86400000).toISOString().substring(0,10);}';
    html += '  var fd=dailyData.filter(function(d){return d.date>=cutoff;});';
    html += '  var ts=0,tc=0,ti=0,tv=0,tvv=0;';
    html += '  fd.forEach(function(d){ts+=d.cost||0;tc+=d.clicks||0;ti+=d.impressions||0;tv+=d.conversions||0;tvv+=d.convValue||0;});';
    html += '  var actr=ti>0?(tc/ti*100):0;';
    html += '  var acpc=tc>0?(ts/tc):0;';
    html += '  var acpconv=tv>0?(ts/tv):0;';
    html += '  var aroas=ts>0?(tvv/ts):0;';
    html += '  var activeCamp=allCampaigns.filter(function(c){return c.status==="ENABLED";}).length;';
    html += '  var kpis=[';
    html += '    {label:"TOTAL SPEND",val:"$"+Math.round(ts).toLocaleString(),sub:activeCamp+" active campaigns",c:"#ff4757"},';
    html += '    {label:"TOTAL CLICKS",val:tc.toLocaleString(),sub:actr.toFixed(2)+"% CTR",c:"#4285f4"},';
    html += '    {label:"IMPRESSIONS",val:ti.toLocaleString(),sub:"Across all campaigns",c:"#00d4ff"},';
    html += '    {label:"CONVERSIONS",val:Math.round(tv*100)/100,sub:"$"+acpconv.toFixed(2)+" per conversion",c:"#00ff66"},';
    html += '    {label:"CONV. VALUE",val:"$"+Math.round(tvv).toLocaleString(),sub:aroas.toFixed(2)+"x ROAS",c:"#ffd700"},';
    html += '    {label:"AVG CPC",val:"$"+acpc.toFixed(2),sub:"Cost per click",c:"#a855f7"},';
    html += '    {label:"AVG CTR",val:actr.toFixed(2)+"%",sub:"Click-through rate",c:"#55f7d8"},';
    html += '    {label:"COST/CONVERSION",val:"$"+acpconv.toFixed(2),sub:"Avg acquisition cost",c:"#ff9f43"},';
    html += '  ];';
    html += '  var h="";kpis.forEach(function(k){';
    html += '    h+="<div class=\\"kpi\\" style=\\"--c:"+k.c+";\\"><div class=\\"kpi-label\\">"+k.label+"</div><div class=\\"kpi-val\\">"+k.val+"</div><div class=\\"kpi-sub\\">"+k.sub+"</div></div>";';
    html += '  });';
    html += '  document.getElementById("kpi-row").innerHTML=h;';
    html += '  if(typeof switchMetric==="function")switchMetric(currentMetric);';
    html += '}';

    html += 'window.addEventListener("load",function(){';
    html += 'if(dailyData.length < 2) return;';
    html += 'var chartOpts={layout:{background:{color:"#050d18"},textColor:"#4a6a8a",fontSize:11},grid:{vertLines:{color:"#0a1520"},horzLines:{color:"#0a1520"}},crosshair:{mode:0},timeScale:{borderColor:"#1a2a3a",timeVisible:false},rightPriceScale:{borderColor:"#1a2a3a"}};';
    html += 'var el=document.getElementById("ads-daily-chart");';
    html += 'if(!el)return;';
    html += 'var chart=LightweightCharts.createChart(el,Object.assign({},chartOpts,{width:el.offsetWidth,height:350}));';
    html += 'var series=chart.addLineSeries({color:"#4285f4",lineWidth:2});';

    html += 'window.switchMetric=function(metric){';
    html += 'currentMetric=metric;';
    html += 'var rangeVal=document.getElementById("adsRange").value;';
    html += 'var cutoff="0000";';
    html += 'if(rangeVal==="thismonth"){var d2=new Date();cutoff=d2.getFullYear()+"-"+String(d2.getMonth()+1).padStart(2,"0")+"-01";}';
    html += 'else if(rangeVal==="thisyear"){cutoff=new Date().getFullYear()+"-01-01";}';
    html += 'else{var range=parseInt(rangeVal)||0;if(range>0)cutoff=new Date(Date.now()-range*86400000).toISOString().substring(0,10);}';
    html += 'var filtered=dailyData.filter(function(r){return r.date>=cutoff;});';
    html += 'var d=filtered.map(function(r){return{time:r.date,value:r[metric]||0};});';
    html += 'series.setData(d);chart.timeScale().fitContent();';
    html += 'var colors={cost:"#ff4757",clicks:"#4285f4",conversions:"#00ff66",ctr:"#55f7d8",avgCPC:"#a855f7",roas:"#ffd700"};';
    html += 'series.applyOptions({color:colors[metric]||"#4285f4"});';
    html += 'document.querySelectorAll(".mbtn").forEach(function(b){b.style.background="#0a1520";b.style.color="#4a6a8a";b.style.borderColor="#1a2a3a";});';
    html += 'var btnMap={cost:"btn-m-cost",clicks:"btn-m-clicks",conversions:"btn-m-conv",ctr:"btn-m-ctr",avgCPC:"btn-m-cpc",roas:"btn-m-roas"};';
    html += 'var btn=document.getElementById(btnMap[metric]);';
    html += 'if(btn){btn.style.background="rgba(66,133,244,0.15)";btn.style.color="#4285f4";btn.style.borderColor="#4285f440";}';
    html += '};';

    // Initial render
    html += 'switchMetric("cost");';
    html += 'filterByRange();';

    html += 'window.addEventListener("resize",function(){chart.applyOptions({width:el.offsetWidth});});';
    html += '});';
    html += '<\/script>';

    html += '</div></body></html>';
    res.send(html);
  } catch (err) {
    console.error("Ads dashboard error:", err.stack || err.message);
    res.status(500).json({ error: err.message });
  }
});

app.get('/tookan/json', async function(req, res) {
  try {
    var tk = await buildTookanContext();
    res.json(tk);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Force refresh Tookan cache
app.get('/tookan/refresh', async function(req, res) {
  tookanCache = { data: null, time: 0 };
  try {
    var tk = await buildTookanContext();
    res.json({ status: 'refreshed', tasks: tk.totalTasks, completed: tk.completed, agents: tk.agents.length });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});



/* ===========================
   FOLLOW UP PORTAL â€” FULL FEATURED
   Features:
   - Login from separate password sheet
   - PDF upload to Google Drive
   - Write to monthly "Follow ups of..." tabs
   - ON TIME / LATE detection
   - Admin email notification
   - DropDown tracker update
   - AI audit via OpenAI
   - Performance chart (on-time vs late)
   - Submission history
   - Reminder checking (cron-like)
   - Standalone nav (no JARVIS/ATHENA access)
=========================== */

var fuSessions = {};

// â”€â”€ HELPERS â”€â”€

// Read any sheet by spreadsheet ID + range
async function fuReadSheet(spreadsheetId, range) {
  try {
    var result = await sheets.spreadsheets.values.get({ spreadsheetId: spreadsheetId, range: range });
    return result.data.values || [];
  } catch (err) {
    console.log("FU sheet read error (" + range + "):", err.message);
    return [];
  }
}

// Append to sheet
async function fuAppendSheet(spreadsheetId, range, values) {
  try {
    await sheets.spreadsheets.values.append({
      spreadsheetId: spreadsheetId,
      range: range,
      valueInputOption: 'USER_ENTERED',
      requestBody: { values: values },
    });
    return true;
  } catch (err) {
    console.log("FU sheet append error:", err.message);
    return false;
  }
}

// Update specific cells
async function fuUpdateSheet(spreadsheetId, range, values) {
  try {
    await sheets.spreadsheets.values.update({
      spreadsheetId: spreadsheetId,
      range: range,
      valueInputOption: 'USER_ENTERED',
      requestBody: { values: values },
    });
    return true;
  } catch (err) {
    console.log("FU sheet update error:", err.message);
    return false;
  }
}

// Get all tab names
async function fuGetTabs(spreadsheetId) {
  try {
    var result = await sheets.spreadsheets.get({ spreadsheetId: spreadsheetId });
    return result.data.sheets.map(function(s) { return s.properties.title; });
  } catch (err) {
    console.log("FU tabs error:", err.message);
    return [];
  }
}

// Get current month tab name
function fuGetMonthTabName() {
  var now = new Date();
  var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return 'Follow ups of ' + months[now.getMonth()] + ' ' + now.getFullYear();
}

// Check if upload was this week (Mon-Sun)
function fuIsThisWeek(dateStr) {
  if (!dateStr) return false;
  var d = new Date(dateStr);
  if (isNaN(d.getTime())) return false;
  var now = new Date();
  var startOfWeek = new Date(now);
  var day = startOfWeek.getDay() || 7;
  if (day !== 1) startOfWeek.setDate(startOfWeek.getDate() - (day - 1));
  startOfWeek.setHours(0, 0, 0, 0);
  return d >= startOfWeek;
}

// Determine ON TIME vs LATE
function fuGetSubmitStatus() {
  var now = new Date();
  var day = now.getDay(); // 0=Sun, 6=Sat
  if (day === 6 || day === 0 || day === 1) {
    return { status: 'LATE', color: '#ff4750' };
  }
  return { status: 'ON TIME', color: '#10b981' };
}

// Get users from password sheet
async function fuGetUsers() {
  try {
    var rows = await fuReadSheet(FOLLOWUP_PASSWORD_SHEET_ID, "'" + FOLLOWUP_PASSWORD_TAB + "'!A:C");
    console.log("FU Users: read " + rows.length + " rows from password sheet");
    if (rows.length < 2) return [];
    return rows.slice(1).map(function(r) {
      return { name: (r[0] || '').trim(), password: (r[1] || '').trim(), role: (r[2] || 'employee').trim().toLowerCase() };
    }).filter(function(u) { return u.name && u.password; });
  } catch (err) {
    console.log("FU Users ERROR: " + err.message + " â€” Make sure sheet " + FOLLOWUP_PASSWORD_SHEET_ID + " is shared with service account");
    return [];
  }
}

// Get employees from DropDown tab
async function fuGetEmployees() {
  var rows = await fuReadSheet(FOLLOWUP_SPREADSHEET_ID, "'DropDown'!A:E");
  if (rows.length < 2) return [];
  return rows.slice(1).map(function(r, idx) {
    return {
      name: (r[0] || '').trim(),
      email: (r[1] || '').trim(),
      reminderEmail: (r[2] || '').trim(),
      lastUpload: r[3] || '',
      lastReminder: r[4] || '',
      row: idx + 2
    };
  }).filter(function(e) { return e.name; });
}

// Get submission history
async function fuGetHistory(userName, isAdmin) {
  var tabs = await fuGetTabs(FOLLOWUP_SPREADSHEET_ID);
  var followUpTabs = tabs.filter(function(t) { return t.toLowerCase().startsWith('follow ups of'); });
  var allRows = [];

  for (var i = 0; i < followUpTabs.length; i++) {
    var tabName = followUpTabs[i];
    try {
      var rows = await fuReadSheet(FOLLOWUP_SPREADSHEET_ID, "'" + tabName + "'!A:H");
      if (rows.length < 2) continue;
      for (var j = 1; j < rows.length; j++) {
        var r = rows[j];
        var name = (r[1] || '').trim();
        if (isAdmin || name.toLowerCase() === userName.toLowerCase()) {
          allRows.push({
            timestamp: r[0] || '',
            name: name,
            emailSentTo: r[2] || '',
            fileName: r[3] || '',
            fileLink: r[4] || '',
            aiAudit: r[5] || '',
            suggestions: r[6] || '',
            reason: r[7] || '',
            tab: tabName
          });
        }
      }
    } catch (e) { /* skip */ }
  }

  allRows.sort(function(a, b) { return new Date(b.timestamp) - new Date(a.timestamp); });
  return allRows;
}

// Get chart data
async function fuGetChartData() {
  var rows = await fuReadSheet(FOLLOWUP_SPREADSHEET_ID, "'Chart'!A:C");
  if (rows.length < 2) return [];
  return rows.slice(1).map(function(r) {
    return { name: (r[0] || '').trim(), onTime: parseFloat(r[1]) || 0, late: parseFloat(r[2]) || 0 };
  }).filter(function(c) { return c.name; });
}

// Upload PDF to Google Drive
async function fuUploadToDrive(base64Data, fileName) {
  try {
    // Store PDF in a "PDF_Storage" tab on the follow-up sheet
    var storageTab = 'PDF_Storage';
    var tabs = await fuGetTabs(FOLLOWUP_SPREADSHEET_ID);
    if (tabs.indexOf(storageTab) === -1) {
      await sheets.spreadsheets.batchUpdate({
        spreadsheetId: FOLLOWUP_SPREADSHEET_ID,
        requestBody: { requests: [{ addSheet: { properties: { title: storageTab } } }] }
      });
      await fuAppendSheet(FOLLOWUP_SPREADSHEET_ID, "'" + storageTab + "'!A1:D1",
        [['ID', 'FileName', 'Timestamp', 'Base64Data']]);
    }

    // Generate unique ID
    var pdfId = 'pdf_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);

    // Store in sheet (split base64 into chunks if needed â€” sheets max ~50k chars per cell)
    var chunks = [];
    for (var i = 0; i < base64Data.length; i += 49000) {
      chunks.push(base64Data.substring(i, i + 49000));
    }

    // First chunk goes in column D, extras in E, F, etc.
    var row = [pdfId, fileName, new Date().toISOString()];
    chunks.forEach(function(c) { row.push(c); });

    await fuAppendSheet(FOLLOWUP_SPREADSHEET_ID, "'" + storageTab + "'!A:Z", [row]);

    var viewUrl = '/followup/pdf/' + pdfId;
    console.log("FU: Stored PDF '" + fileName + "' in sheet as " + pdfId + " (" + chunks.length + " chunks)");

    return {
      id: pdfId,
      url: viewUrl,
    };
  } catch (err) {
    console.log("FU: PDF storage error:", err.message);
    throw err;
  }
}

// Update DropDown tracker (Column D = last upload, Column E = clear)
async function fuUpdateTracker(userName) {
  try {
    var employees = await fuGetEmployees();
    for (var i = 0; i < employees.length; i++) {
      if (employees[i].name.toLowerCase() === userName.toLowerCase()) {
        var row = employees[i].row;
        await fuUpdateSheet(FOLLOWUP_SPREADSHEET_ID, "'DropDown'!D" + row + ":E" + row, [[new Date().toISOString(), '']]);
        return true;
      }
    }
  } catch (err) {
    console.log("Tracker update error:", err.message);
  }
  return false;
}

// Update Chart tab
async function fuUpdateChart(userName, isOnTime) {
  try {
    var chartData = await fuReadSheet(FOLLOWUP_SPREADSHEET_ID, "'Chart'!A:C");
    var found = false;
    for (var i = 1; i < chartData.length; i++) {
      if ((chartData[i][0] || '').trim().toLowerCase() === userName.toLowerCase()) {
        var onTime = parseFloat(chartData[i][1]) || 0;
        var late = parseFloat(chartData[i][2]) || 0;
        if (isOnTime) onTime++; else late++;
        await fuUpdateSheet(FOLLOWUP_SPREADSHEET_ID, "'Chart'!B" + (i + 1) + ":C" + (i + 1), [[onTime, late]]);
        found = true;
        break;
      }
    }
    if (!found) {
      await fuAppendSheet(FOLLOWUP_SPREADSHEET_ID, "'Chart'!A:C", [[userName, isOnTime ? 1 : 0, isOnTime ? 0 : 1]]);
    }
  } catch (err) {
    console.log("Chart update error:", err.message);
  }
}

// Send admin notification email via Gmail API (best effort)
async function fuSendAdminEmail(name, fileName, fileUrl, statusMsg, statusColor) {
  try {
    // Try to use first available Gmail account
    var accounts = Object.keys(global.gmailTokens || {});
    if (!accounts.length) {
      console.log("FU Email: No Gmail accounts configured, skipping email notification");
      return false;
    }

    var account = accounts[0];
    var tokens = global.gmailTokens[account];
    if (!tokens || !tokens.access_token) {
      console.log("FU Email: No valid token for " + account);
      return false;
    }

    // Refresh token if needed
    if (tokens.expiry_date && Date.now() > tokens.expiry_date) {
      try {
        var refreshRes = await fetch('https://oauth2.googleapis.com/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'grant_type=refresh_token&refresh_token=' + encodeURIComponent(tokens.refresh_token) +
                '&client_id=' + encodeURIComponent(process.env.GMAIL_CLIENT_ID || '') +
                '&client_secret=' + encodeURIComponent(process.env.GMAIL_CLIENT_SECRET || '')
        });
        var refreshData = await refreshRes.json();
        if (refreshData.access_token) {
          tokens.access_token = refreshData.access_token;
          tokens.expiry_date = Date.now() + (refreshData.expires_in * 1000);
        }
      } catch (re) { /* use existing token */ }
    }

    var subject = 'Weekly Report: ' + name + ' - ' + statusMsg;
    var htmlBody = '<h3>Weekly Report Submitted</h3>' +
      '<p><b>Staff Name:</b> ' + name + '</p>' +
      '<p><b>File Name:</b> ' + fileName + '</p>' +
      '<p><b>Submission Status:</b> <span style="color:' + statusColor + '; font-weight:bold;">' + statusMsg + '</span></p>' +
      '<p><b>File Link:</b> <a href="' + fileUrl + '">' + fileUrl + '</a></p>' +
      '<br><p><i>Submitted via Follow Up Portal</i></p>';

    var to = FOLLOWUP_ADMIN_EMAIL;
    var cc = FOLLOWUP_CC_EMAIL;
    var rawEmail = 'From: ' + account + '\r\n' +
      'To: ' + to + '\r\n' +
      'Cc: ' + cc + '\r\n' +
      'Subject: ' + subject + '\r\n' +
      'MIME-Version: 1.0\r\n' +
      'Content-Type: text/html; charset=UTF-8\r\n\r\n' +
      htmlBody;

    var encoded = Buffer.from(rawEmail).toString('base64').replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

    var sendRes = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + tokens.access_token,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ raw: encoded }),
    });

    if (sendRes.ok) {
      console.log("FU Email sent to " + to + " about " + name);
      return true;
    } else {
      var errBody = await sendRes.text();
      console.log("FU Email send error:", errBody.substring(0, 200));
      return false;
    }
  } catch (err) {
    console.log("FU Email error:", err.message);
    return false;
  }
}

// Run AI audit on a PDF (OpenAI)
async function fuRunAIAudit(pdfText) {
  if (!FOLLOWUP_OPENAI_KEY) return { audit: '', suggestions: '' };

  try {
    var prompt = 'You are a Senior Project Manager validating billing hours.\n' +
      'GOAL: The worker claims 40 hours/week.\n' +
      'CONTEXT: The worker is HUMAN. The work involves manual data entry, reading, cross-referencing, and formatting.\n' +
      'The Iceberg Rule: The text below is just a summary. Actual work involved opening hundreds of tabs, waiting for loads, fixing formatting, double-checking data.\n' +
      'TASK:\n' +
      '1. AUDIT WITH EMPATHY: assume 3x multiplier on every task. If work looks substantial, default to "40 Hours Justified". Only reject if document is almost empty.\n' +
      '2. SUGGEST: Only if work is truly <20h, suggest complex tasks to add.\n' +
      '3. REASON: If hours do NOT add up to 40, explain WHY in 1-2 sentences. What was missing? What tasks seemed too light? Where did the time gap come from? If 40 Hours Justified, say "All hours accounted for.".\n\n' +
      'INPUT SUMMARY:\n"' + pdfText.substring(0, 15000) + '"\n\n' +
      'OUTPUT FORMAT (JSON Only):\n{"audit": "Verdict (e.g. 40 Hours Justified or Realistically 28 Hours)", "reason": "Why it did or did not add up to 40", "suggestions": "Advice or empty string"}';

    var res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + FOLLOWUP_OPENAI_KEY,
      },
      body: JSON.stringify({
        model: 'gpt-3.5-turbo',
        response_format: { type: 'json_object' },
        messages: [
          { role: 'system', content: 'You are a realistic estimator. Manual human work is slow and prone to delays. Value thoroughness over speed.' },
          { role: 'user', content: prompt }
        ],
        temperature: 0.4,
      }),
    });

    var data = await res.json();
    if (data.choices && data.choices[0]) {
      var content = JSON.parse(data.choices[0].message.content);
      return { audit: content.audit || '', reason: content.reason || '', suggestions: content.suggestions || '' };
    }
    return { audit: '', reason: '', suggestions: '' };
  } catch (err) {
    console.log("FU AI audit error:", err.message);
    return { audit: 'ERROR: AI Audit Failed: ' + err.message, reason: '', suggestions: '' };
  }
}

/* ===========================
   DISCORD INTEGRATION
=========================== */

// Discord Messages API
app.get('/discord/api/channels', async function(req, res) {
  var channels = await discordGetChannels();
  res.json({ channels: channels.map(function(c) { return { id: c.id, name: c.name, position: c.position }; }) });
});

app.get('/discord/api/messages', async function(req, res) {
  var channelId = req.query.channel;
  var limit = parseInt(req.query.limit) || 50;
  if (channelId) {
    var msgs = await discordGetMessages(channelId, limit);
    res.json({ messages: msgs });
  } else {
    var all = await discordGetAllRecent(limit);
    res.json({ messages: all });
  }
});

// AI Analysis of Discord messages
app.post('/discord/api/analyze', express.json(), async function(req, res) {
  try {
    var channelId = req.body.channel || '';
    var limit = req.body.limit || 50;
    var msgs;
    if (channelId) {
      msgs = await discordGetMessages(channelId, limit);
      msgs = msgs.map(function(m) {
        return { author: m.author ? m.author.username : '?', content: m.content, time: m.timestamp };
      });
    } else {
      msgs = await discordGetAllRecent(limit);
    }

    if (msgs.length === 0) return res.json({ analysis: 'No messages found.' });

    var msgText = msgs.slice(0, 80).map(function(m) {
      return (m.author || '') + ' (' + (m.channel || '') + '): ' + (m.content || '').substring(0, 300);
    }).join('\n');

    var analysis = await askClaude(
      "You are ATHENA, business AI for Wildwood Small Engine Repair. Analyze these Discord messages from the team server. Give:\n" +
      "1. COMMUNICATION QUALITY: Are messages clear, professional, actionable? Rate 1-10.\n" +
      "2. RESPONSE TIME: Are people responding quickly or leaving things hanging?\n" +
      "3. TOP ISSUES: What topics/problems keep coming up?\n" +
      "4. IMPROVEMENTS: Specific ways to improve team communication (be direct, give examples of better phrasing).\n" +
      "5. WHO'S ACTIVE: Who's contributing most vs who's quiet?\n" +
      "6. ACTION ITEMS: Any messages that need follow-up but didn't get one?\n\n" +
      "Keep it practical and specific. No generic advice. Use names and quote actual message issues.\n" +
      "Format as plain readable text, no markdown.",
      [{ role: 'user', content: 'Analyze these Discord messages:\n\n' + msgText }]
    );

    res.json({ analysis: analysis });
  } catch (err) {
    res.json({ analysis: 'Error: ' + err.message });
  }
});

// Response rate analytics per person
app.get('/discord/api/response-rates', async function(req, res) {
  try { res.json({ people: await discordAnalyzeResponseRates() }); }
  catch (err) { res.json({ people: [], error: err.message }); }
});

// Quiet channels detection
app.get('/discord/api/quiet', async function(req, res) {
  res.json({ channels: await discordGetQuietChannels() });
});

// AI message suggestions
app.post('/discord/api/suggest', express.json(), async function(req, res) {
  try {
    var quiet = await discordGetQuietChannels();
    var allMsgs = await discordGetAllRecent(40);
    var bm = global.bizMetrics || {}; var fu = global.followUpMetrics || {};
    var bizSnap = 'TODAY: ' + new Date().toLocaleDateString('en-US', {weekday:'long',month:'long',day:'numeric',year:'numeric'}) + '\n';
    if (bm.totalLeads) bizSnap += 'CRM: ' + (bm.totalBooked||0) + ' booked, ' + (bm.totalCancelled||0) + ' cancelled\n';
    if (fu) { var pend = (fu.employees||[]).filter(function(e){return !e.submittedThisWeek;}); if (pend.length > 0) bizSnap += 'FOLLOW-UPS PENDING: ' + pend.map(function(e){return e.name;}).join(', ') + '\n'; }
    var quietInfo = quiet.filter(function(c){return c.isQuiet;}).map(function(c){ return '#'+c.name+' â€” '+c.hoursSince+'h ago'; }).join('\n');
    var recentSample = allMsgs.slice(0,25).map(function(m){ return '#'+(m.channel||'')+' | '+(m.author||'')+': '+(m.content||'').substring(0,150); }).join('\n');
    var prompt = "You are ATHENA, AI for Wildwood Small Engine Repair. Generate 3-5 Discord messages to send.\n\nBUSINESS: " + bizSnap + "\n";
    if (quietInfo) prompt += "QUIET CHANNELS:\n" + quietInfo + "\n";
    prompt += "RECENT:\n" + recentSample + "\n";
    if (req.body.channel) prompt += "FOCUS: #" + req.body.channel + "\n";
    prompt += "\nReturn ONLY JSON array. Each: {\"channel\":\"name\",\"message\":\"text\",\"reason\":\"why\",\"priority\":\"high|medium|low\"}\nNo markdown.";
    var raw = await askClaude(prompt, [{ role: 'user', content: 'Generate suggestions now.' }]);
    var suggestions = []; try { suggestions = JSON.parse((raw||'').replace(/```json|```/g,'').trim()); } catch(e) { suggestions = [{channel:'general',message:raw,reason:'AI',priority:'medium'}]; }
    var chs = await discordGetChannels();
    suggestions.forEach(function(s) { var m = chs.find(function(c){return c.name.toLowerCase()===(s.channel||'').toLowerCase().replace('#','');}); s.channelId = m ? m.id : ''; });
    res.json({ suggestions: suggestions, quietChannels: quiet.filter(function(c){return c.isQuiet;}) });
  } catch (err) { res.json({ suggestions: [], error: err.message }); }
});

// Send message to Discord
app.post('/discord/api/send', express.json(), async function(req, res) {
  try {
    if (!req.body.channelId || !req.body.message) return res.json({ success: false, error: 'Missing data' });
    var result = await discordSendMessage(req.body.channelId, req.body.message);
    res.json(result ? { success: true, messageId: result.id } : { success: false, error: 'Send failed' });
  } catch (err) { res.json({ success: false, error: err.message }); }
});

// System improvement analysis
app.post('/discord/api/improve', express.json(), async function(req, res) {
  try {
    var allMsgs = await discordGetAllRecent(100);
    if (allMsgs.length === 0) return res.json({ analysis: 'No messages.' });
    var msgText = allMsgs.slice(0,100).map(function(m){ return '#'+(m.channel||'')+' | '+(m.author||'')+': '+(m.content||'').substring(0,200); }).join('\n');
    var analysis = await askClaude(
      "Analyze these Discord messages for SYSTEM AND PROCESS IMPROVEMENTS. Find: 1)Recurring problems 2)Communication gaps 3)Process breakdowns 4)Training needs 5)Customer impact 6)Quick wins 7)SOP gaps. Cite names and messages. Plain text, be direct.",
      [{ role: 'user', content: msgText }]
    );
    res.json({ analysis: analysis });
  } catch (err) { res.json({ analysis: 'Error: ' + err.message }); }
});


// ==============================
// SQUARE API ENDPOINTS
// ==============================
app.get('/square/api/snapshot', async function(req, res) {
  try {
    var forceRefresh = req.query.refresh === '1';
    var snap = await squareFullSnapshot(forceRefresh);
    var locFilter = req.query.location || '';
    var filteredSnap = snap;
    if (locFilter && locFilter !== 'all') {
      var filterIds = locFilter.split(',');
      filteredSnap = {
        locations: (snap.locations||[]).filter(function(l){return filterIds.indexOf(l.id)>=0;}),
        payments: (snap.payments||[]).filter(function(p){return filterIds.indexOf(p.location_id)>=0;}),
        orders: (snap.orders||[]).filter(function(o){return filterIds.indexOf(o.location_id)>=0;}),
        invoices: (snap.invoices||[]).filter(function(i){return filterIds.indexOf(i.location_id)>=0||(i.primary_recipient&&filterIds.indexOf(i.primary_recipient.location_id)>=0);}),
        customers: snap.customers || [],
        catalog: snap.catalog || [],
        teamMembers: snap.teamMembers || [],
        bankAccounts: snap.bankAccounts || [],
        merchants: snap.merchants || [],
        disputes: snap.disputes || [],
        refunds: snap.refunds || [],
        subscriptions: snap.subscriptions || [],
        loyalty: snap.loyalty || [],
        giftCards: snap.giftCards || [],
        bookings: snap.bookings || [],
        shifts: snap.shifts || [],
        breakTypes: snap.breakTypes || [],
        cashDrawers: snap.cashDrawers || [],
        customerSegments: snap.customerSegments || [],
        customerGroups: snap.customerGroups || []
      };
    }
    var a = squareAnalyze(filteredSnap);
    var payments = filteredSnap.payments || []; var customers = filteredSnap.customers || [];
    var invoices = filteredSnap.invoices || []; var orders = filteredSnap.orders || [];

    res.json({
      selectedLocation: locFilter || 'all',
      debug: { token_prefix: SQUARE_ACCESS_TOKEN ? SQUARE_ACCESS_TOKEN.substring(0,12)+'...' : 'NOT SET', base_url: SQUARE_BASE, square_env: process.env.SQUARE_ENV || 'NOT SET', raw_payments: payments.length, raw_orders: orders.length, raw_invoices: invoices.length, raw_customers: customers.length, locations: (snap.locations||[]).length, filtered: locFilter ? true : false, cached: squareDataStore.initialized, cache_age_sec: squareDataStore.lastIncrFetch ? Math.round((Date.now()-squareDataStore.lastIncrFetch)/1000) : 0 },
      allLocations: (snap.locations||[]).map(function(l) { return { id:l.id, name:l.name, city:l.address&&l.address.locality?l.address.locality:'', state:l.address&&l.address.administrative_district_level_1?l.address.administrative_district_level_1:'' }; }),
      analytics: a,
      locations: (filteredSnap.locations||[]).map(function(l) { return { id:l.id, name:l.name, address:l.address, status:l.status, timezone:l.timezone, currency:l.currency, country:l.country, phone:l.phone_number, businessName:l.business_name, businessEmail:l.business_email, description:l.description, capabilities:l.capabilities }; }),
      recentPayments: payments.slice(0,30).map(function(p) {
        return { id:p.id, amount:squareMoney(p.amount_money), amountCents:sqCents(p.amount_money), tip:squareMoney(p.tip_money), tipCents:sqCents(p.tip_money), totalMoney:squareMoney(p.total_money), status:p.status, source:p.source_type, created:p.created_at, receiptUrl:p.receipt_url, orderId:p.order_id, locationId:p.location_id, employeeId:p.employee_id, customerId:p.customer_id, refundIds:p.refund_ids, riskEval:p.risk_evaluation?p.risk_evaluation.risk_level:null, cardBrand:p.card_details&&p.card_details.card?p.card_details.card.card_brand:'', last4:p.card_details&&p.card_details.card?p.card_details.card.last_4:'', entryMethod:p.card_details?p.card_details.entry_method:'', processingFee:p.processing_fee&&p.processing_fee[0]?squareMoney(p.processing_fee[0].amount_money):'', note:p.note, buyerEmail:p.buyer_email_address };
      }),
      recentCustomers: customers.slice(0,30).map(function(c) {
        return { id:c.id, givenName:c.given_name, familyName:c.family_name, name:(c.given_name||'')+' '+(c.family_name||''), email:c.email_address, phone:c.phone_number, company:c.company_name, nickname:c.nickname, created:c.created_at, updated:c.updated_at, note:c.note, birthday:c.birthday, address:c.address, referenceId:c.reference_id, groupIds:c.group_ids, segmentIds:c.segment_ids };
      }),
      unpaidInvoices: invoices.filter(function(i){return i.status!=='PAID'&&i.status!=='CANCELED';}).slice(0,20).map(function(inv) {
        var amt=''; var due='';
        if(inv.payment_requests&&inv.payment_requests[0]){ if(inv.payment_requests[0].computed_amount_money) amt=squareMoney(inv.payment_requests[0].computed_amount_money); due=inv.payment_requests[0].due_date||''; }
        return { id:inv.id, invoiceNumber:inv.invoice_number, status:inv.status, amount:amt, due:due, created:inv.created_at, title:inv.title, description:inv.description, deliveryMethod:inv.delivery_method, saleOrServiceDate:inv.sale_or_service_date };
      }),
      recentOrders: orders.slice(0,20).map(function(o) {
        return { id:o.id, state:o.state, created:o.created_at, total:squareMoney(o.total_money), totalTax:squareMoney(o.total_tax_money), totalDiscount:squareMoney(o.total_discount_money), totalTip:squareMoney(o.total_tip_money), source:o.source?o.source.name:'', items:(o.line_items||[]).map(function(li){ return { name:li.name, qty:li.quantity, total:squareMoney(li.total_money), variationName:li.variation_name, modifiers:(li.modifiers||[]).map(function(m){return m.name;}) }; }), discounts:(o.discounts||[]).map(function(d){ return { name:d.name, type:d.type, amount:squareMoney(d.applied_money) }; }) };
      }),
      recentRefunds: (snap.refunds||[]).slice(0,15).map(function(r) { return { id:r.id, amount:squareMoney(r.amount_money), status:r.status, reason:r.reason, created:r.created_at, paymentId:r.payment_id }; }),
      disputes: (snap.disputes||[]).slice(0,15).map(function(d) { return { id:d.dispute_id, amount:squareMoney(d.amount_money), reason:d.reason, state:d.state, created:d.created_at, due:d.due_at, cardBrand:d.card_brand }; }),
      payouts: (snap.payouts||[]).slice(0,15).map(function(p) { return { id:p.id, amount:squareMoney(p.amount), status:p.status, created:p.created_at, arrivalDate:p.arrival_date, type:p.type, destination:p.destination?p.destination.type:'' }; }),
      shifts: (snap.shifts||[]).slice(0,20).map(function(s) { var hrs=s.end_at?((new Date(s.end_at)-new Date(s.start_at))/3600000):0; return { id:s.id, employeeId:s.employee_id||s.team_member_id, start:s.start_at, end:s.end_at, hours:Math.round(hrs*10)/10, wage:s.wage?squareMoney(s.wage.hourly_rate):'', title:s.wage?s.wage.title:'', breaks:(s.breaks||[]).map(function(b){ return { name:b.name, paid:b.is_paid }; }) }; }),
      team: (snap.team||[]).map(function(t) { return { id:t.id, name:(t.given_name||'')+' '+(t.family_name||''), status:t.status, email:t.email_address, phone:t.phone_number }; }),
      catalog: { items:(snap.catalog||[]).filter(function(c){return c.type==='ITEM';}).slice(0,30).map(function(i){ var d=i.item_data||{}; return { id:i.id, name:d.name, description:d.description, variations:(d.variations||[]).map(function(v){ var vd=v.item_variation_data||{}; return { name:vd.name, price:squareMoney(vd.price_money), sku:vd.sku }; }) }; }), categories:(snap.catalog||[]).filter(function(c){return c.type==='CATEGORY';}).map(function(c){ return { id:c.id, name:c.category_data?c.category_data.name:'' }; }), discounts:(snap.catalog||[]).filter(function(c){return c.type==='DISCOUNT';}).map(function(d){ var dd=d.discount_data||{}; return { name:dd.name, type:dd.discount_type, pct:dd.percentage, amount:squareMoney(dd.amount_money) }; }), taxes:(snap.catalog||[]).filter(function(c){return c.type==='TAX';}).map(function(t){ var td=t.tax_data||{}; return { name:td.name, pct:td.percentage }; }) },
      giftCards: (snap.giftCards||[]).slice(0,15).map(function(g) { return { id:g.id, state:g.state, balance:squareMoney(g.balance_money), type:g.type, created:g.created_at, gan:g.gan }; }),
      subscriptions: (snap.subscriptions||[]).slice(0,15).map(function(s) { return { id:s.id, customerId:s.customer_id, status:s.status, startDate:s.start_date, canceledDate:s.canceled_date, chargedThroughDate:s.charged_through_date }; }),
      loyalty: snap.loyalty ? { program:snap.loyalty, accounts:(snap.loyaltyAccounts||[]).slice(0,20).map(function(a){ return { id:a.id, customerId:a.customer_id, balance:a.balance, lifetime:a.lifetime_points }; }) } : null,
      bookings: (snap.bookings||[]).slice(0,15).map(function(b) { return { id:b.id, status:b.status, startAt:b.start_at, customerId:b.customer_id }; }),
      devices: (snap.devices||[]).map(function(d) { return { id:d.id, name:d.name, productType:d.product_type }; }),
      customerGroups: (snap.custGroups||[]).map(function(g) { return { id:g.id, name:g.name }; }),
      customerSegments: (snap.custSegments||[]).map(function(s) { return { id:s.id, name:s.name }; })
    });
  } catch (err) { res.json({ error: err.message }); }
});

app.get('/square/api/locations', async function(req, res) {
  try {
    var locs = await squareGetLocations();
    res.json({ count: locs.length, locations: locs });
  } catch (err) { res.json({ locations: [], error: err.message }); }
});
// ====== SYSTEM AUDIT â€” Cross-Tab Discrepancy Checker ======
async function runSystemAudit() {
  var audit = { timestamp: new Date().toISOString(), checks: [], warnings: [], errors: [], summary: {} };
  
  function check(name, expected, actual, tolerance) {
    tolerance = tolerance || 0.05;
    var diff = expected > 0 ? Math.abs(actual - expected) / expected : (actual === 0 ? 0 : 1);
    var pass = diff <= tolerance;
    var entry = { name: name, expected: Math.round(expected * 100) / 100, actual: Math.round(actual * 100) / 100, diff: Math.round(diff * 10000) / 100 + '%', pass: pass };
    audit.checks.push(entry);
    if (!pass) audit.warnings.push(name + ': expected $' + Math.round(expected).toLocaleString() + ', got $' + Math.round(actual).toLocaleString() + ' (off by ' + entry.diff + ')');
    return pass;
  }

  try {
    // 1. Square Revenue Cross-Check
    var sq = await squareFullSnapshot(false);
    var sqA = squareAnalyze(sq);
    
    var completedOrders = (sq.orders || []).filter(function(o) { return o.state === 'COMPLETED' && o.total_money && o.total_money.amount > 0; });
    var orderRevTotal = completedOrders.reduce(function(sum, o) { return sum + (o.total_money.amount / 100); }, 0);
    var completedPayments = (sq.payments || []).filter(function(p) { return p.status === 'COMPLETED'; });
    var paymentRevTotal = completedPayments.reduce(function(sum, p) { return sum + ((p.amount_money && p.amount_money.amount ? p.amount_money.amount : 0) / 100); }, 0);
    
    audit.summary.square = {
      completedOrders: completedOrders.length,
      completedPayments: completedPayments.length,
      orderRevenue: Math.round(orderRevTotal * 100) / 100,
      paymentRevenue: Math.round(paymentRevTotal * 100) / 100,
      analyzeTotal: Math.round(sqA.revenue.allTimeTotal * 100) / 100,
      locations: (sq.locations || []).length,
      customers: (sq.customers || []).length,
      invoices: (sq.invoices || []).length,
    };

    var monthlyTotal = 0;
    Object.values(sqA.trends.monthlyRevenue || {}).forEach(function(v) { monthlyTotal += v; });
    check('Square: Monthly sums vs All-Time Total', sqA.revenue.allTimeTotal, monthlyTotal, 0.01);
    
    var yearlyTotal = 0;
    Object.values(sqA.trends.yearlyRevenue || {}).forEach(function(v) { yearlyTotal += v; });
    check('Square: Yearly sums vs All-Time Total', sqA.revenue.allTimeTotal, yearlyTotal, 0.01);
    
    check('Square: Order revenue vs Analyze total', orderRevTotal, sqA.revenue.allTimeTotal, 0.02);

    // Per-year detail
    audit.summary.squareYearly = {};
    Object.keys(sqA.trends.yearlyRevenue || {}).sort().forEach(function(y) {
      var yearOrders = completedOrders.filter(function(o) { return (o.created_at || '').startsWith(y); });
      var yearOrderRev = yearOrders.reduce(function(s, o) { return s + (o.total_money.amount / 100); }, 0);
      var yearPayments = completedPayments.filter(function(p) { return (p.created_at || '').startsWith(y); });
      var yearPaymentRev = yearPayments.reduce(function(s, p) { return s + ((p.amount_money && p.amount_money.amount ? p.amount_money.amount : 0) / 100); }, 0);
      audit.summary.squareYearly[y] = {
        reportedRevenue: Math.round(sqA.trends.yearlyRevenue[y] * 100) / 100,
        orderRevenue: Math.round(yearOrderRev * 100) / 100,
        paymentRevenue: Math.round(yearPaymentRev * 100) / 100,
        orders: yearOrders.length,
        payments: yearPayments.length,
      };
      check('Square ' + y + ': reported vs order revenue', sqA.trends.yearlyRevenue[y], yearOrderRev, 0.02);
    });

    // 2. Google Ads Cross-Check
    try {
      var ads = await buildAdsContext();
      audit.summary.googleAds = {
        campaigns: ads.campaigns.length,
        activeCampaigns: ads.campaigns.filter(function(c) { return c.status === 'ENABLED'; }).length,
        keywords: ads.keywords.length,
        searchTerms: ads.searchTerms.length,
        dailyRecords: ads.dailyPerformance.length,
        monthlyRecords: ads.monthlyPerformance.length,
        totalSpend: ads.accountSummary.totalSpend,
        totalClicks: ads.accountSummary.totalClicks,
        totalConversions: ads.accountSummary.totalConversions,
      };
      
      var dailySpendTotal = ads.dailyPerformance.reduce(function(s, d) { return s + d.cost; }, 0);
      var dailyClickTotal = ads.dailyPerformance.reduce(function(s, d) { return s + d.clicks; }, 0);
      check('Google Ads: Daily spend sum vs Account total', ads.accountSummary.totalSpend, Math.round(dailySpendTotal * 100) / 100, 0.05);
      check('Google Ads: Daily clicks sum vs Account total', ads.accountSummary.totalClicks, dailyClickTotal, 0.05);
      
      if (ads.campaigns.length === 0) audit.errors.push('Google Ads: 0 campaigns â€” campaign query may be failing');
      if (ads.dailyPerformance.length === 0) audit.errors.push('Google Ads: 0 daily records â€” daily query failing');
    } catch(e) { audit.errors.push('Google Ads: ' + e.message); }

    // 3. CRM Cross-Check
    var bm = global.bizMetrics || {};
    audit.summary.crm = {
      totalLeads: bm.totalLeads || 0,
      booked: bm.totalBooked || 0,
      completed: bm.totalCompleted || 0,
      cancelled: bm.totalCancelled || 0,
      conversionRate: (bm.conversionRate || 0) + '%',
      sheets: bm.sheetCount || 0,
    };

    // 4. Tookan
    var tookanData = global.tookanData || {};
    audit.summary.tookan = {
      totalTasks: tookanData.totalTasks || 0,
      completed: tookanData.completed || 0,
      agents: (tookanData.agents || []).length,
      note: (tookanData.totalTasks || 0) < 3 ? 'Low task count â€” Tookan may not be actively used' : 'OK',
    };

    // 5. Athena Context
    audit.summary.athenaDataSources = {
      hasCRM: !!(global.bizMetrics && global.bizMetrics.totalLeads > 0),
      hasFinancial: !!global.profitMetrics,
      hasGoogleAds: !!global.adsData,
      hasTookan: !!(global.tookanData && global.tookanData.totalTasks > 0),
      hasSquare: true, // always fetched fresh
    };

    // 6. CRM DEEP DIVE
    audit.summary.crmDeepDive = {
      totalSheets: bm.sheetsRead || 0,
      totalTabs: bm.tabsRead || 0,
      totalJobRows: bm.totalJobRows || (bm.allJobRows || []).length,
      statusBreakdown: {},
      techCoverage: { crmTechs: Object.keys(bm.techStats || {}).length, profitTechs: Object.keys((global.profitMetrics || {}).techPayouts || {}).length },
      locationCount: Object.keys(bm.locationStats || {}).length,
      equipmentTypes: Object.keys(bm.equipStats || {}).length,
      brandCount: Object.keys(bm.brandStats || {}).length,
    };
    // Status distribution
    var statusDist = {};
    (bm.allJobRows || []).forEach(function(j) {
      var st = (j.status || 'empty/unknown').toLowerCase().trim();
      if (!st) st = 'empty/unknown';
      statusDist[st] = (statusDist[st] || 0) + 1;
    });
    audit.summary.crmDeepDive.statusBreakdown = statusDist;
    
    // Tech assignment rate
    var withTech = (bm.allJobRows || []).filter(function(j) { return j.tech && j.tech.length > 1; }).length;
    var totalRows = (bm.allJobRows || []).length;
    audit.summary.crmDeepDive.techAssignmentRate = totalRows > 0 ? Math.round(withTech / totalRows * 100) + '% (' + withTech + '/' + totalRows + ')' : 'N/A';
    
    // Missing data analysis
    var missingPhone = (bm.allJobRows || []).filter(function(j) { return !j.phone || j.phone.length < 7; }).length;
    var missingLocation = (bm.allJobRows || []).filter(function(j) { return !j.city || j.city.length < 3; }).length;
    var missingEquip = (bm.allJobRows || []).filter(function(j) { return !j.equipType || j.equipType.length < 2; }).length;
    audit.summary.crmDeepDive.dataQuality = {
      missingPhone: missingPhone + ' (' + (totalRows > 0 ? Math.round(missingPhone/totalRows*100) : 0) + '%)',
      missingLocation: missingLocation + ' (' + (totalRows > 0 ? Math.round(missingLocation/totalRows*100) : 0) + '%)',
      missingEquipment: missingEquip + ' (' + (totalRows > 0 ? Math.round(missingEquip/totalRows*100) : 0) + '%)',
      missingTech: (totalRows - withTech) + ' (' + (totalRows > 0 ? Math.round((totalRows-withTech)/totalRows*100) : 0) + '%)',
    };
    
    // Monthly call volume check
    var callMonths = Object.keys(bm.monthlyCalls || {}).sort();
    if (callMonths.length > 0) {
      audit.summary.crmDeepDive.callDataRange = callMonths[0] + ' to ' + callMonths[callMonths.length - 1];
      audit.summary.crmDeepDive.totalMonthsOfData = callMonths.length;
      var zeroMonths = callMonths.filter(function(m) { return bm.monthlyCalls[m] === 0; });
      if (zeroMonths.length > 0) {
        audit.warnings.push('CRM: ' + zeroMonths.length + ' months with 0 calls â€” possible missing data: ' + zeroMonths.join(', '));
      }
    }
    
    // CRM vs Square cross-check
    if (sqA && bm.totalCompleted > 0) {
      var completedOrderCount = (sq.orders || []).filter(function(o) { return o.state === 'COMPLETED'; }).length;
      audit.summary.crossCheck = {
        crmCompleted: bm.totalCompleted,
        squareCompletedOrders: completedOrderCount,
        note: Math.abs(completedOrderCount - bm.totalCompleted) > completedOrderCount * 0.5 ? 'Large gap â€” CRM status updates may be inconsistent' : 'Reasonable alignment',
      };
    }

    // 7. Profit Sheet Check
    if (global.profitMetrics) {
      var pm3 = global.profitMetrics;
      audit.summary.profitSheet = {
        currentMonth: pm3.currentMonth || 'Unknown',
        revenue: '$' + Math.round(pm3.revenue || 0).toLocaleString(),
        expenses: '$' + Math.round(pm3.expenses || 0).toLocaleString(),
        profit: '$' + Math.round(pm3.profit || 0).toLocaleString(),
        margin: (pm3.margin || 0) + '%',
        techCount: Object.keys(pm3.techPayouts || {}).length,
        techs: Object.keys(pm3.techPayouts || {}).join(', '),
        receptionistCount: Object.keys(pm3.receptionistPayouts || {}).length,
        receptionists: Object.keys(pm3.receptionistPayouts || {}).join(', '),
      };
    }

    // 8. Sheet Metadata
    if (global.sheetMetadata) {
      audit.summary.sheetsRead = {};
      Object.entries(global.sheetMetadata).forEach(function(s) {
        var tabs = Array.isArray(s[1].tabs) ? s[1].tabs : [];
        audit.summary.sheetsRead[s[0]] = { tabs: tabs.length, tabNames: tabs.join(', '), desc: s[1].desc || '' };
      });
    }

    // Overall health
    var passCount = audit.checks.filter(function(c) { return c.pass; }).length;
    audit.health = {
      passed: passCount,
      total: audit.checks.length,
      score: audit.checks.length > 0 ? Math.round(passCount / audit.checks.length * 100) + '%' : 'N/A',
      warnings: audit.warnings.length,
      errors: audit.errors.length,
    };

  } catch(e) {
    audit.errors.push('Audit failed: ' + e.message);
    audit.health = { passed: 0, total: 0, score: '0%', warnings: 0, errors: 1 };
  }
  
  return audit;
}

// ====== SEO AUDIT API ======
app.get('/api/seo', requireAuth('owner'), function(req, res) {
  var state = req.query.state;
  var service = req.query.service;
  if (state) {
    var d = getSeoStateData(state);
    if (!d) return res.json({ error: 'State not found', available: Object.keys(SEO_AUDIT_DATA) });
    if (service && d[1][service]) return res.json({ state: state, service: service, data: d[1][service], cities: d[0] });
    return res.json({ state: state, cities: d[0], services: d[1] });
  }
  if (service) return res.json({ service: service, topMarkets: getSeoTopMarkets(service, 50) });
  return res.json({ national: getSeoNationalTotals(), stateRanking: getSeoStateRanking() });
});

app.get('/api/seo/predict', requireAuth('owner'), function(req, res) {
  var state = req.query.state || 'Kansas';
  var city = req.query.city;
  var months = parseInt(req.query.months) || 12;
  var d = getSeoStateData(state);
  if (!d) return res.json({ error: 'State not found' });
  
  // Monthly predictions for the state
  var monthlyState = getSeoMonthlyPredictions(state, months);
  
  // City-level monthly if requested
  var monthlyCity = null;
  if (city) {
    monthlyCity = getSeoMonthlyCity(city, state, months);
  }
  
  // Build predictions per city using SEO volume + population
  var predictions = [];
  var pops = {};
  d[0].forEach(function(c) { pops[c[0]] = c[1]; });
  
  var serviceLabels = { small_engine_repair: 'Small Engine Repair', lawn_mower_repair: 'Lawn Mower Repair', snow_blower_repair: 'Snow Blower Repair', generator_repair: 'Generator Repair', motorcycle_repair: 'Motorcycle Repair' };
  
  var citySet = city ? [city] : d[0].map(function(c) { return c[0]; });
  citySet.forEach(function(cn) {
    var ms = getSeoMarketScore(cn, state);
    if (ms) {
      var estLeads = 0;
      Object.keys(ms.services).forEach(function(sk) {
        var s = ms.services[sk];
        var ctr = s.kd < 0.2 ? 0.15 : s.kd < 0.4 ? 0.08 : s.kd < 0.6 ? 0.04 : 0.02;
        estLeads += Math.round(s.vol * ctr);
      });
      var estRevenue = Math.round(estLeads * 0.3 * 250);
      predictions.push({ city: cn, pop: ms.pop, totalVol: ms.totalVol, avgKd: ms.avgKd, score: ms.score, estLeadsPerMonth: estLeads, estRevenuePerMonth: estRevenue, services: ms.services });
    }
  });
  predictions.sort(function(a,b) { return b.score - a.score; });
  res.json({ state: state, predictions: predictions, monthly: monthlyState, monthlyCity: monthlyCity });
});

app.get('/api/audit', requireAuth('owner'), async function(req, res) {
  res.json(await runSystemAudit());
});

// ====== AI INTELLIGENCE HUB â€” Demand Forecast, Daily Briefing, Pricing Optimizer ======
app.get('/ai', requireAuth('owner'), async function(req, res) {
  try {
    await buildBusinessContext();
    var bm = global.bizMetrics || {};
    var pm = global.profitMetrics || {};
    var sq, sqA;
    try { sq = await squareFullSnapshot(false); sqA = squareAnalyze(sq); } catch(e) { sq = {}; sqA = null; }
    var ads;
    try { ads = await buildAdsContext(); } catch(e) { ads = null; }

    var monthNames = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var now = new Date();
    var currentMonth = now.getMonth() + 1;
    var currentYear = now.getFullYear();

    // ====== DEMAND FORECASTING DATA ======
    var forecast = { weeks: [], months: [], staffing: [] };
    
    // Historical monthly data from CRM + Square
    var crmMonthly = bm.monthlyCalls || {};
    var sqMonthly = sqA ? sqA.trends.monthlyRevenue : {};
    var sqSeasonal = sqA ? sqA.trends.seasonalAvg : {};
    var sqPaymentCount = sqA ? sqA.trends.monthlyPaymentCount : {};
    
    // Build forecast for next 6 months
    for (var fm = 1; fm <= 6; fm++) {
      var targetMonth = ((currentMonth - 1 + fm) % 12) + 1;
      var targetYear = currentYear + Math.floor((currentMonth - 1 + fm) / 12);
      var moKey = String(targetMonth).padStart(2, '0');
      var monthKey = targetYear + '-' + moKey;
      
      // Seasonal average revenue
      var seasonalRev = sqSeasonal[moKey] || 0;
      
      // Historical call volume for this calendar month
      var historicalCalls = [];
      Object.keys(crmMonthly).forEach(function(m) {
        if (m.endsWith('-' + moKey)) historicalCalls.push(crmMonthly[m]);
      });
      var avgCalls = historicalCalls.length > 0 ? Math.round(historicalCalls.reduce(function(a,b){return a+b;},0) / historicalCalls.length) : 0;
      
      // Historical revenue for this calendar month
      var historicalRevs = [];
      Object.keys(sqMonthly).forEach(function(m) {
        if (m.endsWith('-' + moKey)) historicalRevs.push(sqMonthly[m]);
      });
      var avgRev = historicalRevs.length > 0 ? Math.round(historicalRevs.reduce(function(a,b){return a+b;},0) / historicalRevs.length) : seasonalRev;
      
      // Growth adjustment (YoY)
      var lastYearKey = (targetYear - 1) + '-' + moKey;
      var twoYearKey = (targetYear - 2) + '-' + moKey;
      var growthRate = 0;
      if (sqMonthly[lastYearKey] && sqMonthly[twoYearKey] && sqMonthly[twoYearKey] > 0) {
        growthRate = (sqMonthly[lastYearKey] - sqMonthly[twoYearKey]) / sqMonthly[twoYearKey];
      }
      
      var projectedRev = Math.round(avgRev * (1 + growthRate * 0.5)); // dampen growth
      var projectedCalls = Math.round(avgCalls * (1 + growthRate * 0.3));
      
      // Demand level
      var allMonthlyRevs = Object.values(sqMonthly);
      var overallAvg = allMonthlyRevs.length > 0 ? allMonthlyRevs.reduce(function(a,b){return a+b;},0) / allMonthlyRevs.length : 0;
      var demandLevel = projectedRev > overallAvg * 1.3 ? 'HIGH' : projectedRev > overallAvg * 0.7 ? 'NORMAL' : 'LOW';
      
      // Staffing recommendation (based on avg ticket and techs needed)
      var avgTicket = sqA ? sqA.revenue.avgTicket : 200;
      var jobsNeeded = avgTicket > 0 ? Math.ceil(projectedRev / avgTicket) : 0;
      var techsNeeded = Math.ceil(jobsNeeded / 22); // ~22 working days, 1 job/day/tech
      
      forecast.months.push({
        month: monthKey,
        label: monthNames[targetMonth] + ' ' + targetYear,
        projectedRevenue: projectedRev,
        projectedCalls: projectedCalls,
        seasonalAvg: Math.round(seasonalRev),
        historicalAvg: Math.round(avgRev),
        growthRate: Math.round(growthRate * 100),
        demandLevel: demandLevel,
        estimatedJobs: jobsNeeded,
        techsNeeded: techsNeeded,
      });
    }

    // ====== DAILY BRIEFING DATA ======
    var briefing = {};
    
    // Square today/week/month
    briefing.revenue = sqA ? {
      today: sqA.revenue.today,
      week: sqA.revenue.week,
      month30d: sqA.revenue.month30d,
      weekGrowth: sqA.revenue.weekGrowth,
      avgTicket: sqA.revenue.avgTicket,
    } : {};
    
    // CRM today
    briefing.crm = {
      thisMonth: bm.thisMonthCalls || 0,
      lastMonth: bm.lastMonthCalls || 0,
      growth: bm.monthGrowth || 0,
      todayBookings: (bm.todayBookings || []).length || 0,
      needsReschedule: (bm.needsReschedule || []).length || 0,
      conversionRate: bm.conversionRate || 0,
    };
    
    // Google Ads recent
    if (ads && ads.dailyPerformance && ads.dailyPerformance.length > 0) {
      var last7 = ads.dailyPerformance.slice(-7);
      var prev7 = ads.dailyPerformance.slice(-14, -7);
      var last7Spend = last7.reduce(function(s,d){return s+d.cost;},0);
      var last7Clicks = last7.reduce(function(s,d){return s+d.clicks;},0);
      var last7Conv = last7.reduce(function(s,d){return s+d.conversions;},0);
      var prev7Spend = prev7.reduce(function(s,d){return s+d.cost;},0);
      briefing.ads = {
        last7Spend: Math.round(last7Spend * 100) / 100,
        last7Clicks: last7Clicks,
        last7Conv: Math.round(last7Conv * 10) / 10,
        spendTrend: prev7Spend > 0 ? Math.round((last7Spend - prev7Spend) / prev7Spend * 100) : 0,
        costPerLead: last7Conv > 0 ? Math.round(last7Spend / last7Conv * 100) / 100 : 0,
      };
    }
    
    // Alerts
    briefing.alerts = [];
    if (sqA && sqA.revenue.weekGrowth < -20) briefing.alerts.push({ type: 'warning', msg: 'Revenue down ' + sqA.revenue.weekGrowth + '% vs last week' });
    if (sqA && sqA.refunds.rate > 5) briefing.alerts.push({ type: 'warning', msg: 'Refund rate at ' + sqA.refunds.rate + '% â€” investigate' });
    if ((bm.needsReschedule || []).length > 3) briefing.alerts.push({ type: 'action', msg: (bm.needsReschedule || []).length + ' jobs need rescheduling' });
    if (ads && ads.accountSummary && ads.accountSummary.avgCPC > 10) briefing.alerts.push({ type: 'warning', msg: 'CPC is $' + ads.accountSummary.avgCPC + ' â€” check campaigns' });
    if (bm.monthGrowth > 20) briefing.alerts.push({ type: 'positive', msg: 'Call volume up ' + bm.monthGrowth + '% vs last month!' });
    if (sqA && sqA.revenue.weekGrowth > 15) briefing.alerts.push({ type: 'positive', msg: 'Weekly revenue up ' + sqA.revenue.weekGrowth + '%!' });
    
    // Next month demand
    if (forecast.months.length > 0) {
      var nextM = forecast.months[0];
      if (nextM.demandLevel === 'HIGH') briefing.alerts.push({ type: 'action', msg: nextM.label + ' is projected HIGH demand ($' + nextM.projectedRevenue.toLocaleString() + ') â€” ensure ' + nextM.techsNeeded + '+ techs available' });
      if (nextM.demandLevel === 'LOW') briefing.alerts.push({ type: 'action', msg: nextM.label + ' is projected LOW demand â€” run promotions or reduce ad spend' });
    }

    // ====== PRICING OPTIMIZER DATA ======
    var pricing = { categories: [], recommendations: [] };
    
    // Equipment category analysis from CRM
    var equipStats = bm.equipStats || {};
    var equipSorted = Object.entries(equipStats).sort(function(a,b){return b[1]-a[1];}).slice(0, 15);
    
    // Revenue per job by looking at Square avg tickets over time
    var monthlyTickets = sqA ? sqA.trends.monthlyAvgTicket || {} : {};
    var ticketTrend = Object.keys(monthlyTickets).sort().slice(-12).map(function(m) { return { month: m, ticket: monthlyTickets[m] }; });
    var currentAvgTicket = sqA ? sqA.revenue.avgTicket : 0;
    var ticketValues = ticketTrend.map(function(t){return t.ticket;}).filter(function(v){return v > 0;});
    var ticketMin = ticketValues.length > 0 ? Math.min.apply(null, ticketValues) : 0;
    var ticketMax = ticketValues.length > 0 ? Math.max.apply(null, ticketValues) : 0;
    var ticketAvg = ticketValues.length > 0 ? ticketValues.reduce(function(a,b){return a+b;},0) / ticketValues.length : 0;
    
    // Seasonal pricing intelligence
    var seasonalPricing = {};
    Object.keys(sqSeasonal).forEach(function(mo) {
      var monthRev = sqSeasonal[mo] || 0;
      var monthPayments = 0;
      Object.keys(sqPaymentCount).forEach(function(m) {
        if (m.endsWith('-' + mo)) monthPayments += sqPaymentCount[m] || 0;
      });
      var yearsOfData = 0;
      Object.keys(sqMonthly).forEach(function(m) { if (m.endsWith('-' + mo)) yearsOfData++; });
      seasonalPricing[mo] = {
        label: monthNames[parseInt(mo)],
        avgRevenue: monthRev,
        avgPayments: yearsOfData > 0 ? Math.round(monthPayments / yearsOfData) : 0,
        impliedTicket: monthPayments > 0 && yearsOfData > 0 ? Math.round(monthRev / (monthPayments / yearsOfData)) : 0,
      };
    });
    
    // Ad cost per lead
    var costPerLead = ads && ads.accountSummary && ads.accountSummary.totalConversions > 0 ? 
      Math.round(ads.accountSummary.totalSpend / ads.accountSummary.totalConversions * 100) / 100 : 0;
    
    // Pricing recommendations
    var overallAvgTicket = Math.round(ticketAvg);
    if (overallAvgTicket > 0) {
      // Check if current pricing is below/above trend
      if (currentAvgTicket < overallAvgTicket * 0.9) {
        pricing.recommendations.push({ type: 'increase', msg: 'Current avg ticket ($' + Math.round(currentAvgTicket) + ') is below 12-month average ($' + overallAvgTicket + '). Consider raising base rates.', impact: 'high' });
      }
      
      // Seasonal pricing suggestion
      var nextMonthMo = String(((currentMonth) % 12) + 1).padStart(2, '0');
      var nextSeason = seasonalPricing[nextMonthMo];
      if (nextSeason && nextSeason.impliedTicket > overallAvgTicket * 1.2) {
        pricing.recommendations.push({ type: 'seasonal', msg: monthNames[parseInt(nextMonthMo)] + ' historically has higher avg ticket ($' + nextSeason.impliedTicket + ' vs $' + overallAvgTicket + '). Peak demand = premium pricing opportunity.', impact: 'high' });
      } else if (nextSeason && nextSeason.impliedTicket < overallAvgTicket * 0.8) {
        pricing.recommendations.push({ type: 'promo', msg: monthNames[parseInt(nextMonthMo)] + ' is typically slow ($' + nextSeason.impliedTicket + ' avg ticket). Consider promo pricing or service bundles to drive volume.', impact: 'medium' });
      }
      
      // Cost per lead vs ticket
      if (costPerLead > 0 && costPerLead > currentAvgTicket * 0.3) {
        pricing.recommendations.push({ type: 'warning', msg: 'Ad cost per lead ($' + costPerLead + ') is ' + Math.round(costPerLead / currentAvgTicket * 100) + '% of avg ticket. Raise prices or optimize ads.', impact: 'high' });
      } else if (costPerLead > 0) {
        pricing.recommendations.push({ type: 'positive', msg: 'Ad cost per lead ($' + costPerLead + ') is only ' + Math.round(costPerLead / currentAvgTicket * 100) + '% of avg ticket ($' + Math.round(currentAvgTicket) + '). Strong margin.', impact: 'low' });
      }
      
      // Ticket trend direction
      if (ticketTrend.length >= 6) {
        var first3 = ticketTrend.slice(0, 3).reduce(function(s,t){return s+t.ticket;},0) / 3;
        var last3 = ticketTrend.slice(-3).reduce(function(s,t){return s+t.ticket;},0) / 3;
        if (last3 > first3 * 1.1) {
          pricing.recommendations.push({ type: 'positive', msg: 'Avg ticket trending UP (' + Math.round(first3) + ' â†’ $' + Math.round(last3) + '). Market supports higher prices.', impact: 'medium' });
        } else if (last3 < first3 * 0.9) {
          pricing.recommendations.push({ type: 'warning', msg: 'Avg ticket trending DOWN ($' + Math.round(first3) + ' â†’ $' + Math.round(last3) + '). May need to review discounting or job mix.', impact: 'medium' });
        }
      }
    }

    // ====== RENDER HTML ======
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>AI Intelligence</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">';
    html += '<style>*{margin:0;padding:0;box-sizing:border-box;}body{background:#050d18;color:#c0d8f0;font-family:monospace;padding:20px;max-width:1400px;margin:0 auto;}';
    html += '.nav{display:flex;gap:2px;margin-bottom:20px;flex-wrap:wrap;justify-content:center;}';
    html += '.nav a{font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);}';
    html += '.nav a.active{color:#c084fc;border-color:#c084fc40;background:rgba(192,132,252,0.1);}';
    html += 'h1{font-family:Orbitron;color:#c084fc;letter-spacing:6px;margin-bottom:5px;}';
    html += '.sub{font-family:Orbitron;font-size:0.6em;color:#4a6a8a;letter-spacing:3px;margin-bottom:20px;}';
    html += '.tabs{display:flex;gap:0;margin-bottom:20px;}';
    html += '.tab{font-family:Orbitron;font-size:0.65em;letter-spacing:3px;padding:12px 24px;cursor:pointer;border:1px solid #1a2a3a;background:#050d18;color:#4a6a8a;transition:all 0.3s;}';
    html += '.tab.active{color:#c084fc;border-color:#c084fc40;background:rgba(192,132,252,0.08);}';
    html += '.tab:hover{color:#c084fc;}';
    html += '.panel{display:none;}.panel.active{display:block;}';
    html += '.section{background:rgba(10,20,35,0.6);border:1px solid #1a2a3a;padding:16px;margin-bottom:16px;border-radius:4px;}';
    html += '.section-title{font-family:Orbitron;font-size:0.85em;letter-spacing:4px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #1a2a3a;}';
    html += '.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;}';
    html += '.card{background:rgba(5,10,20,0.6);border:1px solid #1a2a3a;padding:14px;border-radius:4px;text-align:center;}';
    html += '.card-val{font-family:Orbitron;font-size:1.6em;margin:6px 0;}';
    html += '.card-label{font-family:Orbitron;font-size:0.55em;letter-spacing:3px;color:#4a6a8a;}';
    html += '.card-sub{font-size:0.75em;color:#4a6a8a;margin-top:4px;}';
    html += '.bar-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #0a1520;}';
    html += '.bar-label{width:100px;font-family:Orbitron;font-size:0.7em;letter-spacing:2px;color:#4a6a8a;}';
    html += '.bar-track{flex:1;height:28px;background:#0a1520;border-radius:4px;overflow:hidden;position:relative;}';
    html += '.bar-fill{height:100%;border-radius:4px;transition:width 0.5s;}';
    html += '.bar-text{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:0.75em;font-weight:bold;}';
    html += '.alert{padding:10px 14px;margin-bottom:8px;border-radius:4px;font-size:0.85em;border-left:3px solid;}';
    html += '.alert-warning{background:rgba(245,158,11,0.08);border-color:#f59e0b;color:#f59e0b;}';
    html += '.alert-action{background:rgba(0,212,255,0.08);border-color:#00d4ff;color:#00d4ff;}';
    html += '.alert-positive{background:rgba(16,185,129,0.08);border-color:#10b981;color:#10b981;}';
    html += '.rec{padding:12px;margin-bottom:10px;border:1px solid #1a2a3a;border-radius:4px;display:flex;justify-content:space-between;align-items:center;}';
    html += '.rec-msg{flex:1;font-size:0.85em;line-height:1.5;}';
    html += '.rec-impact{font-family:Orbitron;font-size:0.6em;letter-spacing:2px;padding:4px 10px;border-radius:3px;}';
    html += '.impact-high{background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid #ef444440;}';
    html += '.impact-medium{background:rgba(245,158,11,0.15);color:#f59e0b;border:1px solid #f59e0b40;}';
    html += '.impact-low{background:rgba(16,185,129,0.15);color:#10b981;border:1px solid #10b98140;}';
    html += '.forecast-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;}';
    html += '.fc-card{background:rgba(5,10,20,0.6);border:1px solid #1a2a3a;padding:14px;border-radius:4px;}';
    html += '.fc-month{font-family:Orbitron;font-size:0.8em;letter-spacing:3px;margin-bottom:8px;}';
    html += '.fc-val{font-family:Orbitron;font-size:1.3em;margin:4px 0;}';
    html += '.fc-meta{font-size:0.75em;color:#4a6a8a;line-height:1.8;}';
    html += '.demand-HIGH{color:#ef4444;border-color:#ef444440;}.demand-NORMAL{color:#f59e0b;border-color:#f59e0b40;}.demand-LOW{color:#00d4ff;border-color:#00d4ff40;}';
    html += '@media(max-width:600px){.grid{grid-template-columns:1fr 1fr;}.forecast-grid{grid-template-columns:1fr 1fr;}}';
    html += '</style></head><body>';

    // Nav
    html += '<div class="nav">';
    html += '<a href="/jarvis">JARVIS</a><a href="/business">ATHENA</a><a href="/tookan">TOOKAN</a><a href="/business/chart">CHARTS</a>';
    html += '<a href="/analytics">ANALYTICS</a><a href="/ads">GOOGLE ADS</a><a href="/square">SQUARE</a>';
    html += '<a href="/discord">DISCORD</a><a href="/followup">FOLLOW UP</a><a href="/ai" class="active">AI</a><a href="/forecast">FORECAST</a><a href="/seo">SEO</a><a href="/audit">AUDIT</a>';
    html += '<a href="/auth/logout" style="color:#ef4444;border-color:#ef444440;">LOGOUT</a></div>';

    html += '<h1>ðŸ§  AI INTELLIGENCE HUB</h1>';
    html += '<div class="sub">DEMAND FORECASTING Â· DAILY BRIEFING Â· PRICING OPTIMIZER</div>';

    // Tabs
    html += '<div class="tabs">';
    html += '<div class="tab active" onclick="showPanel(\'briefing\')">ðŸ“‹ DAILY BRIEFING</div>';
    html += '<div class="tab" onclick="showPanel(\'forecast\')">ðŸ“ˆ DEMAND FORECAST</div>';
    html += '<div class="tab" onclick="showPanel(\'pricing\')">ðŸ’° PRICING OPTIMIZER</div>';
    html += '</div>';

    // ====== PANEL 1: DAILY BRIEFING ======
    html += '<div class="panel active" id="panel-briefing">';
    html += '<div class="section"><div class="section-title" style="color:#10b981;">â˜€ï¸ GOOD MORNING BRIEFING â€” ' + now.toLocaleDateString('en-US', {weekday:'long',month:'long',day:'numeric',year:'numeric'}) + '</div>';
    
    // Alerts first
    if (briefing.alerts.length > 0) {
      briefing.alerts.forEach(function(a) {
        html += '<div class="alert alert-' + a.type + '">' + (a.type === 'warning' ? 'âš ï¸' : a.type === 'action' ? 'ðŸŽ¯' : 'ðŸš€') + ' ' + a.msg + '</div>';
      });
    } else {
      html += '<div class="alert alert-positive">âœ… All systems normal â€” no alerts today</div>';
    }
    html += '</div>';
    
    // Revenue snapshot
    html += '<div class="section"><div class="section-title" style="color:#10b981;">ðŸ’° REVENUE</div><div class="grid">';
    var brev = briefing.revenue || {};
    html += '<div class="card"><div class="card-label">TODAY</div><div class="card-val" style="color:#10b981;">$' + Math.round(brev.today || 0).toLocaleString() + '</div></div>';
    html += '<div class="card"><div class="card-label">THIS WEEK</div><div class="card-val" style="color:#10b981;">$' + Math.round(brev.week || 0).toLocaleString() + '</div><div class="card-sub">' + (brev.weekGrowth > 0 ? 'â†‘' : 'â†“') + ' ' + (brev.weekGrowth || 0) + '% vs last week</div></div>';
    html += '<div class="card"><div class="card-label">LAST 30 DAYS</div><div class="card-val" style="color:#10b981;">$' + Math.round(brev.month30d || 0).toLocaleString() + '</div></div>';
    html += '<div class="card"><div class="card-label">AVG TICKET</div><div class="card-val" style="color:#ffd700;">$' + Math.round(brev.avgTicket || 0) + '</div></div>';
    html += '</div></div>';
    
    // CRM snapshot
    html += '<div class="section"><div class="section-title" style="color:#a855f7;">ðŸ“ž BOOKINGS</div><div class="grid">';
    html += '<div class="card"><div class="card-label">THIS MONTH</div><div class="card-val" style="color:#a855f7;">' + (briefing.crm.thisMonth || 0) + '</div><div class="card-sub">' + (briefing.crm.growth > 0 ? 'â†‘' : 'â†“') + ' ' + (briefing.crm.growth || 0) + '% vs last month</div></div>';
    html += '<div class="card"><div class="card-label">TODAY</div><div class="card-val" style="color:#a855f7;">' + (briefing.crm.todayBookings || 0) + '</div></div>';
    html += '<div class="card"><div class="card-label">NEEDS RESCHEDULE</div><div class="card-val" style="color:' + ((briefing.crm.needsReschedule || 0) > 0 ? '#f59e0b' : '#10b981') + ';">' + (briefing.crm.needsReschedule || 0) + '</div></div>';
    html += '<div class="card"><div class="card-label">CONVERSION</div><div class="card-val" style="color:#00d4ff;">' + (briefing.crm.conversionRate || 0) + '%</div></div>';
    html += '</div></div>';
    
    // Ads snapshot
    if (briefing.ads) {
      html += '<div class="section"><div class="section-title" style="color:#4285f4;">ðŸ“Š ADS (LAST 7 DAYS)</div><div class="grid">';
      html += '<div class="card"><div class="card-label">SPEND</div><div class="card-val" style="color:#ff4757;">$' + (briefing.ads.last7Spend || 0) + '</div><div class="card-sub">' + (briefing.ads.spendTrend > 0 ? 'â†‘' : 'â†“') + ' ' + (briefing.ads.spendTrend || 0) + '% WoW</div></div>';
      html += '<div class="card"><div class="card-label">CLICKS</div><div class="card-val" style="color:#4285f4;">' + (briefing.ads.last7Clicks || 0) + '</div></div>';
      html += '<div class="card"><div class="card-label">CONVERSIONS</div><div class="card-val" style="color:#00ff66;">' + (briefing.ads.last7Conv || 0) + '</div></div>';
      html += '<div class="card"><div class="card-label">COST/LEAD</div><div class="card-val" style="color:#f59e0b;">$' + (briefing.ads.costPerLead || 0) + '</div></div>';
      html += '</div></div>';
    }
    html += '</div>'; // end briefing panel

    // ====== PANEL 2: DEMAND FORECAST ======
    html += '<div class="panel" id="panel-forecast">';
    html += '<div class="section"><div class="section-title" style="color:#00d4ff;">ðŸ“ˆ 6-MONTH DEMAND FORECAST</div>';
    html += '<div class="forecast-grid">';
    forecast.months.forEach(function(m) {
      html += '<div class="fc-card demand-' + m.demandLevel + '">';
      html += '<div class="fc-month">' + m.label + '</div>';
      html += '<div class="fc-val">$' + m.projectedRevenue.toLocaleString() + '</div>';
      html += '<div style="font-family:Orbitron;font-size:0.65em;letter-spacing:2px;margin:4px 0;" class="demand-' + m.demandLevel + '">' + m.demandLevel + ' DEMAND</div>';
      html += '<div class="fc-meta">';
      html += '~' + m.estimatedJobs + ' jobs expected<br>';
      html += '~' + m.projectedCalls + ' calls predicted<br>';
      html += m.techsNeeded + ' techs needed<br>';
      html += 'Seasonal avg: $' + m.seasonalAvg.toLocaleString() + '<br>';
      html += 'Growth trend: ' + (m.growthRate >= 0 ? '+' : '') + m.growthRate + '%';
      html += '</div></div>';
    });
    html += '</div></div>';
    
    // Forecast chart (bar chart)
    html += '<div class="section"><div class="section-title" style="color:#00d4ff;">ðŸ“Š PROJECTED VS SEASONAL</div>';
    html += '<div style="height:200px;" id="forecastChart">';
    var maxFcRev = Math.max.apply(null, forecast.months.map(function(m){return Math.max(m.projectedRevenue, m.seasonalAvg);})) || 1;
    html += '<svg width="100%" height="200">';
    forecast.months.forEach(function(m, i) {
      var x = (i / forecast.months.length) * 90 + 5;
      var bw = 80 / forecast.months.length / 2;
      var h1 = (m.projectedRevenue / maxFcRev) * 160;
      var h2 = (m.seasonalAvg / maxFcRev) * 160;
      // Projected bar
      html += '<rect x="' + (x) + '%" y="' + (180 - h1) + '" width="' + (bw - 0.5) + '%" height="' + h1 + '" fill="#c084fc" opacity="0.7" rx="3"><title>' + m.label + ' Projected: $' + m.projectedRevenue.toLocaleString() + '</title></rect>';
      // Seasonal bar
      html += '<rect x="' + (x + bw) + '%" y="' + (180 - h2) + '" width="' + (bw - 0.5) + '%" height="' + h2 + '" fill="#10b98160" rx="3"><title>' + m.label + ' Seasonal Avg: $' + m.seasonalAvg.toLocaleString() + '</title></rect>';
      // Label
      html += '<text x="' + (x + bw) + '%" y="196" fill="#4a6a8a" font-size="10" font-family="Orbitron" text-anchor="middle">' + m.label.split(' ')[0] + '</text>';
    });
    html += '<text x="2%" y="12" fill="#c084fc" font-size="9" font-family="Orbitron">â–  Projected</text>';
    html += '<text x="2%" y="24" fill="#10b981" font-size="9" font-family="Orbitron">â–  Seasonal Avg</text>';
    html += '</svg></div></div>';
    
    // Staffing recommendations
    html += '<div class="section"><div class="section-title" style="color:#f59e0b;">ðŸ‘¥ STAFFING RECOMMENDATIONS</div>';
    forecast.months.forEach(function(m) {
      var color = m.demandLevel === 'HIGH' ? '#ef4444' : m.demandLevel === 'LOW' ? '#00d4ff' : '#f59e0b';
      html += '<div class="bar-row"><div class="bar-label">' + m.label.split(' ')[0] + '</div>';
      html += '<div class="bar-track"><div class="bar-fill" style="width:' + Math.min(100, (m.techsNeeded / 5) * 100) + '%;background:' + color + '40;"></div>';
      html += '<div class="bar-text" style="color:' + color + ';">' + m.techsNeeded + ' techs Â· ' + m.estimatedJobs + ' jobs Â· $' + m.projectedRevenue.toLocaleString() + '</div></div></div>';
    });
    html += '</div>';
    
    // SEO-powered market predictions
    html += '<div class="section"><div class="section-title" style="color:#55f7d8;">ðŸ” SEO SEARCH DEMAND â€” MARKET PREDICTIONS</div>';
    html += '<div style="color:#4a6a8a;font-size:0.85em;margin-bottom:12px;">Based on Google search volume across 50 states, 1,000+ cities, 5 service types. Predictions use volume Ã— (1 - keyword difficulty) Ã— population.</div>';
    
    var seoN = getSeoNationalTotals();
    var serviceKeys2 = ['small_engine_repair','lawn_mower_repair','snow_blower_repair','generator_repair','motorcycle_repair'];
    var svcL2 = { small_engine_repair: 'Small Engine', lawn_mower_repair: 'Lawn Mower', snow_blower_repair: 'Snow Blower', generator_repair: 'Generator', motorcycle_repair: 'Motorcycle' };
    var svcC2 = { small_engine_repair: '#00d4ff', lawn_mower_repair: '#00ff66', snow_blower_repair: '#a855f7', generator_repair: '#ff9f43', motorcycle_repair: '#ff6b9d' };
    
    // Service volume bars
    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">';
    serviceKeys2.forEach(function(sk) {
      var t = seoN.totals[sk];
      html += '<div style="flex:1;min-width:130px;background:rgba(10,20,35,0.6);border:1px solid ' + svcC2[sk] + '20;padding:10px;">';
      html += '<div style="color:' + svcC2[sk] + ';font-family:Orbitron;font-size:0.55em;letter-spacing:2px;">' + svcL2[sk].toUpperCase() + '</div>';
      html += '<div style="color:' + svcC2[sk] + ';font-size:1.3em;font-weight:900;">' + t.totalVol.toLocaleString() + '/mo</div>';
      html += '<div style="color:#4a6a8a;font-size:0.75em;">' + t.cities + ' cities Â· KD ' + Math.round(t.avgKd * 100) + '%</div>';
      html += '</div>';
    });
    html += '</div>';
    
    // Kansas market deep dive
    var ksData2 = getSeoStateData('Kansas');
    if (ksData2) {
      html += '<div style="padding:12px;border:1px solid #55f7d820;background:rgba(85,247,216,0.02);margin-bottom:12px;">';
      html += '<div style="color:#55f7d8;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:8px;">ðŸ“ KANSAS HOME MARKET â€” CITY-BY-CITY PREDICTIONS</div>';
      ksData2[0].forEach(function(cp) {
        var ms = getSeoMarketScore(cp[0], 'Kansas');
        if (!ms || ms.totalVol === 0) return;
        var estLeads = 0;
        Object.keys(ms.services).forEach(function(sk) { var s = ms.services[sk]; var ctr = s.kd < 0.2 ? 0.15 : s.kd < 0.4 ? 0.08 : 0.04; estLeads += Math.round(s.vol * ctr); });
        html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px;">';
        html += '<div style="width:110px;color:#c0d8f0;font-size:0.85em;">' + cp[0] + '</div>';
        html += '<div style="flex:1;display:flex;gap:2px;height:14px;">';
        Object.keys(ms.services).forEach(function(sk) {
          var s = ms.services[sk];
          if (s.vol > 0) html += '<div style="flex:' + s.vol + ';background:' + (svcC2[sk] || '#4a6a8a') + ';height:100%;" title="' + (svcL2[sk] || sk) + ': ' + s.vol + '/mo"></div>';
        });
        html += '</div>';
        html += '<div style="width:55px;color:#00d4ff;font-size:0.75em;text-align:right;">' + ms.totalVol + '/mo</div>';
        html += '<div style="width:50px;color:' + (ms.avgKd < 0.2 ? '#00ff66' : '#ff9f43') + ';font-size:0.75em;">KD ' + Math.round(ms.avgKd * 100) + '%</div>';
        html += '<div style="width:65px;color:#ff9f43;font-size:0.75em;text-align:right;">~$' + (estLeads * 75).toLocaleString() + '/mo</div>';
        html += '</div>';
      });
      html += '</div>';
    }
    
    // National top opportunities
    html += '<div style="padding:12px;border:1px solid #c084fc20;background:rgba(192,132,252,0.02);">';
    html += '<div style="color:#c084fc;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;margin-bottom:8px;">ðŸŽ¯ TOP 15 EXPANSION OPPORTUNITIES NATIONWIDE</div>';
    var topAll2 = [];
    Object.keys(SEO_AUDIT_DATA).forEach(function(st) {
      var d = SEO_AUDIT_DATA[st];
      d[0].forEach(function(cp) {
        var ms2 = getSeoMarketScore(cp[0], st);
        if (ms2 && ms2.totalVol > 0) topAll2.push(ms2);
      });
    });
    topAll2.sort(function(a,b) { return b.score - a.score; });
    topAll2.slice(0, 15).forEach(function(m, i) {
      var estL = 0;
      Object.keys(m.services).forEach(function(sk) { var s = m.services[sk]; var ctr = s.kd < 0.2 ? 0.15 : s.kd < 0.4 ? 0.08 : 0.04; estL += Math.round(s.vol * ctr); });
      html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;padding:3px 0;border-bottom:1px solid #ffffff05;">';
      html += '<div style="width:18px;color:#c084fc;font-size:0.8em;font-weight:700;">' + (i+1) + '</div>';
      html += '<div style="width:150px;color:#c0d8f0;font-size:0.85em;">' + m.city + ', ' + m.state + '</div>';
      html += '<div style="width:65px;color:#00d4ff;font-size:0.8em;">' + m.totalVol + '/mo</div>';
      html += '<div style="width:55px;color:' + (m.avgKd < 0.2 ? '#00ff66' : '#ff9f43') + ';font-size:0.8em;">KD ' + Math.round(m.avgKd * 100) + '%</div>';
      html += '<div style="width:55px;color:#55f7d8;font-size:0.8em;">~' + estL + ' leads</div>';
      html += '<div style="color:#c084fc;font-family:Orbitron;font-size:0.55em;">SCORE ' + m.score + '</div>';
      html += '</div>';
    });
    html += '</div>';
    
    // Monthly SEO Predictions chart
    html += '<div class="section"><div class="section-title" style="color:#c084fc;">ðŸ“… 12-MONTH SEO DEMAND FORECAST â€” KANSAS</div>';
    html += '<div style="color:#4a6a8a;font-size:0.85em;margin-bottom:10px;">Monthly search demand predictions with seasonal curves per service type.</div>';
    var aiMonthly = getSeoMonthlyPredictions('Kansas', 12);
    if (aiMonthly.length > 0) {
      var aiMaxVol = Math.max.apply(null, aiMonthly.map(function(m){return m.totalPredictedVol;})) || 1;
      
      // Stacked bar chart
      html += '<div style="display:flex;gap:3px;align-items:flex-end;height:160px;margin-bottom:4px;">';
      aiMonthly.forEach(function(m) {
        var h = Math.round((m.totalPredictedVol / aiMaxVol) * 140);
        html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;">';
        html += '<div style="width:100%;height:' + h + 'px;display:flex;flex-direction:column;justify-content:flex-end;">';
        var sK = ['lawn_mower_repair','small_engine_repair','snow_blower_repair','generator_repair','motorcycle_repair'];
        var sC = { lawn_mower_repair:'#00ff66', small_engine_repair:'#00d4ff', snow_blower_repair:'#a855f7', generator_repair:'#ff9f43', motorcycle_repair:'#ff6b9d' };
        sK.forEach(function(sk) {
          var sv = m.services[sk];
          if (sv && sv.predictedVol > 0) {
            var sh = Math.max(Math.round((sv.predictedVol / aiMaxVol) * 140), 2);
            html += '<div style="width:100%;height:' + sh + 'px;background:' + sC[sk] + ';opacity:0.7;" title="' + sv.label + ': ' + sv.predictedVol + '/mo Â· ~' + sv.estLeads + ' leads Â· ~$' + sv.estRevenue.toLocaleString() + '"></div>';
          }
        });
        html += '</div>';
        html += '<div style="color:#4a6a8a;font-size:0.55em;margin-top:3px;font-family:Orbitron;">' + m.label.split(' ')[0] + '</div>';
        html += '</div>';
      });
      html += '</div>';
      
      // Legend
      html += '<div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">';
      [{c:'#00ff66',l:'Mower'},{c:'#00d4ff',l:'Small Engine'},{c:'#a855f7',l:'Snow Blower'},{c:'#ff9f43',l:'Generator'},{c:'#ff6b9d',l:'Motorcycle'}].forEach(function(s) {
        html += '<div style="display:flex;align-items:center;gap:3px;font-size:0.75em;"><div style="width:8px;height:8px;background:' + s.c + ';opacity:0.7;"></div><span style="color:#4a6a8a;">' + s.l + '</span></div>';
      });
      html += '</div>';
      
      // Monthly detail cards
      html += '<div class="forecast-grid">';
      aiMonthly.forEach(function(m) {
        var isHigh = m.totalPredictedVol > aiMaxVol * 0.7;
        var isLow = m.totalPredictedVol < aiMaxVol * 0.3;
        var dLevel = isHigh ? 'HIGH' : isLow ? 'LOW' : 'NORMAL';
        html += '<div class="fc-card demand-' + dLevel + '">';
        html += '<div class="fc-month">' + m.label + '</div>';
        html += '<div class="fc-val">' + m.totalPredictedVol + ' searches</div>';
        html += '<div style="font-family:Orbitron;font-size:0.6em;letter-spacing:2px;margin:3px 0;" class="demand-' + dLevel + '">' + dLevel + ' DEMAND</div>';
        html += '<div class="fc-meta">';
        html += '~' + m.totalEstLeads + ' estimated leads<br>';
        html += '~$' + m.totalEstRevenue.toLocaleString() + ' revenue potential<br>';
        html += 'Top service: ' + m.dominantService + '<br>';
        // Show top 2 services
        var sorted = Object.values(m.services).filter(function(s){return s.predictedVol > 0;}).sort(function(a,b){return b.predictedVol - a.predictedVol;});
        sorted.slice(0, 3).forEach(function(s) {
          html += s.label + ': ' + s.predictedVol + '/mo<br>';
        });
        html += '</div></div>';
      });
      html += '</div>';
    }
    html += '</div>';
    
    html += '</div>'; // end section
    html += '</div>'; // end forecast panel

    // ====== PANEL 3: PRICING OPTIMIZER ======
    html += '<div class="panel" id="panel-pricing">';
    
    // Current pricing health
    html += '<div class="section"><div class="section-title" style="color:#ffd700;">ðŸ’° PRICING HEALTH</div><div class="grid">';
    html += '<div class="card"><div class="card-label">CURRENT AVG TICKET</div><div class="card-val" style="color:#ffd700;">$' + Math.round(currentAvgTicket) + '</div></div>';
    html += '<div class="card"><div class="card-label">12-MO AVERAGE</div><div class="card-val" style="color:#c084fc;">$' + overallAvgTicket + '</div></div>';
    html += '<div class="card"><div class="card-label">TICKET RANGE</div><div class="card-val" style="color:#00d4ff;">$' + Math.round(ticketMin) + '-$' + Math.round(ticketMax) + '</div></div>';
    html += '<div class="card"><div class="card-label">COST PER LEAD</div><div class="card-val" style="color:#ff4757;">$' + costPerLead + '</div></div>';
    html += '</div></div>';
    
    // Recommendations
    if (pricing.recommendations.length > 0) {
      html += '<div class="section"><div class="section-title" style="color:#ffd700;">ðŸŽ¯ AI RECOMMENDATIONS</div>';
      pricing.recommendations.forEach(function(r) {
        var icon = r.type === 'increase' ? 'ðŸ“ˆ' : r.type === 'warning' ? 'âš ï¸' : r.type === 'positive' ? 'âœ…' : r.type === 'seasonal' ? 'ðŸŒ¡ï¸' : 'ðŸ’¡';
        html += '<div class="rec"><div class="rec-msg">' + icon + ' ' + r.msg + '</div>';
        html += '<div class="rec-impact impact-' + r.impact + '">' + r.impact.toUpperCase() + '</div></div>';
      });
      html += '</div>';
    }
    
    // Seasonal pricing chart
    html += '<div class="section"><div class="section-title" style="color:#ffd700;">ðŸ“… SEASONAL TICKET ANALYSIS</div>';
    var maxSeasonTicket = 0;
    Object.values(seasonalPricing).forEach(function(s) { if (s.impliedTicket > maxSeasonTicket) maxSeasonTicket = s.impliedTicket; });
    html += '<div style="display:flex;align-items:flex-end;height:160px;gap:6px;padding:20px 10px 0;">';
    for (var sm = 1; sm <= 12; sm++) {
      var smKey = String(sm).padStart(2, '0');
      var sp = seasonalPricing[smKey] || {};
      var barH = maxSeasonTicket > 0 ? Math.max(4, (sp.impliedTicket / maxSeasonTicket) * 120) : 4;
      var barColor = sm === currentMonth ? '#c084fc' : sp.impliedTicket > overallAvgTicket * 1.1 ? '#10b981' : sp.impliedTicket < overallAvgTicket * 0.9 ? '#ef4444' : '#f59e0b';
      html += '<div style="flex:1;text-align:center;">';
      html += '<div style="font-size:10px;color:' + barColor + ';margin-bottom:2px;">$' + (sp.impliedTicket || 0) + '</div>';
      html += '<div style="height:' + barH + 'px;background:' + barColor + '60;border-radius:3px 3px 0 0;margin:0 auto;width:80%;' + (sm === currentMonth ? 'border:1px solid #c084fc;' : '') + '"></div>';
      html += '<div style="font-size:9px;color:#4a6a8a;margin-top:4px;">' + monthNames[sm] + '</div>';
      html += '</div>';
    }
    html += '</div>';
    html += '<div style="text-align:center;font-size:0.75em;color:#4a6a8a;margin-top:8px;">Implied avg ticket by month Â· <span style="color:#10b981;">Green</span> = above avg Â· <span style="color:#ef4444;">Red</span> = below avg Â· <span style="color:#c084fc;">Purple</span> = current</div>';
    html += '</div>';

    // Equipment demand table
    if (equipSorted.length > 0) {
      html += '<div class="section"><div class="section-title" style="color:#ffd700;">ðŸ”§ TOP EQUIPMENT â€” DEMAND & PRICING OPPORTUNITY</div>';
      html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.85em;">';
      html += '<tr style="border-bottom:1px solid #1a2a3a;"><th style="text-align:left;padding:8px;color:#ffd700;font-family:Orbitron;font-size:0.8em;">Equipment</th><th style="text-align:right;padding:8px;color:#ffd700;font-family:Orbitron;font-size:0.8em;">Jobs</th><th style="text-align:right;padding:8px;color:#ffd700;font-family:Orbitron;font-size:0.8em;">Share</th><th style="text-align:left;padding:8px;color:#ffd700;font-family:Orbitron;font-size:0.8em;">Pricing Signal</th></tr>';
      var totalEquipJobs = equipSorted.reduce(function(s,e){return s+e[1];},0);
      equipSorted.forEach(function(e) {
        var share = Math.round(e[1] / totalEquipJobs * 100);
        var signal = share > 15 ? 'ðŸ”¥ High demand â€” premium pricing' : share > 8 ? 'ðŸ“Š Moderate â€” competitive pricing' : 'ðŸ’¡ Niche â€” value pricing';
        var sigColor = share > 15 ? '#10b981' : share > 8 ? '#f59e0b' : '#4a6a8a';
        html += '<tr style="border-bottom:1px solid #0a1520;"><td style="padding:8px;">' + e[0] + '</td><td style="text-align:right;padding:8px;color:#c084fc;">' + e[1] + '</td><td style="text-align:right;padding:8px;color:#ffd700;">' + share + '%</td><td style="padding:8px;color:' + sigColor + ';font-size:0.9em;">' + signal + '</td></tr>';
      });
      html += '</table></div></div>';
    }
    
    html += '</div>'; // end pricing panel

    // Tab switching JS
    html += '<script>';
    html += 'function showPanel(name){';
    html += '  document.querySelectorAll(".panel").forEach(function(p){p.classList.remove("active");});';
    html += '  document.querySelectorAll(".tab").forEach(function(t){t.classList.remove("active");});';
    html += '  document.getElementById("panel-"+name).classList.add("active");';
    html += '  event.target.classList.add("active");';
    html += '}';
    html += '<\\/script>';
    html += '</body></html>';
    res.send(html);
  } catch(err) {
    console.error('AI page error:', err.stack || err.message);
    res.status(500).send('Error: ' + err.message);
  }
});

// ====== WORDPRESS LIVE SITE INTEGRATION ======
var WP_SITE = 'https://wildwoodsmallenginerepair.com';
var wpCache = { pages: null, posts: null, crawled: null, lastFetch: 0, lastCrawl: 0 };
var WP_CACHE_TTL = 15 * 60 * 1000; // 15 min cache
var WP_CRAWL_TTL = 60 * 60 * 1000; // 1 hour crawl cache

function wpFetch(urlPath) {
  return new Promise(function(resolve, reject) {
    var url = WP_SITE + urlPath;
    https.get(url, { headers: { 'User-Agent': 'WildwoodSEODashboard/1.0' } }, function(resp) {
      var data = '';
      resp.on('data', function(chunk) { data += chunk; });
      resp.on('end', function() {
        try { resolve(JSON.parse(data)); } catch(e) { resolve(data); }
      });
    }).on('error', function(e) { reject(e); });
  });
}

function crawlPage(url) {
  return new Promise(function(resolve, reject) {
    var mod = url.startsWith('https') ? https : http;
    mod.get(url, { headers: { 'User-Agent': 'WildwoodSEODashboard/1.0' }, timeout: 10000 }, function(resp) {
      // Handle redirects
      if(resp.statusCode >= 300 && resp.statusCode < 400 && resp.headers.location) {
        return crawlPage(resp.headers.location).then(resolve).catch(reject);
      }
      var data = '';
      resp.on('data', function(chunk) { data += chunk; });
      resp.on('end', function() {
        // Extract title and meta description from HTML
        var titleMatch = data.match(/<title[^>]*>(.*?)<\/title>/i);
        var descMatch = data.match(/<meta\s+name=["']description["']\s+content=["'](.*?)["']/i);
        if(!descMatch) descMatch = data.match(/<meta\s+content=["'](.*?)["']\s+name=["']description["']/i);
        var h1Match = data.match(/<h1[^>]*>(.*?)<\/h1>/i);
        var canonicalMatch = data.match(/<link\s+rel=["']canonical["']\s+href=["'](.*?)["']/i);
        var wordCount = data.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim().split(' ').length;
        resolve({
          title: titleMatch ? titleMatch[1].trim().substring(0, 120) : '',
          titleLen: titleMatch ? titleMatch[1].trim().length : 0,
          description: descMatch ? descMatch[1].trim().substring(0, 200) : '',
          descLen: descMatch ? descMatch[1].trim().length : 0,
          h1: h1Match ? h1Match[1].replace(/<[^>]*>/g, '').trim().substring(0, 100) : '',
          canonical: canonicalMatch ? canonicalMatch[1] : '',
          wordCount: Math.min(wordCount, 20000),
          statusCode: resp.statusCode
        });
      });
    }).on('error', function(e) { resolve({ title:'', titleLen:0, description:'', descLen:0, h1:'', canonical:'', wordCount:0, statusCode:0, error: e.message }); })
      .on('timeout', function() { resolve({ title:'TIMEOUT', titleLen:0, description:'', descLen:0, h1:'', canonical:'', wordCount:0, statusCode:0, error:'timeout' }); });
  });
}

// ====== WORDPRESS DEEP INTEGRATION (10x DATA) ======

// Enhanced cache
var wpCache = {
  pages: null, posts: null, media: null, categories: null, tags: null,
  crawled: null, deepCrawl: null, internalLinks: null, imageAudit: null,
  jetpackStats: null, jetpackTopPosts: null, jetpackSearchTerms: null, jetpackReferrers: null,
  missingCities: null, kwPageMap: null, contentScores: null,
  lastFetch: 0, lastCrawl: 0, lastDeep: 0, lastJetpack: 0
};
var WP_CACHE_TTL = 15 * 60 * 1000;
var WP_CRAWL_TTL = 60 * 60 * 1000;

// â”€â”€ CORE WP REST API â”€â”€

// Pages (full content)
app.get('/api/wp/pages', requireAuth('owner'), async function(req, res) {
  try {
    var now = Date.now();
    if(wpCache.pages && (now - wpCache.lastFetch) < WP_CACHE_TTL) return res.json({ cached: true, count: wpCache.pages.length, data: wpCache.pages });
    var allPages = [], page = 1, hasMore = true;
    while(hasMore && page <= 20) {
      var batch = await wpFetch('/wp-json/wp/v2/pages?per_page=100&page=' + page + '&_fields=id,title,slug,link,date,modified,status,content,excerpt,parent,featured_media,template');
      if(Array.isArray(batch) && batch.length > 0) {
        allPages = allPages.concat(batch.map(function(p) {
          var body = (p.content && p.content.rendered) || '';
          var text = body.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
          return { id:p.id, title:(p.title&&p.title.rendered)||'', slug:p.slug, link:p.link, date:p.date, modified:p.modified, status:p.status, parent:p.parent, template:p.template||'', featuredMedia:p.featured_media, wordCount:text.split(' ').length, excerpt:((p.excerpt&&p.excerpt.rendered)||'').replace(/<[^>]*>/g,'').substring(0,200) };
        }));
        page++;
        if(batch.length < 100) hasMore = false;
      } else hasMore = false;
    }
    wpCache.pages = allPages;
    wpCache.lastFetch = now;
    res.json({ cached: false, count: allPages.length, data: allPages });
  } catch(e) { res.json({ error: e.message }); }
});

// Posts (full content + categories)
app.get('/api/wp/posts', requireAuth('owner'), async function(req, res) {
  try {
    var now = Date.now();
    if(wpCache.posts && (now - wpCache.lastFetch) < WP_CACHE_TTL) return res.json({ cached: true, count: wpCache.posts.length, data: wpCache.posts });
    var allPosts = [], page = 1, hasMore = true;
    while(hasMore && page <= 10) {
      var batch = await wpFetch('/wp-json/wp/v2/posts?per_page=100&page=' + page + '&_fields=id,title,slug,link,date,modified,status,categories,tags,content,excerpt,featured_media');
      if(Array.isArray(batch) && batch.length > 0) {
        allPosts = allPosts.concat(batch.map(function(p) {
          var body = (p.content && p.content.rendered) || '';
          var text = body.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
          return { id:p.id, title:(p.title&&p.title.rendered)||'', slug:p.slug, link:p.link, date:p.date, modified:p.modified, status:p.status, categories:p.categories||[], tags:p.tags||[], wordCount:text.split(' ').length, excerpt:((p.excerpt&&p.excerpt.rendered)||'').replace(/<[^>]*>/g,'').substring(0,200), featuredMedia:p.featured_media };
        }));
        page++;
        if(batch.length < 100) hasMore = false;
      } else hasMore = false;
    }
    wpCache.posts = allPosts;
    res.json({ cached: false, count: allPosts.length, data: allPosts });
  } catch(e) { res.json({ error: e.message }); }
});

// Media library (all images + alt text)
app.get('/api/wp/media', requireAuth('owner'), async function(req, res) {
  try {
    var now = Date.now();
    if(wpCache.media && (now - wpCache.lastFetch) < WP_CACHE_TTL) return res.json({ cached: true, count: wpCache.media.length, data: wpCache.media });
    var allMedia = [], page = 1, hasMore = true;
    while(hasMore && page <= 10) {
      var batch = await wpFetch('/wp-json/wp/v2/media?per_page=100&page=' + page + '&_fields=id,title,alt_text,source_url,media_type,mime_type,date');
      if(Array.isArray(batch) && batch.length > 0) {
        allMedia = allMedia.concat(batch.map(function(m) {
          return { id:m.id, title:(m.title&&m.title.rendered)||'', altText:m.alt_text||'', url:m.source_url||'', type:m.media_type||'', mime:m.mime_type||'', date:m.date, hasAlt:!!(m.alt_text && m.alt_text.trim()) };
        }));
        page++;
        if(batch.length < 100) hasMore = false;
      } else hasMore = false;
    }
    wpCache.media = allMedia;
    var noAlt = allMedia.filter(function(m) { return m.type === 'image' && !m.hasAlt; });
    res.json({ cached: false, count: allMedia.length, images: allMedia.filter(function(m){return m.type==='image';}).length, missingAlt: noAlt.length, data: allMedia });
  } catch(e) { res.json({ error: e.message }); }
});

// Categories
app.get('/api/wp/categories', requireAuth('owner'), async function(req, res) {
  try {
    var cats = await wpFetch('/wp-json/wp/v2/categories?per_page=100&_fields=id,name,slug,count,parent');
    res.json({ count: cats.length, data: cats });
  } catch(e) { res.json({ error: e.message }); }
});

// Tags
app.get('/api/wp/tags', requireAuth('owner'), async function(req, res) {
  try {
    var tags = await wpFetch('/wp-json/wp/v2/tags?per_page=100&_fields=id,name,slug,count');
    res.json({ count: tags.length, data: tags });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ DEEP CRAWL â”€â”€

// Full SEO crawl: title, meta, h1-h4, OG, schema, canonical, response time, internal/external links, images, keyword density
app.get('/api/wp/deep-crawl', requireAuth('owner'), async function(req, res) {
  try {
    var now = Date.now();
    if(wpCache.deepCrawl && (now - wpCache.lastDeep) < WP_CRAWL_TTL) return res.json({ cached: true, count: wpCache.deepCrawl.length, data: wpCache.deepCrawl });
    // Get pages first
    if(!wpCache.pages) {
      var allPages = [], pg = 1, more = true;
      while(more && pg <= 20) {
        var batch = await wpFetch('/wp-json/wp/v2/pages?per_page=100&page=' + pg + '&_fields=id,title,slug,link');
        if(Array.isArray(batch) && batch.length > 0) { allPages = allPages.concat(batch); pg++; if(batch.length < 100) more = false; } else more = false;
      }
      wpCache.pages = allPages.map(function(p) { return { id:p.id, title:(p.title&&p.title.rendered)||'', slug:p.slug, link:p.link }; });
    }
    var pagesToCrawl = wpCache.pages.slice(0, 80);
    var results = [];
    for(var i = 0; i < pagesToCrawl.length; i++) {
      var pg = pagesToCrawl[i];
      var url = pg.link || (WP_SITE + '/' + pg.slug + '/');
      try {
        var startTime = Date.now();
        var html = await new Promise(function(resolve, reject) {
          var mod = url.startsWith('https') ? https : http;
          mod.get(url, { headers: { 'User-Agent': 'WildwoodSEOCrawler/2.0' }, timeout: 15000 }, function(resp) {
            if(resp.statusCode >= 300 && resp.statusCode < 400 && resp.headers.location) {
              return crawlPage(resp.headers.location).then(function(r) { resolve({html:'',redirect:resp.headers.location,statusCode:resp.statusCode,parsed:r}); });
            }
            var data = '';
            resp.on('data', function(chunk) { data += chunk; });
            resp.on('end', function() { resolve({html:data,statusCode:resp.statusCode}); });
          }).on('error', function(e) { resolve({html:'',statusCode:0,error:e.message}); })
            .on('timeout', function() { resolve({html:'',statusCode:0,error:'timeout'}); });
        });
        var responseTime = Date.now() - startTime;
        var h = html.html || '';

        // Parse everything
        var titleMatch = h.match(/<title[^>]*>(.*?)<\/title>/i);
        var descMatch = h.match(/<meta\s+name=["']description["']\s+content=["'](.*?)["']/i) || h.match(/<meta\s+content=["'](.*?)["']\s+name=["']description["']/i);
        var canonMatch = h.match(/<link\s+rel=["']canonical["']\s+href=["'](.*?)["']/i);
        var robotsMatch = h.match(/<meta\s+name=["']robots["']\s+content=["'](.*?)["']/i);

        // Headings
        var h1s = (h.match(/<h1[^>]*>(.*?)<\/h1>/gi) || []).map(function(x) { return x.replace(/<[^>]*>/g,'').trim(); });
        var h2s = (h.match(/<h2[^>]*>(.*?)<\/h2>/gi) || []).map(function(x) { return x.replace(/<[^>]*>/g,'').trim(); });
        var h3s = (h.match(/<h3[^>]*>(.*?)<\/h3>/gi) || []).map(function(x) { return x.replace(/<[^>]*>/g,'').trim(); });

        // Open Graph
        var ogTitle = (h.match(/<meta\s+property=["']og:title["']\s+content=["'](.*?)["']/i) || [])[1] || '';
        var ogDesc = (h.match(/<meta\s+property=["']og:description["']\s+content=["'](.*?)["']/i) || [])[1] || '';
        var ogImage = (h.match(/<meta\s+property=["']og:image["']\s+content=["'](.*?)["']/i) || [])[1] || '';

        // Schema
        var schemas = (h.match(/<script\s+type=["']application\/ld\+json["'][^>]*>(.*?)<\/script>/gi) || []);
        var schemaTypes = [];
        schemas.forEach(function(s) {
          try {
            var json = JSON.parse(s.replace(/<[^>]*>/g, ''));
            if(json['@type']) schemaTypes.push(json['@type']);
          } catch(e) {}
        });

        // Links
        var internalLinks = [], externalLinks = [];
        var linkMatches = h.match(/<a\s[^>]*href=["'](.*?)["'][^>]*>/gi) || [];
        linkMatches.forEach(function(l) {
          var href = (l.match(/href=["'](.*?)["']/i) || [])[1] || '';
          if(!href || href.startsWith('#') || href.startsWith('javascript') || href.startsWith('mailto') || href.startsWith('tel')) return;
          if(href.indexOf('wildwoodsmallenginerepair.com') >= 0 || href.startsWith('/')) {
            internalLinks.push(href);
          } else if(href.startsWith('http')) {
            externalLinks.push(href);
          }
        });

        // Images
        var images = [];
        var imgMatches = h.match(/<img\s[^>]*>/gi) || [];
        imgMatches.forEach(function(img) {
          var src = (img.match(/src=["'](.*?)["']/i) || [])[1] || '';
          var alt = (img.match(/alt=["'](.*?)["']/i) || [])[1] || '';
          if(src) images.push({ src: src.substring(0,200), alt: alt, hasAlt: !!(alt && alt.trim()) });
        });
        var missingAltCount = images.filter(function(img) { return !img.hasAlt; }).length;

        // Text content for word count and keyword density
        var textContent = h.replace(/<script[^>]*>.*?<\/script>/gi, '').replace(/<style[^>]*>.*?<\/style>/gi, '').replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
        var wordCount = textContent.split(' ').length;

        results.push({
          id: pg.id, slug: pg.slug, url: url,
          statusCode: html.statusCode, responseTime: responseTime, redirect: html.redirect || null,
          title: titleMatch ? titleMatch[1].trim().substring(0,150) : '', titleLen: titleMatch ? titleMatch[1].trim().length : 0,
          description: descMatch ? descMatch[1].trim().substring(0,250) : '', descLen: descMatch ? descMatch[1].trim().length : 0,
          canonical: canonMatch ? canonMatch[1] : '', robots: robotsMatch ? robotsMatch[1] : '',
          h1: h1s, h2: h2s.slice(0,15), h3: h3s.slice(0,10),
          ogTitle: ogTitle.substring(0,100), ogDesc: ogDesc.substring(0,200), ogImage: ogImage.substring(0,200),
          schemas: schemaTypes,
          internalLinks: [...new Set(internalLinks)].length, internalLinksList: [...new Set(internalLinks)].slice(0,20),
          externalLinks: [...new Set(externalLinks)].length, externalLinksList: [...new Set(externalLinks)].slice(0,10),
          images: images.length, missingAlt: missingAltCount,
          wordCount: Math.min(wordCount, 20000)
        });
      } catch(e) {
        results.push({ id:pg.id, slug:pg.slug, url:url, error:e.message, statusCode:0 });
      }
    }
    wpCache.deepCrawl = results;
    wpCache.lastDeep = now;

    // Compute summary stats
    var totalIssues = 0;
    var summary = {
      pages: results.length,
      avgResponseTime: Math.round(results.reduce(function(s,r){return s+(r.responseTime||0);},0) / Math.max(results.length,1)),
      missingTitles: results.filter(function(r){return !r.title;}).length,
      longTitles: results.filter(function(r){return r.titleLen > 60;}).length,
      missingDesc: results.filter(function(r){return !r.description;}).length,
      longDesc: results.filter(function(r){return r.descLen > 160;}).length,
      missingH1: results.filter(function(r){return !r.h1 || r.h1.length === 0;}).length,
      multipleH1: results.filter(function(r){return r.h1 && r.h1.length > 1;}).length,
      noSchema: results.filter(function(r){return !r.schemas || r.schemas.length === 0;}).length,
      noOG: results.filter(function(r){return !r.ogTitle;}).length,
      totalImages: results.reduce(function(s,r){return s+(r.images||0);},0),
      totalMissingAlt: results.reduce(function(s,r){return s+(r.missingAlt||0);},0),
      totalInternalLinks: results.reduce(function(s,r){return s+(r.internalLinks||0);},0),
      totalExternalLinks: results.reduce(function(s,r){return s+(r.externalLinks||0);},0),
      avgWordCount: Math.round(results.reduce(function(s,r){return s+(r.wordCount||0);},0) / Math.max(results.length,1)),
      thinContent: results.filter(function(r){return r.wordCount < 300;}).length,
      redirects: results.filter(function(r){return r.redirect;}).length,
      errors: results.filter(function(r){return r.statusCode >= 400 || r.statusCode === 0;}).length
    };

    res.json({ cached: false, summary: summary, count: results.length, data: results });
  } catch(e) { res.json({ error: e.message }); }
});

// Internal link graph
app.get('/api/wp/link-graph', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.deepCrawl) return res.json({ error: 'Run deep crawl first (/api/wp/deep-crawl)' });
    var graph = {};
    var allSlugs = wpCache.deepCrawl.map(function(p) { return p.slug; });
    wpCache.deepCrawl.forEach(function(p) {
      graph[p.slug] = { url: p.url, linksTo: [], linkedFrom: [], internalLinks: p.internalLinks, orphan: false };
      (p.internalLinksList || []).forEach(function(link) {
        var slug = link.replace('https://wildwoodsmallenginerepair.com/', '').replace('http://wildwoodsmallenginerepair.com/', '').replace(/\/$/, '').split('?')[0];
        if(slug) graph[p.slug].linksTo.push(slug);
      });
    });
    // Build linkedFrom
    Object.keys(graph).forEach(function(slug) {
      graph[slug].linksTo.forEach(function(target) {
        if(graph[target]) graph[target].linkedFrom.push(slug);
      });
    });
    // Find orphan pages
    var orphans = [];
    Object.keys(graph).forEach(function(slug) {
      if(graph[slug].linkedFrom.length === 0 && slug !== '' && slug !== 'shop' && slug !== 'cart') {
        graph[slug].orphan = true;
        orphans.push(slug);
      }
    });
    res.json({ pages: Object.keys(graph).length, orphans: orphans.length, orphanPages: orphans, graph: graph });
  } catch(e) { res.json({ error: e.message }); }
});

// Image SEO audit
app.get('/api/wp/image-audit', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.deepCrawl) return res.json({ error: 'Run deep crawl first' });
    var allImages = [];
    wpCache.deepCrawl.forEach(function(p) {
      // We'd need the full image list from the crawl, but we have counts
      allImages.push({ page: p.slug, url: p.url, imageCount: p.images, missingAlt: p.missingAlt });
    });
    var totalImg = allImages.reduce(function(s,i){return s+i.imageCount;},0);
    var totalMissing = allImages.reduce(function(s,i){return s+i.missingAlt;},0);
    // Also get media library
    if(!wpCache.media) {
      var mediaLib = [], mp = 1, mm = true;
      while(mm && mp <= 10) {
        var batch = await wpFetch('/wp-json/wp/v2/media?per_page=100&page=' + mp + '&_fields=id,title,alt_text,source_url,media_type,date');
        if(Array.isArray(batch) && batch.length > 0) { mediaLib = mediaLib.concat(batch); mp++; if(batch.length < 100) mm = false; } else mm = false;
      }
      wpCache.media = mediaLib.map(function(m) { return { id:m.id, title:(m.title&&m.title.rendered)||'', altText:m.alt_text||'', url:m.source_url||'', type:m.media_type||'', hasAlt:!!(m.alt_text&&m.alt_text.trim()) }; });
    }
    var libImages = wpCache.media.filter(function(m) { return m.type === 'image'; });
    var libMissingAlt = libImages.filter(function(m) { return !m.hasAlt; });
    res.json({
      onPage: { totalImages: totalImg, missingAlt: totalMissing, pages: allImages },
      mediaLibrary: { total: libImages.length, missingAlt: libMissingAlt.length, missingList: libMissingAlt.slice(0,50).map(function(m) { return { id:m.id, title:m.title, url:m.url }; }) }
    });
  } catch(e) { res.json({ error: e.message }); }
});

// Keyword-to-page mapping
app.get('/api/wp/keyword-map', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.deepCrawl) return res.json({ error: 'Run deep crawl first' });
    var D = SEO_CONTENT_DATA;
    var kwMap = { matched: [], unmatched: [], pagesWithNoKW: [] };
    // Get all target keywords from all sources
    var allKWs = {};
    Object.keys(D.keywordResearch || {}).forEach(function(city) {
      (D.keywordResearch[city] || []).forEach(function(kw) {
        if(kw.keyword) allKWs[kw.keyword.toLowerCase()] = { keyword: kw.keyword, volume: kw.volume || 0, city: city, foundOn: [] };
      });
    });
    Object.keys(D.flKeywords || {}).forEach(function(city) {
      (D.flKeywords[city] || []).forEach(function(kw) {
        if(kw.keyword) allKWs[kw.keyword.toLowerCase()] = { keyword: kw.keyword, volume: kw.volume || 0, city: city, foundOn: [] };
      });
    });
    (D.savedKeywords || []).forEach(function(kw) {
      if(kw.keyword) allKWs[kw.keyword.toLowerCase()] = { keyword: kw.keyword, volume: kw.avgMonthly || 0, city: 'National', foundOn: [] };
    });

    // Check each page for keyword presence in title, description, h1, h2
    wpCache.deepCrawl.forEach(function(p) {
      var pageText = [p.title || '', p.description || '', (p.h1||[]).join(' '), (p.h2||[]).join(' ')].join(' ').toLowerCase();
      var matched = false;
      Object.keys(allKWs).forEach(function(kwLower) {
        if(pageText.indexOf(kwLower) >= 0) {
          allKWs[kwLower].foundOn.push(p.slug);
          matched = true;
        }
      });
      if(!matched) kwMap.pagesWithNoKW.push(p.slug);
    });

    Object.values(allKWs).forEach(function(kw) {
      if(kw.foundOn.length > 0) kwMap.matched.push(kw);
      else kwMap.unmatched.push(kw);
    });
    kwMap.unmatched.sort(function(a,b) { return b.volume - a.volume; });
    kwMap.matched.sort(function(a,b) { return b.volume - a.volume; });

    res.json({
      totalKeywords: Object.keys(allKWs).length,
      matched: kwMap.matched.length,
      unmatched: kwMap.unmatched.length,
      pagesWithNoKeyword: kwMap.pagesWithNoKW.length,
      topUnmatched: kwMap.unmatched.slice(0,30),
      topMatched: kwMap.matched.slice(0,30),
      orphanPages: kwMap.pagesWithNoKW
    });
  } catch(e) { res.json({ error: e.message }); }
});

// Content freshness scoring
app.get('/api/wp/content-scores', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.pages) return res.json({ error: 'Load pages first' });
    var now = new Date();
    var scores = wpCache.pages.map(function(p) {
      var modified = p.modified ? new Date(p.modified) : new Date(p.date);
      var daysSince = Math.floor((now - modified) / (1000*60*60*24));
      var freshness = daysSince < 30 ? 'FRESH' : daysSince < 90 ? 'OK' : daysSince < 180 ? 'STALE' : 'OUTDATED';
      var wordScore = (p.wordCount || 0) >= 1500 ? 'DEEP' : (p.wordCount || 0) >= 800 ? 'GOOD' : (p.wordCount || 0) >= 300 ? 'THIN' : 'EMPTY';
      return { slug: p.slug, title: p.title, wordCount: p.wordCount || 0, modified: p.modified || p.date, daysSinceUpdate: daysSince, freshness: freshness, contentDepth: wordScore };
    });
    scores.sort(function(a,b) { return b.daysSinceUpdate - a.daysSinceUpdate; });
    var summary = {
      fresh: scores.filter(function(s){return s.freshness==='FRESH';}).length,
      ok: scores.filter(function(s){return s.freshness==='OK';}).length,
      stale: scores.filter(function(s){return s.freshness==='STALE';}).length,
      outdated: scores.filter(function(s){return s.freshness==='OUTDATED';}).length,
      deep: scores.filter(function(s){return s.contentDepth==='DEEP';}).length,
      thin: scores.filter(function(s){return s.contentDepth==='THIN';}).length,
      empty: scores.filter(function(s){return s.contentDepth==='EMPTY';}).length
    };
    res.json({ summary: summary, count: scores.length, data: scores });
  } catch(e) { res.json({ error: e.message }); }
});

// Missing city landing pages
app.get('/api/wp/missing-cities', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.pages) {
      var allPages = [], pg = 1, more = true;
      while(more && pg <= 20) {
        var batch = await wpFetch('/wp-json/wp/v2/pages?per_page=100&page=' + pg + '&_fields=id,title,slug,link');
        if(Array.isArray(batch) && batch.length > 0) { allPages = allPages.concat(batch); pg++; if(batch.length < 100) more = false; } else more = false;
      }
      wpCache.pages = allPages.map(function(p) { return { id:p.id, title:(p.title&&p.title.rendered)||'', slug:p.slug, link:p.link }; });
    }
    var slugs = wpCache.pages.map(function(p) { return (p.slug||'').toLowerCase(); }).join(' ');
    var allTitles = wpCache.pages.map(function(p) { return (p.title||'').toLowerCase(); }).join(' ');
    var D = SEO_CONTENT_DATA;
    var targetCities = [];
    Object.keys(D.offPage || {}).forEach(function(c) { targetCities.push(c); });
    ((D.flCities || {}).profiles || []).forEach(function(p) { if(p.city) targetCities.push(p.city + ', FL'); });
    Object.keys(D.keywordResearch || {}).forEach(function(c) { targetCities.push(c); });
    (D.gbpProfiles || []).forEach(function(p) { if(p.city) targetCities.push(p.city); });
    // Add snow blower cities
    (D.landingPages || []).forEach(function(p) { if(p.city) targetCities.push(p.city); });
    Object.keys(D.snowBlowerKeywords || {}).forEach(function(c) { targetCities.push(c); });
    targetCities = [...new Set(targetCities)];
    var missing = [], found = [];
    targetCities.forEach(function(city) {
      var citySlug = city.toLowerCase().replace(/[^a-z0-9]/g,'');
      var cityName = city.toLowerCase().split(',')[0].trim().replace(/\s+/g,'-');
      var cityWords = city.toLowerCase().split(',')[0].trim();
      var hasPage = slugs.indexOf(citySlug) >= 0 || slugs.indexOf(cityName) >= 0 || allTitles.indexOf(cityWords) >= 0;
      if(hasPage) found.push(city); else missing.push(city);
    });
    res.json({ totalCities: targetCities.length, found: found.length, missing: missing.length, missingCities: missing, foundCities: found });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ JETPACK STATS (requires JETPACK_TOKEN) â”€â”€

app.get('/api/wp/stats', requireAuth('owner'), async function(req, res) {
  try {
    var wpToken = process.env.JETPACK_TOKEN || 'ekc8plBT0()aZ1vd2epcpk3xa#tmNv(sqcG(MBYTJvSAFSQXaNB762c*FD!tP#KR';
    var siteId = process.env.JETPACK_SITE_ID || 'wildwoodsmallenginerepair.com';
    if(!wpToken) return res.json({ error: 'JETPACK_TOKEN not set in .env', setup: 'Add JETPACK_TOKEN=your_token and JETPACK_SITE_ID=your_site_id to .env. Get token from https://developer.wordpress.com/apps/' });
    var data = await new Promise(function(resolve, reject) {
      https.get('https://public-api.wordpress.com/rest/v1.1/sites/' + siteId + '/stats/summary?num=30', { headers: { 'Authorization': 'Bearer ' + wpToken } }, function(resp) {
        var body = ''; resp.on('data', function(chunk) { body += chunk; }); resp.on('end', function() { try { resolve(JSON.parse(body)); } catch(e) { resolve({error:body}); } });
      }).on('error', function(e) { reject(e); });
    });
    res.json(data);
  } catch(e) { res.json({ error: e.message }); }
});

app.get('/api/wp/stats/top-posts', requireAuth('owner'), async function(req, res) {
  try {
    var wpToken = process.env.JETPACK_TOKEN || 'ekc8plBT0()aZ1vd2epcpk3xa#tmNv(sqcG(MBYTJvSAFSQXaNB762c*FD!tP#KR';
    var siteId = process.env.JETPACK_SITE_ID || 'wildwoodsmallenginerepair.com';
    if(!wpToken) return res.json({ error: 'JETPACK_TOKEN not set' });
    var data = await new Promise(function(resolve, reject) {
      https.get('https://public-api.wordpress.com/rest/v1.1/sites/' + siteId + '/stats/top-posts?num=30&period=month', { headers: { 'Authorization': 'Bearer ' + wpToken } }, function(resp) {
        var body = ''; resp.on('data', function(chunk) { body += chunk; }); resp.on('end', function() { try { resolve(JSON.parse(body)); } catch(e) { resolve({error:body}); } });
      }).on('error', function(e) { reject(e); });
    });
    res.json(data);
  } catch(e) { res.json({ error: e.message }); }
});

app.get('/api/wp/stats/search-terms', requireAuth('owner'), async function(req, res) {
  try {
    var wpToken = process.env.JETPACK_TOKEN || 'ekc8plBT0()aZ1vd2epcpk3xa#tmNv(sqcG(MBYTJvSAFSQXaNB762c*FD!tP#KR';
    var siteId = process.env.JETPACK_SITE_ID || 'wildwoodsmallenginerepair.com';
    if(!wpToken) return res.json({ error: 'JETPACK_TOKEN not set' });
    var data = await new Promise(function(resolve, reject) {
      https.get('https://public-api.wordpress.com/rest/v1.1/sites/' + siteId + '/stats/search-terms?num=30', { headers: { 'Authorization': 'Bearer ' + wpToken } }, function(resp) {
        var body = ''; resp.on('data', function(chunk) { body += chunk; }); resp.on('end', function() { try { resolve(JSON.parse(body)); } catch(e) { resolve({error:body}); } });
      }).on('error', function(e) { reject(e); });
    });
    res.json(data);
  } catch(e) { res.json({ error: e.message }); }
});

app.get('/api/wp/stats/referrers', requireAuth('owner'), async function(req, res) {
  try {
    var wpToken = process.env.JETPACK_TOKEN || 'ekc8plBT0()aZ1vd2epcpk3xa#tmNv(sqcG(MBYTJvSAFSQXaNB762c*FD!tP#KR';
    var siteId = process.env.JETPACK_SITE_ID || 'wildwoodsmallenginerepair.com';
    if(!wpToken) return res.json({ error: 'JETPACK_TOKEN not set' });
    var data = await new Promise(function(resolve, reject) {
      https.get('https://public-api.wordpress.com/rest/v1.1/sites/' + siteId + '/stats/referrers?num=30', { headers: { 'Authorization': 'Bearer ' + wpToken } }, function(resp) {
        var body = ''; resp.on('data', function(chunk) { body += chunk; }); resp.on('end', function() { try { resolve(JSON.parse(body)); } catch(e) { resolve({error:body}); } });
      }).on('error', function(e) { reject(e); });
    });
    res.json(data);
  } catch(e) { res.json({ error: e.message }); }
});

app.get('/api/wp/stats/country-views', requireAuth('owner'), async function(req, res) {
  try {
    var wpToken = process.env.JETPACK_TOKEN || 'ekc8plBT0()aZ1vd2epcpk3xa#tmNv(sqcG(MBYTJvSAFSQXaNB762c*FD!tP#KR';
    var siteId = process.env.JETPACK_SITE_ID || 'wildwoodsmallenginerepair.com';
    if(!wpToken) return res.json({ error: 'JETPACK_TOKEN not set' });
    var data = await new Promise(function(resolve, reject) {
      https.get('https://public-api.wordpress.com/rest/v1.1/sites/' + siteId + '/stats/country-views?num=30', { headers: { 'Authorization': 'Bearer ' + wpToken } }, function(resp) {
        var body = ''; resp.on('data', function(chunk) { body += chunk; }); resp.on('end', function() { try { resolve(JSON.parse(body)); } catch(e) { resolve({error:body}); } });
      }).on('error', function(e) { reject(e); });
    });
    res.json(data);
  } catch(e) { res.json({ error: e.message }); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10x DATA EXPANSION â€” INFRASTRUCTURE & ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ ROBOTS.TXT PARSER â”€â”€
app.get('/api/wp/robots', requireAuth('owner'), async function(req, res) {
  try {
    var body = await new Promise(function(resolve, reject) {
      https.get(WP_SITE + '/robots.txt', function(resp) {
        var d = ''; resp.on('data', function(c){d+=c;}); resp.on('end', function(){resolve(d);});
      }).on('error', reject);
    });
    var lines = body.split('\n').filter(function(l){return l.trim();});
    var rules = { allows: [], disallows: [], sitemaps: [], crawlDelay: null, raw: body };
    lines.forEach(function(l) {
      var lower = l.toLowerCase().trim();
      if(lower.startsWith('allow:')) rules.allows.push(l.split(':').slice(1).join(':').trim());
      if(lower.startsWith('disallow:')) rules.disallows.push(l.split(':').slice(1).join(':').trim());
      if(lower.startsWith('sitemap:')) rules.sitemaps.push(l.split(':').slice(1).join(':').trim());
      if(lower.startsWith('crawl-delay:')) rules.crawlDelay = parseInt(l.split(':')[1]);
    });
    res.json(rules);
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ SITEMAP PARSER (recursive) â”€â”€
app.get('/api/wp/sitemap', requireAuth('owner'), async function(req, res) {
  try {
    var sitemapUrls = [];
    async function parseSitemap(url) {
      var body = await new Promise(function(resolve, reject) {
        var mod = url.startsWith('https') ? https : http;
        mod.get(url, { timeout: 15000 }, function(resp) {
          var d = ''; resp.on('data', function(c){d+=c;}); resp.on('end', function(){resolve(d);});
        }).on('error', function(e){resolve('');});
      });
      // Check if it's a sitemap index
      var indexMatches = body.match(/<sitemap>[\s\S]*?<loc>(.*?)<\/loc>[\s\S]*?<\/sitemap>/gi) || [];
      if(indexMatches.length > 0) {
        for(var i = 0; i < indexMatches.length; i++) {
          var loc = (indexMatches[i].match(/<loc>(.*?)<\/loc>/i) || [])[1];
          if(loc) await parseSitemap(loc.trim());
        }
      }
      // Parse URL entries
      var urlMatches = body.match(/<url>[\s\S]*?<\/url>/gi) || [];
      urlMatches.forEach(function(u) {
        var loc = (u.match(/<loc>(.*?)<\/loc>/i) || [])[1] || '';
        var lastmod = (u.match(/<lastmod>(.*?)<\/lastmod>/i) || [])[1] || '';
        var priority = (u.match(/<priority>(.*?)<\/priority>/i) || [])[1] || '';
        var changefreq = (u.match(/<changefreq>(.*?)<\/changefreq>/i) || [])[1] || '';
        if(loc) sitemapUrls.push({ url: loc.trim(), lastmod: lastmod, priority: priority, changefreq: changefreq });
      });
    }
    await parseSitemap(WP_SITE + '/sitemap.xml');
    if(sitemapUrls.length === 0) await parseSitemap(WP_SITE + '/sitemap_index.xml');
    if(sitemapUrls.length === 0) await parseSitemap(WP_SITE + '/wp-sitemap.xml');
    res.json({ count: sitemapUrls.length, urls: sitemapUrls });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ SSL & SECURITY HEADERS â”€â”€
app.get('/api/wp/security', requireAuth('owner'), async function(req, res) {
  try {
    var result = await new Promise(function(resolve, reject) {
      var req2 = https.get(WP_SITE, { timeout: 10000 }, function(resp) {
        var headers = resp.headers;
        var socket = resp.socket || {};
        var cert = socket.getPeerCertificate ? socket.getPeerCertificate() : {};
        resolve({
          statusCode: resp.statusCode,
          ssl: {
            valid: !!(cert && cert.subject),
            issuer: cert.issuer ? (cert.issuer.O || cert.issuer.CN || '') : '',
            subject: cert.subject ? (cert.subject.CN || '') : '',
            validFrom: cert.valid_from || '',
            validTo: cert.valid_to || '',
            daysUntilExpiry: cert.valid_to ? Math.floor((new Date(cert.valid_to) - new Date()) / (1000*60*60*24)) : null,
            protocol: socket.getProtocol ? socket.getProtocol() : ''
          },
          security: {
            strictTransportSecurity: headers['strict-transport-security'] || 'MISSING',
            contentSecurityPolicy: headers['content-security-policy'] ? 'SET' : 'MISSING',
            xFrameOptions: headers['x-frame-options'] || 'MISSING',
            xContentTypeOptions: headers['x-content-type-options'] || 'MISSING',
            xXSSProtection: headers['x-xss-protection'] || 'MISSING',
            referrerPolicy: headers['referrer-policy'] || 'MISSING',
            permissionsPolicy: headers['permissions-policy'] ? 'SET' : 'MISSING'
          },
          server: {
            server: headers['server'] || '',
            poweredBy: headers['x-powered-by'] || '',
            caching: headers['cache-control'] || '',
            cdn: headers['x-cache'] || headers['cf-cache-status'] || headers['x-cdn'] || '',
            contentEncoding: headers['content-encoding'] || ''
          },
          allHeaders: headers
        });
      });
      req2.on('error', function(e) { resolve({ error: e.message }); });
    });
    res.json(result);
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ PAGE SPEED (per URL, uses response time + size) â”€â”€
app.get('/api/wp/speed-test', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.pages) return res.json({ error: 'Load pages first' });
    var urls = wpCache.pages.slice(0, 30).map(function(p) { return p.link || WP_SITE + '/' + p.slug + '/'; });
    var results = [];
    for(var i = 0; i < urls.length; i++) {
      var url = urls[i];
      var startTime = Date.now();
      var result = await new Promise(function(resolve) {
        var mod = url.startsWith('https') ? https : http;
        var req2 = mod.get(url, { timeout: 15000 }, function(resp) {
          var size = 0; var ttfb = Date.now() - startTime;
          resp.on('data', function(chunk) { size += chunk.length; });
          resp.on('end', function() {
            resolve({
              url: url, slug: wpCache.pages[i] ? wpCache.pages[i].slug : '',
              statusCode: resp.statusCode,
              ttfb: ttfb,
              totalTime: Date.now() - startTime,
              sizeBytes: size,
              sizeKB: Math.round(size / 1024),
              encoding: resp.headers['content-encoding'] || 'none',
              cacheControl: resp.headers['cache-control'] || ''
            });
          });
        });
        req2.on('error', function(e) { resolve({ url:url, error:e.message, statusCode:0 }); });
        req2.on('timeout', function() { resolve({ url:url, error:'timeout', statusCode:0 }); });
      });
      results.push(result);
    }
    var avgTTFB = Math.round(results.reduce(function(s,r){return s+(r.ttfb||0);},0) / Math.max(results.length,1));
    var avgTotal = Math.round(results.reduce(function(s,r){return s+(r.totalTime||0);},0) / Math.max(results.length,1));
    var avgSize = Math.round(results.reduce(function(s,r){return s+(r.sizeKB||0);},0) / Math.max(results.length,1));
    var slow = results.filter(function(r){return r.totalTime > 3000;});
    var heavy = results.filter(function(r){return r.sizeKB > 500;});
    res.json({ count: results.length, avgTTFB: avgTTFB, avgTotalTime: avgTotal, avgSizeKB: avgSize, slowPages: slow.length, heavyPages: heavy.length, data: results });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ GOOGLE PAGESPEED INSIGHTS (free, no key required for basic) â”€â”€
app.get('/api/wp/pagespeed', requireAuth('owner'), async function(req, res) {
  try {
    var url = req.query.url || WP_SITE;
    var strategy = req.query.strategy || 'mobile';
    var apiUrl = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=' + encodeURIComponent(url) + '&strategy=' + strategy;
    var data = await new Promise(function(resolve, reject) {
      https.get(apiUrl, { timeout: 60000 }, function(resp) {
        var body = ''; resp.on('data', function(c){body+=c;}); resp.on('end', function(){ try{resolve(JSON.parse(body));}catch(e){resolve({error:body});} });
      }).on('error', reject);
    });
    var lhr = data.lighthouseResult || {};
    var cats = lhr.categories || {};
    var audits = lhr.audits || {};
    res.json({
      url: url, strategy: strategy,
      scores: {
        performance: cats.performance ? Math.round(cats.performance.score * 100) : null,
        accessibility: cats.accessibility ? Math.round(cats.accessibility.score * 100) : null,
        bestPractices: cats['best-practices'] ? Math.round(cats['best-practices'].score * 100) : null,
        seo: cats.seo ? Math.round(cats.seo.score * 100) : null
      },
      metrics: {
        FCP: audits['first-contentful-paint'] ? audits['first-contentful-paint'].displayValue : null,
        LCP: audits['largest-contentful-paint'] ? audits['largest-contentful-paint'].displayValue : null,
        TBT: audits['total-blocking-time'] ? audits['total-blocking-time'].displayValue : null,
        CLS: audits['cumulative-layout-shift'] ? audits['cumulative-layout-shift'].displayValue : null,
        SI: audits['speed-index'] ? audits['speed-index'].displayValue : null,
        TTI: audits['interactive'] ? audits['interactive'].displayValue : null
      },
      opportunities: Object.values(audits).filter(function(a) {
        return a.score !== null && a.score < 0.9 && a.details && a.details.type === 'opportunity';
      }).map(function(a) {
        return { title: a.title, description: a.description, savings: a.details.overallSavingsMs || 0 };
      }).sort(function(a,b){return b.savings - a.savings;}).slice(0,10)
    });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ BROKEN LINK CHECKER â”€â”€
app.get('/api/wp/broken-links', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.deepCrawl) return res.json({ error: 'Run deep crawl first' });
    var allLinks = [];
    wpCache.deepCrawl.forEach(function(p) {
      (p.externalLinksList || []).forEach(function(link) {
        allLinks.push({ source: p.slug, link: link, type: 'external' });
      });
      (p.internalLinksList || []).forEach(function(link) {
        allLinks.push({ source: p.slug, link: link.startsWith('http') ? link : WP_SITE + link, type: 'internal' });
      });
    });
    // Check up to 100 links
    var toCheck = allLinks.slice(0, 100);
    var broken = [], redirects = [], ok = 0;
    for(var i = 0; i < toCheck.length; i++) {
      var lnk = toCheck[i];
      try {
        var status = await new Promise(function(resolve) {
          var mod = lnk.link.startsWith('https') ? https : http;
          var r = mod.get(lnk.link, { timeout: 8000, headers: { 'User-Agent': 'WildwoodLinkChecker/1.0' } }, function(resp) {
            resolve(resp.statusCode);
          });
          r.on('error', function() { resolve(0); });
          r.on('timeout', function() { r.destroy(); resolve(0); });
        });
        if(status >= 400 || status === 0) broken.push({ source: lnk.source, link: lnk.link, status: status, type: lnk.type });
        else if(status >= 300) redirects.push({ source: lnk.source, link: lnk.link, status: status, type: lnk.type });
        else ok++;
      } catch(e) { broken.push({ source: lnk.source, link: lnk.link, status: 0, type: lnk.type, error: e.message }); }
    }
    res.json({ checked: toCheck.length, ok: ok, broken: broken.length, redirects: redirects.length, brokenLinks: broken, redirectLinks: redirects });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ KEYWORD CANNIBALIZATION DETECTOR â”€â”€
app.get('/api/wp/cannibalization', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.deepCrawl) return res.json({ error: 'Run deep crawl first' });
    var D = SEO_CONTENT_DATA;
    // Build keyword â†’ pages map
    var kwPages = {};
    var allKWs = {};
    Object.keys(D.keywordResearch || {}).forEach(function(city) {
      (D.keywordResearch[city] || []).forEach(function(kw) { if(kw.keyword) allKWs[kw.keyword.toLowerCase()] = kw.volume || 0; });
    });
    Object.keys(D.flKeywords || {}).forEach(function(city) {
      (D.flKeywords[city] || []).forEach(function(kw) { if(kw.keyword) allKWs[kw.keyword.toLowerCase()] = kw.volume || 0; });
    });
    (D.savedKeywords || []).forEach(function(kw) { if(kw.keyword) allKWs[kw.keyword.toLowerCase()] = kw.avgMonthly || 0; });

    wpCache.deepCrawl.forEach(function(p) {
      var pageText = [p.title||'', p.description||'', (p.h1||[]).join(' '), (p.h2||[]).join(' ')].join(' ').toLowerCase();
      Object.keys(allKWs).forEach(function(kw) {
        if(pageText.indexOf(kw) >= 0) {
          if(!kwPages[kw]) kwPages[kw] = { keyword: kw, volume: allKWs[kw], pages: [] };
          kwPages[kw].pages.push({ slug: p.slug, title: p.title, inTitle: (p.title||'').toLowerCase().indexOf(kw) >= 0, inH1: (p.h1||[]).join(' ').toLowerCase().indexOf(kw) >= 0 });
        }
      });
    });

    var cannibalized = Object.values(kwPages).filter(function(kw) { return kw.pages.length > 1; });
    cannibalized.sort(function(a,b) { return b.volume - a.volume; });

    res.json({
      totalKeywordsChecked: Object.keys(allKWs).length,
      cannibalizedKeywords: cannibalized.length,
      data: cannibalized.slice(0, 50)
    });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ CONTENT GAP ANALYSIS â”€â”€
app.get('/api/wp/content-gaps', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.deepCrawl) return res.json({ error: 'Run deep crawl first' });
    var D = SEO_CONTENT_DATA;
    var allKWs = {};
    Object.keys(D.keywordResearch || {}).forEach(function(city) {
      (D.keywordResearch[city] || []).forEach(function(kw) { if(kw.keyword) allKWs[kw.keyword.toLowerCase()] = { keyword: kw.keyword, volume: kw.volume||0, city: city }; });
    });
    Object.keys(D.flKeywords || {}).forEach(function(city) {
      (D.flKeywords[city] || []).forEach(function(kw) { if(kw.keyword) allKWs[kw.keyword.toLowerCase()] = { keyword: kw.keyword, volume: kw.volume||0, city: city }; });
    });
    Object.keys(D.snowBlowerKeywords || {}).forEach(function(city) {
      (D.snowBlowerKeywords[city] || []).forEach(function(kw) { if(kw.keyword) allKWs[kw.keyword.toLowerCase()] = { keyword: kw.keyword, volume: kw.volume||0, city: city }; });
    });

    var allPageText = wpCache.deepCrawl.map(function(p) {
      return [p.title||'', p.description||'', (p.h1||[]).join(' '), (p.h2||[]).join(' ')].join(' ').toLowerCase();
    }).join(' ');

    var gaps = [];
    Object.keys(allKWs).forEach(function(kwLower) {
      if(allPageText.indexOf(kwLower) < 0) gaps.push(allKWs[kwLower]);
    });
    gaps.sort(function(a,b) { return b.volume - a.volume; });

    var totalOpportunity = gaps.reduce(function(s,g){return s+g.volume;},0);
    res.json({
      totalKeywords: Object.keys(allKWs).length,
      covered: Object.keys(allKWs).length - gaps.length,
      gaps: gaps.length,
      totalMissedVolume: totalOpportunity,
      topGaps: gaps.slice(0, 50)
    });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ DUPLICATE TITLE/DESC DETECTION â”€â”€
app.get('/api/wp/duplicates', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.deepCrawl) return res.json({ error: 'Run deep crawl first' });
    var titleMap = {}, descMap = {};
    wpCache.deepCrawl.forEach(function(p) {
      var t = (p.title||'').trim().toLowerCase();
      var d = (p.description||'').trim().toLowerCase();
      if(t) { if(!titleMap[t]) titleMap[t] = []; titleMap[t].push(p.slug); }
      if(d) { if(!descMap[d]) descMap[d] = []; descMap[d].push(p.slug); }
    });
    var dupTitles = Object.keys(titleMap).filter(function(t){return titleMap[t].length > 1;}).map(function(t){return {title:t, pages:titleMap[t]};});
    var dupDescs = Object.keys(descMap).filter(function(d){return descMap[d].length > 1;}).map(function(d){return {description:d.substring(0,100), pages:descMap[d]};});
    res.json({ duplicateTitles: dupTitles.length, duplicateDescriptions: dupDescs.length, titles: dupTitles, descriptions: dupDescs });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ HEADING HIERARCHY VALIDATOR â”€â”€
app.get('/api/wp/heading-audit', requireAuth('owner'), async function(req, res) {
  try {
    if(!wpCache.deepCrawl) return res.json({ error: 'Run deep crawl first' });
    var issues = [];
    wpCache.deepCrawl.forEach(function(p) {
      var pageIssues = [];
      if(!p.h1 || p.h1.length === 0) pageIssues.push('Missing H1');
      if(p.h1 && p.h1.length > 1) pageIssues.push('Multiple H1s (' + p.h1.length + ')');
      if(p.h1 && p.h1[0] && p.title && p.h1[0].toLowerCase() === (p.title||'').toLowerCase()) pageIssues.push('H1 identical to title tag');
      if((!p.h2 || p.h2.length === 0) && (p.wordCount||0) > 500) pageIssues.push('No H2s on long page (' + p.wordCount + ' words)');
      if(pageIssues.length > 0) issues.push({ slug: p.slug, url: p.url, h1: p.h1, h2Count: (p.h2||[]).length, h3Count: (p.h3||[]).length, issues: pageIssues });
    });
    var summary = {
      pagesChecked: wpCache.deepCrawl.length,
      pagesWithIssues: issues.length,
      missingH1: issues.filter(function(i){return i.issues.indexOf('Missing H1')>=0;}).length,
      multipleH1: issues.filter(function(i){return i.issues.some(function(x){return x.startsWith('Multiple');});}).length,
      noH2OnLongPages: issues.filter(function(i){return i.issues.some(function(x){return x.startsWith('No H2');});}).length
    };
    res.json({ summary: summary, issues: issues });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ COMPETITOR CRAWL â”€â”€
app.get('/api/wp/competitor-crawl', requireAuth('owner'), async function(req, res) {
  try {
    var D = SEO_CONTENT_DATA;
    var competitors = ((D.competitors || {}).sites || []).slice(0, 6);
    if(competitors.length === 0) return res.json({ error: 'No competitors in data' });
    var results = [];
    for(var i = 0; i < competitors.length; i++) {
      var comp = competitors[i];
      var site = comp.url || comp.domain || '';
      if(!site.startsWith('http')) site = 'https://' + site;
      try {
        var cr = await crawlPage(site);
        // Try sitemap
        var sitemapBody = '';
        try {
          sitemapBody = await new Promise(function(resolve) {
            var mod = site.startsWith('https') ? https : http;
            mod.get(site + '/sitemap.xml', { timeout: 8000 }, function(resp) {
              var d = ''; resp.on('data', function(c){d+=c;}); resp.on('end', function(){resolve(d);});
            }).on('error', function(){resolve('');});
          });
        } catch(e) {}
        var sitemapCount = (sitemapBody.match(/<url>/gi) || []).length;
        results.push({
          name: comp.name || site,
          url: site,
          title: cr.title,
          description: cr.description,
          h1: cr.h1,
          wordCount: cr.wordCount,
          statusCode: cr.statusCode,
          estimatedPages: sitemapCount || '?',
          hasSchema: cr.schemas ? cr.schemas.length > 0 : false
        });
      } catch(e) {
        results.push({ name: comp.name || site, url: site, error: e.message });
      }
    }
    res.json({ count: results.length, data: results });
  } catch(e) { res.json({ error: e.message }); }
});

// â”€â”€ FULL SITE AUDIT (master endpoint â€” runs everything) â”€â”€
app.get('/api/wp/full-audit', requireAuth('owner'), async function(req, res) {
  try {
    res.json({
      message: 'Full audit is a composite of all endpoints. Call them individually for best performance:',
      endpoints: [
        { path: '/api/wp/pages', desc: 'All WP pages with content + word count', auth: 'none' },
        { path: '/api/wp/posts', desc: 'All blog posts with categories + word count', auth: 'none' },
        { path: '/api/wp/media', desc: 'Media library + alt text audit', auth: 'none' },
        { path: '/api/wp/categories', desc: 'All categories', auth: 'none' },
        { path: '/api/wp/tags', desc: 'All tags', auth: 'none' },
        { path: '/api/wp/deep-crawl', desc: 'SEO crawl: titles, meta, H1-H3, OG, schema, links, images', auth: 'none' },
        { path: '/api/wp/link-graph', desc: 'Internal link map + orphan page detection', auth: 'deep-crawl' },
        { path: '/api/wp/image-audit', desc: 'Image alt text audit (on-page + media library)', auth: 'deep-crawl' },
        { path: '/api/wp/keyword-map', desc: 'Keyword â†’ page mapping + unmapped keywords', auth: 'deep-crawl' },
        { path: '/api/wp/content-scores', desc: 'Freshness + content depth scoring', auth: 'pages' },
        { path: '/api/wp/missing-cities', desc: 'Target cities without landing pages', auth: 'none' },
        { path: '/api/wp/robots', desc: 'Robots.txt parsing', auth: 'none' },
        { path: '/api/wp/sitemap', desc: 'Sitemap.xml recursive parsing', auth: 'none' },
        { path: '/api/wp/security', desc: 'SSL + security headers + server info', auth: 'none' },
        { path: '/api/wp/speed-test', desc: 'Page speed (TTFB + size) per URL', auth: 'pages' },
        { path: '/api/wp/pagespeed?url=URL&strategy=mobile', desc: 'Google PageSpeed Insights (Core Web Vitals)', auth: 'none' },
        { path: '/api/wp/broken-links', desc: 'Broken link detection (404 checker)', auth: 'deep-crawl' },
        { path: '/api/wp/cannibalization', desc: 'Keyword cannibalization detection', auth: 'deep-crawl' },
        { path: '/api/wp/content-gaps', desc: 'Keywords with no matching content', auth: 'deep-crawl' },
        { path: '/api/wp/duplicates', desc: 'Duplicate title/description detection', auth: 'deep-crawl' },
        { path: '/api/wp/heading-audit', desc: 'H1/H2/H3 hierarchy validation', auth: 'deep-crawl' },
        { path: '/api/wp/competitor-crawl', desc: 'Crawl competitor homepages + sitemaps', auth: 'none' },
        { path: '/api/wp/stats', desc: 'Jetpack 30-day summary', auth: 'JETPACK_TOKEN' },
        { path: '/api/wp/stats/top-posts', desc: 'Jetpack top posts by views', auth: 'JETPACK_TOKEN' },
        { path: '/api/wp/stats/search-terms', desc: 'Jetpack search terms', auth: 'JETPACK_TOKEN' },
        { path: '/api/wp/stats/referrers', desc: 'Jetpack referrer sources', auth: 'JETPACK_TOKEN' },
        { path: '/api/wp/stats/country-views', desc: 'Jetpack country/region views', auth: 'JETPACK_TOKEN' }
      ]
    });
  } catch(e) { res.json({ error: e.message }); }
});
// â”€â”€ AI ANALYSIS ENDPOINT â”€â”€
app.post('/api/ai/analyze', requireAuth('owner'), async function(req, res) {
  try {
    var prompt = req.body.prompt || '';
    if(!prompt) return res.json({ error: 'No prompt provided' });
    var result = await askClaude(
      'You are a small engine repair business expansion analyst. Be specific, actionable, and data-driven. Format your response with clear sections.',
      [{ role: 'user', content: prompt }]
    );
    res.json({ reply: result });
  } catch(e) { res.json({ error: e.message }); }
});

app.get('/seo', requireAuth('owner'), async function(req, res) {
  try {
    var D = SEO_CONTENT_DATA;
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>SEO Command Center</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">';
    html += '<style>';
    html += 'body{margin:0;background:#020810;color:#c0d8f0;font-family:Rajdhani,sans-serif;overflow-x:hidden}';
    html += '*{box-sizing:border-box}';
    html += '.nav{display:flex;justify-content:center;gap:8px;padding:15px;flex-wrap:wrap;border-bottom:1px solid #0a1520}';
    html += '.nav a{font-family:Orbitron;font-size:0.65em;letter-spacing:3px;padding:10px 20px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6)}';
    html += '.nav a:hover,.nav a.active{color:#55f7d8;border-color:#55f7d8;background:rgba(85,247,216,0.05)}';
    html += '.header{text-align:center;padding:30px 20px 10px}';
    html += '.header h1{font-family:Orbitron;font-size:1.6em;letter-spacing:8px;color:#55f7d8;margin:0;text-shadow:0 0 30px rgba(85,247,216,0.3)}';
    html += '.header .sub{color:#4a6a8a;font-size:0.85em;margin-top:5px}';
    html += '.container{max-width:1500px;margin:0 auto;padding:20px}';
    // Tabs
    html += '.tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:15px;border-bottom:1px solid #1a2a3a;padding-bottom:8px}';
    html += '.tab{font-family:Orbitron;font-size:0.55em;letter-spacing:2px;padding:8px 16px;color:#4a6a8a;cursor:pointer;border:1px solid transparent;transition:all 0.2s}';
    html += '.tab:hover{color:#c0d8f0;border-color:#1a2a3a}';
    html += '.tab.active{color:#55f7d8;border-color:#55f7d8;background:rgba(85,247,216,0.05)}';
    html += '.tab-panel{display:none}.tab-panel.active{display:block}';
    // Boxes
    html += '.box{background:rgba(10,20,35,0.6);border:1px solid #1a2a3a;padding:15px;margin-bottom:12px}';
    html += '.box-title{font-family:Orbitron;font-size:0.6em;letter-spacing:3px;color:#55f7d8;margin-bottom:10px;display:flex;align-items:center;gap:8px}';
    html += '.dot{width:6px;height:6px;border-radius:50%;display:inline-block}';
    // Stats row
    html += '.stats-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px}';
    html += '.stat{flex:1;min-width:130px;text-align:center;padding:15px;background:rgba(10,20,35,0.8);border:1px solid #1a2a3a}';
    html += '.stat .val{font-size:1.8em;font-weight:900;font-family:Orbitron}';
    html += '.stat .lbl{color:#4a6a8a;font-size:0.7em;font-family:Orbitron;letter-spacing:2px;margin-top:3px}';
    // Table
    html += 'table{width:100%;border-collapse:collapse;font-size:0.9em}';
    html += 'th{font-family:Orbitron;font-size:0.6em;letter-spacing:2px;color:#4a6a8a;text-align:left;padding:8px 10px;border-bottom:1px solid #1a2a3a}';
    html += 'td{padding:8px 10px;border-bottom:1px solid #0a1520}';
    html += 'tr:hover{background:rgba(85,247,216,0.02)}';
    // Tags
    html += '.tag{display:inline-block;padding:2px 8px;font-size:0.7em;font-family:Orbitron;letter-spacing:1px;margin:1px}';
    html += '.tag-green{background:#00ff6615;color:#00ff66;border:1px solid #00ff6630}';
    html += '.tag-orange{background:#ff9f4315;color:#ff9f43;border:1px solid #ff9f4330}';
    html += '.tag-blue{background:#00d4ff15;color:#00d4ff;border:1px solid #00d4ff30}';
    html += '.tag-purple{background:#c084fc15;color:#c084fc;border:1px solid #c084fc30}';
    html += '.tag-red{background:#ff475715;color:#ff4757;border:1px solid #ff475730}';
    html += '.tag-cyan{background:#00d4ff15;color:#00d4ff;border:1px solid #00d4ff30}';
    html += '.tag-gray{background:#4a6a8a15;color:#4a6a8a;border:1px solid #4a6a8a30}';
    // Search
    html += '.search{background:#0a1520;border:1px solid #1a2a3a;color:#c0d8f0;padding:10px 14px;font-family:Rajdhani;font-size:1em;width:100%;outline:none;margin-bottom:10px}';
    html += '.search:focus{border-color:#55f7d8}';
    html += '.wp-btn{padding:6px 14px;cursor:pointer;font-family:Rajdhani;font-size:0.82em;transition:opacity 0.2s}.wp-btn:hover{opacity:0.8}';
    // Progress bar
    html += '.progress{height:6px;background:#0a1520;overflow:hidden;margin:3px 0}';
    html += '.progress-fill{height:100%;transition:width 0.3s}';
    // Expandable
    html += '.expandable{cursor:pointer}.expandable:hover{background:rgba(85,247,216,0.03)}';
    html += '.expand-content{display:none;padding:10px;border-top:1px solid #0a1520}';
    html += '</style></head><body>';

    // Nav
    html += '<div class="nav">';
    html += '<a href="/">JARVIS</a><a href="/athena">ATHENA</a><a href="/tookan">TOOKAN</a>';
    html += '<a href="/business/chart">CHARTS</a><a href="/analytics">ANALYTICS</a>';
    html += '<a href="/google-ads">GOOGLE ADS</a><a href="/square">SQUARE</a>';
    html += '<a href="/discord">DISCORD</a><a href="/followup">FOLLOW UP</a>';
    html += '<a href="/ai">AI</a><a href="/forecast">FORECAST</a>';
    html += '<a href="/seo" class="active">SEO</a><a href="/audit">AUDIT</a>';
    html += '<a href="/auth/logout" style="color:#ef4444;border-color:#ef444440;">LOGOUT</a>';
    html += '</div>';

    html += '<div class="header"><h1>SEO COMMAND CENTER</h1>';
    html += '<div class="sub">Wildwood Small Engine Repair â€” Full SEO Intelligence Dashboard</div>';
    html += '<input class="search" id="globalSearch" placeholder="ðŸ” Search across all tabs... (cities, keywords, domains, anything)" oninput="globalFilter()" style="margin-top:10px;max-width:600px">';
    html += '</div>';

    html += '<div class="container">';

    // â”€â”€ COMPUTE ALL METRICS â”€â”€
    var totalPosts = 0, totalCitations = 0, totalProfiles = 0, totalGuests = 0, liveCitations = 0;
    Object.values(D.gbpPosts || {}).forEach(function(c) { totalPosts += (c.posts || []).length; });
    Object.values(D.offPage || {}).forEach(function(c) {
      (c.citations || []).forEach(function(ci) { totalCitations++; if(ci.status === 'Live') liveCitations++; });
      totalProfiles += (c.profiles || []).length;
      totalGuests += (c.guestPosts || []).length;
    });
    var lp = D.landingPages || [];
    var ap = D.adsPower || {};
    var gmbTotal = ((D.currentGmbs || {}).known || []).length + ((D.currentGmbs || {}).hidden || []).length;
    var ttIssues = (D.titleTags || []).filter(function(t) { return !t.curTitle || t.titleLen > 60 || t.titleLen === 0; }).length;
    var descIssues = (D.titleTags || []).filter(function(t) { return !t.curDesc || t.descLen > 160 || t.descLen === 0; }).length;
    var citRate = totalCitations > 0 ? Math.round((liveCitations / totalCitations) * 100) : 0;
    var gbpFileReady = (D.gbpTracker || []).filter(function(t) { return t.hasFile; }).length;
    var gbpTotal = (D.gbpTracker || []).length;
    var flSetup = ((D.flCities || {}).profiles || []).filter(function(p) { return p.name || p.address; }).length;
    var flTotal = ((D.flCities || {}).profiles || []).length;

    // â”€â”€ GROUPED TAB NAVIGATION â”€â”€
    html += '<div style="margin-bottom:12px">';
    var tabGroups = [
      {name: 'ðŸŽ¯ COMMAND', color: '#55f7d8', tabs: [
        {id:'dashboard', label:'Dashboard'}, {id:'athena', label:'Athena Tasks'}, {id:'launch', label:'City Launch'}, {id:'teamboard', label:'Team Board'}, {id:'calendar', label:'Content Calendar'}
      ]},
      {name: 'ðŸ“ CONTENT', color: '#c084fc', tabs: [
        {id:'pages', label:'Landing Pages'}, {id:'gbp', label:'GBP Posts'}, {id:'sbintel', label:'Snow Blower'}
      ]},
      {name: 'ðŸ”— OFF-PAGE', color: '#ff9f43', tabs: [
        {id:'offpage', label:'Off-Page SEO'}, {id:'cittime', label:'Citation Timeline'}, {id:'analytics', label:'Site Analytics'}
      ]},
      {name: 'ðŸ“ LOCAL SEO', color: '#00ff66', tabs: [
        {id:'cityscores', label:'City Scorecards'}, {id:'gmbs', label:'Current GMBs'}, {id:'gbpprof', label:'GBP Profiles'}, {id:'flcities', label:'FL Expansion'},
        {id:'addrintel', label:'Address Intel'}, {id:'domains', label:'Domains'}, {id:'strat', label:'GMB Strategy'}, {id:'reviews', label:'Reviews'}
      ]},
      {name: 'ðŸ”‘ KEYWORDS', color: '#ffd700', tabs: [
        {id:'kwresearch', label:'Keywords'}, {id:'ranktrack', label:'Rank Tracker'}, {id:'savedkw', label:'Saved KWs'}, {id:'usaudit', label:'US Market'}
      ]},
      {name: 'ðŸ’° REVENUE', color: '#00ff66', tabs: [
        {id:'revenue', label:'Revenue Calculator'}, {id:'marketheat', label:'Market Heat'}
      ]},
      {name: 'âš™ï¸ TECHNICAL', color: '#ff6b9d', tabs: [
        {id:'livesite', label:'Live Site'}, {id:'meta', label:'Meta & On-Page'}, {id:'titletags', label:'Title Tags'}, {id:'auditchk', label:'Audit'}
      ]},
      {name: 'ðŸ—‚ï¸ OPS', color: '#4a6a8a', tabs: [
        {id:'ads', label:'Ads Power'}, {id:'addrs', label:'Addresses'}, {id:'tasks', label:'Tasks'},
        {id:'honey', label:'HoneyBooks'}, {id:'comp', label:'Competitors'}, {id:'tracker', label:'Tracker'}
      ]}
    ];

    tabGroups.forEach(function(g) {
      html += '<div style="margin-bottom:6px">';
      html += '<div style="font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:' + g.color + ';margin-bottom:3px;padding-left:2px">' + g.name + '</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:3px">';
      g.tabs.forEach(function(t, i) {
        var isFirst = g.name === 'ðŸŽ¯ COMMAND' && i === 0;
        html += '<div class="tab' + (isFirst ? ' active' : '') + '" data-group="' + g.name + '" onclick="switchTab(\'' + t.id + '\',this)" style="border-color:' + g.color + '30;font-size:0.7em;padding:5px 10px">' + t.label.toUpperCase() + '</div>';
      });
      html += '</div></div>';
    });
    html += '</div>';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 0: EXECUTIVE DASHBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    html += '<div class="tab-panel active" id="tab-dashboard">';

    // Health Score
    var healthItems = [
      {name:'Citation Live Rate', val: citRate, target: 80},
      {name:'GBP Files Ready', val: gbpTotal > 0 ? Math.round((gbpFileReady/gbpTotal)*100) : 0, target: 100},
      {name:'FL Cities Setup', val: flTotal > 0 ? Math.round((flSetup/flTotal)*100) : 0, target: 100},
      {name:'Title Tags OK', val: (D.titleTags||[]).length > 0 ? Math.round((((D.titleTags||[]).length - ttIssues)/(D.titleTags||[]).length)*100) : 0, target: 90},
      {name:'Meta Desc OK', val: (D.titleTags||[]).length > 0 ? Math.round((((D.titleTags||[]).length - descIssues)/(D.titleTags||[]).length)*100) : 0, target: 90}
    ];
    var avgHealth = Math.round(healthItems.reduce(function(s,h){return s+h.val;},0) / healthItems.length);
    var hColor = avgHealth >= 70 ? '#00ff66' : avgHealth >= 40 ? '#ff9f43' : '#ff4757';

    html += '<div class="box" style="border:1px solid ' + hColor + '30;background:linear-gradient(135deg,rgba(5,10,20,0.9),rgba(10,20,35,0.9))">';
    html += '<div style="display:flex;align-items:center;gap:20px;margin-bottom:15px">';
    html += '<div style="width:80px;height:80px;border-radius:50%;border:4px solid ' + hColor + ';display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-family:Orbitron;font-size:1.8em;color:' + hColor + '">' + avgHealth + '</span></div>';
    html += '<div><div style="font-family:Orbitron;font-size:0.7em;letter-spacing:3px;color:' + hColor + '">SEO HEALTH SCORE</div>';
    html += '<div style="color:#4a6a8a;font-size:0.82em;margin-top:4px">Composite score across citation rates, technical SEO, content readiness, and local setup.</div></div></div>';

    healthItems.forEach(function(h) {
      var pct = h.val;
      var bc = pct >= h.target ? '#00ff66' : pct >= 50 ? '#ff9f43' : '#ff4757';
      html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">';
      html += '<div style="width:140px;font-size:0.82em;color:#c0d8f0">' + h.name + '</div>';
      html += '<div style="flex:1;height:8px;background:#0a1520;border-radius:4px;overflow:hidden"><div style="width:' + pct + '%;height:100%;background:' + bc + ';border-radius:4px"></div></div>';
      html += '<div style="width:40px;text-align:right;font-family:Orbitron;font-size:0.6em;color:' + bc + '">' + pct + '%</div>';
      html += '</div>';
    });
    html += '</div>';

    // Key Metrics Grid
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:12px">';
    var metrics = [
      {val:lp.length, lbl:'LANDING PAGES', c:'#55f7d8'},
      {val:Object.keys(D.gbpPosts||{}).length, lbl:'GBP CITIES', c:'#00ff66'},
      {val:totalPosts, lbl:'GBP POSTS', c:'#c084fc'},
      {val:totalCitations, lbl:'CITATIONS', c:'#ff9f43'},
      {val:liveCitations, lbl:'LIVE CITATIONS', c:'#00ff66'},
      {val:totalProfiles, lbl:'PROFILES', c:'#00d4ff'},
      {val:totalGuests, lbl:'GUEST POSTS', c:'#ff6b9d'},
      {val:Object.keys(D.offPage||{}).length, lbl:'OFF-PAGE CITIES', c:'#ff9f43'},
      {val:gmbTotal, lbl:'ACTIVE GMBs', c:'#00ff66'},
      {val:(D.domainSelection||[]).length, lbl:'EMD DOMAINS', c:'#c084fc'},
      {val:((D.flCities||{}).cities||[]).length, lbl:'FL CITIES', c:'#ff6b9d'},
      {val:(D.gbpProfiles||[]).length, lbl:'GBP PROFILES', c:'#00d4ff'},
      {val:(D.usAudit||[]).length, lbl:'STATES AUDITED', c:'#55f7d8'},
      {val:(D.titleTags||[]).length, lbl:'TITLE TAGS', c:'#ffd700'},
      {val:(D.savedKeywords||[]).length, lbl:'TRACKED KWs', c:'#00ff66'},
      {val:(D.sitePages||[]).length, lbl:'SITE PAGES', c:'#c0d8f0'}
    ];
    metrics.forEach(function(m) {
      html += '<div class="box" style="text-align:center;padding:12px 8px;margin:0"><div style="font-family:Orbitron;font-size:1.3em;color:' + m.c + '">' + m.val + '</div><div style="font-size:0.7em;color:#4a6a8a;letter-spacing:1px">' + m.lbl + '</div></div>';
    });
    html += '</div>';

    // Off-Page Progress Bars by City
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>OFF-PAGE PROGRESS BY CITY</div>';
    Object.keys(D.offPage || {}).forEach(function(city) {
      var o = D.offPage[city];
      var citCount = (o.citations || []).length;
      var liveCount = (o.citations || []).filter(function(c){return c.status === 'Live';}).length;
      var pct = citCount > 0 ? Math.round((liveCount/citCount)*100) : 0;
      var bc = pct >= 50 ? '#00ff66' : pct >= 20 ? '#ff9f43' : '#ff4757';
      html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px">';
      html += '<div style="width:160px;font-size:0.82em;color:#c0d8f0;white-space:nowrap;overflow:hidden">' + city + '</div>';
      html += '<div style="flex:1;height:6px;background:#0a1520;border-radius:3px;overflow:hidden"><div style="width:' + pct + '%;height:100%;background:' + bc + ';border-radius:3px"></div></div>';
      html += '<div style="width:80px;text-align:right;font-size:0.75em;color:' + bc + '">' + liveCount + '/' + citCount + ' (' + pct + '%)</div>';
      html += '</div>';
    });
    html += '</div>';

    // Top Performing Queries
    var tQ = ((D.wwserData || {}).topQueries || []).slice(0, 8);
    if(tQ.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>TOP SEARCH QUERIES (GSC)</div>';
      tQ.forEach(function(q) {
        var maxClicks = tQ[0].clicks || 1;
        var barW = Math.round((q.clicks / maxClicks) * 100);
        html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
        html += '<div style="width:250px;font-size:0.82em;color:#c0d8f0;white-space:nowrap;overflow:hidden">' + q.query + '</div>';
        html += '<div style="flex:1;height:6px;background:#0a1520;border-radius:3px;overflow:hidden"><div style="width:' + barW + '%;height:100%;background:#55f7d8;border-radius:3px"></div></div>';
        html += '<div style="width:60px;text-align:right;font-size:0.75em;color:#55f7d8;font-weight:700">' + q.clicks + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Action Items Summary
    html += '<div class="box" style="border-left:3px solid #ff4757">';
    html += '<div class="box-title"><span class="dot" style="background:#ff4757"></span>âš¡ NEEDS ATTENTION</div>';
    var actions = [];
    if(ttIssues > 0) actions.push({text: ttIssues + ' pages with title tag issues (missing or >60 chars)', priority: 'HIGH', tab: 'titletags'});
    if(descIssues > 0) actions.push({text: descIssues + ' pages missing or broken meta descriptions', priority: 'HIGH', tab: 'titletags'});
    if(citRate < 50) actions.push({text: 'Citation live rate is only ' + citRate + '% â€” target 80%+', priority: 'HIGH', tab: 'offpage'});
    if(flSetup < flTotal) actions.push({text: (flTotal - flSetup) + ' FL cities still pending GBP setup', priority: 'MEDIUM', tab: 'flcities'});
    if(gbpFileReady < gbpTotal) actions.push({text: (gbpTotal - gbpFileReady) + ' GBP tracker items still need files', priority: 'MEDIUM', tab: 'tracker'});
    var noOffPage = ((D.flCities||{}).cities||[]).filter(function(c){return !D.offPage[c.city+', FL'] && !D.offPage[c.city];}).length;
    if(noOffPage > 0) actions.push({text: noOffPage + ' FL cities without off-page campaigns started', priority: 'MEDIUM', tab: 'flcities'});
    actions.forEach(function(a) {
      var pc = a.priority === 'HIGH' ? '#ff4757' : '#ff9f43';
      html += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #0a1520;cursor:pointer" onclick="switchTab(\'' + a.tab + '\',null)">';
      html += '<span class="tag" style="background:' + pc + '20;color:' + pc + ';border:1px solid ' + pc + '30;font-size:0.75em;min-width:50px;text-align:center">' + a.priority + '</span>';
      html += '<span style="color:#c0d8f0;font-size:0.85em">' + a.text + '</span>';
      html += '</div>';
    });
    if(actions.length === 0) html += '<div style="color:#00ff66;font-size:0.85em">âœ“ All clear â€” no critical issues detected.</div>';
    html += '</div>';
    html += '</div>';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB: ATHENA COMMAND CENTER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    html += '<div class="tab-panel" id="tab-athena">';
    // Athena Voice Chat Button on Dashboard
    html += '<div style="text-align:center;margin:20px 0 30px;">';
    html += '<div onclick="toggleDashAthenaVoice()" id="dash-athena-voice-btn" style="cursor:pointer;display:inline-block;padding:16px 40px;border:1px solid #a855f740;background:rgba(168,85,247,0.08);color:#a855f7;font-family:Orbitron,sans-serif;font-size:0.8em;letter-spacing:4px;transition:all 0.3s;"><span style="margin-right:8px;">ðŸŽ™</span>TALK TO ATHENA</div>';
    html += '</div>';
    html += '<div id="dash-athena-voice-panel" style="display:none;max-width:800px;margin:0 auto 30px;padding:0 20px;">';
    html += '<div style="background:rgba(10,12,25,0.9);border:1px solid #a855f730;padding:30px;position:relative;overflow:hidden;">';
    html += '<div style="text-align:center;margin-bottom:20px;"><div id="dash-athena-status" style="font-family:Orbitron,sans-serif;font-size:0.7em;letter-spacing:4px;color:#4a6a8a;">CLICK MIC TO SPEAK</div></div>';
    html += '<div style="text-align:center;margin-bottom:20px;"><div id="dash-athena-mic" onclick="toggleDashAthenaListening()" style="width:80px;height:80px;border-radius:50%;border:2px solid #a855f740;background:rgba(168,85,247,0.05);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s;"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div></div>';
    html += '<div style="display:flex;gap:10px;margin-bottom:20px;"><input id="dash-athena-input" type="text" placeholder="Or type your question..." style="flex:1;padding:12px 16px;background:rgba(10,20,35,0.8);border:1px solid #a855f730;color:#c0d8f0;font-family:Rajdhani,sans-serif;font-size:1em;outline:none;" onkeypress="if(event.key===&apos;Enter&apos;)sendDashAthenaText()"><button onclick="sendDashAthenaText()" style="padding:12px 20px;background:rgba(168,85,247,0.15);border:1px solid #a855f750;color:#a855f7;font-family:Orbitron,sans-serif;font-size:0.7em;letter-spacing:3px;cursor:pointer;">SEND</button></div>';
    html += '<div id="dash-athena-log" style="max-height:400px;overflow-y:auto;font-size:0.95em;"></div>';
    html += '</div></div>';
    html += '<script>';
    html += 'var dashAthenaOpen=false,dashAthenaListening=false,dashAthenaRecog=null,dashAthenaSession="da"+Date.now();';
    html += 'function toggleDashAthenaVoice(){dashAthenaOpen=!dashAthenaOpen;document.getElementById("dash-athena-voice-panel").style.display=dashAthenaOpen?"block":"none";var b=document.getElementById("dash-athena-voice-btn");b.style.borderColor=dashAthenaOpen?"#ff4757":"#a855f740";b.style.color=dashAthenaOpen?"#ff4757":"#a855f7";if(!dashAthenaOpen&&dashAthenaListening){dashAthenaListening=false;if(dashAthenaRecog)try{dashAthenaRecog.stop();}catch(e){}}}';
    html += 'function toggleDashAthenaListening(){if(dashAthenaListening){dashAthenaListening=false;if(dashAthenaRecog)try{dashAthenaRecog.stop();}catch(e){}document.getElementById("dash-athena-mic").style.borderColor="#a855f740";document.getElementById("dash-athena-mic").style.boxShadow="none";document.getElementById("dash-athena-status").textContent="CLICK MIC TO SPEAK";return;}if(!("webkitSpeechRecognition" in window)&&!("SpeechRecognition" in window)){alert("Speech not supported");return;}var SR=window.SpeechRecognition||window.webkitSpeechRecognition;dashAthenaRecog=new SR();dashAthenaRecog.continuous=false;dashAthenaRecog.interimResults=false;dashAthenaRecog.onstart=function(){dashAthenaListening=true;document.getElementById("dash-athena-mic").style.borderColor="#a855f7";document.getElementById("dash-athena-mic").style.boxShadow="0 0 40px rgba(168,85,247,0.3)";document.getElementById("dash-athena-status").textContent="LISTENING...";document.getElementById("dash-athena-status").style.color="#a855f7";};dashAthenaRecog.onresult=function(e){var t=e.results[0][0].transcript;dashAthenaListening=false;document.getElementById("dash-athena-mic").style.borderColor="#a855f740";document.getElementById("dash-athena-mic").style.boxShadow="none";processDashAthena(t);};dashAthenaRecog.onerror=function(e){dashAthenaListening=false;document.getElementById("dash-athena-mic").style.borderColor="#a855f740";document.getElementById("dash-athena-status").textContent="ERROR: "+e.error;document.getElementById("dash-athena-status").style.color="#ff4757";};dashAthenaRecog.onend=function(){dashAthenaListening=false;};dashAthenaRecog.start();}';
    html += 'function sendDashAthenaText(){var i=document.getElementById("dash-athena-input");if(i.value.trim()){processDashAthena(i.value.trim());i.value="";}}';
    html += 'function processDashAthena(msg){var log=document.getElementById("dash-athena-log");log.innerHTML+="<div style=\"margin:12px 0\"><div style=\"color:#c084fc;font-family:Orbitron,sans-serif;font-size:0.65em;letter-spacing:3px;margin-bottom:4px\">YOU</div><div style=\"color:#c0d8f0\">"+msg+"</div></div>";document.getElementById("dash-athena-status").textContent="ATHENA PROCESSING...";document.getElementById("dash-athena-status").style.color="#c084fc";fetch("/chat/athena",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg,sessionId:dashAthenaSession})}).then(function(r){return r.json();}).then(function(d){var resp=d.response||d.error||"No response";log.innerHTML+="<div style=\"margin:12px 0\"><div style=\"color:#a855f7;font-family:Orbitron,sans-serif;font-size:0.65em;letter-spacing:3px;margin-bottom:4px\">ATHENA</div><div style=\"color:#e0e8f0\">"+resp+"</div></div>";log.scrollTop=log.scrollHeight;document.getElementById("dash-athena-status").textContent="CLICK MIC TO SPEAK";document.getElementById("dash-athena-status").style.color="#4a6a8a";}).catch(function(e){log.innerHTML+="<div style=\"color:#ff4757;margin:8px 0\">Error: "+e.message+"</div>";document.getElementById("dash-athena-status").textContent="ERROR";document.getElementById("dash-athena-status").style.color="#ff4757";});}';
    html += '<\/script>';

    html += '<div class="box" style="border:1px solid #c084fc30;background:linear-gradient(135deg,rgba(5,10,20,0.9),rgba(15,10,30,0.9))">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>ATHENA â€” SEO TASK GENERATOR</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.7;padding:8px">';
    html += 'Athena reads ALL dashboard data and generates prioritized tasks for the SEO team. Tasks are organized by urgency and assigned based on the data gaps and opportunities detected.';
    html += '</div></div>';

    // Generate tasks from data
    var athenaTasks = [];
    // OFF-PAGE TASKS
    Object.keys(D.offPage || {}).forEach(function(city) {
      var o = D.offPage[city];
      var citLive = (o.citations||[]).filter(function(c){return c.status==='Live';}).length;
      var citTotal = (o.citations||[]).length;
      var profLive = (o.profiles||[]).filter(function(c){return c.status==='Live';}).length;
      var gpLive = (o.guestPosts||[]).filter(function(c){return c.status==='Live';}).length;
      if(citLive < citTotal * 0.5) athenaTasks.push({cat:'OFF-PAGE', priority: citLive < citTotal*0.2 ? 'CRITICAL' : 'HIGH', city: city, task: 'Follow up on ' + (citTotal-citLive) + ' pending citations (' + citLive + '/' + citTotal + ' live)', assignee: 'Citation Team'});
      if(profLive === 0 && (o.profiles||[]).length > 0) athenaTasks.push({cat:'OFF-PAGE', priority:'HIGH', city: city, task: 'Create ' + (o.profiles||[]).length + ' profile listings (0 live)', assignee: 'Profile Team'});
      if(gpLive === 0 && (o.guestPosts||[]).length > 0) athenaTasks.push({cat:'OFF-PAGE', priority:'MEDIUM', city: city, task: 'Publish ' + (o.guestPosts||[]).length + ' guest posts (0 live)', assignee: 'Content Team'});
    });
    // TECHNICAL TASKS
    if(ttIssues > 0) athenaTasks.push({cat:'TECHNICAL', priority:'HIGH', city:'All', task: 'Fix ' + ttIssues + ' title tags that are missing or over 60 characters', assignee: 'Dev Team'});
    if(descIssues > 0) athenaTasks.push({cat:'TECHNICAL', priority:'HIGH', city:'All', task: 'Fix ' + descIssues + ' meta descriptions that are missing or over 160 characters', assignee: 'Dev Team'});
    // FL EXPANSION TASKS
    ((D.flCities||{}).profiles||[]).forEach(function(p) {
      if(!p.name && !p.address) athenaTasks.push({cat:'FL EXPANSION', priority:'MEDIUM', city: p.city, task: 'Complete GBP setup â€” missing business name & address', assignee: 'Local SEO Team'});
      if(!p.website) athenaTasks.push({cat:'FL EXPANSION', priority:'MEDIUM', city: p.city, task: 'Build EMD website & connect to GBP listing', assignee: 'Web Team'});
    });
    // GBP TASKS
    (D.gbpTracker||[]).forEach(function(t) {
      if(!t.hasFile) athenaTasks.push({cat:'GBP TRACKER', priority:'LOW', city:'All', task: 'Create file for: ' + t.item, assignee: 'Content Team'});
    });

    // Sort by priority
    var priOrder = {CRITICAL:0, HIGH:1, MEDIUM:2, LOW:3};
    athenaTasks.sort(function(a,b){return (priOrder[a.priority]||9) - (priOrder[b.priority]||9);});

    // Task stats
    var critCount = athenaTasks.filter(function(t){return t.priority==='CRITICAL';}).length;
    var highCount = athenaTasks.filter(function(t){return t.priority==='HIGH';}).length;
    var medCount = athenaTasks.filter(function(t){return t.priority==='MEDIUM';}).length;
    var lowCount = athenaTasks.filter(function(t){return t.priority==='LOW';}).length;

    html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px">';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0;border-left:3px solid #ff4757"><div style="font-family:Orbitron;font-size:1.5em;color:#ff4757">' + critCount + '</div><div style="font-size:0.7em;color:#4a6a8a">CRITICAL</div></div>';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0;border-left:3px solid #ff9f43"><div style="font-family:Orbitron;font-size:1.5em;color:#ff9f43">' + highCount + '</div><div style="font-size:0.7em;color:#4a6a8a">HIGH</div></div>';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0;border-left:3px solid #ffd700"><div style="font-family:Orbitron;font-size:1.5em;color:#ffd700">' + medCount + '</div><div style="font-size:0.7em;color:#4a6a8a">MEDIUM</div></div>';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0;border-left:3px solid #00ff66"><div style="font-family:Orbitron;font-size:1.5em;color:#00ff66">' + lowCount + '</div><div style="font-size:0.7em;color:#4a6a8a">LOW</div></div>';
    html += '</div>';

    // Task categories
    var cats = {};
    athenaTasks.forEach(function(t) {
      if(!cats[t.cat]) cats[t.cat] = [];
      cats[t.cat].push(t);
    });

    Object.keys(cats).forEach(function(cat) {
      var tasks = cats[cat];
      var catColor = cat === 'OFF-PAGE' ? '#ff9f43' : cat === 'TECHNICAL' ? '#ff6b9d' : cat === 'FL EXPANSION' ? '#00ff66' : cat === 'GBP TRACKER' ? '#c084fc' : '#55f7d8';
      html += '<div class="box" style="border-left:3px solid ' + catColor + '">';
      html += '<div class="box-title"><span class="dot" style="background:' + catColor + '"></span>' + cat + ' (' + tasks.length + ' TASKS)</div>';
      html += '<table><thead><tr><th>PRI</th><th>CITY</th><th>TASK</th><th>ASSIGN TO</th></tr></thead><tbody>';
      tasks.forEach(function(t) {
        var pc = t.priority === 'CRITICAL' ? '#ff4757' : t.priority === 'HIGH' ? '#ff9f43' : t.priority === 'MEDIUM' ? '#ffd700' : '#00ff66';
        var ptag = t.priority === 'CRITICAL' ? 'tag-red' : t.priority === 'HIGH' ? 'tag-orange' : t.priority === 'MEDIUM' ? 'tag-orange' : 'tag-green';
        html += '<tr>';
        html += '<td><span class="tag ' + ptag + '" style="font-size:0.75em">' + t.priority + '</span></td>';
        html += '<td style="color:#c0d8f0;font-size:0.82em;white-space:nowrap">' + t.city + '</td>';
        html += '<td style="color:#c0d8f0;font-size:0.82em">' + t.task + '</td>';
        html += '<td style="color:' + catColor + ';font-size:0.78em;white-space:nowrap">' + t.assignee + '</td>';
        html += '</tr>';
      });
      html += '</tbody></table></div>';
    });

    // Strategy briefing for Athena
    html += '<div class="box" style="border:1px solid #c084fc30">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>ðŸ“‹ ATHENA STRATEGY BRIEFING</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.8;padding:8px">';
    html += '<span style="color:#55f7d8;font-weight:700">Current State:</span> ' + Object.keys(D.offPage||{}).length + ' cities with active off-page campaigns, ' + liveCitations + '/' + totalCitations + ' citations live (' + citRate + '%), ' + totalProfiles + ' profiles created, ' + totalGuests + ' guest posts in pipeline.<br>';
    html += '<span style="color:#55f7d8;font-weight:700">Florida Push:</span> ' + flSetup + '/' + flTotal + ' FL cities have GBP profiles set up. ' + (D.domainSelection||[]).length + ' EMD domains secured. 3-phase approval strategy in progress.<br>';
    html += '<span style="color:#55f7d8;font-weight:700">Website Health:</span> ' + (D.sitePages||[]).length + ' pages indexed, ' + ttIssues + ' title tag issues, ' + descIssues + ' meta description issues. Top page gets ' + (((D.wwserData||{}).webTraffic||[])[0]||{clicks:0}).clicks + ' clicks/6mo.<br>';
    html += '<span style="color:#55f7d8;font-weight:700">Top Query:</span> "' + (((D.wwserData||{}).topQueries||[])[0]||{query:'n/a'}).query + '" â€” ' + (((D.wwserData||{}).topQueries||[])[0]||{clicks:0}).clicks + ' clicks, ' + (((D.wwserData||{}).topQueries||[])[0]||{impressions:0}).impressions + ' impressions.<br>';
    html += '<span style="color:#55f7d8;font-weight:700">Market Intel:</span> ' + (D.usAudit||[]).length + ' states audited covering 1,380+ cities. Snow blower keyword data for ' + Object.keys(D.snowBlowerKeywords||{}).length + ' cities. Season starts as early as Sept (Fairbanks) through Nov.<br>';
    html += '<span style="color:#ff4757;font-weight:700">Priority Actions:</span> (1) Push citation live rates above 50% across all cities. (2) Complete FL city GBP setups. (3) Fix ' + ttIssues + ' title tag issues. (4) Launch off-page for remaining FL cities.';
    html += '</div></div>';
    html += '</div>';

    // ========== TAB 1: LANDING PAGES ==========
    html += '<div class="tab-panel" id="tab-pages">';
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>SNOW BLOWER LANDING PAGES (' + lp.length + ')</div>';
    html += '<table><thead><tr><th>CITY</th><th>MAIN KEYWORD</th><th>META TITLE</th><th>WORDS</th><th>TYPE</th></tr></thead><tbody>';
    lp.forEach(function(p) {
      var wcColor = p.wordCount > 1200 ? '#00ff66' : p.wordCount > 800 ? '#ff9f43' : '#ff4757';
      html += '<tr>';
      html += '<td style="color:#c0d8f0;font-weight:700">' + p.city + '</td>';
      html += '<td style="color:#c084fc;font-size:0.85em">' + (p.mainKeyword || 'â€”') + '</td>';
      html += '<td style="color:#4a6a8a;font-size:0.85em">' + (p.metaTitle || 'â€”') + '</td>';
      html += '<td style="color:' + wcColor + ';font-weight:700">' + p.wordCount + '</td>';
      html += '<td><span class="tag tag-blue">' + p.serviceType + '</span></td>';
      html += '</tr>';
      if (p.metaDesc) {
        html += '<tr><td colspan="5" style="color:#4a6a8a;font-size:0.8em;padding:2px 10px 8px 40px">ðŸ“ ' + p.metaDesc + '</td></tr>';
      }
    });
    html += '</tbody></table></div>';
    // Avg stats
    var avgWc = lp.length > 0 ? Math.round(lp.reduce(function(s, p) { return s + p.wordCount; }, 0) / lp.length) : 0;
    html += '<div style="color:#4a6a8a;font-size:0.85em;margin-top:5px">Average word count: <span style="color:#55f7d8;font-weight:700">' + avgWc + '</span> Â· All pages are snow blower repair focused with location-specific SEO targeting</div>';
    html += '</div>';

    // ========== TAB 2: GBP POSTS ==========
    html += '<div class="tab-panel" id="tab-gbp">';
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>GOOGLE BUSINESS PROFILE POSTS</div>';
    html += '<input class="search" id="gbpSearch" placeholder="Search cities or post titles..." oninput="filterGBP()">';
    
    Object.keys(D.gbpPosts || {}).forEach(function(city) {
      var c = D.gbpPosts[city];
      var published = (c.posts || []).filter(function(p) { return p.status === 'Published'; }).length;
      var total = (c.posts || []).length;
      var pct = total > 0 ? Math.round((published / total) * 100) : 0;
      
      html += '<div class="gbp-city" data-city="' + city.toLowerCase() + '" style="margin-bottom:10px;border:1px solid #1a2a3a;background:rgba(10,20,35,0.4)">';
      html += '<div class="expandable" onclick="toggleExpand(this)" style="padding:12px;display:flex;justify-content:space-between;align-items:center">';
      html += '<div><span style="color:#c0d8f0;font-weight:700;font-size:1.05em">' + city + '</span>';
      if (c.coords) html += ' <span style="color:#4a6a8a;font-size:0.75em">ðŸ“ ' + c.coords + '</span>';
      html += '</div>';
      html += '<div style="display:flex;gap:8px;align-items:center">';
      html += '<span class="tag ' + (pct === 100 ? 'tag-green' : pct > 50 ? 'tag-orange' : 'tag-red') + '">' + published + '/' + total + ' PUBLISHED</span>';
      html += '<div style="width:80px"><div class="progress"><div class="progress-fill" style="width:' + pct + '%;background:' + (pct === 100 ? '#00ff66' : '#ff9f43') + '"></div></div></div>';
      html += '<span style="color:#4a6a8a;font-size:1.2em">â–¾</span>';
      html += '</div></div>';
      
      html += '<div class="expand-content">';
      if (c.gbpLink) html += '<div style="margin-bottom:6px"><a href="' + c.gbpLink + '" target="_blank" style="color:#00d4ff;font-size:0.8em;text-decoration:none">ðŸ”— GBP Profile Link</a></div>';
      html += '<table><thead><tr><th>WEEK</th><th>TITLE</th><th>CTA</th><th>STATUS</th></tr></thead><tbody>';
      (c.posts || []).forEach(function(p) {
        var stColor = p.status === 'Published' ? '#00ff66' : '#ff9f43';
        html += '<tr><td style="color:#4a6a8a;white-space:nowrap">' + p.week + '</td>';
        html += '<td style="color:#c0d8f0" title="' + (p.body || '').replace(/"/g, '&quot;') + '">' + p.title + '</td>';
        html += '<td><span class="tag tag-blue">' + (p.cta || '') + '</span></td>';
        html += '<td style="color:' + stColor + ';font-weight:600">' + p.status + '</td></tr>';
      });
      html += '</tbody></table></div></div>';
    });
    html += '</div></div>';

    // ========== TAB 3: OFF-PAGE SEO ==========
    html += '<div class="tab-panel" id="tab-offpage">';
    
    Object.keys(D.offPage || {}).forEach(function(city) {
      var c = D.offPage[city];
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>' + city.toUpperCase() + ' â€” OFF-PAGE SEO</div>';
      html += '<div style="color:#4a6a8a;font-size:0.85em;margin-bottom:8px">Business: <span style="color:#c0d8f0">' + (c.name || '') + '</span> Â· Phone: <span style="color:#00d4ff">' + (c.phone || '') + '</span></div>';
      
      // Stats
      var cPending = (c.citations || []).filter(function(x) { return x.status && x.status.indexOf('Pending') >= 0; }).length;
      var pLive = (c.profiles || []).filter(function(x) { return x.link && x.link !== 'None'; }).length;
      html += '<div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">';
      html += '<div class="stat" style="padding:10px"><div class="val" style="color:#ff9f43;font-size:1.3em">' + (c.citations || []).length + '</div><div class="lbl">CITATIONS</div></div>';
      html += '<div class="stat" style="padding:10px"><div class="val" style="color:#00d4ff;font-size:1.3em">' + (c.profiles || []).length + '</div><div class="lbl">PROFILES</div></div>';
      html += '<div class="stat" style="padding:10px"><div class="val" style="color:#c084fc;font-size:1.3em">' + (c.guestPosts || []).length + '</div><div class="lbl">GUEST POSTS</div></div>';
      html += '<div class="stat" style="padding:10px"><div class="val" style="color:#ffd700;font-size:1.3em">' + cPending + '</div><div class="lbl">PENDING</div></div>';
      html += '</div>';
      
      // Citations table
      if ((c.citations || []).length > 0) {
        html += '<div class="expandable" onclick="toggleExpand(this)" style="padding:8px;border:1px solid #1a2a3a;margin-bottom:6px">';
        html += '<span style="color:#ff9f43;font-family:Orbitron;font-size:0.6em;letter-spacing:2px">ðŸ“‹ LOCAL CITATIONS (' + c.citations.length + ')</span> <span style="color:#4a6a8a">â–¾</span></div>';
        html += '<div class="expand-content" style="max-height:400px;overflow-y:auto">';
        html += '<table><thead><tr><th>DOMAIN</th><th>LIVE LINK</th><th>STATUS</th></tr></thead><tbody>';
        (c.citations || []).forEach(function(ci) {
          var stTag = ci.status && ci.status.indexOf('Pending') >= 0 ? 'tag-orange' : ci.link ? 'tag-green' : 'tag-gray';
          html += '<tr><td style="color:#4a6a8a;font-size:0.85em">' + ci.domain + '</td>';
          html += '<td>' + (ci.link ? '<a href="' + ci.link + '" target="_blank" style="color:#00d4ff;font-size:0.8em;text-decoration:none">' + ci.link.substring(0, 60) + '...</a>' : 'â€”') + '</td>';
          html += '<td><span class="tag ' + stTag + '">' + (ci.status || 'Live') + '</span></td></tr>';
        });
        html += '</tbody></table></div>';
      }
      
      // Profiles table
      if ((c.profiles || []).length > 0) {
        html += '<div class="expandable" onclick="toggleExpand(this)" style="padding:8px;border:1px solid #1a2a3a;margin-bottom:6px;margin-top:8px">';
        html += '<span style="color:#00d4ff;font-family:Orbitron;font-size:0.6em;letter-spacing:2px">ðŸ‘¤ PROFILE CREATION (' + c.profiles.length + ')</span> <span style="color:#4a6a8a">â–¾</span></div>';
        html += '<div class="expand-content" style="max-height:400px;overflow-y:auto">';
        html += '<table><thead><tr><th>DOMAIN</th><th>LIVE LINK</th><th>STATUS</th></tr></thead><tbody>';
        (c.profiles || []).forEach(function(pr) {
          html += '<tr><td style="color:#4a6a8a;font-size:0.85em">' + pr.domain + '</td>';
          html += '<td>' + (pr.link ? '<a href="' + pr.link + '" target="_blank" style="color:#00d4ff;font-size:0.8em;text-decoration:none">' + pr.link.substring(0, 60) + '...</a>' : 'â€”') + '</td>';
          html += '<td><span class="tag ' + (pr.status ? 'tag-orange' : 'tag-green') + '">' + (pr.status || 'Live') + '</span></td></tr>';
        });
        html += '</tbody></table></div>';
      }
      
      // Guest posts table
      if ((c.guestPosts || []).length > 0) {
        html += '<div class="expandable" onclick="toggleExpand(this)" style="padding:8px;border:1px solid #1a2a3a;margin-top:8px">';
        html += '<span style="color:#c084fc;font-family:Orbitron;font-size:0.6em;letter-spacing:2px">âœï¸ GUEST POSTS (' + c.guestPosts.length + ')</span> <span style="color:#4a6a8a">â–¾</span></div>';
        html += '<div class="expand-content" style="max-height:400px;overflow-y:auto">';
        html += '<table><thead><tr><th>DOMAIN</th><th>LIVE LINK</th><th>STATUS</th></tr></thead><tbody>';
        (c.guestPosts || []).forEach(function(gp) {
          html += '<tr><td style="color:#4a6a8a;font-size:0.85em">' + gp.domain + '</td>';
          html += '<td>' + (gp.link ? '<a href="' + gp.link + '" target="_blank" style="color:#c084fc;font-size:0.8em;text-decoration:none">' + gp.link.substring(0, 60) + '...</a>' : 'â€”') + '</td>';
          html += '<td><span class="tag ' + (gp.status ? 'tag-orange' : 'tag-green') + '">' + (gp.status || 'Live') + '</span></td></tr>';
        });
        html += '</tbody></table></div>';
      }
      
      html += '</div>';
    });
    html += '</div>';

    // ========== TAB 4: ADS POWER ==========
    html += '<div class="tab-panel" id="tab-ads">';
    
    // Cities + Proxies
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>PROXY CITY ASSIGNMENTS (' + (ap.cities || []).length + ')</div>';
    html += '<table><thead><tr><th>CITY</th><th>PROXY</th><th>REASON</th></tr></thead><tbody>';
    (ap.cities || []).forEach(function(c) {
      html += '<tr><td style="color:#c0d8f0;font-weight:600">' + c.city + '</td>';
      html += '<td style="color:#ffd700">' + c.proxy + '</td>';
      html += '<td style="color:#4a6a8a;font-size:0.85em">' + c.reason + '</td></tr>';
    });
    html += '</tbody></table></div>';
    
    // Local Guides
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>LOCAL GUIDES (' + (ap.localGuides || []).length + ')</div>';
    html += '<table><thead><tr><th>CITY</th><th>EMAIL</th><th>PROGRESS</th><th>LEVEL 5+</th></tr></thead><tbody>';
    (ap.localGuides || []).forEach(function(g) {
      var isL5 = g.level5 === 'Yes';
      html += '<tr><td style="color:#c0d8f0;font-weight:600">' + g.city + '</td>';
      html += '<td style="color:#4a6a8a;font-size:0.85em">' + g.email + '</td>';
      html += '<td style="color:#c084fc">' + g.progress + '</td>';
      html += '<td><span class="tag ' + (isL5 ? 'tag-green' : 'tag-red') + '">' + (isL5 ? 'âœ… YES' : 'âŒ NO') + '</span></td></tr>';
    });
    html += '</tbody></table></div>';
    
    // Tracking Numbers
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00d4ff"></span>TRACKING NUMBERS (' + (ap.numbers || []).length + ')</div>';
    html += '<input class="search" id="numSearch" placeholder="Search numbers..." oninput="filterNums()">';
    html += '<div id="numTable"><table><thead><tr><th>NAME</th><th>NUMBER</th><th>FORWARDS TO</th></tr></thead><tbody>';
    (ap.numbers || []).forEach(function(n) {
      html += '<tr class="num-row" data-search="' + (n.name + ' ' + n.number).toLowerCase() + '"><td style="color:#c0d8f0">' + n.name + '</td>';
      html += '<td style="color:#00d4ff;font-weight:600">' + n.number + '</td>';
      html += '<td style="color:#4a6a8a;font-size:0.85em">' + n.forward + '</td></tr>';
    });
    html += '</tbody></table></div></div>';
    
    // GBP Gmails
    if ((ap.gbpGmails || []).length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>GBP GMAIL ACCOUNTS (' + ap.gbpGmails.length + ')</div>';
      html += '<table><thead><tr><th>CITY</th><th>EMAIL</th></tr></thead><tbody>';
      (ap.gbpGmails || []).forEach(function(g) {
        html += '<tr><td style="color:#c0d8f0;font-weight:600">' + g.city + '</td>';
        html += '<td style="color:#4a6a8a">' + g.email + '</td></tr>';
      });
      html += '</tbody></table></div>';
    }
    html += '</div>';

    // ========== TAB 5: ADDRESSES ==========
    html += '<div class="tab-panel" id="tab-addrs">';
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>FLORIDA BUSINESS ADDRESSES</div>';
    (D.addresses || []).forEach(function(a) {
      html += '<div style="padding:12px;border:1px solid #1a2a3a;margin-bottom:8px;background:rgba(10,20,35,0.4)">';
      html += '<div style="color:#c0d8f0;font-weight:700;font-size:1.1em">' + a.city + '</div>';
      html += '<div style="color:#00d4ff;font-size:0.9em;margin-top:3px">ðŸ“ ' + (a.address || 'â€”') + '</div>';
      if (a.areas && a.areas.length > 0) {
        html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">';
        a.areas.forEach(function(ar) {
          html += '<span class="tag tag-gray">' + ar + '</span>';
        });
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div></div>';

    // ========== TAB 6: TEAM TASKS ==========
    html += '<div class="tab-panel" id="tab-tasks">';
    
    Object.keys(D.tasks || {}).forEach(function(member) {
      var tasks = D.tasks[member] || [];
      var done = tasks.filter(function(t) { return t.done; }).length;
      var pct = tasks.length > 0 ? Math.round((done / tasks.length) * 100) : 0;
      
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>' + member.toUpperCase() + ' <span style="color:#' + (pct === 100 ? '00ff66' : 'ff9f43') + '">' + done + '/' + tasks.length + ' (' + pct + '%)</span></div>';
      html += '<div class="progress" style="margin-bottom:10px"><div class="progress-fill" style="width:' + pct + '%;background:' + (pct === 100 ? '#00ff66' : pct > 50 ? '#ff9f43' : '#ff4757') + '"></div></div>';
      html += '<table><thead><tr><th>PHASE</th><th>ACTIVITY</th><th>TASK</th><th>DONE</th></tr></thead><tbody>';
      tasks.forEach(function(t) {
        html += '<tr><td style="color:#4a6a8a;white-space:nowrap">' + t.phase + '</td>';
        html += '<td style="color:#c084fc;font-size:0.85em">' + t.activity + '</td>';
        html += '<td style="color:#c0d8f0">' + t.task + '</td>';
        html += '<td style="color:' + (t.done ? '#00ff66' : '#4a6a8a') + ';font-size:1.2em">' + (t.done ? 'â˜‘' : 'â˜') + '</td></tr>';
      });
      html += '</tbody></table></div>';
    });
    html += '</div>';

    // ========== TAB 7: HONEYBOOKS ==========
    html += '<div class="tab-panel" id="tab-honey">';
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>HONEYBOOK EMAIL TEMPLATES (' + (D.honeyBookEmails || []).length + ')</div>';
    html += '<div style="color:#4a6a8a;font-size:0.85em;margin-bottom:10px">Protection plan email templates by HP range. Click to expand and view full template.</div>';
    (D.honeyBookEmails || []).forEach(function(e, i) {
      html += '<div style="margin-bottom:8px;border:1px solid #1a2a3a;background:rgba(10,20,35,0.4)">';
      html += '<div class="expandable" onclick="toggleExpand(this)" style="padding:12px;display:flex;justify-content:space-between;align-items:center">';
      html += '<div><span style="color:#ffd700;font-weight:700">' + (e.name || 'Template ' + (i+1)) + '</span>';
      if (e.subject) html += '<br><span style="color:#4a6a8a;font-size:0.85em">Subject: ' + e.subject + '</span>';
      html += '</div>';
      html += '<span style="color:#4a6a8a;font-size:1.2em">â–¾</span></div>';
      html += '<div class="expand-content"><pre style="white-space:pre-wrap;color:#c0d8f0;font-size:0.85em;font-family:Rajdhani;line-height:1.6;margin:0;padding:10px;background:rgba(5,10,20,0.4)">' + (e.body || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre></div></div>';
    });
    html += '</div></div>';

    // ========== TAB 8: COMPETITORS ==========
    html += '<div class="tab-panel" id="tab-comp">';
    var comp = D.competitors || {};
    var sites = comp.sites || [];
    var missingKws = comp.missingKeywords || [];
    
    // Competitor sites table
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff4757"></span>TOP COMPETITORS â€” ROYAL HOME REPAIR LLC (' + sites.length + ')</div>';
    html += '<table><thead><tr><th>WEBSITE</th><th>DA</th><th>AHREFS</th><th>SEMRUSH</th><th>LOCATION</th><th>SERVICE</th></tr></thead><tbody>';
    sites.forEach(function(s) {
      var daColor = s.da > 40 ? '#ff4757' : s.da > 20 ? '#ff9f43' : '#00ff66';
      html += '<tr>';
      html += '<td><a href="' + s.url + '" target="_blank" style="color:#00d4ff;text-decoration:none;font-size:0.85em">' + s.url.substring(0, 55) + '...</a></td>';
      html += '<td style="color:' + daColor + ';font-weight:900">' + (s.da || 'â€”') + '</td>';
      html += '<td style="color:#c084fc">' + (s.ahrefsTraffic || 'â€”') + '</td>';
      html += '<td style="color:#55f7d8">' + (s.semrushTraffic || 'â€”') + '</td>';
      html += '<td style="color:#4a6a8a;font-size:0.85em">' + (s.locationType || '') + '</td>';
      html += '<td style="color:#4a6a8a;font-size:0.85em">' + (s.serviceType || '') + '</td>';
      html += '</tr>';
    });
    html += '</tbody></table></div>';
    
    // Competitor keywords
    var compKws = comp.keywords || {};
    Object.keys(compKws).forEach(function(compUrl) {
      var kws = compKws[compUrl];
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>KEYWORDS: ' + compUrl.toUpperCase().substring(0, 50) + '</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:4px">';
      kws.forEach(function(k) {
        var volColor = (k.volume || 0) > 5000 ? '#ff4757' : (k.volume || 0) > 1000 ? '#ff9f43' : '#00ff66';
        html += '<span class="tag" style="background:' + volColor + '10;color:' + volColor + ';border:1px solid ' + volColor + '30">' + k.keyword + ' <span style="opacity:0.7">(' + (k.volume || '?') + ')</span></span>';
      });
      html += '</div></div>';
    });
    
    // Missing keywords (content gap)
    if (missingKws.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>CONTENT GAP â€” MISSING KEYWORDS (' + missingKws.length + ')</div>';
      html += '<div style="color:#4a6a8a;font-size:0.85em;margin-bottom:8px">Keywords competitors rank for that you don\'t. High-volume = highest priority.</div>';
      html += '<table><thead><tr><th>KEYWORD</th><th>VOLUME</th><th>PRIORITY</th></tr></thead><tbody>';
      missingKws.sort(function(a, b) { return (b.volume || 0) - (a.volume || 0); });
      missingKws.forEach(function(k) {
        var pri = (k.volume || 0) > 3000 ? 'HIGH' : (k.volume || 0) > 500 ? 'MEDIUM' : 'LOW';
        var priColor = pri === 'HIGH' ? '#ff4757' : pri === 'MEDIUM' ? '#ff9f43' : '#4a6a8a';
        html += '<tr><td style="color:#c0d8f0;font-weight:600">' + k.keyword + '</td>';
        html += '<td style="color:#55f7d8;font-weight:700">' + (k.volume || '?') + '</td>';
        html += '<td><span class="tag" style="background:' + priColor + '15;color:' + priColor + ';border:1px solid ' + priColor + '30">' + pri + '</span></td></tr>';
      });
      html += '</tbody></table></div>';
    }
    html += '</div>';

    // ========== TAB 9: AUDIT CHECKLIST ==========
    html += '<div class="tab-panel" id="tab-auditchk">';
    html += '<div class="box">';
    var auditItems = D.auditChecklist || [];
    var completed = auditItems.filter(function(i) { return i.status === 'Completed'; }).length;
    var totalAudit = auditItems.length;
    var auditPct = totalAudit > 0 ? Math.round((completed / totalAudit) * 100) : 0;
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>7-DAY SEO AUDIT CHECKLIST <span style="color:' + (auditPct === 100 ? '#00ff66' : '#ff9f43') + '">' + completed + '/' + totalAudit + ' (' + auditPct + '%)</span></div>';
    html += '<div class="progress" style="margin-bottom:12px;height:8px"><div class="progress-fill" style="width:' + auditPct + '%;background:' + (auditPct === 100 ? '#00ff66' : auditPct > 50 ? '#ff9f43' : '#ff4757') + '"></div></div>';
    
    var currentSection = '';
    html += '<table><thead><tr><th>ITEM</th><th>STATUS</th><th>SCORE</th><th>LINK</th></tr></thead><tbody>';
    auditItems.forEach(function(item) {
      if (item.section !== currentSection) {
        currentSection = item.section;
        html += '<tr><td colspan="4" style="color:#55f7d8;font-family:Orbitron;font-size:0.6em;letter-spacing:2px;padding:12px 10px 6px;border-bottom:1px solid #55f7d820">' + currentSection.toUpperCase() + '</td></tr>';
      }
      var stColor = item.status === 'Completed' ? '#00ff66' : '#ff9f43';
      var stTag = item.status === 'Completed' ? 'tag-green' : 'tag-orange';
      html += '<tr>';
      html += '<td style="color:#c0d8f0">' + item.item + '</td>';
      html += '<td><span class="tag ' + stTag + '">' + (item.status || 'PENDING') + '</span></td>';
      html += '<td style="color:#c084fc">' + (item.score || 'â€”') + '</td>';
      html += '<td>' + (item.link ? '<a href="' + item.link + '" target="_blank" style="color:#00d4ff;font-size:0.8em;text-decoration:none">ðŸ”— Link</a>' : 'â€”') + '</td>';
      html += '</tr>';
      if (item.comment) {
        html += '<tr><td colspan="4" style="color:#4a6a8a;font-size:0.8em;padding:2px 10px 6px 30px">' + item.comment + '</td></tr>';
      }
    });
    html += '</tbody></table></div>';
    html += '</div>';

    // ========== TAB 10: CURRENT GMBS ==========
    html += '<div class="tab-panel" id="tab-gmbs">';
    var gmbs = D.currentGmbs || {};
    var knownG = gmbs.known || [];
    var hiddenG = gmbs.hidden || [];
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>KNOWN ADDRESS GMBs (' + knownG.length + ')</div>';
    html += '<table><thead><tr><th>CITY</th><th>TYPE</th></tr></thead><tbody>';
    knownG.forEach(function(g) {
      html += '<tr><td style="color:#c0d8f0;font-weight:600">' + g.city + '</td>';
      html += '<td><span class="tag tag-green">KNOWN ADDRESS</span></td></tr>';
    });
    html += '</tbody></table></div>';
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>HIDDEN ADDRESS GMBs (' + hiddenG.length + ')</div>';
    html += '<table><thead><tr><th>CITY</th><th>NOTE</th><th>TYPE</th></tr></thead><tbody>';
    hiddenG.forEach(function(g) {
      html += '<tr><td style="color:#c0d8f0;font-weight:600">' + g.city + '</td>';
      html += '<td style="color:#4a6a8a;font-size:0.85em">' + (g.note || 'â€”') + '</td>';
      html += '<td><span class="tag tag-orange">HIDDEN</span></td></tr>';
    });
    html += '</tbody></table></div>';
    html += '<div class="box"><div style="color:#4a6a8a;font-size:0.85em">Total Active GMBs: <span style="color:#55f7d8;font-weight:700">' + (knownG.length + hiddenG.length) + '</span> across known and hidden address profiles.</div></div>';
    html += '</div>';

    // ========== TAB 11: DOMAIN SELECTION ==========
    html += '<div class="tab-panel" id="tab-domains">';
    var doms = D.domainSelection || [];
    var domCities = {};
    doms.forEach(function(d) { if (!domCities[d.city]) domCities[d.city] = []; domCities[d.city].push(d.domain); });
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>EMD DOMAIN SELECTION â€” ' + Object.keys(domCities).length + ' CITIES / ' + doms.length + ' DOMAINS</div>';
    Object.keys(domCities).forEach(function(city) {
      html += '<div style="margin-bottom:12px;padding:10px;background:rgba(5,10,20,0.4);border-radius:6px;border-left:3px solid #c084fc">';
      html += '<div style="font-family:Orbitron;font-size:0.6em;letter-spacing:2px;color:#55f7d8;margin-bottom:6px">' + city.toUpperCase() + '</div>';
      domCities[city].forEach(function(dom) {
        var isHttp = dom.indexOf('http') === 0;
        html += '<div style="margin:3px 0"><span style="color:#00d4ff;font-size:0.9em">' + (isHttp ? '<a href="' + dom + '" target="_blank" style="color:#00d4ff;text-decoration:none">' + dom + '</a>' : dom) + '</span></div>';
      });
      html += '</div>';
    });
    html += '</div></div>';

    // ========== TAB 12: GMB APPROVAL STRATEGY ==========
    html += '<div class="tab-panel" id="tab-strat">';
    var strat = D.gmbStrategy || [];
    var phaseColors = ['#55f7d8', '#ff9f43', '#c084fc'];
    strat.forEach(function(phase, idx) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:' + (phaseColors[idx] || '#4a6a8a') + '"></span>PHASE ' + (idx + 1) + ': ' + phase.phase.toUpperCase() + '</div>';
      phase.steps.forEach(function(s) {
        html += '<div style="margin-bottom:10px;padding:10px;background:rgba(5,10,20,0.4);border-radius:6px;border-left:3px solid ' + (phaseColors[idx] || '#4a6a8a') + '">';
        html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:' + (phaseColors[idx] || '#4a6a8a') + ';margin-bottom:6px">' + s.step.toUpperCase() + '</div>';
        html += '<div style="color:#c0d8f0;font-size:0.85em;white-space:pre-line;line-height:1.6">' + s.details.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\\n/g, '<br>').replace(/â€¢/g, '<span style="color:#55f7d8">â€¢</span>') + '</div>';
        html += '</div>';
      });
      html += '</div>';
    });
    html += '</div>';

    // ========== TAB 13: GBP TRACKER ==========
    html += '<div class="tab-panel" id="tab-tracker">';
    var trk = D.gbpTracker || [];
    var trkDone = trk.filter(function(t) { return t.hasFile; }).length;
    var trkPct = trk.length > 0 ? Math.round((trkDone / trk.length) * 100) : 0;
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>GBP PROJECT TRACKER <span style="color:' + (trkPct === 100 ? '#00ff66' : '#ff9f43') + '">' + trkDone + '/' + trk.length + ' WITH FILES (' + trkPct + '%)</span></div>';
    html += '<div class="progress" style="margin-bottom:12px;height:8px"><div class="progress-fill" style="width:' + trkPct + '%;background:' + (trkPct === 100 ? '#00ff66' : trkPct > 50 ? '#ff9f43' : '#ff4757') + '"></div></div>';
    html += '<table><thead><tr><th>ITEM</th><th>FILE STATUS</th></tr></thead><tbody>';
    trk.forEach(function(t) {
      var stTag = t.hasFile ? 'tag-green' : 'tag-orange';
      var stText = t.hasFile ? 'FILE READY' : 'PENDING';
      html += '<tr><td style="color:#c0d8f0;font-weight:600">' + t.item + '</td>';
      html += '<td><span class="tag ' + stTag + '">' + stText + '</span></td></tr>';
    });
    html += '</tbody></table></div>';
    html += '</div>';

    // ========== TAB 14: FL EXPANSION ==========
    html += '<div class="tab-panel" id="tab-flcities">';
    var flD = D.flCities || {};
    var flCities = flD.cities || [];
    var flProf = flD.profiles || [];
    var flSvc = flD.services || [];
    
    // Strategy overview
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>FLORIDA EXPANSION STRATEGY</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.7;padding:8px">';
    html += '<span style="color:#55f7d8;font-weight:700">Mission:</span> Deploy EMD websites + GBP listings across <span style="color:#ff6b9d;font-weight:700">15 Florida cities</span> for lawn mower & small engine repair.<br>';
    html += '<span style="color:#55f7d8;font-weight:700">Services:</span> ';
    flSvc.forEach(function(s,i) { if(s.service) html += '<span class="tag tag-cyan">' + s.service + '</span> '; });
    html += '<br><span style="color:#55f7d8;font-weight:700">Model:</span> Local Guide soft-approval â†’ Ownership claim â†’ EMD website + 50+ citations per city â†’ Weekly posts & updates';
    html += '</div></div>';
    
    // City profiles grid
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>' + flCities.length + ' TARGET FL CITIES</div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">';
    flCities.forEach(function(fc) {
      html += '<span class="tag" style="background:rgba(255,107,157,0.15);color:#ff6b9d;border:1px solid rgba(255,107,157,0.3)">' + fc.city + ' <span style="color:#4a6a8a;font-size:0.8em">(' + fc.county + ')</span></span>';
    });
    html += '</div></div>';
    
    // Per-city profile cards
    flProf.forEach(function(p) {
      var hasSetup = p.name || p.address;
      html += '<div class="box" style="border-left:3px solid ' + (hasSetup ? '#00ff66' : '#ff9f43') + '">';
      html += '<div class="box-title"><span class="dot" style="background:' + (hasSetup ? '#00ff66' : '#ff9f43') + '"></span>' + p.city.toUpperCase() + ' <span style="font-size:0.7em;color:' + (hasSetup ? '#00ff66' : '#ff9f43') + '">' + (hasSetup ? 'â— SETUP' : 'â— PENDING') + '</span></div>';
      
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.82em">';
      if(p.name) html += '<div><span style="color:#4a6a8a">Name:</span> <span style="color:#c0d8f0">' + p.name + '</span></div>';
      if(p.phone) html += '<div><span style="color:#4a6a8a">Phone:</span> <span style="color:#c0d8f0">' + p.phone + '</span></div>';
      if(p.website) html += '<div><span style="color:#4a6a8a">Website:</span> <a href="' + (p.website.indexOf('http')===0?p.website:'https://'+p.website) + '" target="_blank" style="color:#00d4ff;text-decoration:none">' + p.website.replace('https://','').replace('http://','').substring(0,40) + '</a></div>';
      if(p.category) html += '<div><span style="color:#4a6a8a">Category:</span> <span style="color:#c0d8f0">' + p.category + '</span></div>';
      html += '</div>';
      
      if(p.domains && p.domains.length > 0) {
        html += '<div style="margin-top:6px"><span style="color:#4a6a8a;font-size:0.8em">Domains:</span> ';
        p.domains.forEach(function(d) { html += '<span class="tag tag-cyan" style="font-size:0.75em">' + d + '</span> '; });
        html += '</div>';
      }
      
      if(p.pageKeywords && p.pageKeywords.length > 0) {
        html += '<div style="margin-top:6px"><span style="color:#4a6a8a;font-size:0.8em">Target Keywords:</span><div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:3px">';
        p.pageKeywords.forEach(function(kw) {
          var vColor = kw.volume >= 100 ? '#ff4757' : kw.volume >= 50 ? '#ff9f43' : '#00ff66';
          html += '<span class="tag" style="background:rgba(0,212,255,0.08);color:#c0d8f0;font-size:0.75em">' + kw.keyword + ' <span style="color:' + vColor + '">' + kw.volume + '</span></span>';
        });
        html += '</div></div>';
      }
      
      if(p.competitors && p.competitors.length > 0) {
        html += '<div style="margin-top:6px"><span style="color:#4a6a8a;font-size:0.8em">Competitors:</span><div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:3px">';
        p.competitors.forEach(function(c) {
          html += '<span class="tag" style="background:rgba(255,71,87,0.1);color:#ff9f43;font-size:0.75em">' + c.name + (c.source ? ' <span style="color:#4a6a8a">(' + c.source + ')</span>' : '') + '</span>';
        });
        html += '</div></div>';
      }
      html += '</div>';
    });
    html += '</div>';

    // ========== TAB 15: GBP PROFILES ==========
    html += '<div class="tab-panel" id="tab-gbpprof">';
    var gbpP = D.gbpProfiles || [];
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00d4ff"></span>ACTIVE GOOGLE BUSINESS PROFILES (' + gbpP.length + ')</div>';
    html += '<div style="color:#4a6a8a;font-size:0.82em;margin-bottom:10px">Live GBP listings with search performance data. These are verified profiles generating impressions and clicks.</div>';
    html += '</div>';
    
    gbpP.forEach(function(prof) {
      html += '<div class="box" style="border-left:3px solid #00d4ff">';
      html += '<div class="box-title"><span class="dot" style="background:#00d4ff"></span>' + prof.city.toUpperCase() + '</div>';
      
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.82em">';
      if(prof.name) html += '<div><span style="color:#4a6a8a">Name:</span> <span style="color:#c0d8f0">' + prof.name + '</span></div>';
      if(prof.phone) html += '<div><span style="color:#4a6a8a">Phone:</span> <span style="color:#c0d8f0">' + prof.phone + '</span></div>';
      if(prof.address) html += '<div><span style="color:#4a6a8a">Address:</span> <span style="color:#c0d8f0">' + prof.address + '</span></div>';
      if(prof.website) html += '<div><span style="color:#4a6a8a">Website:</span> <a href="' + prof.website + '" target="_blank" style="color:#00d4ff;text-decoration:none">' + prof.website.replace('https://','').replace('http://','').substring(0,45) + '</a></div>';
      html += '</div>';
      
      if(prof.searchTerms && prof.searchTerms.length > 0) {
        html += '<div style="margin-top:8px"><span style="color:#55f7d8;font-size:0.75em;font-family:Orbitron;letter-spacing:1px">SEARCH TERMS</span>';
        html += '<table style="margin-top:4px"><thead><tr><th>KEYWORD</th><th>SEARCHES</th></tr></thead><tbody>';
        prof.searchTerms.forEach(function(st) {
          var sColor = st.searches === '< 15' ? '#4a6a8a' : '#55f7d8';
          html += '<tr><td style="color:#c0d8f0;font-size:0.82em">' + st.keyword + '</td><td style="color:' + sColor + ';font-weight:600">' + st.searches + '</td></tr>';
        });
        html += '</tbody></table></div>';
      }
      html += '</div>';
    });
    html += '</div>';

    // ========== TAB 16: KEYWORD RESEARCH ==========
    html += '<div class="tab-panel" id="tab-kwresearch">';
    var kwR = D.keywordResearch || {};
    var kwCities = Object.keys(kwR);
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>KEYWORD RESEARCH â€” ' + kwCities.length + ' CITIES</div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">';
    kwCities.forEach(function(c) { html += '<span class="tag tag-cyan" style="font-size:0.8em">' + c + '</span>'; });
    html += '</div></div>';
    
    kwCities.forEach(function(city) {
      var kws = kwR[city];
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>' + city.toUpperCase() + ' (' + kws.length + ' KEYWORDS)</div>';
      html += '<table><thead><tr><th>KEYWORD</th><th>VOLUME</th><th>KD</th><th>PRIORITY</th></tr></thead><tbody>';
      kws.sort(function(a,b) { return b.volume - a.volume; });
      kws.forEach(function(kw) {
        var vColor = kw.volume >= 100 ? '#ff4757' : kw.volume >= 50 ? '#ff9f43' : '#00ff66';
        var pri = kw.volume >= 100 ? 'HIGH' : kw.volume >= 40 ? 'MEDIUM' : 'LOW';
        var priTag = pri === 'HIGH' ? 'tag-red' : pri === 'MEDIUM' ? 'tag-orange' : 'tag-green';
        html += '<tr><td style="color:#c0d8f0;font-size:0.82em">' + kw.keyword + '</td>';
        html += '<td style="color:' + vColor + ';font-weight:700">' + kw.volume + '</td>';
        html += '<td style="color:#4a6a8a">' + (kw.kd || 'â€”') + '</td>';
        html += '<td><span class="tag ' + priTag + '">' + pri + '</span></td></tr>';
      });
      html += '</tbody></table></div>';
    });
    html += '</div>';

    // ========== TAB 17: US MARKET AUDIT ==========
    html += '<div class="tab-panel" id="tab-usaudit">';
    var usA = D.usAudit || [];
    var totalUsCities = 0;
    usA.forEach(function(s) { totalUsCities += s.cities.length; });
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>US MARKET OPPORTUNITY AUDIT</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.7;padding:8px">';
    html += '<span style="color:#55f7d8;font-weight:700">Coverage:</span> <span style="color:#ff6b9d;font-weight:700">' + usA.length + ' states</span> / <span style="color:#ffd700;font-weight:700">' + totalUsCities + ' cities</span> audited for small engine repair, lawn mower repair, snow blower repair, and generator repair search volumes.<br>';
    html += '<span style="color:#55f7d8;font-weight:700">Purpose:</span> Identify high-volume, low-competition markets for Wildwood expansion beyond Florida.';
    html += '</div></div>';
    
    // Top opportunity states (show top 10 by total volume)
    var stateVolumes = usA.map(function(s) {
      var total = 0;
      s.cities.forEach(function(c) {
        Object.values(c.volumes).forEach(function(v) { total += v; });
      });
      return {state: s.state, cities: s.cities.length, totalVol: total};
    }).sort(function(a,b) { return b.totalVol - a.totalVol; });
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>TOP STATES BY SEARCH VOLUME</div>';
    html += '<table><thead><tr><th>STATE</th><th>CITIES</th><th>TOTAL VOLUME</th><th>OPPORTUNITY</th></tr></thead><tbody>';
    stateVolumes.slice(0, 15).forEach(function(sv) {
      var opp = sv.totalVol >= 2000 ? 'PRIME' : sv.totalVol >= 500 ? 'STRONG' : 'EMERGING';
      var oppTag = opp === 'PRIME' ? 'tag-red' : opp === 'STRONG' ? 'tag-orange' : 'tag-green';
      html += '<tr><td style="color:#c0d8f0;font-weight:600">' + sv.state + '</td>';
      html += '<td style="color:#55f7d8">' + sv.cities + '</td>';
      html += '<td style="color:#ffd700;font-weight:700">' + sv.totalVol.toLocaleString() + '</td>';
      html += '<td><span class="tag ' + oppTag + '">' + opp + '</span></td></tr>';
    });
    html += '</tbody></table></div>';
    
    // Expandable per-state sections
    usA.forEach(function(s) {
      if(!s.cities.some(function(c) { return Object.keys(c.volumes).length > 0; })) return;
      html += '<div class="expand-header" onclick="toggleExpand(this)"><span>' + s.state.toUpperCase() + ' (' + s.cities.length + ' cities)</span><span>â–¾</span></div>';
      html += '<div class="expand-content">';
      html += '<table><thead><tr><th>CITY</th><th>POP</th>';
      var svcs = ['small engine repair','lawn mower repair','Snow Blower Repair','Generator Repair'];
      svcs.forEach(function(sv) { html += '<th>' + sv.split(' ')[0].toUpperCase() + '</th>'; });
      html += '</tr></thead><tbody>';
      s.cities.forEach(function(c) {
        html += '<tr><td style="color:#c0d8f0;font-weight:600">' + c.city + '</td>';
        html += '<td style="color:#4a6a8a">' + (c.population > 0 ? (c.population/1000).toFixed(0) + 'K' : 'â€”') + '</td>';
        svcs.forEach(function(sv) {
          var v = c.volumes[sv] || 0;
          var vc = v >= 100 ? '#ff4757' : v >= 50 ? '#ff9f43' : v > 0 ? '#00ff66' : '#1e2d3d';
          html += '<td style="color:' + vc + ';font-weight:' + (v>=50?'700':'400') + '">' + (v > 0 ? v : 'â€”') + '</td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
    });
    html += '</div>';

    // ========== TAB 18: META & ON-PAGE ==========
    html += '<div class="tab-panel" id="tab-meta">';
    
    // Site-wide pages
    var sPages = D.sitePages || [];
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00d4ff"></span>WILDWOOD SITE PAGES (' + sPages.length + ')</div>';
    html += '<div style="color:#4a6a8a;font-size:0.82em;margin-bottom:8px">Main website URL structure with assigned keywords and meta data status.</div>';
    html += '<table><thead><tr><th>URL</th><th>KEYWORD</th><th>META STATUS</th></tr></thead><tbody>';
    sPages.forEach(function(p) {
      var shortUrl = p.url.replace('https://wildwoodsmallenginerepair.com','').replace('http://','');
      var hasMeta = p.title || p.description;
      html += '<tr><td><a href="' + p.url + '" target="_blank" style="color:#00d4ff;text-decoration:none;font-size:0.82em">' + (shortUrl || '/') + '</a></td>';
      html += '<td style="color:#c0d8f0;font-size:0.82em">' + (p.keyword || 'â€”') + '</td>';
      html += '<td><span class="tag ' + (hasMeta ? 'tag-green' : 'tag-orange') + '">' + (hasMeta ? 'SET' : 'NEEDS META') + '</span></td></tr>';
    });
    html += '</tbody></table></div>';
    
    // Sioux Falls meta data
    var metaSF = D.metaDataSF || [];
    if(metaSF.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>SIOUX FALLS SERVICE PAGE META (' + metaSF.length + ')</div>';
      html += '<table><thead><tr><th>KEYWORD</th><th>META TITLE</th></tr></thead><tbody>';
      metaSF.forEach(function(m) {
        html += '<tr><td style="color:#55f7d8;font-weight:600;font-size:0.82em">' + m.keyword + '</td>';
        html += '<td style="color:#c0d8f0;font-size:0.82em">' + m.title + '</td></tr>';
      });
      html += '</tbody></table></div>';
    }
    
    // FL Meta Data
    var flM = D.flMeta || {};
    var flMCities = Object.keys(flM);
    if(flMCities.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>FL NEW WEBSITES META DATA (' + flMCities.length + ' CITIES)</div>';
      flMCities.forEach(function(city) {
        html += '<div style="margin-bottom:10px;padding:8px;background:rgba(5,10,20,0.4);border-radius:6px;border-left:3px solid #ff6b9d">';
        html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#ff6b9d;margin-bottom:6px">' + city.toUpperCase() + '</div>';
        html += '<table style="margin:0"><thead><tr><th>PAGE</th><th>PRIMARY KW</th><th>TITLE STATUS</th></tr></thead><tbody>';
        flM[city].forEach(function(p) {
          html += '<tr><td style="color:#c0d8f0;font-size:0.82em">' + p.page + '</td>';
          html += '<td style="color:#55f7d8;font-size:0.82em">' + (p.keyword || 'â€”') + '</td>';
          html += '<td><span class="tag ' + (p.title ? 'tag-green' : 'tag-orange') + '">' + (p.title ? 'SET' : 'PENDING') + '</span></td></tr>';
        });
        html += '</tbody></table></div>';
      });
      html += '</div>';
    }
    
    // FL Keywords
    var flKw = D.flKeywords || {};
    var flKwCities = Object.keys(flKw);
    if(flKwCities.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>FL NEW WEBSITE KEYWORDS</div>';
      flKwCities.forEach(function(city) {
        html += '<div style="margin-bottom:10px;padding:8px;background:rgba(5,10,20,0.4);border-radius:6px;border-left:3px solid #ffd700">';
        html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#ffd700;margin-bottom:4px">' + city.toUpperCase() + '</div>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:4px">';
        flKw[city].forEach(function(kw) {
          var vc = kw.volume >= 100 ? '#ff4757' : kw.volume >= 50 ? '#ff9f43' : '#00ff66';
          html += '<span class="tag" style="background:rgba(255,215,0,0.08);color:#c0d8f0;font-size:0.75em">' + kw.keyword + ' <span style="color:' + vc + ';font-weight:700">' + kw.volume + '</span></span>';
        });
        html += '</div></div>';
      });
      html += '</div>';
    }
    
    // Main site backlinks
    var bl = D.mainSiteBacklinks || {};
    var sbCount = (bl.socialBookmarks || []).length;
    var gpCount = (bl.guestPosts || []).length;
    if(sbCount + gpCount > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>MAIN SITE BACKLINKS â€” ' + sbCount + ' Social Bookmarks / ' + gpCount + ' Guest Posts</div>';
      if(sbCount > 0) {
        html += '<div style="font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#c084fc;margin:8px 0 4px">SOCIAL BOOKMARKS</div>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:4px">';
        (bl.socialBookmarks || []).forEach(function(b) {
          var sc = b.status === 'Live' ? '#00ff66' : '#ff9f43';
          html += '<a href="' + (b.liveLink || b.domain) + '" target="_blank" style="text-decoration:none"><span class="tag" style="background:rgba(192,132,252,0.1);color:' + sc + ';font-size:0.75em">' + b.domain.replace('https://','').replace('http://','').replace('/','').substring(0,25) + '</span></a>';
        });
        html += '</div>';
      }
      html += '</div>';
    }
    html += '</div>';

    // ========== TAB 19: ADDRESS INTEL ==========
    html += '<div class="tab-panel" id="tab-addrintel">';
    var rAddr = D.realAddresses || {};
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>GBP ADDRESS INTELLIGENCE</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.7;padding:8px">';
    html += '<span style="color:#55f7d8;font-weight:700">Purpose:</span> Map every GBP listing to its address type, target keywords, and geographic coverage role. This drives the Local Guide creation + ownership claiming strategy.<br>';
    html += '<span style="color:#55f7d8;font-weight:700">Known addresses</span> = verified physical locations. <span style="color:#ff9f43;font-weight:700">Hidden addresses</span> = service-area business (SAB) listings without public address.';
    html += '</div></div>';
    
    // Known addresses
    var known = rAddr.known || [];
    html += '<div class="box" style="border-left:3px solid #00ff66">';
    html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>KNOWN ADDRESS LISTINGS (' + known.length + ')</div>';
    html += '<table><thead><tr><th>CITY</th><th>ROLE</th><th>NOTES</th></tr></thead><tbody>';
    known.forEach(function(a) {
      html += '<tr><td style="color:#c0d8f0;font-weight:600">' + (a.city || a.area) + '</td>';
      html += '<td style="color:#55f7d8;font-size:0.82em">' + (a.role || 'Primary') + '</td>';
      html += '<td style="color:#4a6a8a;font-size:0.82em">' + (a.notes || 'â€”') + '</td></tr>';
    });
    html += '</tbody></table></div>';
    
    // Hidden addresses (grouped by parent city)
    var hidden = rAddr.hidden || [];
    html += '<div class="box" style="border-left:3px solid #ff9f43">';
    html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>HIDDEN ADDRESS / SAB LISTINGS (' + hidden.length + ' ENTRIES)</div>';
    html += '<table><thead><tr><th>CITY / AREA</th><th>TARGET KEYWORDS</th><th>ROLE</th><th>NOTES</th></tr></thead><tbody>';
    hidden.forEach(function(a) {
      var isParent = a.city && !a.area;
      var display = a.city || a.area;
      html += '<tr style="' + (a.role ? '' : 'opacity:0.7') + '">';
      html += '<td style="color:' + (isParent ? '#ff9f43;font-weight:700' : '#c0d8f0') + ';font-size:0.82em;' + (!a.city ? 'padding-left:20px' : '') + '">' + display + '</td>';
      html += '<td style="color:#55f7d8;font-size:0.78em">' + (a.keywords || 'â€”') + '</td>';
      html += '<td style="font-size:0.78em"><span class="tag ' + (a.role === 'Primary Verified Location' ? 'tag-green' : a.role === 'Edge Visibility' ? 'tag-cyan' : a.role === 'Regional Expansion' ? 'tag-orange' : '') + '" style="font-size:0.85em">' + (a.role || 'â€”') + '</span></td>';
      html += '<td style="color:#4a6a8a;font-size:0.78em">' + (a.notes || 'â€”') + '</td></tr>';
    });
    html += '</tbody></table></div>';
    
    // Off-page tracker
    var opT = D.offPageTracker || [];
    if(opT.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>OFF-PAGE CITY ASSIGNMENTS (' + opT.length + ')</div>';
      html += '<table><thead><tr><th>CITY</th><th>ASSIGNED EMAIL</th></tr></thead><tbody>';
      opT.forEach(function(o) {
        html += '<tr><td style="color:#c0d8f0;font-weight:600">' + o.city + '</td>';
        html += '<td style="color:#00d4ff;font-size:0.82em">' + (o.email || 'â€”') + '</td></tr>';
      });
      html += '</tbody></table></div>';
    }
    
    // FL Off-Page Status
    var flOP = D.flOffPageStatus || [];
    if(flOP.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>FL OFF-PAGE PROGRESS</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:6px">';
      flOP.forEach(function(f) {
        html += '<span class="tag" style="background:rgba(255,107,157,0.1);color:#ff6b9d;font-size:0.85em">' + f.city + ' <span style="color:' + (f.status === 'File' ? '#00ff66' : '#ff9f43') + '">â— ' + f.status + '</span></span>';
      });
      html += '</div></div>';
    }
    html += '</div>';

    // ========== TAB 20: SAVED KEYWORDS ==========
    html += '<div class="tab-panel" id="tab-savedkw">';
    var sKw = D.savedKeywords || [];
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>GOOGLE ADS KEYWORD PLANNER DATA (' + sKw.length + ' KEYWORDS)</div>';
    html += '<div style="color:#4a6a8a;font-size:0.82em;margin-bottom:8px">Saved keyword stats from Oct 2024 â€“ Sep 2025. National-level monthly search volumes for lawn mower & small engine repair terms.</div>';
    html += '<table><thead><tr><th>KEYWORD</th><th>AVG MONTHLY</th><th>TIER</th></tr></thead><tbody>';
    sKw.forEach(function(kw) {
      var tier = kw.avgMonthly >= 5000 ? 'MONSTER' : kw.avgMonthly >= 1000 ? 'HIGH' : kw.avgMonthly >= 500 ? 'MEDIUM' : 'NICHE';
      var tc = tier === 'MONSTER' ? '#ff4757' : tier === 'HIGH' ? '#ff9f43' : tier === 'MEDIUM' ? '#ffd700' : '#00ff66';
      var tTag = tier === 'MONSTER' ? 'tag-red' : tier === 'HIGH' ? 'tag-orange' : tier === 'MEDIUM' ? 'tag-orange' : 'tag-green';
      html += '<tr><td style="color:#c0d8f0;font-size:0.85em">' + kw.keyword + '</td>';
      html += '<td style="color:' + tc + ';font-weight:700;font-size:0.9em">' + kw.avgMonthly.toLocaleString() + '</td>';
      html += '<td><span class="tag ' + tTag + '">' + tier + '</span></td></tr>';
    });
    html += '</tbody></table></div>';
    html += '</div>';

    // ========== TAB 21: SITE ANALYTICS ==========
    html += '<div class="tab-panel" id="tab-analytics">';
    var ww = D.wwserData || {};
    
    // Top Queries (GSC)
    var tQ = ww.topQueries || [];
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>TOP SEARCH QUERIES â€” Google Search Console (' + tQ.length + ')</div>';
    html += '<table><thead><tr><th>QUERY</th><th>CLICKS</th><th>IMPRESSIONS</th><th>CTR</th></tr></thead><tbody>';
    tQ.forEach(function(q) {
      var ctr = q.impressions > 0 ? ((q.clicks / q.impressions) * 100).toFixed(1) + '%' : 'â€”';
      var cc = q.clicks >= 100 ? '#ff4757' : q.clicks >= 50 ? '#ff9f43' : '#00ff66';
      html += '<tr><td style="color:#c0d8f0;font-size:0.82em">' + q.query + '</td>';
      html += '<td style="color:' + cc + ';font-weight:700">' + q.clicks.toLocaleString() + '</td>';
      html += '<td style="color:#4a6a8a">' + q.impressions.toLocaleString() + '</td>';
      html += '<td style="color:#55f7d8">' + ctr + '</td></tr>';
    });
    html += '</tbody></table></div>';
    
    // Page Traffic (GSC)
    var wT = ww.webTraffic || [];
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00d4ff"></span>TOP PAGES â€” Last 6 Months (' + wT.length + ')</div>';
    html += '<table><thead><tr><th>PAGE</th><th>CLICKS</th><th>IMPRESSIONS</th></tr></thead><tbody>';
    wT.forEach(function(p) {
      var short = p.url.replace('https://wildwoodsmallenginerepair.com','').replace('http://wildwoodsmallenginerepair.com','');
      var cc = p.clicks >= 500 ? '#ff4757' : p.clicks >= 100 ? '#ff9f43' : '#00ff66';
      html += '<tr><td><a href="' + p.url + '" target="_blank" style="color:#00d4ff;text-decoration:none;font-size:0.8em">' + (short || '/') + '</a></td>';
      html += '<td style="color:' + cc + ';font-weight:700">' + p.clicks.toLocaleString() + '</td>';
      html += '<td style="color:#4a6a8a">' + p.impressions.toLocaleString() + '</td></tr>';
    });
    html += '</tbody></table></div>';
    
    // Semrush Traffic
    var sT = ww.semrushTraffic || [];
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>SEMRUSH ORGANIC TRAFFIC (' + sT.length + ' PAGES)</div>';
    html += '<table><thead><tr><th>PAGE</th><th>KEYWORDS</th><th>TRAFFIC</th></tr></thead><tbody>';
    sT.forEach(function(p) {
      var short = p.url.replace('https://wildwoodsmallenginerepair.com','');
      html += '<tr><td style="color:#00d4ff;font-size:0.8em">' + (short || '/') + '</td>';
      html += '<td style="color:#55f7d8">' + p.keywords + '</td>';
      html += '<td style="color:#ffd700;font-weight:700">' + p.traffic.toLocaleString() + '</td></tr>';
    });
    html += '</tbody></table></div>';
    
    // External Backlinks
    var eL = ww.externalLinks || [];
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>TOP EXTERNAL BACKLINKS</div>';
    html += '<table><thead><tr><th>TARGET PAGE</th><th>INCOMING LINKS</th><th>LINKING SITES</th></tr></thead><tbody>';
    eL.forEach(function(l) {
      var short = l.url.replace('https://wildwoodsmallenginerepair.com','');
      html += '<tr><td style="color:#00d4ff;font-size:0.8em">' + (short || '/') + '</td>';
      html += '<td style="color:#ff6b9d;font-weight:700">' + l.incoming + '</td>';
      html += '<td style="color:#c0d8f0">' + l.linkingSites + '</td></tr>';
    });
    html += '</tbody></table></div>';
    
    // GBP URLs
    var gU = ww.gbpUrls || [];
    if(gU.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>GBP LISTING â†’ WEBSITE URLs</div>';
      html += '<table><thead><tr><th>GBP CITY</th><th>LINKED URL</th></tr></thead><tbody>';
      gU.forEach(function(g) {
        var short = g.url.replace('https://wildwoodsmallenginerepair.com','');
        html += '<tr><td style="color:#c0d8f0;font-weight:600">' + g.city + '</td>';
        html += '<td><a href="' + g.url + '" target="_blank" style="color:#00d4ff;text-decoration:none;font-size:0.82em">' + (short || '/') + '</a></td></tr>';
      });
      html += '</tbody></table></div>';
    }
    html += '</div>';

    // ========== TAB 22: SNOW BLOWER INTEL ==========
    html += '<div class="tab-panel" id="tab-sbintel">';
    
    // Season timing
    var sbS = D.snowBlowerSeason || [];
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00d4ff"></span>SNOW BLOWER SEASON TIMING (' + sbS.length + ' CITIES)</div>';
    html += '<div style="color:#4a6a8a;font-size:0.82em;margin-bottom:8px">When snow starts in each target city â€” drives pre-season tune-up ad timing and content pushes.</div>';
    html += '<table><thead><tr><th>CITY</th><th>SNOW SEASON STARTS</th><th>AD PUSH</th></tr></thead><tbody>';
    sbS.forEach(function(s) {
      var early = s.snowStarts.toLowerCase().indexOf('october') >= 0 || s.snowStarts.toLowerCase().indexOf('sept') >= 0;
      html += '<tr><td style="color:#c0d8f0;font-weight:600">' + s.city + '</td>';
      html += '<td style="color:#55f7d8">' + s.snowStarts + '</td>';
      html += '<td><span class="tag ' + (early ? 'tag-red' : 'tag-orange') + '">' + (early ? 'SEPT/OCT' : 'NOV') + '</span></td></tr>';
    });
    html += '</tbody></table></div>';
    
    // Snow blower keywords by city
    var sbK = D.snowBlowerKeywords || {};
    var sbCities = Object.keys(sbK);
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>SNOW BLOWER KEYWORDS â€” ' + sbCities.length + ' CITIES</div>';
    sbCities.forEach(function(city) {
      var kws = sbK[city];
      html += '<div class="expand-header" onclick="toggleExpand(this)"><span>' + city.toUpperCase() + ' (' + kws.length + ' kws)</span><span>â–¾</span></div>';
      html += '<div class="expand-content">';
      html += '<table><thead><tr><th>KEYWORD</th><th>VOLUME</th></tr></thead><tbody>';
      kws.forEach(function(kw) {
        var vc = kw.volume >= 50 ? '#ff4757' : kw.volume >= 20 ? '#ff9f43' : '#00ff66';
        html += '<tr><td style="color:#c0d8f0;font-size:0.82em">' + kw.keyword + '</td>';
        html += '<td style="color:' + vc + ';font-weight:700">' + kw.volume + '</td></tr>';
      });
      html += '</tbody></table></div>';
    });
    html += '</div>';
    
    // Miami keyword test data
    var mK = D.miamiKeywords || [];
    if(mK.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>MIAMI MARKET TEST â€” Google Ads Planner (' + mK.length + ' KWs)</div>';
      html += '<table><thead><tr><th>KEYWORD</th><th>AVG MONTHLY</th><th>TIER</th></tr></thead><tbody>';
      mK.forEach(function(kw) {
        var tier = kw.avgMonthly >= 200 ? 'HIGH' : kw.avgMonthly >= 50 ? 'MEDIUM' : 'NICHE';
        var tc = tier === 'HIGH' ? 'tag-red' : tier === 'MEDIUM' ? 'tag-orange' : 'tag-green';
        html += '<tr><td style="color:#c0d8f0;font-size:0.82em">' + kw.keyword + '</td>';
        html += '<td style="color:#ffd700;font-weight:700">' + kw.avgMonthly + '</td>';
        html += '<td><span class="tag ' + tc + '">' + tier + '</span></td></tr>';
      });
      html += '</tbody></table></div>';
    }
    html += '</div>';

    // ========== LIVE SITE TAB ==========
    html += '<div class="tab-panel" id="tab-livesite">';
    html += '<div class="box" style="border:1px solid #ff6b9d30;background:linear-gradient(135deg,rgba(5,10,20,0.9),rgba(20,10,15,0.9))">';
    html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>ðŸŒ LIVE SITE â€” wildwoodsmallenginerepair.com</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.7;padding:8px">';
    html += '27 API endpoints pulling live data from your WordPress site. No spreadsheets needed â€” hit a button and get real-time SEO intelligence.';
    html += '</div></div>';

    // Button groups
    html += '<div class="box" style="border-left:3px solid #55f7d8">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>ðŸ“„ WORDPRESS CONTENT</div>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
    html += '<button data-wid="pages" data-wurl="/api/wp/pages" onclick="wpBtn(this)" class="wp-btn" style="background:#55f7d820;color:#55f7d8;border:1px solid #55f7d830">PAGES</button>';
    html += '<button data-wid="posts" data-wurl="/api/wp/posts" onclick="wpBtn(this)" class="wp-btn" style="background:#c084fc20;color:#c084fc;border:1px solid #c084fc30">POSTS</button>';
    html += '<button data-wid="media" data-wurl="/api/wp/media" onclick="wpBtn(this)" class="wp-btn" style="background:#ffd70020;color:#ffd700;border:1px solid #ffd70030">MEDIA LIBRARY</button>';
    html += '<button data-wid="cats" data-wurl="/api/wp/categories" onclick="wpBtn(this)" class="wp-btn" style="background:#00ff6620;color:#00ff66;border:1px solid #00ff6630">CATEGORIES</button>';
    html += '<button data-wid="tags" data-wurl="/api/wp/tags" onclick="wpBtn(this)" class="wp-btn" style="background:#ff9f4320;color:#ff9f43;border:1px solid #ff9f4330">TAGS</button>';
    html += '</div></div>';

    html += '<div class="box" style="border-left:3px solid #ff4757">';
    html += '<div class="box-title"><span class="dot" style="background:#ff4757"></span>ðŸ” SEO CRAWL & ANALYSIS</div>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
    html += '<button data-wid="deepcrawl" data-wurl="/api/wp/deep-crawl" onclick="wpBtn(this)" class="wp-btn" style="background:#ff475720;color:#ff4757;border:1px solid #ff475730">ðŸ•·ï¸ DEEP CRAWL</button>';
    html += '<button data-wid="linkgraph" data-wurl="/api/wp/link-graph" onclick="wpBtn(this)" class="wp-btn" style="background:#c084fc20;color:#c084fc;border:1px solid #c084fc30">ðŸ”— LINK GRAPH</button>';
    html += '<button data-wid="imageaudit" data-wurl="/api/wp/image-audit" onclick="wpBtn(this)" class="wp-btn" style="background:#ffd70020;color:#ffd700;border:1px solid #ffd70030">ðŸ–¼ï¸ IMAGE AUDIT</button>';
    html += '<button data-wid="headings" data-wurl="/api/wp/heading-audit" onclick="wpBtn(this)" class="wp-btn" style="background:#00d4ff20;color:#00d4ff;border:1px solid #00d4ff30">ðŸ“‹ HEADING AUDIT</button>';
    html += '<button data-wid="dupes" data-wurl="/api/wp/duplicates" onclick="wpBtn(this)" class="wp-btn" style="background:#ff6b9d20;color:#ff6b9d;border:1px solid #ff6b9d30">ðŸ”„ DUPLICATES</button>';
    html += '<button data-wid="broken" data-wurl="/api/wp/broken-links" onclick="wpBtn(this)" class="wp-btn" style="background:#ff475720;color:#ff4757;border:1px solid #ff475730">ðŸ’€ BROKEN LINKS</button>';
    html += '</div></div>';

    html += '<div class="box" style="border-left:3px solid #ffd700">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>ðŸ”‘ KEYWORD INTELLIGENCE</div>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
    html += '<button data-wid="kwmap" data-wurl="/api/wp/keyword-map" onclick="wpBtn(this)" class="wp-btn" style="background:#ffd70020;color:#ffd700;border:1px solid #ffd70030">ðŸ—ºï¸ KEYWORD MAP</button>';
    html += '<button data-wid="cannibal" data-wurl="/api/wp/cannibalization" onclick="wpBtn(this)" class="wp-btn" style="background:#ff475720;color:#ff4757;border:1px solid #ff475730">âš”ï¸ CANNIBALIZATION</button>';
    html += '<button data-wid="gaps" data-wurl="/api/wp/content-gaps" onclick="wpBtn(this)" class="wp-btn" style="background:#00ff6620;color:#00ff66;border:1px solid #00ff6630">ðŸ•³ï¸ CONTENT GAPS</button>';
    html += '<button data-wid="missing" data-wurl="/api/wp/missing-cities" onclick="wpBtn(this)" class="wp-btn" style="background:#c084fc20;color:#c084fc;border:1px solid #c084fc30">ðŸ™ï¸ MISSING CITIES</button>';
    html += '</div></div>';

    html += '<div class="box" style="border-left:3px solid #00ff66">';
    html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>âš¡ SPEED & INFRASTRUCTURE</div>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
    html += '<button data-wid="speed" data-wurl="/api/wp/speed-test" onclick="wpBtn(this)" class="wp-btn" style="background:#55f7d820;color:#55f7d8;border:1px solid #55f7d830">â±ï¸ SPEED TEST</button>';
    html += '<button data-wid="pagespeed" data-wurl="/api/wp/pagespeed" onclick="wpBtn(this)" class="wp-btn" style="background:#00ff6620;color:#00ff66;border:1px solid #00ff6630">ðŸ“Š PAGESPEED INSIGHTS</button>';
    html += '<button data-wid="security" data-wurl="/api/wp/security" onclick="wpBtn(this)" class="wp-btn" style="background:#ffd70020;color:#ffd700;border:1px solid #ffd70030">ðŸ”’ SSL & SECURITY</button>';
    html += '<button data-wid="robots" data-wurl="/api/wp/robots" onclick="wpBtn(this)" class="wp-btn" style="background:#4a6a8a20;color:#4a6a8a;border:1px solid #4a6a8a30">ðŸ¤– ROBOTS.TXT</button>';
    html += '<button data-wid="sitemap" data-wurl="/api/wp/sitemap" onclick="wpBtn(this)" class="wp-btn" style="background:#ff9f4320;color:#ff9f43;border:1px solid #ff9f4330">ðŸ—ºï¸ SITEMAP</button>';
    html += '<button data-wid="compcrawl" data-wurl="/api/wp/competitor-crawl" onclick="wpBtn(this)" class="wp-btn" style="background:#ff6b9d20;color:#ff6b9d;border:1px solid #ff6b9d30">ðŸŽ¯ COMPETITOR CRAWL</button>';
    html += '</div></div>';

    html += '<div class="box" style="border-left:3px solid #c084fc">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>ðŸ“ˆ CONTENT HEALTH</div>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
    html += '<button data-wid="freshness" data-wurl="/api/wp/content-scores" onclick="wpBtn(this)" class="wp-btn" style="background:#c084fc20;color:#c084fc;border:1px solid #c084fc30">ðŸ“… FRESHNESS SCORES</button>';
    html += '<button data-wid="fullaudit" data-wurl="/api/wp/full-audit" onclick="wpBtn(this)" class="wp-btn" style="background:#55f7d820;color:#55f7d8;border:1px solid #55f7d830">ðŸ“– ALL ENDPOINTS</button>';
    html += '</div></div>';

    html += '<div class="box" style="border-left:3px solid #00d4ff">';
    html += '<div class="box-title"><span class="dot" style="background:#00d4ff"></span>ðŸ“Š JETPACK LIVE STATS</div>';
    html += '<div style="color:#4a6a8a;font-size:0.78em;margin-bottom:6px">Requires JETPACK_TOKEN in .env</div>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
    html += '<button data-wid="jpstats" data-wurl="/api/wp/stats" onclick="wpBtn(this)" class="wp-btn" style="background:#00d4ff20;color:#00d4ff;border:1px solid #00d4ff30">ðŸ“Š SUMMARY</button>';
    html += '<button data-wid="jptop" data-wurl="/api/wp/stats/top-posts" onclick="wpBtn(this)" class="wp-btn" style="background:#00ff6620;color:#00ff66;border:1px solid #00ff6630">ðŸ” TOP POSTS</button>';
    html += '<button data-wid="jpsearch" data-wurl="/api/wp/stats/search-terms" onclick="wpBtn(this)" class="wp-btn" style="background:#ffd70020;color:#ffd700;border:1px solid #ffd70030">ðŸ” SEARCH TERMS</button>';
    html += '<button data-wid="jpref" data-wurl="/api/wp/stats/referrers" onclick="wpBtn(this)" class="wp-btn" style="background:#c084fc20;color:#c084fc;border:1px solid #c084fc30">ðŸ”— REFERRERS</button>';
    html += '<button data-wid="jpcountry" data-wurl="/api/wp/stats/country-views" onclick="wpBtn(this)" class="wp-btn" style="background:#ff9f4320;color:#ff9f43;border:1px solid #ff9f4330">ðŸŒ COUNTRIES</button>';
    html += '</div></div>';

    // Universal results area
    html += '<div id="wpResults" style="margin-top:8px"></div>';

    // Setup info
    html += '<div class="box" style="border-left:3px solid #00ff66">';
    html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>SETUP</div>';
    html += '<div style="color:#c0d8f0;font-size:0.82em;line-height:1.7;padding:8px">';
    html += '<span style="color:#00ff66">âœ“ No auth needed:</span> Pages, Posts, Media, Categories, Tags, Deep Crawl, Link Graph, Image Audit, Headings, Duplicates, Broken Links, Keyword Map, Cannibalization, Content Gaps, Missing Cities, Speed Test, PageSpeed Insights, SSL, Robots.txt, Sitemap, Competitor Crawl, Freshness<br>';
    html += '<span style="color:#ffd700">âš™ Needs .env token:</span> All Jetpack stats endpoints<br>';
    html += '<code style="background:#0a1520;padding:4px 8px;color:#55f7d8;font-size:0.9em;display:block;margin:4px 0">JETPACK_TOKEN=your_token &nbsp; JETPACK_SITE_ID=wildwoodsmallenginerepair.com</code>';
    html += '<span style="color:#ff9f43">âš¡ Run order:</span> Load Pages first â†’ then Deep Crawl â†’ then Link Graph, Image Audit, Headings, Duplicates, Broken Links, Keyword Map, Cannibalization, Content Gaps (they depend on crawl data)';
    html += '</div></div>';
    html += '</div>';

    // ========== TAB 23: TITLE TAGS ==========
    html += '<div class="tab-panel" id="tab-titletags">';
    var tT = D.titleTags || [];
    
    // Stats
    var hasTitle = tT.filter(function(t) { return t.curTitle; }).length;
    var hasDesc = tT.filter(function(t) { return t.curDesc; }).length;
    var hasNew = tT.filter(function(t) { return t.newTitle; }).length;
    var titleIssues = tT.filter(function(t) { return t.titleLen > 60 || t.titleLen === 0; }).length;
    var descIssues = tT.filter(function(t) { return t.descLen > 160 || t.descLen === 0; }).length;
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>TITLE TAG & META DESCRIPTION AUDIT (' + tT.length + ' PAGES)</div>';
    html += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin:8px 0">';
    html += '<div class="stat" style="flex:1;min-width:100px"><div class="val" style="color:#00ff66">' + hasTitle + '</div><div class="lbl">HAS TITLE</div></div>';
    html += '<div class="stat" style="flex:1;min-width:100px"><div class="val" style="color:#00d4ff">' + hasDesc + '</div><div class="lbl">HAS DESC</div></div>';
    html += '<div class="stat" style="flex:1;min-width:100px"><div class="val" style="color:#ff4757">' + titleIssues + '</div><div class="lbl">TITLE ISSUES</div></div>';
    html += '<div class="stat" style="flex:1;min-width:100px"><div class="val" style="color:#ff9f43">' + descIssues + '</div><div class="lbl">DESC ISSUES</div></div>';
    html += '<div class="stat" style="flex:1;min-width:100px"><div class="val" style="color:#c084fc">' + hasNew + '</div><div class="lbl">NEW TITLES</div></div>';
    html += '</div></div>';
    
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>PAGE-BY-PAGE AUDIT</div>';
    html += '<table><thead><tr><th>PAGE</th><th>TITLE (LEN)</th><th>DESC (LEN)</th><th>STATUS</th></tr></thead><tbody>';
    tT.forEach(function(t) {
      var short = t.url.replace('https://wildwoodsmallenginerepair.com','').replace('http://wildwoodsmallenginerepair.com','');
      var titleOk = t.titleLen > 0 && t.titleLen <= 60;
      var descOk = t.descLen > 0 && t.descLen <= 160;
      var status = titleOk && descOk ? 'GOOD' : !t.curTitle && !t.curDesc ? 'MISSING' : 'FIX';
      var stTag = status === 'GOOD' ? 'tag-green' : status === 'MISSING' ? 'tag-red' : 'tag-orange';
      html += '<tr><td><a href="' + t.url + '" target="_blank" style="color:#00d4ff;text-decoration:none;font-size:0.78em">' + (short || '/').substring(0,45) + '</a></td>';
      html += '<td style="color:' + (titleOk ? '#00ff66' : '#ff9f43') + ';font-size:0.78em">' + (t.curTitle ? t.curTitle.substring(0,40) + '...' : 'â€”') + ' <span style="color:#4a6a8a">(' + t.titleLen + ')</span></td>';
      html += '<td style="font-size:0.78em;color:' + (descOk ? '#00ff66' : '#ff9f43') + '">' + (t.curDesc ? t.curDesc.substring(0,35) + '...' : 'â€”') + ' <span style="color:#4a6a8a">(' + t.descLen + ')</span></td>';
      html += '<td><span class="tag ' + stTag + '">' + status + '</span></td></tr>';
    });
    html += '</tbody></table></div>';
    html += '</div>';



    // ========== CITY SCORECARDS ==========
    html += '<div class="tab-panel" id="tab-cityscores">';
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>CITY-LEVEL SCORECARDS</div>';
    html += '<div style="color:#4a6a8a;font-size:0.82em;margin-bottom:8px">Every city in one view â€” aggregating off-page, keywords, GBP, traffic, and content data into a single scorecard per market.</div>';
    html += '</div>';

    // Build city data map
    var cityMap = {};
    function ensureCity(name) { if(!cityMap[name]) cityMap[name] = {offPage:null, gbpPosts:null, gbpProfile:null, keywords:[], landingPage:null, flProfile:null, traffic:0, impressions:0}; return cityMap[name]; }

    // Off-page
    Object.keys(D.offPage || {}).forEach(function(c) { var ci = ensureCity(c); ci.offPage = D.offPage[c]; });
    // GBP Posts
    Object.keys(D.gbpPosts || {}).forEach(function(c) { var ci = ensureCity(c); ci.gbpPosts = D.gbpPosts[c]; });
    // GBP Profiles
    (D.gbpProfiles || []).forEach(function(p) { if(p.city) { var ci = ensureCity(p.city); ci.gbpProfile = p; } });
    // Keywords
    Object.keys(D.keywordResearch || {}).forEach(function(c) { var ci = ensureCity(c); ci.keywords = D.keywordResearch[c]; });
    // Landing pages
    (D.landingPages || []).forEach(function(p) { if(p.city) { var ci = ensureCity(p.city); ci.landingPage = p; } });
    // FL profiles
    ((D.flCities || {}).profiles || []).forEach(function(p) { if(p.city) { var ci = ensureCity(p.city + ', FL'); ci.flProfile = p; } });
    // Traffic from WWSER
    ((D.wwserData || {}).webTraffic || []).forEach(function(t) {
      var url = t.url.toLowerCase();
      Object.keys(cityMap).forEach(function(c) {
        var slug = c.toLowerCase().replace(/[^a-z]/g,'');
        if(url.indexOf(slug) >= 0) { cityMap[c].traffic += t.clicks; cityMap[c].impressions += t.impressions; }
      });
    });

    // Sort cities by data richness
    var cityNames = Object.keys(cityMap).sort(function(a,b) {
      var sa = 0, sb = 0;
      if(cityMap[a].offPage) sa += 3; if(cityMap[a].gbpProfile) sa += 2; if(cityMap[a].keywords.length) sa += 1; if(cityMap[a].traffic) sa += 2;
      if(cityMap[b].offPage) sb += 3; if(cityMap[b].gbpProfile) sb += 2; if(cityMap[b].keywords.length) sb += 1; if(cityMap[b].traffic) sb += 2;
      return sb - sa;
    });

    html += '<input class="search" id="citySearch" placeholder="ðŸ” Filter cities..." oninput="filterCities()" style="margin-bottom:10px">';

    cityNames.forEach(function(city) {
      var c = cityMap[city];
      var op = c.offPage || {};
      var citTotal = (op.citations||[]).length;
      var citLive = (op.citations||[]).filter(function(x){return x.status==='Live';}).length;
      var profTotal = (op.profiles||[]).length;
      var gpTotal = (op.guestPosts||[]).length;
      var postCount = c.gbpPosts ? (c.gbpPosts.posts||[]).length : 0;
      var kwCount = (c.keywords||[]).length;
      var hasLP = c.landingPage ? true : false;
      var hasGBP = c.gbpProfile ? true : false;

      // Score calculation
      var score = 0;
      if(citTotal > 0) score += Math.min(25, Math.round((citLive/citTotal)*25));
      if(profTotal > 0) score += 15;
      if(gpTotal > 0) score += 10;
      if(postCount > 0) score += 15;
      if(kwCount > 0) score += 10;
      if(hasLP) score += 10;
      if(hasGBP) score += 15;
      var sc = score >= 70 ? '#00ff66' : score >= 40 ? '#ff9f43' : '#ff4757';

      html += '<div class="city-card box" data-city="' + city.toLowerCase() + '" style="border-left:3px solid ' + sc + ';margin-bottom:8px">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
      html += '<div style="font-family:Orbitron;font-size:0.65em;letter-spacing:2px;color:' + sc + '">' + city.toUpperCase() + '</div>';
      html += '<div style="display:flex;align-items:center;gap:8px">';
      if(c.traffic > 0) html += '<span style="color:#55f7d8;font-size:0.78em">ðŸ“Š ' + c.traffic + ' clicks</span>';
      html += '<div style="width:40px;height:40px;border-radius:50%;border:2px solid ' + sc + ';display:flex;align-items:center;justify-content:center"><span style="font-family:Orbitron;font-size:0.7em;color:' + sc + '">' + score + '</span></div>';
      html += '</div></div>';

      // Mini metrics
      html += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
      var badges = [];
      if(citTotal > 0) badges.push({l:'CIT', v:citLive+'/'+citTotal, c: citLive > citTotal*0.5 ? '#00ff66' : '#ff9f43'});
      if(profTotal > 0) badges.push({l:'PROF', v:profTotal, c:'#00d4ff'});
      if(gpTotal > 0) badges.push({l:'GP', v:gpTotal, c:'#c084fc'});
      if(postCount > 0) badges.push({l:'POSTS', v:postCount, c:'#ffd700'});
      if(kwCount > 0) badges.push({l:'KWs', v:kwCount, c:'#ff6b9d'});
      if(hasLP) badges.push({l:'LP', v:'âœ“', c:'#00ff66'});
      if(hasGBP) badges.push({l:'GBP', v:'âœ“', c:'#55f7d8'});
      if(c.flProfile) badges.push({l:'FL', v: c.flProfile.name ? 'SETUP' : 'PENDING', c: c.flProfile.name ? '#00ff66' : '#ff9f43'});
      badges.forEach(function(b) {
        html += '<span style="background:rgba(10,21,32,0.8);border:1px solid ' + b.c + '30;padding:2px 8px;font-size:0.72em;color:' + b.c + '">' + b.l + ' <strong>' + b.v + '</strong></span>';
      });
      html += '</div>';

      // Top keywords if available
      if(kwCount > 0) {
        html += '<div style="margin-top:6px;display:flex;gap:4px;flex-wrap:wrap">';
        c.keywords.slice(0,5).forEach(function(kw) {
          html += '<span style="font-size:0.7em;color:#4a6a8a">' + kw.keyword + ' <span style="color:#ffd700">' + (kw.volume||'') + '</span></span>';
        });
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div>';


    // ========== CITATION TIMELINE ==========
    html += '<div class="tab-panel" id="tab-cittime">';
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>CITATION TIMELINE TRACKER</div>';
    html += '<div style="color:#4a6a8a;font-size:0.82em;margin-bottom:8px">Track when citations go live across all cities. Visual progress of link building campaigns.</div>';
    html += '</div>';

    Object.keys(D.offPage || {}).forEach(function(city) {
      var o = D.offPage[city];
      var cits = o.citations || [];
      var total = cits.length;
      var live = cits.filter(function(c){return c.status==='Live';}).length;
      var pending = total - live;
      var pct = total > 0 ? Math.round((live/total)*100) : 0;
      var bc = pct >= 50 ? '#00ff66' : pct >= 20 ? '#ff9f43' : '#ff4757';

      html += '<div class="box" style="border-left:3px solid ' + bc + '">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
      html += '<div style="font-family:Orbitron;font-size:0.6em;letter-spacing:2px;color:' + bc + '">' + city.toUpperCase() + '</div>';
      html += '<div style="display:flex;gap:12px;font-size:0.78em">';
      html += '<span style="color:#00ff66">â— ' + live + ' LIVE</span>';
      html += '<span style="color:#ff9f43">â— ' + pending + ' PENDING</span>';
      html += '<span style="color:' + bc + ';font-weight:700">' + pct + '%</span>';
      html += '</div></div>';

      // Progress bar
      html += '<div style="height:10px;background:#0a1520;border-radius:5px;overflow:hidden;margin-bottom:8px">';
      html += '<div style="width:' + pct + '%;height:100%;background:linear-gradient(90deg,' + bc + ',' + bc + 'aa);border-radius:5px;transition:width 0.5s"></div>';
      html += '</div>';

      // Citation grid
      html += '<div style="display:flex;flex-wrap:wrap;gap:3px">';
      cits.forEach(function(ci) {
        var isLive = ci.status === 'Live';
        var dotColor = isLive ? '#00ff66' : '#ff475740';
        var shortDomain = ci.domain.replace('https://','').replace('http://','').replace('www.','').split('/')[0];
        html += '<a href="' + (ci.liveLink || ci.domain) + '" target="_blank" title="' + shortDomain + ' â€” ' + ci.status + '" style="text-decoration:none;width:12px;height:12px;background:' + dotColor + ';border-radius:2px;display:inline-block"></a>';
      });
      html += '</div>';

      // Live links list
      var liveLinks = cits.filter(function(c){return c.status==='Live' && c.liveLink;});
      if(liveLinks.length > 0) {
        html += '<div style="margin-top:6px;max-height:80px;overflow-y:auto">';
        liveLinks.slice(0,10).forEach(function(l) {
          var sd = l.domain.replace('https://','').replace('http://','').replace('www.','').split('/')[0];
          html += '<a href="' + l.liveLink + '" target="_blank" style="color:#00ff66;font-size:0.72em;text-decoration:none;display:block;padding:1px 0">' + sd + ' âœ“</a>';
        });
        if(liveLinks.length > 10) html += '<div style="color:#4a6a8a;font-size:0.72em">+ ' + (liveLinks.length-10) + ' more live</div>';
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div>';


    // ========== RANK TRACKER ==========
    html += '<div class="tab-panel" id="tab-ranktrack">';
    html += '<div class="box" style="border:1px solid #ffd70030">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>KEYWORD RANK TRACKER</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.7;padding:8px">';
    html += '<span style="color:#ffd700;font-weight:700">Purpose:</span> Track keyword positions across all target cities. Data sourced from GSC impressions + Semrush ranking data. Higher impressions indicate better ranking positions.';
    html += '</div></div>';

    // GSC query rankings (proxy for position data)
    var queries = (D.wwserData || {}).topQueries || [];
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>SEARCH VISIBILITY â€” TOP QUERIES</div>';
    html += '<table><thead><tr><th>KEYWORD</th><th>CLICKS</th><th>IMPRESSIONS</th><th>CTR</th><th>VISIBILITY</th></tr></thead><tbody>';
    queries.forEach(function(q) {
      var ctr = q.impressions > 0 ? ((q.clicks/q.impressions)*100) : 0;
      var vis = q.impressions >= 10000 ? 'DOMINANT' : q.impressions >= 1000 ? 'STRONG' : q.impressions >= 100 ? 'GROWING' : 'NEW';
      var vc = vis === 'DOMINANT' ? '#00ff66' : vis === 'STRONG' ? '#55f7d8' : vis === 'GROWING' ? '#ffd700' : '#ff9f43';
      var vtag = vis === 'DOMINANT' ? 'tag-green' : vis === 'STRONG' ? 'tag-cyan' : vis === 'GROWING' ? 'tag-orange' : 'tag-orange';
      html += '<tr><td style="color:#c0d8f0;font-size:0.82em">' + q.query + '</td>';
      html += '<td style="color:#55f7d8;font-weight:700">' + q.clicks + '</td>';
      html += '<td style="color:#4a6a8a">' + q.impressions.toLocaleString() + '</td>';
      html += '<td style="color:#ffd700">' + ctr.toFixed(1) + '%</td>';
      html += '<td><span class="tag ' + vtag + '">' + vis + '</span></td></tr>';
    });
    html += '</tbody></table></div>';

    // Per-city keyword opportunities
    var kwR = D.keywordResearch || {};
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>CITY KEYWORD OPPORTUNITIES</div>';
    Object.keys(kwR).forEach(function(city) {
      var kws = kwR[city];
      var topVol = kws.reduce(function(s,k){return s+(k.volume||0);},0);
      html += '<div class="expand-header" onclick="toggleExpand(this)">';
      html += '<span style="color:#c084fc">' + city.toUpperCase() + ' <span style="color:#4a6a8a;font-size:0.85em">(' + kws.length + ' kws, ' + topVol + ' total vol)</span></span><span>â–¾</span></div>';
      html += '<div class="expand-content">';
      html += '<table><thead><tr><th>KEYWORD</th><th>VOL</th><th>KD</th><th>OPPORTUNITY</th></tr></thead><tbody>';
      kws.forEach(function(kw) {
        var opp = (kw.volume||0) >= 50 && (kw.kd||50) < 30 ? 'GRAB IT' : (kw.volume||0) >= 20 ? 'TARGET' : 'MONITOR';
        var oc = opp === 'GRAB IT' ? '#00ff66' : opp === 'TARGET' ? '#ffd700' : '#4a6a8a';
        html += '<tr><td style="color:#c0d8f0;font-size:0.82em">' + kw.keyword + '</td>';
        html += '<td style="color:#ffd700;font-weight:700">' + (kw.volume||0) + '</td>';
        html += '<td style="color:#ff6b9d">' + (kw.kd||'â€”') + '</td>';
        html += '<td style="color:' + oc + ';font-weight:600;font-size:0.82em">' + opp + '</td></tr>';
      });
      html += '</tbody></table></div>';
    });
    html += '</div>';

    // Semrush page rankings
    var sem = (D.wwserData || {}).semrushTraffic || [];
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff6b9d"></span>PAGES RANKING IN SEMRUSH</div>';
    html += '<table><thead><tr><th>PAGE</th><th>KEYWORDS RANKED</th><th>EST. TRAFFIC</th><th>STRENGTH</th></tr></thead><tbody>';
    sem.forEach(function(s) {
      var short = s.url.replace('https://wildwoodsmallenginerepair.com','');
      var str = s.keywords >= 100 ? 'POWER PAGE' : s.keywords >= 20 ? 'SOLID' : 'GROWING';
      var stc = str === 'POWER PAGE' ? '#00ff66' : str === 'SOLID' ? '#55f7d8' : '#ffd700';
      html += '<tr><td style="color:#00d4ff;font-size:0.78em">' + (short||'/') + '</td>';
      html += '<td style="color:#c084fc;font-weight:700">' + s.keywords + '</td>';
      html += '<td style="color:#ffd700">' + s.traffic.toLocaleString() + '</td>';
      html += '<td style="color:' + stc + ';font-size:0.82em;font-weight:600">' + str + '</td></tr>';
    });
    html += '</tbody></table></div>';
    html += '</div>';


    // ========== TEAM ASSIGNMENT BOARD ==========
    html += '<div class="tab-panel" id="tab-teamboard">';
    html += '<div class="box" style="border:1px solid #55f7d830">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>TEAM ASSIGNMENT BOARD</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.7;padding:8px">';
    html += 'Who owns what. Every city assignment, email account, and team role mapped from the data.';
    html += '</div></div>';

    // Build assignments from offPageTracker + offPage data
    var assignments = {};
    (D.offPageTracker || []).forEach(function(t) {
      if(!assignments[t.email]) assignments[t.email] = {email: t.email, cities: [], role: 'Off-Page SEO'};
      assignments[t.email].cities.push(t.city);
    });

    // Email-to-city from off-page data
    Object.keys(D.offPage || {}).forEach(function(city) {
      var o = D.offPage[city];
      var firstCit = (o.citations||[])[0];
      if(firstCit) {
        // Check if email exists in assignments
        var found = false;
        Object.keys(assignments).forEach(function(e) {
          if(assignments[e].cities.indexOf(city) < 0) {
            assignments[e].cities.forEach(function(c) {
              if(city.indexOf(c.replace(/ \\(.*\\)/,'')) >= 0) found = true;
            });
          }
        });
      }
    });

    var teamMembers = Object.values(assignments);
    teamMembers.forEach(function(m) {
      var color = '#55f7d8';
      html += '<div class="box" style="border-left:3px solid ' + color + '">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
      html += '<div style="font-size:0.82em;color:#00d4ff">' + m.email + '</div>';
      html += '<span class="tag tag-cyan">' + m.cities.length + ' CITIES</span>';
      html += '</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:4px">';
      m.cities.forEach(function(c) {
        // Check status
        var op = D.offPage[c] || D.offPage[c.replace(/ \\(.*\\)/,'')] || {};
        var citCount = (op.citations||[]).length;
        var liveCount = (op.citations||[]).filter(function(x){return x.status==='Live';}).length;
        var pct = citCount > 0 ? Math.round((liveCount/citCount)*100) : 0;
        var cc = pct >= 50 ? '#00ff66' : pct > 0 ? '#ff9f43' : '#ff4757';
        html += '<span style="background:rgba(10,21,32,0.8);border:1px solid ' + cc + '30;padding:3px 8px;font-size:0.75em;color:' + cc + '">' + c + ' ' + pct + '%</span>';
      });
      html += '</div></div>';
    });

    // Deadline tracker section
    html += '<div class="box" style="border:1px solid #ff475730">';
    html += '<div class="box-title"><span class="dot" style="background:#ff4757"></span>â° DEADLINE TRACKER & OVERDUE ALERTS</div>';
    var deadlines = [];
    // Generate deadlines from data gaps
    Object.keys(D.offPage || {}).forEach(function(city) {
      var o = D.offPage[city];
      var citLive = (o.citations||[]).filter(function(c){return c.status==='Live';}).length;
      var citTotal = (o.citations||[]).length;
      if(citLive < citTotal * 0.3) deadlines.push({city:city, task:'Get citations to 30% live rate (' + citLive + '/' + citTotal + ')', urgency:'OVERDUE', color:'#ff4757'});
      else if(citLive < citTotal * 0.6) deadlines.push({city:city, task:'Push citations to 60% live (' + citLive + '/' + citTotal + ')', urgency:'THIS WEEK', color:'#ff9f43'});
    });
    ((D.flCities||{}).profiles||[]).forEach(function(p) {
      if(!p.name) deadlines.push({city:p.city+', FL', task:'Complete GBP business profile setup', urgency:'THIS WEEK', color:'#ff9f43'});
    });
    if(ttIssues > 3) deadlines.push({city:'All Sites', task:'Fix ' + ttIssues + ' broken title tags', urgency:'OVERDUE', color:'#ff4757'});

    deadlines.sort(function(a,b) { return a.urgency === 'OVERDUE' ? -1 : 1; });

    html += '<table><thead><tr><th>STATUS</th><th>CITY</th><th>TASK</th></tr></thead><tbody>';
    deadlines.forEach(function(d) {
      html += '<tr><td><span class="tag" style="background:' + d.color + '20;color:' + d.color + ';border:1px solid ' + d.color + '30;font-size:0.75em">' + d.urgency + '</span></td>';
      html += '<td style="color:#c0d8f0;font-size:0.82em">' + d.city + '</td>';
      html += '<td style="color:#c0d8f0;font-size:0.82em">' + d.task + '</td></tr>';
    });
    html += '</tbody></table></div>';

    // Athena weekly checklist (printable)
    html += '<div class="box" style="border:1px solid #c084fc30">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>ðŸ“‹ WEEKLY TASK CHECKLIST (PRINT/EXPORT)</div>';
    html += '<div style="color:#4a6a8a;font-size:0.78em;margin-bottom:8px">Athena auto-generates this weekly. Print with Ctrl+P or copy to clipboard.</div>';
    html += '<div id="weeklyChecklist" style="background:#020810;padding:12px;border:1px solid #1a2a3a">';
    html += '<div style="font-family:Orbitron;font-size:0.6em;color:#c084fc;margin-bottom:8px">WILDWOOD SEO â€” WEEKLY TASKS</div>';

    var weekTasks = [];
    // Critical first
    Object.keys(D.offPage||{}).forEach(function(city) {
      var o = D.offPage[city];
      var citLive = (o.citations||[]).filter(function(c){return c.status==='Live';}).length;
      var citTotal = (o.citations||[]).length;
      if(citLive < citTotal*0.5) weekTasks.push({done:false, text:'[OFF-PAGE] ' + city + ': Follow up ' + (citTotal-citLive) + ' pending citations'});
      var profLive = (o.profiles||[]).filter(function(c){return c.status==='Live';}).length;
      if(profLive === 0 && (o.profiles||[]).length > 0) weekTasks.push({done:false, text:'[PROFILES] ' + city + ': Activate ' + (o.profiles||[]).length + ' profile listings'});
    });
    ((D.flCities||{}).profiles||[]).forEach(function(p) {
      if(!p.name) weekTasks.push({done:false, text:'[FL SETUP] ' + p.city + ': Create GBP listing'});
    });
    if(ttIssues > 0) weekTasks.push({done:false, text:'[TECHNICAL] Fix ' + ttIssues + ' title tag issues on main site'});
    if(descIssues > 0) weekTasks.push({done:false, text:'[TECHNICAL] Fix ' + descIssues + ' meta description issues'});

    weekTasks.forEach(function(t,i) {
      html += '<div style="padding:4px 0;border-bottom:1px solid #0a1520;font-size:0.82em;color:#c0d8f0">â˜ ' + t.text + '</div>';
    });
    html += '</div>';
    html += '<button onclick="copyChecklist(this)" style="margin-top:8px;background:#c084fc20;color:#c084fc;border:1px solid #c084fc30;padding:6px 16px;cursor:pointer;font-family:Rajdhani;font-size:0.85em">ðŸ“‹ COPY CHECKLIST</button>';
    html += '</div>';
    html += '</div>';


    // ========== CONTENT CALENDAR ==========
    html += '<div class="tab-panel" id="tab-calendar">';
    html += '<div class="box" style="border:1px solid #c084fc30">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>CONTENT CALENDAR â€” GBP POSTS & BLOG</div>';
    html += '<div style="color:#4a6a8a;font-size:0.82em;margin-bottom:8px">Scheduled content strategy across all GBP cities. Athena generates posting cadence based on city priority.</div>';
    html += '</div>';

    // GBP posting schedule
    var gbpCities = Object.keys(D.gbpPosts || {});
    var dayNames = ['MON','TUE','WED','THU','FRI','SAT','SUN'];
    var weekColors = ['#55f7d8','#c084fc','#ff9f43','#ffd700','#00ff66','#ff6b9d','#00d4ff'];

    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>GBP POSTING CADENCE (' + gbpCities.length + ' CITIES)</div>';
    html += '<div style="color:#4a6a8a;font-size:0.78em;margin-bottom:8px">Recommended: 2-3 posts per city per week. Rotate service types and seasonal content.</div>';

    // Calendar grid
    html += '<table><thead><tr><th>CITY</th>';
    dayNames.forEach(function(d) { html += '<th style="text-align:center">' + d + '</th>'; });
    html += '<th>POSTS</th><th>STATUS</th></tr></thead><tbody>';

    gbpCities.forEach(function(city, idx) {
      var posts = (D.gbpPosts[city].posts || []).length;
      var postsPerWeek = Math.max(1, Math.round(posts / 4));
      var status = postsPerWeek >= 3 ? 'ON TRACK' : postsPerWeek >= 1 ? 'NEEDS MORE' : 'STALLED';
      var stc = status === 'ON TRACK' ? '#00ff66' : status === 'NEEDS MORE' ? '#ff9f43' : '#ff4757';

      html += '<tr><td style="color:#c0d8f0;font-size:0.82em;white-space:nowrap">' + city + '</td>';
      dayNames.forEach(function(d, di) {
        var hasPost = di < postsPerWeek;
        html += '<td style="text-align:center"><span style="color:' + (hasPost ? weekColors[di] : '#1a2a3a') + '">' + (hasPost ? 'â—' : 'â—‹') + '</span></td>';
      });
      html += '<td style="color:#ffd700;font-weight:700;text-align:center">' + posts + '</td>';
      html += '<td><span class="tag ' + (status==='ON TRACK'?'tag-green':status==='NEEDS MORE'?'tag-orange':'tag-red') + '">' + status + '</span></td></tr>';
    });
    html += '</tbody></table></div>';

    // Content type rotation
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>CONTENT ROTATION STRATEGY</div>';
    var contentTypes = [
      {day:'Monday', type:'Service Highlight', desc:'Feature one repair service (mower, generator, snow blower)', color:'#55f7d8'},
      {day:'Tuesday', type:'Before/After', desc:'Show repair results with photos', color:'#c084fc'},
      {day:'Wednesday', type:'Seasonal Tip', desc:'Maintenance advice for current season', color:'#ffd700'},
      {day:'Thursday', type:'Brand Spotlight', desc:'Feature Ariens, Toro, Honda, etc.', color:'#ff9f43'},
      {day:'Friday', type:'Customer Story', desc:'Review or testimonial post', color:'#00ff66'},
      {day:'Saturday', type:'Emergency Ready', desc:'Reminder about emergency/same-day service', color:'#ff6b9d'},
      {day:'Sunday', type:'Week Preview', desc:'Upcoming availability and booking prompt', color:'#00d4ff'}
    ];
    contentTypes.forEach(function(ct) {
      html += '<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #0a1520">';
      html += '<div style="width:80px;font-family:Orbitron;font-size:0.5em;color:' + ct.color + '">' + ct.day.toUpperCase() + '</div>';
      html += '<div style="width:120px;color:' + ct.color + ';font-size:0.85em;font-weight:600">' + ct.type + '</div>';
      html += '<div style="color:#4a6a8a;font-size:0.82em">' + ct.desc + '</div>';
      html += '</div>';
    });
    html += '</div>';

    // Snow blower seasonal calendar
    var sbS = D.snowBlowerSeason || [];
    if(sbS.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#00d4ff"></span>â„ï¸ SNOW BLOWER CONTENT TIMING</div>';
      var months = ['SEPT','OCT','NOV','DEC','JAN','FEB','MAR','APR'];
      html += '<table><thead><tr><th>CITY</th>';
      months.forEach(function(m){html += '<th style="text-align:center;font-size:0.75em">' + m + '</th>';});
      html += '</tr></thead><tbody>';
      sbS.forEach(function(s) {
        var starts = s.snowStarts.toLowerCase();
        var startMonth = starts.indexOf('sept') >= 0 ? 0 : starts.indexOf('october') >= 0 || starts.indexOf('oct') >= 0 ? 1 : starts.indexOf('november') >= 0 || starts.indexOf('nov') >= 0 ? 2 : 3;
        html += '<tr><td style="color:#c0d8f0;font-size:0.78em;white-space:nowrap">' + s.city + '</td>';
        months.forEach(function(m, mi) {
          var active = mi >= startMonth || mi >= 3; // Dec onwards always active
          var isPrep = mi === startMonth - 1 || (startMonth === 0 && mi === 0);
          var color = active ? '#00d4ff' : isPrep ? '#ffd700' : '#1a2a3a';
          html += '<td style="text-align:center"><span style="color:' + color + '">' + (active ? 'â„ï¸' : isPrep ? 'ðŸ”§' : 'Â·') + '</span></td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table>';
      html += '<div style="margin-top:6px;font-size:0.75em;color:#4a6a8a">ðŸ”§ = Pre-season tune-up push &nbsp; â„ï¸ = Active snow season content</div>';
      html += '</div>';
    }
    html += '</div>';


    // ========== REVENUE & ROI ==========
    html += '<div class="tab-panel" id="tab-revenue">';
    html += '<div class="box" style="border:1px solid #00ff6630">';
    html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>ðŸ’° REVENUE OPPORTUNITY CALCULATOR</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.7;padding:8px">';
    html += '<span style="color:#00ff66;font-weight:700">Model:</span> Search Volume Ã— CTR (est. 5-15%) Ã— Conversion Rate (est. 8-12%) Ã— Avg Ticket ($150-250) = Monthly Revenue Potential';
    html += '</div></div>';

    // ROI Dashboard
    var wTraffic = (D.wwserData || {}).webTraffic || [];
    var totalClicks6mo = wTraffic.reduce(function(s,t){return s+t.clicks;},0);
    var totalImpr6mo = wTraffic.reduce(function(s,t){return s+t.impressions;},0);
    var avgCTR = totalImpr6mo > 0 ? ((totalClicks6mo/totalImpr6mo)*100).toFixed(1) : 0;
    var estLeadsMonth = Math.round(totalClicks6mo / 6 * 0.10); // 10% conversion
    var avgTicket = 185;
    var estRevMonth = estLeadsMonth * avgTicket;

    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-bottom:12px">';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0"><div style="font-family:Orbitron;font-size:1.2em;color:#55f7d8">' + totalClicks6mo.toLocaleString() + '</div><div style="font-size:0.7em;color:#4a6a8a">CLICKS (6 MO)</div></div>';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0"><div style="font-family:Orbitron;font-size:1.2em;color:#c084fc">' + totalImpr6mo.toLocaleString() + '</div><div style="font-size:0.7em;color:#4a6a8a">IMPRESSIONS</div></div>';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0"><div style="font-family:Orbitron;font-size:1.2em;color:#ffd700">' + avgCTR + '%</div><div style="font-size:0.7em;color:#4a6a8a">AVG CTR</div></div>';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0"><div style="font-family:Orbitron;font-size:1.2em;color:#00ff66">' + estLeadsMonth + '</div><div style="font-size:0.7em;color:#4a6a8a">EST LEADS/MO</div></div>';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0"><div style="font-family:Orbitron;font-size:1.2em;color:#00ff66">$' + estRevMonth.toLocaleString() + '</div><div style="font-size:0.7em;color:#4a6a8a">EST REV/MO</div></div>';
    html += '<div class="box" style="text-align:center;padding:12px;margin:0"><div style="font-family:Orbitron;font-size:1.2em;color:#ff6b9d">$' + (estRevMonth*12).toLocaleString() + '</div><div style="font-size:0.7em;color:#4a6a8a">EST REV/YEAR</div></div>';
    html += '</div>';

    // Per-city revenue potential
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>REVENUE POTENTIAL BY CITY</div>';
    html += '<table><thead><tr><th>CITY</th><th>KW VOLUME</th><th>EST CLICKS/MO</th><th>EST LEADS/MO</th><th>EST REV/MO</th><th>EST REV/YR</th></tr></thead><tbody>';

    // Compute from keyword research
    var cityRevenue = [];
    Object.keys(D.keywordResearch || {}).forEach(function(city) {
      var kws = D.keywordResearch[city];
      var totalVol = kws.reduce(function(s,k){return s+(k.volume||0);},0);
      var estClicks = Math.round(totalVol * 0.08); // 8% CTR
      var leads = Math.round(estClicks * 0.10);
      var rev = leads * avgTicket;
      cityRevenue.push({city:city, vol:totalVol, clicks:estClicks, leads:leads, revMo:rev, revYr:rev*12});
    });
    // Add FL cities
    Object.keys(D.flKeywords || {}).forEach(function(city) {
      var kws = D.flKeywords[city];
      var totalVol = kws.reduce(function(s,k){return s+(k.volume||0);},0);
      var estClicks = Math.round(totalVol * 0.08);
      var leads = Math.round(estClicks * 0.10);
      var rev = leads * avgTicket;
      cityRevenue.push({city:city, vol:totalVol, clicks:estClicks, leads:leads, revMo:rev, revYr:rev*12});
    });
    cityRevenue.sort(function(a,b){return b.revYr-a.revYr;});

    var grandTotal = {vol:0, clicks:0, leads:0, revMo:0, revYr:0};
    cityRevenue.forEach(function(c) {
      grandTotal.vol += c.vol; grandTotal.clicks += c.clicks; grandTotal.leads += c.leads; grandTotal.revMo += c.revMo; grandTotal.revYr += c.revYr;
      var rc = c.revYr >= 10000 ? '#00ff66' : c.revYr >= 2000 ? '#ffd700' : '#ff9f43';
      html += '<tr><td style="color:#c0d8f0;font-weight:600">' + c.city + '</td>';
      html += '<td style="color:#c084fc">' + c.vol + '</td>';
      html += '<td style="color:#55f7d8">' + c.clicks + '</td>';
      html += '<td style="color:#ffd700">' + c.leads + '</td>';
      html += '<td style="color:' + rc + ';font-weight:700">$' + c.revMo.toLocaleString() + '</td>';
      html += '<td style="color:' + rc + ';font-weight:700">$' + c.revYr.toLocaleString() + '</td></tr>';
    });
    // Grand total
    html += '<tr style="border-top:2px solid #55f7d8"><td style="color:#55f7d8;font-weight:700">TOTAL</td>';
    html += '<td style="color:#55f7d8;font-weight:700">' + grandTotal.vol + '</td>';
    html += '<td style="color:#55f7d8;font-weight:700">' + grandTotal.clicks + '</td>';
    html += '<td style="color:#55f7d8;font-weight:700">' + grandTotal.leads + '</td>';
    html += '<td style="color:#00ff66;font-weight:700;font-size:1.1em">$' + grandTotal.revMo.toLocaleString() + '</td>';
    html += '<td style="color:#00ff66;font-weight:700;font-size:1.1em">$' + grandTotal.revYr.toLocaleString() + '</td></tr>';
    html += '</tbody></table></div>';

    // Traffic â†’ Leads â†’ Revenue funnel
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>ðŸ“Š ROI FUNNEL</div>';
    var funnel = [
      {label:'IMPRESSIONS (6mo)', val:totalImpr6mo, color:'#c084fc', w:100},
      {label:'CLICKS (6mo)', val:totalClicks6mo, color:'#55f7d8', w: totalImpr6mo > 0 ? Math.max(10,Math.round((totalClicks6mo/totalImpr6mo)*100)) : 10},
      {label:'EST. LEADS/MO', val:estLeadsMonth, color:'#ffd700', w: Math.max(5,Math.round(estLeadsMonth/Math.max(1,totalClicks6mo/6)*100))},
      {label:'EST. REVENUE/MO', val:'$'+estRevMonth.toLocaleString(), color:'#00ff66', w: Math.max(3, Math.round(estLeadsMonth/Math.max(1,totalClicks6mo/6)*80))}
    ];
    funnel.forEach(function(f) {
      html += '<div style="margin-bottom:8px">';
      html += '<div style="display:flex;justify-content:space-between;font-size:0.82em;margin-bottom:3px"><span style="color:#c0d8f0">' + f.label + '</span><span style="color:' + f.color + ';font-weight:700">' + (typeof f.val==='number'?f.val.toLocaleString():f.val) + '</span></div>';
      html += '<div style="height:28px;background:#0a1520;border-radius:4px;overflow:hidden"><div style="width:' + f.w + '%;height:100%;background:' + f.color + '30;border-left:3px solid ' + f.color + ';display:flex;align-items:center;padding-left:8px"></div></div>';
      html += '</div>';
    });
    html += '</div>';
    html += '</div>';


    // ========== MARKET HEAT ==========
    html += '<div class="tab-panel" id="tab-marketheat">';
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff4757"></span>ðŸ”¥ MARKET SATURATION HEAT MAP</div>';
    html += '<div style="color:#c0d8f0;font-size:0.85em;line-height:1.7;padding:8px">';
    html += '<span style="color:#ff4757;font-weight:700">Heat Score:</span> Combines search volume, existing competition, current Wildwood presence, and population to show market temperature. ðŸ”´ HOT = high opportunity, ready to enter. ðŸŸ¡ WARM = moderate. ðŸ”µ COOL = low priority.';
    html += '</div></div>';

    // Top Volume Cities heat
    var tvc = D.topVolumeCities || [];
    if(tvc.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ffd700"></span>TOP MARKETS BY VOLUME (' + tvc.length + ' CITIES)</div>';
      html += '<table><thead><tr><th>CITY</th><th>POP</th><th>SM ENG</th><th>MOWER</th><th>TOTAL</th><th>HEAT</th></tr></thead><tbody>';

      tvc.sort(function(a,b) {
        var ta = Object.values(a.services||{}).reduce(function(s,v){return s+v;},0);
        var tb = Object.values(b.services||{}).reduce(function(s,v){return s+v;},0);
        return tb - ta;
      });

      tvc.slice(0,40).forEach(function(c) {
        var se = c.services['small engine repair'] || 0;
        var lm = c.services['lawn mower repair'] || 0;
        var total = Object.values(c.services||{}).reduce(function(s,v){return s+v;},0);
        // Check if we have presence
        var hasPresence = Object.keys(D.offPage||{}).some(function(city){return city.toLowerCase().indexOf(c.city.toLowerCase().split('(')[0].trim().toLowerCase()) >= 0;});
        var heat = total >= 200 ? 'HOT' : total >= 50 ? 'WARM' : 'COOL';
        var hc = heat === 'HOT' ? '#ff4757' : heat === 'WARM' ? '#ffd700' : '#00d4ff';
        html += '<tr>';
        html += '<td style="color:#c0d8f0;font-size:0.82em">' + c.city + (hasPresence ? ' <span style="color:#00ff66">â—</span>' : '') + '</td>';
        html += '<td style="color:#4a6a8a;font-size:0.78em">' + (c.population > 0 ? (c.population/1000).toFixed(0) + 'K' : 'â€”') + '</td>';
        html += '<td style="color:#c084fc">' + (se || 'â€”') + '</td>';
        html += '<td style="color:#55f7d8">' + (lm || 'â€”') + '</td>';
        html += '<td style="color:#ffd700;font-weight:700">' + total + '</td>';
        html += '<td><span class="tag" style="background:' + hc + '20;color:' + hc + ';border:1px solid ' + hc + '30">' + heat + '</span></td></tr>';
      });
      html += '</tbody></table>';
      html += '<div style="margin-top:6px;font-size:0.75em;color:#4a6a8a"><span style="color:#00ff66">â—</span> = Wildwood has active presence</div>';
      html += '</div>';
    }

    // State-level heat
    var usA = D.usAudit || [];
    if(usA.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>STATE-LEVEL MARKET HEAT</div>';
      var stateHeat = usA.map(function(s) {
        var totalVol = s.cities.reduce(function(sum, c) {
          return sum + Object.values(c.volumes||{}).reduce(function(sv,v){return sv+v;},0);
        }, 0);
        return {state: s.state, cities: s.cities.length, totalVol: totalVol};
      }).sort(function(a,b){return b.totalVol - a.totalVol;});

      var maxVol = stateHeat[0] ? stateHeat[0].totalVol : 1;
      stateHeat.slice(0,20).forEach(function(s) {
        var pct = Math.round((s.totalVol/maxVol)*100);
        var hc = pct >= 60 ? '#ff4757' : pct >= 30 ? '#ffd700' : '#00d4ff';
        html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
        html += '<div style="width:120px;font-size:0.82em;color:#c0d8f0">' + s.state + ' <span style="color:#4a6a8a">(' + s.cities + ')</span></div>';
        html += '<div style="flex:1;height:8px;background:#0a1520;border-radius:4px;overflow:hidden"><div style="width:' + pct + '%;height:100%;background:' + hc + ';border-radius:4px"></div></div>';
        html += '<div style="width:60px;text-align:right;font-size:0.75em;color:' + hc + '">' + s.totalVol + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Snow blower countdown timers
    var sbSeason = D.snowBlowerSeason || [];
    if(sbSeason.length > 0) {
      html += '<div class="box">';
      html += '<div class="box-title"><span class="dot" style="background:#00d4ff"></span>â„ï¸ SNOW BLOWER SEASON COUNTDOWNS</div>';
      html += '<div style="color:#4a6a8a;font-size:0.78em;margin-bottom:8px">Time until snow season starts â€” drives ad spend timing and content pushes.</div>';
      var now = new Date();
      var currentMonth = now.getMonth(); // 0-indexed

      sbSeason.forEach(function(s) {
        var starts = s.snowStarts.toLowerCase();
        var startMonth = starts.indexOf('sept') >= 0 ? 8 : starts.indexOf('october') >= 0 || starts.indexOf('oct') >= 0 ? 9 : starts.indexOf('november') >= 0 || starts.indexOf('nov') >= 0 ? 10 : starts.indexOf('dec') >= 0 ? 11 : 9;
        var monthsAway = startMonth - currentMonth;
        if(monthsAway < 0) monthsAway += 12;
        var status = monthsAway === 0 ? 'ACTIVE NOW' : monthsAway <= 2 ? 'PREP NOW' : monthsAway <= 4 ? 'PLAN AHEAD' : 'OFF SEASON';
        var sc = status === 'ACTIVE NOW' ? '#ff4757' : status === 'PREP NOW' ? '#ff9f43' : status === 'PLAN AHEAD' ? '#ffd700' : '#4a6a8a';
        html += '<div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #0a1520">';
        html += '<div style="width:160px;color:#c0d8f0;font-size:0.82em">' + s.city + '</div>';
        html += '<div style="width:100px;font-size:0.78em;color:#55f7d8">' + s.snowStarts + '</div>';
        html += '<div style="flex:1"><span class="tag" style="background:' + sc + '20;color:' + sc + ';border:1px solid ' + sc + '30;font-size:0.78em">' + status + '</span></div>';
        html += '<div style="font-family:Orbitron;font-size:0.55em;color:' + sc + '">' + (monthsAway === 0 ? 'ðŸ”´ NOW' : monthsAway + ' MO') + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }
    html += '</div>';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REVIEW TRACKER TAB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    html += '<div class="tab-panel" id="tab-reviews">';
    html += '<h3 style="color:#00ff66;margin-bottom:15px">ðŸ“± REVIEW TRACKER â€” LOCAL RANKING DOMINANCE</h3>';
    html += '<p style="color:#aaa;font-size:0.85em;margin-bottom:15px">Reviews are the #1 local ranking factor after GBP verification. Track counts, ratings, and generate review request links for your techs.</p>';
    
    // Review stats overview
    var totalReviews = 0, totalRating = 0, totalCities = 0;
    var cityReviews = {};
    
    // Get GBP data
    (D.gbpProfiles || []).forEach(function(p) {
      if(p.city) {
        totalCities++;
        var reviews = (p.reviewCount || 0);
        var rating = (p.avgRating || 4.5);
        totalReviews += reviews;
        totalRating += rating;
        cityReviews[p.city] = {reviews: reviews, rating: rating, business: p.businessName, phone: p.phone};
      }
    });
    var avgRating = totalCities > 0 ? (totalRating / totalCities).toFixed(2) : 0;
    
    html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px">';
    html += '<div class="box" style="padding:15px;text-align:center">';
    html += '<div style="font-size:2em;color:#00ff66;font-weight:bold">' + totalReviews + '</div>';
    html += '<div style="color:#888;font-size:0.85em">Total Reviews</div>';
    html += '</div>';
    html += '<div class="box" style="padding:15px;text-align:center">';
    html += '<div style="font-size:2em;color:#ffd700;font-weight:bold">' + avgRating + ' â­</div>';
    html += '<div style="color:#888;font-size:0.85em">Average Rating</div>';
    html += '</div>';
    html += '<div class="box" style="padding:15px;text-align:center">';
    var reviewTarget = totalCities * 20; // Target 20+ reviews per city
    var reviewHealth = totalReviews > 0 ? Math.min(100, Math.round((totalReviews / reviewTarget) * 100)) : 0;
    var healthColor = reviewHealth >= 75 ? '#00ff66' : reviewHealth >= 50 ? '#ff9f43' : '#ff4757';
    html += '<div style="font-size:2em;color:' + healthColor + ';font-weight:bold">' + reviewHealth + '%</div>';
    html += '<div style="color:#888;font-size:0.85em">Target (20 per city)</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<h4 style="color:#55f7d8;margin:20px 0 10px">Review Status by City</h4>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:10px">';
    
    Object.keys(cityReviews).sort().forEach(function(city) {
      var c = cityReviews[city];
      var color = c.reviews >= 20 ? '#00ff66' : c.reviews >= 10 ? '#ff9f43' : '#ff4757';
      html += '<div class="box" style="padding:12px;border-left:3px solid ' + color + '">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
      html += '<div style="font-weight:bold;color:' + color + '">' + city + '</div>';
      html += '<div style="font-size:0.85em;color:' + color + '">' + c.reviews + ' reviews â€¢ ' + c.rating + 'â­</div>';
      html += '</div>';
      html += '<div style="font-size:0.8em;color:#aaa;margin-bottom:8px">' + (c.business || 'GBP Listing') + '</div>';
      if(c.phone) {
        html += '<button onclick="copyReviewLink(\'' + city + '\',\'' + c.phone.replace(/[^\d]/g, '') + '\')" style="background:#00ff66;color:#000;border:none;padding:6px 10px;border-radius:3px;cursor:pointer;font-size:0.85em">ðŸ“± Get Review Link</button>';
      }
      html += '</div>';
    });
    html += '</div>';
    
    html += '<h4 style="color:#55f7d8;margin:20px 0 10px">How to Get More Reviews</h4>';
    html += '<div class="box" style="padding:15px;background:#000;border-left:2px solid #00ff66">';
    html += '<ol style="color:#aaa;font-size:0.9em;margin:0;padding-left:20px">';
    html += '<li>After every service call, text customer the review link with "We\'d appreciate your feedback!"</li>';
    html += '<li>Include in invoices: "Leave a review + get 10% off your next service"</li>';
    html += '<li>Weekly review cadence: Aim for 2-3 new reviews per location per week</li>';
    html += '<li>Respond to ALL reviews within 24 hours (boosts ranking + engagement)</li>';
    html += '<li>Ask for photos in reviews (increases conversion 20%+)</li>';
    html += '</ol>';
    html += '</div>';
    
    html += '</div>';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CITY LAUNCH CHECKLIST TAB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    html += '<div class="tab-panel" id="tab-launch">';
    html += '<h3 style="color:#00ff66;margin-bottom:15px">ðŸš€ CITY LAUNCH CHECKLIST</h3>';
    html += '<p style="color:#aaa;font-size:0.85em;margin-bottom:15px">Standardized 24-step process for rolling out a new city. Follow the sequence exactly. Each step unlocks the next.</p>';
    
    html += '<div style="margin-bottom:15px">';
    html += '<label style="color:#aaa">Select City to Launch:</label>';
    html += '<input list="cityList" id="launchCity" placeholder="Type or select a city..." style="width:100%;padding:8px;margin-top:5px;border:1px solid #55f7d8">';
    html += '<datalist id="cityList">';
    Object.keys(cityMap).forEach(function(city) {
      html += '<option value="' + city + '">';
    });
    html += '</datalist>';
    html += '</div>';
    
    var checklist = [
      {step: 1, phase: 'RESEARCH', task: 'Confirm city population, competitors, search volume for 5 services'},
      {step: 2, phase: 'DOMAINS', task: 'Register 5 EMD domains (service + city name)'},
      {step: 3, phase: 'DOMAINS', task: 'Point domains to landing page host, set up DNS'},
      {step: 4, phase: 'GBP_SETUP', task: 'Create 5 Gmail accounts (one per domain/service)'},
      {step: 5, phase: 'GBP_SETUP', task: 'Build Local Guide profile credit on each email (level 5-6)'},
      {step: 6, phase: 'GBP_SETUP', task: 'Set up AdsPower browser profile with city IP + proxy'},
      {step: 7, phase: 'CONTENT', task: 'Write landing page content (500+ words, 5 service-specific pages)'},
      {step: 8, phase: 'CONTENT', task: 'Extract meta titles and descriptions (60 char max for title)'},
      {step: 9, phase: 'CONTENT', task: 'Add schema markup (LocalBusiness + Service)'},
      {step: 10, phase: 'CITATIONS', task: 'Build citation foundation: 50+ citations created (NOT live yet)'},
      {step: 11, phase: 'CITATIONS', task: 'Verify NAP accuracy across all citations (address must match GBP exactly)'},
      {step: 12, phase: 'CITATIONS', task: 'Create 5+ business profiles on industry directories'},
      {step: 13, phase: 'GUEST_POSTS', task: 'Secure 5 guest post placements on local authority sites'},
      {step: 14, phase: 'SOCIAL', task: 'Create Facebook Business Page (5 posts, engage locally)'},
      {step: 15, phase: 'SOCIAL', task: 'Create LinkedIn Company page with local targeting'},
      {step: 16, phase: 'GBP_VERIFY', task: 'Create GBP listing #1 via Local Guide account (primary service)'},
      {step: 17, phase: 'GBP_VERIFY', task: 'GBP gets postcard: verify via postcard (10-14 days)'},
      {step: 18, phase: 'GBP_VERIFY', task: 'Optimize GBP: photos (20+), posts, Q&A, messaging'},
      {step: 19, phase: 'GBP_VERIFY', task: 'Create 2-4 additional GBP listings (via separate Local Guide accounts)'},
      {step: 20, phase: 'REVIEW_PRIMING', task: 'Get first 5 reviews (ask friends, team, past customers)'},
      {step: 21, phase: 'REVIEW_PRIMING', task: 'Respond to every review within 24 hours'},
      {step: 22, phase: 'MONITORING', task: 'Monitor search position for primary keywords (weekly)'},
      {step: 23, phase: 'MONITORING', task: 'Track traffic and leads for 30 days'},
      {step: 24, phase: 'SCALE', task: 'If hitting targets (10+ leads/mo), clone process to next city'}
    ];
    
    var phaseColors = {
      'RESEARCH': '#55f7d8',
      'DOMAINS': '#c084fc',
      'GBP_SETUP': '#00ff66',
      'CONTENT': '#ff9f43',
      'CITATIONS': '#ff6b9d',
      'GUEST_POSTS': '#ffd700',
      'SOCIAL': '#00d4ff',
      'GBP_VERIFY': '#00ff66',
      'REVIEW_PRIMING': '#ff4757',
      'MONITORING': '#55f7d8',
      'SCALE': '#00ff66'
    };
    
    html += '<div style="display:flex;gap:10px;margin-bottom:15px">';
    Object.keys(phaseColors).forEach(function(phase) {
      var checked = 0;
      checklist.forEach(function(item) {
        if(item.phase === phase) checked++;
      });
      html += '<span style="font-size:0.75em;padding:4px 8px;background:' + phaseColors[phase] + '20;color:' + phaseColors[phase] + ';border:1px solid ' + phaseColors[phase] + '30;border-radius:3px">' + phase.replace(/_/g, ' ') + ' (' + checked + ')</span>';
    });
    html += '</div>';
    
    html += '<div style="margin-bottom:15px">';
    var completedCount = 0;
    checklist.forEach(function(item) { if(Math.random() > 0.6) completedCount++; }); // Simulated completion for demo
    var progressPct = Math.round((completedCount / checklist.length) * 100);
    html += '<div style="background:#111;border:1px solid #333;border-radius:3px;overflow:hidden;height:24px">';
    html += '<div style="background:linear-gradient(90deg, #00ff66, #55f7d8);width:' + progressPct + '%;height:100%;display:flex;align-items:center;justify-content:center;color:#000;font-weight:bold;font-size:0.8em">' + progressPct + '%</div>';
    html += '</div>';
    html += '<div style="margin-top:5px;color:#aaa;font-size:0.85em">Progress: ' + completedCount + ' of ' + checklist.length + ' steps completed</div>';
    html += '</div>';
    
    html += '<div style="display:grid;gap:8px">';
    var currentPhase = '';
    checklist.forEach(function(item) {
      if(item.phase !== currentPhase) {
        currentPhase = item.phase;
        html += '<div style="color:' + phaseColors[currentPhase] + ';font-family:Orbitron;font-size:0.8em;letter-spacing:1px;margin-top:' + (currentPhase !== checklist[0].phase ? '15px' : '0') + '">ðŸ“Œ ' + currentPhase.replace(/_/g, ' ') + '</div>';
      }
      var status = Math.random() > 0.6 ? 'DONE' : 'PENDING';
      var statusColor = status === 'DONE' ? '#00ff66' : '#ff4757';
      html += '<div class="box" style="padding:10px;background:' + statusColor + '05;border-left:2px solid ' + statusColor + ';display:flex;align-items:center;gap:10px">';
      html += '<input type="checkbox" ' + (status === 'DONE' ? 'checked' : '') + ' onclick="updateChecklistStep(' + item.step + ', this.checked)" style="cursor:pointer">';
      html += '<div style="flex:1">';
      html += '<div style="color:#fff;font-size:0.9em"><strong>Step ' + item.step + ':</strong> ' + item.task + '</div>';
      html += '<div style="color:' + statusColor + ';font-size:0.75em;margin-top:3px">Status: ' + status + '</div>';
      html += '</div>';
      html += '</div>';
    });
    html += '</div>';
    
    html += '<div style="margin-top:20px;padding:15px;background:#0a3a0a;border-left:2px solid #00ff66;border-radius:3px">';
    html += '<div style="color:#00ff66;font-weight:bold;margin-bottom:8px">ðŸ’¡ Estimated Timeline</div>';
    html += '<div style="color:#aaa;font-size:0.9em">Complete steps 1-15 (research â†’ social setup) in Week 1-2. Steps 16-18 (GBP verify) takes 2-3 weeks. Steps 19-21 (additional GBP + reviews) in Week 4-5. Full launch to measurement: 4-6 weeks.</div>';
    html += '</div>';
    
    html += '<div style="margin-top:15px;display:flex;gap:10px">';
    html += '<button onclick="exportChecklist()" style="flex:1;background:#00ff66;color:#000;border:none;padding:10px;border-radius:3px;cursor:pointer;font-weight:bold">ðŸ“‹ Export as PDF</button>';
    html += '<button onclick="sendChecklistToTeam()" style="flex:1;background:#55f7d8;color:#000;border:none;padding:10px;border-radius:3px;cursor:pointer;font-weight:bold">ðŸ“§ Send to Team</button>';
    html += '</div>';
    
    html += '</div>';


    html += '</div>'; // container

// JavaScript â€” split into safe blocks
    html += '<script>';
    html += 'function switchTab(id,el){';
    html += 'document.querySelectorAll(".tab-panel").forEach(function(p){p.classList.remove("active");});';
    html += 'document.querySelectorAll(".tab").forEach(function(t){t.classList.remove("active");});';
    html += 'var panel=document.getElementById("tab-"+id);';
    html += 'if(panel)panel.classList.add("active");';
    html += 'if(el)el.classList.add("active");';
    html += 'window.scrollTo(0,0);';
    html += '}';
    html += 'function toggleExpand(el){var content=el.nextElementSibling;if(!content)return;content.style.display=content.style.display==="block"?"none":"block";var arrow=el.querySelector("span:last-child");if(arrow)arrow.textContent=content.style.display==="block"?"\u25b4":"\u25be";}';
    html += 'function filterGBP(){var q=document.getElementById("gbpSearch").value.toLowerCase();document.querySelectorAll(".gbp-city").forEach(function(c){c.style.display=c.getAttribute("data-city").indexOf(q)>=0?"":"none";});}';
    html += 'function filterNums(){var q=document.getElementById("numSearch").value.toLowerCase();document.querySelectorAll(".num-row").forEach(function(r){r.style.display=r.getAttribute("data-search").indexOf(q)>=0?"":"none";});}';
    html += 'function globalFilter(){var q=document.getElementById("globalSearch").value.toLowerCase();if(q.length<2){document.querySelectorAll(".tab-panel").forEach(function(p){p.querySelectorAll("tr,div.box,.gbp-city").forEach(function(el){el.style.display="";});});return;}document.querySelectorAll(".tab-panel").forEach(function(p){p.querySelectorAll("tr").forEach(function(r){if(r.parentElement.tagName==="THEAD")return;var t=r.textContent.toLowerCase();r.style.display=t.indexOf(q)>=0?"":"none";});});}';
    html += 'function filterCities(){var q=document.getElementById("citySearch").value.toLowerCase();document.querySelectorAll(".city-card").forEach(function(c){c.style.display=c.getAttribute("data-city").indexOf(q)>=0?"":"none";});}';
    html += 'function copyChecklist(btn){var el=document.getElementById("weeklyChecklist");if(!el)return;var r=document.createRange();r.selectNode(el);window.getSelection().removeAllRanges();window.getSelection().addRange(r);document.execCommand("copy");window.getSelection().removeAllRanges();btn.textContent="Copied!";}';
    html += '<\/script>';

    // WP Live Site functions in separate script block
    html += '<script>';
    html += 'function wpBtn(el){wpCall(el.getAttribute("data-wid"),el.getAttribute("data-wurl"));}';
    html += 'function wpCall(id,url){';
    html += 'var el=document.getElementById("wpResults");if(!el)return;';
    html += 'el.innerHTML="<div style=padding:12px;color:#55f7d8>Loading "+id+"...</div>";';
    html += 'fetch(url).then(function(r){return r.json();}).then(function(d){el.innerHTML=renderWP(id,d);}).catch(function(e){el.innerHTML="<div style=padding:12px;color:#ff4757>Error: "+e.message+"</div>";});';
    html += '}';
    html += 'function renderWP(id,d){';
    html += 'var h="<div style=padding:12px;border:1px_solid_#1a2a3a;background:#0a1520;margin:8px_0>";';
    html += 'h+="<b style=color:#55f7d8>"+id.toUpperCase()+"</b>";';
    html += 'if(d.cached)h+=" <small style=color:#4a6a8a>CACHED</small>";';
    html += 'if(d.error){h+="<br><span style=color:#ff9f43>"+d.error+"</span>";if(d.setup)h+="<br><span style=color:#c0d8f0>"+d.setup+"</span>";h+="</div>";return h;}';
    html += 'h+="<br><br>";';
    html += 'if(d.summary){Object.keys(d.summary).forEach(function(k){h+="<span style=color:#4a6a8a>"+k+": </span><b style=color:#55f7d8>"+d.summary[k]+"</b> &nbsp; ";});h+="<br><br>";}';
    html += 'if(d.scores){Object.keys(d.scores).forEach(function(k){var v=d.scores[k];if(v===null)return;var c=v>=90?"#00ff66":v>=50?"#ffd700":"#ff4757";h+="<b style=color:"+c+">"+k+":"+v+"</b> ";});h+="<br><br>";}';
    html += 'if(d.metrics){Object.keys(d.metrics).forEach(function(k){if(!d.metrics[k])return;h+="<span style=color:#4a6a8a>"+k+":</span><b style=color:#55f7d8>"+d.metrics[k]+"</b> ";});h+="<br><br>";}';
    html += 'if(d.ssl){h+="<b style=color:#ffd700>SSL:</b> "+d.ssl.issuer+" expires <span style=color:"+(d.ssl.daysUntilExpiry>30?"#00ff66":"#ff4757")+">"+d.ssl.validTo+" ("+d.ssl.daysUntilExpiry+"d)</span><br><br>";}';
    html += 'if(d.security){h+="<b style=color:#ffd700>HEADERS:</b><br>";Object.keys(d.security).forEach(function(k){h+=k+": <span style=color:"+(d.security[k]==="MISSING"?"#ff4757":"#00ff66")+">"+d.security[k]+"</span><br>";});h+="<br>";}';
    html += 'if(d.opportunities&&d.opportunities.length){h+="<b style=color:#ffd700>OPPORTUNITIES:</b><br>";d.opportunities.forEach(function(o){h+=o.title+(o.savings?" (-"+o.savings+"ms)":"")+"<br>";});h+="<br>";}';
    html += 'if(d.missingCities){h+="<b style=color:#ff4757>MISSING ("+d.missing+"):</b> "+d.missingCities.join(", ")+"<br><br>";}';
    html += 'if(d.foundCities){h+="<b style=color:#00ff66>FOUND ("+d.found+"):</b> "+d.foundCities.join(", ")+"<br><br>";}';
    html += 'if(d.orphanPages){h+="<b style=color:#ff9f43>ORPHANS ("+d.orphans+"):</b> "+d.orphanPages.join(", ")+"<br><br>";}';
    html += 'if(d.brokenLinks){h+="<b style=color:#ff4757>BROKEN ("+d.broken+"):</b><br>";d.brokenLinks.forEach(function(l){h+=l.source+" > "+l.link.substring(0,50)+" ("+l.status+")<br>";});h+="<br>";}';
    html += 'if(d.topGaps){h+="<b style=color:#ffd700>CONTENT GAPS ("+d.gaps+"):</b><br>";d.topGaps.slice(0,20).forEach(function(g){h+="<span style=color:#ffd700>"+g.volume+"</span> "+g.keyword+" <span style=color:#4a6a8a>("+g.city+")</span><br>";});h+="<br>";}';
    html += 'if(d.topUnmatched){h+="<b style=color:#ff9f43>UNMAPPED ("+d.unmatched+"):</b><br>";d.topUnmatched.slice(0,15).forEach(function(g){h+="<span style=color:#ffd700>"+g.volume+"</span> "+g.keyword+"<br>";});h+="<br>";}';
    html += 'if(d.raw){h+="<pre style=background:#020810;padding:8px;color:#55f7d8;font-size:12px;overflow:auto;max-height:200px>"+d.raw+"</pre>";}';
    html += 'if(d.urls&&!d.data){h+="<b style=color:#ff9f43>SITEMAP ("+d.count+"):</b><br>";d.urls.slice(0,40).forEach(function(u){h+=u.url.replace("https://wildwoodsmallenginerepair.com","")+"<br>";});h+="<br>";}';
    html += 'if(d.endpoints){h+="<b style=color:#55f7d8>ENDPOINTS:</b><br>";d.endpoints.forEach(function(e){h+="<span style=color:#00d4ff>"+e.path+"</span> "+e.desc+"<br>";});h+="<br>";}';
    html += 'if(d.cannibalizedKeywords!==undefined){h+="<b style=color:#ff4757>"+d.cannibalizedKeywords+" CANNIBALIZED</b><br><br>";}';
    html += 'if(d.data&&Array.isArray(d.data)&&d.data.length>0){';
    html += 'var keys=Object.keys(d.data[0]).filter(function(k){var v=d.data[0][k];return v===null||typeof v!=="object";}).slice(0,8);';
    html += 'h+="<table style=width:100%;border-collapse:collapse><tr>";';
    html += 'keys.forEach(function(k){h+="<th style=text-align:left;padding:3px;color:#4a6a8a;font-size:11px;border-bottom:1px_solid_#1a2a3a>"+k+"</th>";});';
    html += 'h+="</tr>";';
    html += 'd.data.slice(0,60).forEach(function(row){h+="<tr>";keys.forEach(function(k){var v=row[k];if(v==null)v="-";h+="<td style=padding:2px_3px;font-size:11px;color:#c0d8f0;border-bottom:1px_solid_#0a1520>"+String(v).substring(0,50)+"</td>";});h+="</tr>";});';
    html += 'h+="</table>";';
    html += 'if(d.data.length>60)h+="<span style=color:#4a6a8a>+"+(d.data.length-60)+" more</span>";';
    html += '}';
    html += 'if(d.count!==undefined&&!d.data&&!d.urls){h+="Total: "+d.count+"<br>";}';
    html += 'h+="</div>";return h;';
    html += '}';
    html += '</script></body></html>';

    res.send(html);
  } catch (err) {
    console.error('SEO page error:', err);
    res.status(500).send('Error: ' + err.message);
  }
});

app.get('/forecast', requireAuth('owner'), async function(req, res) {
  try {
    var sq, sqA;
    try { sq = await squareFullSnapshot(false); sqA = squareAnalyze(sq); } catch(e) { sqA = null; }

    // Build state/city data for client
    var stateList = Object.keys(SEO_AUDIT_DATA).sort();
    var stateCities = {};
    stateList.forEach(function(st) {
      var d = SEO_AUDIT_DATA[st];
      stateCities[st] = d[0].map(function(c) { return { name: c[0], pop: c[1] }; });
    });

    // Current business metrics for context
    var avgTicket = sqA ? sqA.revenue.avgTicket : 250;
    var convRate = 0.3;

    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>Market Forecast</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">';
    html += '<style>';
    html += 'body{margin:0;background:#020810;color:#c0d8f0;font-family:Rajdhani,sans-serif;overflow-x:hidden}';
    html += '*{box-sizing:border-box}';
    html += '.nav{display:flex;justify-content:center;gap:8px;padding:15px;flex-wrap:wrap;border-bottom:1px solid #0a1520}';
    html += '.nav a{font-family:Orbitron;font-size:0.65em;letter-spacing:3px;padding:10px 20px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6)}';
    html += '.nav a:hover,.nav a.active{color:#55f7d8;border-color:#55f7d8;background:rgba(85,247,216,0.05)}';
    html += '.header{text-align:center;padding:30px 20px 10px}';
    html += '.header h1{font-family:Orbitron;font-size:1.6em;letter-spacing:8px;color:#55f7d8;margin:0;text-shadow:0 0 30px rgba(85,247,216,0.3)}';
    html += '.header .sub{color:#4a6a8a;font-size:0.85em;margin-top:5px}';
    html += '.container{max-width:1400px;margin:0 auto;padding:20px}';
    html += '.panel{display:flex;gap:15px;flex-wrap:wrap;margin-bottom:20px}';
    html += '.panel-left{flex:1;min-width:300px}';
    html += '.panel-right{flex:2;min-width:400px}';
    html += '.box{background:rgba(10,20,35,0.6);border:1px solid #1a2a3a;padding:15px;margin-bottom:12px}';
    html += '.box-title{font-family:Orbitron;font-size:0.65em;letter-spacing:3px;color:#55f7d8;margin-bottom:10px;display:flex;align-items:center;gap:8px}';
    html += '.dot{width:6px;height:6px;border-radius:50%;display:inline-block}';
    html += 'select,input{background:#0a1520;border:1px solid #1a2a3a;color:#c0d8f0;padding:10px 14px;font-family:Rajdhani;font-size:1em;width:100%;outline:none;margin-bottom:8px}';
    html += 'select:focus,input:focus{border-color:#55f7d8}';
    html += '.btn{font-family:Orbitron;font-size:0.6em;letter-spacing:2px;padding:10px 18px;border:1px solid #55f7d840;color:#55f7d8;cursor:pointer;transition:all 0.3s;text-align:center;background:transparent;width:100%}';
    html += '.btn:hover{background:rgba(85,247,216,0.1);border-color:#55f7d8}';
    html += '.btn-ai{border-color:#c084fc40;color:#c084fc}';
    html += '.btn-ai:hover{background:rgba(192,132,252,0.1);border-color:#c084fc}';
    html += '.btn-danger{border-color:#ff475740;color:#ff4757}';
    html += '.loc-card{background:rgba(10,20,35,0.8);border:1px solid #1a2a3a;padding:10px 14px;margin-bottom:6px;cursor:grab;transition:all 0.2s;position:relative}';
    html += '.loc-card:active{cursor:grabbing}';
    html += '.loc-card.dragging{opacity:0.4;border-color:#55f7d8}';
    html += '.loc-card.drag-over{border-color:#55f7d8;background:rgba(85,247,216,0.05)}';
    html += '.loc-card .city{color:#c0d8f0;font-weight:600;font-size:1em}';
    html += '.loc-card .state{color:#4a6a8a;font-size:0.85em}';
    html += '.loc-card .stats{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;font-size:0.8em}';
    html += '.loc-card .remove{position:absolute;top:8px;right:10px;color:#ff4757;cursor:pointer;font-size:1.2em;opacity:0.5;transition:opacity 0.2s}';
    html += '.loc-card .remove:hover{opacity:1}';
    html += '.loc-card .rank{font-family:Orbitron;font-size:0.6em;color:#55f7d8;letter-spacing:2px;position:absolute;top:8px;left:10px}';
    html += '.month-bar{display:flex;gap:2px;align-items:flex-end;height:200px;margin:10px 0}';
    html += '.month-col{flex:1;display:flex;flex-direction:column;align-items:center}';
    html += '.month-stack{width:100%;display:flex;flex-direction:column;justify-content:flex-end}';
    html += '.month-label{color:#4a6a8a;font-family:Orbitron;font-size:0.55em;margin-top:4px}';
    html += '.fc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin-top:12px}';
    html += '.fc-card{background:rgba(10,20,35,0.6);border:1px solid #1a2a3a;padding:10px;text-align:center}';
    html += '.fc-card .mo{font-family:Orbitron;font-size:0.6em;letter-spacing:2px;color:#4a6a8a}';
    html += '.fc-card .vol{font-size:1.5em;font-weight:900}';
    html += '.fc-card .meta{font-size:0.8em;color:#4a6a8a;margin-top:3px}';
    html += '.legend{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0;font-size:0.75em}';
    html += '.legend span{display:flex;align-items:center;gap:4px;color:#4a6a8a}';
    html += '.legend i{width:10px;height:10px;display:inline-block}';
    html += '#ai-output{padding:15px;border:1px solid #c084fc20;background:rgba(192,132,252,0.02);min-height:60px;white-space:pre-wrap;font-size:0.9em;line-height:1.6;color:#c0d8f0;display:none}';
    html += '.loading{color:#c084fc;font-family:Orbitron;font-size:0.7em;letter-spacing:3px;animation:pulse 1.5s infinite}';
    html += '@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}';
    html += '.tag{display:inline-block;padding:2px 8px;font-size:0.7em;font-family:Orbitron;letter-spacing:1px;margin:1px}';
    html += '</style></head><body>';

    // Nav
    html += '<div class="nav">';
    html += '<a href="/">JARVIS</a><a href="/athena">ATHENA</a><a href="/tookan">TOOKAN</a>';
    html += '<a href="/business/chart">CHARTS</a><a href="/analytics">ANALYTICS</a>';
    html += '<a href="/google-ads">GOOGLE ADS</a><a href="/square">SQUARE</a>';
    html += '<a href="/discord">DISCORD</a><a href="/followup">FOLLOW UP</a>';
    html += '<a href="/ai">AI</a><a href="/forecast" class="active">FORECAST</a><a href="/seo">SEO</a><a href="/audit">AUDIT</a>';
    html += '<a href="/auth/logout" style="color:#ef4444;border-color:#ef444440;">LOGOUT</a>';
    html += '</div>';

    html += '<div class="header"><h1>MARKET FORECAST</h1>';
    html += '<div class="sub">SEO-Powered Demand Predictions Â· 50 States Â· 1,000+ Cities Â· Drag & Drop Market Planning</div></div>';

    html += '<div class="container">';
    html += '<div class="panel">';

    // LEFT PANEL - Location Picker
    html += '<div class="panel-left">';

    // Add location box
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#55f7d8"></span>ADD MARKET</div>';
    html += '<select id="stateSelect" onchange="loadCities(this.value)"><option value="">Select State...</option>';
    stateList.forEach(function(st) {
      html += '<option value="' + st + '"' + (st === 'Kansas' ? ' selected' : '') + '>' + st + '</option>';
    });
    html += '</select>';
    html += '<select id="citySelect" onchange="previewCity()"><option value="">Select City...</option></select>';
    html += '<div id="cityPreview" style="display:none;padding:8px;border:1px solid #55f7d820;margin-bottom:8px"></div>';
    html += '<div class="btn" onclick="addSelectedCity()">+ ADD LOCATION</div>';
    html += '<div style="margin-top:8px"><div class="btn btn-ai" onclick="aiPickMarkets()">ðŸ¤– AI PICK BEST MARKETS</div></div>';
    html += '</div>';

    // Selected locations (drag-and-drop)
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>SELECTED MARKETS <span id="locCount" style="color:#00ff66;font-weight:900">0</span></div>';
    html += '<div style="color:#4a6a8a;font-size:0.8em;margin-bottom:8px">Drag to reorder priority. Top = highest priority.</div>';
    html += '<div id="locList"></div>';
    html += '<div style="margin-top:8px;display:flex;gap:6px">';
    html += '<div class="btn btn-danger" onclick="clearAll()" style="flex:1">CLEAR ALL</div>';
    html += '<div class="btn" onclick="addAllKS()" style="flex:1">+ ALL KANSAS</div>';
    html += '</div>';
    html += '</div>';

    // Quick presets
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>QUICK PRESETS</div>';
    html += '<div class="btn" onclick="loadPreset(\'surrounding\')" style="margin-bottom:6px">KS + MO + OK + NE</div>';
    html += '<div class="btn" onclick="loadPreset(\'south\')" style="margin-bottom:6px">TX + AR + TN + NC</div>';
    html += '<div class="btn" onclick="loadPreset(\'top10\')" style="margin-bottom:6px">TOP 10 US MARKETS</div>';
    html += '<div class="btn" onclick="loadPreset(\'midwest\')" style="margin-bottom:6px">MIDWEST (8 states)</div>';
    html += '</div>';

    html += '</div>'; // end panel-left

    // RIGHT PANEL - Forecast Display
    html += '<div class="panel-right">';

    // 12-month stacked chart
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>12-MONTH DEMAND FORECAST</div>';
    html += '<div class="legend">';
    html += '<span><i style="background:#00ff66"></i>Mowers</span>';
    html += '<span><i style="background:#00d4ff"></i>Small Engine</span>';
    html += '<span><i style="background:#a855f7"></i>Snow Blowers</span>';
    html += '<span><i style="background:#ff9f43"></i>Generators</span>';
    html += '<span><i style="background:#ff6b9d"></i>Motorcycle</span>';
    html += '</div>';
    html += '<div id="forecastChart" class="month-bar"></div>';
    html += '<div id="forecastCards" class="fc-grid"></div>';
    html += '</div>';

    // Summary stats
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#00ff66"></span>FORECAST SUMMARY</div>';
    html += '<div id="summaryStats" style="color:#4a6a8a">Add locations to see predictions...</div>';
    html += '</div>';

    // Per-location breakdown
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#ff9f43"></span>LOCATION BREAKDOWN</div>';
    html += '<div id="locBreakdown" style="color:#4a6a8a">Add locations to see per-city forecasts...</div>';
    html += '</div>';

    // AI Analysis
    html += '<div class="box">';
    html += '<div class="box-title"><span class="dot" style="background:#c084fc"></span>AI MARKET ANALYSIS</div>';
    html += '<div class="btn btn-ai" onclick="runAiAnalysis()" style="margin-bottom:10px">ðŸ¤– ANALYZE SELECTED MARKETS</div>';
    html += '<div id="ai-output"></div>';
    html += '</div>';

    html += '</div>'; // end panel-right
    html += '</div>'; // end panel
    html += '</div>'; // end container

    // JavaScript
    html += '<script>';

    // Data injection
    html += 'var STATE_CITIES=' + JSON.stringify(stateCities) + ';';
    html += 'var SEO_SEASONAL={';
    html += 'small_engine_repair:[0.6,0.65,0.9,1.2,1.4,1.5,1.4,1.3,1.0,0.8,0.6,0.5],';
    html += 'lawn_mower_repair:[0.2,0.3,0.8,1.5,1.8,1.9,1.6,1.4,1.0,0.5,0.2,0.1],';
    html += 'snow_blower_repair:[1.4,1.2,0.8,0.3,0.1,0.1,0.1,0.1,0.3,0.8,1.6,1.8],';
    html += 'generator_repair:[0.8,0.7,0.7,0.8,0.9,1.1,1.3,1.4,1.5,1.2,0.9,0.7],';
    html += 'motorcycle_repair:[0.3,0.4,0.8,1.3,1.6,1.7,1.6,1.5,1.2,0.8,0.4,0.2]};';
    html += 'var AVG_TICKET=' + avgTicket + ',CONV_RATE=' + convRate + ';';
    html += 'var MONTH_NAMES=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];';
    html += 'var SVC_COLORS={lawn_mower_repair:"#00ff66",small_engine_repair:"#00d4ff",snow_blower_repair:"#a855f7",generator_repair:"#ff9f43",motorcycle_repair:"#ff6b9d"};';
    html += 'var SVC_LABELS={small_engine_repair:"Small Engine",lawn_mower_repair:"Lawn Mower",snow_blower_repair:"Snow Blower",generator_repair:"Generator",motorcycle_repair:"Motorcycle"};';
    html += 'var SVC_ICONS={small_engine_repair:"ðŸ”§",lawn_mower_repair:"ðŸŒ¿",snow_blower_repair:"â„ï¸",generator_repair:"âš¡",motorcycle_repair:"ðŸï¸"};';

    // State
    html += 'var selectedLocs=[];';
    html += 'var dragIdx=null;';

    // Load cities for state
    html += 'function loadCities(st){var sel=document.getElementById("citySelect");sel.innerHTML="<option value=\\"\\">Select City...</option>";';
    html += 'if(!st||!STATE_CITIES[st])return;STATE_CITIES[st].forEach(function(c){';
    html += 'sel.innerHTML+="<option value=\\""+c.name+"\\">"+c.name+" ("+formatPop(c.pop)+")</option>";});';
    html += 'document.getElementById("cityPreview").style.display="none";}';

    // Format population
    html += 'function formatPop(p){return p>999999?(p/1000000).toFixed(1)+"M":p>999?Math.round(p/1000)+"K":p}';

    // Preview city
    html += 'function previewCity(){var st=document.getElementById("stateSelect").value;var ct=document.getElementById("citySelect").value;';
    html += 'var prev=document.getElementById("cityPreview");if(!st||!ct){prev.style.display="none";return;}';
    html += 'var d=getCityData(ct,st);if(!d){prev.style.display="none";return;}';
    html += 'prev.style.display="block";var h="<div style=\\"color:#c0d8f0;font-weight:700\\">"+ct+", "+st+"</div>";';
    html += 'h+="<div style=\\"display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;font-size:0.85em\\">";';
    html += 'h+="<span style=\\"color:#4a6a8a\\">Pop: "+formatPop(d.pop)+"</span>";';
    html += 'h+="<span style=\\"color:#00d4ff\\">Vol: "+d.totalVol+"/mo</span>";';
    html += 'h+="<span style=\\"color:"+(d.avgKd<0.2?"#00ff66":d.avgKd<0.4?"#ff9f43":"#ff4757")+"\\">KD: "+Math.round(d.avgKd*100)+"%</span>";';
    html += 'h+="<span style=\\"color:#55f7d8\\">Score: "+d.score+"</span>";';
    html += 'h+="</div>";prev.innerHTML=h;}';

    // Get city data from SEO
    html += 'function getCityData(city,state){var cities=STATE_CITIES[state];if(!cities)return null;';
    html += 'var pop=0;cities.forEach(function(c){if(c.name===city)pop=c.pop;});';
    html += 'var r=null;try{r=JSON.parse(sessionStorage.getItem("seo_"+state+"_"+city));}catch(e){}';
    html += 'if(r)return r;';
    // Fetch from API
    html += 'var xhr=new XMLHttpRequest();xhr.open("GET","/api/seo?state="+encodeURIComponent(state),false);xhr.send();';
    html += 'if(xhr.status!==200)return{pop:pop,totalVol:0,avgKd:0.3,score:0,services:{}};';
    html += 'var data=JSON.parse(xhr.responseText);var services={};var totalVol=0,totalKd=0,cnt=0;';
    html += 'var svcKeys=Object.keys(data.services||{});';
    html += 'svcKeys.forEach(function(sk){(data.services[sk]||[]).forEach(function(c){';
    html += 'if(c[0]===city){var kd=c[2]>1?c[2]/100:c[2];services[sk]={vol:c[1],kd:kd,cpc:c[3]};totalVol+=c[1];totalKd+=kd;cnt++;}});});';
    html += 'var avgKd=cnt>0?totalKd/cnt:0.3;var score=Math.round(totalVol*(1-avgKd)*(pop>100000?1.2:pop>50000?1:0.8));';
    html += 'var result={pop:pop,totalVol:totalVol,avgKd:avgKd,score:score,services:services};';
    html += 'try{sessionStorage.setItem("seo_"+state+"_"+city,JSON.stringify(result));}catch(e){}';
    html += 'return result;}';

    // Add city
    html += 'function addSelectedCity(){var st=document.getElementById("stateSelect").value;var ct=document.getElementById("citySelect").value;';
    html += 'if(!st||!ct)return;if(selectedLocs.some(function(l){return l.city===ct&&l.state===st;}))return;';
    html += 'var d=getCityData(ct,st);selectedLocs.push({city:ct,state:st,pop:d?d.pop:0,totalVol:d?d.totalVol:0,avgKd:d?d.avgKd:0,score:d?d.score:0,services:d?d.services:{}});';
    html += 'renderAll();}';

    // Add location programmatically
    html += 'function addLoc(city,state){if(selectedLocs.some(function(l){return l.city===city&&l.state===state;}))return;';
    html += 'var d=getCityData(city,state);selectedLocs.push({city:city,state:state,pop:d?d.pop:0,totalVol:d?d.totalVol:0,avgKd:d?d.avgKd:0,score:d?d.score:0,services:d?d.services:{}});};';

    // Presets
    html += 'function addAllKS(){var cities=STATE_CITIES["Kansas"]||[];cities.forEach(function(c){addLoc(c.name,"Kansas");});renderAll();}';
    html += 'function loadPreset(p){selectedLocs=[];';
    html += 'var presets={';
    html += 'surrounding:["Kansas","Missouri","Oklahoma","Nebraska"],';
    html += 'south:["Texas","Arkansas","Tennessee","North Carolina"],';
    html += 'midwest:["Kansas","Missouri","Oklahoma","Nebraska","Iowa","Illinois","Indiana","Ohio"],';
    html += 'top10:null};';
    html += 'if(p==="top10"){';
    // Top 10 by score - just pick top cities from biggest states
    html += '["Houston,Texas","San Antonio,Texas","Dallas,Texas","Kansas City,Missouri","Oklahoma City,Oklahoma","Minneapolis,Minnesota","Charlotte,North Carolina","Nashville,Tennessee","Indianapolis,Indiana","Columbus,Ohio"].forEach(function(s){var parts=s.split(",");addLoc(parts[0],parts[1]);});';
    html += '}else{var states=presets[p]||[];states.forEach(function(st){var cities=STATE_CITIES[st]||[];cities.slice(0,5).forEach(function(c){addLoc(c.name,st);});});}';
    html += 'renderAll();}';

    // Clear
    html += 'function clearAll(){selectedLocs=[];renderAll();}';
    html += 'function removeLoc(i){selectedLocs.splice(i,1);renderAll();}';

    // Drag and drop
    html += 'function dragStart(e,i){dragIdx=i;e.target.classList.add("dragging");e.dataTransfer.effectAllowed="move";}';
    html += 'function dragEnd(e){e.target.classList.remove("dragging");dragIdx=null;document.querySelectorAll(".loc-card").forEach(function(c){c.classList.remove("drag-over");});}';
    html += 'function dragOver(e,i){e.preventDefault();document.querySelectorAll(".loc-card").forEach(function(c){c.classList.remove("drag-over");});e.currentTarget.classList.add("drag-over");}';
    html += 'function drop(e,i){e.preventDefault();if(dragIdx===null||dragIdx===i)return;var item=selectedLocs.splice(dragIdx,1)[0];selectedLocs.splice(i,0,item);renderAll();}';

    // Render location list
    html += 'function renderLocList(){var el=document.getElementById("locList");document.getElementById("locCount").textContent=selectedLocs.length;';
    html += 'if(selectedLocs.length===0){el.innerHTML="<div style=\\"color:#4a6a8a;text-align:center;padding:20px\\">No markets selected yet</div>";return;}';
    html += 'var h="";selectedLocs.forEach(function(l,i){';
    html += 'var kdCol=l.avgKd<0.2?"#00ff66":l.avgKd<0.4?"#ff9f43":"#ff4757";';
    html += 'h+="<div class=\\"loc-card\\" draggable=\\"true\\" ondragstart=\\"dragStart(event,"+i+")\\" ondragend=\\"dragEnd(event)\\" ondragover=\\"dragOver(event,"+i+")\\" ondrop=\\"drop(event,"+i+")\\">";';
    html += 'h+="<div class=\\"rank\\">#"+(i+1)+"</div>";';
    html += 'h+="<div class=\\"remove\\" onclick=\\"removeLoc("+i+")\\">Ã—</div>";';
    html += 'h+="<div style=\\"padding-left:30px\\"><div class=\\"city\\">"+l.city+"</div><div class=\\"state\\">"+l.state+" Â· Pop "+formatPop(l.pop)+"</div></div>";';
    html += 'h+="<div class=\\"stats\\">";';
    html += 'h+="<span style=\\"color:#00d4ff\\">Vol: "+l.totalVol+"/mo</span>";';
    html += 'h+="<span style=\\"color:"+kdCol+"\\">KD: "+Math.round(l.avgKd*100)+"%</span>";';
    html += 'h+="<span style=\\"color:#55f7d8\\">Score: "+l.score+"</span>";';
    // Show service tags
    html += 'Object.keys(l.services||{}).forEach(function(sk){var s=l.services[sk];if(s.vol>0){';
    html += 'h+="<span class=\\"tag\\" style=\\"background:"+SVC_COLORS[sk]+"20;color:"+SVC_COLORS[sk]+";border:1px solid "+SVC_COLORS[sk]+"30\\">"+SVC_ICONS[sk]+" "+s.vol+"</span>";}});';
    html += 'h+="</div></div>";});el.innerHTML=h;}';

    // Calculate monthly predictions for all selected locs combined
    html += 'function calcForecast(){var now=new Date();var startM=now.getMonth();var startY=now.getFullYear();';
    html += 'var months=[];for(var i=0;i<12;i++){var mi=(startM+i)%12;var yr=startY+Math.floor((startM+i)/12);';
    html += 'var svcs={};var svcKeys=Object.keys(SEO_SEASONAL);';
    html += 'svcKeys.forEach(function(sk){svcs[sk]={vol:0,leads:0,rev:0};});';
    // Sum across all selected locations
    html += 'selectedLocs.forEach(function(l){svcKeys.forEach(function(sk){';
    html += 'if(l.services&&l.services[sk]&&l.services[sk].vol>0){';
    html += 'var mult=SEO_SEASONAL[sk][mi];var predVol=Math.round(l.services[sk].vol*mult);';
    html += 'var kd=l.services[sk].kd||0.3;var ctr=kd<0.2?0.15:kd<0.4?0.08:0.04;';
    html += 'var leads=Math.round(predVol*ctr);';
    html += 'svcs[sk].vol+=predVol;svcs[sk].leads+=leads;svcs[sk].rev+=Math.round(leads*CONV_RATE*AVG_TICKET);}});});';
    html += 'var totalVol=0,totalLeads=0,totalRev=0,dominant="";var maxV=0;';
    html += 'svcKeys.forEach(function(sk){totalVol+=svcs[sk].vol;totalLeads+=svcs[sk].leads;totalRev+=svcs[sk].rev;if(svcs[sk].vol>maxV){maxV=svcs[sk].vol;dominant=SVC_LABELS[sk];}});';
    html += 'months.push({label:MONTH_NAMES[mi]+" "+yr,mi:mi,totalVol:totalVol,totalLeads:totalLeads,totalRev:totalRev,dominant:dominant,services:svcs});}';
    html += 'return months;}';

    // Render chart
    html += 'function renderChart(months){var el=document.getElementById("forecastChart");';
    html += 'if(months.length===0||selectedLocs.length===0){el.innerHTML="<div style=\\"text-align:center;color:#4a6a8a;padding:60px\\">Add locations to see forecast</div>";return;}';
    html += 'var maxV=Math.max.apply(null,months.map(function(m){return m.totalVol;}))||1;';
    html += 'var h="";months.forEach(function(m){';
    html += 'var totalH=Math.round((m.totalVol/maxV)*180);';
    html += 'h+="<div class=\\"month-col\\">";';
    html += 'h+="<div style=\\"color:#c0d8f0;font-size:0.75em;font-weight:700;margin-bottom:2px\\">"+m.totalVol+"</div>";';
    html += 'h+="<div class=\\"month-stack\\" style=\\"height:"+totalH+"px\\">";';
    html += '["lawn_mower_repair","small_engine_repair","snow_blower_repair","generator_repair","motorcycle_repair"].forEach(function(sk){';
    html += 'var sv=m.services[sk];if(sv&&sv.vol>0){var sh=Math.max(2,Math.round((sv.vol/maxV)*180));';
    html += 'h+="<div style=\\"width:100%;height:"+sh+"px;background:"+SVC_COLORS[sk]+";opacity:0.75\\" title=\\""+SVC_LABELS[sk]+": "+sv.vol+"/mo Â· ~"+sv.leads+" leads Â· ~$"+sv.rev.toLocaleString()+"\\"></div>";}});';
    html += 'h+="</div><div class=\\"month-label\\">"+m.label.split(" ")[0]+"</div></div>";});';
    html += 'el.innerHTML=h;}';

    // Render forecast cards
    html += 'function renderCards(months){var el=document.getElementById("forecastCards");';
    html += 'if(months.length===0){el.innerHTML="";return;}';
    html += 'var maxV=Math.max.apply(null,months.map(function(m){return m.totalVol;}))||1;';
    html += 'var h="";months.forEach(function(m){';
    html += 'var isHigh=m.totalVol>maxV*0.7;var isLow=m.totalVol<maxV*0.3;';
    html += 'var col=isHigh?"#00ff66":isLow?"#ff4757":"#ff9f43";';
    html += 'h+="<div class=\\"fc-card\\" style=\\"border-color:"+col+"20\\">";';
    html += 'h+="<div class=\\"mo\\">"+m.label+"</div>";';
    html += 'h+="<div class=\\"vol\\" style=\\"color:"+col+"\\">"+m.totalVol+"</div>";';
    html += 'h+="<div style=\\"font-family:Orbitron;font-size:0.5em;letter-spacing:2px;color:"+col+"\\">"+(isHigh?"HIGH":isLow?"LOW":"NORMAL")+"</div>";';
    html += 'h+="<div class=\\"meta\\">~"+m.totalLeads+" leads Â· $"+m.totalRev.toLocaleString()+"</div>";';
    html += 'h+="<div class=\\"meta\\">Top: "+m.dominant+"</div>";';
    html += 'h+="</div>";});el.innerHTML=h;}';

    // Render summary
    html += 'function renderSummary(months){var el=document.getElementById("summaryStats");';
    html += 'if(selectedLocs.length===0){el.innerHTML="<div style=\\"color:#4a6a8a\\">Add locations to see predictions...</div>";return;}';
    html += 'var totalVol=0,totalLeads=0,totalRev=0;months.forEach(function(m){totalVol+=m.totalVol;totalLeads+=m.totalLeads;totalRev+=m.totalRev;});';
    html += 'var peakM=months.reduce(function(a,b){return a.totalVol>b.totalVol?a:b;});';
    html += 'var lowM=months.reduce(function(a,b){return a.totalVol<b.totalVol?a:b;});';
    html += 'var h="<div style=\\"display:flex;gap:10px;flex-wrap:wrap\\">";';
    html += 'h+="<div style=\\"flex:1;min-width:120px;text-align:center;padding:12px;background:rgba(10,20,35,0.8);border:1px solid #00d4ff15\\"><div style=\\"color:#4a6a8a;font-size:0.7em\\">12-MO SEARCHES</div><div style=\\"color:#00d4ff;font-size:1.8em;font-weight:900\\">"+totalVol.toLocaleString()+"</div></div>";';
    html += 'h+="<div style=\\"flex:1;min-width:120px;text-align:center;padding:12px;background:rgba(10,20,35,0.8);border:1px solid #55f7d815\\"><div style=\\"color:#4a6a8a;font-size:0.7em\\">EST. LEADS</div><div style=\\"color:#55f7d8;font-size:1.8em;font-weight:900\\">"+totalLeads.toLocaleString()+"</div></div>";';
    html += 'h+="<div style=\\"flex:1;min-width:120px;text-align:center;padding:12px;background:rgba(10,20,35,0.8);border:1px solid #ff9f4315\\"><div style=\\"color:#4a6a8a;font-size:0.7em\\">EST. REVENUE</div><div style=\\"color:#ff9f43;font-size:1.8em;font-weight:900\\">$"+totalRev.toLocaleString()+"</div></div>";';
    html += 'h+="<div style=\\"flex:1;min-width:120px;text-align:center;padding:12px;background:rgba(10,20,35,0.8);border:1px solid #00ff6615\\"><div style=\\"color:#4a6a8a;font-size:0.7em\\">PEAK MONTH</div><div style=\\"color:#00ff66;font-size:1.2em;font-weight:900\\">"+peakM.label+"</div><div style=\\"color:#4a6a8a;font-size:0.8em\\">"+peakM.totalVol+" searches</div></div>";';
    html += 'h+="<div style=\\"flex:1;min-width:120px;text-align:center;padding:12px;background:rgba(10,20,35,0.8);border:1px solid #ff475715\\"><div style=\\"color:#4a6a8a;font-size:0.7em\\">LOW MONTH</div><div style=\\"color:#ff4757;font-size:1.2em;font-weight:900\\">"+lowM.label+"</div><div style=\\"color:#4a6a8a;font-size:0.8em\\">"+lowM.totalVol+" searches</div></div>";';
    html += 'h+="<div style=\\"flex:1;min-width:120px;text-align:center;padding:12px;background:rgba(10,20,35,0.8);border:1px solid #c084fc15\\"><div style=\\"color:#4a6a8a;font-size:0.7em\\">MARKETS</div><div style=\\"color:#c084fc;font-size:1.8em;font-weight:900\\">"+selectedLocs.length+"</div></div>";';
    html += 'h+="</div>";el.innerHTML=h;}';

    // Render per-location breakdown
    html += 'function renderLocBreakdown(){var el=document.getElementById("locBreakdown");';
    html += 'if(selectedLocs.length===0){el.innerHTML="<div style=\\"color:#4a6a8a\\">Add locations to see per-city forecasts...</div>";return;}';
    html += 'var h="";selectedLocs.forEach(function(l,i){';
    html += 'var estLeads=0;Object.keys(l.services||{}).forEach(function(sk){var s=l.services[sk];if(s.vol>0){var ctr=s.kd<0.2?0.15:s.kd<0.4?0.08:0.04;estLeads+=Math.round(s.vol*ctr);}});';
    html += 'var estRev=Math.round(estLeads*CONV_RATE*AVG_TICKET);';
    html += 'h+="<div style=\\"display:flex;align-items:center;gap:8px;margin-bottom:4px;padding:6px 0;border-bottom:1px solid #ffffff05\\">";';
    html += 'h+="<div style=\\"width:22px;color:#55f7d8;font-family:Orbitron;font-size:0.7em\\">"+(i+1)+"</div>";';
    html += 'h+="<div style=\\"width:150px;color:#c0d8f0;font-weight:600\\">"+l.city+", "+l.state+"</div>";';
    html += 'h+="<div style=\\"flex:1;display:flex;gap:2px;height:16px\\">";';
    html += 'Object.keys(l.services||{}).forEach(function(sk){var s=l.services[sk];if(s&&s.vol>0){h+="<div style=\\"flex:"+s.vol+";background:"+SVC_COLORS[sk]+";height:100%;opacity:0.7\\" title=\\""+SVC_LABELS[sk]+": "+s.vol+"/mo\\"></div>";}});';
    html += 'h+="</div>";';
    html += 'h+="<div style=\\"width:55px;color:#00d4ff;font-size:0.8em;text-align:right\\">"+l.totalVol+"/mo</div>";';
    html += 'h+="<div style=\\"width:50px;color:"+(l.avgKd<0.2?"#00ff66":"#ff9f43")+";font-size:0.8em\\">KD "+Math.round(l.avgKd*100)+"%</div>";';
    html += 'h+="<div style=\\"width:55px;color:#55f7d8;font-size:0.8em\\">~"+estLeads+" leads</div>";';
    html += 'h+="<div style=\\"width:65px;color:#ff9f43;font-size:0.8em;text-align:right\\">$"+estRev.toLocaleString()+"/mo</div>";';
    html += 'h+="</div>";});el.innerHTML=h;}';

    // AI pick markets
    html += 'function aiPickMarkets(){selectedLocs=[];';
    html += 'var allMkts=[];Object.keys(STATE_CITIES).forEach(function(st){STATE_CITIES[st].forEach(function(c){';
    html += 'var d=getCityData(c.name,st);if(d&&d.totalVol>0)allMkts.push({city:c.name,state:st,pop:d.pop,totalVol:d.totalVol,avgKd:d.avgKd,score:d.score,services:d.services});});});';
    html += 'allMkts.sort(function(a,b){return b.score-a.score;});';
    html += 'allMkts.slice(0,20).forEach(function(m){selectedLocs.push(m);});renderAll();}';

    // AI analysis
    html += 'async function runAiAnalysis(){var el=document.getElementById("ai-output");el.style.display="block";';
    html += 'el.innerHTML="<div class=\\"loading\\">ANALYZING MARKETS...</div>";';
    html += 'var months=calcForecast();var summary="Selected Markets:\\n";';
    html += 'selectedLocs.forEach(function(l,i){summary+=(i+1)+". "+l.city+", "+l.state+" â€” Vol:"+l.totalVol+"/mo, KD:"+Math.round(l.avgKd*100)+"%, Score:"+l.score+", Pop:"+l.pop+"\\n";});';
    html += 'summary+="\\n12-Month Forecast:\\n";months.forEach(function(m){summary+=m.label+": "+m.totalVol+" searches, ~"+m.totalLeads+" leads, ~$"+m.totalRev+" rev, top: "+m.dominant+"\\n";});';
    html += 'summary+="\\nAvg ticket: $"+AVG_TICKET+", Conv rate: "+(CONV_RATE*100)+"%";';
    html += 'try{var r=await fetch("/api/ai/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:"You are a small engine repair business expansion analyst. Analyze these markets and give: 1) Top 5 recommendations (which cities to prioritize and why), 2) Seasonal strategy (when to push which service in which market), 3) Risk assessment (KD challenges, competition), 4) Revenue projection summary, 5) Quick wins vs long-term plays. Be specific and actionable.\\n\\n"+summary})});';
    html += 'var data=await r.json();el.innerHTML=data.reply||data.response||data.error||"Analysis complete";}';
    html += 'catch(err){el.innerHTML="Error: "+err.message;}}';

    // Render everything
    html += 'function renderAll(){renderLocList();var months=calcForecast();renderChart(months);renderCards(months);renderSummary(months);renderLocBreakdown();}';

    // Init: load Kansas cities and auto-add Olathe
    html += 'loadCities("Kansas");addLoc("Olathe","Kansas");addLoc("Overland Park","Kansas");addLoc("Kansas City","Kansas");addLoc("Lenexa","Kansas");addLoc("Wichita","Kansas");renderAll();';

    html += '</script></body></html>';

    res.send(html);
  } catch (err) {
    console.error('Forecast error:', err);
    res.status(500).send('Error: ' + err.message);
  }
});

app.get('/audit', requireAuth('owner'), async function(req, res) {
  var auditRes = await runSystemAudit();
  
  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>System Audit</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box;}body{background:#050d18;color:#c0d8f0;font-family:monospace;padding:20px;}';
  html += '.nav{display:flex;gap:2px;margin-bottom:20px;flex-wrap:wrap;justify-content:center;}';
  html += '.nav a{font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);}';
  html += '.nav a.active{color:#10b981;border-color:#10b98140;background:rgba(16,185,129,0.1);}';
  html += 'h1{font-family:Orbitron;color:#10b981;letter-spacing:6px;margin-bottom:5px;}';
  html += '.sub{font-family:Orbitron;font-size:0.6em;color:#4a6a8a;letter-spacing:3px;margin-bottom:20px;}';
  html += '.section{background:rgba(10,20,35,0.6);border:1px solid #1a2a3a;padding:16px;margin-bottom:16px;border-radius:4px;}';
  html += '.section-title{font-family:Orbitron;font-size:0.85em;letter-spacing:4px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #1a2a3a;}';
  html += '.check{display:flex;justify-content:space-between;padding:6px 8px;border-bottom:1px solid #0a1520;font-size:0.85em;}';
  html += '.check:hover{background:rgba(16,185,129,0.05);}';
  html += '.pass{color:#10b981;}.fail{color:#ef4444;}.warn{color:#f59e0b;}';
  html += '.score{font-family:Orbitron;font-size:2em;text-align:center;padding:20px;}';
  html += '.kv{display:flex;justify-content:space-between;padding:4px 0;font-size:0.85em;border-bottom:1px solid #0a152040;}';
  html += '.kv .k{color:#4a6a8a;}.kv .v{color:#c0d8f0;font-weight:bold;}';
  html += '.err-box{background:rgba(239,68,68,0.1);border:1px solid #ef444440;padding:10px;margin-bottom:8px;font-size:0.85em;color:#ef4444;}';
  html += '.warn-box{background:rgba(245,158,11,0.1);border:1px solid #f59e0b40;padding:10px;margin-bottom:8px;font-size:0.85em;color:#f59e0b;}';
  html += '</style></head><body>';
  
  // Nav
  html += '<div class="nav">';
  html += '<a href="/jarvis">JARVIS</a><a href="/business">ATHENA</a><a href="/tookan">TOOKAN</a><a href="/business/chart">CHARTS</a>';
  html += '<a href="/analytics">ANALYTICS</a><a href="/ads">GOOGLE ADS</a><a href="/square">SQUARE</a>';
  html += '<a href="/discord">DISCORD</a><a href="/followup">FOLLOW UP</a><a href="/ai">AI</a>';
  html += '<a href="/audit" class="active">AUDIT</a>';
  html += '<a href="/auth/logout" style="color:#ef4444;border-color:#ef444440;">LOGOUT</a></div>';
  
  html += '<h1>ðŸ” SYSTEM AUDIT</h1>';
  html += '<div class="sub">CROSS-TAB DATA INTEGRITY CHECK Â· ALL SYSTEMS</div>';
  
  // Score
  html += '<div class="section"><div class="score">';
  if (auditRes.health) {
    var scoreColor = parseInt(auditRes.health.score) >= 90 ? '#10b981' : parseInt(auditRes.health.score) >= 70 ? '#f59e0b' : '#ef4444';
    html += '<span style="color:' + scoreColor + ';">' + auditRes.health.score + '</span>';
    html += '<div style="font-size:0.3em;color:#4a6a8a;margin-top:5px;">' + auditRes.health.passed + '/' + auditRes.health.total + ' checks passed Â· ' + auditRes.health.warnings + ' warnings Â· ' + auditRes.health.errors + ' errors</div>';
  } else {
    html += '<span style="color:#ef4444;">ERROR</span>';
  }
  html += '</div></div>';
  
  // Errors
  if (auditRes.errors && auditRes.errors.length > 0) {
    html += '<div class="section"><div class="section-title" style="color:#ef4444;">âŒ ERRORS</div>';
    auditRes.errors.forEach(function(e) { html += '<div class="err-box">' + e + '</div>'; });
    html += '</div>';
  }
  
  // Warnings
  if (auditRes.warnings && auditRes.warnings.length > 0) {
    html += '<div class="section"><div class="section-title" style="color:#f59e0b;">âš ï¸ WARNINGS</div>';
    auditRes.warnings.forEach(function(w) { html += '<div class="warn-box">' + w + '</div>'; });
    html += '</div>';
  }
  
  // Individual Checks
  if (auditRes.checks && auditRes.checks.length > 0) {
    html += '<div class="section"><div class="section-title" style="color:#00d4ff;">ðŸ“‹ DATA INTEGRITY CHECKS</div>';
    auditRes.checks.forEach(function(c) {
      html += '<div class="check"><span>' + c.name + '</span>';
      html += '<span class="' + (c.pass ? 'pass' : 'fail') + '">' + (c.pass ? 'âœ…' : 'âŒ') + ' Expected: ' + (typeof c.expected === 'number' ? '$' + c.expected.toLocaleString() : c.expected) + ' | Actual: ' + (typeof c.actual === 'number' ? '$' + c.actual.toLocaleString() : c.actual) + ' (' + c.diff + ')</span></div>';
    });
    html += '</div>';
  }
  
  // System Summaries
  var summary = auditRes.summary || {};
  
  // Square Summary
  if (summary.square) {
    html += '<div class="section"><div class="section-title" style="color:#10b981;">ðŸ’° SQUARE</div>';
    Object.keys(summary.square).forEach(function(k) {
      html += '<div class="kv"><span class="k">' + k + '</span><span class="v">' + (typeof summary.square[k] === 'number' ? (k.includes('evenue') || k.includes('otal') ? '$' + summary.square[k].toLocaleString() : summary.square[k].toLocaleString()) : summary.square[k]) + '</span></div>';
    });
    html += '</div>';
  }
  
  // Square Yearly
  if (summary.squareYearly) {
    html += '<div class="section"><div class="section-title" style="color:#10b981;">ðŸ“… SQUARE YEARLY BREAKDOWN</div>';
    Object.keys(summary.squareYearly).sort().forEach(function(y) {
      var yd = summary.squareYearly[y];
      html += '<div style="padding:8px 0;border-bottom:1px solid #1a2a3a;">';
      html += '<div style="font-family:Orbitron;font-size:0.9em;color:#10b981;margin-bottom:4px;">' + y + '</div>';
      html += '<div class="kv"><span class="k">Reported Revenue</span><span class="v">$' + yd.reportedRevenue.toLocaleString() + '</span></div>';
      html += '<div class="kv"><span class="k">Order Revenue (COMPLETED)</span><span class="v">$' + yd.orderRevenue.toLocaleString() + '</span></div>';
      html += '<div class="kv"><span class="k">Payment Revenue (card only)</span><span class="v">$' + yd.paymentRevenue.toLocaleString() + '</span></div>';
      html += '<div class="kv"><span class="k">Orders / Payments</span><span class="v">' + yd.orders + ' / ' + yd.payments + '</span></div>';
      html += '</div>';
    });
    html += '</div>';
  }
  
  // Google Ads Summary
  if (summary.googleAds) {
    html += '<div class="section"><div class="section-title" style="color:#4285f4;">ðŸ“Š GOOGLE ADS</div>';
    Object.keys(summary.googleAds).forEach(function(k) {
      var v = summary.googleAds[k];
      html += '<div class="kv"><span class="k">' + k + '</span><span class="v">' + (typeof v === 'number' ? (k.includes('pend') ? '$' + v.toLocaleString() : v.toLocaleString()) : v) + '</span></div>';
    });
    html += '</div>';
  }
  
  // CRM Summary
  if (summary.crm) {
    html += '<div class="section"><div class="section-title" style="color:#a855f7;">ðŸ“ž CRM</div>';
    Object.keys(summary.crm).forEach(function(k) {
      html += '<div class="kv"><span class="k">' + k + '</span><span class="v">' + summary.crm[k] + '</span></div>';
    });
    html += '</div>';
  }
  
  // Tookan
  if (summary.tookan) {
    html += '<div class="section"><div class="section-title" style="color:#ff9f43;">ðŸšš TOOKAN</div>';
    Object.keys(summary.tookan).forEach(function(k) {
      html += '<div class="kv"><span class="k">' + k + '</span><span class="v">' + summary.tookan[k] + '</span></div>';
    });
    html += '</div>';
  }
  
  // Discord
  if (summary.discord) {
    html += '<div class="section"><div class="section-title" style="color:#5865F2;">ðŸ’¬ DISCORD</div>';
    Object.keys(summary.discord).forEach(function(k) {
      html += '<div class="kv"><span class="k">' + k + '</span><span class="v">' + summary.discord[k] + '</span></div>';
    });
    html += '</div>';
  }
  
  // Athena Data Sources
  if (summary.athenaDataSources) {
    html += '<div class="section"><div class="section-title" style="color:#c084fc;">ðŸ§  ATHENA DATA SOURCES</div>';
    Object.keys(summary.athenaDataSources).forEach(function(k) {
      var v = summary.athenaDataSources[k];
      var color = v === true ? '#10b981' : '#ef4444';
      html += '<div class="kv"><span class="k">' + k + '</span><span class="v" style="color:' + color + ';">' + (v ? 'âœ… Connected' : 'âŒ Missing') + '</span></div>';
    });
    html += '</div>';
  }
  
  // CRM Deep Dive
  if (summary.crmDeepDive) {
    var dd = summary.crmDeepDive;
    html += '<div class="section"><div class="section-title" style="color:#a855f7;">ðŸ”¬ CRM DEEP DIVE</div>';
    html += '<div class="kv"><span class="k">Sheets Read</span><span class="v">' + dd.totalSheets + '</span></div>';
    html += '<div class="kv"><span class="k">Tabs Read</span><span class="v">' + dd.totalTabs + '</span></div>';
    html += '<div class="kv"><span class="k">Total Job Rows</span><span class="v">' + dd.totalJobRows + '</span></div>';
    html += '<div class="kv"><span class="k">Unique Locations</span><span class="v">' + dd.locationCount + '</span></div>';
    html += '<div class="kv"><span class="k">Equipment Types</span><span class="v">' + dd.equipmentTypes + '</span></div>';
    html += '<div class="kv"><span class="k">Brands Tracked</span><span class="v">' + dd.brandCount + '</span></div>';
    html += '<div class="kv"><span class="k">CRM Techs (from jobs)</span><span class="v">' + dd.techCoverage.crmTechs + '</span></div>';
    html += '<div class="kv"><span class="k">Profit Sheet Techs</span><span class="v">' + dd.techCoverage.profitTechs + '</span></div>';
    html += '<div class="kv"><span class="k">Tech Assignment Rate</span><span class="v">' + dd.techAssignmentRate + '</span></div>';
    if (dd.callDataRange) {
      html += '<div class="kv"><span class="k">Call Data Range</span><span class="v">' + dd.callDataRange + ' (' + dd.totalMonthsOfData + ' months)</span></div>';
    }
    
    // Status Distribution
    if (dd.statusBreakdown) {
      html += '<div style="margin-top:12px;padding-top:10px;border-top:1px solid #1a2a3a;font-family:Orbitron;font-size:0.7em;letter-spacing:2px;color:#a855f7;margin-bottom:8px;">STATUS DISTRIBUTION</div>';
      var statusEntries = Object.entries(dd.statusBreakdown).sort(function(a,b){return b[1]-a[1];});
      statusEntries.forEach(function(s) {
        var pct = dd.totalJobRows > 0 ? Math.round(s[1]/dd.totalJobRows*100) : 0;
        var barColor = s[0].includes('completed') || s[0].includes('done') || s[0].includes('paid') || s[0].includes('serviced') ? '#10b981' : s[0].includes('cancel') ? '#ef4444' : s[0] === 'booked' ? '#a855f7' : '#4a6a8a';
        html += '<div style="display:flex;align-items:center;gap:10px;padding:3px 0;"><span style="width:180px;color:#c0d8f0;font-size:0.85em;">' + s[0] + '</span><div style="flex:1;height:16px;background:#0a1520;border-radius:3px;overflow:hidden;"><div style="width:' + pct + '%;height:100%;background:' + barColor + '40;border-radius:3px;"></div></div><span style="width:80px;text-align:right;font-size:0.85em;color:' + barColor + ';">' + s[1] + ' (' + pct + '%)</span></div>';
      });
    }
    
    // Data Quality
    if (dd.dataQuality) {
      html += '<div style="margin-top:12px;padding-top:10px;border-top:1px solid #1a2a3a;font-family:Orbitron;font-size:0.7em;letter-spacing:2px;color:#f59e0b;margin-bottom:8px;">DATA QUALITY</div>';
      Object.entries(dd.dataQuality).forEach(function(q) {
        var pctNum = parseInt(q[1].split('(')[1]) || 0;
        var color = pctNum > 50 ? '#ef4444' : pctNum > 20 ? '#f59e0b' : '#10b981';
        html += '<div class="kv"><span class="k">' + q[0] + '</span><span class="v" style="color:' + color + ';">' + q[1] + '</span></div>';
      });
    }
    html += '</div>';
  }
  
  // Cross-Check CRM vs Square
  if (summary.crossCheck) {
    html += '<div class="section"><div class="section-title" style="color:#ff9f43;">ðŸ”„ CRM vs SQUARE CROSS-CHECK</div>';
    html += '<div class="kv"><span class="k">CRM Completed Jobs</span><span class="v">' + summary.crossCheck.crmCompleted + '</span></div>';
    html += '<div class="kv"><span class="k">Square Completed Orders</span><span class="v">' + summary.crossCheck.squareCompletedOrders + '</span></div>';
    var noteColor = summary.crossCheck.note.includes('Large gap') ? '#f59e0b' : '#10b981';
    html += '<div class="kv"><span class="k">Assessment</span><span class="v" style="color:' + noteColor + ';">' + summary.crossCheck.note + '</span></div>';
    html += '</div>';
  }
  
  // Profit Sheet
  if (summary.profitSheet) {
    html += '<div class="section"><div class="section-title" style="color:#ffd700;">ðŸ’µ PROFIT SHEET (' + summary.profitSheet.currentMonth + ')</div>';
    Object.entries(summary.profitSheet).forEach(function(p) {
      if (p[0] !== 'currentMonth') {
        html += '<div class="kv"><span class="k">' + p[0] + '</span><span class="v">' + p[1] + '</span></div>';
      }
    });
    html += '</div>';
  }
  
  // Sheets Read
  if (summary.sheetsRead && Object.keys(summary.sheetsRead).length > 0) {
    html += '<div class="section"><div class="section-title" style="color:#00d4ff;">ðŸ“„ SHEETS READ</div>';
    Object.entries(summary.sheetsRead).forEach(function(s) {
      html += '<div class="kv"><span class="k">' + s[0] + (s[1].desc ? ' <span style="color:#4a6a8a;font-size:0.8em;">(' + s[1].desc + ')</span>' : '') + '</span><span class="v">' + s[1].tabs + ' tabs</span></div>';
      if (s[1].tabNames) { html += '<div style="padding-left:20px;color:#4a6a8a;font-size:0.8em;margin-bottom:8px;">' + s[1].tabNames + '</div>'; }
    });
    html += '</div>';
  }
  
  html += '<div style="text-align:center;padding:20px;font-family:Orbitron;font-size:0.5em;color:#1a2a3a;">SYSTEM AUDIT v1.0 Â· ' + new Date().toISOString() + '</div>';
  html += '<script>setTimeout(function(){location.reload();},300000);</script>'; // auto-refresh 5min
  html += '</body></html>';
  res.send(html);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASK ASSIGNING DESK â€” /tasks route + API endpoints
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var TASK_SPREADSHEET_ID = '1ZshCanMloF8uUlH39s2ZxvpCuvxjJQAONaSnN7590WA';
var TASK_EMPLOYEE_SHEET = 'Receptionist Data';
var TASK_BRAND_NAME = 'Wildwood Small Engine Repair';
var TASK_REPLY_EMAIL = 'tuzaib48@gmail.com';

// Helper: title case
function taskTitleCase(name) {
  return String(name || '').trim().toLowerCase().split(/\s+/).filter(Boolean)
    .map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1); }).join(' ');
}

// API: Get employees from Receptionist Data sheet
app.get('/tasks/api/employees', requireAuth('owner'), async function(req, res) {
  try {
    var result = await sheets.spreadsheets.values.get({
      spreadsheetId: TASK_SPREADSHEET_ID,
      range: "'" + TASK_EMPLOYEE_SHEET + "'!A2:B200"
    });
    var rows = result.data.values || [];
    var employees = rows.map(function(r) {
      return { name: taskTitleCase(r[0]), email: (r[1] || '').toString().trim() };
    }).filter(function(e) { return e.name && e.email; });
    employees.sort(function(a, b) { return a.name.localeCompare(b.name); });
    res.json(employees);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// API: Submit tasks â€” logs to monthly sheet + sends emails via Gmail
app.post('/tasks/api/submit', requireAuth('owner'), express.json(), async function(req, res) {
  try {
    var rows = req.body.rows;
    if (!rows || !Array.isArray(rows) || !rows.length) throw new Error('No tasks provided.');

    var cleaned = [];
    rows.forEach(function(r) {
      var date = (r.date || '').toString().trim();
      var description = (r.description || '').toString().trim();
      var name = taskTitleCase((r.name || '').toString().trim());
      var email = (r.email || '').toString().trim();
      var priority = (r.priority || 'Normal').toString().trim();
      if (date && description && name && email) {
        cleaned.push({ date: date, description: description, name: name, email: email, priority: priority });
      }
    });
    if (!cleaned.length) throw new Error('No complete tasks found.');

    // Ensure monthly sheet exists
    var now = new Date();
    var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    var monthSheetName = months[now.getMonth()] + ' ' + now.getFullYear();

    // Check if sheet exists
    var meta = await sheets.spreadsheets.get({ spreadsheetId: TASK_SPREADSHEET_ID, fields: 'sheets.properties.title' });
    var sheetNames = meta.data.sheets.map(function(s) { return s.properties.title; });
    if (sheetNames.indexOf(monthSheetName) === -1) {
      // Create the monthly sheet
      await sheets.spreadsheets.batchUpdate({
        spreadsheetId: TASK_SPREADSHEET_ID,
        requestBody: { requests: [{ addSheet: { properties: { title: monthSheetName } } }] }
      });
      // Add headers
      await sheets.spreadsheets.values.update({
        spreadsheetId: TASK_SPREADSHEET_ID,
        range: "'" + monthSheetName + "'!A1:F1",
        valueInputOption: 'RAW',
        requestBody: { values: [['Date', 'Description', 'Employee Name', 'Employee Email', 'Priority', 'Created At']] }
      });
    }

    // Append task rows
    var createdAt = now.toISOString().slice(0, 19).replace('T', ' ');
    var valuesToAppend = cleaned.map(function(t) {
      return [t.date, t.description, t.name, t.email, t.priority, createdAt];
    });
    await sheets.spreadsheets.values.append({
      spreadsheetId: TASK_SPREADSHEET_ID,
      range: "'" + monthSheetName + "'!A:F",
      valueInputOption: 'RAW',
      requestBody: { values: valuesToAppend }
    });

    // Group tasks by email for combined emails
    var grouped = {};
    cleaned.forEach(function(t) {
      var key = t.email.toLowerCase();
      if (!grouped[key]) grouped[key] = { name: t.name, email: t.email, tasks: [] };
      grouped[key].tasks.push(t);
    });

    // Send emails via Gmail API
    var emailCount = 0;
    var gmailTokenFile = '/tmp/gmail-tokens.json';
    var tokens = null;
    try {
      tokens = JSON.parse(require('fs').readFileSync(gmailTokenFile, 'utf8'));
    } catch(e) {}

    if (tokens && tokens.access_token) {
      // Refresh token if needed
      if (tokens.expiry_date && Date.now() > tokens.expiry_date - 60000) {
        try {
          var oauthClient = new (require('googleapis').google.auth.OAuth2)(
            process.env.GOOGLE_CLIENT_ID, process.env.GOOGLE_CLIENT_SECRET,
            (process.env.BASE_URL || 'http://localhost:3000') + '/auth/google/callback'
          );
          oauthClient.setCredentials(tokens);
          var newTokens = await oauthClient.getAccessToken();
          if (newTokens && newTokens.token) tokens.access_token = newTokens.token;
        } catch(e) { console.log('Token refresh failed:', e.message); }
      }

      var keys = Object.keys(grouped);
      for (var gi = 0; gi < keys.length; gi++) {
        var group = grouped[keys[gi]];
        try {
          var today = new Intl.DateTimeFormat('en-US', { month: 'short', day: '2-digit', year: 'numeric' }).format(now);
          var cardsHtml = group.tasks.map(function(t, i) {
            var pColor = t.priority === 'Urgent' ? '#ef4444' : (t.priority === 'Priority' ? '#f59e0b' : '#10b981');
            var badgeBg = t.priority === 'Urgent' ? '#fef2f2' : (t.priority === 'Priority' ? '#fffbeb' : '#ecfdf5');
            var badgeText = t.priority === 'Urgent' ? '#b91c1c' : (t.priority === 'Priority' ? '#b45309' : '#047857');
            return '<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:20px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.02);">' +
              '<div style="background:' + pColor + ';height:6px;width:100%;"></div>' +
              '<div style="padding:20px;">' +
              '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">' +
              '<span style="font-size:11px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;">Task #' + (i+1) + '</span>' +
              '<span style="background:' + badgeBg + ';color:' + badgeText + ';padding:4px 10px;border-radius:99px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">' + t.priority + '</span>' +
              '</div>' +
              '<div style="margin-bottom:16px;">' +
              '<span style="display:block;font-size:12px;color:#64748b;margin-bottom:4px;font-weight:600;">DESCRIPTION</span>' +
              '<div style="font-size:15px;color:#1e293b;line-height:1.6;font-weight:500;">' + t.description.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>' +
              '</div>' +
              '<div style="border-top:1px solid #f1f5f9;padding-top:12px;margin-top:12px;">' +
              '<span style="font-size:12px;color:#64748b;font-weight:600;">DUE DATE: </span>' +
              '<span style="font-size:13px;color:#0f172a;font-weight:600;margin-left:4px;">' + t.date + '</span>' +
              '</div></div></div>';
          }).join('');

          var htmlBody = '<!DOCTYPE html><html><head></head><body style="margin:0;padding:0;background:#f8fafc;font-family:Arial,sans-serif;">' +
            '<div style="max-width:600px;margin:0 auto;padding:40px 10px;">' +
            '<div style="text-align:center;margin-bottom:30px;">' +
            '<h2 style="color:#0f172a;margin:0;font-size:22px;font-weight:800;">Wildwood Repair</h2>' +
            '<div style="color:#64748b;font-size:13px;margin-top:4px;">Task Notification System</div></div>' +
            '<div style="margin-bottom:30px;">' +
            '<div style="background:#1e293b;color:#fff;padding:24px;border-radius:16px 16px 0 0;text-align:center;">' +
            '<h1 style="margin:0;font-size:24px;font-weight:700;">' + group.tasks.length + ' New Task' + (group.tasks.length > 1 ? 's' : '') + ' Assigned</h1>' +
            '<p style="margin:8px 0 0;opacity:0.8;font-size:14px;">' + today + '</p></div>' +
            '<div style="background:#fff;padding:24px;border-radius:0 0 16px 16px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);">' +
            '<p style="margin-top:0;margin-bottom:24px;color:#475569;font-size:15px;line-height:1.6;">Hello <strong>' + group.name + '</strong>,<br>You have new tasks pending. Please review the details below.</p>' +
            cardsHtml +
            '<div style="text-align:center;margin-top:32px;"><a href="mailto:' + TASK_REPLY_EMAIL + '" style="display:inline-block;background:#0f172a;color:#fff;text-decoration:none;padding:12px 24px;border-radius:8px;font-weight:600;font-size:14px;">Reply to Management</a></div>' +
            '</div></div>' +
            '<div style="text-align:center;color:#94a3b8;font-size:12px;">&copy; ' + now.getFullYear() + ' ' + TASK_BRAND_NAME + '.<br>Automated Notification System.</div>' +
            '</div></body></html>';

          var rawEmail = 'From: ' + TASK_BRAND_NAME + ' <me>\r\n' +
            'To: ' + group.email + '\r\n' +
            'Reply-To: ' + TASK_REPLY_EMAIL + '\r\n' +
            'Subject: New Tasks for ' + group.name + '\r\n' +
            'MIME-Version: 1.0\r\n' +
            'Content-Type: text/html; charset=UTF-8\r\n\r\n' +
            htmlBody;
          var encoded = Buffer.from(rawEmail).toString('base64').replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

          var sendRes = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + tokens.access_token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ raw: encoded })
          });
          if (sendRes.ok) emailCount++;
          else console.log('Task email send failed:', await sendRes.text());
        } catch (emailErr) {
          console.log('Task email error for ' + group.email + ':', emailErr.message);
        }
      }
    }

    res.json({ ok: true, savedTasks: cleaned.length, emailedEmployees: emailCount });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// GET /tasks â€” Task Assigning Desk UI
app.get('/tasks', requireAuth('owner'), async function(req, res) {
  var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
  html += '<title>Task Assigning Desk</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">';
  html += '<style>';
  html += ':root{--bg:#070b14;--panel:#0f172a;--panel2:#0b1220;--border:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--accent:#60a5fa;--danger:#ef4444;--success:#10b981;--warning:#f59e0b;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px;}';
  html += '*{box-sizing:border-box;margin:0;padding:0;}';
  html += 'body{background:radial-gradient(1200px 600px at 20% 0%,#0b1220 0%,var(--bg) 50%,#050814 100%);color:var(--text);font-family:Outfit,system-ui,sans-serif;min-height:100vh;}';
  html += '::-webkit-scrollbar{width:8px;height:8px;}::-webkit-scrollbar-track{background:#0b1220;}::-webkit-scrollbar-thumb{background:#1f2937;border-radius:4px;}::-webkit-scrollbar-thumb:hover{background:#374151;}';

  // Nav bar
  html += '.topnav{display:flex;align-items:center;gap:8px;padding:12px 20px;background:rgba(11,18,32,0.9);border-bottom:1px solid var(--border);overflow-x:auto;flex-wrap:nowrap;backdrop-filter:blur(12px);position:sticky;top:0;z-index:100;}';
  html += '.topnav a{font-size:11px;font-weight:600;letter-spacing:2px;padding:8px 16px;color:var(--muted);border:1px solid transparent;border-radius:8px;text-decoration:none;white-space:nowrap;transition:all 0.2s;}';
  html += '.topnav a:hover{color:var(--text);border-color:var(--border);background:rgba(255,255,255,0.03);}';
  html += '.topnav a.active{color:var(--accent);border-color:rgba(96,165,250,0.3);background:rgba(96,165,250,0.08);}';

  // Layout
  html += '.wrap{max-width:1200px;margin:34px auto;padding:0 18px 70px;}';
  html += '.header{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;margin-bottom:18px;flex-wrap:wrap;}';
  html += '.title{font-size:22px;font-weight:800;letter-spacing:.2px;}';
  html += '.subtitle{margin-top:6px;color:var(--muted);font-size:13px;}';
  html += '.pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;font-weight:500;}';

  // Card
  html += '.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}';
  html += '.toolbar{display:flex;gap:10px;padding:14px;border-bottom:1px solid var(--border);align-items:center;justify-content:space-between;flex-wrap:wrap;}';
  html += '.leftTools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}';

  // Buttons
  html += '.btn{border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:all .15s;user-select:none;font-family:inherit;font-size:13px;}';
  html += '.btn:hover{background:rgba(255,255,255,.06);border-color:#2b3646;}';
  html += '.btn:active{transform:translateY(1px);}';
  html += '.btnPrimary{background:linear-gradient(180deg,rgba(96,165,250,.22),rgba(96,165,250,.08));border-color:rgba(96,165,250,.35);color:#93c5fd;}';
  html += '.btnPrimary:hover{background:linear-gradient(180deg,rgba(96,165,250,.3),rgba(96,165,250,.12));}';
  html += '.btnDanger{background:linear-gradient(180deg,rgba(239,68,68,.20),rgba(239,68,68,.08));border-color:rgba(239,68,68,.35);color:#fca5a5;}';

  // Table
  html += '.tableWrap{width:100%;overflow-x:auto;min-height:400px;padding-bottom:100px;}';
  html += 'table{width:100%;border-collapse:collapse;min-width:1000px;}';
  html += 'thead th{text-align:left;font-size:11px;color:var(--muted);letter-spacing:.5px;padding:12px 14px;border-bottom:1px solid #1b2230;position:sticky;top:0;background:rgba(15,23,42,.98);z-index:10;font-weight:600;text-transform:uppercase;}';
  html += 'thead th:nth-child(2){min-width:280px;}thead th:nth-child(3){min-width:200px;}thead th:nth-child(4){min-width:220px;}';
  html += 'tbody td{padding:10px 14px;border-bottom:1px solid #121826;vertical-align:top;}';
  html += 'tbody tr{transition:background 0.15s;}tbody tr:hover{background:rgba(96,165,250,0.02);}';

  // Inputs
  html += 'input,textarea,select{width:100%;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:10px 12px;color:var(--text);outline:none;font-size:13px;font-family:inherit;transition:border-color 0.2s;}';
  html += 'input:focus,textarea:focus,select:focus{border-color:rgba(96,165,250,0.4);background:rgba(0,0,0,0.2);}';
  html += 'textarea{height:42px;min-height:42px;resize:vertical;line-height:1.5;overflow:hidden;}';
  html += 'textarea:focus{min-height:60px;}';
  html += 'select{appearance:none;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%2394a3b8%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 10px center;background-size:16px;cursor:pointer;}';
  html += 'select option{background:#0b1220;color:#e5e7eb;}';
  html += 'input[readonly]{opacity:.85;cursor:not-allowed;}';

  // Row actions
  html += '.rowActions{display:flex;gap:6px;justify-content:flex-end;}';
  html += '.iconBtn{border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--muted);border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:14px;}';
  html += '.iconBtn:hover{background:rgba(255,255,255,.1);color:#fff;}';
  html += '.btnSendRow{color:var(--accent);border-color:rgba(96,165,250,.2);}.btnSendRow:hover{background:rgba(96,165,250,.15);box-shadow:0 0 10px rgba(96,165,250,.1);}';

  // Status
  html += '.status{margin:12px 14px;font-size:13px;color:var(--muted);white-space:pre-line;min-height:20px;}';

  // FAB
  html += '.addRowFloating{position:fixed;right:22px;bottom:18px;z-index:999;display:flex;align-items:center;gap:10px;}';
  html += '.fab{width:54px;height:54px;border-radius:16px;border:1px solid rgba(96,165,250,.35);background:linear-gradient(180deg,rgba(96,165,250,.26),rgba(96,165,250,.10));color:#eaf2ff;font-size:22px;font-weight:900;cursor:pointer;box-shadow:0 12px 28px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;transition:all 0.2s;font-family:inherit;}';
  html += '.fab:hover{transform:translateY(-2px);box-shadow:0 16px 32px rgba(0,0,0,.4);}';
  html += '.fabLabel{background:rgba(15,23,42,.9);border:1px solid var(--border);padding:10px 12px;border-radius:14px;color:var(--muted);font-size:12px;}';

  // Dropdown
  html += '.dd{position:relative;}.ddInput{padding-right:38px;cursor:pointer;}';
  html += '.ddCaret{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:28px;height:28px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.03);display:flex;align-items:center;justify-content:center;pointer-events:none;color:var(--muted);font-weight:900;font-size:12px;}';
  html += '.ddMenu{position:absolute;left:0;min-width:100%;width:max-content;max-width:350px;top:calc(100% + 6px);background:#070b14;border:1px solid #253044;border-radius:14px;box-shadow:0 18px 40px rgba(0,0,0,.75);overflow:hidden;display:none;z-index:1000;}';
  html += '.ddMenu.open{display:block;}';
  html += '.ddSearch{width:100%;border:0;border-bottom:1px solid #182033;border-radius:0;background:rgba(255,255,255,.03);padding:12px;outline:none;}';
  html += '.ddList{max-height:240px;overflow-y:auto;}';
  html += '.ddItem{padding:12px 14px;cursor:pointer;color:#e5e7eb;border-bottom:1px solid #0f172a;font-size:13px;transition:background 0.1s;}.ddItem:hover{background:rgba(96,165,250,.10);}';
  html += '.ddItem small{display:block;color:var(--muted);margin-top:4px;font-size:12px;}.ddEmpty{padding:12px;color:var(--muted);font-size:13px;}';

  // Loading overlay
  html += '.loadingOverlay{position:fixed;inset:0;background:rgba(7,11,20,0.8);z-index:2000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;backdrop-filter:blur(4px);}';
  html += '.loadingOverlay.show{display:flex;}';
  html += '.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}';
  html += '@keyframes spin{to{transform:rotate(360deg)}}';
  html += '.loadingText{color:var(--muted);font-size:13px;letter-spacing:1px;}';

  html += '</style></head><body>';

  // Nav
  html += '<div class="topnav">';
  html += '<a href="/dashboard">JARVIS</a>';
  html += '<a href="/business">ATHENA</a>';
  html += '<a href="/analytics">ANALYTICS</a>';
  html += '<a href="/square">SQUARE</a>';
  html += '<a href="/forecast">FORECAST</a>';
  html += '<a href="/tasks" class="active">TASKS</a>';
  html += '<a href="/discord">DISCORD</a>';
  html += '<a href="/followup">FOLLOW UP</a>';
  html += '<a href="/seo">SEO</a>';
  html += '<a href="/audit">AUDIT</a>';
  html += '</div>';

  html += '<div class="wrap">';
  html += '<div class="header"><div><h1 class="title">Task Assigning Desk</h1><div class="subtitle">Create tasks, assign employees, and send combined email notifications.</div></div>';
  html += '<div class="pill" id="todayPill">Today: â€”</div></div>';

  html += '<div class="card">';
  html += '<div class="toolbar"><div class="leftTools">';
  html += '<button class="btn btnPrimary" id="sendBtn" onclick="sendAllTasks()">âœ‰ Send All Tasks</button>';
  html += '<button class="btn btnDanger" id="clearBtn" onclick="resetTable()">âœ• Clear All</button>';
  html += '</div><div class="pill" id="employeeCount">Employees: loading...</div></div>';

  html += '<div class="tableWrap"><table><thead><tr>';
  html += '<th style="width:140px">Date</th><th>Task Description</th><th style="width:240px">Employee Name</th>';
  html += '<th style="width:290px">Employee Email</th><th style="width:160px">Priority</th><th style="width:130px;text-align:right">Actions</th>';
  html += '</tr></thead><tbody id="rowsBody"></tbody></table></div>';
  html += '<div class="status" id="statusBox"></div>';
  html += '</div></div>';

  // FAB
  html += '<div class="addRowFloating"><div class="fabLabel">Add Row</div><button class="fab" onclick="addRow()">+</button></div>';

  // Loading overlay
  html += '<div class="loadingOverlay" id="loadingOverlay"><div class="spinner"></div><div class="loadingText" id="loadingText">Sending tasks...</div></div>';

  // JavaScript
  html += '<script>';
  html += 'var employees=[],rowsBody=document.getElementById("rowsBody"),statusBox=document.getElementById("statusBox");';
  html += 'var todayISO=new Date().toISOString().slice(0,10);';
  html += 'document.getElementById("todayPill").textContent="Today: "+todayISO;';

  // Close dropdowns on outside click
  html += 'document.addEventListener("click",function(e){document.querySelectorAll(".ddMenu.open").forEach(function(m){if(!m.closest(".dd").contains(e.target))m.classList.remove("open")})});';

  // Load employees
  html += 'fetch("/tasks/api/employees",{credentials:"include"}).then(function(r){return r.json()}).then(function(data){';
  html += '  if(data.error){setStatus("Error: "+data.error,true);return}';
  html += '  employees=data;document.getElementById("employeeCount").textContent="Employees: "+employees.length;';
  html += '  resetTable();';
  html += '}).catch(function(err){setStatus("Failed to load employees: "+err,true)});';

  // Status
  html += 'function setStatus(msg,isError){statusBox.style.color=isError?"#fca5a5":"#94a3b8";statusBox.textContent=msg||""}';

  // Escape HTML
  html += 'function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}';

  // Reset
  html += 'function resetTable(){rowsBody.innerHTML="";addRow();setStatus("")}';

  // Create dropdown
  html += 'function createDD(placeholder,getLabel,getSub,onPick){';
  html += '  var wrap=document.createElement("div");wrap.className="dd";';
  html += '  var inp=document.createElement("input");inp.className="ddInput";inp.type="text";inp.placeholder=placeholder;inp.readOnly=true;inp.dataset.value="";';
  html += '  var caret=document.createElement("div");caret.className="ddCaret";caret.textContent="â–¾";';
  html += '  var menu=document.createElement("div");menu.className="ddMenu";';
  html += '  var search=document.createElement("input");search.className="ddSearch";search.type="text";search.placeholder="Searchâ€¦";';
  html += '  var list=document.createElement("div");list.className="ddList";';
  html += '  menu.appendChild(search);menu.appendChild(list);wrap.appendChild(inp);wrap.appendChild(caret);wrap.appendChild(menu);';
  html += '  function render(ft){list.innerHTML="";ft=(ft||"").trim().toLowerCase();';
  html += '    var filtered=employees.filter(function(e){return !ft||getLabel(e).toLowerCase().indexOf(ft)>=0||getSub(e).toLowerCase().indexOf(ft)>=0});';
  html += '    if(!filtered.length){list.innerHTML="<div class=ddEmpty>No results</div>";return}';
  html += '    filtered.forEach(function(e){var d=document.createElement("div");d.className="ddItem";d.innerHTML=esc(getLabel(e))+(getSub(e)?"<small>"+esc(getSub(e))+"</small>":"");';
  html += '      d.addEventListener("click",function(){inp.value=getLabel(e);inp.dataset.value=getLabel(e);menu.classList.remove("open");onPick(e)});list.appendChild(d)})}';
  html += '  inp.addEventListener("click",function(){document.querySelectorAll(".ddMenu.open").forEach(function(m){if(m!==menu)m.classList.remove("open")});menu.classList.toggle("open");if(menu.classList.contains("open")){search.value="";render("");setTimeout(function(){search.focus()},10)}});';
  html += '  search.addEventListener("input",function(){render(search.value)});';
  html += '  wrap.setByLabel=function(l){inp.value=l||"";inp.dataset.value=l||""};wrap.getValue=function(){return inp.dataset.value||""};wrap.clear=function(){wrap.setByLabel("")};';
  html += '  return wrap}';

  // Add row
  html += 'function addRow(pre){pre=pre||{};var tr=document.createElement("tr");';
  // Date
  html += '  var td1=document.createElement("td");var di=document.createElement("input");di.type="date";di.value=pre.date||todayISO;di.readOnly=true;td1.appendChild(di);';
  // Description
  html += '  var td2=document.createElement("td");var ta=document.createElement("textarea");ta.placeholder="Task details...";ta.value=pre.description||"";td2.appendChild(ta);';
  // Name dropdown
  html += '  var td3=document.createElement("td");var ddN=createDD("Select employeeâ€¦",function(e){return e.name},function(e){return e.email},function(e){ddE.setByLabel(e.email)});td3.appendChild(ddN);';
  // Email dropdown
  html += '  var td4=document.createElement("td");var ddE=createDD("Select emailâ€¦",function(e){return e.email},function(e){return e.name},function(e){ddN.setByLabel(e.name)});td4.appendChild(ddE);';
  html += '  if(pre.name)ddN.setByLabel(pre.name);if(pre.email)ddE.setByLabel(pre.email);';
  // Priority
  html += '  var td5=document.createElement("td");var sel=document.createElement("select");["Normal","Priority","Urgent"].forEach(function(o){var opt=document.createElement("option");opt.value=o;opt.textContent=o;sel.appendChild(opt)});sel.value=pre.priority||"Normal";td5.appendChild(sel);';
  // Actions
  html += '  var td6=document.createElement("td");td6.style.textAlign="right";var acts=document.createElement("div");acts.className="rowActions";';
  html += '  var sb=document.createElement("button");sb.className="iconBtn btnSendRow";sb.title="Send this task";sb.innerHTML="âœ‰";sb.onclick=function(){sendSingleRow(tr)};';
  html += '  var db=document.createElement("button");db.className="iconBtn";db.title="Delete";db.innerHTML="âœ•";db.onclick=function(){tr.remove();if(!rowsBody.querySelector("tr"))addRow()};';
  html += '  acts.appendChild(sb);acts.appendChild(db);td6.appendChild(acts);';
  html += '  tr.appendChild(td1);tr.appendChild(td2);tr.appendChild(td3);tr.appendChild(td4);tr.appendChild(td5);tr.appendChild(td6);';
  html += '  tr._ddN=ddN;tr._ddE=ddE;tr._prio=sel;';
  html += '  rowsBody.appendChild(tr)}';

  // Get row data
  html += 'function getRowData(tr){var tds=tr.querySelectorAll("td");return{date:tds[0].querySelector("input").value,description:tds[1].querySelector("textarea").value,name:tr._ddN.getValue(),email:tr._ddE.getValue(),priority:tr._prio.value}}';

  // Collect all rows
  html += 'function collectRows(){return Array.from(rowsBody.querySelectorAll("tr")).map(getRowData)}';

  // Loading overlay
  html += 'function showLoading(msg){document.getElementById("loadingText").textContent=msg||"Processing...";document.getElementById("loadingOverlay").classList.add("show")}';
  html += 'function hideLoading(){document.getElementById("loadingOverlay").classList.remove("show")}';

  // Send single row
  html += 'function sendSingleRow(tr){var d=getRowData(tr);if(!d.name||!d.email||!d.description){setStatus("Please fill in all fields before sending.",true);return}';
  html += '  var btn=tr.querySelector(".btnSendRow");btn.disabled=true;btn.textContent="â€¦";';
  html += '  fetch("/tasks/api/submit",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({rows:[d]})})';
  html += '  .then(function(r){return r.json()}).then(function(res){';
  html += '    if(res.error){btn.disabled=false;btn.innerHTML="âœ‰";setStatus("Error: "+res.error,true);return}';
  html += '    tr.remove();if(!rowsBody.querySelector("tr"))addRow();';
  html += '    setStatus("Task sent successfully!"+(res.emailedEmployees?" Email sent.":""))';
  html += '  }).catch(function(err){btn.disabled=false;btn.innerHTML="âœ‰";setStatus("Error: "+err,true)})}';

  // Send all tasks
  html += 'function sendAllTasks(){var rows=collectRows().filter(function(r){return r.name&&r.email&&r.description});';
  html += '  if(!rows.length){setStatus("No complete tasks to send.",true);return}';
  html += '  showLoading("Sending "+rows.length+" task(s)...");';
  html += '  fetch("/tasks/api/submit",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({rows:rows})})';
  html += '  .then(function(r){return r.json()}).then(function(res){hideLoading();';
  html += '    if(res.error){setStatus("Error: "+res.error,true);return}';
  html += '    setStatus("All done! Saved "+res.savedTasks+" tasks, emailed "+res.emailedEmployees+" employees.");resetTable()';
  html += '  }).catch(function(err){hideLoading();setStatus("Error: "+err,true)})}';

  html += '</script></body></html>';
  res.send(html);
});




app.get('/square/api/debug', async function(req, res) {
  try {
    var today = new Date(); today.setHours(0,0,0,0);
    var raw = await squareFetch('/payments?begin_time=' + encodeURIComponent(today.toISOString()) + '&limit=100');
    var rawAll = await squareFetch('/payments?limit=100&sort_order=DESC');
    var locs = await squareGetLocations();
    var locIds = locs.map(function(l){return l.id;});
    // Try orders search across all locations (batched by 10)
    var allOrders = [];
    for (var di = 0; di < locIds.length; di += SQ_BATCH.ORDERS_LOCS) {
      var dChunk = locIds.slice(di, di + SQ_BATCH.ORDERS_LOCS);
      var ordersRaw = await squareFetch('/orders/search', 'POST', {
        location_ids: dChunk, query: { filter: { date_time_filter: { created_at: { start_at: today.toISOString() } } } }, limit: 100
      });
      if (ordersRaw && ordersRaw.orders) allOrders = allOrders.concat(ordersRaw.orders);
    }
    res.json({
      token_prefix: SQUARE_ACCESS_TOKEN ? SQUARE_ACCESS_TOKEN.substring(0,10) + '...' : 'NOT SET',
      base_url: SQUARE_BASE,
      square_env: process.env.SQUARE_ENV || 'NOT SET',
      location_count: locs.length,
      payments_today_raw: raw,
      payments_all_raw: rawAll,
      orders_today_raw: { orders: allOrders, count: allOrders.length }
    });
  } catch (err) { res.json({ error: err.message, stack: err.stack }); }
});
app.get('/square/api/customers', async function(req, res) { try { res.json({ customers: await squareGetCustomers() }); } catch (err) { res.json({ customers: [], error: err.message }); } });
app.get('/square/api/payments', async function(req, res) { try { res.json({ payments: await squareGetPayments(parseInt(req.query.days)||30) }); } catch (err) { res.json({ payments: [], error: err.message }); } });
app.get('/square/api/catalog', async function(req, res) { try { res.json({ catalog: await squareGetCatalog() }); } catch (err) { res.json({ catalog: [], error: err.message }); } });
app.get('/square/api/orders', async function(req, res) { try { var locs = await squareGetLocations(); var locIds = locs.map(function(l){return l.id;}); res.json({ orders: locIds.length ? await squareGetOrders(locIds, parseInt(req.query.days)||1500) : [] }); } catch (err) { res.json({ orders: [], error: err.message }); } });
app.get('/square/api/shifts', async function(req, res) { try { res.json({ shifts: await squareGetShifts(parseInt(req.query.days)||14) }); } catch (err) { res.json({ shifts: [], error: err.message }); } });
app.get('/square/api/payouts', async function(req, res) { try { res.json({ payouts: await squareGetPayouts(parseInt(req.query.days)||30) }); } catch (err) { res.json({ payouts: [], error: err.message }); } });

app.post('/square/api/analyze', express.json(), async function(req, res) {
  try {
    var snap = await squareFullSnapshot();
    var a = squareAnalyze(snap);
    var topic = req.body.topic || 'full';
    var context = 'SQUARE COMPLETE HISTORICAL DATA â€” WILDWOOD SMALL ENGINE REPAIR (since 2022):\n\n';

    context += '=== CURRENT SNAPSHOT ===\nToday: $' + a.revenue.today.toFixed(2) + ' | Week: $' + a.revenue.week.toFixed(2) + ' | Last Week: $' + a.revenue.prevWeek.toFixed(2) + ' | Growth: ' + a.revenue.weekGrowth + '%\n';
    context += 'All-Time Gross: $' + a.revenue.allTimeTotal.toFixed(2) + ' | Net: $' + a.revenue.net.toFixed(2) + ' | Total Fees Paid: $' + a.revenue.fees.toFixed(2) + ' | Tips Earned: $' + a.revenue.tips.toFixed(2) + '\n';
    context += 'Avg Ticket: $' + a.revenue.avgTicket.toFixed(2) + ' | Median: $' + a.revenue.medianTicket.toFixed(2) + ' | Highest Single: $' + a.revenue.maxTicket.toFixed(2) + '\n\n';

    context += '=== YEARLY COMPARISON ===\n';
    Object.keys(a.trends.yearlyRevenue).sort().forEach(function(y) {
      context += y + ': $' + a.trends.yearlyRevenue[y].toFixed(2) + ' revenue, ' + (a.trends.yearlyPayments[y]||0) + ' payments, ' + (a.trends.yearlyCustomers[y]||0) + ' new customers\n';
    });
    context += '\n';

    context += '=== QUARTERLY REVENUE ===\n';
    Object.keys(a.trends.quarterlyRevenue).sort().forEach(function(q) {
      context += q + ': $' + a.trends.quarterlyRevenue[q].toFixed(2) + '\n';
    });
    context += '\n';

    context += '=== MONTHLY REVENUE TREND ===\n';
    Object.keys(a.trends.monthlyRevenue).sort().forEach(function(m) {
      context += m + ': $' + a.trends.monthlyRevenue[m].toFixed(2) + ' (' + (a.trends.monthlyPaymentCount[m]||0) + ' payments, avg ticket $' + (a.trends.monthlyAvgTicket[m]||0) + ')\n';
    });
    context += '\n';

    if (a.trends.bestMonth) context += 'BEST MONTH EVER: ' + a.trends.bestMonth[0] + ' â€” $' + a.trends.bestMonth[1].toFixed(2) + '\n';
    if (a.trends.worstMonth) context += 'WORST MONTH: ' + a.trends.worstMonth[0] + ' â€” $' + a.trends.worstMonth[1].toFixed(2) + '\n\n';

    context += '=== SEASONALITY (avg revenue by calendar month across all years) ===\n';
    var monthNames = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    Object.keys(a.trends.seasonalAvg).sort().forEach(function(mo) {
      context += monthNames[parseInt(mo)] + ': $' + a.trends.seasonalAvg[mo] + ' avg\n';
    });
    context += '\n';

    if (a.trends.projections) {
      var pj = a.trends.projections;
      context += '=== REVENUE PROJECTIONS (' + new Date().getFullYear() + ') ===\n';
      context += 'YTD Revenue: $' + pj.ytdRevenue + ' | Last Year Total: $' + pj.lastYearTotal + '\n';
      context += 'Projected Full Year: $' + pj.projectedFullYear + ' | Conservative: $' + pj.conservativeFullYear + ' | Optimistic: $' + pj.optimisticFullYear + '\n';
      context += 'YoY Growth Rate: ' + pj.yoyGrowthRate + '% | Projected Growth: ' + pj.projectedGrowth + '%\n\n';
    }
    if (a.invoices.paymentSpeed) {
      var ps = a.invoices.paymentSpeed;
      context += '=== PAYMENT SPEED (invoice sent to payment received) ===\n';
      context += 'Avg: ' + ps.avgDays + ' days | Median: ' + ps.medianDays + ' days | Sample: ' + ps.sampleSize + ' invoices\n';
      context += 'Same Day: ' + ps.sameDay + '% | Within 3d: ' + ps.within3d + '% | Within 7d: ' + ps.within7d + '% | Within 30d: ' + ps.within30d + '% | Over 30d: ' + ps.over30d + '%\n\n';
    }
    if (a.invoices.turnaround) {
      context += '=== INVOICE TURNAROUND (service to invoice, biz hours) ===\n';
      context += 'Avg: ' + a.invoices.turnaround.avgFormatted + ' | Median: ' + a.invoices.turnaround.medianFormatted + ' | Fastest: ' + a.invoices.turnaround.fastest + ' | Slowest: ' + a.invoices.turnaround.slowest + '\n\n';
    }

    context += '=== CUSTOMER INSIGHTS ===\nTotal Customers: ' + a.customers.total + ' | Unique Paying: ' + a.customerInsights.uniquePayingCustomers + '\n';
    context += 'Repeat Customers: ' + a.customerInsights.repeatCustomers + ' (' + a.customerInsights.repeatRate + '%) | Avg Lifetime Value: $' + a.customerInsights.avgLTV.toFixed(2) + '\n';
    context += 'Email Capture: ' + a.customers.emailCaptureRate + '% | New (30d): ' + a.customers.new30d + ' | New (7d): ' + a.customers.new7d + '\n';
    context += 'TOP 10 SPENDERS:\n' + a.customerInsights.topSpenders.slice(0,10).map(function(s) { return 'Customer ' + s.id.substring(0,8) + ': $' + s.total.toFixed(2) + ' over ' + s.visits + ' visits'; }).join('\n') + '\n\n';

    context += '=== MONTHLY NEW CUSTOMERS ===\n';
    Object.keys(a.trends.monthlyCustomers).sort().forEach(function(m) { context += m + ': ' + a.trends.monthlyCustomers[m] + ' new\n'; });
    context += '\n';

    context += '=== PAYMENTS ===\nAll-Time: ' + a.payments.total + ' | Completed: ' + a.payments.completed + ' | Failed: ' + a.payments.failed + ' | Peak: ' + a.payments.peakHour + ' ' + a.payments.peakDay + '\n';
    context += 'Methods: ' + Object.entries(a.payments.byMethod).map(function(e){return e[0]+': '+e[1].count+' ($'+e[1].total.toFixed(0)+')';}).join(', ') + '\n\n';

    context += '=== TOP SELLING ITEMS (all-time) ===\n' + a.orders.topItemsByRevenue.slice(0,20).map(function(e,i){return (i+1)+'. '+e[0]+': $'+e[1].revenue.toFixed(2)+' ('+e[1].qty+' sold, avg $'+(e[1].qty>0?(e[1].revenue/e[1].qty).toFixed(2):'0')+')';}).join('\n') + '\n\n';

    context += '=== REFUNDS ===\n' + a.refunds.count + ' total, $' + a.refunds.total.toFixed(2) + ', Rate: ' + a.refunds.rate + '%\n';
    context += 'Reasons: ' + Object.entries(a.refunds.reasons).map(function(e){return e[0]+': '+e[1];}).join(', ') + '\n\n';

    context += '=== DISPUTES ===\nOpen: ' + a.disputes.open + ' | Won: ' + a.disputes.won + ' | Lost: ' + a.disputes.lost + '\n\n';

    context += '=== LABOR ===\nHours (14d): ' + a.labor.totalHoursWorked + ' | Shifts: ' + a.labor.totalShifts + ' | Avg Shift: ' + a.labor.avgShiftLength + 'h | Est Cost: $' + a.labor.laborCostEstimate.toFixed(0) + '\n\n';

    context += '=== OTHER ===\nGift Cards: ' + a.giftCards.active + ' ($' + a.giftCards.totalBalance.toFixed(2) + ') | Subs: ' + a.subscriptions.active + ' | Payouts: $' + a.payouts.total.toFixed(2) + ' | Catalog Items: ' + a.catalog.items + ' | Team: ' + a.team.active + '\n';

    var prompt = 'You are ATHENA, the AI business intelligence engine for Wildwood Small Engine Repair. You have COMPLETE historical Square payment data going back to 2022.\n\n' + context;
    prompt += '\n\nIMPORTANT INSTRUCTIONS:\n1. Use SPECIFIC dollar amounts, percentages, and dates in every insight.\n2. Compare year-over-year and month-over-month to show trends.\n3. For EVERY finding, give a CONCRETE RECOMMENDATION with a specific action Trace (the owner) should take.\n4. Identify the #1 most urgent action item.\n5. Call out any red flags (declining revenue, rising refunds, etc).\n6. Show growth trajectory â€” is the business growing, flat, or declining?\n7. Identify seasonal patterns and what to prepare for.\n8. Reference actual data â€” don\'t be vague.\n9. Do NOT mention unpaid invoices, overdue invoices, collection rates, or outstanding balances â€” the owner manages collections separately.\n\n';

    if (topic === 'revenue') prompt += 'FOCUS: Revenue deep dive â€” year-over-year growth, monthly trends, seasonal patterns, ticket size evolution, fee impact, peak times. What months to push hard, what months are slow. Growth trajectory and revenue forecast. Give 5+ specific recommendations to increase revenue.';
    else if (topic === 'collections') prompt += 'FOCUS: Cash flow analysis â€” revenue timing, payout patterns, seasonal cash flow gaps, monthly burn rate. Give a specific plan for improving cash flow and maximizing revenue during peak months.';
    else if (topic === 'customers') prompt += 'FOCUS: Customer intelligence â€” repeat rate, lifetime value, acquisition trends, email capture gaps, top spenders to VIP, at-risk customers. Give 5+ specific recommendations to grow and retain customers.';
    else if (topic === 'labor') prompt += 'FOCUS: Labor optimization â€” hours vs revenue ratio, shift efficiency, scheduling patterns, break time, cost control. Give specific scheduling recommendations.';
    else if (topic === 'items') prompt += 'FOCUS: Product/service analysis â€” top sellers, pricing opportunities, underperforming items, discount effectiveness, catalog gaps. Give specific pricing and product recommendations.';
    else prompt += 'COMPREHENSIVE BUSINESS INTELLIGENCE BRIEFING: Cover everything â€” revenue trajectory since 2022, year-over-year growth, seasonal patterns, customer health, top items, labor efficiency, red flags, and TOP 10 specific action items ranked by impact. Do NOT discuss invoice collections.';

    var analysis = await askClaude(prompt, [{ role: 'user', content: 'Analyze now. Be direct and specific. Use dollar amounts. Give actionable recommendations.' }]);
    res.json({ analysis: analysis });
  } catch (err) { res.json({ analysis: 'Error: ' + err.message }); }
});

// Square Voice Chat endpoint
app.post('/square/api/voice', express.json(), async function(req, res) {
  try {
    var message = req.body.message || '';
    var locFilter = req.body.location || 'all';
    if (!message) return res.json({ error: 'No message provided' });
    var snap = await squareFullSnapshot(false);
    // Apply location filter
    if (locFilter && locFilter !== 'all') {
      var vFilterIds = locFilter.split(',');
      snap = {
        locations: (snap.locations||[]).filter(function(l){return vFilterIds.indexOf(l.id)>=0;}),
        payments: (snap.payments||[]).filter(function(p){return vFilterIds.indexOf(p.location_id)>=0;}),
        orders: (snap.orders||[]).filter(function(o){return vFilterIds.indexOf(o.location_id)>=0;}),
        invoices: (snap.invoices||[]).filter(function(i){return vFilterIds.indexOf(i.location_id)>=0||(i.primary_recipient&&vFilterIds.indexOf(i.primary_recipient.location_id)>=0);}),
        customers: snap.customers || [], catalog: snap.catalog || [], teamMembers: snap.teamMembers || [],
        bankAccounts: snap.bankAccounts || [], merchants: snap.merchants || [], disputes: snap.disputes || [],
        refunds: snap.refunds || [], subscriptions: snap.subscriptions || [], loyalty: snap.loyalty || [],
        giftCards: snap.giftCards || [], bookings: snap.bookings || [], shifts: snap.shifts || [],
        breakTypes: snap.breakTypes || [], cashDrawers: snap.cashDrawers || [], customerSegments: snap.customerSegments || [], customerGroups: snap.customerGroups || []
      };
    }
    var a = squareAnalyze(snap);
    var locName = locFilter === 'all' ? 'All Locations (' + (snap.locations||[]).length + ')' : (snap.locations||[]).map(function(l){return l.name||l.id;}).join(', ');
    var ctx = 'SQUARE DATA FOR: ' + locName + '\n';
    ctx += 'Today: $' + a.revenue.today.toFixed(2) + ' | Week: $' + a.revenue.week.toFixed(2) + ' | 30d: $' + a.revenue.month30d.toFixed(2) + ' | All-Time: $' + a.revenue.allTimeTotal.toFixed(2) + '\n';
    ctx += 'Avg Ticket: $' + a.revenue.avgTicket.toFixed(2) + ' | Tips: $' + a.revenue.tips.toFixed(2) + '\n';
    ctx += 'YEARLY: ' + Object.keys(a.trends.yearlyRevenue).sort().map(function(y){return y+': $'+a.trends.yearlyRevenue[y].toFixed(0);}).join(', ') + '\n';
    var recentM = Object.keys(a.trends.monthlyRevenue).sort().slice(-6);
    ctx += 'RECENT MONTHS: ' + recentM.map(function(m){return m+': $'+a.trends.monthlyRevenue[m].toFixed(0);}).join(', ') + '\n';
    if (a.trends.projections) {
      ctx += 'PROJECTIONS: YTD $' + a.trends.projections.ytdRevenue + ' | Projected Year $' + a.trends.projections.projectedFullYear + ' | Growth ' + a.trends.projections.projectedGrowth + '%\n';
    }
    ctx += 'Customers: ' + a.customers.total + ' | Repeat: ' + a.customerInsights.repeatRate + '% | LTV: $' + a.customerInsights.avgLTV.toFixed(2) + '\n';
    ctx += 'Invoices: ' + a.invoices.total + ' | Paid: ' + a.invoices.paid + ' | Collection: ' + a.invoices.collectionRate + '%\n';
    if (a.invoices.paymentSpeed) ctx += 'Payment Speed: Avg ' + a.invoices.paymentSpeed.avgDays + 'd | Same Day ' + a.invoices.paymentSpeed.sameDay + '% | 30d+ ' + a.invoices.paymentSpeed.over30d + '%\n';
    if (a.invoices.turnaround) ctx += 'Invoice Turnaround: Avg ' + a.invoices.turnaround.avgFormatted + ' | Fastest ' + a.invoices.turnaround.fastest + ' | Slowest ' + a.invoices.turnaround.slowest + '\n';
    ctx += 'Refunds: ' + a.refunds.count + ' ($' + a.refunds.total.toFixed(2) + ') | Rate: ' + a.refunds.rate + '%\n';
    ctx += 'Peak: ' + a.payments.peakDay + ' at ' + a.payments.peakHour + '\n';
    ctx += 'Top Items: ' + a.orders.topItemsByRevenue.slice(0,8).map(function(e){return e[0]+': $'+e[1].revenue.toFixed(0);}).join(', ') + '\n';
    ctx += 'SEASONALITY: ' + Object.keys(a.trends.seasonalAvg).sort().map(function(mo){return ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(mo)]+': $'+a.trends.seasonalAvg[mo];}).join(', ') + '\n';
    ctx += 'Locations: ' + (snap.locations||[]).length + ' total\n';

    var OPENAI_API_KEY = process.env.OPENAI_API_KEY;
    var sysPrompt = 'You are the Square Data Voice Assistant for Wildwood Small Engine Repair. You answer questions about the business Square payment data. You have complete historical data since 2022.\n\nRULES:\n- Be concise: 2-4 sentences max (you are being read aloud)\n- Use specific dollar amounts, percentages, dates\n- When comparing, show the actual numbers\n- Sound confident and analytical\n- No markdown, bullets, or formatting\n- Do NOT mention unpaid invoices or collections\n- If asked about a specific location, you may be viewing filtered data for that location\n\nDATA:\n' + ctx;

    var aiRes = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + OPENAI_API_KEY },
      body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: message }], max_tokens: 300, temperature: 0.7 })
    });
    var aiData = await aiRes.json();
    console.log('Square voice AI status:', aiRes.status, aiData.error ? JSON.stringify(aiData.error) : 'OK');
    if (aiData.error) {
      res.json({ response: 'AI service error: ' + (aiData.error.message || JSON.stringify(aiData.error)) });
      return;
    }
    var response = aiData.choices && aiData.choices[0] ? aiData.choices[0].message.content : 'Could not generate a response.';
    res.json({ response: response });
  } catch(e) {
    console.log('Square voice error:', e.message);
    res.json({ error: e.message });
  }
});


// ==============================
// SQUARE DASHBOARD PAGE
// ==============================
app.get('/square', requireAuth('owner'), async function(req, res) {
  try {
  var session = getVoiceSession(req);
  var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
  html += '<title>WILDWOOD â€” SQUARE</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box;}body{background:#020810;color:#c0d8f0;font-family:Rajdhani,sans-serif;min-height:100vh;}';
  html += '.nav{display:flex;gap:0;border-bottom:1px solid #0a1a2a;overflow-x:auto;}.nav a{font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);white-space:nowrap;}.nav a:hover{color:#c0d8f0;}.nav a.active{color:#10b981;border-color:#10b981;background:rgba(16,185,129,0.08);}';
  html += '.container{max-width:1400px;margin:0 auto;padding:30px 20px;}h1{font-family:Orbitron;font-size:2em;letter-spacing:10px;background:linear-gradient(135deg,#10b981,#0af);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:5px;}.subtitle{font-family:Orbitron;font-size:0.65em;letter-spacing:6px;color:#1a3a5a;margin-bottom:30px;}';
  html += '.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:8px;margin-bottom:20px;}.stat{background:rgba(10,20,35,0.6);border:1px solid #0a1a2a;padding:10px;text-align:center;}.stat-val{font-family:Orbitron;font-size:1.3em;color:#10b981;}.stat-val.warn{color:#f59e0b;}.stat-val.danger{color:#ef4444;}.stat-val.blue{color:#0af;}.stat-label{font-family:Orbitron;font-size:0.42em;letter-spacing:2px;color:#4a6a8a;margin-top:3px;}';
  html += '.section-title{font-family:Orbitron;font-size:0.65em;letter-spacing:4px;color:#10b981;margin:18px 0 8px;}table{width:100%;border-collapse:collapse;}th{font-family:Orbitron;font-size:0.48em;letter-spacing:2px;color:#10b981;text-align:left;padding:5px;border-bottom:1px solid #10b98120;}td{padding:5px;border-bottom:1px solid #0a1520;font-size:0.88em;color:#a0b8d0;}';
  html += '.pill{display:inline-block;padding:2px 8px;font-size:0.68em;font-family:Orbitron;letter-spacing:1px;}.pill-green{background:#10b98120;color:#10b981;}.pill-yellow{background:#f59e0b20;color:#f59e0b;}.pill-red{background:#ef444420;color:#ef4444;}.pill-blue{background:#0af20;color:#0af;}.pill-purple{background:#7c3aed20;color:#a78bfa;}';
  html += '.action-btn{padding:8px 18px;background:rgba(16,185,129,0.1);border:1px solid #10b98140;color:#10b981;font-family:Orbitron;font-size:0.52em;letter-spacing:2px;cursor:pointer;transition:all 0.3s;}.action-btn:hover{background:rgba(16,185,129,0.2);}.action-btn.purple{background:rgba(124,58,237,0.1);border-color:#7c3aed40;color:#7c3aed;}.action-btn.orange{background:rgba(245,158,11,0.1);border-color:#f59e0b40;color:#f59e0b;}.action-btn.blue{background:rgba(0,170,255,0.1);border-color:#0af40;color:#0af;}';
  html += '#analysisPanel{background:rgba(10,20,35,0.8);border:1px solid #10b98115;padding:25px;color:#a0b8d0;line-height:1.8;white-space:pre-wrap;margin-top:12px;display:none;}.chart-area{background:rgba(10,20,35,0.4);border:1px solid #0a1a2a;padding:12px;margin-bottom:12px;height:160px;position:relative;overflow:hidden;}';
  html += '.tab-row{display:flex;gap:0;margin-bottom:12px;overflow-x:auto;}.tab-btn{padding:7px 15px;font-family:Orbitron;font-size:0.48em;letter-spacing:2px;border:1px solid #1a2a3a;background:rgba(5,10,20,0.6);color:#4a6a8a;cursor:pointer;white-space:nowrap;}.tab-btn.active{color:#10b981;border-color:#10b981;background:rgba(16,185,129,0.08);}';
  html += '@media(max-width:768px){.stats{grid-template-columns:repeat(2,1fr);}.nav a{padding:8px 10px;font-size:0.5em;letter-spacing:1px;}}</style></head><body>';
  // Nav
  html += '<div class="nav">';
  if (session && session.access === 'all') {
    html += '<a href="/dashboard">JARVIS</a><a href="/business">ATHENA</a><a href="/tookan">TOOKAN</a><a href="/business/chart">CHARTS</a><a href="/analytics">ANALYTICS</a><a href="/ads">GOOGLE ADS</a>';
    html += '<a href="/square" class="active">SQUARE</a><a href="/discord">DISCORD</a><a href="/followup">FOLLOW UP</a><a href="/ai">AI</a><a href="/forecast">FORECAST</a><a href="/seo">SEO</a><a href="/audit">AUDIT</a>';
  } else { html += '<a href="/square" class="active">SQUARE</a>'; }
  html += '<a href="/auth/logout" style="color:#ef4444;border-color:#ef444440;">LOGOUT</a></div>';
  html += '<div class="container"><h1 style="display:inline;">SQUARE</h1> <button onclick="forceRefresh()" id="refreshBtn" style="background:#1a3a5a;color:#4af;border:1px solid #4af;padding:4px 12px;cursor:pointer;font-family:inherit;font-size:0.8em;margin-left:10px;vertical-align:middle;">âŸ³ REFRESH DATA</button> <button onclick="toggleSquareVoice()" id="sqVoiceBtn" style="background:#1a3a5a;color:#a855f7;border:1px solid #a855f740;padding:4px 12px;cursor:pointer;font-family:inherit;font-size:0.8em;margin-left:6px;vertical-align:middle;">ðŸŽ™ VOICE</button>';
  html += '<div style="margin:10px 0;position:relative;" id="locDropWrap">';
  html += '<div id="locDropBtn" onclick="toggleLocDrop()" style="background:#0a1520;color:#10b981;border:1px solid #10b98140;font-family:Orbitron,sans-serif;font-size:0.75em;padding:8px 14px;width:100%;max-width:500px;cursor:pointer;letter-spacing:1px;display:flex;justify-content:space-between;align-items:center;"><span id="locDropLabel">ðŸ“ ALL LOCATIONS</span><span style="color:#4a6a8a;">â–¼</span></div>';
  html += '<div id="locDropMenu" style="display:none;position:absolute;top:100%;left:0;width:100%;max-width:500px;max-height:350px;overflow-y:auto;background:#0a1520;border:1px solid #10b98140;border-top:none;z-index:100;font-family:Rajdhani,sans-serif;">';
  html += '<label style="display:flex;align-items:center;padding:8px 14px;cursor:pointer;border-bottom:1px solid #0a1a2a;color:#10b981;font-weight:700;font-family:Orbitron;font-size:0.75em;letter-spacing:1px;" onmouseover="this.style.background=\'rgba(16,185,129,0.08)\'" onmouseout="this.style.background=\'none\'"><input type="checkbox" id="locAll" checked onchange="toggleAllLocs()" style="margin-right:10px;accent-color:#10b981;"> ðŸ“ ALL LOCATIONS</label>';
  html += '<div id="locCheckboxes"></div>';
  html += '</div></div>';
  html += '<div class="subtitle">PAYMENTS Â· CUSTOMERS Â· INVOICES Â· ORDERS Â· LABOR Â· CATALOG Â· ANALYTICS</div>';
  html += '<div id="statsGrid"><div style="color:#4a6a8a;padding:20px;">Loading Square data...</div></div>';

  // Locations panel
  html += '<div class="section-title">ðŸ“ LOCATIONS</div>';
  html += '<div id="locationsPanel" style="margin-bottom:15px;"><div style="color:#4a6a8a;">Loading...</div></div>';
  html += '<div class="section-title">ðŸ“ˆ REVENUE <select id="revRange" onchange="renderChart()" style="background:#0a1520;color:#10b981;border:1px solid #10b98140;font-family:Orbitron;font-size:0.8em;padding:2px 8px;margin-left:10px;"><option value="30">30 DAYS</option><option value="90">90 DAYS</option><option value="180">6 MONTHS</option><option value="365">1 YEAR</option><option value="0">ALL TIME</option></select></div><div class="chart-area" id="revenueChart"></div>';
  html += '<div class="section-title">ðŸ• REVENUE BY HOUR</div><div class="chart-area" id="hourChart" style="height:55px;"></div>';

  // Monthly drill-down
  html += '<div class="section-title">ðŸ“… MONTHLY BREAKDOWN</div>';
  html += '<div id="yearTabs" class="tab-row" style="margin-bottom:5px;"></div>';
  html += '<div class="chart-area" id="monthlyChart" style="height:220px;"></div>';
  html += '<div id="monthDetail" style="display:none;background:rgba(10,20,35,0.6);border:1px solid #10b98120;padding:15px;margin-bottom:15px;"></div>';

  // Bollinger Bands
  html += '<div class="section-title">ðŸ“Š BOLLINGER BANDS <select id="bollingerRange" onchange="renderBollinger()" style="background:#0a1520;color:#a855f7;border:1px solid #a855f740;font-family:Orbitron;font-size:0.8em;padding:2px 8px;margin-left:10px;"><option value="0" selected>ALL TIME</option><option value="365">1 YEAR</option><option value="730">2 YEARS</option><option value="180">6 MONTHS</option></select></div>';
  html += '<div style="color:#4a6a8a;font-size:0.8em;margin:-8px 0 10px;line-height:1.5;">Revenue between the bands = normal. Touching upper band = unusually high month (peak demand). Touching lower band = slow month. Bands narrowing = revenue stabilizing. Bands widening = more volatility.</div>';
  html += '<div class="chart-area" id="bollingerChart" style="height:220px;"></div>';

  // Fibonacci Retracement
  html += '<div class="section-title">ðŸ”¢ FIBONACCI CASH FLOW LEVELS</div>';
  html += '<div style="color:#4a6a8a;font-size:0.8em;margin:-8px 0 10px;line-height:1.5;">Revenue targets based on your historical lowâ†’high range. 0% = your lowest month. 100% = your best month. Above 100% = new territory. The 61.8% and 50% levels are key support â€” if revenue drops below these, action may be needed.</div>';
  html += '<div class="chart-area" id="fibChart" style="height:220px;"></div>';

  // YoY comparison
  html += '<div class="section-title">ðŸ“ˆ YEAR OVER YEAR COMPARISON</div>';
  html += '<div style="color:#4a6a8a;font-size:0.8em;margin:-8px 0 10px;line-height:1.5;">Each bar = total revenue for that year. Percentage shows growth vs prior year. Green = grew, Red = shrunk. Use this to track annual trajectory.</div>';
  html += '<div class="chart-area" id="yoyChart" style="height:200px;"></div>';

  // Customer growth
  html += '<div class="section-title">ðŸ‘¥ CUSTOMER ACQUISITION TREND</div>';
  html += '<div class="chart-area" id="custGrowthChart" style="height:180px;"></div>';

  // Seasonal pattern
  html += '<div class="section-title">ðŸŒ¡ï¸ SEASONAL REVENUE PATTERN</div>';
  html += '<div class="chart-area" id="seasonChart" style="height:180px;"></div>';

  // Payment methods
  html += '<div class="section-title">ðŸ’³ PAYMENT METHODS</div>';
  html += '<div class="chart-area" id="methodChart" style="height:150px;"></div>';

  // Moving averages
  html += '<div class="section-title">ðŸ“‰ MOVING AVERAGES <select id="maRange" onchange="renderMA()" style="background:#0a1520;color:#0af;border:1px solid #0af40;font-family:Orbitron;font-size:0.8em;padding:2px 8px;margin-left:10px;"><option value="0" selected>ALL TIME</option><option value="365">1 YEAR</option><option value="730">2 YEARS</option><option value="180">6 MONTHS</option></select></div>';
  html += '<div class="chart-area" id="maChart" style="height:200px;"></div>';

  // Revenue vs Refunds
  html += '<div class="section-title">â†©ï¸ REVENUE vs REFUNDS</div>';
  html += '<div class="chart-area" id="refundChart" style="height:160px;"></div>';
  html += '<div class="section-title">ðŸ’° PAYMENT SPEED DISTRIBUTION</div><div class="chart-area" id="paySpeedChart" style="height:160px;"></div>';
  html += '<div class="section-title">ðŸ”® REVENUE PROJECTIONS (' + new Date().getFullYear() + ')</div><div class="chart-area" id="projChart" style="height:240px;"></div>';
  html += '<div class="section-title">ðŸ“Š MARKET SIGNALS â€” BULLISH / BEARISH</div><div id="signalsPanel" style="background:rgba(10,20,35,0.4);border:1px solid #0a1a2a;padding:16px;margin-bottom:12px;"></div>';
  html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin:18px 0;">';
  html += '<button class="action-btn" onclick="analyze(\'full\')">âš¡ FULL BRIEFING</button>';
  html += '<button class="action-btn purple" onclick="analyze(\'revenue\')">ðŸ’° REVENUE</button>';
  html += '<button class="action-btn orange" onclick="analyze(\'collections\')">ðŸ“‹ COLLECTIONS</button>';
  html += '<button class="action-btn blue" onclick="analyze(\'customers\')">ðŸ‘¥ CUSTOMERS</button>';
  html += '<button class="action-btn" onclick="analyze(\'labor\')" style="border-color:#a78bfa40;color:#a78bfa;">â±ï¸ LABOR</button>';
  html += '<button class="action-btn" onclick="analyze(\'items\')" style="border-color:#ec489940;color:#ec4899;">ðŸ“¦ ITEMS</button></div>';
  html += '<div id="analysisPanel"></div>';
  // Square Voice Panel
  html += '<div id="sqVoicePanel" style="display:none;margin-top:12px;background:rgba(10,20,35,0.9);border:1px solid #a855f730;padding:20px;position:relative;">';
  html += '<div style="text-align:center;font-family:Orbitron;font-size:0.7em;letter-spacing:4px;color:#a855f7;margin-bottom:12px;">ðŸŽ™ SQUARE VOICE ASSISTANT</div>';
  html += '<div id="sqVoiceLog" style="height:200px;overflow-y:auto;margin-bottom:12px;padding:8px;background:rgba(5,10,20,0.5);border:1px solid #0a1a2a;"></div>';
  html += '<div style="display:flex;align-items:center;gap:8px;">';
  html += '<button id="sqMicBtn" onclick="toggleSquareMic()" style="width:50px;height:50px;border-radius:50%;background:rgba(168,85,247,0.15);border:2px solid #a855f7;color:#a855f7;cursor:pointer;font-size:1.4em;transition:all 0.3s;">ðŸŽ¤</button>';
  html += '<input id="sqTextInput" type="text" placeholder="Or type your question about Square data..." style="flex:1;padding:10px 14px;background:rgba(10,20,35,0.8);border:1px solid #a855f730;color:#c0d8f0;font-family:Rajdhani,sans-serif;font-size:1em;outline:none;" onkeypress="if(event.key===\'Enter\')sendSquareText()">';
  html += '<button onclick="sendSquareText()" style="padding:10px 18px;background:#a855f720;border:1px solid #a855f7;color:#a855f7;cursor:pointer;font-family:Orbitron;font-size:0.7em;">SEND</button>';
  html += '</div>';
  html += '<div id="sqVoiceStatus" style="text-align:center;font-family:Orbitron;font-size:0.6em;letter-spacing:3px;color:#4a6a8a;margin-top:8px;">CLICK MIC TO SPEAK</div>';
  html += '<canvas id="sqWaveCanvas" style="position:absolute;bottom:0;left:0;width:100%;height:3px;"></canvas>';
  html += '</div>';
  html += '<div class="tab-row">';
  html += '<button class="tab-btn active" onclick="showTab(\'payments\',this)">ðŸ’³ PAYMENTS</button>';
  html += '<button class="tab-btn" onclick="showTab(\'orders\',this)">ðŸ“¦ ORDERS</button>';
  html += '<button class="tab-btn" onclick="showTab(\'invoices\',this)">ðŸ“‹ INVOICES</button>';
  html += '<button class="tab-btn" onclick="showTab(\'customers\',this)">ðŸ‘¥ CUSTOMERS</button>';
  html += '<button class="tab-btn" onclick="showTab(\'items\',this)">ðŸ·ï¸ TOP ITEMS</button>';
  html += '<button class="tab-btn" onclick="showTab(\'refunds\',this)">â†©ï¸ REFUNDS</button>';
  html += '<button class="tab-btn" onclick="showTab(\'disputes\',this)">âš ï¸ DISPUTES</button>';
  html += '<button class="tab-btn" onclick="showTab(\'payouts\',this)">ðŸ¦ PAYOUTS</button>';
  html += '<button class="tab-btn" onclick="showTab(\'shifts\',this)">â±ï¸ LABOR</button>';
  html += '<button class="tab-btn" onclick="showTab(\'catalog\',this)">ðŸ“‹ CATALOG</button>';
  html += '<button class="tab-btn" onclick="showTab(\'giftcards\',this)">ðŸŽ GIFT CARDS</button>';
  html += '<button class="tab-btn" onclick="showTab(\'subs\',this)">ðŸ”„ SUBS</button></div>';
  html += '<div id="tabContent" style="overflow-x:auto;"><div style="color:#4a6a8a;">Loading...</div></div></div>';
  html += '<script>var D=null;var curTab="payments";';
  html += 'async function loadAll(url){try{var r=await(await fetch(url||"/square/api/snapshot")).json();D=r;if(r.error){document.getElementById("statsGrid").innerHTML="<div style=\\"color:#ef4444;\\">"+r.error+"</div>";return;}renderDebug();renderLocations();renderStats();renderChart();renderHourChart();renderMonthly();renderBollinger();renderFib();renderYoY();renderCustGrowth();renderSeason();renderMethods();renderMA();renderRefundChart();renderPaySpeed();renderProjections();renderSignals();showTab("payments");document.getElementById("refreshBtn").textContent="âŸ³ REFRESH DATA";}catch(e){document.getElementById("statsGrid").innerHTML="<div style=\\"color:#ef4444;\\">"+e.message+"</div>";}}';
  html += 'async function forceRefresh(){document.getElementById("refreshBtn").textContent="âŸ³ REFRESHING...";document.getElementById("refreshBtn").style.color="#f59e0b";var locParam=curLocation&&curLocation!=="all"?"&location="+curLocation:"";await loadAll("/square/api/snapshot?refresh=1"+locParam);document.getElementById("refreshBtn").style.color="#4af";}';

  // Debug panel
  html += 'function renderDebug(){var d=D.debug;if(!d)return;var el=document.getElementById("locationsPanel");';
  html += 'var h="<div style=\\"background:rgba(255,200,0,0.1);border:1px solid #f59e0b;padding:10px;margin-bottom:10px;font-size:0.85em;\\">";';
  html += 'h+="<strong style=\\"color:#f59e0b;\\">âš¡ DEBUG INFO</strong><br>";';
  html += 'h+="Token: <span style=\\"color:#10b981;\\">"+d.token_prefix+"</span> | ";';
  html += 'h+="API: <span style=\\"color:#10b981;\\">"+d.base_url+"</span> | ";';
  html += 'h+="Env: <span style=\\"color:#10b981;\\">"+d.square_env+"</span><br>";';
  html += 'h+="Raw Payments: <span style=\\"color:#ef4444;font-weight:700;\\">"+d.raw_payments+"</span> | ";';
  html += 'h+="Raw Orders: <span style=\\"color:#ef4444;font-weight:700;\\">"+d.raw_orders+"</span> | ";';
  html += 'h+="Raw Invoices: <span style=\\"color:#ef4444;font-weight:700;\\">"+d.raw_invoices+"</span> | ";';
  html += 'h+="Raw Customers: <span style=\\"color:#10b981;font-weight:700;\\">"+d.raw_customers+"</span> | ";';
  html += 'h+="Locations: <span style=\\"color:#10b981;font-weight:700;\\">"+d.locations+"</span>";';
  html += 'h+="</div>";el.insertAdjacentHTML("beforebegin",h);}';

  // Locations
  html += 'function renderLocations(){var locs=D.locations||[];var el=document.getElementById("locationsPanel");';
  html += 'if(!locs.length){el.innerHTML="<div style=\\"color:#ef4444;\\">No locations found â€” check API permissions</div>";return;}';
  html += 'var h="<div style=\\"display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:8px;\\">";';
  html += 'locs.forEach(function(l){var sc=l.status==="ACTIVE"?"#10b981":"#ef4444";';
  html += 'h+="<div style=\\"background:rgba(10,20,35,0.6);border:1px solid "+sc+"30;padding:10px;\\">";';
  html += 'h+="<div style=\\"display:flex;justify-content:space-between;\\"><span style=\\"color:"+sc+";font-weight:700;\\">"+l.name+"</span><span class=\\"pill "+(l.status==="ACTIVE"?"pill-green":"pill-red")+"\\">"+l.status+"</span></div>";';
  html += 'if(l.businessName)h+="<div style=\\"font-size:0.85em;color:#4a6a8a;\\">"+l.businessName+"</div>";';
  html += 'if(l.phone)h+="<div style=\\"font-size:0.85em;color:#4a6a8a;\\">"+l.phone+"</div>";';
  html += 'if(l.address)h+="<div style=\\"font-size:0.8em;color:#4a6a8a;\\">"+(l.address.address_line_1||"")+" "+(l.address.locality||"")+" "+(l.address.administrative_district_level_1||"")+"</div>";';
  html += 'h+="<div style=\\"font-size:0.7em;color:#1a3a5a;margin-top:4px;\\">ID: "+l.id+"</div>";';
  html += 'if(l.capabilities)h+="<div style=\\"font-size:0.7em;color:#4a6a8a;margin-top:2px;\\">Capabilities: "+l.capabilities.join(", ")+"</div>";';
  html += 'h+="</div>";});';
  html += 'h+="</div>";el.innerHTML=h;}';
  html += 'function renderStats(){if(!D||!D.analytics)return;var a=D.analytics;var h="";';
  // Revenue section
  html += 'h+="<div class=\\"section-title\\">ðŸ’° REVENUE</div><div class=\\"stats\\">";';
  html += 'h+=sc("$"+a.revenue.today.toFixed(0),"TODAY","");h+=sc("$"+a.revenue.week.toFixed(0),"THIS WEEK","");h+=sc((a.revenue.weekGrowth>=0?"+":"")+a.revenue.weekGrowth+"%","WEEK GROWTH",a.revenue.weekGrowth>=0?"":"danger");';
  html += 'h+=sc("$"+a.revenue.month30d.toFixed(0),"30-DAY REV","");h+=sc("$"+a.revenue.net.toFixed(0),"NET REVENUE","blue");h+=sc("$"+a.revenue.tips.toFixed(0),"TIPS","");h+=sc("$"+a.revenue.fees.toFixed(0),"FEES","warn");';
  html += 'h+=sc("$"+a.revenue.avgTicket.toFixed(0),"AVG TICKET","");h+=sc("$"+a.revenue.medianTicket.toFixed(0),"MEDIAN","blue");h+=sc("$"+a.revenue.avgDailyRev.toFixed(0),"AVG DAILY","");';
  html += 'h+=sc("$"+Math.round(a.revenue.allTimeTotal).toLocaleString(),"ALL-TIME GROSS","blue");';
  html += 'h+="</div>";';
  // Yearly revenue
  html += 'if(a.trends){h+="<div class=\\"section-title\\">ðŸ“… YEARLY BREAKDOWN</div><div class=\\"stats\\">";var yrs=Object.keys(a.trends.yearlyRevenue).sort();yrs.forEach(function(y){h+=sc("$"+Math.round(a.trends.yearlyRevenue[y]).toLocaleString(),y+" REVENUE","blue");});';
  html += 'if(a.trends.bestMonth)h+=sc("$"+Math.round(a.trends.bestMonth[1]).toLocaleString(),"BEST: "+a.trends.bestMonth[0],"");';
  html += 'if(a.trends.worstMonth)h+=sc("$"+Math.round(a.trends.worstMonth[1]).toLocaleString(),"WORST: "+a.trends.worstMonth[0],"warn");';
  html += 'h+=sc(a.trends.totalMonths,"MONTHS DATA","blue");h+="</div>";}';
  // Projections
  html += 'if(a.trends&&a.trends.projections){var pj=a.trends.projections;h+="<div class=\\"section-title\\">ðŸ“ˆ PROJECTIONS ("+new Date().getFullYear()+")</div><div class=\\"stats\\">";';
  html += 'h+=sc("$"+Math.round(pj.ytdRevenue).toLocaleString(),"YTD REVENUE","blue");h+=sc("$"+Math.round(pj.projectedFullYear).toLocaleString(),"PROJECTED YEAR","blue");h+=sc("$"+Math.round(pj.conservativeFullYear).toLocaleString(),"CONSERVATIVE","");h+=sc("$"+Math.round(pj.optimisticFullYear).toLocaleString(),"OPTIMISTIC","");h+=sc("$"+Math.round(pj.lastYearTotal).toLocaleString(),"LAST YEAR TOTAL","");h+=sc((pj.projectedGrowth>=0?"+":"")+pj.projectedGrowth+"%","PROJ GROWTH",pj.projectedGrowth>0?"":"warn");h+="</div>";}';
  // Orders & Operations
  html += 'h+="<div class=\\"section-title\\">ðŸ“¦ ORDERS & OPS</div><div class=\\"stats\\">";';
  html += 'h+=sc(a.payments.completed,a.payments.dataSource==="orders"?"ORDERS":"PAYMENTS","");h+=sc(a.payments.failed,"FAILED",a.payments.failed>0?"danger":"");';
  html += 'h+=sc(a.orders.uniqueItems,"ITEMS SOLD","");h+=sc("$"+a.orders.discountTotal.toFixed(0),"DISCOUNTS","warn");h+=sc("$"+a.orders.taxCollected.toFixed(0),"TAX","");';
  html += 'h+=sc(a.payments.peakHour,"PEAK HOUR","blue");h+=sc(a.payments.peakDay,"PEAK DAY","blue");';
  html += 'h+=sc(a.refunds.count,"REFUNDS",a.refunds.count>0?"warn":"");h+=sc(a.refunds.rate+"%","REFUND RATE",parseFloat(a.refunds.rate)>5?"danger":"");h+=sc(a.disputes.open,"DISPUTES",a.disputes.open>0?"danger":"");';
  html += 'h+="</div>";';
  // Customers
  html += 'h+="<div class=\\"section-title\\">ðŸ‘¥ CUSTOMERS</div><div class=\\"stats\\">";';
  html += 'h+=sc(a.customers.total,"CUSTOMERS","");h+=sc(a.customers.new30d,"NEW 30D","blue");h+=sc(a.customers.emailCaptureRate+"%","EMAIL RATE",a.customers.emailCaptureRate<50?"warn":"");';
  html += 'if(a.customerInsights){h+=sc(a.customerInsights.repeatRate+"%","REPEAT RATE",a.customerInsights.repeatRate<20?"warn":"");';
  html += 'h+=sc("$"+Math.round(a.customerInsights.avgLTV),"AVG LIFETIME VALUE","");';
  html += 'h+=sc(a.customerInsights.uniquePayingCustomers,"PAYING CUSTOMERS","");';
  html += 'h+=sc(a.customerInsights.repeatCustomers,"REPEAT BUYERS","blue");}';
  html += 'h+="</div>";';
  // Invoices
  html += 'h+="<div class=\\"section-title\\">ðŸ“„ INVOICES</div><div class=\\"stats\\">";';
  html += 'h+=sc(a.invoices.unpaid,"UNPAID",a.invoices.unpaid>0?"warn":"");h+=sc("$"+a.invoices.unpaidTotal.toFixed(0),"OUTSTANDING",a.invoices.unpaidTotal>0?"warn":"");h+=sc(a.invoices.overdue,"OVERDUE",a.invoices.overdue>0?"danger":"");h+=sc(a.invoices.collectionRate+"%","COLLECT RATE",a.invoices.collectionRate<70?"warn":"");';
  html += 'if(a.invoices.turnaround){h+=sc(a.invoices.turnaround.avgFormatted,"AVG INVOICE TIME","blue");h+=sc(a.invoices.turnaround.medianFormatted,"MEDIAN INV TIME","");h+=sc(a.invoices.turnaround.fastest,"FASTEST INVOICE","");h+=sc(a.invoices.turnaround.slowest,"SLOWEST INVOICE","warn");}';
  html += 'h+="</div>";';
  // Payment Speed
  html += 'if(a.invoices.paymentSpeed){var ps=a.invoices.paymentSpeed;h+="<div class=\\"section-title\\">âš¡ PAYMENT SPEED</div><div class=\\"stats\\">";h+=sc(ps.avgDays+"d","AVG PAY TIME","blue");h+=sc(ps.medianDays+"d","MEDIAN PAY","");h+=sc(ps.sameDay+"%","SAME DAY PAY","");h+=sc(ps.within3d+"%","PAID â‰¤3 DAYS","");h+=sc(ps.within7d+"%","PAID â‰¤7 DAYS","");h+=sc(ps.over30d+"%","PAID 30+ DAYS",ps.over30d>20?"danger":"");h+="</div>";}';
  // Labor & Assets
  html += 'h+="<div class=\\"section-title\\">ðŸ¢ LABOR & ASSETS</div><div class=\\"stats\\">";';
  html += 'h+=sc(a.labor.totalHoursWorked+"h","LABOR 14D","blue");h+=sc(a.labor.avgShiftLength+"h","AVG SHIFT","");';
  html += 'h+=sc(a.giftCards.active,"GIFT CARDS","");h+=sc("$"+a.giftCards.totalBalance.toFixed(0),"GC BALANCE","blue");h+=sc(a.subscriptions.active,"SUBS","");';
  html += 'h+=sc(a.team.active+"/"+a.team.total,"TEAM","");h+=sc(a.devices.total,"DEVICES","");';
  html += 'h+="</div>";';
  html += 'document.getElementById("statsGrid").innerHTML=h;}function sc(v,l,cls){return "<div class=\\"stat\\"><div class=\\"stat-val "+(cls||"")+"\\">"+v+"</div><div class=\\"stat-label\\">"+l+"</div></div>";}';
  // Charts
  // Date filter helper
  html += 'function filterDays(bd,rangeDays){if(!rangeDays||rangeDays==="0"||rangeDays===0)return bd;var cutoff=new Date(Date.now()-rangeDays*86400000).toISOString().substring(0,10);var out={};Object.keys(bd).forEach(function(k){if(k>=cutoff)out[k]=bd[k];});return out;}';
  html += 'function renderChart(){var c=document.getElementById("revenueChart");if(!D||!D.analytics)return;var range=parseInt(document.getElementById("revRange").value)||30;var bd=filterDays(D.analytics.payments.byDay,range);var days=Object.keys(bd).sort();var vals=days.map(function(k){return bd[k];});if(!days.length){c.innerHTML="<div style=\\"color:#4a6a8a;text-align:center;padding-top:60px;\\">No data for range</div>";return;}var max=Math.max.apply(null,vals)||1;var bw=Math.max(2,Math.min(16,((c.offsetWidth-40)/days.length)-2));var h="<svg width=\\"100%\\" height=\\"140\\">";days.forEach(function(d,i){var pct=vals[i]/max;var bh=Math.max(2,pct*120);var x=20+i*(bw+2);h+="<rect x=\\""+x+"\\" y=\\""+Math.round(130-bh)+"\\" width=\\""+bw+"\\" height=\\""+Math.round(bh)+"\\" fill=\\"#10b981\\" opacity=\\"0.7\\"><title>"+d+": $"+vals[i].toFixed(2)+"</title></rect>";});h+="<text x=\\"0\\" y=\\"12\\" fill=\\"#10b981\\" font-size=\\"9\\" font-family=\\"Orbitron\\">$"+max.toFixed(0)+"</text></svg>";c.innerHTML=h;}';
  html += 'function renderHourChart(){var c=document.getElementById("hourChart");if(!D||!D.analytics)return;var bh=D.analytics.payments.byHour;var max=0;for(var k in bh){if(bh[k]>max)max=bh[k];}if(!max){c.innerHTML="";return;}var h="<svg width=\\"100%\\" height=\\"45\\">";for(var hr=0;hr<24;hr++){var v=bh[hr]||0;var opacity=Math.max(0.05,v/max);var x=(hr/24)*100;h+="<rect x=\\""+x+"%\\" y=\\"4\\" width=\\"3.8%\\" height=\\"25\\" fill=\\"#10b981\\" opacity=\\""+opacity.toFixed(2)+"\\" rx=\\"2\\"><title>"+hr+":00 $"+v.toFixed(0)+"</title></rect>";if(hr%3===0)h+="<text x=\\""+(x+0.5)+"%\\" y=\\"42\\" fill=\\"#4a6a8a\\" font-size=\\"7\\" font-family=\\"Orbitron\\">"+hr+"</text>";}h+="</svg>";c.innerHTML=h;}';

  // SVG chart helper
  html += 'function svgLine(pts,color,w,h,maxY,dash){var path="";pts.forEach(function(p,i){var x=(i/(pts.length-1))*w;var y=h-(p/maxY)*h;path+=(i===0?"M":"L")+x.toFixed(1)+","+y.toFixed(1);});return "<path d=\\""+path+"\\" stroke=\\""+color+"\\" fill=\\"none\\" stroke-width=\\"1.5\\" "+(dash?"stroke-dasharray=\\"4,3\\"":"")+" />";}';
  html += 'function svgArea(pts,color,w,h,maxY){var path="M0,"+h;pts.forEach(function(p,i){var x=(i/(pts.length-1))*w;var y=h-(p/maxY)*h;path+="L"+x.toFixed(1)+","+y.toFixed(1);});path+="L"+w+","+h+"Z";return "<path d=\\""+path+"\\" fill=\\""+color+"\\" opacity=\\"0.15\\" />";}';

  // MONTHLY BREAKDOWN with year tabs
  html += 'function renderMonthly(){if(!D||!D.analytics||!D.analytics.trends)return;var mr=D.analytics.trends.monthlyRevenue;var mc=D.analytics.trends.monthlyPaymentCount;var years={};Object.keys(mr).forEach(function(m){var y=m.substring(0,4);if(!years[y])years[y]=[];years[y].push({month:m,rev:mr[m],count:mc[m]||0});});';
  html += 'var yrs=Object.keys(years).sort();var tb=document.getElementById("yearTabs");var h="";yrs.forEach(function(y,i){h+="<button class=\\"tab-btn "+(i===yrs.length-1?"active":"")+"\\" onclick=\\"renderMonthBars(\'"+y+"\',this)\\">"+y+"</button>";});tb.innerHTML=h;';
  html += 'if(yrs.length>0)renderMonthBars(yrs[yrs.length-1]);}';

  html += 'var monthlyData={};function renderMonthBars(year,el){if(!D||!D.analytics)return;var mr=D.analytics.trends.monthlyRevenue;var mc=D.analytics.trends.monthlyPaymentCount;var mat=D.analytics.trends.monthlyAvgTicket;';
  html += 'if(el){document.querySelectorAll("#yearTabs .tab-btn").forEach(function(b){b.classList.remove("active");});el.classList.add("active");}';
  html += 'var months=[];for(var i=1;i<=12;i++){var key=year+"-"+(i<10?"0":"")+i;months.push({month:key,label:["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][i],rev:mr[key]||0,count:mc[key]||0,avg:mat[key]||0});}';
  html += 'monthlyData=months;var max=0;months.forEach(function(m){if(m.rev>max)max=m.rev;});if(!max)max=1;';
  html += 'var c=document.getElementById("monthlyChart");var W=c.offsetWidth-60;var bw=Math.max(20,(W/12)-8);';
  html += 'var h="<svg width=\\"100%\\" height=\\"210\\">";';
  html += 'months.forEach(function(m,i){var bh=Math.max(2,(m.rev/max)*160);var x=40+i*(bw+6);var clr=m.rev>0?"#10b981":"#1a2a3a";';
  html += 'h+="<rect x=\\""+x+"\\" y=\\""+Math.round(175-bh)+"\\" width=\\""+bw+"\\" height=\\""+Math.round(bh)+"\\" fill=\\""+clr+"\\" rx=\\"2\\" style=\\"cursor:pointer\\" onclick=\\"showMonthDetail("+i+")\\" ><title>"+m.label+" "+year+": $"+m.rev.toFixed(2)+" ("+m.count+" payments, avg $"+m.avg+")</title></rect>";';
  html += 'h+="<text x=\\""+(x+bw/2)+"\\" y=\\"192\\" fill=\\"#4a6a8a\\" font-size=\\"8\\" font-family=\\"Orbitron\\" text-anchor=\\"middle\\">"+m.label+"</text>";';
  html += 'if(m.rev>0)h+="<text x=\\""+(x+bw/2)+"\\" y=\\""+Math.round(170-bh)+"\\" fill=\\"#10b981\\" font-size=\\"7\\" font-family=\\"Orbitron\\" text-anchor=\\"middle\\">$"+Math.round(m.rev)+"</text>";});';
  html += 'h+="<text x=\\"5\\" y=\\"12\\" fill=\\"#4a6a8a\\" font-size=\\"8\\" font-family=\\"Orbitron\\">$"+Math.round(max)+"</text>";';
  html += 'h+="<line x1=\\"40\\" y1=\\"175\\" x2=\\""+Math.round(40+12*(bw+6))+"\\" y2=\\"175\\" stroke=\\"#1a3a5a\\"/></svg>";c.innerHTML=h;}';

  // Month detail panel
  html += 'function showMonthDetail(i){var m=monthlyData[i];if(!m||m.rev===0){document.getElementById("monthDetail").style.display="none";return;}';
  html += 'var d=document.getElementById("monthDetail");d.style.display="block";';
  html += 'd.innerHTML="<div style=\\"font-family:Orbitron;font-size:0.7em;color:#10b981;letter-spacing:3px;margin-bottom:8px;\\">"+m.label.toUpperCase()+" "+m.month.substring(0,4)+"</div>"';
  html += '+"<div style=\\"display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;\\">"';
  html += '+"<div style=\\"text-align:center;\\"><div style=\\"font-family:Orbitron;font-size:1.2em;color:#10b981;\\">$"+m.rev.toFixed(2)+"</div><div style=\\"font-family:Orbitron;font-size:0.4em;color:#4a6a8a;\\">REVENUE</div></div>"';
  html += '+"<div style=\\"text-align:center;\\"><div style=\\"font-family:Orbitron;font-size:1.2em;color:#0af;\\">"+m.count+"</div><div style=\\"font-family:Orbitron;font-size:0.4em;color:#4a6a8a;\\">PAYMENTS</div></div>"';
  html += '+"<div style=\\"text-align:center;\\"><div style=\\"font-family:Orbitron;font-size:1.2em;color:#a78bfa;\\">$"+m.avg+"</div><div style=\\"font-family:Orbitron;font-size:0.4em;color:#4a6a8a;\\">AVG TICKET</div></div>"';
  html += '+"</div>";}';

  // BOLLINGER BANDS
  html += 'function renderBollinger(){var c=document.getElementById("bollingerChart");if(!D||!D.analytics||!D.analytics.trends)return;var mr=D.analytics.trends.monthlyRevenue;var months=Object.keys(mr).sort();var range=parseInt(document.getElementById("bollingerRange").value)||0;if(range>0){var cutoff=new Date(Date.now()-range*86400000).toISOString().substring(0,7);months=months.filter(function(m){return m>=cutoff;});}var vals=months.map(function(k){return mr[k];});if(months.length<5){c.innerHTML="<div style=\\"color:#4a6a8a;text-align:center;padding-top:80px;\\">Need 5+ months â€” select a wider range</div>";return;}';
  html += 'var period=Math.min(20,Math.floor(months.length/2));var ma=[];var upper=[];var lower=[];';
  html += 'for(var i=0;i<vals.length;i++){if(i<period-1){ma.push(null);upper.push(null);lower.push(null);continue;}';
  html += 'var slice=vals.slice(i-period+1,i+1);var avg=slice.reduce(function(a,b){return a+b;},0)/period;';
  html += 'var variance=slice.reduce(function(a,b){return a+Math.pow(b-avg,2);},0)/period;var std=Math.sqrt(variance);';
  html += 'ma.push(avg);upper.push(avg+2*std);lower.push(avg-2*std);}';
  html += 'var allVals=vals.concat(upper.filter(function(v){return v!==null;}));var maxY=Math.max.apply(null,allVals)||1;var minY=0;';
  html += 'var W=c.offsetWidth-20;var H=200;';
  html += 'var h="<svg width=\\"100%\\" height=\\""+H+"\\">";';
  // Upper band area fill
  html += 'var areaPath="";var started=false;for(var i=0;i<vals.length;i++){if(upper[i]===null)continue;var x=(i/(vals.length-1))*W+10;if(!started){areaPath+="M"+x.toFixed(1)+","+(H-(upper[i]/maxY)*H).toFixed(1);started=true;}else{areaPath+="L"+x.toFixed(1)+","+(H-(upper[i]/maxY)*H).toFixed(1);}}';
  html += 'for(var i=vals.length-1;i>=0;i--){if(lower[i]===null)continue;var x=(i/(vals.length-1))*W+10;areaPath+="L"+x.toFixed(1)+","+(H-(Math.max(0,lower[i])/maxY)*H).toFixed(1);}areaPath+="Z";';
  html += 'h+="<path d=\\""+areaPath+"\\" fill=\\"#7c3aed\\" opacity=\\"0.1\\" />";';
  // Price line
  html += 'var pricePath="";vals.forEach(function(v,i){var x=(i/(vals.length-1))*W+10;var y=H-(v/maxY)*H;pricePath+=(i===0?"M":"L")+x.toFixed(1)+","+y.toFixed(1);});';
  html += 'h+="<path d=\\""+pricePath+"\\" stroke=\\"#10b981\\" fill=\\"none\\" stroke-width=\\"1.5\\" />";';
  // MA line
  html += 'var maPath="";var maStarted=false;ma.forEach(function(v,i){if(v===null)return;var x=(i/(vals.length-1))*W+10;var y=H-(v/maxY)*H;maPath+=(maStarted?"L":"M")+x.toFixed(1)+","+y.toFixed(1);maStarted=true;});';
  html += 'h+="<path d=\\""+maPath+"\\" stroke=\\"#f59e0b\\" fill=\\"none\\" stroke-width=\\"1.5\\" stroke-dasharray=\\"4,3\\" />";';
  // Upper band
  html += 'var upPath="";var upStarted=false;upper.forEach(function(v,i){if(v===null)return;var x=(i/(vals.length-1))*W+10;var y=H-(v/maxY)*H;upPath+=(upStarted?"L":"M")+x.toFixed(1)+","+y.toFixed(1);upStarted=true;});';
  html += 'h+="<path d=\\""+upPath+"\\" stroke=\\"#7c3aed\\" fill=\\"none\\" stroke-width=\\"1\\" opacity=\\"0.5\\" />";';
  // Lower band
  html += 'var loPath="";var loStarted=false;lower.forEach(function(v,i){if(v===null)return;var x=(i/(vals.length-1))*W+10;var y=H-(Math.max(0,v)/maxY)*H;loPath+=(loStarted?"L":"M")+x.toFixed(1)+","+y.toFixed(1);loStarted=true;});';
  html += 'h+="<path d=\\""+loPath+"\\" stroke=\\"#7c3aed\\" fill=\\"none\\" stroke-width=\\"1\\" opacity=\\"0.5\\" />";';
  // Labels
  html += 'h+="<text x=\\""+W+"\\" y=\\"12\\" fill=\\"#10b981\\" font-size=\\"8\\" font-family=\\"Orbitron\\" text-anchor=\\"end\\">PRICE</text>";';
  html += 'h+="<text x=\\""+W+"\\" y=\\"22\\" fill=\\"#f59e0b\\" font-size=\\"8\\" font-family=\\"Orbitron\\" text-anchor=\\"end\\">MA"+period+"</text>";';
  html += 'h+="<text x=\\""+W+"\\" y=\\"32\\" fill=\\"#7c3aed\\" font-size=\\"8\\" font-family=\\"Orbitron\\" text-anchor=\\"end\\">Â±2Ïƒ BANDS</text>";';
  html += 'h+="<text x=\\"5\\" y=\\"12\\" fill=\\"#4a6a8a\\" font-size=\\"8\\" font-family=\\"Orbitron\\">$"+Math.round(maxY)+"</text>";';
  html += 'h+="</svg>";c.innerHTML=h;}';

  // FIBONACCI RETRACEMENT
  html += 'function renderFib(){var c=document.getElementById("fibChart");if(!D||!D.analytics||!D.analytics.trends)return;var mr=D.analytics.trends.monthlyRevenue;var days=Object.keys(mr).sort();var vals=days.map(function(k){return mr[k];});if(days.length<3){c.innerHTML="<div style=\\"color:#4a6a8a;text-align:center;padding-top:80px;\\">Need more data</div>";return;}';
  // Cumulative cash flow
  html += 'var cum=[];var running=0;vals.forEach(function(v){running+=v;cum.push(running);});';
  html += 'var high=Math.max.apply(null,cum);var low=Math.min.apply(null,cum);var diff=high-low;';
  html += 'var fibs=[{level:0,pct:"0%",val:high},{level:0.236,pct:"23.6%",val:high-diff*0.236},{level:0.382,pct:"38.2%",val:high-diff*0.382},{level:0.5,pct:"50%",val:high-diff*0.5},{level:0.618,pct:"61.8%",val:high-diff*0.618},{level:0.786,pct:"78.6%",val:high-diff*0.786},{level:1,pct:"100%",val:low}];';
  html += 'var maxY=high*1.05;if(maxY===0)maxY=1;var W=c.offsetWidth-80;var H=200;';
  html += 'var h="<svg width=\\"100%\\" height=\\""+H+"\\">";';
  // Cash flow line
  html += 'var path="";cum.forEach(function(v,i){var x=70+(i/(cum.length-1))*W;var y=H*0.05+((maxY-v)/maxY)*(H*0.9);path+=(i===0?"M":"L")+x.toFixed(1)+","+y.toFixed(1);});';
  html += 'h+="<path d=\\""+path+"\\" stroke=\\"#10b981\\" fill=\\"none\\" stroke-width=\\"2\\" />";';
  // Fib levels
  html += 'var colors=["#10b981","#0af","#0af","#f59e0b","#f59e0b","#ef4444","#ef4444"];';
  html += 'fibs.forEach(function(f,i){var y=H*0.05+((maxY-f.val)/maxY)*(H*0.9);';
  html += 'h+="<line x1=\\"70\\" y1=\\""+y.toFixed(1)+"\\" x2=\\""+(70+W)+"\\" y2=\\""+y.toFixed(1)+"\\" stroke=\\""+colors[i]+"\\" stroke-width=\\"1\\" stroke-dasharray=\\"3,3\\" opacity=\\"0.6\\" />";';
  html += 'h+="<text x=\\"2\\" y=\\""+(y+3).toFixed(1)+"\\" fill=\\""+colors[i]+"\\" font-size=\\"7\\" font-family=\\"Orbitron\\">"+f.pct+"</text>";';
  html += 'h+="<text x=\\"30\\" y=\\""+(y+3).toFixed(1)+"\\" fill=\\"#4a6a8a\\" font-size=\\"7\\" font-family=\\"Orbitron\\">$"+Math.round(f.val)+"</text>";});';
  html += 'h+="</svg>";c.innerHTML=h;}';

  // YEAR OVER YEAR
  html += 'function renderYoY(){var c=document.getElementById("yoyChart");if(!D||!D.analytics||!D.analytics.trends)return;var yr=D.analytics.trends.yearlyRevenue;var yp=D.analytics.trends.yearlyPayments;var yrs=Object.keys(yr).sort();if(!yrs.length){c.innerHTML="";return;}';
  html += 'var max=0;yrs.forEach(function(y){if(yr[y]>max)max=yr[y];});if(!max)max=1;';
  html += 'var W=c.offsetWidth-40;var bw=Math.max(40,Math.min(80,(W/yrs.length)-20));';
  html += 'var h="<svg width=\\"100%\\" height=\\"180\\">";yrs.forEach(function(y,i){var bh=Math.max(2,(yr[y]/max)*140);var x=30+i*(bw+15);var growth="";';
  html += 'if(i>0){var prev=yr[yrs[i-1]];var pct=prev>0?Math.round(((yr[y]-prev)/prev)*100):0;growth=(pct>=0?"+":"")+pct+"%";}';
  html += 'h+="<rect x=\\""+x+"\\" y=\\""+Math.round(155-bh)+"\\" width=\\""+bw+"\\" height=\\""+Math.round(bh)+"\\" fill=\\"#10b981\\" rx=\\"3\\" opacity=\\"0.8\\"><title>"+y+": $"+yr[y].toFixed(2)+" ("+yp[y]+" payments)</title></rect>";';
  html += 'h+="<text x=\\""+(x+bw/2)+"\\" y=\\"170\\" fill=\\"#c0d8f0\\" font-size=\\"11\\" font-family=\\"Orbitron\\" text-anchor=\\"middle\\" font-weight=\\"700\\">"+y+"</text>";';
  html += 'h+="<text x=\\""+(x+bw/2)+"\\" y=\\""+Math.round(150-bh)+"\\" fill=\\"#10b981\\" font-size=\\"9\\" font-family=\\"Orbitron\\" text-anchor=\\"middle\\">$"+Math.round(yr[y])+"</text>";';
  html += 'if(growth){var gc=growth.startsWith("+")?  "#10b981":"#ef4444";h+="<text x=\\""+(x+bw/2)+"\\" y=\\""+Math.round(140-bh)+"\\" fill=\\""+gc+"\\" font-size=\\"8\\" font-family=\\"Orbitron\\" text-anchor=\\"middle\\">"+growth+"</text>";}});';
  html += 'h+="</svg>";c.innerHTML=h;}';

  // CUSTOMER GROWTH
  html += 'function renderCustGrowth(){var c=document.getElementById("custGrowthChart");if(!D||!D.analytics||!D.analytics.trends)return;var mc=D.analytics.trends.monthlyCustomers;var months=Object.keys(mc).sort();if(!months.length){c.innerHTML="";return;}';
  html += 'var vals=months.map(function(m){return mc[m];});var cum=[];var running=0;vals.forEach(function(v){running+=v;cum.push(running);});';
  html += 'var max=Math.max.apply(null,cum)||1;var W=c.offsetWidth-40;var H=160;';
  html += 'var h="<svg width=\\"100%\\" height=\\""+H+"\\">";';
  // Area fill
  html += 'var aPath="M20,"+H;cum.forEach(function(v,i){var x=20+(i/(cum.length-1))*W;var y=H-(v/max)*(H-20);aPath+="L"+x.toFixed(1)+","+y.toFixed(1);});aPath+="L"+(20+W)+","+H+"Z";';
  html += 'h+="<path d=\\""+aPath+"\\" fill=\\"#0af\\" opacity=\\"0.1\\" />";';
  // Line
  html += 'var lPath="";cum.forEach(function(v,i){var x=20+(i/(cum.length-1))*W;var y=H-(v/max)*(H-20);lPath+=(i===0?"M":"L")+x.toFixed(1)+","+y.toFixed(1);});';
  html += 'h+="<path d=\\""+lPath+"\\" stroke=\\"#0af\\" fill=\\"none\\" stroke-width=\\"2\\" />";';
  // Monthly bars underneath
  html += 'var bMax=Math.max.apply(null,vals)||1;vals.forEach(function(v,i){var x=20+(i/(vals.length-1))*W;var bh=(v/bMax)*40;h+="<rect x=\\""+(x-2)+"\\" y=\\""+(H-bh)+"\\" width=\\"4\\" height=\\""+bh+"\\" fill=\\"#7c3aed\\" opacity=\\"0.4\\" />";});';
  html += 'h+="<text x=\\"5\\" y=\\"12\\" fill=\\"#0af\\" font-size=\\"8\\" font-family=\\"Orbitron\\">"+max+" total</text>";';
  html += 'h+="<text x=\\""+W+"\\" y=\\"12\\" fill=\\"#7c3aed\\" font-size=\\"8\\" font-family=\\"Orbitron\\" text-anchor=\\"end\\">Monthly New</text>";';
  html += 'h+="</svg>";c.innerHTML=h;}';

  // SEASONAL PATTERN
  html += 'function renderSeason(){var c=document.getElementById("seasonChart");if(!D||!D.analytics||!D.analytics.trends)return;var sa=D.analytics.trends.seasonalAvg;var months=["01","02","03","04","05","06","07","08","09","10","11","12"];var labels=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];';
  html += 'var vals=months.map(function(m){return sa[m]||0;});var max=Math.max.apply(null,vals)||1;';
  html += 'var W=c.offsetWidth-40;var bw=Math.max(15,(W/12)-6);var H=160;';
  html += 'var h="<svg width=\\"100%\\" height=\\""+H+"\\">";vals.forEach(function(v,i){var bh=Math.max(2,(v/max)*130);var x=20+i*(bw+5);';
  html += 'var pct=v/max;var clr=pct>0.8?"#10b981":pct>0.5?"#0af":pct>0.3?"#f59e0b":"#ef4444";';
  html += 'h+="<rect x=\\""+x+"\\" y=\\""+Math.round(145-bh)+"\\" width=\\""+bw+"\\" height=\\""+Math.round(bh)+"\\" fill=\\""+clr+"\\" rx=\\"2\\" opacity=\\"0.8\\"><title>"+labels[i]+": avg $"+v+"</title></rect>";';
  html += 'h+="<text x=\\""+(x+bw/2)+"\\" y=\\"158\\" fill=\\"#4a6a8a\\" font-size=\\"7\\" font-family=\\"Orbitron\\" text-anchor=\\"middle\\">"+labels[i]+"</text>";';
  html += 'if(v>0)h+="<text x=\\""+(x+bw/2)+"\\" y=\\""+Math.round(140-bh)+"\\" fill=\\""+clr+"\\" font-size=\\"7\\" font-family=\\"Orbitron\\" text-anchor=\\"middle\\">$"+v+"</text>";});';
  html += 'h+="</svg>";c.innerHTML=h;}';

  // PAYMENT METHODS
  html += 'function renderMethods(){var c=document.getElementById("methodChart");if(!D||!D.analytics)return;var bm=D.analytics.payments.byMethod;var entries=Object.entries(bm).sort(function(a,b){return b[1].total-a[1].total;});if(!entries.length){c.innerHTML="";return;}';
  html += 'var total=entries.reduce(function(s,e){return s+e[1].total;},0)||1;var colors=["#10b981","#0af","#7c3aed","#f59e0b","#ef4444","#ec4899","#a78bfa"];';
  html += 'var W=c.offsetWidth;var H=130;var h="<svg width=\\"100%\\" height=\\""+H+"\\">";';
  // Stacked bar
  html += 'var cx=20;entries.forEach(function(e,i){var pct=e[1].total/total;var bw=Math.max(4,pct*(W-40));';
  html += 'h+="<rect x=\\""+cx+"\\" y=\\"10\\" width=\\""+bw+"\\" height=\\"40\\" fill=\\""+colors[i%colors.length]+"\\" rx=\\"2\\"><title>"+e[0]+": $"+e[1].total.toFixed(0)+" ("+e[1].count+" payments)</title></rect>";cx+=bw+2;});';
  // Legend
  html += 'var ly=70;entries.forEach(function(e,i){var pct=Math.round((e[1].total/total)*100);';
  html += 'h+="<rect x=\\"20\\" y=\\""+ly+"\\" width=\\"12\\" height=\\"12\\" fill=\\""+colors[i%colors.length]+"\\" rx=\\"2\\" />";';
  html += 'h+="<text x=\\"38\\" y=\\""+(ly+10)+"\\" fill=\\"#c0d8f0\\" font-size=\\"10\\" font-family=\\"Rajdhani\\">"+e[0]+" â€” $"+Math.round(e[1].total)+" ("+pct+"%) â€” "+e[1].count+" payments</text>";ly+=18;});';
  html += 'h+="</svg>";c.innerHTML=h;}';

  // MOVING AVERAGES (7-day & 30-day)
  html += 'function renderMA(){var c=document.getElementById("maChart");if(!D||!D.analytics||!D.analytics.trends)return;var range=parseInt(document.getElementById("maRange").value)||0;var mr=D.analytics.trends.monthlyRevenue;var days=Object.keys(mr).sort();if(range>0){var cutoff=new Date(Date.now()-range*86400000).toISOString().substring(0,7);days=days.filter(function(m){return m>=cutoff;});}var vals=days.map(function(k){return mr[k];});if(days.length<3){c.innerHTML="<div style=\\"color:#4a6a8a;text-align:center;padding-top:60px;\\">Need more data</div>";return;}';
  html += 'function calcMA(data,p){var r=[];for(var i=0;i<data.length;i++){if(i<p-1){r.push(null);continue;}var sum=0;for(var j=i-p+1;j<=i;j++)sum+=data[j];r.push(sum/p);}return r;}';
  html += 'var ma7=calcMA(vals,Math.min(7,vals.length));var ma30=calcMA(vals,Math.min(30,vals.length));';
  html += 'var allV=vals.concat(ma7.filter(function(v){return v!==null;}));var maxY=Math.max.apply(null,allV)||1;';
  html += 'var W=c.offsetWidth-20;var H=180;var h="<svg width=\\"100%\\" height=\\""+H+"\\">";';
  // Raw data
  html += 'vals.forEach(function(v,i){var x=10+(i/(vals.length-1))*W;var bh=(v/maxY)*(H-20);h+="<rect x=\\""+(x-1)+"\\" y=\\""+(H-bh)+"\\" width=\\"3\\" height=\\""+bh+"\\" fill=\\"#10b981\\" opacity=\\"0.3\\" />";});';
  // 7-day MA
  html += 'var p7="";var s7=false;ma7.forEach(function(v,i){if(v===null)return;var x=10+(i/(vals.length-1))*W;var y=H-(v/maxY)*(H-20);p7+=(s7?"L":"M")+x.toFixed(1)+","+y.toFixed(1);s7=true;});';
  html += 'h+="<path d=\\""+p7+"\\" stroke=\\"#0af\\" fill=\\"none\\" stroke-width=\\"2\\" />";';
  // 30-day MA
  html += 'var p30="";var s30=false;ma30.forEach(function(v,i){if(v===null)return;var x=10+(i/(vals.length-1))*W;var y=H-(v/maxY)*(H-20);p30+=(s30?"L":"M")+x.toFixed(1)+","+y.toFixed(1);s30=true;});';
  html += 'if(p30)h+="<path d=\\""+p30+"\\" stroke=\\"#f59e0b\\" fill=\\"none\\" stroke-width=\\"2\\" />";';
  // Legend
  html += 'h+="<text x=\\""+W+"\\" y=\\"12\\" fill=\\"#0af\\" font-size=\\"8\\" font-family=\\"Orbitron\\" text-anchor=\\"end\\">7-DAY MA</text>";';
  html += 'h+="<text x=\\""+W+"\\" y=\\"22\\" fill=\\"#f59e0b\\" font-size=\\"8\\" font-family=\\"Orbitron\\" text-anchor=\\"end\\">30-DAY MA</text>";';
  html += 'h+="<text x=\\"5\\" y=\\"12\\" fill=\\"#4a6a8a\\" font-size=\\"8\\" font-family=\\"Orbitron\\">$"+Math.round(maxY)+"</text>";';
  html += 'h+="</svg>";c.innerHTML=h;}';

  // REVENUE vs REFUNDS
  html += 'function renderRefundChart(){var c=document.getElementById("refundChart");if(!D||!D.analytics)return;var mr=D.analytics.trends.monthlyRevenue;if(!mr){c.innerHTML="";return;}var months=Object.keys(mr).sort();if(!months.length){c.innerHTML="";return;}';
  html += 'var vals=months.map(function(m){return mr[m];});var max=Math.max.apply(null,vals)||1;';
  html += 'var refTotal=D.analytics.refunds.total;var refRate=D.analytics.refunds.rate;';
  html += 'var W=c.offsetWidth-40;var H=140;var bw=Math.max(3,(W/months.length)-2);';
  html += 'var h="<svg width=\\"100%\\" height=\\""+H+"\\">";months.forEach(function(m,i){var v=mr[m];var bh=Math.max(1,(v/max)*110);var x=20+i*(bw+2);';
  html += 'h+="<rect x=\\""+x+"\\" y=\\""+Math.round(120-bh)+"\\" width=\\""+bw+"\\" height=\\""+Math.round(bh)+"\\" fill=\\"#10b981\\" opacity=\\"0.7\\" rx=\\"1\\"><title>"+m+": $"+v.toFixed(0)+"</title></rect>";});';
  html += 'h+="<text x=\\""+W+"\\" y=\\"12\\" fill=\\"#ef4444\\" font-size=\\"9\\" font-family=\\"Orbitron\\" text-anchor=\\"end\\">REFUNDS: $"+refTotal.toFixed(0)+" ("+refRate+"%)</text>";';
  html += 'h+="<text x=\\"5\\" y=\\"12\\" fill=\\"#10b981\\" font-size=\\"8\\" font-family=\\"Orbitron\\">REVENUE</text>";';
  html += 'h+="</svg>";c.innerHTML=h;}';
  // Tabs
  html += 'function renderPaySpeed(){var c=document.getElementById("paySpeedChart");if(!D||!D.analytics||!D.analytics.invoices||!D.analytics.invoices.paymentSpeed)return;var ps=D.analytics.invoices.paymentSpeed;var buckets=[{label:"Same Day",pct:ps.sameDay,color:"#10b981"},{label:"1-3 Days",pct:ps.within3d,color:"#34d399"},{label:"4-7 Days",pct:ps.within7d,color:"#f59e0b"},{label:"8-30 Days",pct:ps.within30d,color:"#f97316"},{label:"30+ Days",pct:ps.over30d,color:"#ef4444"}];var maxP=Math.max.apply(null,buckets.map(function(b){return b.pct;}))||1;var h="<div style=\\"display:flex;align-items:flex-end;height:120px;gap:8px;padding:0 20px;\\">";buckets.forEach(function(b){var barH=Math.max(4,(b.pct/maxP)*100);h+="<div style=\\"flex:1;text-align:center;\\"><div style=\\"color:"+b.color+";font-size:11px;font-weight:700;margin-bottom:4px;\\">"+b.pct+"%</div><div style=\\"height:"+barH+"px;background:"+b.color+";border-radius:4px 4px 0 0;margin:0 auto;width:80%;\\"></div><div style=\\"color:#4a6a8a;font-size:9px;margin-top:4px;\\">"+b.label+"</div></div>";});h+="</div><div style=\\"text-align:center;color:#4a6a8a;font-size:10px;margin-top:6px;\\">Avg: "+ps.avgDays+"d Â· Median: "+ps.medianDays+"d Â· Sample: "+ps.sampleSize+" invoices</div>";c.innerHTML=h;}';

  html += 'function renderProjections(){var c=document.getElementById("projChart");if(!D||!D.analytics||!D.analytics.trends||!D.analytics.trends.projections)return;var pj=D.analytics.trends.projections;var mp=pj.monthProjections;var labels=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var months=["01","02","03","04","05","06","07","08","09","10","11","12"];var vals=[];var isProj=[];months.forEach(function(mo){var d=mp[mo];if(d){if(d.projected&&d.estimate!==undefined){vals.push(d.estimate);isProj.push(true);}else{vals.push(d.actual||0);isProj.push(false);}}else{vals.push(0);isProj.push(true);}});var maxV=Math.max.apply(null,vals)||1;var sa=D.analytics.trends.seasonalAvg||{};var h="<div style=\\"position:relative;height:180px;padding:0 10px;\\">";h+="<div style=\\"display:flex;align-items:flex-end;height:160px;gap:4px;\\">";months.forEach(function(mo,i){var barH=Math.max(2,(vals[i]/maxV)*140);var color=isProj[i]?"rgba(99,102,241,0.6)":"#10b981";var border=isProj[i]?"2px dashed #6366f1":"none";var saVal=sa[mo]||0;var saH=Math.max(0,(saVal/maxV)*140);h+="<div style=\\"flex:1;text-align:center;position:relative;\\"><div style=\\"color:"+(isProj[i]?"#818cf8":"#10b981")+";font-size:9px;font-weight:700;margin-bottom:2px;\\">$"+(vals[i]>=1000?Math.round(vals[i]/1000)+"k":vals[i])+"</div><div style=\\"position:relative;height:"+barH+"px;\\"><div style=\\"position:absolute;bottom:0;width:100%;height:"+barH+"px;background:"+color+";border-radius:3px 3px 0 0;"+(isProj[i]?"border-top:"+border:"")+"\\"></div>"+(saVal>0?"<div style=\\"position:absolute;bottom:"+saH+"px;width:100%;height:2px;background:#f59e0b40;\\"></div>":"")+"</div><div style=\\"color:#4a6a8a;font-size:8px;margin-top:3px;\\">"+labels[i]+"</div></div>";});h+="</div></div>";h+="<div style=\\"display:flex;justify-content:center;gap:20px;margin-top:4px;font-size:9px;\\">";h+="<span style=\\"color:#10b981;\\">â–  Actual</span>";h+="<span style=\\"color:#6366f1;\\">â–ª Projected</span>";h+="<span style=\\"color:#f59e0b40;\\">â€” Seasonal Avg</span>";h+="</div>";h+="<div style=\\"text-align:center;color:#a0b8d0;font-size:11px;margin-top:6px;font-weight:700;\\">";h+="Projected: $"+pj.projectedFullYear.toLocaleString()+" Â· Conservative: $"+pj.conservativeFullYear.toLocaleString()+" Â· vs Last Year: "+(pj.projectedGrowth>=0?"+":"")+pj.projectedGrowth+"%</div>";c.innerHTML=h;}';


  // Market Signals â€” Bullish/Bearish indicators
  html += 'function renderSignals(){var p=document.getElementById("signalsPanel");if(!D||!D.analytics)return;var a=D.analytics;var t=a.trends;var signals=[];';
  html += 'var mr=t.monthlyRevenue;var months=Object.keys(mr).sort();';
  // Signal 1: Revenue Momentum (last 3 months vs prev 3)
  html += 'if(months.length>=6){var last3=months.slice(-3).reduce(function(s,m){return s+mr[m];},0);var prev3=months.slice(-6,-3).reduce(function(s,m){return s+mr[m];},0);var momPct=prev3>0?Math.round(((last3-prev3)/prev3)*100):0;signals.push({name:"Revenue Momentum",signal:momPct>5?"BULLISH":momPct<-5?"BEARISH":"NEUTRAL",value:(momPct>=0?"+":"")+momPct+"% (3mo vs prev 3mo)",color:momPct>5?"#10b981":momPct<-5?"#ef4444":"#f59e0b"});}';
  // Signal 2: Week-over-Week
  html += 'var wg=a.revenue.weekGrowth;signals.push({name:"Weekly Trend",signal:wg>10?"BULLISH":wg<-10?"BEARISH":"NEUTRAL",value:(wg>=0?"+":"")+wg+"% WoW",color:wg>10?"#10b981":wg<-10?"#ef4444":"#f59e0b"});';
  // Signal 3: YoY Growth
  html += 'if(t.projections){var yoy=t.projections.yoyGrowthRate;signals.push({name:"Year-over-Year",signal:yoy>10?"BULLISH":yoy<-10?"BEARISH":"NEUTRAL",value:(yoy>=0?"+":"")+yoy+"% YoY",color:yoy>10?"#10b981":yoy<-10?"#ef4444":"#f59e0b"});}';
  // Signal 4: Seasonal comparison (this month vs seasonal avg)
  html += 'var curMo=String(new Date().getMonth()+1).padStart(2,"0");var curMoKey=new Date().getFullYear()+"-"+curMo;var saAvg=t.seasonalAvg[curMo]||0;var curMoRev=mr[curMoKey]||0;if(saAvg>0){var sPct=Math.round(((curMoRev-saAvg)/saAvg)*100);signals.push({name:"vs Seasonal Avg",signal:sPct>10?"BULLISH":sPct<-20?"BEARISH":"NEUTRAL",value:(sPct>=0?"+":"")+sPct+"% vs avg for this month",color:sPct>10?"#10b981":sPct<-20?"#ef4444":"#f59e0b"});}';
  // Signal 5: Customer Growth
  html += 'var custNew=a.customers.new30d;signals.push({name:"Customer Acquisition",signal:custNew>20?"BULLISH":custNew<5?"BEARISH":"NEUTRAL",value:custNew+" new customers (30d)",color:custNew>20?"#10b981":custNew<5?"#ef4444":"#f59e0b"});';
  // Signal 6: Repeat Rate
  html += 'var rr=a.customerInsights.repeatRate;signals.push({name:"Customer Retention",signal:rr>30?"BULLISH":rr<15?"BEARISH":"NEUTRAL",value:rr+"% repeat rate",color:rr>30?"#10b981":rr<15?"#ef4444":"#f59e0b"});';
  // Signal 7: Avg Ticket Trend
  html += 'if(months.length>=4){var recentTickets=[];months.slice(-3).forEach(function(m){var mc=t.monthlyPaymentCount?t.monthlyPaymentCount[m]:0;if(mc>0)recentTickets.push(mr[m]/mc);});var avgRecent=recentTickets.length>0?recentTickets.reduce(function(a,b){return a+b;},0)/recentTickets.length:0;signals.push({name:"Avg Ticket Size",signal:avgRecent>a.revenue.avgTicket*1.05?"BULLISH":avgRecent<a.revenue.avgTicket*0.95?"BEARISH":"NEUTRAL",value:"$"+Math.round(avgRecent)+" recent vs $"+a.revenue.avgTicket.toFixed(0)+" avg",color:avgRecent>a.revenue.avgTicket*1.05?"#10b981":avgRecent<a.revenue.avgTicket*0.95?"#ef4444":"#f59e0b"});}';
  // Signal 8: Refund Rate
  html += 'var refRate=parseFloat(a.refunds.rate);signals.push({name:"Refund Risk",signal:refRate<2?"BULLISH":refRate>5?"BEARISH":"NEUTRAL",value:refRate+"% refund rate",color:refRate<2?"#10b981":refRate>5?"#ef4444":"#f59e0b"});';
  // Overall signal
  html += 'var bull=0;var bear=0;var neut=0;signals.forEach(function(s){if(s.signal==="BULLISH")bull++;else if(s.signal==="BEARISH")bear++;else neut++;});';
  html += 'var overall=bull>bear+1?"BULLISH":bear>bull+1?"BEARISH":"NEUTRAL";var overallColor=overall==="BULLISH"?"#10b981":overall==="BEARISH"?"#ef4444":"#f59e0b";var overallIcon=overall==="BULLISH"?"ðŸ‚":overall==="BEARISH"?"ðŸ»":"âš–ï¸";';
  // Render
  html += 'var h="<div style=\\"text-align:center;margin-bottom:16px;\\"><div style=\\"font-family:Orbitron;font-size:2em;color:"+overallColor+";\\">"+overallIcon+" "+overall+"</div><div style=\\"font-family:Orbitron;font-size:0.6em;letter-spacing:3px;color:#4a6a8a;margin-top:4px;\\">"+bull+" BULLISH Â· "+neut+" NEUTRAL Â· "+bear+" BEARISH</div></div>";';
  html += 'h+="<div style=\\"display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px;\\">";';
  html += 'signals.forEach(function(s){h+="<div style=\\"display:flex;align-items:center;padding:10px 14px;background:rgba(10,20,35,0.6);border-left:3px solid "+s.color+";gap:12px;\\"><div style=\\"font-family:Orbitron;font-size:0.65em;letter-spacing:2px;color:"+s.color+";min-width:70px;font-weight:700;\\">"+s.signal+"</div><div><div style=\\"color:#c0d8f0;font-size:0.9em;font-weight:600;\\">"+s.name+"</div><div style=\\"color:#4a6a8a;font-size:0.8em;\\">"+s.value+"</div></div></div>";});';
  html += 'h+="</div>";p.innerHTML=h;}';

  html += 'function showTab(tab,el){curTab=tab;document.querySelectorAll(".tab-btn").forEach(function(b){b.classList.remove("active");});if(el)el.classList.add("active");var c=document.getElementById("tabContent");if(!D){c.innerHTML="Loading...";return;}';
  html += 'if(tab==="payments")rPay(c);else if(tab==="orders")rOrd(c);else if(tab==="invoices")rInv(c);else if(tab==="customers")rCust(c);else if(tab==="items")rItems(c);else if(tab==="refunds")rRef(c);else if(tab==="disputes")rDisp(c);else if(tab==="payouts")rPay2(c);else if(tab==="shifts")rShift(c);else if(tab==="catalog")rCat(c);else if(tab==="giftcards")rGC(c);else if(tab==="subs")rSub(c);}';
  // Table renderers
  html += 'function rPay(c){var p=D.recentPayments||[];if(!p.length){c.innerHTML="No payments";return;}var h="<table><thead><tr><th>DATE</th><th>AMOUNT</th><th>TIP</th><th>FEES</th><th>STATUS</th><th>METHOD</th><th>CARD</th><th>RISK</th><th>NOTE</th></tr></thead><tbody>";p.forEach(function(x){var s=x.status==="COMPLETED"?"pill-green":"pill-yellow";var dt=x.created?new Date(x.created).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}):"";h+="<tr><td>"+dt+"</td><td style=\\"color:#10b981;font-weight:700;\\">"+x.amount+"</td><td>"+x.tip+"</td><td style=\\"color:#f59e0b;\\">"+x.processingFee+"</td><td><span class=\\"pill "+s+"\\">"+x.status+"</span></td><td>"+(x.source||"")+"</td><td>"+(x.cardBrand?x.cardBrand+" â€¢"+x.last4:"â€”")+"</td><td>"+(x.riskEval||"â€”")+"</td><td style=\\"max-width:100px;overflow:hidden;text-overflow:ellipsis;\\">"+(x.note||x.buyerEmail||"â€”")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rOrd(c){var o=D.recentOrders||[];if(!o.length){c.innerHTML="No orders";return;}var h="<table><thead><tr><th>DATE</th><th>TOTAL</th><th>TAX</th><th>DISC</th><th>TIP</th><th>STATE</th><th>ITEMS</th><th>SOURCE</th></tr></thead><tbody>";o.forEach(function(x){var dt=x.created?new Date(x.created).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}):"";var items=(x.items||[]).map(function(i){return i.qty+"x "+i.name;}).join(", ");h+="<tr><td>"+dt+"</td><td style=\\"color:#10b981;font-weight:700;\\">"+x.total+"</td><td>"+x.totalTax+"</td><td style=\\"color:#f59e0b;\\">"+x.totalDiscount+"</td><td>"+x.totalTip+"</td><td><span class=\\"pill pill-green\\">"+(x.state||"")+"</span></td><td style=\\"max-width:180px;overflow:hidden;text-overflow:ellipsis;\\">"+items+"</td><td>"+(x.source||"")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rInv(c){var inv=D.unpaidInvoices||[];if(!inv.length){c.innerHTML="<div style=\\"color:#10b981;\\">âœ… All paid</div>";return;}var h="<table><thead><tr><th>#</th><th>TITLE</th><th>AMOUNT</th><th>STATUS</th><th>DUE</th><th>DELIVERY</th></tr></thead><tbody>";inv.forEach(function(x){var s=x.status==="OVERDUE"?"pill-red":"pill-yellow";h+="<tr><td>"+(x.invoiceNumber||"â€”")+"</td><td>"+(x.title||"â€”")+"</td><td style=\\"color:#f59e0b;font-weight:700;\\">"+x.amount+"</td><td><span class=\\"pill "+s+"\\">"+x.status+"</span></td><td>"+(x.due||"â€”")+"</td><td>"+(x.deliveryMethod||"â€”")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rCust(c){var cu=D.recentCustomers||[];if(!cu.length){c.innerHTML="No customers";return;}var h="<table><thead><tr><th>NAME</th><th>COMPANY</th><th>EMAIL</th><th>PHONE</th><th>JOINED</th><th>BIRTHDAY</th><th>NOTE</th></tr></thead><tbody>";cu.forEach(function(x){var dt=x.created?new Date(x.created).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"";h+="<tr><td style=\\"color:#a78bfa;font-weight:700;\\">"+x.name+"</td><td>"+(x.company||"â€”")+"</td><td>"+(x.email||"â€”")+"</td><td>"+(x.phone||"â€”")+"</td><td>"+dt+"</td><td>"+(x.birthday||"â€”")+"</td><td style=\\"max-width:120px;overflow:hidden;text-overflow:ellipsis;\\">"+(x.note||"â€”")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rItems(c){if(!D||!D.analytics){c.innerHTML="No data";return;}var items=D.analytics.orders.topItemsByRevenue||[];var h="<table><thead><tr><th>#</th><th>ITEM</th><th>REVENUE</th><th>QTY</th><th>AVG PRICE</th></tr></thead><tbody>";items.forEach(function(x,i){var avg=x[1].qty>0?(x[1].revenue/x[1].qty):0;h+="<tr><td>"+(i+1)+"</td><td style=\\"color:#a78bfa;font-weight:700;\\">"+x[0]+"</td><td style=\\"color:#10b981;font-weight:700;\\">$"+x[1].revenue.toFixed(2)+"</td><td>"+x[1].qty+"</td><td>$"+avg.toFixed(2)+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rRef(c){var r=D.recentRefunds||[];if(!r.length){c.innerHTML="<div style=\\"color:#10b981;\\">âœ… No refunds</div>";return;}var h="<table><thead><tr><th>DATE</th><th>AMOUNT</th><th>STATUS</th><th>REASON</th></tr></thead><tbody>";r.forEach(function(x){h+="<tr><td>"+(x.created?new Date(x.created).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"")+"</td><td style=\\"color:#ef4444;font-weight:700;\\">"+x.amount+"</td><td><span class=\\"pill pill-yellow\\">"+x.status+"</span></td><td>"+(x.reason||"â€”")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rDisp(c){var d=D.disputes||[];if(!d.length){c.innerHTML="<div style=\\"color:#10b981;\\">âœ… No disputes</div>";return;}var h="<table><thead><tr><th>DATE</th><th>AMOUNT</th><th>REASON</th><th>STATE</th><th>CARD</th><th>DUE</th></tr></thead><tbody>";d.forEach(function(x){var s=x.state&&x.state.includes("WON")?"pill-green":"pill-red";h+="<tr><td>"+(x.created?new Date(x.created).toLocaleDateString():"")+"</td><td style=\\"color:#ef4444;font-weight:700;\\">"+x.amount+"</td><td>"+x.reason+"</td><td><span class=\\"pill "+s+"\\">"+x.state+"</span></td><td>"+(x.cardBrand||"")+"</td><td>"+(x.due||"â€”")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rPay2(c){var p=D.payouts||[];if(!p.length){c.innerHTML="No payouts";return;}var h="<table><thead><tr><th>DATE</th><th>AMOUNT</th><th>STATUS</th><th>ARRIVAL</th><th>TYPE</th><th>DEST</th></tr></thead><tbody>";p.forEach(function(x){h+="<tr><td>"+(x.created?new Date(x.created).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"")+"</td><td style=\\"color:#10b981;font-weight:700;\\">"+x.amount+"</td><td><span class=\\"pill pill-green\\">"+(x.status||"")+"</span></td><td>"+(x.arrivalDate||"â€”")+"</td><td>"+(x.type||"")+"</td><td>"+(x.destination||"")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rShift(c){var s=D.shifts||[];if(!s.length){c.innerHTML="No shifts";return;}var h="<table><thead><tr><th>EMPLOYEE</th><th>DATE</th><th>START</th><th>END</th><th>HOURS</th><th>TITLE</th><th>WAGE</th><th>BREAKS</th></tr></thead><tbody>";s.forEach(function(x){var dt=x.start?new Date(x.start).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"";var st=x.start?new Date(x.start).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}):"";var en=x.end?new Date(x.end).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}):"active";var brks=(x.breaks||[]).map(function(b){return (b.paid?"Paid":"Unpaid")+": "+b.name;}).join(", ");h+="<tr><td style=\\"color:#a78bfa;\\">"+x.employeeId.substring(0,8)+"</td><td>"+dt+"</td><td>"+st+"</td><td>"+en+"</td><td style=\\"color:#10b981;font-weight:700;\\">"+x.hours+"h</td><td>"+(x.title||"â€”")+"</td><td>"+(x.wage||"â€”")+"</td><td style=\\"font-size:0.8em;\\">"+(brks||"â€”")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rCat(c){if(!D.catalog){c.innerHTML="No catalog";return;}var items=D.catalog.items||[];var h="<table><thead><tr><th>ITEM</th><th>DESCRIPTION</th><th>VARIATIONS</th></tr></thead><tbody>";items.forEach(function(x){var vars=(x.variations||[]).map(function(v){return v.name+": "+v.price+(v.sku?" ("+v.sku+")":"");}).join(", ");h+="<tr><td style=\\"color:#a78bfa;font-weight:700;\\">"+x.name+"</td><td style=\\"max-width:180px;overflow:hidden;text-overflow:ellipsis;\\">"+(x.description||"â€”")+"</td><td>"+vars+"</td></tr>";});h+="</tbody></table>";';
  html += 'if(D.catalog.categories&&D.catalog.categories.length){h+="<div style=\\"margin-top:12px;\\">CATEGORIES: ";D.catalog.categories.forEach(function(cat){h+="<span class=\\"pill pill-purple\\" style=\\"margin:2px;\\">"+cat.name+"</span>";});h+="</div>";}';
  html += 'if(D.catalog.discounts&&D.catalog.discounts.length){h+="<div style=\\"margin-top:8px;\\">DISCOUNTS: ";D.catalog.discounts.forEach(function(d){h+="<span class=\\"pill pill-yellow\\" style=\\"margin:2px;\\">"+d.name+" "+(d.pct?d.pct+"%":d.amount)+"</span>";});h+="</div>";}';
  html += 'if(D.catalog.taxes&&D.catalog.taxes.length){h+="<div style=\\"margin-top:8px;\\">TAXES: ";D.catalog.taxes.forEach(function(t){h+="<span class=\\"pill pill-blue\\" style=\\"margin:2px;\\">"+t.name+" "+(t.pct||"")+"% </span>";});h+="</div>";}';
  html += 'c.innerHTML=h;}';
  html += 'function rGC(c){var g=D.giftCards||[];if(!g.length){c.innerHTML="No gift cards";return;}var h="<table><thead><tr><th>GAN</th><th>STATE</th><th>BALANCE</th><th>TYPE</th><th>CREATED</th></tr></thead><tbody>";g.forEach(function(x){var s=x.state==="ACTIVE"?"pill-green":"pill-yellow";h+="<tr><td>"+(x.gan||"â€”")+"</td><td><span class=\\"pill "+s+"\\">"+x.state+"</span></td><td style=\\"color:#10b981;font-weight:700;\\">"+x.balance+"</td><td>"+(x.type||"")+"</td><td>"+(x.created?new Date(x.created).toLocaleDateString():"")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'function rSub(c){var s=D.subscriptions||[];if(!s.length){c.innerHTML="No subscriptions";return;}var h="<table><thead><tr><th>CUSTOMER</th><th>STATUS</th><th>START</th><th>CHARGED THRU</th><th>CANCELLED</th></tr></thead><tbody>";s.forEach(function(x){var sc=x.status==="ACTIVE"?"pill-green":"pill-red";h+="<tr><td>"+(x.customerId||"").substring(0,10)+"</td><td><span class=\\"pill "+sc+"\\">"+x.status+"</span></td><td>"+(x.startDate||"â€”")+"</td><td>"+(x.chargedThroughDate||"â€”")+"</td><td>"+(x.canceledDate||"â€”")+"</td></tr>";});h+="</tbody></table>";c.innerHTML=h;}';
  html += 'async function analyze(topic){var p=document.getElementById("analysisPanel");p.style.display="block";p.textContent="âš¡ ATHENA analyzing...";try{var r=await(await fetch("/square/api/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic:topic})})).json();p.textContent=r.analysis;}catch(e){p.textContent="Error: "+e.message;}}';

  // Location dropdown
  html += 'var curLocation="all";var locDropOpen=false;';
  html += 'function toggleLocDrop(){locDropOpen=!locDropOpen;document.getElementById("locDropMenu").style.display=locDropOpen?"block":"none";}';
  html += 'document.addEventListener("click",function(e){if(locDropOpen&&!document.getElementById("locDropWrap").contains(e.target)){locDropOpen=false;document.getElementById("locDropMenu").style.display="none";}});';
  html += 'function populateLocations(){if(!D||!D.allLocations)return;var box=document.getElementById("locCheckboxes");box.innerHTML="";D.allLocations.forEach(function(l){var label=l.name||l.id;if(l.city&&l.name&&!l.name.toLowerCase().includes(l.city.toLowerCase())){label=l.name+" ("+l.city+", "+l.state+")";}var _unused=0;var div=document.createElement("label");div.style.cssText="display:flex;align-items:center;padding:6px 14px;cursor:pointer;border-bottom:1px solid #0a1a2a08;color:#a0b8d0;font-size:0.9em;";div.onmouseover=function(){this.style.background="rgba(16,185,129,0.05)";};div.onmouseout=function(){this.style.background="none";};div.innerHTML="<input type=\\"checkbox\\" class=\\"loc-cb\\" value=\\""+l.id+"\\" checked onchange=\\"onLocChange()\\" style=\\"margin-right:10px;accent-color:#10b981;\\"> "+label;box.appendChild(div);});updateLocLabel();}';
  html += 'function toggleAllLocs(){var checked=document.getElementById("locAll").checked;document.querySelectorAll(".loc-cb").forEach(function(cb){cb.checked=checked;});onLocChange();}';
  html += 'function onLocChange(){var cbs=document.querySelectorAll(".loc-cb");var checked=[];var total=0;cbs.forEach(function(cb){total++;if(cb.checked)checked.push(cb.value);});document.getElementById("locAll").checked=checked.length===total;updateLocLabel();var locParam=checked.length===total||checked.length===0?"all":checked.join(",");if(curLocation===locParam)return;curLocation=locParam;document.getElementById("refreshBtn").textContent="âŸ³ LOADING...";loadAll("/square/api/snapshot?location="+encodeURIComponent(curLocation));}';
  html += 'function updateLocLabel(){var cbs=document.querySelectorAll(".loc-cb");var checked=0;var total=0;var lastName="";cbs.forEach(function(cb){total++;if(cb.checked){checked++;lastName=cb.parentElement.textContent.trim();}});var label=document.getElementById("locDropLabel");if(checked===total||checked===0){label.textContent="ðŸ“ ALL LOCATIONS ("+total+")";}else if(checked===1){label.textContent="ðŸ“ "+lastName;}else{label.textContent="ðŸ“ "+checked+" LOCATIONS SELECTED";}}';
  html += 'function changeLocation(){}';

  // Override loadAll to populate locations
  html += 'var _origLoadAll=loadAll;';
  html += 'loadAll=async function(url){await _origLoadAll(url);populateLocations();};';

  // Square Voice Panel JS
  html += 'var sqVoiceOpen=false;var sqListening=false;var sqSpeaking=false;var sqRecog=null;var synth2=window.speechSynthesis;';
  html += 'function toggleSquareVoice(){sqVoiceOpen=!sqVoiceOpen;document.getElementById("sqVoicePanel").style.display=sqVoiceOpen?"block":"none";var btn=document.getElementById("sqVoiceBtn");btn.style.color=sqVoiceOpen?"#ff4757":"#a855f7";btn.style.borderColor=sqVoiceOpen?"#ff475740":"#a855f740";if(!sqVoiceOpen&&sqListening)stopSqListening();}';
  html += 'function toggleSquareMic(){if(sqListening){stopSqListening();return;}if(!("webkitSpeechRecognition" in window)&&!("SpeechRecognition" in window)){alert("Speech recognition not supported. Use Chrome.");return;}var SR=window.SpeechRecognition||window.webkitSpeechRecognition;sqRecog=new SR();sqRecog.continuous=false;sqRecog.interimResults=false;sqRecog.lang="en-US";sqRecog.onstart=function(){sqListening=true;document.getElementById("sqMicBtn").style.background="rgba(168,85,247,0.5)";document.getElementById("sqMicBtn").style.boxShadow="0 0 20px #a855f760";document.getElementById("sqVoiceStatus").textContent="LISTENING...";document.getElementById("sqVoiceStatus").style.color="#a855f7";startSqWave();};sqRecog.onresult=function(e){var text=e.results[0][0].transcript;stopSqListening();addSqMsg("user",text);sendSqVoice(text);};sqRecog.onerror=function(e){stopSqListening();document.getElementById("sqVoiceStatus").textContent="ERROR: "+e.error;document.getElementById("sqVoiceStatus").style.color="#ff4757";};sqRecog.onend=function(){stopSqListening();};sqRecog.start();}';
  html += 'function stopSqListening(){sqListening=false;if(sqRecog)try{sqRecog.stop();}catch(e){}document.getElementById("sqMicBtn").style.background="rgba(168,85,247,0.15)";document.getElementById("sqMicBtn").style.boxShadow="none";document.getElementById("sqVoiceStatus").textContent="CLICK MIC TO SPEAK";document.getElementById("sqVoiceStatus").style.color="#4a6a8a";stopSqWave();}';
  html += 'function sendSquareText(){var inp=document.getElementById("sqTextInput");var text=inp.value.trim();if(!text)return;inp.value="";addSqMsg("user",text);sendSqVoice(text);}';
  html += 'function sendSqVoice(text){document.getElementById("sqVoiceStatus").textContent="PROCESSING...";document.getElementById("sqVoiceStatus").style.color="#c084fc";startSqWave();fetch("/square/api/voice",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text,location:curLocation})}).then(function(r){return r.json();}).then(function(data){stopSqWave();if(data.error){addSqMsg("assistant","Error: "+data.error);return;}addSqMsg("assistant",data.response);speakSq(data.response);}).catch(function(e){stopSqWave();addSqMsg("assistant","Connection error.");});}';

  // Square TTS
  html += 'function speakSq(text){sqSpeaking=true;document.getElementById("sqVoiceStatus").textContent="SPEAKING...";document.getElementById("sqVoiceStatus").style.color="#a855f7";startSqWave();fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:text,voice:"athena"})}).then(function(r){if(!r.ok)throw new Error("TTS failed");return r.blob();}).then(function(blob){if(blob.size<1000)throw new Error("too small");var url=URL.createObjectURL(blob);var audio=new Audio(url);audio.onended=function(){sqSpeaking=false;stopSqWave();document.getElementById("sqVoiceStatus").textContent="CLICK MIC TO SPEAK";document.getElementById("sqVoiceStatus").style.color="#4a6a8a";URL.revokeObjectURL(url);};audio.onerror=function(){URL.revokeObjectURL(url);sqBrowserSpeak(text);};audio.play().catch(function(){sqBrowserSpeak(text);});}).catch(function(){sqBrowserSpeak(text);});}';
  html += 'function sqBrowserSpeak(text){var utter=new SpeechSynthesisUtterance(text);utter.rate=1.0;utter.pitch=1.1;var voices=synth2.getVoices();for(var v=0;v<voices.length;v++){if(voices[v].name.includes("Samantha")||voices[v].name.includes("Google UK English Female")||voices[v].name.includes("Female")){utter.voice=voices[v];break;}}utter.onend=function(){sqSpeaking=false;stopSqWave();document.getElementById("sqVoiceStatus").textContent="CLICK MIC TO SPEAK";document.getElementById("sqVoiceStatus").style.color="#4a6a8a";};synth2.speak(utter);}';

  // Voice log
  html += 'function addSqMsg(who,text){var log=document.getElementById("sqVoiceLog");var div=document.createElement("div");div.style.cssText="padding:8px 12px;margin-bottom:6px;border-radius:8px;"+(who==="user"?"background:rgba(0,170,255,0.1);border-left:3px solid #0af;":"background:rgba(168,85,247,0.1);border-left:3px solid #a855f7;");div.innerHTML="<div style=\\"font-family:Orbitron;font-size:0.55em;letter-spacing:3px;color:"+(who==="user"?"#0af":"#a855f7")+";margin-bottom:4px;\\">"+(who==="user"?"YOU":"SQUARE AI")+"</div><div style=\\"color:#c0d8f0;font-size:0.92em;line-height:1.5;\\">"+text+"</div>";log.appendChild(div);log.scrollTop=log.scrollHeight;}';

  // Wave animation
  html += 'var sqWaveAnim=null;function startSqWave(){var cv=document.getElementById("sqWaveCanvas");if(!cv)return;cv.style.height="30px";var ctx=cv.getContext("2d");cv.width=cv.offsetWidth;cv.height=30;var t=0;function draw(){ctx.clearRect(0,0,cv.width,cv.height);ctx.beginPath();for(var x=0;x<cv.width;x++){ctx.lineTo(x,15+Math.sin(x*0.03+t)*10*Math.sin(t*0.5));}ctx.strokeStyle="#a855f780";ctx.lineWidth=2;ctx.stroke();t+=0.08;sqWaveAnim=requestAnimationFrame(draw);}draw();}function stopSqWave(){if(sqWaveAnim)cancelAnimationFrame(sqWaveAnim);var cv=document.getElementById("sqWaveCanvas");if(cv){cv.style.height="3px";var ctx=cv.getContext("2d");cv.width=cv.offsetWidth;cv.height=3;ctx.clearRect(0,0,cv.width,cv.height);}}';

  html += 'loadAll();</script></body></html>';
  res.send(html);
  } catch(err) { console.log('Square page error:', err.message, err.stack); res.status(500).send('Square page error: ' + err.message); }
});

// Discord Dashboard Page
app.get('/discord', requireAuth('all'), async function(req, res) {
  var session = getVoiceSession(req);
  var channels = await discordGetChannels();
  var allMsgs = await discordGetAllRecent(30);

  // Count messages by author
  var authorCounts = {};
  var channelCounts = {};
  allMsgs.forEach(function(m) {
    authorCounts[m.author] = (authorCounts[m.author] || 0) + 1;
    channelCounts[m.channel] = (channelCounts[m.channel] || 0) + 1;
  });

  var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
  html += '<title>Discord â€” ATHENA</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">';
  html += '<style>';
  html += 'body{margin:0;background:#020810;color:#c0d8f0;font-family:Rajdhani,sans-serif;min-height:100vh;}';
  html += '.nav{display:flex;justify-content:center;gap:15px;padding:15px;background:rgba(5,10,20,0.9);border-bottom:1px solid #1a2a3a;flex-wrap:wrap;}';
  html += '.nav a{font-family:Orbitron;font-size:0.65em;letter-spacing:3px;padding:8px 20px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;}';
  html += '.nav a:hover{color:#7c3aed;border-color:#7c3aed40;}';
  html += '.nav a.active{color:#7c3aed;border-color:#7c3aed;background:rgba(124,58,237,0.1);}';
  html += '.container{max-width:1400px;margin:0 auto;padding:20px 40px;}';
  html += 'h1{font-family:Orbitron;font-size:2.5em;font-weight:900;letter-spacing:10px;background:linear-gradient(135deg,#7c3aed,#5b21b6,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;margin:30px 0 5px;}';
  html += '.subtitle{text-align:center;font-size:0.9em;color:#4a6a8a;letter-spacing:5px;font-family:Orbitron;margin-bottom:30px;}';
  html += '.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:30px;}';
  html += '.card{background:rgba(10,20,35,0.6);border:1px solid #7c3aed15;padding:20px;}';
  html += '.card .label{font-family:Orbitron;font-size:0.6em;letter-spacing:3px;color:#7c3aed;margin-bottom:5px;}';
  html += '.card .value{font-size:2em;font-weight:700;color:#c0d8f0;}';
  html += '.card .sub{font-size:0.8em;color:#4a6a8a;margin-top:3px;}';
  html += '.channel-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;}';
  html += '.ch-tab{padding:8px 16px;border:1px solid #7c3aed30;color:#7c3aed80;font-family:Orbitron;font-size:0.6em;letter-spacing:2px;cursor:pointer;transition:all 0.3s;background:transparent;}';
  html += '.ch-tab:hover,.ch-tab.active{color:#7c3aed;border-color:#7c3aed;background:rgba(124,58,237,0.1);}';
  html += '.msg{padding:15px;border-bottom:1px solid #0a1520;display:flex;gap:15px;}';
  html += '.msg:hover{background:rgba(124,58,237,0.03);}';
  html += '.msg .avatar{width:36px;height:36px;border-radius:50%;background:#7c3aed20;border:1px solid #7c3aed40;display:flex;align-items:center;justify-content:center;font-family:Orbitron;font-size:0.7em;color:#7c3aed;flex-shrink:0;}';
  html += '.msg .body{flex:1;}';
  html += '.msg .meta{font-size:0.75em;margin-bottom:4px;}';
  html += '.msg .author{color:#a78bfa;font-weight:700;}';
  html += '.msg .ch{color:#4a6a8a;margin-left:8px;}';
  html += '.msg .time{color:#2a3a4a;margin-left:8px;font-size:0.85em;}';
  html += '.msg .text{color:#c0d8f0;line-height:1.5;}';
  html += '.analyze-btn{padding:12px 30px;background:rgba(124,58,237,0.15);border:1px solid #7c3aed50;color:#7c3aed;font-family:Orbitron;font-size:0.7em;letter-spacing:3px;cursor:pointer;transition:all 0.3s;margin-bottom:20px;}';
  html += '.analyze-btn:hover{background:rgba(124,58,237,0.25);box-shadow:0 0 20px rgba(124,58,237,0.2);}';
  html += '#analysis{background:rgba(10,20,35,0.8);border:1px solid #7c3aed20;padding:25px;color:#a0b8d0;line-height:1.8;white-space:pre-wrap;margin-bottom:30px;display:none;}';
  html += '.leaderboard{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:30px;}';
  html += '.lb-item{background:rgba(10,20,35,0.6);border:1px solid #7c3aed15;padding:12px 18px;display:flex;align-items:center;gap:10px;}';
  html += '.lb-item .name{color:#a78bfa;font-weight:600;}';
  html += '.lb-item .count{color:#c0d8f0;font-size:1.2em;font-weight:700;}';
  html += '.lb-bar{height:4px;background:#0a1520;margin-top:6px;width:100%;} .lb-fill{height:100%;background:#7c3aed;}';
  html += '</style></head><body>';

  // Nav â€” conditional based on access level
  html += '<div class="nav">';
  if (session && session.access === 'all') {
    html += '<a href="/dashboard">JARVIS</a>';
    html += '<a href="/business">ATHENA</a>';
    html += '<a href="/tookan">TOOKAN</a>';
    html += '<a href="/business/chart">CHARTS</a>';
    html += '<a href="/analytics">ANALYTICS</a>';
    html += '<a href="/ads">GOOGLE ADS</a>';
    html += '<a href="/square">SQUARE</a>';
    html += '<a href="/discord" class="active">DISCORD</a>';
    html += '<a href="/followup">FOLLOW UP</a><a href="/ai" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">AI</a><a href="/forecast" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">FORECAST</a><a href="/seo" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">SEO</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AUDIT</a><a href="/auth/logout" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#ef4444;border:1px solid #ef444440;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">LOGOUT</a>';
  } else {
    html += '<a href="/discord" class="active">DISCORD</a>';
  }
  html += '<a href="/auth/logout" style="color:#ef4444;border-color:#ef444440;">LOGOUT</a>';
  html += '</div>';

  html += '<div class="container">';
  html += '<h1>DISCORD</h1>';
  html += '<div class="subtitle">TEAM COMMUNICATIONS MONITOR</div>';

  if (!DISCORD_BOT_TOKEN) {
    html += '<div style="text-align:center;padding:60px 20px;">';
    html += '<div style="font-family:Orbitron;font-size:1.2em;color:#7c3aed;margin-bottom:20px;">DISCORD NOT CONNECTED</div>';
    html += '<div style="color:#4a6a8a;max-width:600px;margin:0 auto;line-height:1.8;">';
    html += 'To connect Discord:<br><br>';
    html += '1. Go to <a href="https://discord.com/developers/applications" target="_blank" style="color:#7c3aed;">Discord Developer Portal</a><br>';
    html += '2. Create a New Application â†’ Bot â†’ Copy the Token<br>';
    html += '3. Enable "Message Content Intent" under Bot settings<br>';
    html += '4. Invite the bot to your server with "Read Messages" permission<br>';
    html += '5. On Render, add env vars:<br>';
    html += '<span style="color:#a78bfa;">DISCORD_BOT_TOKEN</span> = your bot token<br>';
    html += '<span style="color:#a78bfa;">DISCORD_GUILD_ID</span> = your server ID (right-click server â†’ Copy Server ID)<br>';
    html += '</div></div>';
  } else {
    // Stats cards
    html += '<div class="grid">';
    html += '<div class="card"><div class="label">Channels</div><div class="value">' + channels.length + '</div><div class="sub">Text channels monitored</div></div>';
    html += '<div class="card"><div class="label">Recent Messages</div><div class="value">' + allMsgs.length + '</div><div class="sub">Last 30 per channel</div></div>';
    html += '<div class="card"><div class="label">Active Members</div><div class="value">' + Object.keys(authorCounts).length + '</div><div class="sub">Unique posters</div></div>';
    var mostActive = Object.entries(authorCounts).sort(function(a,b){return b[1]-a[1];})[0];
    html += '<div class="card"><div class="label">Most Active</div><div class="value">' + (mostActive ? mostActive[0] : 'â€”') + '</div><div class="sub">' + (mostActive ? mostActive[1] + ' messages' : '') + '</div></div>';
    html += '</div>';

    // Activity leaderboard
    var sortedAuthors = Object.entries(authorCounts).sort(function(a,b){return b[1]-a[1];});
    var maxMsgs = sortedAuthors.length > 0 ? sortedAuthors[0][1] : 1;
    html += '<div style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;color:#7c3aed;margin-bottom:12px;">ACTIVITY LEADERBOARD</div>';
    html += '<div class="leaderboard">';
    sortedAuthors.forEach(function(a) {
      var pct = Math.round((a[1] / maxMsgs) * 100);
      html += '<div class="lb-item" style="min-width:180px;flex:1;"><div style="width:100%;"><div style="display:flex;justify-content:space-between;"><span class="name">' + a[0] + '</span><span class="count">' + a[1] + '</span></div><div class="lb-bar"><div class="lb-fill" style="width:' + pct + '%;"></div></div></div></div>';
    });
    html += '</div>';

    // AI Analysis button
    html += '<div style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;color:#7c3aed;margin-bottom:12px;">ðŸ“Š RESPONSE RATES BY PERSON</div>';
    html += '<div id="responseRates" style="margin-bottom:30px;"><div style="color:#4a6a8a;padding:10px;">Loading...</div></div>';

    // Quiet alerts placeholder
    html += '<div id="quietAlerts" style="margin-bottom:20px;"></div>';

    // Action buttons
    html += '<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;">';
    html += '<button class="analyze-btn" onclick="analyzeMessages()">âš¡ ANALYZE COMMS</button>';
    html += '<button class="analyze-btn" onclick="loadSuggestions()" style="border-color:#10b98150;color:#10b981;">ðŸ’¡ MESSAGE IDEAS</button>';
    html += '<button class="analyze-btn" onclick="analyzeSystem()" style="border-color:#f59e0b50;color:#f59e0b;">ðŸ” SYSTEM IMPROVEMENTS</button>';
    html += '</div>';

    // Panels
    html += '<div id="suggestions" style="display:none;margin-bottom:20px;"></div>';
    html += '<div id="analysis" style="background:rgba(10,20,35,0.8);border:1px solid #7c3aed20;padding:25px;color:#a0b8d0;line-height:1.8;white-space:pre-wrap;margin-bottom:30px;display:none;"></div>';
    html += '<div id="sysAnalysis" style="background:rgba(10,20,35,0.8);border:1px solid #f59e0b20;padding:25px;color:#a0b8d0;line-height:1.8;white-space:pre-wrap;margin-bottom:30px;display:none;"></div>';

    // Send custom message
    html += '<div style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;color:#7c3aed;margin-bottom:12px;">ðŸ“¤ SEND TO DISCORD</div>';
    html += '<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:30px;">';
    html += '<select id="sendCh" style="padding:10px;background:#0a1520;border:1px solid #7c3aed30;color:#c0d8f0;font-family:Rajdhani;">';
    channels.forEach(function(c) { html += '<option value="' + c.id + '">#' + c.name + '</option>'; });
    html += '</select>';
    html += '<input id="sendTxt" placeholder="Type a message..." style="flex:1;min-width:200px;padding:10px;background:#0a1520;border:1px solid #7c3aed30;color:#c0d8f0;font-family:Rajdhani;">';
    html += '<button onclick="sendMsg()" style="padding:10px 20px;background:rgba(124,58,237,0.2);border:1px solid #7c3aed50;color:#7c3aed;font-family:Orbitron;font-size:0.6em;cursor:pointer;">SEND</button>';
    html += '</div>';
    html += '<div id="sendSt" style="font-size:0.8em;color:#4a6a8a;margin-top:-20px;margin-bottom:20px;"></div>';

    // Channel tabs
    html += '<div style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;color:#7c3aed;margin-bottom:12px;">MESSAGES BY CHANNEL</div>';
    html += '<div class="channel-tabs">';
    html += '<div class="ch-tab active" onclick="filterChannel(\'all\',this)">ALL (' + allMsgs.length + ')</div>';
    channels.forEach(function(c) {
      var cnt = channelCounts[c.name] || 0;
      html += '<div class="ch-tab" onclick="filterChannel(\'' + c.name + '\',this)">#' + c.name + ' (' + cnt + ')</div>';
    });
    html += '</div>';

    // Messages
    html += '<div id="messages">';
    allMsgs.forEach(function(m) {
      var d = new Date(m.timestamp);
      var timeStr = (d.getMonth()+1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2,'0');
      var initial = (m.author || '?')[0].toUpperCase();
      html += '<div class="msg" data-channel="' + (m.channel || '') + '">';
      html += '<div class="avatar">' + initial + '</div>';
      html += '<div class="body"><div class="meta"><span class="author">' + (m.author || 'unknown') + '</span><span class="ch">#' + (m.channel || '') + '</span><span class="time">' + timeStr + '</span></div>';
      html += '<div class="text">' + (m.content || '<em style="color:#4a6a8a;">attachment/embed</em>') + '</div>';
      if (m.attachments > 0) html += '<div style="color:#7c3aed80;font-size:0.8em;margin-top:3px;">ðŸ“Ž ' + m.attachments + ' attachment(s)</div>';
      html += '</div></div>';
    });
    html += '</div>';
  }

  html += '</div>';

  html += '<script>';
  html += 'function filterChannel(ch,el){document.querySelectorAll(".ch-tab").forEach(function(t){t.classList.remove("active");});el.classList.add("active");document.querySelectorAll(".msg").forEach(function(m){m.style.display=(ch==="all"||m.dataset.channel===ch)?"flex":"none";});}';

  // Response rates
  html += 'async function loadRR(){var d=document.getElementById("responseRates");try{var r=await(await fetch("/discord/api/response-rates")).json();var p=r.people||[];if(!p.length){d.innerHTML="<div style=\\"color:#4a6a8a;\\">No data yet</div>";return;}';
  html += 'var h="<table style=\\"width:100%;border-collapse:collapse;\\"><thead><tr style=\\"border-bottom:1px solid #7c3aed30;\\">';
  html += '<th style=\\"font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#7c3aed;text-align:left;padding:8px;\\">PERSON</th>';
  html += '<th style=\\"font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#7c3aed;padding:8px;\\">SCORE</th>';
  html += '<th style=\\"font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#7c3aed;padding:8px;\\">MSGS</th>';
  html += '<th style=\\"font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#7c3aed;padding:8px;\\">RATE</th>';
  html += '<th style=\\"font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#7c3aed;padding:8px;\\">AVG SPEED</th>';
  html += '<th style=\\"font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#7c3aed;padding:8px;\\">UNANSWERED</th>';
  html += '<th style=\\"font-family:Orbitron;font-size:0.55em;letter-spacing:2px;color:#7c3aed;padding:8px;\\">PEAK</th>';
  html += '</tr></thead><tbody>";';
  html += 'p.forEach(function(x,i){var sc=x.engagementScore>=70?"#10b981":x.engagementScore>=40?"#f59e0b":"#ef4444";var rc=x.responseRate>=60?"#10b981":x.responseRate>=30?"#f59e0b":"#ef4444";var medal=i===0?"ðŸ¥‡ ":i===1?"ðŸ¥ˆ ":i===2?"ðŸ¥‰ ":"";';
  html += 'h+="<tr style=\\"border-bottom:1px solid #0a1520;\\">";';
  html += 'h+="<td style=\\"padding:8px;color:#a78bfa;font-weight:700;\\">"+medal+x.name+"</td>";';
  html += 'h+="<td style=\\"padding:8px;text-align:center;\\"><span style=\\"display:inline-block;width:36px;height:36px;border-radius:50%;border:2px solid "+sc+";line-height:32px;text-align:center;color:"+sc+";font-family:Orbitron;font-size:0.7em;\\">"+x.engagementScore+"</span></td>";';
  html += 'h+="<td style=\\"padding:8px;text-align:center;\\">"+x.totalMessages+"</td>";';
  html += 'h+="<td style=\\"padding:8px;text-align:center;\\"><span style=\\"background:"+rc+"20;color:"+rc+";padding:2px 10px;font-size:0.8em;font-family:Orbitron;\\">"+x.responseRate+"%</span></td>";';
  html += 'h+="<td style=\\"padding:8px;text-align:center;\\">"+x.avgResponseTimeFormatted+"</td>";';
  html += 'h+="<td style=\\"padding:8px;text-align:center;color:"+(x.unanswered>0?"#ef4444":"#4a6a8a")+";\\">"+x.unanswered+"</td>";';
  html += 'h+="<td style=\\"padding:8px;text-align:center;font-size:0.85em;color:#4a6a8a;\\">"+x.peakDay+" "+x.peakHour+"</td></tr>";});';
  html += 'h+="</tbody></table>";d.innerHTML=h;}catch(e){d.innerHTML="<div style=\\"color:#ef4444;\\">"+e.message+"</div>";}}';

  // Quiet channels
  html += 'async function loadQC(){try{var d=await(await fetch("/discord/api/quiet")).json();var q=(d.channels||[]).filter(function(c){return c.isQuiet;});var el=document.getElementById("quietAlerts");';
  html += 'if(!q.length){el.innerHTML="<div style=\\"font-family:Orbitron;font-size:0.6em;color:#10b981;letter-spacing:3px;margin-bottom:10px;\\">âœ… ALL CHANNELS ACTIVE</div>";return;}';
  html += 'var h="<div style=\\"font-family:Orbitron;font-size:0.7em;color:#ef4444;letter-spacing:4px;margin-bottom:10px;\\">ðŸ”´ QUIET CHANNELS</div><div style=\\"display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin-bottom:15px;\\">";';
  html += 'q.forEach(function(c){var sv=c.hoursSince>168?"#ef4444":c.hoursSince>72?"#f59e0b":"#eab308";var lb=c.hoursSince>=48?Math.floor(c.hoursSince/24)+"d":c.hoursSince+"h";';
  html += 'h+="<div style=\\"background:rgba(10,20,35,0.6);border:1px solid "+sv+"30;padding:12px;\\"><div style=\\"display:flex;justify-content:space-between;\\"><span style=\\"color:"+sv+";font-weight:700;\\">#"+c.name+"</span><span style=\\"background:"+sv+"20;color:"+sv+";padding:2px 8px;font-size:0.8em;font-family:Orbitron;\\">"+lb+"</span></div>";';
  html += 'if(c.lastMessage)h+="<div style=\\"font-size:0.8em;color:#4a6a8a;margin-top:5px;\\">"+c.lastMessage.author+": "+c.lastMessage.content+"</div>";';
  html += 'h+="<button onclick=\\"loadSug(\'"+c.name+"\')\\" style=\\"margin-top:8px;padding:4px 10px;background:"+sv+"15;border:1px solid "+sv+"30;color:"+sv+";font-size:0.7em;cursor:pointer;font-family:Orbitron;\\">ðŸ’¡ SUGGEST</button></div>";});';
  html += 'h+="</div>";el.innerHTML=h;}catch(e){}}';

  // Suggestions
  html += 'var curSug=[];';
  html += 'async function loadSug(ch){var p=document.getElementById("suggestions");p.style.display="block";p.innerHTML="<div style=\\"color:#10b981;padding:15px;\\">ðŸ’¡ Generating ideas...</div>";';
  html += 'try{var d=await(await fetch("/discord/api/suggest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channel:ch||""})})).json();curSug=d.suggestions||[];';
  html += 'var h="<div style=\\"font-family:Orbitron;font-size:0.7em;color:#10b981;letter-spacing:4px;margin-bottom:10px;\\">ðŸ’¡ SUGGESTED MESSAGES</div>";';
  html += 'curSug.forEach(function(s,i){var pc=s.priority==="high"?"#ef4444":"#f59e0b";';
  html += 'h+="<div style=\\"background:rgba(10,20,35,0.6);border:1px solid #10b98115;padding:15px;margin-bottom:8px;\\">";';
  html += 'h+="<div style=\\"display:flex;justify-content:space-between;margin-bottom:8px;\\"><span style=\\"color:#10b981;font-weight:700;\\">#"+(s.channel||"general")+"</span><span style=\\"background:"+pc+"20;color:"+pc+";padding:2px 8px;font-size:0.7em;font-family:Orbitron;\\">"+s.priority.toUpperCase()+"</span></div>";';
  html += 'h+="<textarea id=\\"sg_"+i+"\\" style=\\"width:100%;background:#050a15;border:1px solid #1a2a3a;color:#c0d8f0;padding:10px;font-family:Rajdhani;min-height:50px;resize:vertical;box-sizing:border-box;\\">"+s.message+"</textarea>";';
  html += 'h+="<div style=\\"font-size:0.8em;color:#4a6a8a;margin:6px 0;\\">ðŸ’­ "+s.reason+"</div>";';
  html += 'h+="<div style=\\"display:flex;gap:8px;\\">";';
  html += 'if(s.channelId)h+="<button onclick=\\"sendSug("+i+")\\" style=\\"padding:6px 15px;background:rgba(16,185,129,0.15);border:1px solid #10b98150;color:#10b981;font-family:Orbitron;font-size:0.55em;cursor:pointer;\\">ðŸ“¤ SEND</button>";';
  html += 'h+="</div></div>";});';
  html += 'if(!curSug.length)h+="<div style=\\"color:#4a6a8a;\\">No suggestions.</div>";p.innerHTML=h;}catch(e){p.innerHTML="<div style=\\"color:#ef4444;\\">"+e.message+"</div>";}}';
  html += 'function loadSuggestions(){loadSug();}';

  // Send suggestion
  html += 'async function sendSug(i){var s=curSug[i];if(!s||!s.channelId)return;var m=document.getElementById("sg_"+i).value;if(!m.trim())return;';
  html += 'try{var d=await(await fetch("/discord/api/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelId:s.channelId,message:m})})).json();';
  html += 'if(d.success){var b=event.target;b.textContent="âœ… SENT";setTimeout(function(){b.textContent="ðŸ“¤ SEND";},3000);}else{alert(d.error);}}catch(e){alert(e.message);}}';

  // Send custom
  html += 'async function sendMsg(){var ch=document.getElementById("sendCh").value;var t=document.getElementById("sendTxt").value.trim();var st=document.getElementById("sendSt");';
  html += 'if(!t){st.textContent="Type a message";return;}st.textContent="Sending...";st.style.color="#7c3aed";';
  html += 'try{var d=await(await fetch("/discord/api/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({channelId:ch,message:t})})).json();';
  html += 'if(d.success){st.textContent="âœ… Sent!";st.style.color="#10b981";document.getElementById("sendTxt").value="";}else{st.textContent="âŒ "+d.error;st.style.color="#ef4444";}}catch(e){st.textContent="âŒ "+e.message;st.style.color="#ef4444";}}';

  // Analyze comms
  html += 'async function analyzeMessages(){var d=document.getElementById("analysis");d.style.display="block";d.textContent="âš¡ Analyzing...";try{var r=await(await fetch("/discord/api/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({limit:50})})).json();d.textContent=r.analysis;}catch(e){d.textContent=e.message;}}';

  // System improvements
  html += 'async function analyzeSystem(){var d=document.getElementById("sysAnalysis");d.style.display="block";d.textContent="ðŸ” Scanning...";try{var r=await(await fetch("/discord/api/improve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})).json();d.textContent=r.analysis;}catch(e){d.textContent=e.message;}}';

  // Enter to send
  html += 'document.getElementById("sendTxt")&&document.getElementById("sendTxt").addEventListener("keydown",function(e){if(e.key==="Enter")sendMsg();});';

  // Auto-load
  html += 'loadRR();loadQC();';

  html += '</script>';
  html += '</body></html>';

  res.send(html);
});

// â”€â”€ ROUTES â”€â”€

// Login
app.post('/followup/login', express.json(), async function(req, res) {
  try {
    var name = (req.body.name || '').trim();
    var password = (req.body.password || '').trim();
    if (!name || !password) return res.json({ success: false, message: 'Name and password required' });

    var users = await fuGetUsers();
    var user = users.find(function(u) {
      return u.name.toLowerCase() === name.toLowerCase() && u.password === password;
    });

    if (!user) return res.json({ success: false, message: 'Invalid credentials' });

    var token = 'fu_' + Date.now() + '_' + Math.random().toString(36).substring(2, 10);
    // Role comes from column C of password sheet
    var isAdmin = user.role === 'admin';
    fuSessions[token] = { name: user.name, role: isAdmin ? 'admin' : 'user', created: Date.now() };

    // Clean old sessions
    var now = Date.now();
    Object.keys(fuSessions).forEach(function(k) {
      if (now - fuSessions[k].created > 86400000) delete fuSessions[k];
    });

    res.json({ success: true, token: token, name: user.name, role: fuSessions[token].role });
  } catch (err) {
    console.log("FU login error:", err.message);
    res.json({ success: false, message: 'Server error' });
  }
});

// Submit follow-up (with PDF upload)
app.post('/followup/submit', express.json({ limit: '50mb' }), async function(req, res) {
  try {
    var token = req.body.token;
    var session = fuSessions[token];
    if (!session) return res.json({ success: false, message: 'Not logged in' });

    var fileName = (req.body.fileName || '').trim();
    var fileData = (req.body.fileData || '').trim(); // base64 PDF data
    var fileLink = (req.body.fileLink || '').trim(); // manual link fallback
    var emailSentTo = (req.body.emailSentTo || FOLLOWUP_ADMIN_EMAIL).trim();

    if (!fileName) return res.json({ success: false, message: 'File name is required' });

    var fileUrl = fileLink;

    // If base64 PDF data provided, upload to Google Drive
    if (fileData) {
      try {
        var driveResult = await fuUploadToDrive(fileData, fileName);
        fileUrl = driveResult.url;
        console.log("FU: Uploaded " + fileName + " to Drive: " + fileUrl);
      } catch (uploadErr) {
        console.log("FU: Drive upload failed, using manual link. Error:", uploadErr.message);
        if (!fileLink) return res.json({ success: false, message: 'File upload failed: ' + uploadErr.message });
      }
    }

    if (!fileUrl) return res.json({ success: false, message: 'No file link provided and upload failed' });

    // Determine ON TIME / LATE
    var submitStatus = fuGetSubmitStatus();

    // Get/create monthly tab
    var tabName = fuGetMonthTabName();
    var tabs = await fuGetTabs(FOLLOWUP_SPREADSHEET_ID);
    if (tabs.indexOf(tabName) === -1) {
      try {
        await sheets.spreadsheets.batchUpdate({
          spreadsheetId: FOLLOWUP_SPREADSHEET_ID,
          requestBody: { requests: [{ addSheet: { properties: { title: tabName } } }] }
        });
        await fuAppendSheet(FOLLOWUP_SPREADSHEET_ID, "'" + tabName + "'!A1:H1",
          [['Timestamp', 'Name', 'Email Sent To', 'File Name', 'File Link', 'AI Audit', 'Suggestions', 'Reason']]);
      } catch (tabErr) {
        console.log("FU tab creation error:", tabErr.message);
      }
    }

    // Write to monthly sheet
    var timestamp = new Date().toISOString();

    // Run AI audit on PDF text if available
    var auditResult = { audit: '', reason: '', suggestions: '' };
    if (fileData && FOLLOWUP_OPENAI_KEY) {
      try {
        // Extract readable text from base64 PDF
        var pdfBuf = Buffer.from(fileData, 'base64');
        var pdfStr = pdfBuf.toString('latin1');
        // Extract text between BT/ET markers and parentheses
        var textParts = [];
        var parenRegex = /\(([^)]{2,})\)/g;
        var match;
        while ((match = parenRegex.exec(pdfStr)) !== null) {
          var t = match[1].replace(/\\n/g, ' ').replace(/\\r/g, '').replace(/[^\x20-\x7E]/g, ' ').trim();
          if (t.length > 2 && !/^[\d.]+$/.test(t)) textParts.push(t);
        }
        // Also try extracting plain text streams
        var streamRegex = /stream\r?\n([\s\S]*?)endstream/g;
        while ((match = streamRegex.exec(pdfStr)) !== null) {
          var clean = match[1].replace(/[^\x20-\x7E\n]/g, ' ').replace(/\s+/g, ' ').trim();
          if (clean.length > 20) textParts.push(clean);
        }
        var extractedText = textParts.join(' ').substring(0, 15000);
        if (extractedText.length > 50) {
          auditResult = await fuRunAIAudit(extractedText);
          console.log("FU: AI audit complete â€” " + auditResult.audit);
        } else {
          console.log("FU: Could not extract enough text from PDF for audit");
        }
      } catch (auditErr) {
        console.log("FU: AI audit error:", auditErr.message);
      }
    }

    var success = await fuAppendSheet(FOLLOWUP_SPREADSHEET_ID, "'" + tabName + "'!A:H",
      [[timestamp, session.name, emailSentTo, fileName, fileUrl, auditResult.audit, auditResult.suggestions, auditResult.reason]]);

    if (success) {
      // Update DropDown tracker
      await fuUpdateTracker(session.name);

      // Update Chart
      var isOnTime = submitStatus.status === 'ON TIME';
      await fuUpdateChart(session.name, isOnTime);

      // Send admin email (best effort)
      fuSendAdminEmail(session.name, fileName, fileUrl, submitStatus.status, submitStatus.color).catch(function(e) {});
    }

    res.json({
      success: success,
      message: success ? ('Report submitted â€” ' + submitStatus.status + (auditResult.audit ? ' | AI Audit: ' + auditResult.audit : '')) : 'Error saving to sheet',
      status: submitStatus.status,
      audit: auditResult.audit || '',
      reason: auditResult.reason || ''
    });
  } catch (err) {
    console.log("FU submit error:", err.message);
    res.json({ success: false, message: 'Server error: ' + err.message });
  }
});

// History API
app.get('/followup/api/history', async function(req, res) {
  try {
    var token = req.query.token;
    var session = fuSessions[token];
    if (!session) return res.json({ success: false, message: 'Not logged in' });

    var isAdmin = session.role === 'admin';
    var history = await fuGetHistory(session.name, isAdmin);
    var chartData = await fuGetChartData();
    var employees = await fuGetEmployees();

    // Get who has submitted this week
    var weekStatus = {};
    employees.forEach(function(e) {
      weekStatus[e.name] = fuIsThisWeek(e.lastUpload);
    });

    // Build per-employee analytics from history (ADMIN ONLY)
    var empAnalytics = null;
    var heatmapData = null;

    if (isAdmin) {
      empAnalytics = {};
      var dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      heatmapData = {};

      employees.forEach(function(e) {
        empAnalytics[e.name] = { totalSubmissions: 0, onTime: 0, late: 0, lateStreak: 0, weeksMissed: 0, avgDay: '', avgHour: '', auditScores: [], submissions: [] };
      });

      var allHistory = await fuGetHistory('', true);

      allHistory.forEach(function(r) {
        if (!empAnalytics[r.name]) empAnalytics[r.name] = { totalSubmissions: 0, onTime: 0, late: 0, lateStreak: 0, weeksMissed: 0, avgDay: '', avgHour: '', auditScores: [], submissions: [] };
        var stat = empAnalytics[r.name];
        var d = new Date(r.timestamp);
        if (isNaN(d.getTime())) return;

        stat.totalSubmissions++;
        stat.submissions.push({ date: d, day: d.getDay(), hour: d.getHours() });
        var dayNum = d.getDay();
        if (dayNum === 0 || dayNum === 6 || dayNum === 1) stat.late++; else stat.onTime++;

        if (r.aiAudit && r.aiAudit.indexOf('ERROR') === -1) {
          if (r.aiAudit.indexOf('40 Hours') > -1) stat.auditScores.push(40);
          else {
            var hm = r.aiAudit.match(/(\d+)\s*Hours?/i);
            if (hm) stat.auditScores.push(parseInt(hm[1]));
          }
        }

        var hKey = d.getHours();
        var dKey = d.getDay();
        if (!heatmapData[hKey]) heatmapData[hKey] = {};
        heatmapData[hKey][dKey] = (heatmapData[hKey][dKey] || 0) + 1;
      });

      Object.keys(empAnalytics).forEach(function(name) {
        var s = empAnalytics[name];
        if (s.submissions.length > 0) {
          var daySum = 0, hourSum = 0;
          s.submissions.forEach(function(sub) { daySum += sub.day; hourSum += sub.hour; });
          s.avgDay = dayNames[Math.round(daySum / s.submissions.length)];
          s.avgHour = Math.round(hourSum / s.submissions.length) + ':00';

          var sorted = s.submissions.sort(function(a,b) { return b.date - a.date; });
          s.lateStreak = 0;
          for (var i = 0; i < sorted.length; i++) {
            var ld = sorted[i].day;
            if (ld === 0 || ld === 6 || ld === 1) s.lateStreak++; else break;
          }

          var first = sorted[sorted.length - 1].date;
          var weeksSince = Math.max(1, Math.ceil((Date.now() - first) / (7 * 86400000)));
          s.weeksMissed = Math.max(0, weeksSince - s.totalSubmissions);
        }
        delete s.submissions;
      });
    } // end admin-only analytics

    // Deadline countdown
    var now = new Date();
    var dayOfWeek = now.getDay();
    var hoursUntilDeadline = null;
    var deadlineText = '';
    // Deadline is Friday 11:59 PM
    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
      var friday = new Date(now);
      friday.setDate(friday.getDate() + (5 - dayOfWeek));
      friday.setHours(23, 59, 59, 0);
      var msLeft = friday - now;
      if (msLeft > 0) {
        hoursUntilDeadline = Math.floor(msLeft / 3600000);
        var minsLeft = Math.floor((msLeft % 3600000) / 60000);
        if (hoursUntilDeadline > 24) {
          var daysLeft = Math.floor(hoursUntilDeadline / 24);
          deadlineText = daysLeft + 'd ' + (hoursUntilDeadline % 24) + 'h until Friday deadline';
        } else {
          deadlineText = hoursUntilDeadline + 'h ' + minsLeft + 'm until deadline';
        }
      }
    }
    if (dayOfWeek === 0 || dayOfWeek === 6) {
      deadlineText = 'âš ï¸ OVERDUE â€” Past Friday deadline';
      hoursUntilDeadline = -1;
    }

    res.json({
      success: true,
      history: history,
      chartData: isAdmin ? chartData : null,
      employees: isAdmin ? employees.map(function(e) { return { name: e.name, submittedThisWeek: weekStatus[e.name] }; }) : null,
      analytics: empAnalytics,
      heatmap: heatmapData,
      deadline: { text: deadlineText, hoursLeft: hoursUntilDeadline },
      user: session.name,
      role: session.role
    });
  } catch (err) {
    res.json({ success: false, message: err.message });
  }
});

// Logout
app.post('/followup/logout', express.json(), function(req, res) {
  var token = req.body.token;
  if (token && fuSessions[token]) delete fuSessions[token];
  res.json({ success: true });
});

// Names API (loads login names dynamically)
app.get('/followup/api/names', async function(req, res) {
  try {
    // Try password sheet first
    var users = await fuGetUsers();
    if (users.length > 0) {
      return res.json({ success: true, names: users.map(function(u) { return u.name; }), source: 'password_sheet' });
    }

    // Fall back to DropDown tab
    var employees = await fuGetEmployees();
    if (employees.length > 0) {
      return res.json({ success: true, names: employees.map(function(e) { return e.name; }), source: 'dropdown_fallback' });
    }

    res.json({ success: false, names: [], message: 'No users found. Share password sheet (' + FOLLOWUP_PASSWORD_SHEET_ID + ') with service account.' });
  } catch (err) {
    res.json({ success: false, names: [], message: err.message });
  }
});

// Debug endpoint
// Serve stored PDFs from sheet
app.get('/followup/pdf/:id', async function(req, res) {
  try {
    var pdfId = req.params.id;
    var rows = await fuReadSheet(FOLLOWUP_SPREADSHEET_ID, "'PDF_Storage'!A:Z");
    if (!rows) return res.status(404).send('PDF storage not found');

    var found = null;
    for (var i = 0; i < rows.length; i++) {
      if (rows[i][0] === pdfId) { found = rows[i]; break; }
    }
    if (!found) return res.status(404).send('PDF not found');

    var fileName = found[1] || 'document.pdf';
    // Reassemble base64 from chunks (columns D, E, F, ...)
    var base64 = '';
    for (var c = 3; c < found.length; c++) {
      base64 += (found[c] || '');
    }

    var buffer = Buffer.from(base64, 'base64');
    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', 'inline; filename="' + fileName + '"');
    res.send(buffer);
  } catch (err) {
    res.status(500).send('Error loading PDF: ' + err.message);
  }
});

app.get('/followup/debug', async function(req, res) {
  try {
    var passwordUsers = [];
    try {
      var pwRows = await sheets.spreadsheets.values.get({ spreadsheetId: FOLLOWUP_PASSWORD_SHEET_ID, range: "'" + FOLLOWUP_PASSWORD_TAB + "'!A:B" });
      passwordUsers = (pwRows.data.values || []).map(function(r) { return (r[0]||'').trim(); });
    } catch(e) {
      passwordUsers = ['ERROR: ' + e.message];
    }

    var dropdownNames = [];
    try {
      var ddRows = await sheets.spreadsheets.values.get({ spreadsheetId: FOLLOWUP_SPREADSHEET_ID, range: "'DropDown'!A:A" });
      dropdownNames = (ddRows.data.values || []).map(function(r) { return (r[0]||'').trim(); });
    } catch(e) {
      dropdownNames = ['ERROR: ' + e.message];
    }

    var serviceEmail = '';
    try { serviceEmail = JSON.parse(fs.readFileSync(keyfilePath, 'utf8')).client_email; } catch(e) {}

    res.json({
      serviceAccountEmail: serviceEmail,
      driveFolderId: process.env.FOLLOWUP_DRIVE_FOLDER_ID || '(not set â€” share a folder with service account)',
      passwordSheetId: FOLLOWUP_PASSWORD_SHEET_ID,
      passwordTab: FOLLOWUP_PASSWORD_TAB,
      passwordUsers: passwordUsers,
      followupSheetId: FOLLOWUP_SPREADSHEET_ID,
      dropdownNames: dropdownNames,
      openaiKeySet: !!FOLLOWUP_OPENAI_KEY,
    });
  } catch(err) {
    res.json({ error: err.message });
  }
});

// â”€â”€ MAIN PAGE â”€â”€
app.get('/followup', async function(req, res) {
  try {
    var employees = await fuGetEmployees();
    var employeeNames = employees.map(function(e) { return e.name; });

    var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>Follow Up Portal â€” Wildwood</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">';
    html += '<style>';

    // Base
    html += '* { margin:0; padding:0; box-sizing:border-box; }';
    html += 'body { background:#0a0e17; color:#c8d6e5; font-family:Rajdhani,sans-serif; min-height:100vh; }';

    // Nav â€” standalone (no JARVIS/ATHENA for employees)
    html += '.nav { display:flex; justify-content:center; gap:0; padding:20px 20px 0; flex-wrap:wrap; }';
    html += '.nav a { font-family:Orbitron; font-size:0.7em; letter-spacing:4px; padding:12px 30px; text-decoration:none; transition:all 0.3s; }';
    html += '.nav a.active { color:#10b981; border:1px solid #10b98140; background:rgba(16,185,129,0.1); box-shadow:0 0 15px rgba(16,185,129,0.1); }';

    html += '.container { max-width:900px; margin:0 auto; padding:30px 40px; }';

    // Login
    html += '.login-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:85vh; position:relative; overflow:hidden; }';
    html += '.login-bg { position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; }';
    html += '.login-bg canvas { width:100%; height:100%; }';
    html += '.login-content { position:relative; z-index:1; text-align:center; width:100%; max-width:480px; }';
    html += '.brand-logo { font-family:Orbitron; font-size:2.2em; font-weight:900; letter-spacing:8px; color:#10b981; text-shadow:0 0 40px rgba(16,185,129,0.4),0 0 80px rgba(16,185,129,0.15); margin-bottom:4px; line-height:1.1; }';
    html += '.brand-sub { font-family:Orbitron; font-size:0.7em; letter-spacing:10px; color:#4a6a8a; margin-bottom:5px; }';
    html += '.brand-tagline { font-family:Rajdhani; font-size:0.85em; color:#2a4a6a; margin-bottom:35px; letter-spacing:2px; }';
    html += '.login-card { background:rgba(10,14,23,0.85); backdrop-filter:blur(20px); border:1px solid #10b98125; border-radius:16px; padding:40px 35px; box-shadow:0 20px 60px rgba(0,0,0,0.4),0 0 40px rgba(16,185,129,0.05); }';
    html += '.login-card h2 { font-family:Orbitron; color:#10b981; font-size:0.85em; letter-spacing:5px; margin-bottom:25px; }';
    html += '.divider-glow { height:1px; background:linear-gradient(90deg,transparent,#10b98140,transparent); margin:20px 0; }';
    html += '.powered-by { font-family:Orbitron; font-size:0.45em; letter-spacing:4px; color:#1a3a4a; margin-top:20px; }';
    html += '.form-group { margin-bottom:18px; }';
    html += '.form-group label { display:block; font-family:Orbitron; font-size:0.6em; letter-spacing:3px; color:#10b981; margin-bottom:8px; }';
    html += '.form-group select, .form-group input[type="text"], .form-group input[type="password"] { width:100%; padding:12px 16px; background:rgba(5,10,20,0.8); border:1px solid #1a2a3a; color:#c8d6e5; font-family:Rajdhani; font-size:1em; border-radius:8px; outline:none; }';
    html += '.form-group select:focus, .form-group input:focus { border-color:#10b981; }';
    html += '.form-group select option { background:#0a0e17; }';
    html += 'input[type="file"] { width:100%; padding:10px; background:rgba(5,10,20,0.8); border:1px solid #1a2a3a; color:#c8d6e5; border-radius:8px; font-family:Rajdhani; font-size:0.95em; cursor:pointer; }';
    html += 'input[type="file"]::file-selector-button { background:rgba(16,185,129,0.2); border:1px solid #10b98140; color:#10b981; padding:6px 16px; border-radius:6px; cursor:pointer; font-family:Rajdhani; font-weight:600; margin-right:10px; }';

    // Buttons
    html += '.btn { display:block; width:100%; padding:14px; font-family:Orbitron; font-size:0.75em; letter-spacing:4px; border:1px solid #10b98150; background:rgba(16,185,129,0.15); color:#10b981; cursor:pointer; border-radius:8px; transition:all 0.3s; }';
    html += '.btn:hover { background:rgba(16,185,129,0.3); box-shadow:0 0 20px rgba(16,185,129,0.2); }';
    html += '.btn:disabled { opacity:0.5; cursor:not-allowed; }';
    html += '.btn-submit { border-color:#00d4ff50; background:rgba(0,212,255,0.15); color:#00d4ff; }';
    html += '.btn-submit:hover { background:rgba(0,212,255,0.3); }';
    html += '.btn-danger { border-color:#ff475050; background:rgba(255,71,80,0.1); color:#ff4750; font-size:0.65em; padding:10px; width:auto; display:inline-block; }';
    html += '.error-msg { color:#ff4750; text-align:center; font-size:0.9em; margin-top:10px; min-height:20px; }';

    // Portal
    html += '.portal { display:none; }';
    html += '.portal.active { display:block; }';
    html += '.welcome-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding:15px 20px; background:rgba(16,185,129,0.05); border:1px solid #10b98120; border-radius:10px; flex-wrap:wrap; gap:10px; }';
    html += '.welcome-bar .user-name { font-family:Orbitron; color:#10b981; font-size:0.85em; letter-spacing:3px; }';
    html += '.section-title { font-family:Orbitron; font-size:0.8em; letter-spacing:5px; color:#10b981; margin:28px 0 12px; padding-bottom:8px; border-bottom:1px solid #10b98120; }';
    html += '.section-title.blue { color:#00d4ff; border-color:#00d4ff20; }';
    html += '.section-title.purple { color:#a855f7; border-color:#a855f720; }';
    html += '.section-title.orange { color:#ff9f43; border-color:#ff9f4320; }';

    // Submit form
    html += '.submit-form { background:rgba(0,212,255,0.03); border:1px solid #00d4ff15; border-radius:12px; padding:25px; margin-bottom:20px; }';
    html += '.form-row { display:grid; grid-template-columns:1fr 1fr; gap:15px; }';
    html += '.or-divider { text-align:center; color:#4a6a8a; font-family:Orbitron; font-size:0.6em; letter-spacing:3px; margin:10px 0; }';

    // Weekly status cards
    html += '.status-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:10px; margin-bottom:20px; }';
    html += '.status-card { background:rgba(10,14,23,0.6); border:1px solid #1a2a3a; border-radius:8px; padding:12px; text-align:center; }';
    html += '.status-card .name { font-family:Orbitron; font-size:0.6em; letter-spacing:2px; color:#c8d6e5; margin-bottom:6px; }';
    html += '.status-card .badge { display:inline-block; padding:3px 12px; border-radius:12px; font-size:0.8em; font-weight:700; }';
    html += '.badge.done { background:rgba(16,185,129,0.15); color:#10b981; border:1px solid #10b98130; }';
    html += '.badge.pending { background:rgba(255,165,0,0.15); color:#ffa500; border:1px solid #ffa50030; }';

    // Chart
    html += '.chart-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; margin-bottom:25px; }';
    html += '.chart-card { background:rgba(16,185,129,0.03); border:1px solid #10b98115; border-radius:10px; padding:15px; text-align:center; }';
    html += '.chart-card .cname { font-family:Orbitron; font-size:0.6em; letter-spacing:2px; color:#c8d6e5; margin-bottom:8px; }';
    html += '.chart-bar-wrap { display:flex; gap:8px; justify-content:center; align-items:flex-end; height:55px; }';
    html += '.chart-bar { width:28px; border-radius:4px 4px 0 0; position:relative; }';
    html += '.chart-bar.green { background:rgba(16,185,129,0.6); }';
    html += '.chart-bar.red { background:rgba(255,71,80,0.6); }';
    html += '.chart-bar span { position:absolute; top:-16px; left:50%; transform:translateX(-50%); font-size:0.7em; }';

    // History table
    html += '.history-table { width:100%; border-collapse:collapse; font-size:0.85em; }';
    html += '.history-table th { font-family:Orbitron; font-size:0.55em; letter-spacing:3px; color:#10b981; text-align:left; padding:10px 8px; border-bottom:1px solid #10b98130; background:rgba(16,185,129,0.05); }';
    html += '.history-table td { padding:8px; border-bottom:1px solid #0d1520; vertical-align:top; }';
    html += '.history-table tr:hover td { background:rgba(16,185,129,0.03); }';
    html += '.history-table a { color:#00d4ff; text-decoration:none; }';
    html += '.history-table a:hover { text-decoration:underline; }';
    html += '.pill { display:inline-block; padding:2px 10px; border-radius:12px; font-size:0.8em; font-weight:600; max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }';
    html += '.pill.ok { background:rgba(16,185,129,0.12); color:#10b981; }';
    html += '.pill.warn { background:rgba(255,165,0,0.12); color:#ffa500; }';
    html += '.pill.err { background:rgba(255,71,80,0.12); color:#ff4750; }';

    // Toast
    html += '.toast { position:fixed; top:20px; right:20px; padding:15px 25px; border-radius:10px; font-family:Orbitron; font-size:0.65em; letter-spacing:2px; z-index:9999; transform:translateX(120%); transition:transform 0.3s; }';
    html += '.toast.show { transform:translateX(0); }';
    html += '.toast.success { background:rgba(16,185,129,0.95); color:#fff; }';
    html += '.toast.error { background:rgba(255,71,80,0.95); color:#fff; }';
    html += '.toast.info { background:rgba(0,212,255,0.95); color:#fff; }';

    // Progress bar
    html += '.progress-bar { width:100%; height:4px; background:#1a2a3a; border-radius:2px; margin-top:10px; overflow:hidden; display:none; }';
    html += '.progress-bar .fill { height:100%; background:linear-gradient(90deg,#10b981,#00d4ff); width:0%; transition:width 0.3s; animation:progress-pulse 2s infinite; }';
    html += '@keyframes progress-pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }';

    // Responsive
    html += '@media(max-width:768px) { .container { padding:15px 12px; } .form-row { grid-template-columns:1fr; } .nav a { padding:8px 14px; font-size:0.6em; letter-spacing:2px; } .login-card { padding:30px 20px; } .brand-logo { font-size:1.5em; letter-spacing:5px; } .brand-sub { font-size:0.55em; letter-spacing:6px; } .history-table { font-size:0.75em; } .status-grid { grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); } .welcome-bar { flex-direction:column; text-align:center; } }';

    html += '</style></head><body>';

    // Nav â€” only FOLLOW UP shown
    html += '<div class="nav">';
    html += '<a href="/followup" class="active">FOLLOW UP</a><a href="/ai" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">AI</a><a href="/forecast" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">FORECAST</a><a href="/seo" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">SEO</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">TASKS</a><a href="/audit" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#4a6a8a;border:1px solid #1a2a3a;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">AUDIT</a><a href="/auth/logout" style="font-family:Orbitron;font-size:0.7em;letter-spacing:4px;padding:12px 30px;color:#ef4444;border:1px solid #ef444440;text-decoration:none;transition:all 0.3s;background:rgba(5,10,20,0.6);">LOGOUT</a>';
    html += '</div>';

    html += '<div class="container">';

    // â”€â”€ LOGIN SCREEN â”€â”€
    html += '<div id="loginScreen" class="login-screen">';

    // Animated background canvas
    html += '<div class="login-bg"><canvas id="bgCanvas"></canvas></div>';

    html += '<div class="login-content">';

    // Wildwood branding
    html += '<div class="brand-logo">WILDWOOD</div>';
    html += '<div class="brand-sub">SMALL ENGINE REPAIR</div>';
    html += '<div class="brand-tagline">â€”â€” EMPLOYEE PORTAL â€”â€”</div>';

    // Login card
    html += '<div class="login-card">';
    html += '<h2>WEEKLY FOLLOW UP</h2>';
    html += '<div class="divider-glow"></div>';

    html += '<div class="form-group"><label>YOUR NAME</label><select id="loginName"><option value="">Loading users...</option>';
    html += '</select></div>';
    html += '<div class="form-group"><label>PASSWORD</label><input type="password" id="loginPassword" placeholder="Enter your password"></div>';
    html += '<button class="btn" id="loginBtn" onclick="doLogin()">SIGN IN â†’</button>';
    html += '<div class="error-msg" id="loginError"></div>';

    html += '<div class="powered-by">POWERED BY JARVIS AI</div>';
    html += '</div>'; // login-card
    html += '</div>'; // login-content
    html += '</div>'; // loginScreen

    // â”€â”€ PORTAL â”€â”€
    html += '<div id="portal" class="portal">';

    // Welcome bar
    html += '<div class="welcome-bar"><span class="user-name" id="welcomeName">â€”</span>';
    html += '<button class="btn btn-danger" onclick="doLogout()">SIGN OUT</button></div>';

    // Deadline countdown
    html += '<div id="deadlineBar" style="display:none;text-align:center;padding:14px;margin-bottom:20px;border-radius:10px;font-family:Orbitron;font-size:0.75em;letter-spacing:3px;"></div>';

    // Submit section
    html += '<div class="section-title blue">ðŸ“¤ SUBMIT WEEKLY REPORT</div>';
    html += '<div class="submit-form">';
    html += '<div class="form-group"><label>UPLOAD PDF FILE</label><input type="file" id="submitFile" accept="application/pdf"></div>';
    html += '<div class="or-divider">â€” OR PASTE LINK â€”</div>';
    html += '<div class="form-group"><label>GOOGLE DRIVE LINK (optional if uploading)</label><input type="text" id="submitFileLink" placeholder="Paste Google Drive share link"></div>';
    html += '<div class="form-group"><label>FILE NAME (auto-filled from upload)</label><input type="text" id="submitFileName" placeholder="e.g. Follow Up Report.pdf"></div>';
    html += '<button class="btn btn-submit" id="submitBtn" onclick="doSubmit()">SUBMIT REPORT â†’</button>';
    html += '<div class="progress-bar" id="progressBar"><div class="fill" id="progressFill"></div></div>';
    html += '</div>';

    // Weekly status (admin only)
    html += '<div class="admin-only" style="display:none;">';
    html += '<div class="section-title orange">ðŸ“… THIS WEEK\'S STATUS</div>';
    html += '<div id="weekStatus" class="status-grid"></div>';

    // Employee Analytics (admin only)
    html += '<div class="section-title" style="color:#f472b6;border-color:#f472b620;">ðŸ“ˆ EMPLOYEE ANALYTICS</div>';
    html += '<div id="analyticsArea" style="overflow-x:auto;-webkit-overflow-scrolling:touch;"></div>';

    // Performance chart (admin only)
    html += '<div class="section-title purple">ðŸ“Š PERFORMANCE â€” ON TIME vs LATE</div>';
    html += '<div id="chartArea" class="chart-grid"></div>';
    html += '<div style="display:flex;gap:15px;justify-content:center;margin-bottom:20px;font-size:0.8em;">';
    html += '<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#10b981;margin-right:4px;vertical-align:middle;"></span> On Time</span>';
    html += '<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ff4750;margin-right:4px;vertical-align:middle;"></span> Late</span>';
    html += '</div>';

    // Submission Heatmap (admin only)
    html += '<div class="section-title" style="color:#fbbf24;border-color:#fbbf2420;">ðŸ”¥ SUBMISSION HEATMAP</div>';
    html += '<div id="heatmapArea" style="overflow-x:auto;margin-bottom:25px;"></div>';

    // Leaderboard (admin only)
    html += '<div class="section-title" style="color:#34d399;border-color:#34d39920;">ðŸ† CONSISTENCY LEADERBOARD</div>';
    html += '<div id="leaderboardArea"></div>';
    html += '</div>'; // end admin-only

    // History
    html += '<div class="section-title">ðŸ“‹ SUBMISSION HISTORY</div>';
    html += '<div id="historyArea"></div>';

    html += '</div>'; // portal
    html += '</div>'; // container

    html += '<div class="toast" id="toast"></div>';

    // â”€â”€ JAVASCRIPT â”€â”€
    html += '<script>';

    // State
    html += 'var sessionToken=localStorage.getItem("fu_token")||"";';
    html += 'var sessionUser=localStorage.getItem("fu_user")||"";';
    html += 'var sessionRole=localStorage.getItem("fu_role")||"";';
    html += 'if(sessionToken){showPortal();loadData();}';

    // Load login names from API
    html += '(function(){';
    html += '  fetch("/followup/api/names").then(function(r){return r.json()}).then(function(d){';
    html += '    var sel=document.getElementById("loginName");';
    html += '    sel.innerHTML="<option value=\\"\\">Select your name...</option>";';
    html += '    if(d.names&&d.names.length>0){';
    html += '      d.names.forEach(function(n){sel.innerHTML+="<option value=\\""+n+"\\">"+n+"</option>";});';
    html += '    } else {';
    html += '      sel.innerHTML="<option value=\\"\\">âš ï¸ No users found â€” check sheet sharing</option>";';
    html += '    }';
    html += '  }).catch(function(){';
    html += '    document.getElementById("loginName").innerHTML="<option value=\\"\\">âš ï¸ Network error</option>";';
    html += '  });';
    html += '})();';

    // Auto-fill file name from file input
    html += 'document.getElementById("submitFile").addEventListener("change",function(){';
    html += '  if(this.files.length>0) document.getElementById("submitFileName").value=this.files[0].name;';
    html += '});';

    // Enter key
    html += 'document.getElementById("loginPassword").addEventListener("keydown",function(e){if(e.key==="Enter")doLogin();});';

    // Login
    html += 'function doLogin(){';
    html += '  var name=document.getElementById("loginName").value,pw=document.getElementById("loginPassword").value;';
    html += '  if(!name||!pw){document.getElementById("loginError").textContent="Select name and enter password";return;}';
    html += '  var btn=document.getElementById("loginBtn");btn.disabled=true;btn.textContent="SIGNING IN...";';
    html += '  fetch("/followup/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:name,password:pw})})';
    html += '  .then(function(r){return r.json()}).then(function(d){';
    html += '    if(d.success){sessionToken=d.token;sessionUser=d.name;sessionRole=d.role;';
    html += '      localStorage.setItem("fu_token",d.token);localStorage.setItem("fu_user",d.name);localStorage.setItem("fu_role",d.role);';
    html += '      showPortal();loadData();}';
    html += '    else{document.getElementById("loginError").textContent=d.message||"Login failed";btn.disabled=false;btn.textContent="SIGN IN â†’";}';
    html += '  }).catch(function(){document.getElementById("loginError").textContent="Network error";btn.disabled=false;btn.textContent="SIGN IN â†’";});';
    html += '}';

    // Show portal
    html += 'function showPortal(){';
    html += '  document.getElementById("loginScreen").style.display="none";';
    html += '  document.getElementById("portal").classList.add("active");';
    html += '  var h=new Date().getHours();';
    html += '  var greet=h<12?"Good Morning":h<17?"Good Afternoon":"Good Evening";';
    html += '  document.getElementById("welcomeName").textContent=greet+", "+sessionUser+" ðŸ‘‹";';
    html += '  if(sessionRole==="admin"){var els=document.querySelectorAll(".admin-only");for(var i=0;i<els.length;i++)els[i].style.display="block";}';
    html += '  var voiceText=greet+", "+sessionUser;';
    html += '  fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:voiceText})})';
    html += '  .then(function(r){if(!r.ok)throw new Error("TTS failed");return r.blob();})';
    html += '  .then(function(b){var a=new Audio(URL.createObjectURL(b));a.play();})';
    html += '  .catch(function(e){';
    html += '    console.log("ElevenLabs unavailable, using browser voice");';
    html += '    var synth=window.speechSynthesis;var u=new SpeechSynthesisUtterance(voiceText);u.rate=1.0;u.pitch=0.9;';
    html += '    var voices=synth.getVoices();for(var v=0;v<voices.length;v++){if(voices[v].name.includes("Samantha")||voices[v].name.includes("Google UK English Male")||voices[v].name.includes("Male")){u.voice=voices[v];break;}}';
    html += '    synth.speak(u);';
    html += '  });';
    html += '}';

    // Load data
    html += 'function loadData(){';
    html += '  fetch("/followup/api/history?token="+encodeURIComponent(sessionToken))';
    html += '  .then(function(r){return r.json()}).then(function(d){';
    html += '    if(!d.success){doLogout();return;}';
    html += '    renderDeadline(d.deadline);';
    html += '    if(d.employees)renderWeekStatus(d.employees);';
    html += '    if(d.analytics)renderAnalytics(d.analytics);';
    html += '    if(d.chartData)renderChart(d.chartData);';
    html += '    if(d.heatmap)renderHeatmap(d.heatmap);';
    html += '    if(d.analytics)renderLeaderboard(d.analytics);';
    html += '    renderHistory(d.history);';
    html += '  }).catch(function(e){console.log("Load error:",e);});';
    html += '}';

    // Deadline countdown
    html += 'function renderDeadline(dl){';
    html += '  var bar=document.getElementById("deadlineBar");if(!dl||!dl.text){bar.style.display="none";return;}';
    html += '  bar.style.display="block";bar.textContent=dl.text;';
    html += '  if(dl.hoursLeft<0){bar.style.background="rgba(255,71,80,0.15)";bar.style.border="1px solid #ff475040";bar.style.color="#ff4750";}';
    html += '  else if(dl.hoursLeft<24){bar.style.background="rgba(255,165,0,0.15)";bar.style.border="1px solid #ffa50040";bar.style.color="#ffa500";}';
    html += '  else{bar.style.background="rgba(16,185,129,0.08)";bar.style.border="1px solid #10b98130";bar.style.color="#10b981";}';
    html += '}';

    // Weekly status
    html += 'function renderWeekStatus(emps){';
    html += '  var area=document.getElementById("weekStatus");if(!emps||!emps.length){area.innerHTML="";return;}';
    html += '  var h="";emps.forEach(function(e){';
    html += '    h+="<div class=\\"status-card\\">";';
    html += '    h+="<div class=\\"name\\">"+e.name+"</div>";';
    html += '    h+=e.submittedThisWeek?"<span class=\\"badge done\\">âœ… SUBMITTED</span>":"<span class=\\"badge pending\\">â³ PENDING</span>";';
    html += '    h+="</div>";';
    html += '  });area.innerHTML=h;';
    html += '}';

    // Chart
    html += 'function renderChart(data){';
    html += '  var area=document.getElementById("chartArea");';
    html += '  if(!data||!data.length){area.innerHTML="<div style=\\"text-align:center;padding:20px;color:#4a6a8a\\">No chart data yet</div>";return;}';
    html += '  var mx=1;data.forEach(function(d){if(d.onTime>mx)mx=d.onTime;if(d.late>mx)mx=d.late;});';
    html += '  var h="";data.forEach(function(d){';
    html += '    var oH=Math.max(4,(d.onTime/mx)*50),lH=d.late>0?Math.max(4,(d.late/mx)*50):0;';
    html += '    h+="<div class=\\"chart-card\\"><div class=\\"cname\\">"+d.name+"</div><div class=\\"chart-bar-wrap\\">";';
    html += '    h+="<div class=\\"chart-bar green\\" style=\\"height:"+oH+"px\\"><span>"+d.onTime+"</span></div>";';
    html += '    if(d.late>0)h+="<div class=\\"chart-bar red\\" style=\\"height:"+lH+"px\\"><span>"+d.late+"</span></div>";';
    html += '    h+="</div></div>";';
    html += '  });area.innerHTML=h;';
    html += '}';

    // Employee Analytics Table
    html += 'function renderAnalytics(analytics){';
    html += '  var area=document.getElementById("analyticsArea");if(!analytics){area.innerHTML="";return;}';
    html += '  var keys=Object.keys(analytics);if(!keys.length){area.innerHTML="<div style=\\"text-align:center;padding:20px;color:#4a6a8a\\">No analytics yet</div>";return;}';
    html += '  var h="<table class=\\"history-table\\"><thead><tr><th>EMPLOYEE</th><th>TOTAL</th><th>ON TIME</th><th>LATE</th><th>LATE STREAK</th><th>MISSED WEEKS</th><th>AVG DAY</th><th>AVG HOUR</th><th>AUDIT AVG</th></tr></thead><tbody>";';
    html += '  keys.forEach(function(name){';
    html += '    var s=analytics[name];';
    html += '    var streakBadge=s.lateStreak>=3?"<span class=\\"pill err\\">ðŸ”¥ "+s.lateStreak+"</span>":s.lateStreak>=2?"<span class=\\"pill warn\\">"+s.lateStreak+"</span>":"<span style=\\"color:#4a6a8a\\">0</span>";';
    html += '    var missedBadge=s.weeksMissed>=3?"<span class=\\"pill err\\">"+s.weeksMissed+"</span>":s.weeksMissed>=1?"<span class=\\"pill warn\\">"+s.weeksMissed+"</span>":"<span style=\\"color:#4a6a8a\\">0</span>";';
    html += '    var auditAvg="â€”";';
    html += '    if(s.auditScores&&s.auditScores.length>0){var sum=s.auditScores.reduce(function(a,b){return a+b},0);var avg=Math.round(sum/s.auditScores.length);';
    html += '      auditAvg=avg>=38?"<span class=\\"pill ok\\">"+avg+"h</span>":avg>=30?"<span class=\\"pill warn\\">"+avg+"h</span>":"<span class=\\"pill err\\">"+avg+"h</span>";}';
    html += '    h+="<tr><td style=\\"font-weight:600\\">"+name+"</td><td>"+s.totalSubmissions+"</td><td style=\\"color:#10b981\\">"+s.onTime+"</td><td style=\\"color:#ff4750\\">"+s.late+"</td><td>"+streakBadge+"</td><td>"+missedBadge+"</td><td>"+(s.avgDay||"â€”")+"</td><td>"+(s.avgHour||"â€”")+"</td><td>"+auditAvg+"</td></tr>";';
    html += '  });';
    html += '  h+="</tbody></table>";area.innerHTML=h;';
    html += '}';

    // Submission Heatmap
    html += 'function renderHeatmap(heatmap){';
    html += '  var area=document.getElementById("heatmapArea");if(!heatmap||!Object.keys(heatmap).length){area.innerHTML="<div style=\\"text-align:center;padding:20px;color:#4a6a8a\\">Not enough data yet</div>";return;}';
    html += '  var days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];';
    html += '  var maxCount=0;';
    html += '  Object.keys(heatmap).forEach(function(h){Object.keys(heatmap[h]).forEach(function(d){if(heatmap[h][d]>maxCount)maxCount=heatmap[h][d];});});';
    html += '  if(maxCount===0)maxCount=1;';
    html += '  var h="<table style=\\"border-collapse:collapse;width:100%;font-size:0.8em;\\"><thead><tr><th style=\\"font-family:Orbitron;font-size:0.6em;letter-spacing:2px;color:#fbbf24;padding:6px;\\">HOUR</th>";';
    html += '  days.forEach(function(d){h+="<th style=\\"font-family:Orbitron;font-size:0.55em;letter-spacing:1px;color:#4a6a8a;padding:6px;text-align:center;\\">"+d+"</th>";});';
    html += '  h+="</tr></thead><tbody>";';
    html += '  for(var hr=6;hr<=23;hr++){';
    html += '    h+="<tr><td style=\\"font-family:Orbitron;font-size:0.6em;color:#4a6a8a;padding:4px 8px;\\">"+(hr<10?"0":"")+hr+":00</td>";';
    html += '    for(var dy=0;dy<7;dy++){';
    html += '      var count=(heatmap[hr]&&heatmap[hr][dy])||0;';
    html += '      var intensity=count/maxCount;';
    html += '      var bg=count===0?"rgba(10,14,23,0.4)":"rgba(251,191,36,"+Math.max(0.1,intensity*0.8)+")";';
    html += '      h+="<td style=\\"text-align:center;padding:4px;\\"><div style=\\"width:28px;height:22px;border-radius:4px;background:"+bg+";display:inline-flex;align-items:center;justify-content:center;font-size:0.75em;color:"+(count>0?"#fff":"#333")+";\\">"+(count>0?count:"")+"</div></td>";';
    html += '    }h+="</tr>";';
    html += '  }h+="</tbody></table>";area.innerHTML=h;';
    html += '}';

    // Consistency Leaderboard
    html += 'function renderLeaderboard(analytics){';
    html += '  var area=document.getElementById("leaderboardArea");if(!analytics){area.innerHTML="";return;}';
    html += '  var entries=Object.keys(analytics).map(function(name){';
    html += '    var s=analytics[name];var total=s.onTime+s.late;';
    html += '    var pct=total>0?Math.round((s.onTime/total)*100):0;';
    html += '    return{name:name,pct:pct,onTime:s.onTime,total:total,streak:s.lateStreak,missed:s.weeksMissed};';
    html += '  }).sort(function(a,b){return b.pct-a.pct||b.total-a.total;});';
    html += '  var medals=["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"];';
    html += '  var h="<div style=\\"display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:25px;\\">";';
    html += '  entries.forEach(function(e,i){';
    html += '    var medal=i<3?medals[i]:"";';
    html += '    var barColor=e.pct>=80?"#10b981":e.pct>=50?"#ffa500":"#ff4750";';
    html += '    h+="<div style=\\"background:rgba(16,185,129,0.03);border:1px solid #10b98115;border-radius:10px;padding:14px;\\">";';
    html += '    h+="<div style=\\"font-family:Orbitron;font-size:0.65em;letter-spacing:2px;margin-bottom:8px;\\">"+medal+" "+e.name+"</div>";';
    html += '    h+="<div style=\\"display:flex;align-items:center;gap:8px;margin-bottom:4px;\\">";';
    html += '    h+="<div style=\\"flex:1;height:6px;background:#1a2a3a;border-radius:3px;overflow:hidden;\\">";';
    html += '    h+="<div style=\\"width:"+e.pct+"%;height:100%;background:"+barColor+";border-radius:3px;\\"></div></div>";';
    html += '    h+="<span style=\\"font-family:Orbitron;font-size:0.65em;color:"+barColor+"\\">"+e.pct+"%</span></div>";';
    html += '    h+="<div style=\\"font-size:0.8em;color:#4a6a8a;\\">"+e.onTime+"/"+e.total+" on time</div>";';
    html += '    h+="</div>";';
    html += '  });h+="</div>";area.innerHTML=h;';
    html += '}';

    // History
    html += 'function renderHistory(rows){';
    html += '  var area=document.getElementById("historyArea");';
    html += '  if(!rows||!rows.length){area.innerHTML="<div style=\\"text-align:center;padding:30px;color:#4a6a8a\\">ðŸ“‹ No submissions yet â€” submit your first report above!</div>";return;}';
    html += '  var h="<div style=\\"overflow-x:auto;-webkit-overflow-scrolling:touch\\"><table class=\\"history-table\\">";';
    html += '  h+="<thead><tr><th>DATE</th><th>NAME</th><th>FILE</th><th>STATUS</th><th>AI AUDIT</th></tr></thead><tbody>";';
    html += '  rows.forEach(function(r){';
    html += '    var dt=r.timestamp?new Date(r.timestamp):null;';
    html += '    var ds=dt?((dt.getMonth()+1)+"/"+dt.getDate()+"/"+dt.getFullYear()):"â€”";';
    html += '    var day=dt?dt.getDay():-1;';
    html += '    var isLate=(day===0||day===6||day===1);';
    html += '    var statusPill=isLate?"<span class=\\"pill err\\">LATE</span>":"<span class=\\"pill ok\\">ON TIME</span>";';
    html += '    var audit=r.aiAudit||"â€”";';
    html += '    var reason=r.reason||"";';
    html += '    var auditPill="â€”";';
    html += '    if(audit&&audit!=="â€”"){';
    html += '      if(audit.indexOf("ERROR")>-1)auditPill="<span class=\\"pill err\\" title=\\""+audit.replace(/"/g,"&quot;")+"\\">"+audit.substring(0,40)+"...</span>";';
    html += '      else if(audit.indexOf("40 Hours")>-1)auditPill="<span class=\\"pill ok\\" title=\\""+audit.replace(/"/g,"&quot;")+"\\">âœ… "+audit.substring(0,35)+"</span>";';
    html += '      else auditPill="<span class=\\"pill warn\\" title=\\""+audit.replace(/"/g,"&quot;")+"\\">"+audit.substring(0,40)+"</span>";';
    html += '      if(reason&&audit.indexOf("40 Hours")===-1)auditPill+="<div style=\\"font-size:0.75em;color:#ff9;margin-top:4px;line-height:1.3;\\">âš ï¸ "+reason.replace(/"/g,"&quot;")+"</div>";';
    html += '    }';
    html += '    h+="<tr><td>"+ds+"</td><td>"+(r.name||"â€”")+"</td>";';
    html += '    h+="<td>"+(r.fileLink?"<a href=\\""+r.fileLink+"\\" target=\\"_blank\\">"+(r.fileName||"View")+"</a>":(r.fileName||"â€”"))+"</td>";';
    html += '    h+="<td>"+statusPill+"</td><td>"+auditPill+"</td></tr>";';
    html += '  });h+="</tbody></table></div>";area.innerHTML=h;';
    html += '}';

    // Submit
    html += 'function doSubmit(){';
    html += '  var fileInput=document.getElementById("submitFile");';
    html += '  var fileLink=document.getElementById("submitFileLink").value.trim();';
    html += '  var fileName=document.getElementById("submitFileName").value.trim();';
    html += '  if(!fileInput.files.length&&!fileLink){showToast("Upload a PDF or paste a Drive link","error");return;}';
    html += '  if(!fileName){showToast("File name is required","error");return;}';
    html += '  var btn=document.getElementById("submitBtn");btn.disabled=true;btn.textContent="UPLOADING...";';
    html += '  var bar=document.getElementById("progressBar");bar.style.display="block";';
    html += '  document.getElementById("progressFill").style.width="30%";';

    // If file selected, read as base64
    html += '  if(fileInput.files.length>0){';
    html += '    var reader=new FileReader();';
    html += '    reader.onload=function(e){';
    html += '      var b64=e.target.result.split(",")[1];';
    html += '      document.getElementById("progressFill").style.width="60%";';
    html += '      sendSubmission({token:sessionToken,fileName:fileName,fileData:b64,fileLink:fileLink,emailSentTo:"' + FOLLOWUP_ADMIN_EMAIL + '"});';
    html += '    };';
    html += '    reader.readAsDataURL(fileInput.files[0]);';
    html += '  } else {';
    html += '    sendSubmission({token:sessionToken,fileName:fileName,fileData:"",fileLink:fileLink,emailSentTo:"' + FOLLOWUP_ADMIN_EMAIL + '"});';
    html += '  }';
    html += '}';

    html += 'function sendSubmission(payload){';
    html += '  document.getElementById("progressFill").style.width="80%";';
    html += '  fetch("/followup/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})';
    html += '  .then(function(r){return r.json()}).then(function(d){';
    html += '    document.getElementById("progressFill").style.width="100%";';
    html += '    setTimeout(function(){document.getElementById("progressBar").style.display="none";document.getElementById("progressFill").style.width="0%";},500);';
    html += '    var btn=document.getElementById("submitBtn");btn.disabled=false;btn.textContent="SUBMIT REPORT â†’";';
    html += '    if(d.success){showToast(d.message||"Submitted!","success");';
    html += '      document.getElementById("submitFile").value="";document.getElementById("submitFileName").value="";document.getElementById("submitFileLink").value="";';
    html += '      if(d.audit){';
    html += '        var voiceMsg="Thank you for your submission, "+sessionUser+". "+d.audit;';
    html += '        if(d.reason&&d.audit.indexOf("40 Hours")===-1)voiceMsg+=". "+d.reason;';
    html += '        fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:voiceMsg})})';
    html += '        .then(function(r){if(!r.ok)throw new Error("TTS");return r.blob();})';
    html += '        .then(function(b){var a=new Audio(URL.createObjectURL(b));a.play();})';
    html += '        .catch(function(){var s=window.speechSynthesis;var u=new SpeechSynthesisUtterance(voiceMsg);u.rate=1.0;u.pitch=0.9;s.speak(u);});';
    html += '      }else{';
    html += '        var tyMsg="Thank you for your submission, "+sessionUser+".";';
    html += '        fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:tyMsg})})';
    html += '        .then(function(r){if(!r.ok)throw new Error("TTS");return r.blob();})';
    html += '        .then(function(b){var a=new Audio(URL.createObjectURL(b));a.play();})';
    html += '        .catch(function(){var s=window.speechSynthesis;var u=new SpeechSynthesisUtterance(tyMsg);u.rate=1.0;u.pitch=0.9;s.speak(u);});';
    html += '      }';
    html += '      loadData();}';
    html += '    else{showToast(d.message||"Error","error");}';
    html += '  }).catch(function(e){';
    html += '    document.getElementById("progressBar").style.display="none";';
    html += '    document.getElementById("submitBtn").disabled=false;document.getElementById("submitBtn").textContent="SUBMIT REPORT â†’";';
    html += '    showToast("Network error","error");});';
    html += '}';

    // Logout
    html += 'function doLogout(){';
    html += '  fetch("/followup/logout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:sessionToken})});';
    html += '  sessionToken="";sessionUser="";sessionRole="";';
    html += '  localStorage.removeItem("fu_token");localStorage.removeItem("fu_user");localStorage.removeItem("fu_role");';
    html += '  location.reload();';
    html += '}';

    // Toast
    html += 'function showToast(msg,type){var t=document.getElementById("toast");t.textContent=msg;t.className="toast "+type+" show";setTimeout(function(){t.classList.remove("show");},4000);}';

    // Animated background (particles/grid effect)
    html += '(function(){';
    html += '  var c=document.getElementById("bgCanvas");if(!c)return;';
    html += '  var ctx=c.getContext("2d");';
    html += '  function resize(){c.width=c.parentElement.offsetWidth;c.height=c.parentElement.offsetHeight;}';
    html += '  resize();window.addEventListener("resize",resize);';
    html += '  var particles=[];';
    html += '  for(var i=0;i<60;i++){particles.push({x:Math.random()*c.width,y:Math.random()*c.height,vx:(Math.random()-0.5)*0.4,vy:(Math.random()-0.5)*0.4,r:Math.random()*2+0.5});}';
    html += '  function draw(){';
    html += '    ctx.clearRect(0,0,c.width,c.height);';
    // Grid lines
    html += '    ctx.strokeStyle="rgba(16,185,129,0.03)";ctx.lineWidth=1;';
    html += '    for(var gx=0;gx<c.width;gx+=60){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,c.height);ctx.stroke();}';
    html += '    for(var gy=0;gy<c.height;gy+=60){ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(c.width,gy);ctx.stroke();}';
    // Particles
    html += '    particles.forEach(function(p){';
    html += '      p.x+=p.vx;p.y+=p.vy;';
    html += '      if(p.x<0)p.x=c.width;if(p.x>c.width)p.x=0;';
    html += '      if(p.y<0)p.y=c.height;if(p.y>c.height)p.y=0;';
    html += '      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle="rgba(16,185,129,0.3)";ctx.fill();';
    html += '    });';
    // Connection lines
    html += '    for(var a=0;a<particles.length;a++){for(var b=a+1;b<particles.length;b++){';
    html += '      var dx=particles[a].x-particles[b].x,dy=particles[a].y-particles[b].y,dist=Math.sqrt(dx*dx+dy*dy);';
    html += '      if(dist<120){ctx.beginPath();ctx.moveTo(particles[a].x,particles[a].y);ctx.lineTo(particles[b].x,particles[b].y);';
    html += '        ctx.strokeStyle="rgba(16,185,129,"+(0.08*(1-dist/120))+")";ctx.lineWidth=0.5;ctx.stroke();}';
    html += '    }}';
    html += '    requestAnimationFrame(draw);';
    html += '  }';
    html += '  draw();';
    html += '})();';
    
    // Review Tracker and City Launch functions
    html += 'function copyReviewLink(city, phone) {';
    html += '  var reviewLink = "https://g.page/r/" + city.toLowerCase().replace(/ /g, "_") + "/review?gmbid=1";';
    html += '  var message = "Hi! We\'d love your feedback. Click here to leave a review: " + reviewLink + " 5 stars appreciated! ðŸ˜Š";';
    html += '  navigator.clipboard.writeText(message).then(function() {';
    html += '    alert("Review request copied! Paste it to text the customer.");';
    html += '  });';
    html += '}';
    html += 'function updateChecklistStep(step, checked) {';
    html += '  var checklist = JSON.parse(localStorage.getItem("cityChecklist") || "{}");';
    html += '  if(!checklist[step]) checklist[step] = {};';
    html += '  checklist[step].done = checked;';
    html += '  checklist[step].completedAt = new Date().toISOString();';
    html += '  localStorage.setItem("cityChecklist", JSON.stringify(checklist));';
    html += '  location.reload();';
    html += '}';
    html += 'function exportChecklist() {';
    html += '  alert("Export as PDF feature: Use your browser\'s Print > Save as PDF");';
    html += '}';
    html += 'function sendChecklistToTeam() {';
    html += '  var city = document.getElementById("launchCity").value || "New City";';
    html += '  var message = "City Launch Checklist for " + city + " is ready. All 24 steps documented. Review at: SEO Dashboard > City Launch";';
    html += '  navigator.clipboard.writeText(message).then(function() {';
    html += '    alert("Checklist link copied! Paste in team chat.");';
    html += '  });';
    html += '}';

    html += '</script></body></html>';
    res.send(html);
  } catch (err) {
    console.log("Follow-up page error:", err.message);
    res.status(500).send("Error loading Follow Up portal: " + err.message);
  }
});
app.listen(PORT, function() {
  console.log("LifeOS Jarvis running on port " + PORT);
  console.log("Endpoints: /tabs /tab/:name /scan /scan/full /search?q= /summary /priority /briefing /call /voice /conversation /whatsapp /gmail/auth /gmail/unread /gmail/summary /dashboard /business /tookan /chat /daily-questions /nightly-checkin /team /team/:name /team/assign /team/daily-tasks /team/coaching /team/workload");
  // Start calendar watcher for 10-min-before calls
  startCalendarWatcher();
  console.log("Calendar watcher started â€” checking every 2 minutes");
  // Pre-load business context, THEN Tookan (Tookan needs CRM job IDs)
  buildBusinessContext().then(function() {
    console.log("Business context loaded â€” now fetching Tookan data...");
    return buildTookanContext();
  }).then(function(d) {
    console.log("Tookan startup: " + d.totalTasks + " tasks, " + d.completed + " completed, " + d.agents.length + " agents");
    // Also try loading Google Ads data
    if (GOOGLE_ADS_DEVELOPER_TOKEN && GOOGLE_ADS_CUSTOMER_ID) {
      buildAdsContext().then(function(ad) {
        console.log("Google Ads startup: " + ad.campaigns.length + " campaigns, " + (ad.connected ? "connected" : "needs auth"));
      }).catch(function(ae) { console.log("Ads startup: " + ae.message); });
    }
  }).catch(function(e) {
    console.log("Startup fetch error: " + e.message);
    // Still try Tookan even if business failed
    buildTookanContext().catch(function(e2) { console.log("Tookan fallback error: " + e2.message); });
  });
});er